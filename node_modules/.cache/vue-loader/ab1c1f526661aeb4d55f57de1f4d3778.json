{"remainingRequest":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/src/views/micro_edition/revenues/Order.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/src/views/micro_edition/revenues/Order.vue","mtime":1639364469147},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCB7IGkxOG4gfSBmcm9tICJAL2kxOG4iOwppbXBvcnQgRGF0ZVBpY2tlckNvbXBvbmVudCBmcm9tICJAL2NvbXBvbmVudHMvY3VzdG9tX3RlbXBsYXRlcy9EYXRlUGlja2VyQ29tcG9uZW50IjsKaW1wb3J0IGtlbmRvIGZyb20gIkBwcm9ncmVzcy9rZW5kby11aSI7CmltcG9ydCB7IERyb3BEb3duTGlzdCB9IGZyb20gIkBwcm9ncmVzcy9rZW5kby12dWUtZHJvcGRvd25zIjsKaW1wb3J0IFNhbGVGb3JtQ29udGVudE1vZGVsIGZyb20gIkAvc2NyaXB0cy9tb2RlbC9TYWxlRm9ybUNvbnRlbnQiOwppbXBvcnQgSXRlbUxpbmVNb2RlbCBmcm9tICJAL3NjcmlwdHMvaW52b2ljZS9tb2RlbC9JdGVtTGluZSI7CmltcG9ydCB7IHV1aWQgfSBmcm9tICJ2dWUtdXVpZCI7CmltcG9ydCBTYWxlT3JkZXJNb2RlbCBmcm9tICJAL3NjcmlwdHMvbW9kZWwvVHJhbnNhY3Rpb24iOwoKLyogU3RvcmUgKi8KaW1wb3J0IHN0b3JlIGZyb20gIkAvc3RvcmUiOwoKY29uc3QgaW5zdGl0dXRlID0gc3RvcmUuc3RhdGUuaW5zdGl0dXRlLmluc3RpdHV0ZTsKCmltcG9ydCB7IFNob3dSZXNvdXJjZSB9IGZyb20gIkAvb2JzZXJ2YWJsZS9zdG9yZSI7CmltcG9ydCBwYXltZW50VGVybUhhbmRsZXJfIGZyb20gIkAvc2NyaXB0cy9wYXltZW50dGVybS9oYW5kbGVyL3BheW1lbnRUZXJtSGFuZGxlciI7CmltcG9ydCBjcmVkaXRMaW1pdEhhbmRsZXIgZnJvbSAiQC9zY3JpcHRzL2NyZWRpdExpbWl0L2hhbmRsZXIvY3JlZGl0TGltaXRIYW5kbGVyIjsKaW1wb3J0IEhlbHBlciBmcm9tICJAL2hlbHBlciI7CmltcG9ydCB0cmFuc2FjdGlvbkhhbmRsZXIgZnJvbSAiQC9zY3JpcHRzL3RyYW5zYWN0aW9uSGFuZGxlciI7CmltcG9ydCB7IGRhdGFTdG9yZSB9IGZyb20gIkAvb2JzZXJ2YWJsZS9zdG9yZSI7CgovLy8vaGFuZGxlcgpjb25zdCBzYWxlT3JkZXJIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3RyYW5zYWN0aW9uSGFuZGxlciIpOwpjb25zdCBiaWxsaW5nSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9pbnZvaWNlL2hhbmRsZXIvYmlsbGluZ0hhbmRsZXIiKTsKY29uc3QgY3VzdG9tZXJIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2N1c3RvbWVySGFuZGxlciIpOwpjb25zdCBwcm9qZWN0SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wcm9qZWN0SGFuZGxlciIpOwpjb25zdCBwcmVmaXhIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3ByZWZpeEhhbmRsZXIiKTsKY29uc3QgcGF5bWVudFRlcm1IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3BheW1lbnRUZXJtSGFuZGxlciIpOwpjb25zdCBwcmljZUxldmVsSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wcmljZUxldmVsSGFuZGxlciIpOwpjb25zdCBzYWxlRm9ybUNvbnRlbnRIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3NhbGVGb3JtQ29udGVudEhhbmRsZXIiKTsKY29uc3QgZW1wbG95ZWVIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2VtcGxveWVlSGFuZGxlciIpOwpjb25zdCBpdGVtTW9kaWZpZXJIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2l0ZW1Nb2RpZmllckhhbmRsZXIiKTsKY29uc3QgZGlzY291bnRJdGVtSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9kaXNjb3VudEl0ZW1IYW5kbGVyIik7CmNvbnN0IHVvbVByaWNlSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy91b21QcmljZUhhbmRsZXIiKTsKY29uc3QgcHJvZHVjdFZhcmlhbnRIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3Byb2R1Y3RWYXJpYW50SGFuZGxlciIpOwpjb25zdCBvdGhlckNoYXJnZUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvb3RoZXJDaGFyZ2VIYW5kbGVyIik7CmNvbnN0IGxvY2F0aW9uSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9sb2NhdGlvbkhhbmRsZXIiKTsKY29uc3Qgc2V0dGluZ3NIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3NldHRpbmdzSGFuZGxlciIpOwpjb25zdCBzYWxlQ2hhbm5lbEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2FsZUNoYW5uZWxIYW5kbGVyIik7CmNvbnN0IHNhbGVVbml0SXRlbUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2FsZVVuaXRJdGVtSGFuZGxlciIpOwpjb25zdCBzZXR0aW5nSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9zZXR0aW5nSGFuZGxlciIpOwpjb25zdCBjYXRhbG9nSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9jYXRhbG9nSGFuZGxlciIpOwpjb25zdCBwcm9kdWN0SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wcm9kdWN0SGFuZGxlciIpOwpjb25zdCBjdXJyZW5jeUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvY3VycmVuY3kvaGFuZGxlci9jdXJyZW5jeUhhbmRsZXIiKTsKY29uc3Qgc3VwcGxpZXJIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3N1cHBsaWVySGFuZGxlciIpOwoKY29uc3Qgc2FsZUZvcm1Db250ZW50TW9kZWwgPSBuZXcgU2FsZUZvcm1Db250ZW50TW9kZWwoe30pOwpjb25zdCBpdGVtTGluZU1vZGVsID0gbmV3IEl0ZW1MaW5lTW9kZWwoe30pOwovL290aGVyCmNvbnN0ICQgPSBrZW5kby5qUXVlcnk7CmNvbnN0IHRleHRGaWVsZCA9ICJudW1iZXJOYW1lIjsKY29uc3Qga2V5RmllbGQgPSAiaWQiOwpjb25zdCBkZWZhdWx0SXRlbSA9IHsgW3RleHRGaWVsZF06ICJTZWxlY3QgQ3VzdG9tZXIuLi4iLCBba2V5RmllbGRdOiBudWxsIH07CmNvbnN0IGRlZmF1bHRTdXBJdGVtID0geyBbdGV4dEZpZWxkXTogIlNlbGVjdCBTdXBwbGllci4uLiIsIFtrZXlGaWVsZF06IG51bGwgfTsKY29uc3QgZGVmYXVsdEVtcEl0ZW0gPSB7IFt0ZXh0RmllbGRdOiAiU2VsZWN0IEVtcGxveWVlLi4uIiwgW2tleUZpZWxkXTogbnVsbCB9Owpjb25zdCBlbXB0eUl0ZW0gPSB7IFt0ZXh0RmllbGRdOiAibG9hZGluZyAuLi4iIH07CmNvbnN0IGludm9pY2VQcmVmaXggPSAibGluLSI7CmNvbnN0IERJU0NPVU5UX1RZUEUgPSAiP3R5cGU9U2FsZSI7CmNvbnN0IGNvb2tpZUpTID0gcmVxdWlyZSgiQC9jb29raWUuanMiKTsKY29uc3QgY29va2llID0gY29va2llSlMuZ2V0Q29va2llKCk7CmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAiU2FsZU9yZGVyIiwKICBwcm9wczogewogICAgaWQ6IHsKICAgICAgdHlwZTogU3RyaW5nLAogICAgfSwKICAgIGluaXRTYWxlT3JkZXI6IHsKICAgICAgdHlwZTogU2FsZU9yZGVyTW9kZWwsCiAgICB9LAogIH0sCiAgY29tcG9uZW50czogewogICAgTG9hZGluZ01lOiAoKSA9PiBpbXBvcnQoYEAvY29tcG9uZW50cy9Mb2FkaW5nYCksCiAgICAiYXBwLWRhdGVwaWNrZXIiOiBEYXRlUGlja2VyQ29tcG9uZW50LAogICAgZHJvcGRvd25saXN0OiBEcm9wRG93bkxpc3QsCiAgICAvLyAiYXBwLW1vbnRob2YtcGlja2VyIjogKCkgPT4gaW1wb3J0KCJAL2NvbXBvbmVudHMva2VuZG9fdGVtcGxhdGVzL01vbnRoT2ZQaWNrZXIiKSwKICB9LAogIGRhdGE6ICgpID0+ICh7CiAgICBzYWxlT3JkZXI6IG5ldyBTYWxlT3JkZXJNb2RlbCgpLAogICAgaXNFZGl0OiBmYWxzZSwKICAgIG51bVNlbGVjdDogWzFdLAogICAgZGlhbG9nVGF4OiBmYWxzZSwKICAgIHRoZURhdGU6ICIiLAogICAgLy9DYXRhbG9nCiAgICBkaWFsb2dDYXRhbG9nOiBmYWxzZSwKICAgIGdyaWRTY2hlbWE6IHsKICAgICAgbW9kZWw6IHsKICAgICAgICBpZDogImlkIiwKICAgICAgfSwKICAgIH0sCiAgICBpbWdVUkw6ICJodHRwczovL3MzLWFwLXNvdXRoZWFzdC0xLmFtYXpvbmF3cy5jb20vaW1hZ2VzLmJhbmhqaS8iLAogICAgLy8gTG9hZGluZ01lCiAgICBzaG93TG9hZGluZzogZmFsc2UsCiAgICBsb2FkaW5nQWxlcnQ6IGZhbHNlLAogICAgbG9hZGluZ0NvbG9yQWxlcnQ6ICIiLAogICAgbG9hZGluZ1RleHRBbGVydDogIiIsCiAgICBiaWxsX2RhdGU6ICIiLAogICAgYWxlcnQ6IGZhbHNlLAogICAgZmlsZXM6IFtdLAogICAgZXJyb3JzOiBbXSwKICAgIC8vIEZvcm0gdmFsaWRhdGlvbgogICAgdmFsaWQ6IHRydWUsCiAgICB0ZW1wbGF0ZXM6IFsKICAgICAgeyB0aXRsZTogIkRyYWZ0IiB9LAogICAgICB7IHRpdGxlOiAiT3BlbiIgfSwKICAgICAgeyB0aXRsZTogIlBhcnRpYWxseSBDbG9zZWQiIH0sCiAgICAgIHsgdGl0bGU6ICJDbG9zZWQiIH0sCiAgICBdLAogICAgc2FsZU9yZGVyVHlwZTogMSwKICAgIHNhbGVPcmRlclR5cGVzOiBbCiAgICAgIHsgbmFtZTogIlN0YW5kYXJkIE9yZGVyIiwgaWQ6IDEgfSwKICAgICAgeyBuYW1lOiAiT3BlbiBPcmRlciIsIGlkOiAyIH0sCiAgICAgIHsgbmFtZTogIkNvbnRyYWN0IiwgaWQ6IDMgfSwKICAgICAgeyBuYW1lOiAiQ29uc2lnbm1lbnQgT3JkZXIiLCBpZDogNCB9LAogICAgICAvLyB7bmFtZTogJ09yZGVyIHJlcXVpcmVkIFB1cmNoYXNlJywgaWQ6IDV9LAogICAgXSwKICAgIGlzUmVxdXJlZFB1cmNoYXNlOiBmYWxzZSwKICAgIGNvbF9leHBhbmQ6IDksCiAgICBjb2xfaGlkZTogMywKICAgIGlzSGlkZUJhcjogZmFsc2UsCiAgICBmaWx0ZXI6ICIiLAogICAgdGV4dEZpZWxkOiAibnVtYmVyTmFtZSIsCiAgICBkYXRhSXRlbUtleTogImlkIiwKICAgIGRlZmF1bHRJdGVtOiBkZWZhdWx0SXRlbSwKICAgIGRlZmF1bHRTdXBJdGVtOiBkZWZhdWx0U3VwSXRlbSwKICAgIGRlZmF1bHRFbXBJdGVtOiBkZWZhdWx0RW1wSXRlbSwKICAgIG1PdGhlckNoYXJnZTogW10sCiAgICAvL2l0ZW0KICAgIGl0ZW1MaW5lczogW10sCiAgICBpdGVtTGluZTogaXRlbUxpbmVNb2RlbCwKICAgIGRhdGVGb3JtYXQ6IGl0ZW1MaW5lTW9kZWwuZGF0ZUZvcm1hdCwKICAgIC8vY3VzdG9tZXIKICAgIGN1c0Jhc2VVcmw6IGN1c3RvbWVySGFuZGxlci5zZWFyY2goKSwKICAgIGN1c3RvbWVyOiB7fSwKICAgIGN1c3RvbWVyTGlzdDogW10sCiAgICBzdXBwbGllckxpc3Q6IFtdLAogICAgc3VwcGxpZXI6IHt9LAogICAgc3VwQmFzZVVybDogc3VwcGxpZXJIYW5kbGVyLnNlYXJjaCgpLAogICAgYmlsbGluZ0FkZHJlc3M6IFtdLAogICAgZGVsaXZlcnlBZGRyZXNzOiBbXSwKICAgIHByaWNlTGV2ZWw6IFtdLAogICAgLy9kYXRlCiAgICBwYXltZW50VGVybXM6IFtdLAogICAgdHJhbnNhY3Rpb25zOiBbXSwKICAgIGVtcGxveWVlTGlzdDogW10sCiAgICBlbXBsb3llZToge30sCiAgICBlbXBCYXNlVXJsOiBlbXBsb3llZUhhbmRsZXIuc2VhcmNoVVJMKCksCiAgICBzYWxlQ2hhbm5lbExpc3Q6IFtdLAogICAgbG9jYXRpb25zOiBbXSwKICAgIGN1c3RvbWVyUHJvamVjdHM6IFtdLAogICAgc2VnbWVudHM6IFtdLAogICAgdHJhbnNhY3Rpb25UeXBlOiB7fSwKICAgIHRheExpc3RUb3RhbDoge30sCiAgICBjdXN0b21lckRpc2NvdW50SXRlbTogW10sCiAgICBjdXN0b21lclNhbGVVbml0OiBbXSwKICAgIHNhbGVGb3JtQ29udGVudDogc2FsZUZvcm1Db250ZW50TW9kZWwsCiAgICB0cmFuc2FjdGlvbkRhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApLAogICAgbW9udGhPZjogZmFsc2UsCiAgICBkZWxpdmVyeURhdGVUaW1lOiBuZXcgRGF0ZSgpLAogICAgdmFsaWRpdHlEYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDAsIDEwKSwKICAgIHNwZWNpZmljRGlzY291bnRJdGVtOiBbXSwKICAgIG90aGVyQ2hhcmdlTGlzdDogW10sCiAgICBzYWxlVW5pdEl0ZW1MaXN0OiBbXSwKICAgIG90aGVyVGF4OiBbXSwKICAgIHNwZWNpZmljVGF4OiBbXSwKICAgIHB1YmxpY0xpZ2h0aW5nVGF4OiBbXSwKICAgIHZhdFRheDogW10sCiAgICB0YXg6IFtdLAogICAgbG9nZ2VkVXNlcjogewogICAgICBpZDogY29va2llLmNyZWF0b3IsCiAgICAgIG5hbWU6IGNvb2tpZS5lbWFpbCwKICAgIH0sCiAgICBsZWFkczogW10sCiAgICBjYXRhbG9nczogW10sCiAgICB0eG5MaXN0OiBbXSwKICAgIHF1b3RlczogW10sCiAgICB0eG5MaXN0czogW10sCiAgICBpc1NhdmVOZXc6IGZhbHNlLAogICAgaXNTYXZlQ2xvc2U6IGZhbHNlLAogICAgaXNTYXZlUHJpbnQ6IGZhbHNlLAogICAgaXNTYXZlRHJhZnQ6IGZhbHNlLAogICAgZXhjaGFuZ2VSYXRlOiB7fSwKICAgIGJhc2VDdXJyZW5jeUNvZGU6ICIiLAogICAgY3VycmVuY3lDb2RlOiAiIiwKICAgIHRyYW5zYWN0aW9uUmF0ZTogMSwKICAgIHNhdmVPcHRpb246ICIiLAogICAgZm9ybUFSOiBbCiAgICAgIHsgaWQ6IDEsIG5hbWU6ICJEZWZhdWx0IEZvcm0iIH0sCiAgICAgIHsgaWQ6IDIsIG5hbWU6ICJGb3JtIDgwbW0iIH0sCiAgICBdLAogICAgaXNQcmljZUxldmVsQ2hhbmdlZDogZmFsc2UsCiAgICByZWZGcm9tOiBbXSwgLy8gY2FuIFNPIGNhbiBiZSBmcm9tIFNhbGUgUXVvdGVzCiAgICBidG5EaXNhYmxlZDogZmFsc2UsCiAgfSksCiAgbWV0aG9kczogewogICAgZm9ybWF0RGF0ZVRpbWUodmFsdWUpIHsKICAgICAgcmV0dXJuIGtlbmRvLnRvU3RyaW5nKG5ldyBEYXRlKHZhbHVlKSwgdGhpcy5kYXRlRm9ybWF0ICsgYCBoaDptbSB0dGApOwogICAgfSwKICAgIGFtb3VudEZvcm1hdCh2YWx1ZSkgewogICAgICByZXR1cm4ga2VuZG8udG9TdHJpbmcodmFsdWUuYW1vdW50LCBgbiR7dGhpcy5zYWxlRm9ybUNvbnRlbnQuZGVjaW1hbH1gKTsKICAgIH0sCiAgICBwcmljZUZvcm1hdCh2YWx1ZSkgewogICAgICByZXR1cm4ga2VuZG8udG9TdHJpbmcodmFsdWUucHJpY2UsIGBuJHt0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsfWApOwogICAgfSwKICAgIEhlbHAoa2V5X3NlYXJjaCkgewogICAgICBTaG93UmVzb3VyY2Uoa2V5X3NlYXJjaCk7CiAgICB9LAogICAgaW5pdGlhbERhdGEoKSB7CiAgICAgIGlmICh0aGlzLmluaXRTYWxlT3JkZXIpIHsKICAgICAgICAvLyBFZGl0IE1vZGUKICAgICAgICB0aGlzLnNhbGVPcmRlciA9IHRoaXMuaW5pdFNhbGVPcmRlcjsKICAgICAgICB0aGlzLnNhbGVPcmRlci5jcmVkaXRMaW1pdCA9IDA7CiAgICAgICAgdGhpcy5zYWxlT3JkZXIuY3VycmVudEJhbGFuY2UgPSAwOwogICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLmluaXRTYWxlT3JkZXIsICdwcm9wRGF0YScpCiAgICAgICAgdGhpcy5iaW5kRGF0YSgpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEJyYW5kIE5ldyBNb2RlCiAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLnNldERlZmF1bHREYXRhKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc2V0RGVmYXVsdERhdGEoKSB7CiAgICAgIC8vIEJyYW5kIE5ldyBNb2RlCiAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnZGVmYXVsdCBvciBjbGVhcicpCiAgICAgIHRoaXMuaXNFZGl0ID0gZmFsc2U7CiAgICAgIHRoaXMuc2FsZU9yZGVyID0gbmV3IFNhbGVPcmRlck1vZGVsKHt9KTsKICAgICAgLy9zYWxlIG9yZGVyIHR5cGUKICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5zYWxlT3JkZXIuc2FsZU9yZGVyVHlwZSA9IDE7CiAgICAgICAgdGhpcy5zYWxlT3JkZXJUeXBlID0gMTsKICAgICAgICBpZiAodGhpcy5hcHBUeXBlID09PSAibnBvIiB8fCB0aGlzLmFwcFR5cGUgPT09ICJQdWJsaWMgU2VjdG9ycyIpIHsKICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnNhbGVPcmRlclR5cGUgPSAzOwogICAgICAgICAgdGhpcy5zYWxlT3JkZXJUeXBlID0gMzsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5zYWxlT3JkZXIuZGVsaXZlcnlEYXRlVGltZSA9IG5ldyBEYXRlKCk7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmZvcm1UZW1wbGF0ZSA9IDE7CiAgICAgIHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uRGF0ZSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApOwogICAgICAvLyBHZW5lcmF0ZSBOdW1iZXIKICAgICAgdGhpcy5pdGVtTGluZXMgPSBbXTsKICAgICAgLy8gbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCk7CiAgICAgIC8vIGRzLmRhdGEoW10pOwogICAgICAvLyBBZGQgMiBkZWZhdWx0IGxpbmVzCiAgICAgIHRoaXMucmVtb3ZlRW1wdHlMaW5lKCk7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuYWRkUm93KCk7CiAgICAgICAgLy8gdGhpcy5hZGRSb3coKQogICAgICB9LCA1MDApOwogICAgICAvLyBBZGQgMiBkZWZhdWx0IGxpbmVzCiAgICAgIHRoaXMub3RoZXJDaGFyZ2VMaXN0ID0gW107CiAgICAgIHRoaXMubU90aGVyQ2hhcmdlID0gW107CiAgICAgIHRoaXMuZW1wbG95ZWUgPSB7fTsKICAgICAgdGhpcy50YXhMaXN0VG90YWwgPSB7fTsKICAgICAgdGhpcy5xdW90ZXMgPSBbXTsKICAgICAgdGhpcy5pc1NhdmVOZXcgPSBmYWxzZTsKICAgICAgdGhpcy5pc1NhdmVDbG9zZSA9IGZhbHNlOwogICAgICB0aGlzLmlzU2F2ZVByaW50ID0gZmFsc2U7CiAgICAgIHRoaXMuaXNTYXZlRHJhZnQgPSBmYWxzZTsKICAgICAgdGhpcy5jcmVkaXRMaW1pdFVzYWdlKDAsIDEpOwogICAgICB0aGlzLmlzUmVxdXJlZFB1cmNoYXNlID0gZmFsc2U7CiAgICAgIHRoaXMuY3VzdG9tZXIgPSB7fTsKICAgIH0sCiAgICBiaW5kRGF0YSgpIHsKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHRoaXMuc2FsZU9yZGVyLCAnYmluZERhdGEnKQogICAgICAvLyBFZGl0IE1vZGUKICAgICAgaWYgKHRoaXMuc2FsZU9yZGVyKSB7CiAgICAgICAgaWYgKHRoaXMuc2FsZU9yZGVyLmhhc093blByb3BlcnR5KCJjdXN0b21lciIpKSB7CiAgICAgICAgICB0aGlzLmlzRWRpdCA9IHRydWU7CiAgICAgICAgICB0aGlzLmN1c3RvbWVyID0gdGhpcy5zYWxlT3JkZXIuY3VzdG9tZXI7CiAgICAgICAgICAvLyBsZXQgZSA9IHt2YWx1ZTogdGhpcy5zYWxlT3JkZXIuY3VzdG9tZXJ9CiAgICAgICAgICAvLyB0aGlzLm9uQ2hhbmdlKGUpCiAgICAgICAgICB0aGlzLmJpbGxpbmdBZGRyZXNzID0gdGhpcy5zYWxlT3JkZXIuY3VzdG9tZXIuYmlsbGluZ0FkZHJlc3M7CiAgICAgICAgICB0aGlzLmRlbGl2ZXJ5QWRkcmVzcyA9IHRoaXMuc2FsZU9yZGVyLmN1c3RvbWVyLmRlbGl2ZXJ5QWRkcmVzczsKICAgICAgICAgIC8vIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IHRoaXMuc2FsZU9yZGVyLmN1c3RvbWVyLgogICAgICAgICAgdGhpcy50YXhMaXN0VG90YWwgPSB0aGlzLnNhbGVPcmRlci50YXhMaXN0VG90YWw7CiAgICAgICAgICB0aGlzLml0ZW1MaW5lcyA9IHRoaXMuc2FsZU9yZGVyLml0ZW1MaW5lczsKICAgICAgICAgIHRoaXMubU90aGVyQ2hhcmdlID0gdGhpcy5zYWxlT3JkZXIub3RoZXJDaGFyZ2U7CiAgICAgICAgICB0aGlzLmxvYWRQcm9qZWN0QnlDdXN0b21lcigpOwogICAgICAgICAgaWYgKHRoaXMuY3VzdG9tZXIuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMuY3VzdG9tZXIuaWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGFkZFNlbGVjdCgpIHsKICAgICAgbGV0IGFtb3VudF9udW0gPSB0aGlzLm51bVNlbGVjdC5sZW5ndGg7CiAgICAgIGxldCBudW0gPSB0aGlzLm51bVNlbGVjdFthbW91bnRfbnVtIC0gMV07CiAgICAgIGxldCBuZXdfbnVtID0gbnVtICsgMTsKICAgICAgbGV0IGxlbmdodEl0ZW0gPSB0aGlzLnNwZWNpZmljRGlzY291bnRJdGVtLmxlbmd0aDsKICAgICAgaWYgKG5ld19udW0gPD0gbGVuZ2h0SXRlbSkgewogICAgICAgIHRoaXMubnVtU2VsZWN0LnB1c2gobmV3X251bSk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVTZWxlY3QoaW5kZXgpIHsKICAgICAgdGhpcy5udW1TZWxlY3Quc3BsaWNlKGluZGV4LCAxKTsKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGluZGV4LCB0aGlzLm51bVNlbGVjdCkKICAgICAgLy8gdGhpcy5zZWxlY3REaXNjb3VudC5zcGxpY2UoaW5kZXgsMSkKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCJyZW1vdmUiLHRoaXMuc2VsZWN0RGlzY291bnQpCiAgICAgIC8vIHRoaXMuc2VsZWN0RGlzY291bnQgPSB0aGlzLnNlbGVjdERpc2NvdW50LmZpbHRlcihpdGVtID0+ICBpdGVtLmlkICE9IHZhbC5pZCk7CiAgICB9LAogICAgZXJyb3JNZXNzYWdlKCkge30sCiAgICBhY2NvdW50RHJvcERvd25FZGl0b3IoKSB7fSwKICAgIGhpZGVfc21hbGxzaXRlYmFyKCkgewogICAgICBpZiAoIXRoaXMuaXNIaWRlQmFyKSB7CiAgICAgICAgLy8gdGhpcy5jb2xfZXhwYW5kID0gMTIKICAgICAgICAvLyB0aGlzLmNvbF9oaWRlID0gMAogICAgICAgIHRoaXMuaXNIaWRlQmFyID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGlzLmNvbF9leHBhbmQgPSA5CiAgICAgICAgLy8gdGhpcy5jb2xfaGlkZSA9IDMKICAgICAgICB0aGlzLmlzSGlkZUJhciA9IGZhbHNlOwogICAgICB9CiAgICB9LAogICAgLy9udW1iZXIKICAgIGdlbmVyYXRlTnVtYmVyKCkgewogICAgICBpZiAodGhpcy5pc0VkaXQgPT0gZmFsc2UpIHsKICAgICAgICBsZXQgZCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApOwogICAgICAgIGlmICh0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbkRhdGUpIHsKICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLnRyYW5zYWN0aW9uRGF0ZSkKICAgICAgICAgIGQgPSB0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbkRhdGU7CiAgICAgICAgfQogICAgICAgIGxldCBkYXRhID0gewogICAgICAgICAgYWJicjogdGhpcy5zYWxlT3JkZXIudHJhbnNhY3Rpb25UeXBlLmFiYnIsCiAgICAgICAgICBzdHJ1Y3R1cmU6IHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uVHlwZS5zdHJ1Y3R1cmUsCiAgICAgICAgICB0cmFuc2FjdGlvbkRhdGU6IGQsCiAgICAgICAgICB0eXBlOiAiU2FsZSBPcmRlciIsCiAgICAgICAgfTsKICAgICAgICBiaWxsaW5nSGFuZGxlcgogICAgICAgICAgLmxhc3ROdW1iZXIoZGF0YSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICBjb25zdCByZXMgPSByZXNwb25zZS5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgY29uc3QgbGFzdE51bWJlciA9IHRoaXMuemVyb1BhZCgKICAgICAgICAgICAgICAgIHBhcnNlSW50KHJlcy5sYXN0TnVtYmVyKSwKICAgICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uVHlwZS5mb3JtYXQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IG51bWJlciA9CiAgICAgICAgICAgICAgICByZXMuc3VmZml4ICsKICAgICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uVHlwZS5udW1iZXJTZXBhcmF0b3IgKwogICAgICAgICAgICAgICAgbGFzdE51bWJlcjsKICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5udW1iZXIgPSBudW1iZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgdGhpcy5lcnJvcnMucHVzaChlKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgemVyb1BhZChudW0sIHBsYWNlcykgewogICAgICByZXR1cm4gU3RyaW5nKG51bSkucGFkU3RhcnQocGxhY2VzLCAiMCIpOwogICAgfSwKICAgIC8vY3VzdG9tZXIKICAgIG9uQ2hhbmdlKGV2ZW50KSB7CiAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhldmVudCk7CiAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudmFsdWU7CiAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVt0ZXh0RmllbGRdID09PSBlbXB0eUl0ZW1bdGV4dEZpZWxkXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLmN1c3RvbWVyID0gdmFsdWU7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmN1c3RvbWVyID0gdmFsdWU7CiAgICAgIC8vIHRoaXMuaW52b2ljZSA9IHZhbHVlCiAgICAgIC8vIHRoaXMuc2FsZU9yZGVyLnBheW1lbnRUZXJtID0gdmFsdWUuaGFzT3duUHJvcGVydHkoInBheW1lbnRUZXJtIikKICAgICAgLy8gICA/IHZhbHVlLnBheW1lbnRUZXJtCiAgICAgIC8vICAgOiB7fTsKICAgICAgdGhpcy5zYWxlT3JkZXIucHJpY2VMZXZlbCA9IHZhbHVlLmhhc093blByb3BlcnR5KCJwcmljZUxldmVsIikKICAgICAgICA/IHZhbHVlLnByaWNlTGV2ZWwKICAgICAgICA6IHt9OwogICAgICBjb25zdCBiYXNlQ3VycmVuY3kgPSB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgiYmFzZUN1cnJlbmN5IikKICAgICAgICA/IHZhbHVlLmJhc2VDdXJyZW5jeQogICAgICAgIDoge307CiAgICAgIGlmIChiYXNlQ3VycmVuY3kuaGFzT3duUHJvcGVydHkoImNvZGUiKSkgewogICAgICAgIHRoaXMuYmFzZUN1cnJlbmN5Q29kZSA9IGJhc2VDdXJyZW5jeS5jb2RlOwogICAgICB9CiAgICAgIGNvbnN0IHByaWNlTGV2ZWwgPSB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgicHJpY2VMZXZlbCIpCiAgICAgICAgPyB2YWx1ZS5wcmljZUxldmVsCiAgICAgICAgOiB7fTsKICAgICAgaWYgKHByaWNlTGV2ZWwuaGFzT3duUHJvcGVydHkoImN1cnJlbmN5IikpIHsKICAgICAgICBpZiAocHJpY2VMZXZlbC5jdXJyZW5jeS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgdGhpcy5sb2FkVHJhbnNhY3Rpb25SYXRlKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuYmlsbGluZ0FkZHJlc3MgPSB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgiYmlsbGluZ0FkZHJlc3MiKQogICAgICAgID8gdmFsdWUuYmlsbGluZ0FkZHJlc3MKICAgICAgICA6IFtdOwogICAgICB0aGlzLmRlbGl2ZXJ5QWRkcmVzcyA9IHZhbHVlLmhhc093blByb3BlcnR5KCJkZWxpdmVyeUFkZHJlc3MiKQogICAgICAgID8gdmFsdWUuZGVsaXZlcnlBZGRyZXNzCiAgICAgICAgOiBbXTsKICAgICAgaWYgKHRoaXMuYmlsbGluZ0FkZHJlc3MubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc2FsZU9yZGVyLmJpbGxpbmdBZGRyZXNzID0gdGhpcy5iaWxsaW5nQWRkcmVzc1swXTsKICAgICAgfQogICAgICBpZiAodGhpcy5kZWxpdmVyeUFkZHJlc3MubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc2FsZU9yZGVyLmRlbGl2ZXJ5QWRkcmVzcyA9IHRoaXMuZGVsaXZlcnlBZGRyZXNzWzBdOwogICAgICB9CiAgICAgIHRoaXMub25TYWxlT3JkZXJEYXRlQ2hhbmdlZCgpOwogICAgICB0aGlzLmxvYWRQcm9qZWN0QnlDdXN0b21lcigpOwogICAgICAvLyBjb25zdCBjcmVkaXRMaW1pdCA9IHZhbHVlLmhhc093blByb3BlcnR5KCJjcmVkaXRMaW1pdCIpCiAgICAgIC8vICAgPyB2YWx1ZS5jcmVkaXRMaW1pdAogICAgICAvLyAgIDogMDsKICAgICAgLy8gdGhpcy5zYWxlT3JkZXIuY3JlZGl0TGltaXQgPSBrZW5kby5wYXJzZUZsb2F0KGNyZWRpdExpbWl0KTsKICAgICAgdGhpcy5sb2FkQ3JlZGl0TGltaXQoKTsKICAgICAgdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMuY3VzdG9tZXIuaWQpOwogICAgICAvLyBsb2FkIHF1b3RlCiAgICAgIHRoaXMubG9hZFF1b3RlKCk7CiAgICAgIHRoaXMubG9hZFBheW1lbnRUZXJtTGlzdCgpOwogICAgfSwKICAgIG9uRmlsdGVyQ2hhbmdlKGV2ZW50KSB7CiAgICAgIGNvbnN0IGZpbHRlciA9IGV2ZW50LmZpbHRlci52YWx1ZTsKICAgICAgdGhpcy5yZXF1ZXN0RGF0YSgwLCBmaWx0ZXIsIHRoaXMuY3VzQmFzZVVybCk7CiAgICAgIHRoaXMuZmlsdGVyID0gZmlsdGVyOwogICAgfSwKICAgIGFzeW5jIHJlcXVlc3REYXRhKHNraXAsIGZpbHRlciwgYmFzZVVybCkgewogICAgICBsZXQgdXJsID0gYmFzZVVybCArIGA/ZmlsdGVyPSR7ZmlsdGVyfWA7CiAgICAgIGlmICh0aGlzLmFwcFR5cGUgPT09ICJucG8iKSB7CiAgICAgICAgdXJsID0gYmFzZVVybCArIGA/ZmlsdGVyPSR7ZmlsdGVyfSZpc19kb25vcj10cnVlYDsKICAgICAgfQogICAgICB0aGlzLnJlcXVlc3RTdGFydGVkID0gdHJ1ZTsKICAgICAgZmV0Y2godXJsKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICB9KQogICAgICAgIC50aGVuKHRoaXMuYWZ0ZXJGZXRjaCk7CiAgICB9LAogICAgYWZ0ZXJGZXRjaChqc29uKSB7CiAgICAgIHRoaXMuY3VzdG9tZXJMaXN0ID0ganNvbi5kYXRhOwogICAgfSwKICAgIC8vc3VwcGxpZXIKICAgIG9uU3VwcGxpZXJDaGFuZ2UoZXZlbnQpIHsKICAgICAgd2luZG93LmNvbnNvbGUubG9nKGV2ZW50KTsKICAgICAgY29uc3QgdmFsdWUgPSBldmVudC52YWx1ZTsKICAgICAgaWYgKHZhbHVlICYmIHZhbHVlW3RleHRGaWVsZF0gPT09IGVtcHR5SXRlbVt0ZXh0RmllbGRdKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuc3VwcGxpZXIgPSB2YWx1ZTsKICAgICAgdGhpcy5zYWxlT3JkZXIuc3VwcGxpZXIgPSB2YWx1ZTsKICAgIH0sCiAgICBvblN1cHBsaWVyRmlsdGVyQ2hhbmdlKGV2ZW50KSB7CiAgICAgIGNvbnN0IHN1cGZpbHRlciA9IGV2ZW50LmZpbHRlci52YWx1ZTsKICAgICAgdGhpcy5zdXBwbGllclJlcXVlc3REYXRhKDAsIHN1cGZpbHRlciwgdGhpcy5zdXBCYXNlVXJsKTsKICAgIH0sCiAgICBzdXBwbGllclJlcXVlc3REYXRhKHNraXAsIGZpbHRlciwgYmFzZVVybCkgewogICAgICBjb25zdCB1cmwgPSBiYXNlVXJsICsgYD9maWx0ZXI9JHtmaWx0ZXJ9YDsKICAgICAgdGhpcy5yZXF1ZXN0U3RhcnRlZCA9IHRydWU7CiAgICAgIGZldGNoKHVybCkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7CiAgICAgICAgfSkKICAgICAgICAudGhlbih0aGlzLnN1cEFmdGVyRmV0Y2gpOwogICAgfSwKICAgIHN1cEFmdGVyRmV0Y2goanNvbikgewogICAgICB0aGlzLnN1cHBsaWVyTGlzdCA9IGpzb24uZGF0YTsKICAgIH0sCiAgICAvL2VtcGxveWVlCiAgICBvbkVtcGxveWVlQ2hhbmdlKGV2ZW50KSB7CiAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudmFsdWU7CiAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVt0ZXh0RmllbGRdID09PSBlbXB0eUl0ZW1bdGV4dEZpZWxkXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLmVtcGxveWVlID0gdmFsdWU7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmVtcGxveWVlID0gdmFsdWU7CiAgICB9LAogICAgb25FbXBsb3llZUZpbHRlckNoYW5nZWQoZXZlbnQpIHsKICAgICAgY29uc3QgZW1wZmlsdGVyID0gZXZlbnQuZmlsdGVyLnZhbHVlOwogICAgICB0aGlzLmVtcGxveWVlUmVxdWVzdERhdGEoMCwgZW1wZmlsdGVyLCB0aGlzLmVtcEJhc2VVcmwpOwogICAgfSwKICAgIGVtcGxveWVlUmVxdWVzdERhdGEoc2tpcCwgZmlsdGVyLCBiYXNlVXJsKSB7CiAgICAgIGNvbnN0IHVybCA9IGJhc2VVcmwgKyBgP2ZpbHRlcj0ke2ZpbHRlcn1gOwogICAgICB0aGlzLnJlcXVlc3RTdGFydGVkID0gdHJ1ZTsKICAgICAgZmV0Y2godXJsKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICB9KQogICAgICAgIC50aGVuKHRoaXMuZW1wQWZ0ZXJGZXRjaCk7CiAgICB9LAogICAgZW1wQWZ0ZXJGZXRjaChqc29uKSB7CiAgICAgIHRoaXMuZW1wbG95ZWVMaXN0ID0ganNvbi5kYXRhOwogICAgfSwKICAgIHJlbW92ZVJvdyhlKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgY29uc3QgZ3JpZCA9IGtlbmRvLmpRdWVyeSgiI2dyaWRJdGVtTGluZVNhbGVPcmRlciIpLmRhdGEoImtlbmRvR3JpZCIpLAogICAgICAgIGRhdGFTb3VyY2UgPSBncmlkLmRhdGFTb3VyY2UsCiAgICAgICAgZGF0YUl0ZW0gPSBncmlkLmRhdGFJdGVtKCQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCJ0ciIpKTsKCiAgICAgIGlmIChkYXRhU291cmNlLnRvdGFsKCkgPiAxKSB7CiAgICAgICAgZGF0YVNvdXJjZS5yZW1vdmUoZGF0YUl0ZW0pOwogICAgICB9CiAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgfSwKICAgIC8vZGF0ZQogICAgYXN5bmMgb25TYWxlT3JkZXJEYXRlQ2hhbmdlZCgpIHsKICAgICAgaWYgKHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uRGF0ZSkgewogICAgICAgIHRoaXMuc2FsZU9yZGVyLm1vbnRoT2YgPSBuZXcgRGF0ZSh0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbkRhdGUpCiAgICAgICAgICAudG9JU09TdHJpbmcoKQogICAgICAgICAgLnN1YnN0cigwLCA3KTsKICAgICAgfQogICAgICBhd2FpdCB0aGlzLmxvYWRDcmVkaXRMaW1pdCgpOwogICAgICBhd2FpdCB0aGlzLmxvYWRDdXN0b21lckJhbGFuY2UodGhpcy5jdXN0b21lci5pZCk7CiAgICAgIGF3YWl0IHRoaXMub25QcmljZUxldmVsQ2hhbmdlKCk7CiAgICAgIGF3YWl0IHRoaXMubG9hZFBheW1lbnRUZXJtTGlzdCgpOwogICAgICBpZiAodGhpcy5jdXN0b21lcikgewogICAgICAgIGNvbnN0IHBheW1lbnRUZXJtID0gdGhpcy5zYWxlT3JkZXIucGF5bWVudFRlcm0gfHwge307CiAgICAgICAgY29uc3QgbmV0RHVlID0gcGF5bWVudFRlcm0ubmV0RHVlIHx8IDA7CiAgICAgICAgY29uc3Qgc29tZURhdGUgPSBuZXcgRGF0ZSh0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbkRhdGUpOwogICAgICAgIHNvbWVEYXRlLnNldERhdGUoc29tZURhdGUuZ2V0RGF0ZSgpICsgcGFyc2VJbnQobmV0RHVlKSk7IC8vbnVtYmVyICBvZiBkYXlzIHRvIGFkZCwgZS54LiAxNSBkYXlzCiAgICAgICAgdGhpcy5zYWxlT3JkZXIudmFsaWRpdHlEYXRlID0gc29tZURhdGUudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApOwogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygiZHVlRGF0ZSIsIHRoaXMuc2FsZU9yZGVyLnZhbGlkaXR5RGF0ZSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICB9CiAgICB9LAogICAgb25QYXltZW50VGVybUNoYW5nZWQoKSB7CiAgICAgIC8vIHRoaXMub25TYWxlT3JkZXJEYXRlQ2hhbmdlZCgpOwogICAgICBpZiAodGhpcy5jdXN0b21lcikgewogICAgICAgIGNvbnN0IHBheW1lbnRUZXJtID0gdGhpcy5zYWxlT3JkZXIucGF5bWVudFRlcm0gfHwge307CiAgICAgICAgY29uc3QgbmV0RHVlID0gcGF5bWVudFRlcm0ubmV0RHVlIHx8IDA7CiAgICAgICAgY29uc3Qgc29tZURhdGUgPSBuZXcgRGF0ZSh0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbkRhdGUpOwogICAgICAgIHNvbWVEYXRlLnNldERhdGUoc29tZURhdGUuZ2V0RGF0ZSgpICsgcGFyc2VJbnQobmV0RHVlKSk7IC8vbnVtYmVyICBvZiBkYXlzIHRvIGFkZCwgZS54LiAxNSBkYXlzCiAgICAgICAgdGhpcy5zYWxlT3JkZXIudmFsaWRpdHlEYXRlID0gc29tZURhdGUudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApOwogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygiZHVlRGF0ZSIsIHRoaXMuc2FsZU9yZGVyLnZhbGlkaXR5RGF0ZSk7CiAgICAgIH0KICAgIH0sCiAgICAvL251bWJlcgogICAgbnVtYmVyRm9ybWF0KHZhbHVlKSB7CiAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsLCduaW1vbCcpCiAgICAgIHJldHVybiBrZW5kby50b1N0cmluZyh2YWx1ZSwgYG4ke3RoaXMuc2FsZUZvcm1Db250ZW50LmRlY2ltYWx9YCk7CiAgICAgIC8vIHJldHVybiB2YWx1ZQogICAgfSwKICAgIC8vCiAgICBhc3luYyBsb2FkTGVhZCgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAiP3R5cGU9U2FsZSBMZWFkIjsKICAgICAgICAgIHRoaXMubGVhZHMgPSBbXTsKICAgICAgICAgIGJpbGxpbmdIYW5kbGVyLmxpc3Qoc3RyRmlsdGVyKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgaWYgKHJlcykgewogICAgICAgICAgICAgIGlmIChyZXMuZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHRoaXMubGVhZHMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRQYXltZW50VGVybSgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBwYXltZW50VGVybUhhbmRsZXIuZ2V0QWxsKCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5wYXltZW50VGVybXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICBpZiAodGhpcy5wYXltZW50VGVybXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCAhPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT0gIiIKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNhbGVPcmRlcikgewogICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5wYXltZW50VGVybSA9IHRoaXMucGF5bWVudFRlcm1zWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwgMTApOwogICAgICB9KTsKICAgIH0sCiAgICBhc3luYyBsb2FkUHJpY2VMZXZlbCgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAiP25hdHVyZT1zYWxlIjsKICAgICAgICAgIHByaWNlTGV2ZWxIYW5kbGVyLmdldChzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICB0aGlzLnByaWNlTGV2ZWwgPSByZXM7CiAgICAgICAgICAgIGlmICh0aGlzLnByaWNlTGV2ZWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCAhPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT0gIiIKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNhbGVPcmRlcikgewogICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5wcmljZUxldmVsID0gdGhpcy5wcmljZUxldmVsWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5sb2FkVHJhbnNhY3Rpb25SYXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIHJlbW92ZUR1cGxpY2F0ZShhcnJheSkgewogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgbWFwID0gbmV3IE1hcCgpOwogICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgYXJyYXkpIHsKICAgICAgICBpZiAoIW1hcC5oYXMoaXRlbS5pZCkpIHsKICAgICAgICAgIG1hcC5zZXQoaXRlbS5pZCwgdHJ1ZSk7IC8vIHNldCBhbnkgdmFsdWUgdG8gTWFwCiAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICBhdXRvQ2FsY3VsYXRlRGlzY291bnQoZGlzY291bnRJdGVtLCBzdWJUb3RhbCkgewogICAgICBpZiAoZGlzY291bnRJdGVtKSB7CiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJkaXNjb3VudEl0ZW0iLCBkaXNjb3VudEl0ZW0sIHN1YlRvdGFsKTsKICAgICAgICBjb25zdCBuYXR1cmUgPSBkaXNjb3VudEl0ZW0ubmF0dXJlIHx8ICIiOwogICAgICAgIGNvbnN0IGFtb3VudCA9IGRpc2NvdW50SXRlbS5hbW91bnQgfHwgMDsKICAgICAgICBpZiAobmF0dXJlID09PSAiQW1vdW50IikgewogICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoYW1vdW50KTsKICAgICAgICB9IGVsc2UgaWYgKG5hdHVyZSA9PT0gIlBlcmNlbnRhZ2UiKSB7CiAgICAgICAgICByZXR1cm4gc3ViVG90YWwgKiAocGFyc2VGbG9hdChhbW91bnQpIC8gMTAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICB9LAogICAgYXV0b0NhbGN1bGF0ZVRheCh0YXgsIGFtb3VudCkgewogICAgICBpZiAodGF4KSB7CiAgICAgICAgdmFyIGZvcm11bGEgPSB0YXguZm9ybXVsYTsKICAgICAgICB2YXIgaW5BbXQgPSBrZW5kby5wYXJzZUZsb2F0KGFtb3VudCk7CiAgICAgICAgdmFyIG5BbXQgPSBrZW5kby5wYXJzZUZsb2F0KGFtb3VudCk7CiAgICAgICAgdmFyIHRheEJhc2UgPSBrZW5kby5wYXJzZUZsb2F0KHRheC50YXhCYXNlKSAvIDEwMDsKICAgICAgICB2YXIgcmF0ZSA9IGtlbmRvLnBhcnNlRmxvYXQodGF4LnJhdGUpIC8gMTAwOwogICAgICAgIHZhciB0b3RhbCA9IGV2YWwoZm9ybXVsYSk7CiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGluQW10LCBuQW10LCB0YXhCYXNlLCByYXRlLCBmb3JtdWxhLCB0b3RhbCk7CiAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGFtb3VudCkKICAgICAgICByZXR1cm4gdG90YWw7CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIDAKICAgIH0sCiAgICBhdXRvQ2FsY3VsYXRlVGF4QnlUeXBlKHRheCkgewogICAgICAvLyByZXR1cm4gYnkgYSBrZXkKICAgICAgY29uc3QgZ3JvdXBBbGwgPSAobGlzdCkgPT4KICAgICAgICBsaXN0LnJlZHVjZSgodGF4LCBpdGVtKSA9PiB7CiAgICAgICAgICBjb25zdCB0YXhBbW91bnQgPSB0YXhbaXRlbS5uYW1lXSB8fCAwOwogICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRheCwgewogICAgICAgICAgICBbaXRlbS5uYW1lXTogdGF4QW1vdW50ICsgcGFyc2VGbG9hdChpdGVtLmFtb3VudCksCiAgICAgICAgICB9KTsKICAgICAgICB9LCB7fSk7CiAgICAgIHRoaXMudGF4TGlzdFRvdGFsID0gZ3JvdXBBbGwodGF4KTsKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCduaW1vbCcsIGdyb3VwQWxsKHRheCkpCiAgICAgIC8vIHRoaXMuCiAgICB9LAogICAgZGF0YVNvdXJjZUNoYW5nZWQoZSkgewogICAgICBpZiAoZS5maWVsZCkgewogICAgICAgIGxldCBkYXRhUm93ID0gZS5pdGVtc1swXSwKICAgICAgICAgIGJ1b20gPSB7fSwKICAgICAgICAgIGNvbnZlcnNpb25SYXRlID0gMSwKICAgICAgICAgIHdhYyA9IDAsCiAgICAgICAgICBxb2ggPSAwLAogICAgICAgICAgYW1vdW50ID0gMCwKICAgICAgICAgIHhBbW91bnQgPSAwOwogICAgICAgIHN3aXRjaCAoZS5maWVsZCkgewogICAgICAgICAgY2FzZSAiaXRlbSI6CiAgICAgICAgICAgIC8vIHRoaXMuYXR0cmlidXRlXyA9IHRoaXMuYXR0cmlidXRlcy5maWx0ZXIobSA9PiBtLnR5cGUuaWQgPT09IGRhdGFSb3cudmFyaWFudC5pZCkKICAgICAgICAgICAgZGF0YVJvdy5zZXQoImRlc2NyaXB0aW9uIiwgZGF0YVJvdy5pdGVtLmRlc2NyaXB0aW9uKTsKICAgICAgICAgICAgYnVvbSA9IGRhdGFSb3cuaXRlbS51b20gfHwge307CiAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJidW9tIiwgYnVvbSk7CiAgICAgICAgICAgIC8vIHRoaXMuaXRlbUNoYW5nZShkYXRhUm93KQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInVvbSI6CiAgICAgICAgICAgIGlmICh0aGlzLmlzUHJpY2VMZXZlbENoYW5nZWQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGJ1b20gPSBkYXRhUm93LnVvbS5idW9tIHx8IHt9OwogICAgICAgICAgICAgICAgICBxb2ggPSBkYXRhUm93LnVvbS5xb2ggfHwgMDsKICAgICAgICAgICAgICAgICAgY29udmVyc2lvblJhdGUgPSBkYXRhUm93LnVvbS5jb252ZXJzaW9uUmF0ZSB8fCAxOwogICAgICAgICAgICAgICAgICB3YWMgPSBkYXRhUm93LnVvbS53YWMgfHwgMDsKICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCBidW9tKTsKICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoIndhYyIsIHdhYyk7CiAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJxb2giLCBxb2gpOwogICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiY29udmVyc2lvblJhdGUiLCBwYXJzZUZsb2F0KGNvbnZlcnNpb25SYXRlKSk7CiAgICAgICAgICAgICAgICAgIGlmIChkYXRhUm93LnVvbSkgewogICAgICAgICAgICAgICAgICAgIGFtb3VudCA9CiAgICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGRhdGFSb3cudW9tLnByaWNlKSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgIHhBbW91bnQgPSBhbW91bnQgKiBwYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicHJpY2UiLCBwYXJzZUZsb2F0KGRhdGFSb3cudW9tLnByaWNlKSk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0KICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRmxvYXQoZGF0YVJvdy5wcmljZSkgKiBwYXJzZUZsb2F0KGRhdGFSb3cucXR5KTsKICAgICAgICAgICAgICAgICAgICB4QW1vdW50ID0gYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnNhbGVPcmRlci50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInByaWNlIiwgcGFyc2VGbG9hdChkYXRhUm93LnByaWNlKSk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYnVvbSIsIHt9KTsKICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgMSk7CiAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwcmljZSIsIDApOwogICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicW9oIiwgMCk7CiAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJ3YWMiLCAwKTsKICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIDApOwogICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwcmljZSIsIDApOwogICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInByaWNlIjoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBhbW91bnQgPSBwYXJzZUZsb2F0KGRhdGFSb3cucHJpY2UpICogcGFyc2VGbG9hdChkYXRhUm93LnF0eSk7CiAgICAgICAgICAgICAgeEFtb3VudCA9IGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CgogICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwcmljZSIsIHBhcnNlRmxvYXQoZGF0YVJvdy5wcmljZSkpOwogICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJleGNoYW5nZUFtb3VudCIsIHhBbW91bnQpOwogICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygncHJpY2UnLGRhdGFSb3cucHJpY2UpCiAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwcmljZSIsIDApOwogICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCAwKTsKICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInF0eSI6CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYW1vdW50ID0gcGFyc2VGbG9hdChkYXRhUm93LnByaWNlKSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgIHhBbW91bnQgPSBhbW91bnQgKiBwYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwoKICAgICAgICAgICAgICBkYXRhUm93LnNldCgicHJpY2UiLCBwYXJzZUZsb2F0KGRhdGFSb3cucHJpY2UpKTsKICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgYW1vdW50KTsKICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCB4QW1vdW50KTsKICAgICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInByaWNlIiwgMCk7CiAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIDApOwogICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJleGNoYW5nZUFtb3VudCIsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAib3RoZXJUYXgiOgogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coIi0tIiwgZGF0YVJvdykKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKGUuZmllbGQpIHsKICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGF1dG9DYWxjdWxhdGUoKSB7CiAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgIHN1YlRvdGFsID0gMCwKICAgICAgICB0b3RhbFRheCA9IDAsCiAgICAgICAgZGlzY291bnRUb3RhbCA9IDAsCiAgICAgICAgc3BUYXggPSAwLAogICAgICAgIHBsdGF4ID0gMCwKICAgICAgICBvdGhlclRheCA9IDAsCiAgICAgICAgdmF0VGF4ID0gMCwKICAgICAgICBkaXNjb3VudEludm9pY2UgPSAwLAogICAgICAgIHRheExpc3QgPSBbXSwKICAgICAgICBkaXNjb3VudEl0ZW0gPSBbXSwKICAgICAgICBzYWxlVW5pdCA9IFtdLAogICAgICAgIGluY2x1c2l2ZVRheCA9IDAsCiAgICAgICAgaXRlbVN1YnRvdGFsID0gMCwKICAgICAgICB0eG5JdG1TdWJ0b3RhbCA9IDAsCiAgICAgICAgc2VydmljZVN1YnRvdGFsID0gMCwKICAgICAgICBpdGVtRGlzY291bnQgPSAwLAogICAgICAgIHNlcnZpY2VEaXNjb3VudCA9IDAsCiAgICAgICAgdHhuRGlzY291bnQgPSAwOwoKICAgICAgY29uc3Qgcm93cyA9IGRzLmRhdGEoKS5maWx0ZXIoKG0pID0+IHBhcnNlRmxvYXQobS5hbW91bnQpID4gMCk7CiAgICAgIHJvd3MuZm9yRWFjaCgodmFsdWUpID0+IHsKICAgICAgICBsZXQgbW9kaWZpZXJQcmljZSA9IDA7CiAgICAgICAgaWYgKHZhbHVlLm1vZGlmaWVyKSB7CiAgICAgICAgICBtb2RpZmllclByaWNlID0ga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5tb2RpZmllci5wcmljZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBzdWJUb3RhbCArPSAoa2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpICsgbW9kaWZpZXJQcmljZSkKICAgICAgICBsZXQgZGlzY291bnQgPSAwOwogICAgICAgIGlmICh2YWx1ZS5kaXNjb3VudEl0ZW0pIHsKICAgICAgICAgIGxldCBzdWJUbyA9CiAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgZGlzY291bnQgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCh2YWx1ZS5kaXNjb3VudEl0ZW0sIHN1YlRvKTsKICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygKICAgICAgICAgICAgImRpc2NvdW50IGl0ZW0iLAogICAgICAgICAgICBkaXNjb3VudCwKICAgICAgICAgICAgIi0tIiwKICAgICAgICAgICAgdmFsdWUuZGlzY291bnRJdGVtCiAgICAgICAgICApOwogICAgICAgICAgdmFsdWVbImRpc2NvdW50QW1vdW50Il0gPSBkaXNjb3VudDsKICAgICAgICAgIHZhbHVlWyJkaXNjb3VudEV4Y2hhbmdlQW1vdW50Il0gPQogICAgICAgICAgICBkaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CiAgICAgICAgICBpZiAodmFsdWUuZGlzY291bnRJdGVtLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgIGRpc2NvdW50SXRlbS5wdXNoKHZhbHVlLmRpc2NvdW50SXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgICBkaXNjb3VudFRvdGFsICs9IGRpc2NvdW50OwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWUuc2FsZVVuaXQpIHsKICAgICAgICAgIGlmICh2YWx1ZS5zYWxlVW5pdC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICBzYWxlVW5pdC5wdXNoKHZhbHVlLnNhbGVVbml0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlLnNwZWNpZmljVGF4KSB7CiAgICAgICAgICBzcFRheCA9IHRoaXMuYXV0b0NhbGN1bGF0ZVRheCgKICAgICAgICAgICAgdmFsdWUuc3BlY2lmaWNUYXgsCiAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50KSAtIGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnQpCiAgICAgICAgICApOwogICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdzcCAnLCBkaXNjb3VudCkKICAgICAgICAgIHNwVGF4ID0ga2VuZG8ucGFyc2VGbG9hdChzcFRheCkgPyBrZW5kby5wYXJzZUZsb2F0KHNwVGF4KSA6IDA7CiAgICAgICAgICB2YWx1ZVsic3BlY2lmaWNUYXhBbW91bnQiXSA9IHNwVGF4OwogICAgICAgICAgdmFsdWVbInNwZWNpZmljVGF4RXhjaGFuZ2VBbW91bnQiXSA9CiAgICAgICAgICAgIHNwVGF4ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnNhbGVPcmRlci50eG5SYXRlKTsKICAgICAgICAgIGNvbnN0IHRheCA9IHZhbHVlLnNwZWNpZmljVGF4OwogICAgICAgICAgY29uc3QgYmFzZUFtb3VudCA9IHRheC5iYXNlQW1vdW50OwogICAgICAgICAgaWYgKGJhc2VBbW91bnQpIHsKICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gImluY2x1c2l2ZSIpIHsKICAgICAgICAgICAgICBpbmNsdXNpdmVUYXggKz0gc3BUYXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZS5zcGVjaWZpY1RheC5oYXNPd25Qcm9wZXJ0eSgidGF4VHlwZSIpKSB7CiAgICAgICAgICAgIHRheExpc3QucHVzaCh7CiAgICAgICAgICAgICAgbmFtZTogdmFsdWUuc3BlY2lmaWNUYXgudGF4VHlwZS5uYW1lLAogICAgICAgICAgICAgIGFtb3VudDogc3BUYXgsCiAgICAgICAgICAgICAgaWQ6IHZhbHVlLnNwZWNpZmljVGF4LnRheFR5cGUuaWQsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodmFsdWUucHVibGljTGlnaHRpbmdUYXgpIHsKICAgICAgICAgIHBsdGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KAogICAgICAgICAgICB2YWx1ZS5wdWJsaWNMaWdodGluZ1RheCwKICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpIC0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCkKICAgICAgICAgICk7CiAgICAgICAgICBwbHRheCA9IGtlbmRvLnBhcnNlRmxvYXQocGx0YXgpID8ga2VuZG8ucGFyc2VGbG9hdChwbHRheCkgOiAwOwogICAgICAgICAgdmFsdWVbInB1YmxpY0xpZ2h0aW5nVGF4QW1vdW50Il0gPSBwbHRheDsKICAgICAgICAgIHZhbHVlWyJwdWJsaWNMaWdodGluZ1RheEV4Y2hhbmdlQW1vdW50Il0gPQogICAgICAgICAgICBwbHRheCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CiAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS5wdWJsaWNMaWdodGluZ1RheDsKICAgICAgICAgIGNvbnN0IGJhc2VBbW91bnQgPSB0YXguYmFzZUFtb3VudDsKICAgICAgICAgIGlmIChiYXNlQW1vdW50KSB7CiAgICAgICAgICAgIGlmIChiYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkgPT09ICJpbmNsdXNpdmUiKSB7CiAgICAgICAgICAgICAgaW5jbHVzaXZlVGF4ICs9IHBsdGF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsdWUucHVibGljTGlnaHRpbmdUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICB0YXhMaXN0LnB1c2goewogICAgICAgICAgICAgIG5hbWU6IHZhbHVlLnB1YmxpY0xpZ2h0aW5nVGF4LnRheFR5cGUubmFtZSwKICAgICAgICAgICAgICBhbW91bnQ6IHBsdGF4LAogICAgICAgICAgICAgIGlkOiB2YWx1ZS5wdWJsaWNMaWdodGluZ1RheC50YXhUeXBlLmlkLAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlLm90aGVyVGF4KSB7CiAgICAgICAgICBvdGhlclRheCA9IHRoaXMuYXV0b0NhbGN1bGF0ZVRheCgKICAgICAgICAgICAgdmFsdWUub3RoZXJUYXgsCiAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50KSAtIGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnQpCiAgICAgICAgICApOwogICAgICAgICAgb3RoZXJUYXggPSBrZW5kby5wYXJzZUZsb2F0KG90aGVyVGF4KQogICAgICAgICAgICA/IGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXgpCiAgICAgICAgICAgIDogMDsKICAgICAgICAgIHZhbHVlWyJvdGhlclRheEFtb3VudCJdID0gb3RoZXJUYXg7CiAgICAgICAgICB2YWx1ZVsib3RoZXJUYXhFeGNoYW5nZUFtb3VudCJdID0KICAgICAgICAgICAgb3RoZXJUYXggKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwogICAgICAgICAgY29uc3QgdGF4ID0gdmFsdWUub3RoZXJUYXg7CiAgICAgICAgICBjb25zdCBiYXNlQW1vdW50ID0gdGF4LmJhc2VBbW91bnQ7CiAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIikgewogICAgICAgICAgICAgIGluY2x1c2l2ZVRheCArPSBvdGhlclRheDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlLm90aGVyVGF4Lmhhc093blByb3BlcnR5KCJ0YXhUeXBlIikpIHsKICAgICAgICAgICAgdGF4TGlzdC5wdXNoKHsKICAgICAgICAgICAgICBuYW1lOiB2YWx1ZS5vdGhlclRheC50YXhUeXBlLm5hbWUsCiAgICAgICAgICAgICAgYW1vdW50OiBvdGhlclRheCwKICAgICAgICAgICAgICBpZDogdmFsdWUub3RoZXJUYXgudGF4VHlwZS5pZCwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodmFsdWUudmF0VGF4KSB7CiAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ1ZhdCBUYXgnLCB2YWx1ZS52YXRUYXgpCiAgICAgICAgICBsZXQgYW10ID0KICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzcFRheCA/IHNwVGF4IDogMCkgKwogICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHBsdGF4ID8gcGx0YXggOiAwKSArCiAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXggPyBvdGhlclRheCA6IDApICsKICAgICAgICAgICAgKGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50ID8gdmFsdWUuYW1vdW50IDogMCkgLQogICAgICAgICAgICAgIChkaXNjb3VudCA/IGRpc2NvdW50IDogMCkpOwogICAgICAgICAgdmF0VGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KHZhbHVlLnZhdFRheCwgYW10KTsKICAgICAgICAgIHZhdFRheCA9IGtlbmRvLnBhcnNlRmxvYXQodmF0VGF4KSA/IGtlbmRvLnBhcnNlRmxvYXQodmF0VGF4KSA6IDA7CiAgICAgICAgICB2YWx1ZVsidmF0VGF4QW1vdW50Il0gPSB2YXRUYXg7CiAgICAgICAgICB2YWx1ZVsidmF0VGF4RXhjaGFuZ2VBbW91bnQiXSA9CiAgICAgICAgICAgIHZhdFRheCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CiAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS52YXRUYXg7CiAgICAgICAgICBjb25zdCBiYXNlQW1vdW50ID0gdGF4LmJhc2VBbW91bnQ7CiAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIikgewogICAgICAgICAgICAgIGluY2x1c2l2ZVRheCArPSB2YXRUYXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICB0YXhMaXN0LnB1c2goewogICAgICAgICAgICAgIG5hbWU6IHZhbHVlLnZhdFRheC50YXhUeXBlLm5hbWUsCiAgICAgICAgICAgICAgYW1vdW50OiB2YXRUYXgsCiAgICAgICAgICAgICAgaWQ6IHZhbHVlLnZhdFRheC50YXhUeXBlLmlkLAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdG90YWxUYXggKz0KICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQoc3BUYXggPyBzcFRheCA6IDApICsKICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQocGx0YXggPyBwbHRheCA6IDApICsKICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXggPyBvdGhlclRheCA6IDApICsKICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmF0VGF4ID8gdmF0VGF4IDogMCk7CiAgICAgICAgc3ViVG90YWwgKz0KICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50KSArIG1vZGlmaWVyUHJpY2UgLSBpbmNsdXNpdmVUYXg7CgogICAgICAgIGNvbnN0IGl0ZW0gPSB2YWx1ZS5pdGVtOwogICAgICAgIGNvbnN0IGl0bVR5cGUgPSBpdGVtLnR5cGUgfHwgIiI7CiAgICAgICAgaWYgKGl0bVR5cGUgPT09ICJWYXJpYW50IikgewogICAgICAgICAgaXRlbVN1YnRvdGFsICs9CiAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgaXRlbURpc2NvdW50ICs9IGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnQpOwogICAgICAgIH0gZWxzZSBpZiAoaXRtVHlwZSA9PT0gIlNlcnZpY2UiKSB7CiAgICAgICAgICBzZXJ2aWNlU3VidG90YWwgKz0KICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5wcmljZSkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSk7CiAgICAgICAgICBzZXJ2aWNlRGlzY291bnQgKz0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR4bkl0bVN1YnRvdGFsICs9CiAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgdHhuRGlzY291bnQgKz0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCk7CiAgICAgICAgfQogICAgICAgIC8vaW5jbHVkZSBUYXggQW1vdW50CiAgICAgICAgY29uc3QgYW1vdW50Tm9kaXNjb3VudCA9CiAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnByaWNlKSAqIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucXR5KSAtCiAgICAgICAgICBkaXNjb3VudDsKICAgICAgICBjb25zdCBpbmNsdWRlVGF4QW1vdW50ID0KICAgICAgICAgIGFtb3VudE5vZGlzY291bnQgKyB2YXRUYXggKyBwbHRheCArIHNwVGF4ICsgb3RoZXJUYXg7CiAgICAgICAgdmFsdWVbImluY2x1ZGVUYXhBbW91bnQiXSA9IGluY2x1ZGVUYXhBbW91bnQ7CiAgICAgICAgdmFsdWVbImluY2x1ZGVUYXhFeGNoYW5nZUFtb3VudCJdID0KICAgICAgICAgIGluY2x1ZGVUYXhBbW91bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwogICAgICB9KTsKCiAgICAgIHRoaXMuc2FsZU9yZGVyLml0ZW1TdWJ0b3RhbCA9IGl0ZW1TdWJ0b3RhbDsKICAgICAgdGhpcy5zYWxlT3JkZXIuZXhjaGFuZ2VJdGVtU3VidG90YWwgPQogICAgICAgIGl0ZW1TdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CgogICAgICB0aGlzLnNhbGVPcmRlci5zZXJ2aWNlU3VidG90YWwgPSBzZXJ2aWNlU3VidG90YWw7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlU2VydmljZVN1YnRvdGFsID0KICAgICAgICBzZXJ2aWNlU3VidG90YWwgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwogICAgICB0aGlzLnNhbGVPcmRlci50eG5JdG1TdWJ0b3RhbCA9IHR4bkl0bVN1YnRvdGFsOwogICAgICB0aGlzLnNhbGVPcmRlci5leGNoYW5nZVR4bkl0bVN1YnRvdGFsID0KICAgICAgICB0eG5JdG1TdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CgogICAgICB0aGlzLnNhbGVPcmRlci5pdGVtRGlzY291bnQgPSBpdGVtRGlzY291bnQ7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlSXRlbURpc2NvdW50ID0KICAgICAgICBpdGVtRGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwogICAgICB0aGlzLnNhbGVPcmRlci5zZXJ2aWNlRGlzY291bnQgPSBzZXJ2aWNlRGlzY291bnQ7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlU2VydmljZURpc2NvdW50ID0KICAgICAgICBzZXJ2aWNlRGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnR4blJhdGUpOwogICAgICB0aGlzLnNhbGVPcmRlci50eG5JdG1EaXNjb3VudCA9IHR4bkRpc2NvdW50OwogICAgICB0aGlzLnNhbGVPcmRlci5leGNoYW5nZVR4bkl0bURpc2NvdW50ID0KICAgICAgICB0eG5EaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CgogICAgICBkaXNjb3VudFRvdGFsID0gZGlzY291bnRUb3RhbCA/IGRpc2NvdW50VG90YWwgOiAwOwoKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHNwVGF4LCBwbHRheCwgb3RoZXJUYXgsIHZhdFRheCkKICAgICAgbGV0IHRvdGFsID0KICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHN1YlRvdGFsKSAtCiAgICAgICAga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudFRvdGFsKSArCiAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0b3RhbFRheCk7CiAgICAgIHRoaXMuc2FsZU9yZGVyLnN1YlRvdGFsID0gc3ViVG90YWw7CiAgICAgIHRoaXMuc2FsZU9yZGVyLnRvdGFsVGF4QW1vdW50ID0ga2VuZG8ucGFyc2VGbG9hdCh0b3RhbFRheCk7CiAgICAgIHRoaXMuc2FsZU9yZGVyLmRpc2NvdW50VG90YWwgPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50VG90YWwpOwogICAgICBpZiAodGhpcy5zYWxlT3JkZXIuc3BlY2lmaWNEaXNjb3VudEl0ZW0pIHsKICAgICAgICBkaXNjb3VudEludm9pY2UgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCgKICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnNwZWNpZmljRGlzY291bnRJdGVtLAogICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzdWJUb3RhbCkKICAgICAgICApOwogICAgICAgIGRpc2NvdW50SW52b2ljZSA9IGRpc2NvdW50SW52b2ljZSA/IGRpc2NvdW50SW52b2ljZSA6IDA7CiAgICAgIH0KICAgICAgLy8gdGhpcy5vbk90aGVyQ2hhcmdlQ2hhbmdlKCkKICAgICAgdGhpcy5zYWxlT3JkZXIudG90YWwgPQogICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodG90YWwpIC0KICAgICAgICBkaXNjb3VudEludm9pY2UgKwogICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIub3RoZXJDaGFyZ2VBbW91bnQpOwogICAgICB0aGlzLnNhbGVPcmRlci5leGNoYW5nZUFtb3VudCA9CiAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnNhbGVPcmRlci50b3RhbCkgKgogICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIudHhuUmF0ZSk7CiAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZVRheEJ5VHlwZSh0YXhMaXN0KTsKICAgICAgdGhpcy5jdXN0b21lckRpc2NvdW50SXRlbSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKGRpc2NvdW50SXRlbSk7CiAgICAgIHRoaXMuY3VzdG9tZXJTYWxlVW5pdCA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKHNhbGVVbml0KTsKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdkaXNjb3VudCAnLCB0aGlzLmN1c3RvbWVyRGlzY291bnRJdGVtKQogICAgfSwKICAgIHJvd051bWJlclRtcGwoZGF0YUl0ZW0pIHsKICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCksCiAgICAgICAgaW5kZXggPSBkcy5pbmRleE9mKGRhdGFJdGVtKTsKICAgICAgcmV0dXJuIGluZGV4ICsgMTsKICAgIH0sCiAgICBhc3luYyBsb2FkU2FsZUZvcm1Db250ZW50KCkgewogICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgIHNhbGVGb3JtQ29udGVudEhhbmRsZXIubGlzdCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zYWxlRm9ybUNvbnRlbnQgPSBkYXRhWzBdOwogICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGRhdGFbMF0pCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIHZhdFRlbXBsYXRlKGRhdGFJdGVtKSB7CiAgICAgIGNvbnN0IHZhdCA9IGRhdGFJdGVtLnZhdFRheDsKICAgICAgaWYgKHZhdCkgewogICAgICAgIHJldHVybiBgPHNwYW4+JHt2YXQuZGVmYXVsdFRheCA/IHZhdC5kZWZhdWx0VGF4IDogYGB9PC9zcGFuPmA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGBgOwogICAgICB9CiAgICB9LAogICAgaXRlbVRlbXBsYXRlKGRhdGFJdGVtKSB7CiAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhSXRlbS5pdGVtOwogICAgICBpZiAoaXRlbSkgewogICAgICAgIHJldHVybiBgPHNwYW4+JHtpdGVtLm5hbWUgPyBpdGVtLm5hbWUgOiBgYH08L3NwYW4+YDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYGA7CiAgICAgIH0KICAgIH0sCiAgICBVT01UZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICBjb25zdCB1b20gPSBkYXRhSXRlbS51b207CiAgICAgIGlmICh1b20pIHsKICAgICAgICByZXR1cm4gYDxzcGFuPiR7dW9tLnVvbSA/IHVvbS51b20ubmFtZSA6IGBgfTwvc3Bhbj5gOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBgYDsKICAgICAgfQogICAgfSwKICAgIHNhbGVVbml0VGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgY29uc3Qgc2FsZVVuaXQgPSBkYXRhSXRlbS5zYWxlVW5pdDsKICAgICAgaWYgKHNhbGVVbml0KSB7CiAgICAgICAgcmV0dXJuIGA8c3Bhbj4ke3NhbGVVbml0Lm5hbWUgPyBzYWxlVW5pdC5uYW1lIDogYGB9PC9zcGFuPmA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGBgOwogICAgICB9CiAgICB9LAogICAgZGlzY291bnRJdGVtVGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgY29uc3QgZGlzY291bnRJdGVtID0gZGF0YUl0ZW0uZGlzY291bnRJdGVtOwogICAgICBpZiAoZGlzY291bnRJdGVtKSB7CiAgICAgICAgcmV0dXJuIGA8c3Bhbj4ke2Rpc2NvdW50SXRlbS5jb2RlID8gZGlzY291bnRJdGVtLmNvZGUgOiBgYH0gLSAkewogICAgICAgICAgZGlzY291bnRJdGVtLm5hbWUgPyBkaXNjb3VudEl0ZW0ubmFtZSA6IGBgCiAgICAgICAgfTwvc3Bhbj5gOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBgYDsKICAgICAgfQogICAgfSwKICAgIFNlcnZpY2VEYXRlRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICBrZW5kbwogICAgICAgIC5qUXVlcnkoJzxpbnB1dCByZXF1aXJlZCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgLmtlbmRvRGF0ZVBpY2tlcigpOwoKICAgICAgLy8gbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGRzLmRhdGEoKSkKICAgICAgLy8gLy8gY29uc3QgZGF0ZVN0cmluZyA9IGtlbmRvLnRvU3RyaW5nKChuZXcgRGF0ZShvcHRpb25zLm1vZGVsLml0ZW1zLnNlcnZpY2VEYXRlKSksIHRoaXMuaXRlbUxpbmUuZGF0ZUZvcm1hdCkKICAgICAgLy8gLy8gY29uc3QgZGF0ZVN0cmluZyA9IGtlbmRvLnRvU3RyaW5nKG9wdGlvbnMubW9kZWwuaXRlbXMuc2VydmljZURhdGUpCiAgICAgIC8vIGNvbnN0ICRpbnB1dCA9ICQoIjxpbnB1dCB2YWx1ZT0iICsgb3B0aW9ucy5tb2RlbC5zZXJ2aWNlRGF0ZSArICIgLz4iKS5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgIC8vICRpbnB1dC5rZW5kb0RhdGVQaWNrZXIoKQogICAgICAvLyAvLyAkaW5wdXQuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAvLyAvLyBvcHRpb25zLm1vZGVsLml0ZW1zLnNlcnZpY2VEYXRlID0gZGF0ZVN0cmluZwogICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJGlucHV0KQogICAgfSwKICAgIFNlcnZpY2VEYXRlVG9FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgIGtlbmRvCiAgICAgICAgLmpRdWVyeSgnPGlucHV0IHJlcXVpcmVkIG5hbWU9IicgKyBvcHRpb25zLmZpZWxkICsgJyIvPicpCiAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAua2VuZG9EYXRlUGlja2VyKCk7CiAgICB9LAogICAgSXRlbURyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICBrZW5kbwogICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAibmFtZSIsCiAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgIjxzcGFuPkl0ZW1zIDwvc3Bhbj4iICsKICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9bmFtZSM8L3NwYW4+IiwKICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgcmVhZDogewogICAgICAgICAgICAgICAgdXJsOiBwcm9kdWN0VmFyaWFudEhhbmRsZXIuaXRlbVNlYXJjaFVSTCgKICAgICAgICAgICAgICAgICAgIj9wbElkPSIgKyB0aGlzLnNhbGVPcmRlci5wcmljZUxldmVsLmlkCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgZmllbGRzOiB7CiAgICAgICAgICAgICAgICAgIGlkOiB7IHR5cGU6ICJzdHJpbmciIH0sCiAgICAgICAgICAgICAgICAgIG5hbWU6IHsgdHlwZTogInN0cmluZyIgfSwKICAgICAgICAgICAgICAgICAgc2t1OiB7IHR5cGU6ICJzdHJpbmciIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHRvdGFsOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmNvdW50OwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIGRhdGE6IHRoaXMudmFyaWFudHMKICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgfSwKICAgIFVPTURyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICBrZW5kbwogICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJ1b20ubmFtZSIsCiAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogInVvbS5pZCIsCiAgICAgICAgICBjYXNjYWRlRnJvbTogIml0ZW0iLAogICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPXVvbS5uYW1lIHx8IGBObyBQcmljZSBMZXZlbGAjPC9zcGFuPiIsCiAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICBzZXJ2ZXJGaWx0ZXJpbmc6IHRydWUsCiAgICAgICAgICAgIHRyYW5zcG9ydDogewogICAgICAgICAgICAgIHJlYWQ6IHsKICAgICAgICAgICAgICAgIC8vIHVybDogdW9tUHJpY2VIYW5kbGVyLmdldFVSTChvcHRpb25zLm1vZGVsLml0ZW0uaWQsIHRoaXMuc2FsZU9yZGVyLnByaWNlTGV2ZWwuaWQpLAogICAgICAgICAgICAgICAgdXJsOiB1b21QcmljZUhhbmRsZXIudW9tUHJpY2VCeVByaWNlTGV2ZWxVUkwoCiAgICAgICAgICAgICAgICAgICJpZD0iICsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLml0ZW0uaWQgKwogICAgICAgICAgICAgICAgICAgICImcGxJZD0iICsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5wcmljZUxldmVsLmlkICsKICAgICAgICAgICAgICAgICAgICAiJmRhdGU9IiArCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIudHJhbnNhY3Rpb25EYXRlCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgZmllbGRzOiB7CiAgICAgICAgICAgICAgICAgIGlkOiB7IHR5cGU6ICJzdHJpbmciIH0sCiAgICAgICAgICAgICAgICAgIC8vIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgIC8vIHNrdToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLy8gZGF0YTogdGhpcy52YXJpYW50cwogICAgICAgICAgfSksCiAgICAgICAgfSk7CiAgICB9LAogICAgRGlzY291bnRJdGVtRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgIGtlbmRvCiAgICAgICAgLmpRdWVyeSgnPGlucHV0IG5hbWU9IicgKyBvcHRpb25zLmZpZWxkICsgJyIvPicpCiAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJpZCIsCiAgICAgICAgICBjYXNjYWRlRnJvbTogIml0ZW0iLAogICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWNvZGUjIC0gIz1uYW1lIzwvc3Bhbj4iLAogICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgc2VydmVyRmlsdGVyaW5nOiB0cnVlLAogICAgICAgICAgICB0cmFuc3BvcnQ6IHsKICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICB1cmw6IGRpc2NvdW50SXRlbUhhbmRsZXIuZ2V0VVJMKERJU0NPVU5UX1RZUEUpLAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgZmllbGRzOiB7CiAgICAgICAgICAgICAgICAgIGlkOiB7IHR5cGU6ICJzdHJpbmciIH0sCiAgICAgICAgICAgICAgICAgIC8vIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgIC8vIHNrdToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgfSwKICAgIFNwZWNpZmljVGF4RHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgIGtlbmRvCiAgICAgICAgLmpRdWVyeSgnPGlucHV0IG5hbWU9IicgKyBvcHRpb25zLmZpZWxkICsgJyIvPicpCiAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgZGF0YVRleHRGaWVsZDogImRlZmF1bHRUYXgiLAogICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJpZCIsCiAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9ZGVmYXVsdFRheCM8L3NwYW4+IiwKICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgIGRhdGE6IHRoaXMuc3BlY2lmaWNUYXguZmlsdGVyKChtKSA9PiB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMubW9kZWwuaGFzT3duUHJvcGVydHkoInZhdFRheCIpKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXQgPSBvcHRpb25zLm1vZGVsLnZhdFRheDsKICAgICAgICAgICAgICAgIGlmICh2YXQpIHsKICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubW9kZWwudmF0VGF4ICE9PSBudWxsIHx8CiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC52YXRUYXggIT09ICJudWxsIgogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlbC52YXRUYXguYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgbS5iYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkgPT09CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubW9kZWwudmF0VGF4LmJhc2VBbW91bnQudG9Mb3dlckNhc2UoKQogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLAogICAgICAgICAgfSksCiAgICAgICAgfSk7CiAgICB9LAogICAgUHVibGljTGlnaHRpbmdUYXhEcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAga2VuZG8KICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgZmlsdGVyOiAic3RhcnRzd2l0aCIsCiAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAiZGVmYXVsdFRheCIsCiAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1kZWZhdWx0VGF4Izwvc3Bhbj4iLAogICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgZGF0YTogdGhpcy5wdWJsaWNMaWdodGluZ1RheC5maWx0ZXIoKG0pID0+IHsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlbC5oYXNPd25Qcm9wZXJ0eSgidmF0VGF4IikpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhdCA9IG9wdGlvbnMubW9kZWwudmF0VGF4OwogICAgICAgICAgICAgICAgaWYgKHZhdCkgewogICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC52YXRUYXggIT09IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLnZhdFRheCAhPT0gIm51bGwiCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm1vZGVsLnZhdFRheC5iYXNlQW1vdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICBtLmJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0KICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC52YXRUYXguYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksCiAgICAgICAgICB9KSwKICAgICAgICB9KTsKICAgIH0sCiAgICBPdGhlclRheERyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICBrZW5kbwogICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJkZWZhdWx0VGF4IiwKICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWRlZmF1bHRUYXgjPC9zcGFuPiIsCiAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICBkYXRhOiB0aGlzLm90aGVyVGF4LmZpbHRlcigobSkgPT4gewogICAgICAgICAgICAgIGlmIChvcHRpb25zLm1vZGVsLmhhc093blByb3BlcnR5KCJ2YXRUYXgiKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmF0ID0gb3B0aW9ucy5tb2RlbC52YXRUYXg7CiAgICAgICAgICAgICAgICBpZiAodmF0KSB7CiAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLnZhdFRheCAhPT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubW9kZWwudmF0VGF4ICE9PSAibnVsbCIKICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMubW9kZWwudmF0VGF4LmJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgIG0uYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PQogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLnZhdFRheC5iYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgfSwKICAgIFZhdFRheERyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICBrZW5kbwogICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJkZWZhdWx0VGF4IiwKICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWRlZmF1bHRUYXgjPC9zcGFuPiIsCiAgICAgICAgICBvcHRpb25MYWJlbDogIi0tU2VsZWN0LS0iLAogICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgIGRhdGE6IHRoaXMudmF0VGF4LAogICAgICAgICAgfSksCiAgICAgICAgfSk7CiAgICB9LAogICAgU2FsZVVuaXREcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAga2VuZG8KICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgZmlsdGVyOiAic3RhcnRzd2l0aCIsCiAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAibmFtZSIsCiAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1jb2RlIyAtICM9bmFtZSM8L3NwYW4+IiwKICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgIGRhdGE6IHRoaXMuc2FsZVVuaXRJdGVtTGlzdCwKICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgfSwKICAgIE1vZGlmaWVyRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgIGNvbnN0IGl0ZW0gPSBvcHRpb25zLm1vZGVsLml0ZW0gfHwge307CiAgICAgIGNvbnN0IHVvbSA9IGl0ZW0udW9tIHx8IHt9OwogICAgICBjb25zdCBpdGVtSWQgPSBpdGVtLmlkIHx8ICIiOwogICAgICBjb25zdCB1b21JZCA9IHVvbS5pZCB8fCAiIjsKICAgICAga2VuZG8KICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgZmlsdGVyOiAiY29udGFpbnMiLAogICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJpZCIsCiAgICAgICAgICBoZWFkZXJUZW1wbGF0ZToKICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImRyb3Bkb3duLWhlYWRlciBrLXdpZGdldCBrLWhlYWRlciI+JyArCiAgICAgICAgICAgICI8c3Bhbj5Nb2RpZmllciA8L3NwYW4+IiArCiAgICAgICAgICAgICI8c3Bhbj48L3NwYW4+IiArCiAgICAgICAgICAgICI8L2Rpdj4iLAogICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICBzZXJ2ZXJGaWx0ZXJpbmc6IHRydWUsCiAgICAgICAgICAgIHRyYW5zcG9ydDogewogICAgICAgICAgICAgIHJlYWQ6IHsKICAgICAgICAgICAgICAgIHVybDogaXRlbU1vZGlmaWVySGFuZGxlci5zZWFyY2hVUkwoCiAgICAgICAgICAgICAgICAgICI/cGxJZD0iICsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5wcmljZUxldmVsLmlkICsKICAgICAgICAgICAgICAgICAgICAiJmlkPSIgKwogICAgICAgICAgICAgICAgICAgIGl0ZW1JZCArCiAgICAgICAgICAgICAgICAgICAgIiZ1b21JZD0iICsKICAgICAgICAgICAgICAgICAgICB1b21JZAogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNjaGVtYTogewogICAgICAgICAgICAgIG1vZGVsOiB7CiAgICAgICAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgICAgICAgIGZpZWxkczogewogICAgICAgICAgICAgICAgICBpZDogeyB0eXBlOiAic3RyaW5nIiB9LAogICAgICAgICAgICAgICAgICBuYW1lOiB7IHR5cGU6ICJzdHJpbmciIH0sCiAgICAgICAgICAgICAgICAgIHByaWNlOiB7IHR5cGU6ICJudW1iZXIiIH0sCiAgICAgICAgICAgICAgICAgIHVvbTogeyB0eXBlOiAic3RyaW5nIiB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB0b3RhbDogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5jb3VudDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgICAgfSksCiAgICAgICAgfSk7CiAgICB9LAogICAgRW1wbG95ZWVEcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAga2VuZG8KICAgICAgICAualF1ZXJ5KCc8aW5wdXQgZGF0YS1iaW5kPSJ2YWx1ZTonICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgLmtlbmRvTXVsdGlTZWxlY3QoewogICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgIHN1Z2dlc3Q6IHRydWUsCiAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAibmFtZSIsCiAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgIjxzcGFuPkVtcGxveWVlIDwvc3Bhbj4iICsKICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9bmFtZSM8L3NwYW4+IiwKICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgcmVhZDogewogICAgICAgICAgICAgICAgdXJsOiBlbXBsb3llZUhhbmRsZXIuc2VhcmNoVVJMKCksCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgICAgICB9LAogICAgICAgICAgICBzY2hlbWE6IHsKICAgICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgICAgICBmaWVsZHM6IHsKICAgICAgICAgICAgICAgICAgaWQ6IHsgdHlwZTogInN0cmluZyIgfSwKICAgICAgICAgICAgICAgICAgbmFtZTogeyB0eXBlOiAic3RyaW5nIiB9LAogICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHsgdHlwZTogInN0cmluZyIgfSwKICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHsgdHlwZTogInN0cmluZyIgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgfSwKICAgIGVtcEltcGwoZGF0YUl0ZW0pIHsKICAgICAgbGV0IGVtcElkcyA9IFtdOwogICAgICBkYXRhSXRlbS5lbXBsb3llZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgZW1wSWRzLnB1c2gobS5maXJzdE5hbWUgKyAiIC0gIiArIG0ubGFzdE5hbWUpOwogICAgICB9KTsKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGVtcElkcy5qb2luKCcsICcpKQogICAgICByZXR1cm4gYDxzcGFuPiR7ZW1wSWRzLmpvaW4oIiwgIil9PC9zcGFuPmA7CiAgICB9LAogICAgYWRkUm93KCkgewogICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICB0b3RhbCA9IGRzLnRvdGFsKCk7CiAgICAgIHRoaXMuaXRlbUxpbmUuaWQgPSBpbnZvaWNlUHJlZml4ICsgdXVpZC52MSgpOwogICAgICBkcy5pbnNlcnQodG90YWwsIHRoaXMuaXRlbUxpbmUpOwogICAgfSwKICAgIG9uU3BlY2lmaWNEaXNjb3VudENoYW5nZWQoKSB7CiAgICAgIGlmICh0aGlzLnNhbGVPcmRlci5zcGVjaWZpY0Rpc2NvdW50SXRlbSkgewogICAgICAgIGNvbnN0IGRpc2NvdW50T3JkZXIgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCgKICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnNwZWNpZmljRGlzY291bnRJdGVtLAogICAgICAgICAgdGhpcy5zYWxlT3JkZXIuc3ViVG90YWwKICAgICAgICApOwogICAgICAgIHRoaXMuc2FsZU9yZGVyLnNwZWNpZmljRGlzY291bnRUb3RhbCA9IGtlbmRvLnRvU3RyaW5nKAogICAgICAgICAgZGlzY291bnRPcmRlciA/IGRpc2NvdW50T3JkZXIgOiAwLAogICAgICAgICAgIm4iCiAgICAgICAgKTsKICAgICAgICBsZXQgdG90YWwgPQogICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnNhbGVPcmRlci5zdWJUb3RhbCkgLQogICAgICAgICAgKGtlbmRvLnBhcnNlRmxvYXQodGhpcy5zYWxlT3JkZXIuZGlzY291bnRUb3RhbCkgKwogICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRoaXMuc2FsZU9yZGVyLnRvdGFsVGF4QW1vdW50KSkgLQogICAgICAgICAgZGlzY291bnRPcmRlcjsKICAgICAgICB0aGlzLnNhbGVPcmRlci50b3RhbCA9IGtlbmRvLnRvU3RyaW5nKHRvdGFsLCAibiIpOwogICAgICB9CiAgICB9LAogICAgb25PdGhlckNoYXJnZUNoYW5nZSgpIHsKICAgICAgbGV0IG90aGVyQ2hhcmdlID0gMDsKICAgICAgdGhpcy5tT3RoZXJDaGFyZ2UuZm9yRWFjaCgobSkgPT4gewogICAgICAgIG90aGVyQ2hhcmdlICs9IHRoaXMuYXV0b0NhbGN1bGF0ZURpc2NvdW50KG0sIHRoaXMuc2FsZU9yZGVyLnN1YlRvdGFsKTsKICAgICAgfSk7CiAgICAgIHRoaXMuc2FsZU9yZGVyLm90aGVyQ2hhcmdlQW1vdW50ID0gb3RoZXJDaGFyZ2U7CiAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgfSwKICAgIGFzeW5jIGxvYWRPdGhlckNoYXJnZSgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBvdGhlckNoYXJnZUhhbmRsZXIubGlzdCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgdGhpcy5vdGhlckNoYXJnZUxpc3QgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIG9uT3RoZXJBbW91bnQodmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXMuYXV0b0NhbGN1bGF0ZURpc2NvdW50KHZhbHVlLCB0aGlzLnNhbGVPcmRlci5zdWJUb3RhbCk7CiAgICB9LAogICAgYXN5bmMgbG9hZERpc2NvdW50SXRlbSgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBkaXNjb3VudEl0ZW1IYW5kbGVyLmxpc3QoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgIHRoaXMuc3BlY2lmaWNEaXNjb3VudEl0ZW0gPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRTZWdtZW50KCkgewogICAgICB0aGlzLnNlZ21lbnRzID0gW107CiAgICAgIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDA7CiAgICAgIGlmIChyb2xlVHlwZSA9PT0gMCkgewogICAgICAgIGlmIChkYXRhU3RvcmUucm9sZURhdGEpIHsKICAgICAgICAgIGNvbnN0IHJvbGVEYXRhID0gZGF0YVN0b3JlLnJvbGVEYXRhIHx8IFtdOwogICAgICAgICAgY29uc3Qgc2VnbWVudCA9IHJvbGVEYXRhLmZpbHRlcigoaXRtKSA9PiBpdG0udHlwZSA9PT0gInNlZ21lbnQiKTsKICAgICAgICAgIGNvbnN0IHNlZ21lbnREZWZhdWx0ID0gc2VnbWVudC5maWx0ZXIoKG0pID0+IG0uaXNEZWZhdWx0ID09PSAxKTsKICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSBzZWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09ICIiCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHNlZ21lbnREZWZhdWx0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5zZWdtZW50ID0gc2VnbWVudERlZmF1bHRbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocm9sZVR5cGUgPT09IDEpIHsKICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSBbXTsKICAgICAgICAgICAgc2V0dGluZ3NIYW5kbGVyLmdldFNlZygpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDEwKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGFzeW5jIGxvYWRMb2NhdGlvbigpIHsKICAgICAgdGhpcy5sb2NhdGlvbnMgPSBbXTsKICAgICAgY29uc3Qgcm9sZVR5cGUgPSBkYXRhU3RvcmUucm9sZVR5cGUgfHwgMDsKICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgaWYgKGRhdGFTdG9yZS5yb2xlRGF0YSkgewogICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW107CiAgICAgICAgICBjb25zdCBsb2NhdGlvbiA9IHJvbGVEYXRhLmZpbHRlcigoaXRtKSA9PiBpdG0udHlwZSA9PT0gImxvY2F0aW9uIik7CiAgICAgICAgICBjb25zdCBsb2NhdGlvbkRlZmF1bHQgPSBsb2NhdGlvbi5maWx0ZXIoKG0pID0+IG0uaXNEZWZhdWx0ID09PSAxKTsKICAgICAgICAgIHRoaXMubG9jYXRpb25zID0gbG9jYXRpb247CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gIiIKICAgICAgICAgICkgewogICAgICAgICAgICBpZiAobG9jYXRpb25EZWZhdWx0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5sb2NhdGlvbiA9IGxvY2F0aW9uRGVmYXVsdFswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChyb2xlVHlwZSA9PT0gMSkgewogICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSBbXTsKICAgICAgICAgICAgbG9jYXRpb25IYW5kbGVyLmxpc3QoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgMTApOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgYXN5bmMgbG9hZFByb2plY3RCeUN1c3RvbWVyKCkgewogICAgICB0aGlzLmN1c3RvbWVyUHJvamVjdHMgPSBbXTsKICAgICAgY29uc3Qgcm9sZVR5cGUgPSBkYXRhU3RvcmUucm9sZVR5cGUgfHwgMDsKICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgaWYgKGRhdGFTdG9yZS5yb2xlRGF0YSkgewogICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW107CiAgICAgICAgICBjb25zdCBwcm9qZWN0ID0gcm9sZURhdGEuZmlsdGVyKChpdG0pID0+IGl0bS50eXBlID09PSAicHJvamVjdCIpOwogICAgICAgICAgcHJvamVjdC5mb3JFYWNoKChrKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGN1c3RvbWVycyA9IGsuY3VzdG9tZXJzIHx8IFtdOwogICAgICAgICAgICBjb25zdCBwcm9DdXN0b21lciA9IGN1c3RvbWVycy5maWx0ZXIoCiAgICAgICAgICAgICAgKG4pID0+IG4uY3VzdG9tZXIuaWQgPT09IHRoaXMuY3VzdG9tZXIuaWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKHByb0N1c3RvbWVyLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB0aGlzLmN1c3RvbWVyUHJvamVjdHMucHVzaChrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gIiIKICAgICAgICAgICkgewogICAgICAgICAgICBjb25zdCBwcm9qZWN0RGVmYXVsdCA9IHRoaXMuY3VzdG9tZXJQcm9qZWN0cy5maWx0ZXIoCiAgICAgICAgICAgICAgKG0pID0+IG0uaXNEZWZhdWx0ID09PSAxCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChwcm9qZWN0RGVmYXVsdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIucHJvamVjdCA9IHByb2plY3REZWZhdWx0WzBdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHJvbGVUeXBlID09PSAxKSB7CiAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICBwcm9qZWN0SGFuZGxlci5nZXRCeUN1c3RvbWVyKHRoaXMuY3VzdG9tZXIuaWQpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgMTApOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgYXN5bmMgbG9hZFNhbGVDaGFubmVsKCkgewogICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgc2FsZUNoYW5uZWxIYW5kbGVyLmdldCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIHRoaXMuc2FsZUNoYW5uZWxMaXN0ID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICBpZiAodGhpcy5zYWxlQ2hhbm5lbExpc3QubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT0gIiIKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5zYWxlQ2hhbm5lbCA9IHRoaXMuc2FsZUNoYW5uZWxMaXN0WzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0sIDEwKTsKICAgICAgfSk7CiAgICB9LAogICAgYXN5bmMgbG9hZFRheCgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBzZXR0aW5nSGFuZGxlci5nZXQoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgdGhpcy50YXggPSByZXM7CiAgICAgICAgICAgIHRoaXMub3RoZXJUYXggPSB0aGlzLnRheC5maWx0ZXIoCiAgICAgICAgICAgICAgKG0pID0+CiAgICAgICAgICAgICAgICAobS50YXhUeXBlLnR5cGVJZCA9PT0gNyB8fCBtLnRheFR5cGUudHlwZUlkID09PSAxMCkgJiYKICAgICAgICAgICAgICAgIG0udHJhbnNhY3Rpb25UeXBlID09PSAiU2FsZSIKICAgICAgICAgICAgKTsgLy8gdmFsdWFibGUgdGF4CiAgICAgICAgICAgIHRoaXMuc3BlY2lmaWNUYXggPSB0aGlzLnRheC5maWx0ZXIoCiAgICAgICAgICAgICAgKG0pID0+CiAgICAgICAgICAgICAgICAobS50YXhUeXBlLnR5cGVJZCA9PT0gOCB8fCBtLnRheFR5cGUudHlwZUlkID09PSAxMCkgJiYKICAgICAgICAgICAgICAgIG0udHJhbnNhY3Rpb25UeXBlID09PSAiU2FsZSIKICAgICAgICAgICAgKTsgLy8gdmFsdWFibGUgdGF4CiAgICAgICAgICAgIHRoaXMucHVibGljTGlnaHRpbmdUYXggPSB0aGlzLnRheC5maWx0ZXIoCiAgICAgICAgICAgICAgKG0pID0+CiAgICAgICAgICAgICAgICAobS50YXhUeXBlLnR5cGVJZCA9PT0gOSB8fCBtLnRheFR5cGUudHlwZUlkID09PSAxMCkgJiYKICAgICAgICAgICAgICAgIG0udHJhbnNhY3Rpb25UeXBlID09PSAiU2FsZSIKICAgICAgICAgICAgKTsgLy8gdmFsdWFibGUgdGF4CiAgICAgICAgICAgIHRoaXMudmF0VGF4ID0gdGhpcy50YXguZmlsdGVyKAogICAgICAgICAgICAgIChtKSA9PgogICAgICAgICAgICAgICAgKG0udGF4VHlwZS50eXBlSWQgPT09IDEgfHwKICAgICAgICAgICAgICAgICAgbS50YXhUeXBlLnR5cGVJZCA9PT0gOCB8fAogICAgICAgICAgICAgICAgICBtLnRheFR5cGUudHlwZUlkID09PSAxMCkgJiYKICAgICAgICAgICAgICAgIG0udHJhbnNhY3Rpb25UeXBlID09PSAiU2FsZSIKICAgICAgICAgICAgKTsgLy8gdmFsdWFibGUgdGF4CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRTYWxlVW5pdEl0ZW1zKCkgewogICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgIHNhbGVVbml0SXRlbUhhbmRsZXIubGlzdCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKQogICAgICAgICAgICAgIHRoaXMuc2FsZVVuaXRJdGVtTGlzdCA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRDdXN0b21lckJhbGFuY2UoaWQpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSBpZCArICI/dHlwZT1iYWwiOwogICAgICAgICAgYmlsbGluZ0hhbmRsZXIKICAgICAgICAgICAgLmJhbGFuY2Uoc3RyRmlsdGVyKQogICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLmN1cnJlbnRCYWxhbmNlID0gZGF0YVswXS5iYWxhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNhdGNoKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGNyZWRpdExpbWl0VXNhZ2UoYmFsYW5jZSwgY3JlZGl0TGltaXQpIHsKICAgICAgbGV0IG51bSA9IDA7CiAgICAgIGxldCBwZXIgPSAoYmFsYW5jZSAvIGNyZWRpdExpbWl0KSAqIDEwMDsKICAgICAgaWYgKGlzTmFOKHBlcikpIHsKICAgICAgICAvLyBJdCBpc24ndCBhIG51bWJlcgogICAgICAgIG51bSA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSXQgaXMgYSBudW1iZXIKICAgICAgICBudW0gPSBwZXI7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bSArICIgJSI7CiAgICB9LAogICAgY2xvc2UoZGF0YSkgewogICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7CiAgICAgICAgICBuYW1lOiAiQ3VzdG9tZXJzIiwKICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgfSwKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3aW5kb3cuaGlzdG9yeS5nbygtMSk7CiAgICAgIH0KICAgICAgd2luZG93LmNvbnNvbGUubG9nKGRhdGEsICJjbG9zZSIpOwogICAgICAvLyBsb2NhbFN0b3JhZ2UuZGF0YS5pZCA9IEpTT04uc3RyaW5naWZ5KGRhdGEpCiAgICB9LAogICAgLy9jYXRhbG9nCiAgICBsb2FkSW1hZ2UoZGF0YUl0ZW0pIHsKICAgICAgaWYgKGRhdGFJdGVtLmhhc093blByb3BlcnR5KCJpbWFnZXMiKSkgewogICAgICAgIGlmIChkYXRhSXRlbS5pbWFnZXMuaGFzT3duUHJvcGVydHkoImRlZmF1bHQiKSkgewogICAgICAgICAgY29uc3QgdXJsID0gdGhpcy5pbWdVUkwgKyBkYXRhSXRlbS5pbWFnZXMuZGVmYXVsdC50aHVtYjsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICI8aW1nIHdpZHRoPSc1MCcgaGVpZ2h0PSc1MCcgc3R5bGU9ICdtYXJnaW46IGF1dG87ZGlzcGxheTogYmxvY2s7JyBzcmM9JyIgKwogICAgICAgICAgICB1cmwgKwogICAgICAgICAgICAiJyAvPiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgfSwKICAgIGFzeW5jIGxvYWRDYXRhbG9ncygpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgIGNhdGFsb2dIYW5kbGVyLmdldCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2F0YWxvZ3MgPSByZXM7CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFkZENhdGFsb2coZSkgewogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGxldCBncmlkID0ga2VuZG8ualF1ZXJ5KCIjZ3JpZENhdGFsb2ciKS5kYXRhKCJrZW5kb0dyaWQiKTsKICAgICAgbGV0IGRhdGFJdGVtID0gZ3JpZC5kYXRhSXRlbSgkKGUuY3VycmVudFRhcmdldCkuY2xvc2VzdCgidHIiKSk7CiAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhSXRlbSkKICAgICAgaWYgKGRhdGFJdGVtLnZhcmlhbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICBkYXRhSXRlbS52YXJpYW50cy5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICBpZiAobS5oYXNPd25Qcm9wZXJ0eSgidmFyaWFudCIpKSB7CiAgICAgICAgICAgIGlmIChtLnZhcmlhbnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICB0aGlzLmxvYWRTaW5nbGVJdGVtKG0udmFyaWFudC5pZCwgImkiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMuZGlhbG9nQ2F0YWxvZyA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChkYXRhSXRlbS5zZXJ2aWNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgZGF0YUl0ZW0uc2VydmljZXMuZm9yRWFjaCgobSkgPT4gewogICAgICAgICAgaWYgKG0uaGFzT3duUHJvcGVydHkoInNlcnZpY2UiKSkgewogICAgICAgICAgICBpZiAobS5zZXJ2aWNlLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgdGhpcy5sb2FkU2luZ2xlSXRlbShtLnNlcnZpY2UuaWQsICJzIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLmRpYWxvZ0NhdGFsb2cgPSBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIGFzeW5jIGxvYWRTaW5nbGVJdGVtKGl0ZW1JZCwgdHlwZSkgewogICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgIHByb2R1Y3RIYW5kbGVyLmdldE9uZShpdGVtSWQpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBkYXRhID0gcmVzOwogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coZGF0YSk7CiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgICAgICAgIHRvdGFsID0gZHMudG90YWwoKTsKICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5pZCA9IGludm9pY2VQcmVmaXggKyB1dWlkLnYxKCk7CiAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaXRlbSA9IGRhdGE7CiAgICAgICAgICAgIGlmICh0eXBlID09ICJpIikgewogICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuZGVzY3JpcHRpb24gPSBkYXRhLnZhcmlhbnQuc2FsZURlc2NyaXB0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuZGVzY3JpcHRpb24gPSBkYXRhLnNhbGVEZXNjcmlwdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkcy5pbnNlcnQodG90YWwsIHRoaXMuaXRlbUxpbmUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwgNTAwKTsKICAgICAgfSk7CiAgICB9LAogICAgYXN5bmMgbG9hZFByZWZpeCgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBwcmVmaXhIYW5kbGVyLmdldCgic2FsZSBvcmRlciIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25UeXBlID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICBpZiAodGhpcy50cmFuc2FjdGlvblR5cGUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIudHJhbnNhY3Rpb25UeXBlID0gdGhpcy50cmFuc2FjdGlvblR5cGVbMF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5pdHNhbGVPcmRlcikgewogICAgICAgICAgICAgICAgICB0aGlzLmdlbmVyYXRlTnVtYmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRWaWV3c2FsZU9yZGVyKCkgewogICAgICBpZiAoIXRoaXMuaW5pdHNhbGVPcmRlcikgewogICAgICAgIHRoaXMuaXNFZGl0ID0gdHJ1ZTsKICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICBzYWxlT3JkZXJIYW5kbGVyCiAgICAgICAgICAgICAgLnZpZXcodGhpcy4kcm91dGUucGFyYW1zLmlkKQogICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlciA9IHJlcy5kYXRhLmRhdGFbMF07CiAgICAgICAgICAgICAgICAgIHRoaXMucXVvdGVzID0gdGhpcy5zYWxlT3JkZXIucmVmRnJvbSB8fCBbXTsKICAgICAgICAgICAgICAgICAgdGhpcy5iaW5kRGF0YSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLmNhdGNoKCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIDEwKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldERlZmF1bHREYXRhKCk7CiAgICAgIH0KICAgIH0sCiAgICBhc3luYyBsb2FkUXVvdGUoKSB7CiAgICAgIGlmICh0aGlzLnNhbGVPcmRlci5jdXN0b21lcikgewogICAgICAgIHRoaXMucmVmRnJvbSA9IFtdOwogICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucXVvdGVzID0gW107CiAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICBsZXQgZGF0YSA9IHsKICAgICAgICAgICAgICBtZXRob2Q6ICJieV9jdXN0b21lciIsCiAgICAgICAgICAgICAgY3VzdG9tZXI6IHRoaXMuc2FsZU9yZGVyLmN1c3RvbWVyLmlkLAogICAgICAgICAgICAgIHNlZ21lbnRJZDogdGhpcy5zYWxlT3JkZXIuc2VnbWVudC5pZCwKICAgICAgICAgICAgICBsb2NhdGlvbklkOiB0aGlzLnNhbGVPcmRlci5sb2NhdGlvbi5pZCwKICAgICAgICAgICAgICBwcmljZUxldmVsSWQ6IHRoaXMuc2FsZU9yZGVyLnByaWNlTGV2ZWwuaWQsCiAgICAgICAgICAgICAgdHlwZTogIlNhbGUgUXVvdGUiLAogICAgICAgICAgICB9OwogICAgICAgICAgICBzYWxlT3JkZXJIYW5kbGVyLnNlYXJjaChkYXRhKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgdGhpcy5xdW90ZXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDEwKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGFkZFF1b3RlKGRhdGEpIHsKICAgICAgLy9hZGQgaXRlbSBsaW5lcwogICAgICBsZXQgdHhuRGF0YSA9IGRhdGEudHhuRGF0YSB8fCB7fTsKICAgICAgY29uc3QgaXRlbUxpbmVzID0gZGF0YS5pdGVtTGluZXMgfHwgW107CiAgICAgIHRoaXMucmVmRnJvbS5wdXNoKHsKICAgICAgICBpZDogZGF0YS5pZCB8fCAiIiwKICAgICAgICByZWZlcmVuY2U6IGRhdGEubnVtYmVyIHx8ICIiLAogICAgICAgIGN1c3RvbWVySWQ6IHR4bkRhdGEuY3VzdG9tZXJJZCB8fCAiIiwKICAgICAgfSk7CiAgICAgIGlmIChpdGVtTGluZXMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMucmVtb3ZlRW1wdHlMaW5lKCk7CiAgICAgICAgaXRlbUxpbmVzLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgIG0udHhuX2FkZF9pZCA9IHR4bkRhdGEuaWQ7CiAgICAgICAgICBtLmlkID0gaW52b2ljZVByZWZpeCArIHV1aWQudjEoKTsKICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgICAgICB0b3RhbCA9IGRzLnRvdGFsKCk7CiAgICAgICAgICBkcy5pbnNlcnQodG90YWwsIG0pOwogICAgICAgIH0pOwogICAgICAgIC8vIHRoaXMuYWRkUm93KCk7CiAgICAgIH0KICAgICAgLy9hZGQgb3RoZXIgY2hhcmQKICAgICAgaWYgKGRhdGEub3RoZXJDaGFyZ2UubGVuZ3RoID4gMCkgewogICAgICAgIGRhdGEub3RoZXJDaGFyZ2UuZm9yRWFjaCgobSkgPT4gewogICAgICAgICAgbS50eG5fYWRkX2lkID0gdHhuRGF0YS5pZDsKICAgICAgICAgIHRoaXMubU90aGVyQ2hhcmdlLnB1c2gobSk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgdGhpcy5vbk90aGVyQ2hhcmdlQ2hhbmdlKCk7CiAgICAgIH0KICAgICAgLy8gYWRkIHR4bmxpc3QKICAgICAgdGhpcy50eG5MaXN0cy5wdXNoKHR4bkRhdGEpOwogICAgICBpZiAodHhuRGF0YS5sZWFkLmlkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLnR4bkxpc3RzLnB1c2godHhuRGF0YS5sZWFkKTsKICAgICAgfQogICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2codGhpcy50eG5MaXN0cyk7CiAgICAgIC8vcmVtb3ZlIHR4bgogICAgICBjb25zdCBpbmRleCA9IHRoaXMucXVvdGVzLmZpbmRJbmRleCgoaXRlbSkgPT4gewogICAgICAgIHJldHVybiBkYXRhLmlkID09PSBpdGVtLmlkOwogICAgICB9KTsKICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgIHRoaXMucXVvdGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIC8vIHRoaXMucXVvdGVzW2luZGV4XS5pc19hZGRlZCA9IHRydWUKICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHRoaXMucXVvdGVzKQogICAgICB0aGlzLnNhbGVPcmRlci5yZWZGcm9tID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUodGhpcy5yZWZGcm9tKTsKICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJyZWYiLCB0aGlzLnNhbGVPcmRlci5yZWZGcm9tKTsKICAgIH0sCiAgICByZW1vdmVFbXB0eUxpbmUoKSB7CiAgICAgIGNvbnN0IGdyaWQgPSBrZW5kby5qUXVlcnkoIiNncmlkSXRlbUxpbmVTYWxlT3JkZXIiKS5kYXRhKCJrZW5kb0dyaWQiKSwKICAgICAgICBkYXRhU291cmNlID0gZ3JpZC5kYXRhU291cmNlOwogICAgICBkYXRhU291cmNlLmRhdGEoKS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgaWYgKG0pIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBtLml0ZW0gfHwge307CiAgICAgICAgICBpZiAoaXRlbS5pZCA9PT0gdW5kZWZpbmVkIHx8IGl0ZW0uaWQgPT09ICIiKSB7CiAgICAgICAgICAgIGRhdGFTb3VyY2UucmVtb3ZlKG0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgYXN5bmMgbG9hZFRyYW5zYWN0aW9uUmF0ZSgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUodGhpcy5zYWxlT3JkZXIudHJhbnNhY3Rpb25EYXRlKQogICAgICAgICAgICAudG9JU09TdHJpbmcoKQogICAgICAgICAgICAuc3Vic3RyKDAsIDEwKTsKICAgICAgICAgIGNvbnN0IHByaWNlTGV2ZWwgPSB0aGlzLnNhbGVPcmRlci5wcmljZUxldmVsOwogICAgICAgICAgbGV0IGNvZGUgPSAiIjsKICAgICAgICAgIGlmIChwcmljZUxldmVsLmhhc093blByb3BlcnR5KCJjdXJyZW5jeSIpKSB7CiAgICAgICAgICAgIGlmIChwcmljZUxldmVsLmN1cnJlbmN5Lmhhc093blByb3BlcnR5KCJjb2RlIikpIHsKICAgICAgICAgICAgICBjb2RlID0gcHJpY2VMZXZlbC5jdXJyZW5jeS5jb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29kZSAhPT0gdW5kZWZpbmVkIHx8IGNvZGUgIT09ICIiKSB7CiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICBjdXJyZW5jeUhhbmRsZXIKICAgICAgICAgICAgICAuZ2V0TGFzdEV4Y2hhbmdlUmF0ZUJ5RGF0ZShkYXRlLCBjb2RlKQogICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB0aGlzLmV4Y2hhbmdlUmF0ZSA9IHJlcy5kYXRhLmRhdGFbMF07CiAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVuY3lDb2RlID0gdGhpcy5leGNoYW5nZVJhdGUuY29kZTsKICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvblJhdGUgPSB0aGlzLmV4Y2hhbmdlUmF0ZS5yYXRlOwogICAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci50eG5SYXRlID0gdGhpcy5leGNoYW5nZVJhdGUucmF0ZTsKICAgICAgICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIuZXhjaGFuZ2VSYXRlID0gdGhpcy5leGNoYW5nZVJhdGU7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGNsZWFyKCkgewogICAgICB0aGlzLmlkID0gdW5kZWZpbmVkOwogICAgICB0aGlzLnNhbGVPcmRlciA9IHt9OwogICAgICB0aGlzLml0ZW1MaW5lcyA9IFtdOwogICAgICB0aGlzLmN1c3RvbWVyID0gIiI7CiAgICAgIHRoaXMuZ2VuZXJhdGVOdW1iZXIoKTsKICAgIH0sCiAgICBzYXZlQ2xvc2UoKSB7CiAgICAgIGxldCBpZCA9ICIiOwogICAgICBpZiAodGhpcy5jdXN0b21lci5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgIGlkID0gdGhpcy5jdXN0b21lci5pZCB8fCAiIjsKICAgICAgfQogICAgICBpZiAoaWQgPT09ICIiKSB7CiAgICAgICAgdGhpcy4kc25vdGlmeS5lcnJvcigiY3VzdG9tZXIgaXMgcmVxdWlyZSIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKTsKICAgICAgbGV0IGQxID0gZHMuZGF0YSgpLmZpbHRlcigobSkgPT4gbS5hbW91bnQgPiAwKTsKICAgICAgbGV0IGRhdGFWYWxpZGF0ZSA9IDA7CiAgICAgIGQxLmZvckVhY2goKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgIGlmICh2YWx1ZS5pdGVtLmlkID09IHVuZGVmaW5lZCB8fCB2YWx1ZS51b20uaWQgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLiRzbm90aWZ5LmVycm9yKAogICAgICAgICAgICAiUGxlYXNlIGNoZWNrIEl0ZW0gb3IgVW9tICBvbiByb3cgIiArIChpbmRleCArIDEpCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkYXRhVmFsaWRhdGUgKz0gMTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAoZDEubGVuZ3RoID09IGRhdGFWYWxpZGF0ZSkgewogICAgICAgIHRoaXMuaXNTYXZlQ2xvc2UgPSB0cnVlOwogICAgICAgIHRoaXMuc2F2ZU9wdGlvbiA9ICJzYXZlQ2xvc2UiOwogICAgICAgIHRoaXMuc2F2ZSgpOwogICAgICB9CiAgICB9LAogICAgc2F2ZVByaW50KCkgewogICAgICB0aGlzLmlzU2F2ZVByaW50ID0gdHJ1ZTsKICAgICAgdGhpcy5zYXZlT3B0aW9uID0gInNhdmVQcmludCI7CiAgICAgIHRoaXMuc2F2ZSgpOwogICAgfSwKICAgIHNhdmVOZXcoKSB7CiAgICAgIHRoaXMuc2F2ZU9wdGlvbiA9ICJzYXZlTmV3IjsKICAgICAgdGhpcy5pc1NhdmVOZXcgPSB0cnVlOwogICAgICB0aGlzLnNhdmUoKTsKICAgIH0sCiAgICBjYW5jZWwoKSB7CiAgICAgIHRoaXMuJHN3YWwoewogICAgICAgIHRpdGxlOiBpMThuLnQoIm1zZ190aXRsZV93YXJuaW5nIiksCiAgICAgICAgdGV4dDogaTE4bi50KCJtc2dfZGlzY2FyZCIpLAogICAgICAgIGljb246ICJ3YXJuaW5nIiwKICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLAogICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IGkxOG4udCgiY2FuY2VsIiksCiAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiAiIzRkNDg0OCIsCiAgICAgICAgY2FuY2VsQnV0dG9uQ29sb3I6ICIjRUQxQTNBIiwKICAgICAgICBjb25maXJtQnV0dG9uVGV4dDogaTE4bi50KCJkaXNjYXJkIiksCiAgICAgIH0pLnRoZW4oKHJlc3VsdENlbikgPT4gewogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhyZXN1bHRDZW4pOwogICAgICAgIGlmIChyZXN1bHRDZW4udmFsdWUpIHsKICAgICAgICAgIHRoaXMuJHJvdXRlci5nbygtMSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBzYXZlRHJhZnQoKSB7CiAgICAgIHRoaXMuc2F2ZU9wdGlvbiA9ICJzYXZlRHJhZnQiOwogICAgICB0aGlzLmlzU2F2ZURyYWZ0ID0gdHJ1ZTsKICAgICAgdGhpcy5zYXZlKCk7CiAgICB9LAogICAgYXN5bmMgc2F2ZSgpIHsKICAgICAgaWYgKCF0aGlzLiRyZWZzLmZvcm0udmFsaWRhdGUoKSkgewogICAgICAgIHRoaXMuJHJlZnMuZm9ybS52YWxpZGF0ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgIHRoaXMucmVtb3ZlRW1wdHlMaW5lKCk7CiAgICAgICAgICBsZXQgaXRlbUxpbmVEUyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgICAgICB0b3RhbCA9IGl0ZW1MaW5lRFMudG90YWwoKTsKICAgICAgICAgIGxldCBpdG1MaW5lcyA9IGl0ZW1MaW5lRFMKICAgICAgICAgICAgLmRhdGEoKQogICAgICAgICAgICAuZmlsdGVyKChtKSA9PiBtLmFtb3VudCA+IDApCiAgICAgICAgICAgIC5tYXAoKG0pID0+IHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IEl0ZW1MaW5lTW9kZWwobSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmICh0b3RhbCA8PSAwKSB7CiAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoIkZpZWxkIFJlcXVpcmVkISIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRoaXMuaXNSZXF1cmVkUHVyY2hhc2UpIHsKICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIuc3VwcGxpZXIgPSB7fTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vaXMgZm9yIHB1cmNoYXNlCiAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyVHlwZSA9IDU7CiAgICAgICAgICB9CiAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coaXRtTGluZXMsICdpdG1MaW5lcycpCiAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoaXRtTGluZXMpLCAnaXRtTGluZXMnKQogICAgICAgICAgbGV0IGRhdGEgPSB7CiAgICAgICAgICAgIGlkOiB0aGlzLnNhbGVPcmRlci5pZCA/IHRoaXMuc2FsZU9yZGVyLmlkIDogIiIsCiAgICAgICAgICAgIHR5cGU6ICJTYWxlIE9yZGVyIiwKICAgICAgICAgICAgdHJhbnNhY3Rpb25UeXBlOiB0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvblR5cGUsCiAgICAgICAgICAgIG51bWJlcjogdGhpcy5zYWxlT3JkZXIubnVtYmVyLAogICAgICAgICAgICBhYmJyOiB0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvblR5cGUuYWJiciwKICAgICAgICAgICAgdHJhbnNhY3Rpb25EYXRlOiB0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbkRhdGUsCiAgICAgICAgICAgIHRyYW5zYWN0aW9uRGF0ZVRaOiBIZWxwZXIudG9JU09EYXRlKHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uRGF0ZSksCiAgICAgICAgICAgIHZhbGlkaXR5RGF0ZTogdGhpcy5zYWxlT3JkZXIudmFsaWRpdHlEYXRlLAogICAgICAgICAgICBtb250aE9mOiB0aGlzLnNhbGVPcmRlci5tb250aE9mLAogICAgICAgICAgICBjdXN0b21lcjogdGhpcy5zYWxlT3JkZXIuY3VzdG9tZXIsCiAgICAgICAgICAgIHBheW1lbnRUZXJtOiB0aGlzLnNhbGVPcmRlci5wYXltZW50VGVybSwKICAgICAgICAgICAgZGlzY291bnRQcm9tb3Rpb246IHt9LAogICAgICAgICAgICBwcmljZUxldmVsOiB0aGlzLnNhbGVPcmRlci5wcmljZUxldmVsLAogICAgICAgICAgICBpdGVtTGluZXM6IGl0bUxpbmVzLAogICAgICAgICAgICBzZWdtZW50OiB0aGlzLnNhbGVPcmRlci5zZWdtZW50LAogICAgICAgICAgICBsb2NhdGlvbjogdGhpcy5zYWxlT3JkZXIubG9jYXRpb24sCiAgICAgICAgICAgIHByb2plY3Q6IHRoaXMuc2FsZU9yZGVyLnByb2plY3QsCiAgICAgICAgICAgIHNhbGVDaGFubmVsOiB0aGlzLnNhbGVPcmRlci5zYWxlQ2hhbm5lbCwKICAgICAgICAgICAgYmlsbGluZ0FkZHJlc3M6IHRoaXMuc2FsZU9yZGVyLmJpbGxpbmdBZGRyZXNzLAogICAgICAgICAgICBkZWxpdmVyeUFkZHJlc3M6IHRoaXMuc2FsZU9yZGVyLmRlbGl2ZXJ5QWRkcmVzcywKICAgICAgICAgICAgZGVsaXZlcnlEYXRlVGltZTogdGhpcy5zYWxlT3JkZXIuZGVsaXZlcnlEYXRlVGltZSwKICAgICAgICAgICAgdHJhbnNhY3Rpb25Ob3RlOiB0aGlzLnNhbGVPcmRlci50cmFuc2FjdGlvbk5vdGUsCiAgICAgICAgICAgIHN1YlRvdGFsOiB0aGlzLnNhbGVPcmRlci5zdWJUb3RhbCwKICAgICAgICAgICAgdG90YWw6IHRoaXMuc2FsZU9yZGVyLnRvdGFsLAogICAgICAgICAgICBhbW91bnQ6IHRoaXMuc2FsZU9yZGVyLmFtb3VudCwKICAgICAgICAgICAgZGlzY291bnRUb3RhbDogdGhpcy5zYWxlT3JkZXIuZGlzY291bnRUb3RhbCwKICAgICAgICAgICAgc3BlY2lmaWNEaXNjb3VudFRvdGFsOiB0aGlzLnNhbGVPcmRlci5zcGVjaWZpY0Rpc2NvdW50VG90YWwsCiAgICAgICAgICAgIGRlbGl2ZXJ5RmVlOiB0aGlzLnNhbGVPcmRlci5kZWxpdmVyeUZlZSwKICAgICAgICAgICAgdG90YWxUYXhBbW91bnQ6IHRoaXMuc2FsZU9yZGVyLnRvdGFsVGF4QW1vdW50LAogICAgICAgICAgICBjdXJyZW50QmFsYW5jZTogdGhpcy5zYWxlT3JkZXIuY3VycmVudEJhbGFuY2UsCiAgICAgICAgICAgIGNyZWRpdExpbWl0OiB0aGlzLnNhbGVPcmRlci5jcmVkaXRMaW1pdCwKICAgICAgICAgICAgc2F2ZU9wdGlvbjogdGhpcy5zYXZlT3B0aW9uLAogICAgICAgICAgICB0eG5SYXRlOiB0aGlzLnNhbGVPcmRlci50eG5SYXRlLAogICAgICAgICAgICByYXRlOiAxLAogICAgICAgICAgICBleGNoYW5nZVJhdGU6IHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlUmF0ZSwKICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlQW1vdW50LAogICAgICAgICAgICBzdGF0dXM6IDEsCiAgICAgICAgICAgIGFwcHJvdmVkQnk6IHRoaXMuc2FsZU9yZGVyLmFwcHJvdmVkQnksCiAgICAgICAgICAgIGZvcm1UZW1wbGF0ZToge30sCiAgICAgICAgICAgIHNwZWNpZmljRGlzY291bnRJdGVtOiB0aGlzLnNhbGVPcmRlci5zcGVjaWZpY0Rpc2NvdW50SXRlbSwKICAgICAgICAgICAgb3RoZXJDaGFyZ2U6IHRoaXMubU90aGVyQ2hhcmdlLAogICAgICAgICAgICBvdGhlckNoYXJnZUFtb3VudDogdGhpcy5zYWxlT3JkZXIub3RoZXJDaGFyZ2VBbW91bnQsCiAgICAgICAgICAgIHB1YmxpY0xpbms6ICIiLAogICAgICAgICAgICB0YXhMaXN0VG90YWw6IHRoaXMudGF4TGlzdFRvdGFsLAogICAgICAgICAgICBjdXN0b21lckRpc2NvdW50SXRlbTogdGhpcy5jdXN0b21lckRpc2NvdW50SXRlbSwKICAgICAgICAgICAgY3VzdG9tZXJTYWxlVW5pdDogdGhpcy5jdXN0b21lclNhbGVVbml0LAogICAgICAgICAgICBsb2dnZWRVc2VyOiB0aGlzLmxvZ2dlZFVzZXIsCiAgICAgICAgICAgIHR4bkxpc3Q6IHRoaXMudHhuTGlzdHMsCiAgICAgICAgICAgIHNhbGVPcmRlclR5cGU6IHRoaXMuc2FsZU9yZGVyLnNhbGVPcmRlclR5cGUsCiAgICAgICAgICAgIGVtcGxveWVlOiB0aGlzLnNhbGVPcmRlci5lbXBsb3llZSwKICAgICAgICAgICAgc3VwcGxpZXI6IHRoaXMuc2FsZU9yZGVyLnN1cHBsaWVyLAogICAgICAgICAgICBpdGVtU3VidG90YWw6IHRoaXMuc2FsZU9yZGVyLml0ZW1TdWJ0b3RhbCwKICAgICAgICAgICAgZXhjaGFuZ2VJdGVtU3VidG90YWw6IHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlSXRlbVN1YnRvdGFsLAogICAgICAgICAgICBzZXJ2aWNlU3VidG90YWw6IHRoaXMuc2FsZU9yZGVyLnNlcnZpY2VTdWJ0b3RhbCwKICAgICAgICAgICAgZXhjaGFuZ2VTZXJ2aWNlU3VidG90YWw6IHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlU2VydmljZVN1YnRvdGFsLAogICAgICAgICAgICB0eG5JdG1TdWJ0b3RhbDogdGhpcy5zYWxlT3JkZXIudHhuSXRtU3VidG90YWwsCiAgICAgICAgICAgIGV4Y2hhbmdlVHhuSXRtU3VidG90YWw6IHRoaXMuc2FsZU9yZGVyLmV4Y2hhbmdlVHhuSXRtU3VidG90YWwsCiAgICAgICAgICAgIGl0ZW1EaXNjb3VudDogdGhpcy5zYWxlT3JkZXIuaXRlbURpc2NvdW50LAogICAgICAgICAgICBleGNoYW5nZUl0ZW1EaXNjb3VudDogdGhpcy5zYWxlT3JkZXIuZXhjaGFuZ2VJdGVtRGlzY291bnQsCiAgICAgICAgICAgIHNlcnZpY2VEaXNjb3VudDogdGhpcy5zYWxlT3JkZXIuc2VydmljZURpc2NvdW50LAogICAgICAgICAgICBleGNoYW5nZVNlcnZpY2VEaXNjb3VudDogdGhpcy5zYWxlT3JkZXIuZXhjaGFuZ2VTZXJ2aWNlRGlzY291bnQsCiAgICAgICAgICAgIHR4bkl0bURpc2NvdW50OiB0aGlzLnNhbGVPcmRlci50eG5JdG1EaXNjb3VudCwKICAgICAgICAgICAgZXhjaGFuZ2VUeG5JdG1EaXNjb3VudDogdGhpcy5zYWxlT3JkZXIuZXhjaGFuZ2VUeG5JdG1EaXNjb3VudCwKICAgICAgICAgICAgbGVhZDoge30sCiAgICAgICAgICAgIHJvdXRlVmlldzogInNhbGVfb3JkZXJfdmlldyIsCiAgICAgICAgICAgIGV4c3BlY3RlZERhdGU6ICIiLAogICAgICAgICAgICB1c2VkRGF0ZUF0OiAiIiwKICAgICAgICAgICAgZGVsZXRlZEF0OiAiIiwKICAgICAgICAgICAgZGVsZXRlZDogMCwKICAgICAgICAgICAgcmVmRnJvbTogdGhpcy5zYWxlT3JkZXIucmVmRnJvbSB8fCBbXSwKICAgICAgICAgICAgcmVmVG86IHRoaXMuc2FsZU9yZGVyLnJlZlRvIHx8IFtdLAogICAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApLAogICAgICAgICAgfTsKICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnZGF0YScsIGRhdGEpCiAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ2RhdGEnLCBKU09OLnN0cmluZ2lmeShkYXRhKSkKICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgdGhpcy5idG5EaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBzYWxlT3JkZXJIYW5kbGVyCiAgICAgICAgICAgIC5jcmVhdGUoZGF0YSkKICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMSkgewogICAgICAgICAgICAgICAgdGhpcy5idG5EaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTYXZlTmV3ID09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zZXREZWZhdWx0RGF0YSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZShyZXNwb25zZS5kYXRhLmRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gdGhpcy4kcmVmcy5mb3JtLnJlc2V0KCk7CiAgICAgICAgICAgICAgICB0aGlzLiRzbm90aWZ5LnN1Y2Nlc3MoIlN1Y2Nlc3NmdWxseSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmJ0bkRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgICB0aGlzLiRzbm90aWZ5LmVycm9yKCJTb21ldGhpbmcgd2VudCB3cm9uZyIpOwogICAgICAgICAgICAgIHRoaXMuZXJyb3JzLnB1c2goZSk7CiAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRQYXltZW50VGVybUxpc3QoKSB7CiAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgaWYgKHRoaXMuY3VzdG9tZXIpIHsKICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0KICAgICAgICAgICAgICAiP2lkPSIgKwogICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXIuaWQgKwogICAgICAgICAgICAgICImdHJhbnNhY3Rpb25EYXRlPSIgKwogICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uRGF0ZSArCiAgICAgICAgICAgICAgIiZ0eXBlPUN1c3RvbWVyIjsKICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIucGF5bWVudFRlcm0gPSB7fTsKICAgICAgICAgICAgcGF5bWVudFRlcm1IYW5kbGVyXy5nZXQoc3RyRmlsdGVyKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXJtcyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5wYXltZW50VGVybSA9IHRlcm1zLnRlcm07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRDcmVkaXRMaW1pdCgpIHsKICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICBpZiAodGhpcy5jdXN0b21lcikgewogICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPQogICAgICAgICAgICAgICI/aWQ9IiArCiAgICAgICAgICAgICAgdGhpcy5jdXN0b21lci5pZCArCiAgICAgICAgICAgICAgIiZ0cmFuc2FjdGlvbkRhdGU9IiArCiAgICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXIudHJhbnNhY3Rpb25EYXRlICsKICAgICAgICAgICAgICAiJnR5cGU9Q3VzdG9tZXIiOwogICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5jcmVkaXRMaW1pdCA9IDA7CiAgICAgICAgICAgIGNyZWRpdExpbWl0SGFuZGxlci5nZXQoc3RyRmlsdGVyKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAvLyB0aGlzLmNyZWRpdExpbWl0SXRlbSA9IHJlcy5kYXRhLmRhdGEKICAgICAgICAgICAgICAgIGNvbnN0IGNyZWRpdCA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNhbGVPcmRlci5jcmVkaXRMaW1pdCA9IGtlbmRvLnBhcnNlRmxvYXQoCiAgICAgICAgICAgICAgICAgIGNyZWRpdC5hbW91bnQgfHwgMAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0sIDEwKTsKICAgICAgfSk7CiAgICB9LAogICAgYXN5bmMgY2xlYXJVT01JdGVtKCkgewogICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKTsKICAgICAgZHMuZGF0YSgpLm1hcCgobikgPT4gewogICAgICAgIG4uc2V0KCJ1b20iLCB7fSk7CiAgICAgIH0pOwogICAgICB0aGlzLmlzUHJpY2VMZXZlbENoYW5nZWQgPSBmYWxzZTsKICAgIH0sCiAgICBvblByaWNlTGV2ZWxDaGFuZ2UoKSB7CiAgICAgIHRoaXMuaXNQcmljZUxldmVsQ2hhbmdlZCA9IHRydWU7CiAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9uUmF0ZSgpOwogICAgICB0aGlzLmNsZWFyVU9NSXRlbSgpOwogICAgICB0aGlzLmxvYWRRdW90ZSgpOwogICAgfSwKICAgIGFzeW5jIGxvYWRTYWxlT3JkZXIoaWQpIHsKICAgICAgd2luZG93LmNvbnNvbGUubG9nKGlkLCAibG9hZCBpZCIpOwogICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgdHJhbnNhY3Rpb25IYW5kbGVyLnZpZXcoaWQpLnRoZW4oKHJlcykgPT4gewogICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmlzRWRpdCA9IHRydWU7CiAgICAgICAgdGhpcy5pdGVtTGluZXMgPSBbXTsKICAgICAgICB0aGlzLnNhbGVPcmRlciA9IHJlcy5kYXRhLmRhdGFbMF07CiAgICAgICAgdGhpcy5iaW5kRGF0YSgpOwogICAgICB9KTsKICAgIH0sCiAgICBhc3luYyBsb2FkRW1wbG95ZWVDZW50ZXIoKSB7CiAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgdGhpcy5lbXBsb3llZXMgPSBbXTsKICAgICAgICAgIGVtcGxveWVlSGFuZGxlcgogICAgICAgICAgICAuY2VudGVyKHVuZGVmaW5lZCkKICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLmVtcGxveWVlID0ge307CiAgICAgICAgICAgICAgdGhpcy5lbXBsb3llZXMgPSBbXTsKICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVtcGxveWVlcyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5lbXBsb3llZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgLy8gICAgIHRoaXMudHJhbnNhY3Rpb24uZW1wbG95ZWUgPSB0aGlzLmVtcGxveWVlc1swXTsKICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNhdGNoKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9LCAxMCk7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGxvYWRTaW5nbGVEYXRhKCkgewogICAgICBpZiAodGhpcy4kcm91dGUubmFtZSA9PT0gIlNhbGUgT3JkZXIiKSB7CiAgICAgICAgaWYgKHRoaXMuaW5pdHNhbGVPcmRlcikgewogICAgICAgICAgLy8gRWRpdCBNb2RlCiAgICAgICAgICB0aGlzLml0ZW1MaW5lcyA9IFtdOwogICAgICAgICAgdGhpcy5zYWxlT3JkZXIgPSB0aGlzLmluaXRzYWxlT3JkZXI7CiAgICAgICAgICB0aGlzLmJpbmREYXRhKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIG5ldwogICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5sb2FkU2FsZU9yZGVyKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNldERlZmF1bHREYXRhKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHByZWZpeEhhbmRsZXIuZ2V0KCJzYWxlIG9yZGVyIikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvblR5cGUgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICBpZiAodGhpcy50cmFuc2FjdGlvblR5cGUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCAhPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT0gIiIKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVyLnRyYW5zYWN0aW9uVHlwZSA9IHRoaXMudHJhbnNhY3Rpb25UeXBlWzBdOwogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAhdGhpcy5pbml0U2FsZU9yZGVyICYmCiAgICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGF3YWl0IHRoaXMubG9hZFBheW1lbnRUZXJtKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkU2FsZUZvcm1Db250ZW50KCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkT3RoZXJDaGFyZ2UoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRQcmljZUxldmVsKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkRGlzY291bnRJdGVtKDApOwogICAgICAgIGF3YWl0IHRoaXMubG9hZFNhbGVDaGFubmVsKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ2F0YWxvZ3MoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRMZWFkKCk7CiAgICAgICAgdGhpcy5sb2FkVGF4KCk7CiAgICAgICAgdGhpcy5sb2FkU2FsZVVuaXRJdGVtcygpOwogICAgICAgIHRoaXMubG9hZFNlZ21lbnQoKTsKICAgICAgICB0aGlzLmxvYWRMb2NhdGlvbigpOwogICAgICAgIHRoaXMubG9hZEVtcGxveWVlQ2VudGVyKCk7CiAgICAgIH0KICAgIH0sCiAgfSwKICBhY3RpdmF0ZWQoKSB7CiAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkKSB7CiAgICAgIHRoaXMubG9hZFZpZXdzYWxlT3JkZXIoKTsKICAgIH0KICB9LAogIHdhdGNoOiB7CiAgICBpbml0c2FsZU9yZGVyKCkgewogICAgICB0aGlzLmluaXRpYWxEYXRhKCk7CiAgICB9LAogICAgJHJvdXRlOiAibG9hZFNpbmdsZURhdGEiLAogIH0sCiAgY3JlYXRlZCgpIHsKICAgIHRoaXMubG9hZFRheCgpOwogICAgdGhpcy5sb2FkU2FsZVVuaXRJdGVtcygpOwogICAgLy8gdGhpcy5sb2FkUHJlZml4KCkKICAgIHRoaXMubG9hZFNlZ21lbnQoKTsKICAgIHRoaXMubG9hZExvY2F0aW9uKCk7CiAgICAvLyBsb2NhbFN0b3JhZ2Uuc2FsZU9yZGVyID0gIntuYW1lOiAnYWJjc3Nzcyd9IgogIH0sCiAgY29tcHV0ZWQ6IHsKICAgIGFwcFR5cGUoKSB7CiAgICAgIHJldHVybiBkYXRhU3RvcmUucHJvZHVjdFR5cGU7CiAgICB9LAogICAgZGF0ZUZvcm1hdHRlZCgpIHsKICAgICAgcmV0dXJuIGtlbmRvLnRvU3RyaW5nKG5ldyBEYXRlKCksIGluc3RpdHV0ZS5kYXRlRm9ybWF0KTsKICAgIH0sCiAgICBkYXRlVGltZUZvcm1hdHRlZCgpIHsKICAgICAgd2luZG93LmNvbnNvbGUubG9nKGluc3RpdHV0ZS5kYXRlRm9ybWF0ICsgIiBISDptbSIsICJpbnN0IGRhdGUiKTsKICAgICAgcmV0dXJuIGtlbmRvLnRvU3RyaW5nKG5ldyBEYXRlKCksIGluc3RpdHV0ZS5kYXRlRm9ybWF0ICsgIiBISDptbSIpOwogICAgfSwKICAgIHZhbGlkQ3VzdG9tZXIoKSB7CiAgICAgIHJldHVybiB0aGlzLmN1c3RvbWVyLmlkICE9PSB1bmRlZmluZWQgJiYgdGhpcy5jdXN0b21lci5pZCAhPT0gbnVsbDsKICAgIH0sCiAgICBoaWRkZW5CdXR0b24oKSB7CiAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgICBkaXNhYmxlZE1lKCkgewogICAgICByZXR1cm4gISF0aGlzLiRyb3V0ZS5wYXJhbXMuaWQ7CiAgICB9LAogIH0sCiAgbW91bnRlZDogYXN5bmMgZnVuY3Rpb24gKCkgewogICAgdGhpcy5sb2FkU2luZ2xlRGF0YSgpOwogICAgYXdhaXQgdGhpcy5yZXF1ZXN0RGF0YSgwLCB0aGlzLmZpbHRlciwgdGhpcy5jdXNCYXNlVXJsKTsKICAgIGF3YWl0IHRoaXMuc3VwcGxpZXJSZXF1ZXN0RGF0YSgwLCB0aGlzLmZpbHRlciwgdGhpcy5zdXBCYXNlVXJsKTsKICAgIGF3YWl0IHRoaXMuZW1wbG95ZWVSZXF1ZXN0RGF0YSgwLCB0aGlzLmZpbHRlciwgdGhpcy5lbXBCYXNlVXJsKTsKICB9LAp9Owo="},{"version":3,"sources":["Order.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgmBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Order.vue","sourceRoot":"src/views/micro_edition/revenues","sourcesContent":["<template>\n  <v-app>\n    <v-container>\n      <v-row>\n        <v-col sm=\"12\" cols=\"12\">\n          <v-card\n            outlined\n            dense\n            class=\"pa-4 no_border rounded-sm\"\n            color=\"white\"\n          >\n            <v-row>\n              <v-col\n                class=\"py-0 pr-2\"\n                sm=\"12\"\n                cols=\"12\"\n                style=\"transition: 0.3s ease-in\"\n                :class=\"{ hide_big_bar_class: isHideBar }\"\n              >\n                <v-form ref=\"form\" v-model=\"valid\" lazy-validation>\n                  <v-card\n                    outlined\n                    dense\n                    class=\"no_border d-flex justify-space-between\"\n                  >\n                    <h2 class=\"mb-0\">{{ saleFormContent.saleOrder }}</h2>\n                    <div class=\"d-flex justify-end\">\n                      <h3\n                        style=\"color: #b3b5bc; font-size: 20px\"\n                        class=\"text-uppercase all_center\"\n                      >\n                        <span class=\"pointer\" @click=\"Help('sale order')\">{{\n                          $t(\"help\")\n                        }}</span>\n                        <v-icon\n                          @click=\"cancel()\"\n                          style=\"cursor: pointer; color: #333; font-size: 40px\"\n                          class=\"float-right mt-n1\"\n                          >close\n                        </v-icon>\n                      </h3>\n                    </div>\n                  </v-card>\n                  <v-card\n                    outlined\n                    dense\n                    class=\"px-3 mb-3 rounded-4 no_border\"\n                    color=\"grayBg\"\n                  >\n                    <v-row>\n                      <v-col sm=\"4\" cols=\"12\" class=\"pb-0\">\n         \n                        <label class=\"label mb-0\">{{\n                          $t(\"customer\")\n                        }}</label>\n                        <div class=\"kendo_dropdown_custom pb-2 mt-1\">\n                          <dropdownlist\n                            class=\"v-input__slot\"\n                            :data-items=\"customerList\"\n                            @change=\"onChange\"\n                            :rules=\"[(v) => !!v || 'Customer is required']\"\n                            :value=\"customer\"\n                            :data-item-key=\"dataItemKey\"\n                            :text-field=\"textField\"\n                            :default-item=\"defaultItem\"\n                            :filterable=\"true\"\n                            @filterchange=\"onFilterChange\"\n                            :required=\"true\"\n                            :valid=\"validCustomer\"\n                            :disabled=\"isEdit\"\n                          >\n                          </dropdownlist>\n                        </div>\n                        <label class=\"label\" style=\"\">{{ $t(\"date\") }}</label>\n                        <app-datepicker\n                          :initialDate=\"saleOrder.transactionDate\"\n                          @onChanged=\"onSaleOrderDateChanged\"\n                          @emitDate=\"saleOrder.transactionDate = $event\"\n                        />\n                      </v-col>\n                      <v-col sm=\"4\" cols=\"12\">\n                        <label class=\"label\">{{ $t(\"number\") }}</label>\n                        <div class=\"mt-1  d-flex mr-0\">\n                          <div class=\"code_text flex-1 text-bold\">\n                            {{ saleOrder.transactionType.abbr }}\n                          </div>\n                          <v-text-field\n                            class=\"flex-2 custom-border\"\n                            disabled\n                            v-model=\"saleOrder.number\"\n                            outlined\n                            :rules=\"[(v) => !!v || 'Number is required']\"\n                            required\n                          />\n                          <v-icon\n                            color=\"black\"\n                            size=\"30\"\n                            style=\"height: 40px\"\n                            class=\"border_qrcode ml-1\"\n                            :disabled=\"disabledMe\"\n                            @click=\"generateNumber\"\n                            >mdi-qrcode\n                          </v-icon>\n                        </div>\n                        <label class=\"label mb-0\">{{\n                          $t(\"price_level\")\n                        }}</label>\n                        <v-select\n                          class=\"mt-1\"\n                          v-model=\"saleOrder.priceLevel\"\n                          :items=\"priceLevel\"\n                          :rules=\"[\n                            (v) => !!v['id'] || 'Price level is required',\n                          ]\"\n                          @change=\"onPriceLevelChange\"\n                          item-value=\"id\"\n                          item-text=\"name\"\n                          return-object\n                          placeholder=\"Price Level\"\n                          outlined\n                        />\n                      </v-col>\n                      <v-col sm=\"4\" cols=\"12\">\n                        <div>\n                          <label class=\" mb-0\">{{ $t(\"currency\") }}</label>\n                          <p class=\"text-bold pt-4 pb-2\">{{ currencyCode }}</p>\n                        </div>\n                        <label class=\"label mb-0\">{{\n                          $t(\"sale_channel\")\n                        }}</label>\n                        <v-select class=\"mt-1\" outlined />\n                      </v-col>\n                    </v-row>\n                  </v-card>\n                  <v-row class=\"pt-1 px-3\" style=\"background-color: #fff\">\n                    <v-col sm=\"12\" cols=\"12\" class=\"pt-0 pb-1 px-0\">\n                      <kendo-datasource\n                        ref=\"itemLineDS\"\n                        :data=\"itemLines\"\n                        :change=\"dataSourceChanged\"\n                      />\n                      <kendo-grid\n                        id=\"gridItemLineSaleOrder\"\n                        class=\"grid-function\"\n                        :data-source-ref=\"'itemLineDS'\"\n                        :sortable=\"false\"\n                        :column-menu=\"true\"\n                        :editable=\"true\"\n                        :scrollable-virtual=\"true\"\n                      >\n                        <kendo-grid-column\n                          :command=\"{\n                            iconClass: 'k-icon k-i-trash',\n                            text: ' ',\n                            click: removeRow,\n                            className: 'btn-plus',\n                          }\"\n                          :title=\"''\"\n                          :width=\"63\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                        />\n                        <kendo-grid-column\n                          :title=\"$t('no.')\"\n                          :width=\"53\"\n                          :column-menu=\"false\"\n                          :template=\"rowNumberTmpl\"\n                          :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5;',\n                            class: 'text-products',\n                          }\"\n                          :attributes=\"{ style: 'text-align: products' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'item'\"\n                          :title=\"$t('item')\"\n                          :template=\"itemTemplate\"\n                          :editor=\"ItemDropDownEditor\"\n                          :width=\"200\"\n                          :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'description'\"\n                          :title=\"$t('description')\"\n                          :template=\"'<span>#=description#</span>'\"\n                          :width=\"200\"\n                          :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'uom'\"\n                          :title=\"$t('uom')\"\n                          :width=\"100\"\n                          :template=\"UOMTemplate\"\n                          :editor=\"UOMDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'qty'\"\n                          :title=\"$t('qty')\"\n                          :format=\"'{0:n}'\"\n                          :template=\"'<span>#=qty#</span>'\"\n                          :width=\"100\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left;' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'price'\"\n                          :title=\"$t('price')\"\n                          :width=\"150\"\n                          :template=\"priceFormat\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'amount'\"\n                          :title=\"$t('amount')\"\n                          :width=\"150\"\n                          :editable=\"\n                            () => {\n                              return false;\n                            }\n                          \"\n                          :template=\"amountFormat\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'vatTax'\"\n                          :title=\"$t('vat')\"\n                          :width=\"200\"\n                          :template=\"vatTemplate\"\n                          :hidden=\"appType != 'npo' ? false : true\"\n                          :editor=\"VatTaxDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'serviceDate'\"\n                          :title=\"$t('date_from')\"\n                          :width=\"160\"\n                          :hidden=\"!saleFormContent.serviceDate\"\n                          :template=\"'<span>#= kendo.toString(new Date(serviceDate), dateFormat)#</span>'\"\n                          :editor=\"ServiceDateEditor\"\n                          :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'serviceDateTo'\"\n                          :title=\"$t('date_to')\"\n                          :width=\"160\"\n                          :hidden=\"!saleFormContent.serviceDateTo\"\n                          :template=\"'<span>#= kendo.toString(new Date(serviceDateTo), dateFormat)#</span>'\"\n                          :editor=\"ServiceDateToEditor\"\n                          :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'modifier'\"\n                          :title=\"$t('modifier')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.modifier\"\n                          :template=\"'<span>#=modifier.name?modifier.name:``#</span>'\"\n                          :editor=\"ModifierDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'discountItem'\"\n                          :title=\"$t('discount_item')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.discountItem\"\n                          :template=\"discountItemTemplate\"\n                          :editor=\"DiscountItemDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'specificTax'\"\n                          :title=\"$t('specificTax')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.specificTax\"\n                          :template=\"'<span>#=specificTax.defaultTax?specificTax.defaultTax:``#</span>'\"\n                          :editor=\"SpecificTaxDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'otherTax'\"\n                          :title=\"$t('otherTax')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.otherTax\"\n                          :template=\"'<span>#=otherTax.defaultTax?otherTax.defaultTax:``#</span>'\"\n                          :editor=\"OtherTaxDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'publicLightingTax'\"\n                          :title=\"$t('pl_tax')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.publicLightingTax\"\n                          :template=\"'<span>#=publicLightingTax.defaultTax?publicLightingTax.defaultTax:``#</span>'\"\n                          :editor=\"PublicLightingTaxDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'saleUnit'\"\n                          :title=\"$t('sale_unit')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.saleUnit\"\n                          :template=\"saleUnitTemplate\"\n                          :editor=\"SaleUnitDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                        <kendo-grid-column\n                          :field=\"'employee'\"\n                          :title=\"$t('employee')\"\n                          :width=\"200\"\n                          :hidden=\"!saleFormContent.employee\"\n                          :template=\"empImpl\"\n                          :editor=\"EmployeeDropDownEditor\"\n                          :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                          :attributes=\"{ style: 'text-align: left' }\"\n                        />\n                      </kendo-grid>\n                    </v-col>\n                    <v-col sm=\"12\" cols=\"12\" class=\"pt-0 pl-0\">\n                      <v-btn class=\"float-left btn_plus\" @click=\"addRow\">\n                        <v-icon size=\"\" class=\"ma-1\">mdi-plus</v-icon>\n                      </v-btn>\n                    </v-col>\n                    <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                      <v-row>\n                        <v-row>\n                          <v-col class=\"pt-0\" sm=\"5\" cols=\"6\">\n                          </v-col>\n                          <v-col class=\"pt-0\" sm=\"7\" cols=\"12\">\n                            <v-simple-table>\n                              <template v-slot:default>\n                                <tbody>\n                                  <tr v-if=\"appType != 'npo'\">\n                                    <td class=\"text-left pr-0\">\n                                      {{ $t(\"subtotal\") }}\n                                    </td>\n                                    <td class=\"text-center\">:</td>\n                                    <td class=\"text-right\">\n                                      {{ numberFormat(saleOrder.subTotal) }}\n                                    </td>\n                                  </tr>\n                                  <tr v-if=\"appType != 'npo'\">\n                                    <td class=\"text-left pr-0\">\n                                      {{ $t(\"general_discount\") }}\n                                    </td>\n                                    <td class=\"text-center\">:</td>\n                                    <td class=\"text-right\">\n                                      ({{\n                                        numberFormat(saleOrder.discountTotal)\n                                      }})\n                                    </td>\n                                  </tr>\n                                  <tr style=\"background: #f8f8f9\">\n                                    <td class=\"text-left text-uppercase pr-0\">\n                                      {{ $t(\"total\") }}\n                                    </td>\n                                    <td class=\"text-center\">:</td>\n                                    <td\n                                      class=\"text-right primary--text text-bold\"\n                                      id=\"total\"\n                                    >\n                                      {{ numberFormat(saleOrder.total) }}\n                                    </td>\n                                  </tr>\n                                </tbody>\n                              </template>\n                            </v-simple-table>\n                          </v-col>\n                        </v-row>\n                      </v-row>\n                    </v-col>\n                  </v-row>\n                  <v-divider />\n                  <v-card outlined dense class=\"no_border function_footer\">\n                    <v-alert type=\"warning\" v-model=\"alert\" dismissible>\n                      <span v-html=\"errorMessage\" />\n                    </v-alert>\n                    <v-menu>\n                      <template v-slot:activator=\"{ on }\">\n                        <v-btn\n                          class=\"mr-2 float-left select_template\"\n                          v-on=\"on\"\n                        >\n                          {{ $t(\"select_template\") }}\n                          <v-icon size=\"\" class=\"ma-1\">expand_more</v-icon>\n                        </v-btn>\n                      </template>\n                      <v-list>\n                        <v-list-item\n                          v-for=\"(item, index) in formAR\"\n                          :key=\"index\"\n                        >\n                          <v-list-item-title>{{ item.name }}</v-list-item-title>\n                        </v-list-item>\n                      </v-list>\n                    </v-menu>\n                    <v-btn\n                      class=\"text-capitalize black--text float-left\"\n                      color=\"primary\"\n                      outlined\n                      @click=\"cancel\"\n                      >{{ $t(\"cancel\") }}\n                    </v-btn>\n                    <!--                    <v-menu>-->\n                    <!--                      <template v-slot:activator=\"{ on }\">-->\n                    <!--                        <v-btn class=\"ml-2 float-right text-capitalize  white&#45;&#45;text\"-->\n                    <!--                               color=\"primary\" v-on=\"on\">-->\n                    <!--                          {{ $t('save_option') }}-->\n                    <!--                          <v-icon size=\"\" class=\"ma-1\">expand_more</v-icon>-->\n                    <!--                        </v-btn>-->\n                    <!--                      </template>-->\n                    <!--                      <v-list rounded>-->\n                    <!--                        <v-list-item-group>-->\n                    <!--                          <v-list-item>-->\n                    <!--                            <v-list-item-content>-->\n                    <!--                              <v-list-item-title v-if=\"!isEdit\" @click=\"saveNew\">-->\n                    <!--                                {{ $t('save_new') }}-->\n                    <!--                              </v-list-item-title>-->\n                    <!--                            </v-list-item-content>-->\n                    <!--                          </v-list-item>-->\n                    <!--                          <v-list-item>-->\n                    <!--                            <v-list-item-content>-->\n                    <!--                              <v-list-item-title @click=\"saveClose\">{{-->\n                    <!--                                  $t('save_close')-->\n                    <!--                                }}-->\n                    <!--                              </v-list-item-title>-->\n                    <!--                            </v-list-item-content>-->\n                    <!--                          </v-list-item>-->\n\n                    <!--                        </v-list-item-group>-->\n                    <!--                      </v-list>-->\n                    <!--                    </v-menu>-->\n                    <v-btn\n                      @click=\"saveClose\"\n                      class=\"float-right text-capitalize white--text\"\n                      :disabled=\"btnDisabled\"\n                      color=\"primary\"\n                    >\n                      {{ $t(\"save_close\") }}\n                    </v-btn>\n                    <v-btn\n                      color=\"secondary\"\n                      style=\"margin-right: 10px !important\"\n                      :disabled=\"btnDisabled\"\n                      class=\"white--text float-right text-capitalize\"\n                      @click=\"saveNew\"\n                      :hidden=\"hiddenButton\"\n                      >{{ $t(\"save_new\") }}\n                    </v-btn>\n                  </v-card>\n                </v-form>\n              </v-col>\n            </v-row>\n          </v-card>\n        </v-col>\n      </v-row>\n      <LoadingMe\n        :isLoading=\"showLoading\"\n        :fullPage=\"false\"\n        :myLoading=\"true\"\n        type=\"loading\"\n        :alertMessage=\"loadingAlert\"\n        :color=\"loadingColorAlert\"\n        :alertText=\"loadingTextAlert\"\n      />\n      <v-dialog v-model=\"dialogCatalog\" max-width=\"850px\">\n        <v-card>\n          <div class=\"modal_header\">\n            <v-card-title>{{ $t(\"catalog\") }}</v-card-title>\n            <v-icon class=\"btn_close\" @click=\"dialogCatalog = false\"\n              >close\n            </v-icon>\n          </div>\n          <v-card-text class=\"modal_text_conent\">\n            <v-row>\n              <v-col sm=\"12\" cols=\"12\" class=\"pb-0\">\n                <v-simple-table>\n                  <kendo-datasource\n                    ref=\"catalogDatasource\"\n                    :data=\"catalogs\"\n                    :schema=\"gridSchema\"\n                  />\n                  <kendo-grid\n                    id=\"gridCatalog\"\n                    class=\"grid-function\"\n                    :data-source-ref=\"'catalogDatasource'\"\n                    :style=\"{ width: '100%' }\"\n                    :noRecords=\"true\"\n                    :pageable-numeric=\"false\"\n                    :pageable-previous-next=\"false\"\n                    :pageable-messages-display=\"'Showing {2} data items'\"\n                    :scrollable-virtual=\"true\"\n                  >\n                    <kendo-grid-column\n                      :field=\"'images'\"\n                      :title=\"$t('image')\"\n                      :width=\"50\"\n                      :template=\"loadImage\"\n                      :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"\n                    />\n                    <kendo-grid-column\n                      :field=\"'number'\"\n                      :title=\"$t('number')\"\n                      :width=\"70\"\n                      :template=\"'<span>#=number#</span>'\"\n                      :groupHeaderColumnTemplate=\"'#=value#'\"\n                      :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"\n                    />\n                    <kendo-grid-column\n                      :field=\"'name'\"\n                      :title=\"$t('name')\"\n                      :attributes=\"{ class: 'tb_name_td' }\"\n                      :width=\"100\"\n                      :template=\"'<span>#=name#</span>'\"\n                      :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"\n                    />\n                    <kendo-grid-column\n                      :field=\"'description'\"\n                      :title=\"$t('description')\"\n                      :width=\"100\"\n                      :template=\"'<span>#=description#</span>'\"\n                      :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"\n                    />\n                    <kendo-grid-column\n                      :field=\"'noOfProduct'\"\n                      :title=\"$t('products')\"\n                      :template=\"'<span>#=noOfProduct#</span>'\"\n                      :width=\"50\"\n                      :headerAttributes=\"{\n                        style: 'text-align: left; background-color: #EDF1F5',\n                      }\"\n                    />\n                    <kendo-grid-column\n                      :field=\"''\"\n                      :title=\"$t('action')\"\n                      :width=\"60\"\n                      :command=\"[{ text: $t('add'), click: addCatalog }]\"\n                      :headerAttributes=\"{\n                        style: 'text-align: left; background-color: #EDF1F5',\n                      }\"\n                    />\n                  </kendo-grid>\n                </v-simple-table>\n              </v-col>\n            </v-row>\n          </v-card-text>\n        </v-card>\n      </v-dialog>\n    </v-container>\n  </v-app>\n</template>\n\n<script>\nimport { i18n } from \"@/i18n\";\nimport DatePickerComponent from \"@/components/custom_templates/DatePickerComponent\";\nimport kendo from \"@progress/kendo-ui\";\nimport { DropDownList } from \"@progress/kendo-vue-dropdowns\";\nimport SaleFormContentModel from \"@/scripts/model/SaleFormContent\";\nimport ItemLineModel from \"@/scripts/invoice/model/ItemLine\";\nimport { uuid } from \"vue-uuid\";\nimport SaleOrderModel from \"@/scripts/model/Transaction\";\n\n/* Store */\nimport store from \"@/store\";\n\nconst institute = store.state.institute.institute;\n\nimport { ShowResource } from \"@/observable/store\";\nimport paymentTermHandler_ from \"@/scripts/paymentterm/handler/paymentTermHandler\";\nimport creditLimitHandler from \"@/scripts/creditLimit/handler/creditLimitHandler\";\nimport Helper from \"@/helper\";\nimport transactionHandler from \"@/scripts/transactionHandler\";\nimport { dataStore } from \"@/observable/store\";\n\n////handler\nconst saleOrderHandler = require(\"@/scripts/transactionHandler\");\nconst billingHandler = require(\"@/scripts/invoice/handler/billingHandler\");\nconst customerHandler = require(\"@/scripts/customerHandler\");\nconst projectHandler = require(\"@/scripts/projectHandler\");\nconst prefixHandler = require(\"@/scripts/prefixHandler\");\nconst paymentTermHandler = require(\"@/scripts/paymentTermHandler\");\nconst priceLevelHandler = require(\"@/scripts/priceLevelHandler\");\nconst saleFormContentHandler = require(\"@/scripts/saleFormContentHandler\");\nconst employeeHandler = require(\"@/scripts/employeeHandler\");\nconst itemModifierHandler = require(\"@/scripts/itemModifierHandler\");\nconst discountItemHandler = require(\"@/scripts/discountItemHandler\");\nconst uomPriceHandler = require(\"@/scripts/uomPriceHandler\");\nconst productVariantHandler = require(\"@/scripts/productVariantHandler\");\nconst otherChargeHandler = require(\"@/scripts/otherChargeHandler\");\nconst locationHandler = require(\"@/scripts/locationHandler\");\nconst settingsHandler = require(\"@/scripts/settingsHandler\");\nconst saleChannelHandler = require(\"@/scripts/saleChannelHandler\");\nconst saleUnitItemHandler = require(\"@/scripts/saleUnitItemHandler\");\nconst settingHandler = require(\"@/scripts/settingHandler\");\nconst catalogHandler = require(\"@/scripts/catalogHandler\");\nconst productHandler = require(\"@/scripts/productHandler\");\nconst currencyHandler = require(\"@/scripts/currency/handler/currencyHandler\");\nconst supplierHandler = require(\"@/scripts/supplierHandler\");\n\nconst saleFormContentModel = new SaleFormContentModel({});\nconst itemLineModel = new ItemLineModel({});\n//other\nconst $ = kendo.jQuery;\nconst textField = \"numberName\";\nconst keyField = \"id\";\nconst defaultItem = { [textField]: \"Select Customer...\", [keyField]: null };\nconst defaultSupItem = { [textField]: \"Select Supplier...\", [keyField]: null };\nconst defaultEmpItem = { [textField]: \"Select Employee...\", [keyField]: null };\nconst emptyItem = { [textField]: \"loading ...\" };\nconst invoicePrefix = \"lin-\";\nconst DISCOUNT_TYPE = \"?type=Sale\";\nconst cookieJS = require(\"@/cookie.js\");\nconst cookie = cookieJS.getCookie();\nexport default {\n  name: \"SaleOrder\",\n  props: {\n    id: {\n      type: String,\n    },\n    initSaleOrder: {\n      type: SaleOrderModel,\n    },\n  },\n  components: {\n    LoadingMe: () => import(`@/components/Loading`),\n    \"app-datepicker\": DatePickerComponent,\n    dropdownlist: DropDownList,\n    // \"app-monthof-picker\": () => import(\"@/components/kendo_templates/MonthOfPicker\"),\n  },\n  data: () => ({\n    saleOrder: new SaleOrderModel(),\n    isEdit: false,\n    numSelect: [1],\n    dialogTax: false,\n    theDate: \"\",\n    //Catalog\n    dialogCatalog: false,\n    gridSchema: {\n      model: {\n        id: \"id\",\n      },\n    },\n    imgURL: \"https://s3-ap-southeast-1.amazonaws.com/images.banhji/\",\n    // LoadingMe\n    showLoading: false,\n    loadingAlert: false,\n    loadingColorAlert: \"\",\n    loadingTextAlert: \"\",\n    bill_date: \"\",\n    alert: false,\n    files: [],\n    errors: [],\n    // Form validation\n    valid: true,\n    templates: [\n      { title: \"Draft\" },\n      { title: \"Open\" },\n      { title: \"Partially Closed\" },\n      { title: \"Closed\" },\n    ],\n    saleOrderType: 1,\n    saleOrderTypes: [\n      { name: \"Standard Order\", id: 1 },\n      { name: \"Open Order\", id: 2 },\n      { name: \"Contract\", id: 3 },\n      { name: \"Consignment Order\", id: 4 },\n      // {name: 'Order required Purchase', id: 5},\n    ],\n    isRequredPurchase: false,\n    col_expand: 9,\n    col_hide: 3,\n    isHideBar: false,\n    filter: \"\",\n    textField: \"numberName\",\n    dataItemKey: \"id\",\n    defaultItem: defaultItem,\n    defaultSupItem: defaultSupItem,\n    defaultEmpItem: defaultEmpItem,\n    mOtherCharge: [],\n    //item\n    itemLines: [],\n    itemLine: itemLineModel,\n    dateFormat: itemLineModel.dateFormat,\n    //customer\n    cusBaseUrl: customerHandler.search(),\n    customer: {},\n    customerList: [],\n    supplierList: [],\n    supplier: {},\n    supBaseUrl: supplierHandler.search(),\n    billingAddress: [],\n    deliveryAddress: [],\n    priceLevel: [],\n    //date\n    paymentTerms: [],\n    transactions: [],\n    employeeList: [],\n    employee: {},\n    empBaseUrl: employeeHandler.searchURL(),\n    saleChannelList: [],\n    locations: [],\n    customerProjects: [],\n    segments: [],\n    transactionType: {},\n    taxListTotal: {},\n    customerDiscountItem: [],\n    customerSaleUnit: [],\n    saleFormContent: saleFormContentModel,\n    transactionDate: new Date().toISOString().substr(0, 10),\n    monthOf: false,\n    deliveryDateTime: new Date(),\n    validityDate: new Date().toISOString().substr(0, 10),\n    specificDiscountItem: [],\n    otherChargeList: [],\n    saleUnitItemList: [],\n    otherTax: [],\n    specificTax: [],\n    publicLightingTax: [],\n    vatTax: [],\n    tax: [],\n    loggedUser: {\n      id: cookie.creator,\n      name: cookie.email,\n    },\n    leads: [],\n    catalogs: [],\n    txnList: [],\n    quotes: [],\n    txnLists: [],\n    isSaveNew: false,\n    isSaveClose: false,\n    isSavePrint: false,\n    isSaveDraft: false,\n    exchangeRate: {},\n    baseCurrencyCode: \"\",\n    currencyCode: \"\",\n    transactionRate: 1,\n    saveOption: \"\",\n    formAR: [\n      { id: 1, name: \"Default Form\" },\n      { id: 2, name: \"Form 80mm\" },\n    ],\n    isPriceLevelChanged: false,\n    refFrom: [], // can SO can be from Sale Quotes\n    btnDisabled: false,\n  }),\n  methods: {\n    formatDateTime(value) {\n      return kendo.toString(new Date(value), this.dateFormat + ` hh:mm tt`);\n    },\n    amountFormat(value) {\n      return kendo.toString(value.amount, `n${this.saleFormContent.decimal}`);\n    },\n    priceFormat(value) {\n      return kendo.toString(value.price, `n${this.saleFormContent.decimal}`);\n    },\n    Help(key_search) {\n      ShowResource(key_search);\n    },\n    initialData() {\n      if (this.initSaleOrder) {\n        // Edit Mode\n        this.saleOrder = this.initSaleOrder;\n        this.saleOrder.creditLimit = 0;\n        this.saleOrder.currentBalance = 0;\n        // window.console.log(this.initSaleOrder, 'propData')\n        this.bindData();\n      } else {\n        // Brand New Mode\n        if (this.$route.params.id === undefined) {\n          this.setDefaultData();\n        }\n      }\n    },\n    setDefaultData() {\n      // Brand New Mode\n      // window.console.log('default or clear')\n      this.isEdit = false;\n      this.saleOrder = new SaleOrderModel({});\n      //sale order type\n      if (this.$route.params.id !== undefined) {\n        this.saleOrder.saleOrderType = 1;\n        this.saleOrderType = 1;\n        if (this.appType === \"npo\" || this.appType === \"Public Sectors\") {\n          this.saleOrder.saleOrderType = 3;\n          this.saleOrderType = 3;\n        }\n      }\n      this.saleOrder.deliveryDateTime = new Date();\n      this.saleOrder.formTemplate = 1;\n      this.saleOrder.transactionDate = new Date().toISOString().substr(0, 10);\n      // Generate Number\n      this.itemLines = [];\n      // let ds = this.$refs.itemLineDS.kendoWidget();\n      // ds.data([]);\n      // Add 2 default lines\n      this.removeEmptyLine();\n      setTimeout(() => {\n        this.addRow();\n        // this.addRow()\n      }, 500);\n      // Add 2 default lines\n      this.otherChargeList = [];\n      this.mOtherCharge = [];\n      this.employee = {};\n      this.taxListTotal = {};\n      this.quotes = [];\n      this.isSaveNew = false;\n      this.isSaveClose = false;\n      this.isSavePrint = false;\n      this.isSaveDraft = false;\n      this.creditLimitUsage(0, 1);\n      this.isRequredPurchase = false;\n      this.customer = {};\n    },\n    bindData() {\n      // window.console.log(this.saleOrder, 'bindData')\n      // Edit Mode\n      if (this.saleOrder) {\n        if (this.saleOrder.hasOwnProperty(\"customer\")) {\n          this.isEdit = true;\n          this.customer = this.saleOrder.customer;\n          // let e = {value: this.saleOrder.customer}\n          // this.onChange(e)\n          this.billingAddress = this.saleOrder.customer.billingAddress;\n          this.deliveryAddress = this.saleOrder.customer.deliveryAddress;\n          // this.customerProjects = this.saleOrder.customer.\n          this.taxListTotal = this.saleOrder.taxListTotal;\n          this.itemLines = this.saleOrder.itemLines;\n          this.mOtherCharge = this.saleOrder.otherCharge;\n          this.loadProjectByCustomer();\n          if (this.customer.hasOwnProperty(\"id\")) {\n            this.loadCustomerBalance(this.customer.id);\n          }\n        }\n      }\n    },\n    addSelect() {\n      let amount_num = this.numSelect.length;\n      let num = this.numSelect[amount_num - 1];\n      let new_num = num + 1;\n      let lenghtItem = this.specificDiscountItem.length;\n      if (new_num <= lenghtItem) {\n        this.numSelect.push(new_num);\n      }\n    },\n    removeSelect(index) {\n      this.numSelect.splice(index, 1);\n      // window.console.log(index, this.numSelect)\n      // this.selectDiscount.splice(index,1)\n      // window.console.log(\"remove\",this.selectDiscount)\n      // this.selectDiscount = this.selectDiscount.filter(item =>  item.id != val.id);\n    },\n    errorMessage() {},\n    accountDropDownEditor() {},\n    hide_smallsitebar() {\n      if (!this.isHideBar) {\n        // this.col_expand = 12\n        // this.col_hide = 0\n        this.isHideBar = true;\n      } else {\n        // this.col_expand = 9\n        // this.col_hide = 3\n        this.isHideBar = false;\n      }\n    },\n    //number\n    generateNumber() {\n      if (this.isEdit == false) {\n        let d = new Date().toISOString().substr(0, 10);\n        if (this.saleOrder.transactionDate) {\n          // window.console.log(this.transactionDate)\n          d = this.saleOrder.transactionDate;\n        }\n        let data = {\n          abbr: this.saleOrder.transactionType.abbr,\n          structure: this.saleOrder.transactionType.structure,\n          transactionDate: d,\n          type: \"Sale Order\",\n        };\n        billingHandler\n          .lastNumber(data)\n          .then((response) => {\n            if (response.data.statusCode === 200) {\n              const res = response.data.data;\n              const lastNumber = this.zeroPad(\n                parseInt(res.lastNumber),\n                this.saleOrder.transactionType.format\n              );\n              const number =\n                res.suffix +\n                this.saleOrder.transactionType.numberSeparator +\n                lastNumber;\n              this.saleOrder.number = number;\n            }\n          })\n          .catch((e) => {\n            this.errors.push(e);\n          });\n      }\n    },\n    zeroPad(num, places) {\n      return String(num).padStart(places, \"0\");\n    },\n    //customer\n    onChange(event) {\n      window.console.log(event);\n      const value = event.value;\n      if (value && value[textField] === emptyItem[textField]) {\n        return;\n      }\n      this.customer = value;\n      this.saleOrder.customer = value;\n      // this.invoice = value\n      // this.saleOrder.paymentTerm = value.hasOwnProperty(\"paymentTerm\")\n      //   ? value.paymentTerm\n      //   : {};\n      this.saleOrder.priceLevel = value.hasOwnProperty(\"priceLevel\")\n        ? value.priceLevel\n        : {};\n      const baseCurrency = value.hasOwnProperty(\"baseCurrency\")\n        ? value.baseCurrency\n        : {};\n      if (baseCurrency.hasOwnProperty(\"code\")) {\n        this.baseCurrencyCode = baseCurrency.code;\n      }\n      const priceLevel = value.hasOwnProperty(\"priceLevel\")\n        ? value.priceLevel\n        : {};\n      if (priceLevel.hasOwnProperty(\"currency\")) {\n        if (priceLevel.currency.hasOwnProperty(\"id\")) {\n          this.loadTransactionRate();\n        }\n      }\n      this.billingAddress = value.hasOwnProperty(\"billingAddress\")\n        ? value.billingAddress\n        : [];\n      this.deliveryAddress = value.hasOwnProperty(\"deliveryAddress\")\n        ? value.deliveryAddress\n        : [];\n      if (this.billingAddress.length > 0) {\n        this.saleOrder.billingAddress = this.billingAddress[0];\n      }\n      if (this.deliveryAddress.length > 0) {\n        this.saleOrder.deliveryAddress = this.deliveryAddress[0];\n      }\n      this.onSaleOrderDateChanged();\n      this.loadProjectByCustomer();\n      // const creditLimit = value.hasOwnProperty(\"creditLimit\")\n      //   ? value.creditLimit\n      //   : 0;\n      // this.saleOrder.creditLimit = kendo.parseFloat(creditLimit);\n      this.loadCreditLimit();\n      this.loadCustomerBalance(this.customer.id);\n      // load quote\n      this.loadQuote();\n      this.loadPaymentTermList();\n    },\n    onFilterChange(event) {\n      const filter = event.filter.value;\n      this.requestData(0, filter, this.cusBaseUrl);\n      this.filter = filter;\n    },\n    async requestData(skip, filter, baseUrl) {\n      let url = baseUrl + `?filter=${filter}`;\n      if (this.appType === \"npo\") {\n        url = baseUrl + `?filter=${filter}&is_donor=true`;\n      }\n      this.requestStarted = true;\n      fetch(url)\n        .then((response) => {\n          return response.json();\n        })\n        .then(this.afterFetch);\n    },\n    afterFetch(json) {\n      this.customerList = json.data;\n    },\n    //supplier\n    onSupplierChange(event) {\n      window.console.log(event);\n      const value = event.value;\n      if (value && value[textField] === emptyItem[textField]) {\n        return;\n      }\n      this.supplier = value;\n      this.saleOrder.supplier = value;\n    },\n    onSupplierFilterChange(event) {\n      const supfilter = event.filter.value;\n      this.supplierRequestData(0, supfilter, this.supBaseUrl);\n    },\n    supplierRequestData(skip, filter, baseUrl) {\n      const url = baseUrl + `?filter=${filter}`;\n      this.requestStarted = true;\n      fetch(url)\n        .then((response) => {\n          return response.json();\n        })\n        .then(this.supAfterFetch);\n    },\n    supAfterFetch(json) {\n      this.supplierList = json.data;\n    },\n    //employee\n    onEmployeeChange(event) {\n      const value = event.value;\n      if (value && value[textField] === emptyItem[textField]) {\n        return;\n      }\n      this.employee = value;\n      this.saleOrder.employee = value;\n    },\n    onEmployeeFilterChanged(event) {\n      const empfilter = event.filter.value;\n      this.employeeRequestData(0, empfilter, this.empBaseUrl);\n    },\n    employeeRequestData(skip, filter, baseUrl) {\n      const url = baseUrl + `?filter=${filter}`;\n      this.requestStarted = true;\n      fetch(url)\n        .then((response) => {\n          return response.json();\n        })\n        .then(this.empAfterFetch);\n    },\n    empAfterFetch(json) {\n      this.employeeList = json.data;\n    },\n    removeRow(e) {\n      e.preventDefault();\n      const grid = kendo.jQuery(\"#gridItemLineSaleOrder\").data(\"kendoGrid\"),\n        dataSource = grid.dataSource,\n        dataItem = grid.dataItem($(e.currentTarget).closest(\"tr\"));\n\n      if (dataSource.total() > 1) {\n        dataSource.remove(dataItem);\n      }\n      this.autoCalculate();\n    },\n    //date\n    async onSaleOrderDateChanged() {\n      if (this.saleOrder.transactionDate) {\n        this.saleOrder.monthOf = new Date(this.saleOrder.transactionDate)\n          .toISOString()\n          .substr(0, 7);\n      }\n      await this.loadCreditLimit();\n      await this.loadCustomerBalance(this.customer.id);\n      await this.onPriceLevelChange();\n      await this.loadPaymentTermList();\n      if (this.customer) {\n        const paymentTerm = this.saleOrder.paymentTerm || {};\n        const netDue = paymentTerm.netDue || 0;\n        const someDate = new Date(this.saleOrder.transactionDate);\n        someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n        this.saleOrder.validityDate = someDate.toISOString().substr(0, 10);\n        window.console.log(\"dueDate\", this.saleOrder.validityDate);\n      }\n      if (this.$route.params.id === undefined) {\n        this.generateNumber();\n      }\n    },\n    onPaymentTermChanged() {\n      // this.onSaleOrderDateChanged();\n      if (this.customer) {\n        const paymentTerm = this.saleOrder.paymentTerm || {};\n        const netDue = paymentTerm.netDue || 0;\n        const someDate = new Date(this.saleOrder.transactionDate);\n        someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n        this.saleOrder.validityDate = someDate.toISOString().substr(0, 10);\n        window.console.log(\"dueDate\", this.saleOrder.validityDate);\n      }\n    },\n    //number\n    numberFormat(value) {\n      // window.console.log(this.saleFormContent.decimal,'nimol')\n      return kendo.toString(value, `n${this.saleFormContent.decimal}`);\n      // return value\n    },\n    //\n    async loadLead() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          const strFilter = \"?type=Sale Lead\";\n          this.leads = [];\n          billingHandler.list(strFilter).then((res) => {\n            if (res) {\n              if (res.data) {\n                if (res.data.statusCode === 200) {\n                  this.showLoading = false;\n                  this.leads = res.data.data;\n                }\n              }\n            }\n            this.showLoading = false;\n          });\n        }, 10);\n      });\n    },\n    async loadPaymentTerm() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          paymentTermHandler.getAll().then((res) => {\n            this.showLoading = false;\n            this.paymentTerms = res.data.data;\n            if (this.paymentTerms.length > 0) {\n              if (\n                this.$route.params.id !== undefined ||\n                this.$route.params.id != \"\"\n              ) {\n                if (this.saleOrder) {\n                  this.saleOrder.paymentTerm = this.paymentTerms[0];\n                }\n              }\n            }\n          });\n        }, 10);\n      });\n    },\n    async loadPriceLevel() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          const strFilter = \"?nature=sale\";\n          priceLevelHandler.get(strFilter).then((res) => {\n            this.priceLevel = res;\n            if (this.priceLevel.length > 0) {\n              if (\n                this.$route.params.id !== undefined ||\n                this.$route.params.id != \"\"\n              ) {\n                if (this.saleOrder) {\n                  this.saleOrder.priceLevel = this.priceLevel[0];\n                }\n                this.loadTransactionRate();\n              }\n            }\n          });\n        }, 10);\n      });\n    },\n    removeDuplicate(array) {\n      const result = [];\n      const map = new Map();\n      for (const item of array) {\n        if (!map.has(item.id)) {\n          map.set(item.id, true); // set any value to Map\n          result.push(item);\n        }\n      }\n      return result;\n    },\n    autoCalculateDiscount(discountItem, subTotal) {\n      if (discountItem) {\n        window.console.log(\"discountItem\", discountItem, subTotal);\n        const nature = discountItem.nature || \"\";\n        const amount = discountItem.amount || 0;\n        if (nature === \"Amount\") {\n          return parseFloat(amount);\n        } else if (nature === \"Percentage\") {\n          return subTotal * (parseFloat(amount) / 100);\n        } else {\n          return 0;\n        }\n      } else {\n        return 0;\n      }\n    },\n    autoCalculateTax(tax, amount) {\n      if (tax) {\n        var formula = tax.formula;\n        var inAmt = kendo.parseFloat(amount);\n        var nAmt = kendo.parseFloat(amount);\n        var taxBase = kendo.parseFloat(tax.taxBase) / 100;\n        var rate = kendo.parseFloat(tax.rate) / 100;\n        var total = eval(formula);\n        window.console.log(inAmt, nAmt, taxBase, rate, formula, total);\n        // window.console.log(amount)\n        return total;\n      }\n      // return 0\n    },\n    autoCalculateTaxByType(tax) {\n      // return by a key\n      const groupAll = (list) =>\n        list.reduce((tax, item) => {\n          const taxAmount = tax[item.name] || 0;\n          return Object.assign({}, tax, {\n            [item.name]: taxAmount + parseFloat(item.amount),\n          });\n        }, {});\n      this.taxListTotal = groupAll(tax);\n      // window.console.log('nimol', groupAll(tax))\n      // this.\n    },\n    dataSourceChanged(e) {\n      if (e.field) {\n        let dataRow = e.items[0],\n          buom = {},\n          conversionRate = 1,\n          wac = 0,\n          qoh = 0,\n          amount = 0,\n          xAmount = 0;\n        switch (e.field) {\n          case \"item\":\n            // this.attribute_ = this.attributes.filter(m => m.type.id === dataRow.variant.id)\n            dataRow.set(\"description\", dataRow.item.description);\n            buom = dataRow.item.uom || {};\n            dataRow.set(\"buom\", buom);\n            // this.itemChange(dataRow)\n            break;\n          case \"uom\":\n            if (this.isPriceLevelChanged === false) {\n              try {\n                try {\n                  buom = dataRow.uom.buom || {};\n                  qoh = dataRow.uom.qoh || 0;\n                  conversionRate = dataRow.uom.conversionRate || 1;\n                  wac = dataRow.uom.wac || 0;\n                  dataRow.set(\"buom\", buom);\n                  dataRow.set(\"wac\", wac);\n                  dataRow.set(\"qoh\", qoh);\n                  dataRow.set(\"conversionRate\", parseFloat(conversionRate));\n                  if (dataRow.uom) {\n                    amount =\n                      parseFloat(dataRow.uom.price) * parseFloat(dataRow.qty);\n                    xAmount = amount * parseFloat(this.saleOrder.txnRate);\n\n                    dataRow.set(\"price\", parseFloat(dataRow.uom.price));\n                    dataRow.set(\"amount\", amount);\n                    dataRow.set(\"exchangeAmount\", xAmount);\n                  } else {\n                    amount =\n                      parseFloat(dataRow.price) * parseFloat(dataRow.qty);\n                    xAmount = amount * parseFloat(this.saleOrder.txnRate);\n\n                    dataRow.set(\"price\", parseFloat(dataRow.price));\n                    dataRow.set(\"amount\", amount);\n                    dataRow.set(\"exchangeAmount\", xAmount);\n                  }\n                } catch (err) {\n                  dataRow.set(\"buom\", {});\n                  dataRow.set(\"conversionRate\", 1);\n                  dataRow.set(\"price\", 0);\n                  dataRow.set(\"qoh\", 0);\n                  dataRow.set(\"wac\", 0);\n                  dataRow.set(\"amount\", 0);\n                  dataRow.set(\"exchangeAmount\", 0);\n                }\n              } catch {\n                dataRow.set(\"price\", 0);\n                dataRow.set(\"amount\", 0);\n              }\n            }\n            break;\n          case \"price\":\n            try {\n              amount = parseFloat(dataRow.price) * parseFloat(dataRow.qty);\n              xAmount = amount * parseFloat(this.saleOrder.txnRate);\n\n              dataRow.set(\"price\", parseFloat(dataRow.price));\n              dataRow.set(\"amount\", amount);\n              dataRow.set(\"exchangeAmount\", xAmount);\n              // window.console.log('price',dataRow.price)\n            } catch {\n              dataRow.set(\"price\", 0);\n              dataRow.set(\"amount\", 0);\n              dataRow.set(\"exchangeAmount\", 0);\n            }\n            break;\n          case \"qty\":\n            try {\n              amount = parseFloat(dataRow.price) * parseFloat(dataRow.qty);\n              xAmount = amount * parseFloat(this.saleOrder.txnRate);\n\n              dataRow.set(\"price\", parseFloat(dataRow.price));\n              dataRow.set(\"amount\", amount);\n              dataRow.set(\"exchangeAmount\", xAmount);\n            } catch {\n              dataRow.set(\"price\", 0);\n              dataRow.set(\"amount\", 0);\n              dataRow.set(\"exchangeAmount\", 0);\n            }\n            break;\n          case \"otherTax\":\n            // window.console.log(\"--\", dataRow)\n            break;\n          default:\n            break;\n        }\n        if (e.field) {\n          this.autoCalculate();\n        }\n      }\n    },\n    autoCalculate() {\n      let ds = this.$refs.itemLineDS.kendoWidget(),\n        subTotal = 0,\n        totalTax = 0,\n        discountTotal = 0,\n        spTax = 0,\n        pltax = 0,\n        otherTax = 0,\n        vatTax = 0,\n        discountInvoice = 0,\n        taxList = [],\n        discountItem = [],\n        saleUnit = [],\n        inclusiveTax = 0,\n        itemSubtotal = 0,\n        txnItmSubtotal = 0,\n        serviceSubtotal = 0,\n        itemDiscount = 0,\n        serviceDiscount = 0,\n        txnDiscount = 0;\n\n      const rows = ds.data().filter((m) => parseFloat(m.amount) > 0);\n      rows.forEach((value) => {\n        let modifierPrice = 0;\n        if (value.modifier) {\n          modifierPrice = kendo.parseFloat(value.modifier.price);\n        }\n\n        // subTotal += (kendo.parseFloat(value.amount) + modifierPrice)\n        let discount = 0;\n        if (value.discountItem) {\n          let subTo =\n            kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n          discount = this.autoCalculateDiscount(value.discountItem, subTo);\n          window.console.log(\n            \"discount item\",\n            discount,\n            \"--\",\n            value.discountItem\n          );\n          value[\"discountAmount\"] = discount;\n          value[\"discountExchangeAmount\"] =\n            discount * kendo.parseFloat(this.saleOrder.txnRate);\n          if (value.discountItem.hasOwnProperty(\"id\")) {\n            discountItem.push(value.discountItem);\n          }\n          discountTotal += discount;\n        }\n        if (value.saleUnit) {\n          if (value.saleUnit.hasOwnProperty(\"id\")) {\n            saleUnit.push(value.saleUnit);\n          }\n        }\n        if (value.specificTax) {\n          spTax = this.autoCalculateTax(\n            value.specificTax,\n            kendo.parseFloat(value.amount) - kendo.parseFloat(discount)\n          );\n          // window.console.log('sp ', discount)\n          spTax = kendo.parseFloat(spTax) ? kendo.parseFloat(spTax) : 0;\n          value[\"specificTaxAmount\"] = spTax;\n          value[\"specificTaxExchangeAmount\"] =\n            spTax * kendo.parseFloat(this.saleOrder.txnRate);\n          const tax = value.specificTax;\n          const baseAmount = tax.baseAmount;\n          if (baseAmount) {\n            if (baseAmount.toLowerCase() === \"inclusive\") {\n              inclusiveTax += spTax;\n            }\n          }\n          if (value.specificTax.hasOwnProperty(\"taxType\")) {\n            taxList.push({\n              name: value.specificTax.taxType.name,\n              amount: spTax,\n              id: value.specificTax.taxType.id,\n            });\n          }\n        }\n        if (value.publicLightingTax) {\n          pltax = this.autoCalculateTax(\n            value.publicLightingTax,\n            kendo.parseFloat(value.amount) - kendo.parseFloat(discount)\n          );\n          pltax = kendo.parseFloat(pltax) ? kendo.parseFloat(pltax) : 0;\n          value[\"publicLightingTaxAmount\"] = pltax;\n          value[\"publicLightingTaxExchangeAmount\"] =\n            pltax * kendo.parseFloat(this.saleOrder.txnRate);\n          const tax = value.publicLightingTax;\n          const baseAmount = tax.baseAmount;\n          if (baseAmount) {\n            if (baseAmount.toLowerCase() === \"inclusive\") {\n              inclusiveTax += pltax;\n            }\n          }\n          if (value.publicLightingTax.hasOwnProperty(\"taxType\")) {\n            taxList.push({\n              name: value.publicLightingTax.taxType.name,\n              amount: pltax,\n              id: value.publicLightingTax.taxType.id,\n            });\n          }\n        }\n        if (value.otherTax) {\n          otherTax = this.autoCalculateTax(\n            value.otherTax,\n            kendo.parseFloat(value.amount) - kendo.parseFloat(discount)\n          );\n          otherTax = kendo.parseFloat(otherTax)\n            ? kendo.parseFloat(otherTax)\n            : 0;\n          value[\"otherTaxAmount\"] = otherTax;\n          value[\"otherTaxExchangeAmount\"] =\n            otherTax * kendo.parseFloat(this.saleOrder.txnRate);\n          const tax = value.otherTax;\n          const baseAmount = tax.baseAmount;\n          if (baseAmount) {\n            if (baseAmount.toLowerCase() === \"inclusive\") {\n              inclusiveTax += otherTax;\n            }\n          }\n          if (value.otherTax.hasOwnProperty(\"taxType\")) {\n            taxList.push({\n              name: value.otherTax.taxType.name,\n              amount: otherTax,\n              id: value.otherTax.taxType.id,\n            });\n          }\n        }\n\n        if (value.vatTax) {\n          // window.console.log('Vat Tax', value.vatTax)\n          let amt =\n            kendo.parseFloat(spTax ? spTax : 0) +\n            kendo.parseFloat(pltax ? pltax : 0) +\n            kendo.parseFloat(otherTax ? otherTax : 0) +\n            (kendo.parseFloat(value.amount ? value.amount : 0) -\n              (discount ? discount : 0));\n          vatTax = this.autoCalculateTax(value.vatTax, amt);\n          vatTax = kendo.parseFloat(vatTax) ? kendo.parseFloat(vatTax) : 0;\n          value[\"vatTaxAmount\"] = vatTax;\n          value[\"vatTaxExchangeAmount\"] =\n            vatTax * kendo.parseFloat(this.saleOrder.txnRate);\n          const tax = value.vatTax;\n          const baseAmount = tax.baseAmount;\n          if (baseAmount) {\n            if (baseAmount.toLowerCase() === \"inclusive\") {\n              inclusiveTax += vatTax;\n            }\n          }\n          if (value.vatTax.hasOwnProperty(\"taxType\")) {\n            taxList.push({\n              name: value.vatTax.taxType.name,\n              amount: vatTax,\n              id: value.vatTax.taxType.id,\n            });\n          }\n        }\n        totalTax +=\n          kendo.parseFloat(spTax ? spTax : 0) +\n          kendo.parseFloat(pltax ? pltax : 0) +\n          kendo.parseFloat(otherTax ? otherTax : 0) +\n          kendo.parseFloat(vatTax ? vatTax : 0);\n        subTotal +=\n          kendo.parseFloat(value.amount) + modifierPrice - inclusiveTax;\n\n        const item = value.item;\n        const itmType = item.type || \"\";\n        if (itmType === \"Variant\") {\n          itemSubtotal +=\n            kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n          itemDiscount += kendo.parseFloat(discount);\n        } else if (itmType === \"Service\") {\n          serviceSubtotal +=\n            kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n          serviceDiscount += kendo.parseFloat(discount);\n        } else {\n          txnItmSubtotal +=\n            kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n          txnDiscount += kendo.parseFloat(discount);\n        }\n        //include Tax Amount\n        const amountNodiscount =\n          kendo.parseFloat(value.price) * kendo.parseFloat(value.qty) -\n          discount;\n        const includeTaxAmount =\n          amountNodiscount + vatTax + pltax + spTax + otherTax;\n        value[\"includeTaxAmount\"] = includeTaxAmount;\n        value[\"includeTaxExchangeAmount\"] =\n          includeTaxAmount * kendo.parseFloat(this.saleOrder.txnRate);\n      });\n\n      this.saleOrder.itemSubtotal = itemSubtotal;\n      this.saleOrder.exchangeItemSubtotal =\n        itemSubtotal * kendo.parseFloat(this.saleOrder.txnRate);\n\n      this.saleOrder.serviceSubtotal = serviceSubtotal;\n      this.saleOrder.exchangeServiceSubtotal =\n        serviceSubtotal * kendo.parseFloat(this.saleOrder.txnRate);\n      this.saleOrder.txnItmSubtotal = txnItmSubtotal;\n      this.saleOrder.exchangeTxnItmSubtotal =\n        txnItmSubtotal * kendo.parseFloat(this.saleOrder.txnRate);\n\n      this.saleOrder.itemDiscount = itemDiscount;\n      this.saleOrder.exchangeItemDiscount =\n        itemDiscount * kendo.parseFloat(this.saleOrder.txnRate);\n      this.saleOrder.serviceDiscount = serviceDiscount;\n      this.saleOrder.exchangeServiceDiscount =\n        serviceDiscount * kendo.parseFloat(this.saleOrder.txnRate);\n      this.saleOrder.txnItmDiscount = txnDiscount;\n      this.saleOrder.exchangeTxnItmDiscount =\n        txnDiscount * kendo.parseFloat(this.saleOrder.txnRate);\n\n      discountTotal = discountTotal ? discountTotal : 0;\n\n      // window.console.log(spTax, pltax, otherTax, vatTax)\n      let total =\n        kendo.parseFloat(subTotal) -\n        kendo.parseFloat(discountTotal) +\n        kendo.parseFloat(totalTax);\n      this.saleOrder.subTotal = subTotal;\n      this.saleOrder.totalTaxAmount = kendo.parseFloat(totalTax);\n      this.saleOrder.discountTotal = kendo.parseFloat(discountTotal);\n      if (this.saleOrder.specificDiscountItem) {\n        discountInvoice = this.autoCalculateDiscount(\n          this.saleOrder.specificDiscountItem,\n          kendo.parseFloat(subTotal)\n        );\n        discountInvoice = discountInvoice ? discountInvoice : 0;\n      }\n      // this.onOtherChargeChange()\n      this.saleOrder.total =\n        kendo.parseFloat(total) -\n        discountInvoice +\n        kendo.parseFloat(this.saleOrder.otherChargeAmount);\n      this.saleOrder.exchangeAmount =\n        kendo.parseFloat(this.saleOrder.total) *\n        kendo.parseFloat(this.saleOrder.txnRate);\n      this.autoCalculateTaxByType(taxList);\n      this.customerDiscountItem = this.removeDuplicate(discountItem);\n      this.customerSaleUnit = this.removeDuplicate(saleUnit);\n      // window.console.log('discount ', this.customerDiscountItem)\n    },\n    rowNumberTmpl(dataItem) {\n      let ds = this.$refs.itemLineDS.kendoWidget(),\n        index = ds.indexOf(dataItem);\n      return index + 1;\n    },\n    async loadSaleFormContent() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          saleFormContentHandler.list().then((res) => {\n            if (res.data.statusCode === 200) {\n              const data = res.data.data;\n              if (data.length > 0) {\n                this.saleFormContent = data[0];\n                // window.console.log(data[0])\n              }\n            }\n          });\n        }, 10);\n      });\n    },\n    vatTemplate(dataItem) {\n      const vat = dataItem.vatTax;\n      if (vat) {\n        return `<span>${vat.defaultTax ? vat.defaultTax : ``}</span>`;\n      } else {\n        return ``;\n      }\n    },\n    itemTemplate(dataItem) {\n      const item = dataItem.item;\n      if (item) {\n        return `<span>${item.name ? item.name : ``}</span>`;\n      } else {\n        return ``;\n      }\n    },\n    UOMTemplate(dataItem) {\n      const uom = dataItem.uom;\n      if (uom) {\n        return `<span>${uom.uom ? uom.uom.name : ``}</span>`;\n      } else {\n        return ``;\n      }\n    },\n    saleUnitTemplate(dataItem) {\n      const saleUnit = dataItem.saleUnit;\n      if (saleUnit) {\n        return `<span>${saleUnit.name ? saleUnit.name : ``}</span>`;\n      } else {\n        return ``;\n      }\n    },\n    discountItemTemplate(dataItem) {\n      const discountItem = dataItem.discountItem;\n      if (discountItem) {\n        return `<span>${discountItem.code ? discountItem.code : ``} - ${\n          discountItem.name ? discountItem.name : ``\n        }</span>`;\n      } else {\n        return ``;\n      }\n    },\n    ServiceDateEditor(container, options) {\n      kendo\n        .jQuery('<input required name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDatePicker();\n\n      // let ds = this.$refs.itemLineDS.kendoWidget()\n      // window.console.log(ds.data())\n      // // const dateString = kendo.toString((new Date(options.model.items.serviceDate)), this.itemLine.dateFormat)\n      // // const dateString = kendo.toString(options.model.items.serviceDate)\n      // const $input = $(\"<input value=\" + options.model.serviceDate + \" />\").appendTo(container)\n      // $input.kendoDatePicker()\n      // // $input.appendTo(container)\n      // // options.model.items.serviceDate = dateString\n      // window.console.log($input)\n    },\n    ServiceDateToEditor(container, options) {\n      kendo\n        .jQuery('<input required name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDatePicker();\n    },\n    ItemDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"contains\",\n          dataTextField: \"name\",\n          dataValueField: \"id\",\n          headerTemplate:\n            '<div class=\"dropdown-header k-widget k-header\">' +\n            \"<span>Items </span>\" +\n            \"<span></span>\" +\n            \"</div>\",\n          template: \"<span>#=name#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            serverFiltering: true,\n            transport: {\n              read: {\n                url: productVariantHandler.itemSearchURL(\n                  \"?plId=\" + this.saleOrder.priceLevel.id\n                ),\n              },\n              dataType: \"json\",\n            },\n            schema: {\n              model: {\n                id: \"id\",\n                fields: {\n                  id: { type: \"string\" },\n                  name: { type: \"string\" },\n                  sku: { type: \"string\" },\n                },\n              },\n              data: function (response) {\n                return response.data;\n              },\n              total: function (response) {\n                return response.data.count;\n              },\n            },\n            // data: this.variants\n          }),\n        });\n    },\n    UOMDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"uom.name\",\n          dataValueField: \"uom.id\",\n          cascadeFrom: \"item\",\n          template: \"<span>#=uom.name || `No Price Level`#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            serverFiltering: true,\n            transport: {\n              read: {\n                // url: uomPriceHandler.getURL(options.model.item.id, this.saleOrder.priceLevel.id),\n                url: uomPriceHandler.uomPriceByPriceLevelURL(\n                  \"id=\" +\n                    options.model.item.id +\n                    \"&plId=\" +\n                    this.saleOrder.priceLevel.id +\n                    \"&date=\" +\n                    this.saleOrder.transactionDate\n                ),\n              },\n              dataType: \"json\",\n            },\n            schema: {\n              model: {\n                id: \"id\",\n                fields: {\n                  id: { type: \"string\" },\n                  // name: {type: \"string\"},\n                  // sku: {type: \"string\"},\n                },\n              },\n              data: function (response) {\n                return response.data;\n              },\n              total: function (response) {\n                return response.data.count;\n              },\n            },\n            // data: this.variants\n          }),\n        });\n    },\n    DiscountItemDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"name\",\n          dataValueField: \"id\",\n          cascadeFrom: \"item\",\n          template: \"<span>#=code# - #=name#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            serverFiltering: true,\n            transport: {\n              read: {\n                url: discountItemHandler.getURL(DISCOUNT_TYPE),\n              },\n              dataType: \"json\",\n            },\n            schema: {\n              model: {\n                id: \"id\",\n                fields: {\n                  id: { type: \"string\" },\n                  // name: {type: \"string\"},\n                  // sku: {type: \"string\"},\n                },\n              },\n              data: function (response) {\n                return response.data;\n              },\n              total: function (response) {\n                return response.data.count;\n              },\n            },\n          }),\n        });\n    },\n    SpecificTaxDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"defaultTax\",\n          dataValueField: \"id\",\n          template: \"<span>#=defaultTax#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            data: this.specificTax.filter((m) => {\n              if (options.model.hasOwnProperty(\"vatTax\")) {\n                const vat = options.model.vatTax;\n                if (vat) {\n                  if (\n                    options.model.vatTax !== null ||\n                    options.model.vatTax !== \"null\"\n                  ) {\n                    if (options.model.vatTax.baseAmount) {\n                      return (\n                        m.baseAmount.toLowerCase() ===\n                        options.model.vatTax.baseAmount.toLowerCase()\n                      );\n                    } else {\n                      return m;\n                    }\n                  }\n                } else {\n                  return m;\n                }\n              }\n            }),\n          }),\n        });\n    },\n    PublicLightingTaxDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"defaultTax\",\n          dataValueField: \"id\",\n          template: \"<span>#=defaultTax#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            data: this.publicLightingTax.filter((m) => {\n              if (options.model.hasOwnProperty(\"vatTax\")) {\n                const vat = options.model.vatTax;\n                if (vat) {\n                  if (\n                    options.model.vatTax !== null &&\n                    options.model.vatTax !== \"null\"\n                  ) {\n                    if (options.model.vatTax.baseAmount) {\n                      return (\n                        m.baseAmount.toLowerCase() ===\n                        options.model.vatTax.baseAmount.toLowerCase()\n                      );\n                    } else {\n                      return m;\n                    }\n                  }\n                } else {\n                  return m;\n                }\n              }\n            }),\n          }),\n        });\n    },\n    OtherTaxDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"defaultTax\",\n          dataValueField: \"id\",\n          template: \"<span>#=defaultTax#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            data: this.otherTax.filter((m) => {\n              if (options.model.hasOwnProperty(\"vatTax\")) {\n                const vat = options.model.vatTax;\n                if (vat) {\n                  if (\n                    options.model.vatTax !== null &&\n                    options.model.vatTax !== \"null\"\n                  ) {\n                    if (options.model.vatTax.baseAmount) {\n                      return (\n                        m.baseAmount.toLowerCase() ===\n                        options.model.vatTax.baseAmount.toLowerCase()\n                      );\n                    } else {\n                      return m;\n                    }\n                  }\n                } else {\n                  return m;\n                }\n              }\n            }),\n          }),\n        });\n    },\n    VatTaxDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"defaultTax\",\n          dataValueField: \"id\",\n          template: \"<span>#=defaultTax#</span>\",\n          optionLabel: \"--Select--\",\n          dataSource: new kendo.data.DataSource({\n            data: this.vatTax,\n          }),\n        });\n    },\n    SaleUnitDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"startswith\",\n          dataTextField: \"name\",\n          dataValueField: \"id\",\n          template: \"<span>#=code# - #=name#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            data: this.saleUnitItemList,\n          }),\n        });\n    },\n    ModifierDropDownEditor(container, options) {\n      const item = options.model.item || {};\n      const uom = item.uom || {};\n      const itemId = item.id || \"\";\n      const uomId = uom.id || \"\";\n      kendo\n        .jQuery('<input name=\"' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoDropDownList({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          filter: \"contains\",\n          dataTextField: \"name\",\n          dataValueField: \"id\",\n          headerTemplate:\n            '<div class=\"dropdown-header k-widget k-header\">' +\n            \"<span>Modifier </span>\" +\n            \"<span></span>\" +\n            \"</div>\",\n          template: \"<span>#=name#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            serverFiltering: true,\n            transport: {\n              read: {\n                url: itemModifierHandler.searchURL(\n                  \"?plId=\" +\n                    this.saleOrder.priceLevel.id +\n                    \"&id=\" +\n                    itemId +\n                    \"&uomId=\" +\n                    uomId\n                ),\n              },\n              dataType: \"json\",\n            },\n            schema: {\n              model: {\n                id: \"id\",\n                fields: {\n                  id: { type: \"string\" },\n                  name: { type: \"string\" },\n                  price: { type: \"number\" },\n                  uom: { type: \"string\" },\n                },\n              },\n              data: function (response) {\n                return response.data;\n              },\n              total: function (response) {\n                return response.data.count;\n              },\n            },\n          }),\n        });\n    },\n    EmployeeDropDownEditor(container, options) {\n      kendo\n        .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n        .appendTo(container)\n        .kendoMultiSelect({\n          autoBind: true,\n          autoWidth: true,\n          height: 400,\n          suggest: true,\n          filter: \"contains\",\n          dataTextField: \"name\",\n          dataValueField: \"id\",\n          headerTemplate:\n            '<div class=\"dropdown-header k-widget k-header\">' +\n            \"<span>Employee </span>\" +\n            \"<span></span>\" +\n            \"</div>\",\n          template: \"<span>#=name#</span>\",\n          optionLabel: \"--- Select ---\",\n          dataSource: new kendo.data.DataSource({\n            serverFiltering: true,\n            transport: {\n              read: {\n                url: employeeHandler.searchURL(),\n              },\n              dataType: \"json\",\n            },\n            schema: {\n              model: {\n                id: \"id\",\n                fields: {\n                  id: { type: \"string\" },\n                  name: { type: \"string\" },\n                  firstName: { type: \"string\" },\n                  lastName: { type: \"string\" },\n                },\n              },\n              data: function (response) {\n                return response.data;\n              },\n              total: function (response) {\n                return response.data.count;\n              },\n            },\n          }),\n        });\n    },\n    empImpl(dataItem) {\n      let empIds = [];\n      dataItem.employee.forEach((m) => {\n        empIds.push(m.firstName + \" - \" + m.lastName);\n      });\n      // window.console.log(empIds.join(', '))\n      return `<span>${empIds.join(\", \")}</span>`;\n    },\n    addRow() {\n      let ds = this.$refs.itemLineDS.kendoWidget(),\n        total = ds.total();\n      this.itemLine.id = invoicePrefix + uuid.v1();\n      ds.insert(total, this.itemLine);\n    },\n    onSpecificDiscountChanged() {\n      if (this.saleOrder.specificDiscountItem) {\n        const discountOrder = this.autoCalculateDiscount(\n          this.saleOrder.specificDiscountItem,\n          this.saleOrder.subTotal\n        );\n        this.saleOrder.specificDiscountTotal = kendo.toString(\n          discountOrder ? discountOrder : 0,\n          \"n\"\n        );\n        let total =\n          kendo.parseFloat(this.saleOrder.subTotal) -\n          (kendo.parseFloat(this.saleOrder.discountTotal) +\n            kendo.parseFloat(this.saleOrder.totalTaxAmount)) -\n          discountOrder;\n        this.saleOrder.total = kendo.toString(total, \"n\");\n      }\n    },\n    onOtherChargeChange() {\n      let otherCharge = 0;\n      this.mOtherCharge.forEach((m) => {\n        otherCharge += this.autoCalculateDiscount(m, this.saleOrder.subTotal);\n      });\n      this.saleOrder.otherChargeAmount = otherCharge;\n      this.autoCalculate();\n    },\n    async loadOtherCharge() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          otherChargeHandler.list().then((res) => {\n            if (res.data.statusCode === 200) {\n              this.otherChargeList = res.data.data;\n            }\n          });\n        }, 10);\n      });\n    },\n    onOtherAmount(value) {\n      return this.autoCalculateDiscount(value, this.saleOrder.subTotal);\n    },\n    async loadDiscountItem() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          discountItemHandler.list().then((res) => {\n            if (res.data.statusCode === 200) {\n              this.specificDiscountItem = res.data.data;\n            }\n          });\n        }, 10);\n      });\n    },\n    async loadSegment() {\n      this.segments = [];\n      const roleType = dataStore.roleType || 0;\n      if (roleType === 0) {\n        if (dataStore.roleData) {\n          const roleData = dataStore.roleData || [];\n          const segment = roleData.filter((itm) => itm.type === \"segment\");\n          const segmentDefault = segment.filter((m) => m.isDefault === 1);\n          this.segments = segment;\n          if (\n            this.$route.params.id === undefined ||\n            this.$route.params.id === \"\"\n          ) {\n            if (segmentDefault.length > 0) {\n              this.saleOrder.segment = segmentDefault[0];\n            }\n          }\n        }\n      } else if (roleType === 1) {\n        new Promise((resolve) => {\n          setTimeout(() => {\n            resolve(\"resolved\");\n            this.segments = [];\n            settingsHandler.getSeg().then((res) => {\n              this.showLoading = true;\n              if (res.data.statusCode === 200) {\n                this.showLoading = false;\n                this.segments = res.data.data;\n              } else {\n                this.showLoading = false;\n              }\n            });\n          }, 10);\n        });\n      }\n    },\n    async loadLocation() {\n      this.locations = [];\n      const roleType = dataStore.roleType || 0;\n      if (roleType === 0) {\n        if (dataStore.roleData) {\n          const roleData = dataStore.roleData || [];\n          const location = roleData.filter((itm) => itm.type === \"location\");\n          const locationDefault = location.filter((m) => m.isDefault === 1);\n          this.locations = location;\n          if (\n            this.$route.params.id === undefined ||\n            this.$route.params.id === \"\"\n          ) {\n            if (locationDefault.length > 0) {\n              this.saleOrder.location = locationDefault[0];\n            }\n          }\n        }\n      } else if (roleType === 1) {\n        new Promise((resolve) => {\n          setTimeout(() => {\n            resolve(\"resolved\");\n            this.locations = [];\n            locationHandler.list().then((res) => {\n              this.showLoading = true;\n              if (res.data.statusCode === 200) {\n                this.showLoading = false;\n                this.locations = res.data.data;\n              } else {\n                this.showLoading = false;\n              }\n            });\n          }, 10);\n        });\n      }\n    },\n    async loadProjectByCustomer() {\n      this.customerProjects = [];\n      const roleType = dataStore.roleType || 0;\n      if (roleType === 0) {\n        if (dataStore.roleData) {\n          const roleData = dataStore.roleData || [];\n          const project = roleData.filter((itm) => itm.type === \"project\");\n          project.forEach((k) => {\n            const customers = k.customers || [];\n            const proCustomer = customers.filter(\n              (n) => n.customer.id === this.customer.id\n            );\n            if (proCustomer.length > 0) {\n              this.customerProjects.push(k);\n            }\n          });\n          if (\n            this.$route.params.id === undefined ||\n            this.$route.params.id === \"\"\n          ) {\n            const projectDefault = this.customerProjects.filter(\n              (m) => m.isDefault === 1\n            );\n            if (projectDefault.length > 0) {\n              this.saleOrder.project = projectDefault[0];\n            }\n          }\n        }\n      } else if (roleType === 1) {\n        new Promise((resolve) => {\n          setTimeout(() => {\n            resolve(\"resolved\");\n            projectHandler.getByCustomer(this.customer.id).then((res) => {\n              this.showLoading = true;\n              if (res.data.statusCode === 200) {\n                this.showLoading = false;\n                this.customerProjects = res.data.data;\n              } else {\n                this.showLoading = false;\n              }\n            });\n          }, 10);\n        });\n      }\n    },\n    async loadSaleChannel() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          this.showLoading = true;\n          saleChannelHandler.get().then((res) => {\n            if (res.data.statusCode === 200) {\n              this.showLoading = false;\n              this.saleChannelList = res.data.data;\n              if (this.saleChannelList.length > 0) {\n                if (\n                  this.$route.params.id !== undefined ||\n                  this.$route.params.id != \"\"\n                ) {\n                  this.saleOrder.saleChannel = this.saleChannelList[0];\n                }\n              }\n            } else {\n              this.showLoading = false;\n            }\n          });\n        }, 10);\n      });\n    },\n    async loadTax() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          settingHandler.get().then((res) => {\n            this.tax = res;\n            this.otherTax = this.tax.filter(\n              (m) =>\n                (m.taxType.typeId === 7 || m.taxType.typeId === 10) &&\n                m.transactionType === \"Sale\"\n            ); // valuable tax\n            this.specificTax = this.tax.filter(\n              (m) =>\n                (m.taxType.typeId === 8 || m.taxType.typeId === 10) &&\n                m.transactionType === \"Sale\"\n            ); // valuable tax\n            this.publicLightingTax = this.tax.filter(\n              (m) =>\n                (m.taxType.typeId === 9 || m.taxType.typeId === 10) &&\n                m.transactionType === \"Sale\"\n            ); // valuable tax\n            this.vatTax = this.tax.filter(\n              (m) =>\n                (m.taxType.typeId === 1 ||\n                  m.taxType.typeId === 8 ||\n                  m.taxType.typeId === 10) &&\n                m.transactionType === \"Sale\"\n            ); // valuable tax\n          });\n        }, 10);\n      });\n    },\n    async loadSaleUnitItems() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          saleUnitItemHandler.list().then((res) => {\n            if (res.data.statusCode === 200)\n              this.saleUnitItemList = res.data.data;\n          });\n        }, 10);\n      });\n    },\n    async loadCustomerBalance(id) {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          const strFilter = id + \"?type=bal\";\n          billingHandler\n            .balance(strFilter)\n            .then((res) => {\n              if (res.data.statusCode === 200) {\n                const data = res.data.data;\n                if (data.length > 0) {\n                  this.saleOrder.currentBalance = data[0].balance;\n                }\n              }\n            })\n            .catch();\n          {\n            this.showLoading = false;\n          }\n        }, 10);\n      });\n    },\n    creditLimitUsage(balance, creditLimit) {\n      let num = 0;\n      let per = (balance / creditLimit) * 100;\n      if (isNaN(per)) {\n        // It isn't a number\n        num = 0;\n      } else {\n        // It is a number\n        num = per;\n      }\n      return num + \" %\";\n    },\n    close(data) {\n      if (this.$route.params.id === undefined) {\n        this.$router.push({\n          name: \"Customers\",\n          params: {\n            data: data,\n          },\n        });\n      } else {\n        window.history.go(-1);\n      }\n      window.console.log(data, \"close\");\n      // localStorage.data.id = JSON.stringify(data)\n    },\n    //catalog\n    loadImage(dataItem) {\n      if (dataItem.hasOwnProperty(\"images\")) {\n        if (dataItem.images.hasOwnProperty(\"default\")) {\n          const url = this.imgURL + dataItem.images.default.thumb;\n          return (\n            \"<img width='50' height='50' style= 'margin: auto;display: block;' src='\" +\n            url +\n            \"' />\"\n          );\n        }\n      } else {\n        return \"\";\n      }\n    },\n    async loadCatalogs() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          this.showLoading = true;\n          catalogHandler.get().then((res) => {\n            this.showLoading = false;\n            this.catalogs = res;\n          });\n        }, 10);\n      });\n    },\n    addCatalog(e) {\n      e.preventDefault();\n      let grid = kendo.jQuery(\"#gridCatalog\").data(\"kendoGrid\");\n      let dataItem = grid.dataItem($(e.currentTarget).closest(\"tr\"));\n      // window.console.log(dataItem)\n      if (dataItem.variants.length > 0) {\n        dataItem.variants.forEach((m) => {\n          if (m.hasOwnProperty(\"variant\")) {\n            if (m.variant.hasOwnProperty(\"id\")) {\n              this.loadSingleItem(m.variant.id, \"i\");\n            }\n          }\n        });\n        this.dialogCatalog = false;\n      }\n      if (dataItem.services.length > 0) {\n        dataItem.services.forEach((m) => {\n          if (m.hasOwnProperty(\"service\")) {\n            if (m.service.hasOwnProperty(\"id\")) {\n              this.loadSingleItem(m.service.id, \"s\");\n            }\n          }\n        });\n        this.dialogCatalog = false;\n      }\n    },\n    async loadSingleItem(itemId, type) {\n      new Promise((resolve) => {\n        resolve(\"resolved\");\n        setTimeout(() => {\n          this.showLoading = true;\n          productHandler.getOne(itemId).then((res) => {\n            this.showLoading = false;\n            let data = res;\n            window.console.log(data);\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n              total = ds.total();\n            this.itemLine.id = invoicePrefix + uuid.v1();\n            this.itemLine.item = data;\n            if (type == \"i\") {\n              this.itemLine.description = data.variant.saleDescription;\n            } else {\n              this.itemLine.description = data.saleDescription;\n            }\n            ds.insert(total, this.itemLine);\n          });\n        }, 500);\n      });\n    },\n    async loadPrefix() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          prefixHandler.get(\"sale order\").then((res) => {\n            if (res.data.statusCode === 200) {\n              this.showLoading = false;\n              this.transactionType = res.data.data;\n              if (this.transactionType.length > 0) {\n                this.saleOrder.transactionType = this.transactionType[0];\n                if (!this.initsaleOrder) {\n                  this.generateNumber();\n                }\n              }\n            }\n          });\n        }, 10);\n      });\n    },\n    async loadViewsaleOrder() {\n      if (!this.initsaleOrder) {\n        this.isEdit = true;\n        new Promise((resolve) => {\n          setTimeout(() => {\n            resolve(\"resolved\");\n            this.showLoading = true;\n            saleOrderHandler\n              .view(this.$route.params.id)\n              .then((res) => {\n                if (res.data.statusCode === 200) {\n                  this.showLoading = false;\n                  this.saleOrder = res.data.data[0];\n                  this.quotes = this.saleOrder.refFrom || [];\n                  this.bindData();\n                }\n              })\n              .catch();\n            {\n              this.showLoading = false;\n            }\n          }, 10);\n        });\n      } else {\n        this.setDefaultData();\n      }\n    },\n    async loadQuote() {\n      if (this.saleOrder.customer) {\n        this.refFrom = [];\n        this.showLoading = true;\n        this.quotes = [];\n        new Promise((resolve) => {\n          setTimeout(() => {\n            resolve(\"resolved\");\n            let data = {\n              method: \"by_customer\",\n              customer: this.saleOrder.customer.id,\n              segmentId: this.saleOrder.segment.id,\n              locationId: this.saleOrder.location.id,\n              priceLevelId: this.saleOrder.priceLevel.id,\n              type: \"Sale Quote\",\n            };\n            saleOrderHandler.search(data).then((res) => {\n              this.showLoading = false;\n              this.quotes = res.data.data;\n            });\n          }, 10);\n        });\n      }\n    },\n    addQuote(data) {\n      //add item lines\n      let txnData = data.txnData || {};\n      const itemLines = data.itemLines || [];\n      this.refFrom.push({\n        id: data.id || \"\",\n        reference: data.number || \"\",\n        customerId: txnData.customerId || \"\",\n      });\n      if (itemLines.length > 0) {\n        this.removeEmptyLine();\n        itemLines.forEach((m) => {\n          m.txn_add_id = txnData.id;\n          m.id = invoicePrefix + uuid.v1();\n          let ds = this.$refs.itemLineDS.kendoWidget(),\n            total = ds.total();\n          ds.insert(total, m);\n        });\n        // this.addRow();\n      }\n      //add other chard\n      if (data.otherCharge.length > 0) {\n        data.otherCharge.forEach((m) => {\n          m.txn_add_id = txnData.id;\n          this.mOtherCharge.push(m);\n        });\n        this.autoCalculate();\n        this.onOtherChargeChange();\n      }\n      // add txnlist\n      this.txnLists.push(txnData);\n      if (txnData.lead.id !== undefined) {\n        this.txnLists.push(txnData.lead);\n      }\n      // window.console.log(this.txnLists);\n      //remove txn\n      const index = this.quotes.findIndex((item) => {\n        return data.id === item.id;\n      });\n      this.autoCalculate();\n      this.quotes.splice(index, 1);\n      // this.quotes[index].is_added = true\n      // window.console.log(this.quotes)\n      this.saleOrder.refFrom = this.removeDuplicate(this.refFrom);\n      window.console.log(\"ref\", this.saleOrder.refFrom);\n    },\n    removeEmptyLine() {\n      const grid = kendo.jQuery(\"#gridItemLineSaleOrder\").data(\"kendoGrid\"),\n        dataSource = grid.dataSource;\n      dataSource.data().forEach((m) => {\n        if (m) {\n          const item = m.item || {};\n          if (item.id === undefined || item.id === \"\") {\n            dataSource.remove(m);\n          }\n        }\n      });\n    },\n    async loadTransactionRate() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          const date = new Date(this.saleOrder.transactionDate)\n            .toISOString()\n            .substr(0, 10);\n          const priceLevel = this.saleOrder.priceLevel;\n          let code = \"\";\n          if (priceLevel.hasOwnProperty(\"currency\")) {\n            if (priceLevel.currency.hasOwnProperty(\"code\")) {\n              code = priceLevel.currency.code;\n            }\n          }\n          if (code !== undefined || code !== \"\") {\n            this.showLoading = true;\n            currencyHandler\n              .getLastExchangeRateByDate(date, code)\n              .then((res) => {\n                if (res.data.statusCode === 200) {\n                  this.showLoading = false;\n                  this.exchangeRate = res.data.data[0];\n                  this.currencyCode = this.exchangeRate.code;\n                  this.transactionRate = this.exchangeRate.rate;\n                  this.saleOrder.txnRate = this.exchangeRate.rate;\n                  this.saleOrder.exchangeRate = this.exchangeRate;\n                  this.showLoading = false;\n                }\n              });\n          }\n        }, 10);\n      });\n    },\n    clear() {\n      this.id = undefined;\n      this.saleOrder = {};\n      this.itemLines = [];\n      this.customer = \"\";\n      this.generateNumber();\n    },\n    saveClose() {\n      let id = \"\";\n      if (this.customer.hasOwnProperty(\"id\")) {\n        id = this.customer.id || \"\";\n      }\n      if (id === \"\") {\n        this.$snotify.error(\"customer is require\");\n        return;\n      }\n      let ds = this.$refs.itemLineDS.kendoWidget();\n      let d1 = ds.data().filter((m) => m.amount > 0);\n      let dataValidate = 0;\n      d1.forEach((value, index) => {\n        if (value.item.id == undefined || value.uom.id == undefined) {\n          this.$snotify.error(\n            \"Please check Item or Uom  on row \" + (index + 1)\n          );\n        } else {\n          dataValidate += 1;\n        }\n      });\n      if (d1.length == dataValidate) {\n        this.isSaveClose = true;\n        this.saveOption = \"saveClose\";\n        this.save();\n      }\n    },\n    savePrint() {\n      this.isSavePrint = true;\n      this.saveOption = \"savePrint\";\n      this.save();\n    },\n    saveNew() {\n      this.saveOption = \"saveNew\";\n      this.isSaveNew = true;\n      this.save();\n    },\n    cancel() {\n      this.$swal({\n        title: i18n.t(\"msg_title_warning\"),\n        text: i18n.t(\"msg_discard\"),\n        icon: \"warning\",\n        showCancelButton: true,\n        cancelButtonText: i18n.t(\"cancel\"),\n        confirmButtonColor: \"#4d4848\",\n        cancelButtonColor: \"#ED1A3A\",\n        confirmButtonText: i18n.t(\"discard\"),\n      }).then((resultCen) => {\n        window.console.log(resultCen);\n        if (resultCen.value) {\n          this.$router.go(-1);\n        }\n      });\n    },\n    saveDraft() {\n      this.saveOption = \"saveDraft\";\n      this.isSaveDraft = true;\n      this.save();\n    },\n    async save() {\n      if (!this.$refs.form.validate()) {\n        this.$refs.form.validate();\n        return;\n      }\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          this.removeEmptyLine();\n          let itemLineDS = this.$refs.itemLineDS.kendoWidget(),\n            total = itemLineDS.total();\n          let itmLines = itemLineDS\n            .data()\n            .filter((m) => m.amount > 0)\n            .map((m) => {\n              return new ItemLineModel(m);\n            });\n\n          if (total <= 0) {\n            this.$snotify.error(\"Field Required!\");\n            return;\n          }\n          if (!this.isRequredPurchase) {\n            this.saleOrder.supplier = {};\n          } else {\n            //is for purchase\n            this.saleOrderType = 5;\n          }\n          // window.console.log(itmLines, 'itmLines')\n          // window.console.log(JSON.stringify(itmLines), 'itmLines')\n          let data = {\n            id: this.saleOrder.id ? this.saleOrder.id : \"\",\n            type: \"Sale Order\",\n            transactionType: this.saleOrder.transactionType,\n            number: this.saleOrder.number,\n            abbr: this.saleOrder.transactionType.abbr,\n            transactionDate: this.saleOrder.transactionDate,\n            transactionDateTZ: Helper.toISODate(this.saleOrder.transactionDate),\n            validityDate: this.saleOrder.validityDate,\n            monthOf: this.saleOrder.monthOf,\n            customer: this.saleOrder.customer,\n            paymentTerm: this.saleOrder.paymentTerm,\n            discountPromotion: {},\n            priceLevel: this.saleOrder.priceLevel,\n            itemLines: itmLines,\n            segment: this.saleOrder.segment,\n            location: this.saleOrder.location,\n            project: this.saleOrder.project,\n            saleChannel: this.saleOrder.saleChannel,\n            billingAddress: this.saleOrder.billingAddress,\n            deliveryAddress: this.saleOrder.deliveryAddress,\n            deliveryDateTime: this.saleOrder.deliveryDateTime,\n            transactionNote: this.saleOrder.transactionNote,\n            subTotal: this.saleOrder.subTotal,\n            total: this.saleOrder.total,\n            amount: this.saleOrder.amount,\n            discountTotal: this.saleOrder.discountTotal,\n            specificDiscountTotal: this.saleOrder.specificDiscountTotal,\n            deliveryFee: this.saleOrder.deliveryFee,\n            totalTaxAmount: this.saleOrder.totalTaxAmount,\n            currentBalance: this.saleOrder.currentBalance,\n            creditLimit: this.saleOrder.creditLimit,\n            saveOption: this.saveOption,\n            txnRate: this.saleOrder.txnRate,\n            rate: 1,\n            exchangeRate: this.saleOrder.exchangeRate,\n            exchangeAmount: this.saleOrder.exchangeAmount,\n            status: 1,\n            approvedBy: this.saleOrder.approvedBy,\n            formTemplate: {},\n            specificDiscountItem: this.saleOrder.specificDiscountItem,\n            otherCharge: this.mOtherCharge,\n            otherChargeAmount: this.saleOrder.otherChargeAmount,\n            publicLink: \"\",\n            taxListTotal: this.taxListTotal,\n            customerDiscountItem: this.customerDiscountItem,\n            customerSaleUnit: this.customerSaleUnit,\n            loggedUser: this.loggedUser,\n            txnList: this.txnLists,\n            saleOrderType: this.saleOrder.saleOrderType,\n            employee: this.saleOrder.employee,\n            supplier: this.saleOrder.supplier,\n            itemSubtotal: this.saleOrder.itemSubtotal,\n            exchangeItemSubtotal: this.saleOrder.exchangeItemSubtotal,\n            serviceSubtotal: this.saleOrder.serviceSubtotal,\n            exchangeServiceSubtotal: this.saleOrder.exchangeServiceSubtotal,\n            txnItmSubtotal: this.saleOrder.txnItmSubtotal,\n            exchangeTxnItmSubtotal: this.saleOrder.exchangeTxnItmSubtotal,\n            itemDiscount: this.saleOrder.itemDiscount,\n            exchangeItemDiscount: this.saleOrder.exchangeItemDiscount,\n            serviceDiscount: this.saleOrder.serviceDiscount,\n            exchangeServiceDiscount: this.saleOrder.exchangeServiceDiscount,\n            txnItmDiscount: this.saleOrder.txnItmDiscount,\n            exchangeTxnItmDiscount: this.saleOrder.exchangeTxnItmDiscount,\n            lead: {},\n            routeView: \"sale_order_view\",\n            exspectedDate: \"\",\n            usedDateAt: \"\",\n            deletedAt: \"\",\n            deleted: 0,\n            refFrom: this.saleOrder.refFrom || [],\n            refTo: this.saleOrder.refTo || [],\n            createdAt: new Date().toISOString().substr(0, 10),\n          };\n          // window.console.log('data', data)\n          // window.console.log('data', JSON.stringify(data))\n          this.showLoading = true;\n          this.btnDisabled = true;\n          saleOrderHandler\n            .create(data)\n            .then((response) => {\n              this.showLoading = false;\n              if (response.data.statusCode === 201) {\n                this.btnDisabled = false;\n                if (this.isSaveNew == true) {\n                  this.setDefaultData();\n                } else {\n                  this.close(response.data.data);\n                }\n                // this.$refs.form.reset();\n                this.$snotify.success(\"Successfully\");\n              } else {\n                this.btnDisabled = false;\n                this.showLoading = false;\n              }\n            })\n            .catch((e) => {\n              this.$snotify.error(\"Something went wrong\");\n              this.errors.push(e);\n              window.console.log(e);\n            });\n        }, 10);\n      });\n    },\n    async loadPaymentTermList() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          if (this.customer) {\n            const strFilter =\n              \"?id=\" +\n              this.customer.id +\n              \"&transactionDate=\" +\n              this.saleOrder.transactionDate +\n              \"&type=Customer\";\n            this.saleOrder.paymentTerm = {};\n            paymentTermHandler_.get(strFilter).then((res) => {\n              if (res.data.statusCode === 200) {\n                const terms = res.data.data;\n                this.saleOrder.paymentTerm = terms.term;\n              }\n            });\n          }\n        }, 10);\n      });\n    },\n    async loadCreditLimit() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          if (this.customer) {\n            const strFilter =\n              \"?id=\" +\n              this.customer.id +\n              \"&transactionDate=\" +\n              this.saleOrder.transactionDate +\n              \"&type=Customer\";\n            this.saleOrder.creditLimit = 0;\n            creditLimitHandler.get(strFilter).then((res) => {\n              if (res.data.statusCode === 200) {\n                // this.creditLimitItem = res.data.data\n                const credit = res.data.data;\n                this.saleOrder.creditLimit = kendo.parseFloat(\n                  credit.amount || 0\n                );\n              }\n            });\n          }\n        }, 10);\n      });\n    },\n    async clearUOMItem() {\n      let ds = this.$refs.itemLineDS.kendoWidget();\n      ds.data().map((n) => {\n        n.set(\"uom\", {});\n      });\n      this.isPriceLevelChanged = false;\n    },\n    onPriceLevelChange() {\n      this.isPriceLevelChanged = true;\n      this.loadTransactionRate();\n      this.clearUOMItem();\n      this.loadQuote();\n    },\n    async loadSaleOrder(id) {\n      window.console.log(id, \"load id\");\n      this.showLoading = true;\n      transactionHandler.view(id).then((res) => {\n        this.showLoading = false;\n        this.isEdit = true;\n        this.itemLines = [];\n        this.saleOrder = res.data.data[0];\n        this.bindData();\n      });\n    },\n    async loadEmployeeCenter() {\n      new Promise((resolve) => {\n        setTimeout(() => {\n          resolve(\"resolved\");\n          this.employees = [];\n          employeeHandler\n            .center(undefined)\n            .then((res) => {\n              this.showLoading = true;\n              this.saleOrder.employee = {};\n              this.employees = [];\n              if (res.data.statusCode === 200) {\n                this.showLoading = false;\n                this.employees = res.data.data;\n                // if (this.employees.length > 0) {\n                //     this.transaction.employee = this.employees[0];\n                // }\n              } else {\n                this.showLoading = false;\n              }\n            })\n            .catch();\n          {\n            this.showLoading = false;\n          }\n        }, 10);\n      });\n    },\n    async loadSingleData() {\n      if (this.$route.name === \"Sale Order\") {\n        if (this.initsaleOrder) {\n          // Edit Mode\n          this.itemLines = [];\n          this.saleOrder = this.initsaleOrder;\n          this.bindData();\n        } else {\n          // new\n          if (this.$route.params.id != undefined) {\n            this.loadSaleOrder(this.$route.params.id);\n          } else {\n            this.setDefaultData();\n          }\n        }\n        prefixHandler.get(\"sale order\").then((res) => {\n          if (res.data.statusCode === 200) {\n            this.showLoading = false;\n            this.transactionType = res.data.data;\n            if (this.transactionType.length > 0) {\n              if (\n                this.$route.params.id !== undefined ||\n                this.$route.params.id != \"\"\n              ) {\n                this.saleOrder.transactionType = this.transactionType[0];\n                if (\n                  !this.initSaleOrder &&\n                  this.$route.params.id === undefined\n                ) {\n                  this.generateNumber();\n                }\n              }\n            }\n          }\n        });\n        await this.loadPaymentTerm();\n        await this.loadSaleFormContent();\n        await this.loadOtherCharge();\n        await this.loadPriceLevel();\n        await this.loadDiscountItem(0);\n        await this.loadSaleChannel();\n        await this.loadCatalogs();\n        await this.loadLead();\n        this.loadTax();\n        this.loadSaleUnitItems();\n        this.loadSegment();\n        this.loadLocation();\n        this.loadEmployeeCenter();\n      }\n    },\n  },\n  activated() {\n    if (this.$route.params.id) {\n      this.loadViewsaleOrder();\n    }\n  },\n  watch: {\n    initsaleOrder() {\n      this.initialData();\n    },\n    $route: \"loadSingleData\",\n  },\n  created() {\n    this.loadTax();\n    this.loadSaleUnitItems();\n    // this.loadPrefix()\n    this.loadSegment();\n    this.loadLocation();\n    // localStorage.saleOrder = \"{name: 'abcssss'}\"\n  },\n  computed: {\n    appType() {\n      return dataStore.productType;\n    },\n    dateFormatted() {\n      return kendo.toString(new Date(), institute.dateFormat);\n    },\n    dateTimeFormatted() {\n      window.console.log(institute.dateFormat + \" HH:mm\", \"inst date\");\n      return kendo.toString(new Date(), institute.dateFormat + \" HH:mm\");\n    },\n    validCustomer() {\n      return this.customer.id !== undefined && this.customer.id !== null;\n    },\n    hiddenButton() {\n      if (this.$route.params.id) {\n        return true;\n      } else {\n        return false;\n      }\n    },\n    disabledMe() {\n      return !!this.$route.params.id;\n    },\n  },\n  mounted: async function () {\n    this.loadSingleData();\n    await this.requestData(0, this.filter, this.cusBaseUrl);\n    await this.supplierRequestData(0, this.filter, this.supBaseUrl);\n    await this.employeeRequestData(0, this.filter, this.empBaseUrl);\n  },\n};\n</script>\n\n<style scoped>\n.function_content .label {\n  margin-bottom: 10px;\n  display: inline-block;\n}\n.all_center {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n@media (min-width: 1264px) {\n  .container {\n    max-width: 1080px !important;\n  }\n}\n\n@media (max-width: 576px) {\n  .pt-6.col-sm-5.col-12 {\n    padding-top: 0 !important;\n  }\n\n  .code_text {\n    width: 100%;\n  }\n\n  .phone_no_pt {\n    padding-top: 0 !important;\n  }\n\n  .select_template,\n  .save_option {\n    margin-bottom: 10px;\n  }\n}\n</style>\n"]}]}