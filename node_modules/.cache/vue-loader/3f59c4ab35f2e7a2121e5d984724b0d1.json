{"remainingRequest":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/src/views/suppliers/CreditPurchases.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/src/views/suppliers/CreditPurchases.vue","mtime":1639966363975},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCi8vIGltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiCmltcG9ydCB7aTE4bn0gZnJvbSAiQC9pMThuIjsKaW1wb3J0IFB1cmNoYXNlTW9kZWwgZnJvbSAiQC9zY3JpcHRzL3B1cmNoYXNlL21vZGVsL1B1cmNoYXNlIjsKaW1wb3J0IEl0ZW1MaW5lTW9kZWwgZnJvbSAiQC9zY3JpcHRzL3B1cmNoYXNlL21vZGVsL0l0ZW1MaW5lIjsKaW1wb3J0IHt1dWlkfSBmcm9tICJ2dWUtdXVpZCI7CmltcG9ydCB7RHJvcERvd25MaXN0fSBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdnVlLWRyb3Bkb3ducyI7CmltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiOwppbXBvcnQgUHVyY2hhc2VGb3JtQ29udGVudE1vZGVsIGZyb20gIkAvc2NyaXB0cy9tb2RlbC9QdXJjaGFzZUZvcm1Db250ZW50IjsKaW1wb3J0IHtkYXRhU3RvcmUsIFNob3dSZXNvdXJjZX0gZnJvbSAiQC9vYnNlcnZhYmxlL3N0b3JlIjsKaW1wb3J0IHBheW1lbnRUZXJtSGFuZGxlcl8gZnJvbSAiQC9zY3JpcHRzL3BheW1lbnR0ZXJtL2hhbmRsZXIvcGF5bWVudFRlcm1IYW5kbGVyIjsKaW1wb3J0IGNyZWRpdExpbWl0SGFuZGxlciBmcm9tICJAL3NjcmlwdHMvY3JlZGl0TGltaXQvaGFuZGxlci9jcmVkaXRMaW1pdEhhbmRsZXIiOwppbXBvcnQgc2FsZU9yZGVySGFuZGxlciBmcm9tICJAL3NjcmlwdHMvdHJhbnNhY3Rpb25IYW5kbGVyIjsKaW1wb3J0IEhlbHBlciBmcm9tICJAL2hlbHBlciI7CmltcG9ydCBzZXR0aW5nc0hhbmRsZXIgZnJvbSAiQC9zY3JpcHRzL3NldHRpbmdzSGFuZGxlciI7Cgpjb25zdCBzdXBwbGllckhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc3VwcGxpZXJIYW5kbGVyIik7Ci8vIGltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiOwoKY29uc3QgcHJvamVjdEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcHJvamVjdEhhbmRsZXIiKTsKY29uc3QgcHJpY2VMZXZlbEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcHJpY2VMZXZlbEhhbmRsZXIiKTsKY29uc3QgY3VycmVuY3lIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2N1cnJlbmN5L2hhbmRsZXIvY3VycmVuY3lIYW5kbGVyIik7CgovLyBjb25zdCBzZXR0aW5nc0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2V0dGluZ3NIYW5kbGVyIik7CmNvbnN0IGVtcGxveWVlSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9lbXBsb3llZUhhbmRsZXIiKTsKY29uc3QgbG9jYXRpb25IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2xvY2F0aW9uSGFuZGxlciIpOwovLyBjb25zdCBwYXltZW50VGVybUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcGF5bWVudFRlcm1IYW5kbGVyIik7CmNvbnN0IGFjY291bnRIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2hhbmRsZXIvYWNjb3VudGluZy9hY2NvdW50Iik7CmNvbnN0IHByb2R1Y3RWYXJpYW50SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wcm9kdWN0VmFyaWFudEhhbmRsZXIiKTsKY29uc3QgdW9tUHJpY2VIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3VvbVByaWNlSGFuZGxlciIpOwpjb25zdCBkaXNjb3VudEl0ZW1IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2Rpc2NvdW50SXRlbUhhbmRsZXIiKTsKY29uc3Qgc2V0dGluZ0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2V0dGluZ0hhbmRsZXIiKTsKY29uc3Qgb3RoZXJDaGFyZ2VIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL290aGVyQ2hhcmdlSGFuZGxlciIpOwpjb25zdCBwdXJjaGFzZUZvcm1Db250ZW50SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wdXJjaGFzZUZvcm1Db250ZW50SGFuZGxlciIpOwpjb25zdCBwcmVmaXhIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3ByZWZpeEhhbmRsZXIiKTsKY29uc3QgYmlsbGluZ0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvaW52b2ljZS9oYW5kbGVyL2JpbGxpbmdIYW5kbGVyIik7Cgpjb25zdCBwdXJjaGFzZU1vZGVsID0gbmV3IFB1cmNoYXNlTW9kZWwoe30pOwpjb25zdCBpdGVtTGluZU1vZGVsID0gbmV3IEl0ZW1MaW5lTW9kZWwoe30pOwpjb25zdCBwdXJjaGFzZUZvcm1Db250ZW50TW9kZWwgPSBuZXcgUHVyY2hhc2VGb3JtQ29udGVudE1vZGVsKHt9KTsKY29uc3QgJCA9IGtlbmRvLmpRdWVyeQoKY29uc3QgdGV4dEZpZWxkID0gIm51bWJlck5hbWUiOwpjb25zdCBrZXlGaWVsZCA9ICJpZCI7CmNvbnN0IGRlZmF1bHRJdGVtID0ge1t0ZXh0RmllbGRdOiAiU2VsZWN0IHZlbmRvci4uLiIsIFtrZXlGaWVsZF06IG51bGx9Owpjb25zdCBlbXB0eUl0ZW0gPSB7W3RleHRGaWVsZF06ICJsb2FkaW5nIC4uLiJ9Owpjb25zdCBwYWdlU2l6ZSA9IDEwOwpjb25zdCBpdGVtTGluZVByZWZpeCA9ICJsaW4tIjsKY29uc3QgbG9hZGluZ0RhdGEgPSBbXTsKd2hpbGUgKGxvYWRpbmdEYXRhLmxlbmd0aCA8IHBhZ2VTaXplKSB7CiAgICBsb2FkaW5nRGF0YS5wdXNoKHsuLi5lbXB0eUl0ZW19KTsKfQpjb25zdCB7Q2xhc3NFZGl0b3J9ID0gcmVxdWlyZSgiQC9zY3JpcHRzL2tlbmRvX2VkaXRvci9Db2xsZWN0aW9ucyIpOwpjb25zdCBESVNDT1VOVF9UWVBFID0gIj90eXBlPVB1cmNoYXNlIjsKY29uc3QgVFJBTlNBQ1RJT05fVFlQRSA9ICJQdXJjaGFzZSI7CmNvbnN0IGNvb2tpZUpTID0gcmVxdWlyZSgiQC9jb29raWUuanMiKTsKY29uc3QgY29va2llID0gY29va2llSlMuZ2V0Q29va2llKCk7CmNvbnN0IE5BVFVSRSA9ICdwdXJjaGFzZScKZXhwb3J0IGRlZmF1bHQgewogICAgbmFtZTogIkNyZWRpdFB1cmNoYXNlIiwKICAgIHByb3BzOiBbImlkIiwgInRyYW5zYWN0aW9uRGF0ZSJdLAogICAgY29tcG9uZW50czogewogICAgICAgIExvYWRpbmdNZTogKCkgPT4gaW1wb3J0KGBAL2NvbXBvbmVudHMvTG9hZGluZ2ApLAogICAgICAgICJhcHAtZGF0ZXBpY2tlciI6ICgpID0+IGltcG9ydCgiQC9jb21wb25lbnRzL2N1c3RvbV90ZW1wbGF0ZXMvRGF0ZVBpY2tlckNvbXBvbmVudCIpLAogICAgICAgICJtb250aC1waWNrZXIiOiAoKSA9PiBpbXBvcnQoIkAvY29tcG9uZW50cy9jdXN0b21fdGVtcGxhdGVzL01vbnRoUGlja2VyIiksCiAgICAgICAgZHJvcGRvd25saXN0OiBEcm9wRG93bkxpc3QsCiAgICB9LAogICAgZGF0YTogKCkgPT4gKHsKICAgICAgICBpc0VkaXQ6IGZhbHNlLAogICAgICAgIHNob3dMb2FkaW5nVHhuOiBmYWxzZSwKICAgICAgICBzaG93TG9hZGluZ1R4bkFkZGl0aW9uYWxDb3N0OiBmYWxzZSwKICAgICAgICBtT3RoZXJDaGFyZ2U6IFtdLAogICAgICAgIG1PdGhlckNoYXJnZUFtb3VudDogW10sCiAgICAgICAgcHVyY2hhc2VPcmRlcnM6IFtdLAogICAgICAgIG51bVNlbGVjdDogWzFdLAogICAgICAgIGRpYWxvZ1RheDogZmFsc2UsCiAgICAgICAgdmVuZG9yTGlzdDogW10sCiAgICAgICAgc2hvd0xvYWRpbmc6IGZhbHNlLAogICAgICAgIGJpbGxfZGF0ZTogIiIsCiAgICAgICAgYWxlcnQ6IGZhbHNlLAogICAgICAgIGZpbGVzOiBbXSwKICAgICAgICAvLyBGb3JtIHZhbGlkYXRpb24KICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICBpdGVtTGluZXM6IFtdLAogICAgICAgIHR4bkRhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApLAogICAgICAgIGJpbGxEYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDAsIDEwKSwKICAgICAgICBpbnZvaWNlRGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCksCiAgICAgICAgbW9udGhPZjogIiIsCiAgICAgICAgdGVtcGxhdGVzOiBbCiAgICAgICAgICAgIHt0aXRsZTogIlB1cmNoYXNlIiwgdmFsdWU6ICJQdXJjaGFzZSJ9LAoKICAgICAgICBdLAogICAgICAgIGlzSGlkZUJhcjogZmFsc2UsCiAgICAgICAgdmVuZG9yOiB7fSwKICAgICAgICBkZWZhdWx0SXRlbTogZGVmYXVsdEl0ZW0sCiAgICAgICAgcHVyY2hhc2U6IHB1cmNoYXNlTW9kZWwsCiAgICAgICAgdHJhbnNhY3Rpb25UeXBlOiBbIkludm9pY2UiLCAiQ29tbWVyY2lhbCBJbnZvaWNlIiwgIlRheCBJbnZvaWNlIl0sCiAgICAgICAgY3VzQmFzZVVybDogc3VwcGxpZXJIYW5kbGVyLnNlYXJjaCgpLAogICAgICAgIGVtcEJhc2VVcmw6IGVtcGxveWVlSGFuZGxlci5zZWFyY2goKSwKICAgICAgICBpbml0OiB7bWV0aG9kOiAiR0VUIiwgYWNjZXB0OiAiYXBwbGljYXRpb24vanNvbiIsIGhlYWRlcnM6IFtdfSwKICAgICAgICBwZW5kaW5nUmVxdWVzdDogdW5kZWZpbmVkLAogICAgICAgIHJlcXVlc3RTdGFydGVkOiBmYWxzZSwKICAgICAgICBza2lwOiAwLAogICAgICAgIHRlbXBTa2lwOiBudWxsLAogICAgICAgIHRvdGFsOiAwLAogICAgICAgIGZpbHRlcjogIiIsCiAgICAgICAgcmVmZXJlbmNlTm86ICIiLAogICAgICAgIGZpbHRlcl86ICIiLAogICAgICAgIHRleHRGaWVsZDogIm51bWJlck5hbWUiLAogICAgICAgIGRhdGFJdGVtS2V5OiAiaWQiLAogICAgICAgIHNlZ21lbnRzOiBbXSwKICAgICAgICBlbXBsb3llZXM6IFtdLAogICAgICAgIG1ldGhvZHM6IFsnUXR5IEJhc2VkJywgJ0Ftb3VudCBCYXNlZCddLAogICAgICAgIG1FbXBsb3llZToge30sCiAgICAgICAgY3VzdG9tZXJQcm9qZWN0czogW10sCiAgICAgICAgYmlsbGluZ0FkZHJlc3M6IFtdLAogICAgICAgIGRlbGl2ZXJ5QWRkcmVzczogW10sCiAgICAgICAgZGVsaXZlcnlEYXRlVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCksCiAgICAgICAgcHJpY2VMZXZlbDogW10sCiAgICAgICAgbG9jYXRpb25zOiBbXSwKICAgICAgICBwYXltZW50VGVybXM6IFtdLAogICAgICAgIGFjY1BheWFibGU6IFtdLAogICAgICAgIGN1cnJlbmNpZXM6IFtdLAogICAgICAgIGl0ZW1MaW5lOiBpdGVtTGluZU1vZGVsLAogICAgICAgIHVvbXM6IFtdLAogICAgICAgIHRheDogW10sCiAgICAgICAgc3BlY2lmaWNEaXNjb3VudEl0ZW06IFtdLAogICAgICAgIG90aGVyQ2hhcmdlTGlzdDogW10sCiAgICAgICAgZGVwb3NpdEJhbGFuY2U6IDAsCiAgICAgICAgc2NoZW1hRGVmaW5pdGlvbjogewogICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgIH0sCiAgICAgICAgfSwKICAgICAgICBwdXJjaGFzZUZvcm1Db250ZW50OiBwdXJjaGFzZUZvcm1Db250ZW50TW9kZWwsCiAgICAgICAgQ2xhc3NFZGl0b3I6IENsYXNzRWRpdG9yLAogICAgICAgIHRheExpc3RUb3RhbDoge30sCiAgICAgICAgcHVyY2hhc2VUeXBlczogW10sCiAgICAgICAgdGF4TGlzdERldGFpbDogW10sCiAgICAgICAgc3VwcGxpZXJEaXNjb3VudEl0ZW06IFtdLAogICAgICAgIGxhdGVGZWVMaXN0OiBbXSwKICAgICAgICBsb2dnZWRVc2VyOiB7CiAgICAgICAgICAgIGlkOiBjb29raWUuY3JlYXRvciwKICAgICAgICAgICAgbmFtZTogY29va2llLmVtYWlsLAogICAgICAgIH0sCiAgICAgICAgZXhjaGFuZ2VSYXRlOiB7fSwKICAgICAgICBiYXNlQ3VycmVuY3lDb2RlOiAiIiwKICAgICAgICBjdXJyZW5jeUNvZGU6ICIiLAogICAgICAgIHRyYW5zYWN0aW9uUmF0ZTogMSwKICAgICAgICBqUmF3OiBbXSwKICAgICAgICByZWZGcm9tOiBbXSwKICAgICAgICBpc1ByaWNlTGV2ZWxDaGFuZ2VkOiBmYWxzZSwKICAgICAgICBleHBlbnNlczogW10sCiAgICAgICAgYWRkaXRpb25hbENvc3RUb3RhbDogMCwKICAgICAgICBjaGtDaGVja2VkOiBbXSwKICAgICAgICBhY2NXaXRoaG9sZGluZ0V4cGVuc2U6IFtdCiAgICB9KSwKICAgIG1ldGhvZHM6IHsKICAgICAgICBkYXRhQm91bmQ6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBrZW5kby5qUXVlcnkoIiNncmlkSXRlbUxpbmUiKS5kYXRhKCJrZW5kb0dyaWQiKTsKICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBlLnNlbmRlci5pdGVtcygpOwogICAgICAgICAgICBpZiAoZ3JpZCkgewogICAgICAgICAgICAgICAgaXRlbXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGFJdGVtID0gZ3JpZC5kYXRhSXRlbSh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAkKCJ0cltkYXRhLXVpZD0nIiArIGRhdGFJdGVtLnVpZCArICInXSIpLmZpbmQoJy5pc0VkaXRhYmxlJykKICAgICAgICAgICAgICAgICAgICAgICAgLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFJdGVtLmlzRWRpdGFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiay1zdGF0ZS1kaXNhYmxlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBvbk1ldGhvZENoYW5nZWQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSXRlbSgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUFkZGl0aW9uYWxDb3N0KCkKICAgICAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG9uQ2hlY2tDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0l0ZW0oKSkgewogICAgICAgICAgICAgICAgdGhpcy5hZGRpdGlvbmFsQ29zdFRvdGFsID0gMAogICAgICAgICAgICAgICAgdGhpcy5qUmF3ID0gW10KICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoa0NoZWNrZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoa0NoZWNrZWQuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHhBbW91bnQgPSBtLmV4Y2hhbmdlQW1vdW50IHx8IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkaXRpb25hbENvc3RUb3RhbCArPSBwYXJzZUZsb2F0KHhBbW91bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QgPSB0aGlzLmNoa0NoZWNrZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmFkZGl0aW9uYWxDb3N0VG90YWwgPSB0aGlzLmFkZGl0aW9uYWxDb3N0VG90YWwKICAgICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdE1ldGhvZCA9PT0gJ1F0eSBCYXNlZCcpIHsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5wZXJjZW50YWdlQXBwbGllZCgpCiAgICAgICAgICAgICAgICAgICAgLy8gfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5hbW91bnRBcHBsaWVkKCkKICAgICAgICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVBZGRpdGlvbmFsQ29zdCgpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgb25QcmljZUxldmVsQ2hhbmdlKCkgewogICAgICAgICAgICB0aGlzLmlzUHJpY2VMZXZlbENoYW5nZWQgPSB0cnVlCiAgICAgICAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9uUmF0ZSgpCiAgICAgICAgICAgIHRoaXMuY2xlYXJVT01JdGVtKCkKICAgICAgICB9LAogICAgICAgIGFzeW5jIGNsZWFyVU9NSXRlbSgpIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgZHMuZGF0YSgpLm1hcChuID0+IHsKICAgICAgICAgICAgICAgIG4uc2V0KCd1b20nLCB7fSkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5pc1ByaWNlTGV2ZWxDaGFuZ2VkID0gZmFsc2UKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQYXltZW50VGVybUxpc3QoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbmRvcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2lkPScgKyB0aGlzLnZlbmRvci5pZCArICcmdHJhbnNhY3Rpb25EYXRlPScgKyB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSArICcmdHlwZT1WZW5kb3InCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0gPSB7fQogICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50VGVybUhhbmRsZXJfLmdldChzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlcm1zID0gcmVzLmRhdGEuZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0gPSB0ZXJtcy50ZXJtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vblBheW1lbnRUZXJtQ2hhbmdlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkQ3JlZGl0TGltaXQoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbmRvcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2lkPScgKyB0aGlzLnZlbmRvci5pZCArICcmdHJhbnNhY3Rpb25EYXRlPScgKyB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSArICcmdHlwZT1WZW5kb3InCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuY3JlZGl0TGltaXQgPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWRpdExpbWl0SGFuZGxlci5nZXQoc3RyRmlsdGVyKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVkaXQgPSByZXMuZGF0YS5kYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5jcmVkaXRMaW1pdCA9IGtlbmRvLnBhcnNlRmxvYXQoY3JlZGl0LmFtb3VudCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIG9ic2VydmVyQ2xlYW4ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLnJlZHVjZSgKICAgICAgICAgICAgICAgIChyZXMsIGUpID0+IE9iamVjdC5hc3NpZ24ocmVzLCB7W2VdOiBvYmpbZV19KSwKICAgICAgICAgICAgICAgIHt9CiAgICAgICAgICAgICk7CiAgICAgICAgfSwKICAgICAgICBIZWxwKGtleV9zZWFyY2gpIHsKICAgICAgICAgICAgU2hvd1Jlc291cmNlKGtleV9zZWFyY2gpOwogICAgICAgIH0sCiAgICAgICAgQW1vdW50RWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IGRhdGEtYmluZD0idmFsdWU6JyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9OdW1lcmljVGV4dEJveCh7CiAgICAgICAgICAgICAgICAgICAgZGVjaW1hbHM6IDMwLAogICAgICAgICAgICAgICAgICAgIGZvcm1hdDogYCR7dGhpcy5wdXJjaGFzZUZvcm1Db250ZW50LmRlY2ltYWx9YCwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdmF0VGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgdmF0ID0gZGF0YUl0ZW0udmF0VGF4IHx8IHt9OwogICAgICAgICAgICBpZiAodmF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7dmF0LmRlZmF1bHRUYXggPyB2YXQuZGVmYXVsdFRheCA6IGBgfTwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGBgOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBpdGVtVGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgaXRlbSA9IGRhdGFJdGVtLml0ZW07CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7aXRlbS5uYW1lID8gaXRlbS5uYW1lIDogYGB9PC9zcGFuPmA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYGA7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFVPTVRlbXBsYXRlKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIGNvbnN0IHVvbSA9IGRhdGFJdGVtLnVvbSB8fCB7fTsKICAgICAgICAgICAgY29uc3QgY29kZSA9IHVvbS5jb2RlIHx8ICcnCiAgICAgICAgICAgIGlmICh1b20pIHsKICAgICAgICAgICAgICAgIHJldHVybiBgPHNwYW4+JHt1b20udW9tID8gY29kZSA6IGBgfTwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGBgOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkaXNjb3VudEl0ZW1UZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICAgICAgICBjb25zdCBkaXNjb3VudEl0ZW0gPSBkYXRhSXRlbS5kaXNjb3VudEl0ZW07CiAgICAgICAgICAgIGlmIChkaXNjb3VudEl0ZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBgPHNwYW4+JHtkaXNjb3VudEl0ZW0uY29kZSA/IGRpc2NvdW50SXRlbS5jb2RlIDogYGB9IC0gJHsKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudEl0ZW0ubmFtZSA/IGRpc2NvdW50SXRlbS5uYW1lIDogYGAKICAgICAgICAgICAgICAgIH08L3NwYW4+YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBgYDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWRkU2VsZWN0KCkgewogICAgICAgICAgICBsZXQgYW1vdW50X251bSA9IHRoaXMubnVtU2VsZWN0Lmxlbmd0aDsKICAgICAgICAgICAgbGV0IG51bSA9IHRoaXMubnVtU2VsZWN0W2Ftb3VudF9udW0gLSAxXTsKICAgICAgICAgICAgbGV0IG5ld19udW0gPSBudW0gKyAxOwogICAgICAgICAgICBsZXQgbGVuZ2h0SXRlbSA9IHRoaXMuc3BlY2lmaWNEaXNjb3VudEl0ZW0ubGVuZ3RoOwogICAgICAgICAgICBpZiAobmV3X251bSA8PSBsZW5naHRJdGVtKSB7CiAgICAgICAgICAgICAgICB0aGlzLm51bVNlbGVjdC5wdXNoKG5ld19udW0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZW1vdmVTZWxlY3QoaW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5udW1TZWxlY3Quc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGluZGV4LCB0aGlzLm51bVNlbGVjdCkKICAgICAgICAgICAgLy8gdGhpcy5zZWxlY3REaXNjb3VudC5zcGxpY2UoaW5kZXgsMSkKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCJyZW1vdmUiLHRoaXMuc2VsZWN0RGlzY291bnQpCiAgICAgICAgICAgIC8vIHRoaXMuc2VsZWN0RGlzY291bnQgPSB0aGlzLnNlbGVjdERpc2NvdW50LmZpbHRlcihpdGVtID0+ICBpdGVtLmlkICE9IHZhbC5pZCk7CiAgICAgICAgfSwKICAgICAgICBvbk90aGVyQ2hhcmdlQ2hhbmdlKCkgewogICAgICAgICAgICBsZXQgb3RoZXJDaGFyZ2UgPSAwOwogICAgICAgICAgICB0aGlzLm1PdGhlckNoYXJnZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSArPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudChtLCB0aGlzLnB1cmNoYXNlLnN1YlRvdGFsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uub3RoZXJDaGFyZ2VBbW91bnQgPSBvdGhlckNoYXJnZTsKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgfSwKICAgICAgICBvbk90aGVyQW1vdW50KHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCh2YWx1ZSwgdGhpcy5wdXJjaGFzZS5zdWJUb3RhbCk7CiAgICAgICAgfSwKICAgICAgICBvblNwZWNpZmljRGlzY291bnRDaGFuZ2VkKCkgewogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRUb3RhbCA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJy1jaGFuZ2VkJywgdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSkKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsID0KICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCgKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zdWJUb3RhbAogICAgICAgICAgICAgICAgICAgICkgfHwgMDsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UudG90YWwgPQogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS5zdWJUb3RhbCkgLQogICAgICAgICAgICAgICAgICAgIChrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UuZGlzY291bnRUb3RhbCkgKwogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudG90YWxUYXhBbW91bnQpKSAtCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlRGlzY291bnQoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudEl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3ViVG90YWwKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgIH0sCiAgICAgICAgZW1wSW1wbChkYXRhSXRlbSkgewogICAgICAgICAgICBsZXQgZW1wSWRzID0gW107CiAgICAgICAgICAgIGRhdGFJdGVtLmVtcGxveWVlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgIGVtcElkcy5wdXNoKG0uZmlyc3ROYW1lICsgIiAtICIgKyBtLmxhc3ROYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhlbXBJZHMuam9pbignLCAnKSkKICAgICAgICAgICAgcmV0dXJuIGA8c3Bhbj4ke2VtcElkcy5qb2luKCIsICIpfTwvc3Bhbj5gOwogICAgICAgIH0sCiAgICAgICAgdW9tVG1wKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhSXRlbSk7CiAgICAgICAgICAgIHJldHVybiBkYXRhSXRlbTsKICAgICAgICB9LAogICAgICAgIG9uSW52b2ljZVR5cGVDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSBudWxsIHx8IHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVOdW1iZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXV0b0NhbGN1bGF0ZVRheEJ5VHlwZSh0YXgpIHsKICAgICAgICAgICAgLy8gcmV0dXJuIGJ5IGEga2V5CiAgICAgICAgICAgIGNvbnN0IGdyb3VwQWxsID0gKGxpc3QpID0+CiAgICAgICAgICAgICAgICBsaXN0LnJlZHVjZSgodGF4LCBpdGVtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGF4QW1vdW50ID0gdGF4W2l0ZW0ubmFtZV0gfHwgMDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdGF4LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIFtpdGVtLm5hbWVdOiB0YXhBbW91bnQgKyBwYXJzZUZsb2F0KGl0ZW0uYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIHt9KTsKICAgICAgICAgICAgdGhpcy50YXhMaXN0VG90YWwgPSBncm91cEFsbCh0YXgpOwogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coIm5pbW9sIiwgZ3JvdXBBbGwodGF4KSk7CiAgICAgICAgfSwKICAgICAgICBvbkRlcG9zaXREZWR1Y3Rpb25DaGFuZ2UoKSB7CiAgICAgICAgICAgIGNvbnN0IGRlZHVjdCA9IHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uIHx8IDApCiAgICAgICAgICAgIGlmIChkZWR1Y3QgPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24gPSAwCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9PT0gIiIgfHwgdGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgZGVkdWN0aW9uID0gcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24pIHx8IDA7CiAgICAgICAgICAgIGlmIChkZWR1Y3Rpb24gPiB0aGlzLnB1cmNoYXNlLmRlcG9zaXRBbW91bnQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9IHRoaXMucHVyY2hhc2UuZGVwb3NpdEFtb3VudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBhdXRvQ2FsY3VsYXRlKCkgewogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICAgICAgICAgIHN1YlRvdGFsID0gMCwKICAgICAgICAgICAgICAgIHRvdGFsVGF4ID0gMCwKICAgICAgICAgICAgICAgIGRpc2NvdW50VG90YWwgPSAwLAogICAgICAgICAgICAgICAgc3BUYXggPSAwLAogICAgICAgICAgICAgICAgcGx0YXggPSAwLAogICAgICAgICAgICAgICAgb3RoZXJUYXggPSAwLAogICAgICAgICAgICAgICAgdmF0VGF4ID0gMCwKICAgICAgICAgICAgICAgIGRpc2NvdW50SW52b2ljZSA9IDAsCiAgICAgICAgICAgICAgICB0YXhMaXN0ID0gW10sCiAgICAgICAgICAgICAgICB0YXhMaXN0RGV0YWlsID0gW10sCiAgICAgICAgICAgICAgICBkaXNjb3VudEl0ZW0gPSBbXSwKICAgICAgICAgICAgICAgIGRpc2NvdW50TGluZSA9IFtdLAogICAgICAgICAgICAgICAgaW5jbHVzaXZlVGF4ID0gMCwKICAgICAgICAgICAgICAgIHRheFR5cGVJZCA9IDAsCiAgICAgICAgICAgICAgICB3aXRoaG9sZGluZ1RheEFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICB3aFRheEFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICBpdGVtU3VidG90YWwgPSAwLAogICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgPSAwLAogICAgICAgICAgICAgICAgc2VydmljZVN1YnRvdGFsID0gMCwKICAgICAgICAgICAgICAgIGl0ZW1EaXNjb3VudCA9IDAsCiAgICAgICAgICAgICAgICBzZXJ2aWNlRGlzY291bnQgPSAwLAogICAgICAgICAgICAgICAgdHhuRGlzY291bnQgPSAwOwogICAgICAgICAgICBsZXQgbmF0dXJlID0gIiI7CiAgICAgICAgICAgIHRoaXMualJhdyA9IFtdOwogICAgICAgICAgICBjb25zdCByb3dzID0gZHMuZGF0YSgpLmZpbHRlcigobSkgPT4gcGFyc2VGbG9hdChtLmFtb3VudCkgPiAwKTsKICAgICAgICAgICAgcm93cy5mb3JFYWNoKCh2YWx1ZSkgPT4gewogICAgICAgICAgICAgICAgbGV0IG1vZGlmaWVyUHJpY2UgPSAwLCBpbmNUYXggPSAwOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlLm1vZGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJQcmljZSA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUubW9kaWZpZXIucHJpY2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCBkaXNjb3VudCA9IDA7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuZGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzSXRlbUZpZWxkID0gdmFsdWUuZGlzY291bnRJdGVtOwogICAgICAgICAgICAgICAgICAgIGxldCBzdWJUbyA9CiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuY29zdCkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSk7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnQgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCh2YWx1ZS5kaXNjb3VudEl0ZW0sIHN1YlRvKTsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsiZGlzY291bnRBbW91bnQiXSA9IGRpc2NvdW50OwogICAgICAgICAgICAgICAgICAgIHZhbHVlWyJkaXNjb3VudEV4Y2hhbmdlQW1vdW50Il0gPQogICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUuZGlzY291bnRJdGVtLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvdW50SXRlbS5wdXNoKHZhbHVlLmRpc2NvdW50SXRlbSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50VG90YWwgKz0gZGlzY291bnQgPyBkaXNjb3VudCA6IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc2NvdW50ICogLTEgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc0l0ZW1GaWVsZC5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNJdGVtRmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkaXNJdGVtRmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJQdXJjaGFzZSBEaXNjb3VudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogZGlzSXRlbUZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkaXNJdGVtRmllbGQuYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGRpc2NvdW50ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogImRpc2NvdW50IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZhbHVlLnZhdFRheCkgewogICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnVmF0IFRheCcsIHZhbHVlLnRheCkKICAgICAgICAgICAgICAgICAgICBsZXQgYW10ID0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzcFRheCA/IHNwVGF4IDogMCkgKwogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHBsdGF4ID8gcGx0YXggOiAwKSArCiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXggPyBvdGhlclRheCA6IDApICsKICAgICAgICAgICAgICAgICAgICAgICAgKGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50ID8gdmFsdWUuYW1vdW50IDogMCkgLQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGRpc2NvdW50ID8gZGlzY291bnQgOiAwKSk7CiAgICAgICAgICAgICAgICAgICAgdmF0VGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KHZhbHVlLnZhdFRheCwgYW10KTsKICAgICAgICAgICAgICAgICAgICB2YXRUYXggPSBrZW5kby5wYXJzZUZsb2F0KHZhdFRheCkgPyBrZW5kby5wYXJzZUZsb2F0KHZhdFRheCkgOiAwOwogICAgICAgICAgICAgICAgICAgIHZhbHVlWyJ2YXRUYXhBbW91bnQiXSA9IHZhdFRheDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsidmF0VGF4RXhjaGFuZ2VBbW91bnQiXSA9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhdFRheCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS52YXRUYXggfHwge307CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZUFtb3VudCA9IHRheC5iYXNlQW1vdW50IHx8ICcnOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyh0YXgsICJpbSB0YXgiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jVGF4ID0gdmF0VGF4CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdXNpdmVUYXggKz0gdmF0VGF4OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWUudmF0VGF4LnRheFR5cGUubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdmF0VGF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZhbHVlLnZhdFRheC50YXhUeXBlLmlkLAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmF0VGF4XyA9IHZhbHVlLnZhdFRheCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWyd0YXhBbW91bnRfJ10gPSB2YXRUYXgKICAgICAgICAgICAgICAgICAgICAgICAgdmF0VGF4X1snYW1vdW50J10gPSB2YWx1ZS5hbW91bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWydkaXNjb3VudCddID0gZGlzY291bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWyd0eG5SYXRlJ10gPSB0aGlzLnB1cmNoYXNlLnR4blJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWydpc1ZhdCddID0gMQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfLmRldGFpbCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZmljVGF4OiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpY0xpZ2h0aW5nVGF4OiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyVGF4OiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0RGV0YWlsLnB1c2godmF0VGF4Xyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygndmF0XycsIHZhdFRheF8pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXhUeXBlID0gdmFsdWUudmF0VGF4LnRheFR5cGUgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgIHRheFR5cGVJZCA9IHRheFR5cGUudHlwZUlkIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxldCB0YXhBbW91bnQgPSB2YXRUYXg7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRheERlc2NyaXB0aW9uID0gIiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRheFR5cGVJZCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiZHIiOwogICAgICAgICAgICAgICAgICAgICAgICB0YXhBbW91bnQgPSB2YXRUYXg7CiAgICAgICAgICAgICAgICAgICAgICAgIHRheERlc2NyaXB0aW9uID0gIlB1cmNoYXNlIFRheCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXhUeXBlSWQgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGhvbGRpbmdUYXhBbW91bnQgKz0gdmF0VGF4OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGF4VHlwZUlkID09PSAyICYmIGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gJ25ldCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoVGF4QW1vdW50ICs9IHZhdFRheDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgICAgICB0YXhBbW91bnQgPSB2YXRUYXggKiAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4RGVzY3JpcHRpb24gPSAiV2l0aGhvbGRpbmcgVGF4IjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRheFR5cGVJZCA9PT0gMTApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4QW1vdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4RGVzY3JpcHRpb24gPSAiTm8gVGF4IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRheEFtb3VudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCB2YXRUYXhGaWVsZCA9IHZhbHVlLnZhdFRheCB8fCB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAodGF4QW1vdW50ICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YXRUYXhGaWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhdFRheEZpZWxkLmFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmF0VGF4RmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdmF0VGF4RmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0YXhEZXNjcmlwdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHZhdFRheEZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHZhdFRheEZpZWxkLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHRheEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRheEFtb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogInRheCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRvdGFsVGF4ICs9IGtlbmRvLnBhcnNlRmxvYXQoc3BUYXggPyBzcFRheCA6IDApICsga2VuZG8ucGFyc2VGbG9hdChwbHRheCA/IHBsdGF4IDogMCkgKwogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXggPyBvdGhlclRheCA6IDApICsKICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHZhdFRheCA/IHZhdFRheCA6IDApOwogICAgICAgICAgICAgICAgc3ViVG90YWwgKz0ga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpICsgbW9kaWZpZXJQcmljZSAtIGluY1RheDsKICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50KSArIG1vZGlmaWVyUHJpY2U7CiAgICAgICAgICAgICAgICBjb25zdCBhbXQgPSB0aGlzLmV4Y2x1ZGVWQVRUYXhJbmNsdXNpdmUodmFsdWUudmF0VGF4LCBhbW91bnQsIGluY1RheCkKICAgICAgICAgICAgICAgIC8vIGNvbnN0IHhBbW91bnQgPSAoa2VuZG8ucGFyc2VGbG9hdChhbXQpICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpKQogICAgICAgICAgICAgICAgY29uc3QgYWRkaXRjID0gdmFsdWUuYWRkaXRpb25hbENvc3QgfHwgMAogICAgICAgICAgICAgICAgY29uc3QgaXRlbUFtb3VudCA9IGFtdAogICAgICAgICAgICAgICAgY29uc3QgaXRlbVhBbW91bnQgPSBpdGVtQW1vdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB2YWx1ZS5pdGVtOwogICAgICAgICAgICAgICAgY29uc3QgaXRtVHlwZSA9IGl0ZW0udHlwZSB8fCAiIjsKICAgICAgICAgICAgICAgIGlmIChpdG1UeXBlID09PSAiVmFyaWFudCIpIHsKICAgICAgICAgICAgICAgICAgICBpdGVtU3VidG90YWwgKz0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5jb3N0KSAqIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucXR5KTsKICAgICAgICAgICAgICAgICAgICBpdGVtRGlzY291bnQgKz0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0bVR5cGUgPT09ICJTZXJ2aWNlIikgewogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VTdWJ0b3RhbCArPQogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLmNvc3QpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VEaXNjb3VudCArPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgKz0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5jb3N0KSAqIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucXR5KTsKICAgICAgICAgICAgICAgICAgICB0eG5EaXNjb3VudCArPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChhbXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0udHlwZSA9PT0gIlNlcnZpY2UiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBsYW4gPSBpdGVtLmlzUGFuIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGxhbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaGFzT3duUHJvcGVydHkoImRlZmVycmVkSW5jb21lQWNjIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5kZWZlcnJlZEluY29tZUFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVmZXJyZWRJbkFjYyA9IGl0ZW0uZGVmZXJyZWRJbmNvbWVBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkZWZlcnJlZEluQWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMucHVyY2hhc2Uuam91cm5hbE5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBkZWZlcnJlZEluQWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkZWZlcnJlZEluQWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBpdGVtQW1vdW50ICogLTEsIC8vIHF0eSphdmdfY29zdCAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogaXRlbVhBbW91bnQsIC8vLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJjb3N0T2ZHb29kc1NvbGRBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmNvc3RPZkdvb2RzU29sZEFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgY29zdE9mR29vZHNTb2xkQWNjID0gaXRlbS5jb3N0T2ZHb29kc1NvbGRBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBjb3N0T2ZHb29kc1NvbGRBY2MuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uY29zdE9mR29vZHNTb2xkQWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmNvc3RPZkdvb2RzU29sZEFjYy5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBpdGVtWEFtb3VudCwgLy94QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS50eXBlID09PSAiVmFyaWFudCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW1vdW50V2l0aEFkZGljdCA9IChpdGVtQW1vdW50ICsgKHZhbHVlLmFtb3VudEFwcGxpZWQgfHwgMCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnYWRkaXRjJywgYWRkaXRjLCAnLScsIGl0ZW1BbW91bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJpbnZlbnRvcnlBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaW52ZW50b3J5QWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGludmVudG9yeUFjYyA9IGl0ZW0uaW52ZW50b3J5QWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGludmVudG9yeUFjYy5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogaXRlbS5pbnZlbnRvcnlBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogaXRlbS5pbnZlbnRvcnlBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50V2l0aEFkZGljdCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGFtb3VudFdpdGhBZGRpY3QgKiAodGhpcy5wdXJjaGFzZS50eG5SYXRlIHx8IDEpLCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gIkZpeGVkIEFzc2V0IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5oYXNPd25Qcm9wZXJ0eSgiYXNzZXRBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uYXNzZXRBY2MuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzZXRBY2MgPSBpdGVtLmFzc2V0QWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGFzc2V0QWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLnB1cmNoYXNlLmpvdXJuYWxOb3RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmFzc2V0QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uYXNzZXRBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGl0ZW1YQW1vdW50LCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gIlRyYW5zYWN0aW9uIEl0ZW0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJhY2NvdW50IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpdGVtLmFjY291bnQuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMucHVyY2hhc2Uuam91cm5hbE5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGl0ZW1YQW1vdW50LCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL2luY2x1ZGUgVGF4IEFtb3VudAogICAgICAgICAgICAgICAgY29uc3QgYW1vdW50Tm9kaXNjb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuY29zdCkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSkgLSBkaXNjb3VudDsKICAgICAgICAgICAgICAgIGNvbnN0IGluY2x1ZGVUYXhBbW91bnQgPSBhbW91bnROb2Rpc2NvdW50ICsgdmF0VGF4ICsgcGx0YXggKyBzcFRheCArIG90aGVyVGF4OwogICAgICAgICAgICAgICAgdmFsdWVbImluY2x1ZGVUYXhBbW91bnQiXSA9IGluY2x1ZGVUYXhBbW91bnQ7CiAgICAgICAgICAgICAgICB2YWx1ZVsiaW5jbHVkZVRheEV4Y2hhbmdlQW1vdW50Il0gPSBpbmNsdWRlVGF4QW1vdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy90b2RvOiBXaXRoaG9sZGluZ1RheCBleHBlbnNlCiAgICAgICAgICAgIHRoaXMud2l0aGhvbGRpbmdFeHBlbnNlKHdoVGF4QW1vdW50LCB0aGlzLnB1cmNoYXNlLnR4blJhdGUgfHwgMSkKCiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuaXRlbVN1YnRvdGFsID0gaXRlbVN1YnRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmluY2x1c2l2ZVRheEFtb3VudCA9IGluY2x1c2l2ZVRheDsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5leGNoYW5nZUl0ZW1TdWJ0b3RhbCA9IGl0ZW1TdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKCiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc2VydmljZVN1YnRvdGFsID0gc2VydmljZVN1YnRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlU2VydmljZVN1YnRvdGFsID0KICAgICAgICAgICAgICAgIHNlcnZpY2VTdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50eG5JdG1TdWJ0b3RhbCA9IHR4bkl0bVN1YnRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlVHhuSXRtU3VidG90YWwgPQogICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudHhuUmF0ZSk7CgogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLml0ZW1EaXNjb3VudCA9IGl0ZW1EaXNjb3VudDsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5leGNoYW5nZUl0ZW1EaXNjb3VudCA9CiAgICAgICAgICAgICAgICBpdGVtRGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudHhuUmF0ZSk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc2VydmljZURpc2NvdW50ID0gc2VydmljZURpc2NvdW50OwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlU2VydmljZURpc2NvdW50ID0KICAgICAgICAgICAgICAgIHNlcnZpY2VEaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50eG5JdG1EaXNjb3VudCA9IHR4bkRpc2NvdW50OwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlVHhuSXRtRGlzY291bnQgPQogICAgICAgICAgICAgICAgdHhuRGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudHhuUmF0ZSk7CgogICAgICAgICAgICBsZXQgdG90YWwgPQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzdWJUb3RhbCkgLQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudFRvdGFsKSArCiAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRvdGFsVGF4KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zdWJUb3RhbCA9IHN1YlRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRvdGFsVGF4QW1vdW50ID0ga2VuZG8ucGFyc2VGbG9hdCh0b3RhbFRheCk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGlzY291bnRUb3RhbCA9IGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnRUb3RhbCk7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICBkaXNjb3VudEludm9pY2UgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCgKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtLAogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQoc3ViVG90YWwpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgZGlzY291bnRJbnZvaWNlID0gZGlzY291bnRJbnZvaWNlID8gZGlzY291bnRJbnZvaWNlIDogMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGlzLm9uT3RoZXJDaGFyZ2VDaGFuZ2UoKQogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRvdGFsID0ga2VuZG8ucGFyc2VGbG9hdCh0b3RhbCkgLSBkaXNjb3VudEludm9pY2UgKyBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2Uub3RoZXJDaGFyZ2VBbW91bnQpIC8vLSBwYXJzZUZsb2F0KHdpdGhob2xkaW5nVGF4QW1vdW50KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS53aXRoaG9sZGluZ1RheEFtb3VudCA9IHdpdGhob2xkaW5nVGF4QW1vdW50CiAgICAgICAgICAgIC8vIHRoaXMucHVyY2hhc2UudG90YWxBZnRlcldpdGhob2xkaW5nVGF4ID0ga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnRvdGFsKSAtIHBhcnNlRmxvYXQod2l0aGhvbGRpbmdUYXhBbW91bnQpOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnJlbWFpbmluZ0Ftb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50b3RhbCkgLSBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbikgLSBwYXJzZUZsb2F0KHdpdGhob2xkaW5nVGF4QW1vdW50KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5hbW91bnREdWUgPSBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudG90YWwpIC0ga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24pIC0gcGFyc2VGbG9hdCh3aXRoaG9sZGluZ1RheEFtb3VudCk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VBbW91bnQgPQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLmFtb3VudER1ZSkgKgogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ0V4Y2hhbmdlIEFtb3VudCcsIHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VBbW91bnQsIHRoaXMucHVyY2hhc2UuYW1vdW50RHVlKQogICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGVUYXhCeVR5cGUodGF4TGlzdCk7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVjaWZpY0Rpc2NvdW50ID0gdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSB8fCB7fTsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2NvdW50LmlkKSB7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnRJdGVtLnB1c2goc3BlY2lmaWNEaXNjb3VudCk7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnRMaW5lLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpZDogc3BlY2lmaWNEaXNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogc3BlY2lmaWNEaXNjb3VudC5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsICogdGhpcy5wdXJjaGFzZS50eG5SYXRlLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHVuaXF1ZURpc2NvdW50SXRlbSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKGRpc2NvdW50SXRlbSk7CiAgICAgICAgICAgIHRoaXMuc2hyaW5rRGlzY291bnRJdGVtKHVuaXF1ZURpc2NvdW50SXRlbSwgZGlzY291bnRMaW5lKTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdkaXNjb3VudCAnLCB0aGlzLmN1c3RvbWVyRGlzY291bnRJdGVtKQogICAgICAgICAgICAvLyB0b2RvOiByYXcgSm91cm5hbAogICAgICAgICAgICBjb25zdCBhcEFjYyA9IHRoaXMucHVyY2hhc2UuYXBBY2MgfHwge307CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmFtb3VudER1ZSAqIC0xID4gMCkgewogICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJjciI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFwQWNjKSB7CiAgICAgICAgICAgICAgICBpZiAoYXBBY2MuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBhcEFjYy5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwoe30pLAogICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogYXBBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogYXBBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlQW1vdW50ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5wdXJjaGFzZS5hbW91bnREdWUgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJhcCIsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3Qgc3BlY2lmaWNEaXNjID0gdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbTsKICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsICogLTEgPiAwKSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiZHIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coc3BlY2lmaWNEaXNjLCAnc3BlY2lmaWNEaXNjJywgdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwpCiAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2MpIHsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2MuaGFzT3duUHJvcGVydHkoImFjY291bnQiKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2MuYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHNwZWNpZmljRGlzYy5hY2NvdW50LmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHt9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIlB1cmNoYXNlIERpc2NvdW50IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBzcGVjaWZpY0Rpc2MuYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwZWNpZmljRGlzYy5hY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsKSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiZGlzY291bnQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24gKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVyY2hhc2VEZXBvc2l0QWNjID0gdGhpcy52ZW5kb3IucHVyY2hhc2VEZXBvc2l0QWNjIHx8IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChwdXJjaGFzZURlcG9zaXRBY2MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHB1cmNoYXNlRGVwb3NpdEFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBwdXJjaGFzZURlcG9zaXRBY2MuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJQdXJjaGFzZSBEZXBvc2l0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogcHVyY2hhc2VEZXBvc2l0QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogcHVyY2hhc2VEZXBvc2l0QWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlRGVwb3NpdERlZHVjdGlvbiAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogImRlcG9zaXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMubU90aGVyQ2hhcmdlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGxldCBvdGhlckNoYXJnZSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLm1PdGhlckNoYXJnZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2UgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudChtLCB0aGlzLnB1cmNoYXNlLnN1YlRvdGFsKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXJDaGFyZ2UgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uaGFzT3duUHJvcGVydHkoImFjY291bnQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY291bnQgPSBtLmFjY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJPdGhlciBDaGFyZ2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBhY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IG90aGVyQ2hhcmdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJvdGhlckNoYXJnZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gdGhpcy5wdXJjaGFzZS5vdGhlckNoYXJnZUFtb3VudCA9IG90aGVyQ2hhcmdlCiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2codGhpcy5tT3RoZXJDaGFyZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudGF4TGlzdERldGFpbCA9IHRheExpc3REZXRhaWwKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlVGF4RGV0YWlsKCkKICAgICAgICAgICAgLy8gdG9kbzogZW5kIHJhdyBKb3VybmFsCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh0aGlzLnB1cmNoYXNlKSwgJ3B1cmNoYXNlJykKCiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FsY3VsYXRlQWRkaXRpb25hbENvc3QoKQogICAgICAgICAgICAvLyB0b2RvOiBjb29rIGpvdXJuYWwKICAgICAgICAgICAgdGhpcy5zaHJpbmtEYXRhKHRoaXMualJhdyk7CiAgICAgICAgICAgIC8vIGNvbnN0IHVuaXF1ZSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKHRoaXMuYWNjb3VudHMpCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh1bmlxdWUsICd1bmlxdWUnKQogICAgICAgIH0sCiAgICAgICAgd2l0aGhvbGRpbmdFeHBlbnNlKGFtb3VudCwgdHhuUmF0ZSkgewogICAgICAgICAgICAvLyBpZiAodGhpcy5pc0l0ZW0oKSkgewogICAgICAgICAgICBpZiAoYW1vdW50ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgbmF0dXJlID0gJ2RyJwogICAgICAgICAgICAgICAgY29uc3QgYWNjb3VudCA9IHRoaXMuYWNjV2l0aGhvbGRpbmdFeHBlbnNlIHx8IFtdCiAgICAgICAgICAgICAgICBpZiAoYWNjb3VudC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWFjYyA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpYWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiV2l0aGhvbGRpbmcgVGF4IEV4cGVuc2UiLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpYWNjLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGlhY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBhbW91bnQgKiB0eG5SYXRlLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJXaXRoaG9sZGluZyIsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gfQogICAgICAgIH0sCiAgICAgICAgc2hyaW5rRGF0YShvYmopIHsKICAgICAgICAgICAgY29uc3QgdW5pcXVlcyA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKAogICAgICAgICAgICAgICAgb2JqCiAgICAgICAgICAgICk7IC8qWy4uLm5ldyBTZXQoYWNjb3VudElkLm1hcChpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgaWRfOiBpLmlkXywKICAgICAgICAgICAgICAgICAgICBpZDogaS5pZCwKICAgICAgICAgICAgICAgICAgICB0eXBlOiBpLnR5cGUKICAgICAgICAgICAgfSkpXSovCiAgICAgICAgICAgIHVuaXF1ZXMuZm9yRWFjaCgobikgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSBvYmouZmlsdGVyKChtKSA9PiBtLmlkID09PSBuLmlkKTsKICAgICAgICAgICAgICAgIGxldCBhbW91bnQgPSAwOwogICAgICAgICAgICAgICAgZm91bmQuZm9yRWFjaCgoeikgPT4gewogICAgICAgICAgICAgICAgICAgIGFtb3VudCArPSBwYXJzZUZsb2F0KHouYW1vdW50IHx8IDApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBuLmFtb3VudCA9IHBhcnNlRmxvYXQoYW1vdW50KTsgLy90aGlzLm51bWJlckZvcm1hdChhbW91bnQpCiAgICAgICAgICAgICAgICBuLmV4Y2hhbmdlQW1vdW50ID0gcGFyc2VGbG9hdCgKICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSkKICAgICAgICAgICAgICAgICk7IC8vdGhpcy5udW1iZXJGb3JtYXQoYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpKSAvLy50b0ZpeGVkKHRoaXMuc2FsZUZvcm1Db250ZW50LmRlY2ltYWwpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmpSYXcgPSB1bmlxdWVzOwogICAgICAgICAgICBsZXQgZHIgPSAwLAogICAgICAgICAgICAgICAgY3IgPSAwOwogICAgICAgICAgICB0aGlzLmpSYXcuZm9yRWFjaCgoaikgPT4gewogICAgICAgICAgICAgICAgc3dpdGNoIChqLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJjciI6CiAgICAgICAgICAgICAgICAgICAgICAgIGNyICs9IHBhcnNlRmxvYXQoai5leGNoYW5nZUFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgZHIgKz0gcGFyc2VGbG9hdChqLmV4Y2hhbmdlQW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRyID0gZHI7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuY3IgPSBjcjsKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJkcj0iLCBkciwgImNyPSIsIGNyLCAiZHIrY3IgPSAiLCBkciArIGNyKTsKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHVuaXF1ZXMpLCAndW5pcXVlcycpCiAgICAgICAgfSwKICAgICAgICBzaHJpbmtEaXNjb3VudEl0ZW0oZGlzY291bnRJdGVtLCBkaXNjb3VudExpbmUpIHsKICAgICAgICAgICAgbGV0IHVuaXF1ZURpc2NvdW50SXRlbXMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdW5pcXVlID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUoZGlzY291bnRJdGVtKTsKICAgICAgICAgICAgdW5pcXVlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gZGlzY291bnRMaW5lLmZpbHRlcigobikgPT4gbi5pZCA9PT0gbS5pZCk7CiAgICAgICAgICAgICAgICBsZXQgYW1vdW50ID0gMCwKICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICBmb3VuZC5tYXAoKG8pID0+IHsKICAgICAgICAgICAgICAgICAgICBhbW91bnQgKz0gby5hbW91bnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvdW5kLm1hcCgobykgPT4gewogICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50ICs9IG8uZXhjaGFuZ2VBbW91bnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHVuaXF1ZURpc2NvdW50SXRlbXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IG0uaWQsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbS5uYW1lLAogICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50LAogICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBleGNoYW5nZUFtb3VudCwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5zdXBwbGllckRpc2NvdW50SXRlbSA9IHVuaXF1ZURpc2NvdW50SXRlbXM7CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyh1bmlxdWVEaXNjb3VudEl0ZW1zLCAidW5pcXVlRGlzY291bnRJdGVtcyIpOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlRHVwbGljYXRlKGFycmF5KSB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICAgICAgICBjb25zdCBtYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBhcnJheSkgewogICAgICAgICAgICAgICAgaWYgKCFtYXAuaGFzKGl0ZW0uaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFwLnNldChpdGVtLmlkLCB0cnVlKTsgLy8gc2V0IGFueSB2YWx1ZSB0byBNYXAKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgbnVtYmVyRm9ybWF0KHZhbHVlKSB7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsLCduaW1vbCcpCiAgICAgICAgICAgIHJldHVybiBrZW5kby50b1N0cmluZyh2YWx1ZSwgYG4ke3RoaXMucHVyY2hhc2VGb3JtQ29udGVudC5kZWNpbWFsfWApOwogICAgICAgIH0sCiAgICAgICAgYXV0b0NhbGN1bGF0ZURpc2NvdW50KGRpc2NvdW50SXRlbSwgc3ViVG90YWwpIHsKICAgICAgICAgICAgaWYgKGRpc2NvdW50SXRlbSkgewogICAgICAgICAgICAgICAgY29uc3QgbmF0dXJlID0gZGlzY291bnRJdGVtLm5hdHVyZSB8fCAnJwogICAgICAgICAgICAgICAgY29uc3QgYW1vdW50ID0gZGlzY291bnRJdGVtLmFtb3VudCB8fCAwCiAgICAgICAgICAgICAgICBpZiAobmF0dXJlID09PSAnQW1vdW50JykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KGFtb3VudCkKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmF0dXJlID09PSAnUGVyY2VudGFnZScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHN1YlRvdGFsICogKHBhcnNlRmxvYXQoYW1vdW50KSAvIDEwMCkpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlVGF4KHRheCwgYW1vdW50KSB7CiAgICAgICAgICAgIGlmICh0YXgpIHsKICAgICAgICAgICAgICAgIHZhciBmb3JtdWxhID0gdGF4LmZvcm11bGE7CiAgICAgICAgICAgICAgICB2YXIgaW5BbXQgPSBrZW5kby5wYXJzZUZsb2F0KGFtb3VudCk7CiAgICAgICAgICAgICAgICB2YXIgbkFtdCA9IGtlbmRvLnBhcnNlRmxvYXQoYW1vdW50KTsKICAgICAgICAgICAgICAgIHZhciB0YXhCYXNlID0ga2VuZG8ucGFyc2VGbG9hdCh0YXgudGF4QmFzZSkgLyAxMDA7CiAgICAgICAgICAgICAgICB2YXIgcmF0ZSA9IGtlbmRvLnBhcnNlRmxvYXQodGF4LnJhdGUpIC8gMTAwOwogICAgICAgICAgICAgICAgdmFyIHRvdGFsID0gZXZhbChmb3JtdWxhKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhpbkFtdCwgbkFtdCwgdGF4QmFzZSwgcmF0ZSwgZm9ybXVsYSwgdG90YWwpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJldHVybiAwCiAgICAgICAgfSwKICAgICAgICB0YXhNYXBwaW5nKG9ialRheCwgdGF4KSB7CiAgICAgICAgICAgIGNvbnN0IHRheElkID0gdGF4LmlkIHx8ICcnCiAgICAgICAgICAgIGNvbnN0IHRheF8gPSBvYmpUYXguZmlsdGVyKHQgPT4gdC5pZCA9PT0gdGF4SWQpWzBdCiAgICAgICAgICAgIHJldHVybiB0YXhfIHx8IHsKICAgICAgICAgICAgICAgIGlkOiAnJywKICAgICAgICAgICAgICAgIGRlZmF1bHRUYXg6ICcnCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGRhdGFTb3VyY2VDaGFuZ2VkKGUpIHsKICAgICAgICAgICAgaWYgKGUuZmllbGQpIHsKICAgICAgICAgICAgICAgIGxldCBkYXRhUm93ID0gZS5pdGVtc1swXSwKICAgICAgICAgICAgICAgICAgICBidW9tID0ge30sIHZUYXggPSB7fSwKICAgICAgICAgICAgICAgICAgICBjb252ZXJzaW9uUmF0ZSA9IDEsCiAgICAgICAgICAgICAgICAgICAgd2FjID0gMCwKICAgICAgICAgICAgICAgICAgICBxb2ggPSAwLAogICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUuZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJpdGVtIjoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5hdHRyaWJ1dGVfID0gdGhpcy5hdHRyaWJ1dGVzLmZpbHRlcihtID0+IG0udHlwZS5pZCA9PT0gZGF0YVJvdy52YXJpYW50LmlkKQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZGVzY3JpcHRpb24iLCBkYXRhUm93Lml0ZW0uZGVzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBidW9tID0gZGF0YVJvdy5pdGVtLnVvbSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCBidW9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YVJvdy5zZXQoJ3VvbScsIGJ1b20pCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhUm93Lml0ZW0sJ3JvdycpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF3YWl0IHRoaXMuaW52ZW50b3J5QmFsYW5jZShkYXRhUm93LCBkYXRhUm93Lml0ZW0uaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImNvc3QiOgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpICogcGFyc2VGbG9hdChkYXRhUm93LnF0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4QW1vdW50ID0gYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJjb3N0IiwgcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3ByaWNlJyxkYXRhUm93LnByaWNlKQogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJjb3N0IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJ1b20iOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1ByaWNlTGV2ZWxDaGFuZ2VkID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVJvdy51b20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVvbSA9IGRhdGFSb3cudW9tLmJ1b20gfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHFvaCA9IGRhdGFSb3cudW9tLnFvaCB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzaW9uUmF0ZSA9IGRhdGFSb3cudW9tLmNvbnZlcnNpb25SYXRlIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhYyA9IGRhdGFSb3cudW9tLndhYyB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYnVvbSIsIGJ1b20pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgid2FjIiwgd2FjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInFvaCIsIHFvaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIHRvZG86IG1hcHBpbmcgdGF4IG9iamVjdCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2VGF4ID0gdGhpcy50YXhNYXBwaW5nKHRoaXMudGF4LCBkYXRhUm93LnVvbS5wdXJjaGFzZVRheCB8fCB7fSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJ2YXRUYXgiLCB2VGF4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgcGFyc2VGbG9hdChjb252ZXJzaW9uUmF0ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVJvdy51b20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChkYXRhUm93LnVvbS5jb3N0KSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiY29zdCIsIHBhcnNlRmxvYXQoZGF0YVJvdy51b20uY29zdCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCB4QW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IHBhcnNlRmxvYXQoZGF0YVJvdy5jb3N0KSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiY29zdCIsIHBhcnNlRmxvYXQoZGF0YVJvdy5jb3N0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgYW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJleGNoYW5nZUFtb3VudCIsIHhBbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJlcnJvciIsIGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvc3QiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicW9oIiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoIndhYyIsIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJxdHkiOgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpICogcGFyc2VGbG9hdChkYXRhUm93LnF0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4QW1vdW50ID0gYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJjb3N0IiwgcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvc3QiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJleGNoYW5nZUFtb3VudCIsIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm90aGVyVGF4IjoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCItLSIsIGRhdGFSb3cpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGUuZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGUoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2RhdGFSb3cnLCBkYXRhUm93KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBTZXJ2aWNlRGF0ZUVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCByZXF1aXJlZCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0RhdGVQaWNrZXIoKTsKCiAgICAgICAgICAgIC8vIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkcy5kYXRhKCkpCiAgICAgICAgICAgIC8vIC8vIGNvbnN0IGRhdGVTdHJpbmcgPSBrZW5kby50b1N0cmluZygobmV3IERhdGUob3B0aW9ucy5tb2RlbC5pdGVtcy5zZXJ2aWNlRGF0ZSkpLCB0aGlzLml0ZW1MaW5lLmRhdGVGb3JtYXQpCiAgICAgICAgICAgIC8vIC8vIGNvbnN0IGRhdGVTdHJpbmcgPSBrZW5kby50b1N0cmluZyhvcHRpb25zLm1vZGVsLml0ZW1zLnNlcnZpY2VEYXRlKQogICAgICAgICAgICAvLyBjb25zdCAkaW5wdXQgPSAkKCI8aW5wdXQgdmFsdWU9IiArIG9wdGlvbnMubW9kZWwuc2VydmljZURhdGUgKyAiIC8+IikuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgICAgICAvLyAkaW5wdXQua2VuZG9EYXRlUGlja2VyKCkKICAgICAgICAgICAgLy8gLy8gJGlucHV0LmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgLy8gLy8gb3B0aW9ucy5tb2RlbC5pdGVtcy5zZXJ2aWNlRGF0ZSA9IGRhdGVTdHJpbmcKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCRpbnB1dCkKICAgICAgICB9LAogICAgICAgIFNlcnZpY2VEYXRlVG9FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgcmVxdWlyZWQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9EYXRlUGlja2VyKCk7CiAgICAgICAgfSwKICAgICAgICBJdGVtRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPkl0ZW1zIDwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBwcm9kdWN0VmFyaWFudEhhbmRsZXIuaXRlbVNlYXJjaFVSTCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVtYTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNrdToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5jb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhdGE6IHRoaXMudmFyaWFudHMKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgVU9NRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAiY29kZSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJ1b21Db252ZXJ0SWQiLAogICAgICAgICAgICAgICAgICAgIGNhc2NhZGVGcm9tOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWNvZGUgfHwgYGAjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1b21QcmljZUhhbmRsZXIudW9tUHJpY2VCeVByaWNlTGV2ZWxVUkwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpZD0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC5pdGVtLmlkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZwbElkPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnByaWNlTGV2ZWwuaWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJmRhdGU9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHhuRGF0ZSArICImbmF0dXJlPXB1cmNoYXNlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDoge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2t1OiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YTogdGhpcy52YXJpYW50cwogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBEaXNjb3VudEl0ZW1Ecm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICBjYXNjYWRlRnJvbTogIml0ZW0iLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1jb2RlIyAtICM9bmFtZSM8L3NwYW4+IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyRmlsdGVyaW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGRpc2NvdW50SXRlbUhhbmRsZXIuZ2V0VVJMKERJU0NPVU5UX1RZUEUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVtYTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNrdToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5jb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIFZhdFRheERyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IG5hbWU9IicgKyBvcHRpb25zLmZpZWxkICsgJyIvPicpCiAgICAgICAgICAgICAgICAuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgICAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgICAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiAic3RhcnRzd2l0aCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogImRlZmF1bHRUYXgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1kZWZhdWx0VGF4Izwvc3Bhbj4iLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS1TZWxlY3QtLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMudGF4LAogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBFbXBsb3llZURyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IGRhdGEtYmluZD0idmFsdWU6JyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9NdWx0aVNlbGVjdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIHN1Z2dlc3Q6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiAiY29udGFpbnMiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICBoZWFkZXJUZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImRyb3Bkb3duLWhlYWRlciBrLXdpZGdldCBrLWhlYWRlciI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICI8c3Bhbj5FbXBsb3llZSA8L3NwYW4+IiArCiAgICAgICAgICAgICAgICAgICAgICAgICI8c3Bhbj48L3NwYW4+IiArCiAgICAgICAgICAgICAgICAgICAgICAgICI8L2Rpdj4iLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1uYW1lIzwvc3Bhbj4iLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJGaWx0ZXJpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcG9ydDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogZW1wbG95ZWVIYW5kbGVyLnNlYXJjaFVSTCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVtYTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByb3dOdW1iZXJUbXBsKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgICAgICAgICAgaW5kZXggPSBkcy5pbmRleE9mKGRhdGFJdGVtKTsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ICsgMTsKICAgICAgICB9LAogICAgICAgIGFkZFJvdygpIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCksCiAgICAgICAgICAgICAgICB0b3RhbCA9IGRzLnRvdGFsKCk7CiAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaWQgPSBpdGVtTGluZVByZWZpeCArIHV1aWQudjEoKTsKICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5kZWNpbWFsRm9ybWF0ID0gIm4iICsgdGhpcy5wdXJjaGFzZUZvcm1Db250ZW50LmRlY2ltYWw7CiAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaXNFZGl0YWJsZSA9IHRydWU7CiAgICAgICAgICAgIGRzLmluc2VydCh0b3RhbCwgdGhpcy5pdGVtTGluZSk7CgogICAgICAgICAgICAvLyBrZW5kby5qUXVlcnkoKS5hZGRDbGFzcygnZWRpdCcpCiAgICAgICAgICAgIC8vIHRoaXMuaXRlbUxpbmVzLnB1c2godGhpcy5pdGVtTGluZSkKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdpdGVtIExpbmUnLCB0aGlzLml0ZW1MaW5lKQogICAgICAgIH0sCiAgICAgICAgb25QYXltZW50VGVybUNoYW5nZWQoKSB7CiAgICAgICAgICAgIC8vIHRoaXMub25JbnZvaWNlRGF0ZUNoYW5nZWQoKTsKICAgICAgICAgICAgaWYgKHRoaXMudmVuZG9yKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYXltZW50VGVybSA9IHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0gfHwge30KICAgICAgICAgICAgICAgIGNvbnN0IG5ldER1ZSA9IHBheW1lbnRUZXJtLm5ldER1ZSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgc29tZURhdGUgPSBuZXcgRGF0ZSh0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSk7CiAgICAgICAgICAgICAgICBzb21lRGF0ZS5zZXREYXRlKHNvbWVEYXRlLmdldERhdGUoKSArIHBhcnNlSW50KG5ldER1ZSkpOyAvL251bWJlciAgb2YgZGF5cyB0byBhZGQsIGUueC4gMTUgZGF5cwogICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5kdWVEYXRlID0gc29tZURhdGU7CiAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coImltIiwgc29tZURhdGUsIG5ldER1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIG9uSW52b2ljZURhdGVDaGFuZ2VkKCkgewogICAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRQYXltZW50VGVybUxpc3QoKTsKICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ3JlZGl0TGltaXQoKTsKICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMudmVuZG9yLmlkKTsKICAgICAgICAgICAgYXdhaXQgdGhpcy5vblByaWNlTGV2ZWxDaGFuZ2UoKTsKCiAgICAgICAgICAgIHRoaXMubW9udGhPZiA9IGtlbmRvLnRvU3RyaW5nKG5ldyBEYXRlKHRoaXMudHhuRGF0ZSksICd5eXl5LU1NJykKICAgICAgICAgICAgLy8gaWYgKHRoaXMudmVuZG9yKSB7CiAgICAgICAgICAgIC8vICAgICBpZiAodGhpcy5wdXJjaGFzZS5oYXNPd25Qcm9wZXJ0eSgicGF5bWVudFRlcm0iKSkgewogICAgICAgICAgICAvLyAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnBheW1lbnRUZXJtLmhhc093blByb3BlcnR5KCJuZXREdWUiKSkgewogICAgICAgICAgICAvLyAgICAgICAgICAgICBjb25zdCBuZXREdWUgPSB0aGlzLnB1cmNoYXNlLnBheW1lbnRUZXJtLm5ldER1ZTsKICAgICAgICAgICAgLy8gICAgICAgICAgICAgY29uc3Qgc29tZURhdGUgPSBuZXcgRGF0ZSh0aGlzLnR4bkRhdGUpOwogICAgICAgICAgICAvLyAgICAgICAgICAgICBzb21lRGF0ZS5zZXREYXRlKHNvbWVEYXRlLmdldERhdGUoKSArIHBhcnNlSW50KG5ldER1ZSkpOyAvL251bWJlciAgb2YgZGF5cyB0byBhZGQsIGUueC4gMTUgZGF5cwogICAgICAgICAgICAvLyAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmR1ZURhdGUgPSBzb21lRGF0ZS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCk7CiAgICAgICAgICAgIC8vICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnaW0nLCBzb21lRGF0ZSwgbmV0RHVlKQogICAgICAgICAgICAvLyAgICAgICAgIH0KICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgLy8gfQogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVOdW1iZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmxvYWRUcmFuc2FjdGlvblJhdGUoKTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQcmVmaXgoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHByZWZpeEhhbmRsZXIuZ2V0KCJwdXJjaGFzZSIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlVHlwZXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2VUeXBlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUgPSB0aGlzLnB1cmNoYXNlVHlwZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVOdW1iZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkUHJpY2VMZXZlbCgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0gJz8mbmF0dXJlPScgKyBOQVRVUkUKICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsSGFuZGxlci5nZXQoc3RyRmlsdGVyKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmljZUxldmVsID0gcmVzOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wcmljZUxldmVsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucHJpY2VMZXZlbCA9IHRoaXMucHJpY2VMZXZlbFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWREaXNjb3VudEl0ZW0oKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50SXRlbUhhbmRsZXIubGlzdChESVNDT1VOVF9UWVBFKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGVjaWZpY0Rpc2NvdW50SXRlbSA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkT3RoZXJDaGFyZ2UoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIG90aGVyQ2hhcmdlSGFuZGxlci5saXN0KCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3RoZXJDaGFyZ2VMaXN0ID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRBY2NvdW50KCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SGFuZGxlci5nZXRBbGwoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAvL1JlY2VpdmFibGUgQWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY1BheWFibGUgPSByZXMuZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigobSkgPT4gbS5hY2NvdW50X3R5cGUubnVtYmVyID09PSAxOCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKGl0bSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpdG0udXVpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZDogaXRtLnV1aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGl0bS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9uYW1lOiBpdG0ubG9jYWxfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiBpdG0ubnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc190YXhhYmxlOiBpdG0uaXNfdGF4YWJsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuaGppQWNjQ29kZTogaXRtLmJhbmhqaUFjY0NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwX2NvZGU6IGl0bS5ncm91cF9jb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRfYWNjb3VudDogaXRtLnBhcmVudF9hY2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlX2NvZGU6IGl0bS50eXBlX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfdHlwZTogaXRtLmFjY291bnRfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjY1BheWFibGUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5hcEFjYyA9IHRoaXMuYWNjUGF5YWJsZVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY1dpdGhob2xkaW5nRXhwZW5zZSA9IHJlcy5kYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChtKSA9PiBwYXJzZUludChtLmJhbmhqaUFjY0NvZGUpID09PSA4NDMwMDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKChpdG0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRtLnV1aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWQ6IGl0bS51dWlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBpdG0ubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxfbmFtZTogaXRtLmxvY2FsX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogaXRtLm51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfdGF4YWJsZTogaXRtLmlzX3RheGFibGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbmhqaUFjY0NvZGU6IGl0bS5iYW5oamlBY2NDb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cF9jb2RlOiBpdG0uZ3JvdXBfY29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50X2FjY291bnQ6IGl0bS5wYXJlbnRfYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZV9jb2RlOiBpdG0udHlwZV9jb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X3R5cGU6IGl0bS5hY2NvdW50X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQYXltZW50VGVybSgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0gIj90eXBlPXBtdC1zdXBwbGllciI7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXltZW50VGVybXMgPSBbXQogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzSGFuZGxlci5nZXRQYXltZW50VGVybShzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGF5bWVudFRlcm1zID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGF5bWVudFRlcm1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0gPSB0aGlzLnBheW1lbnRUZXJtc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRMb2NhdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSBbXQogICAgICAgICAgICBjb25zdCByb2xlVHlwZSA9IGRhdGFTdG9yZS5yb2xlVHlwZSB8fCAwCiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDAnLCBkYXRhU3RvcmUpCiAgICAgICAgICAgIGlmIChyb2xlVHlwZSA9PT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGRhdGFTdG9yZS5yb2xlRGF0YSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvbGVEYXRhID0gZGF0YVN0b3JlLnJvbGVEYXRhIHx8IFtdCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb24gPSByb2xlRGF0YS5maWx0ZXIoaXRtID0+IGl0bS50eXBlID09PSAnbG9jYXRpb24nKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uRGVmYXVsdCA9IGxvY2F0aW9uLmZpbHRlcihtID0+IG0uaXNEZWZhdWx0ID09PSAxKQogICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYXRpb25zID0gbG9jYXRpb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQgfHwgdGhpcy4kcm91dGUucGFyYW1zLmlkID09PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9jYXRpb25EZWZhdWx0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UubG9jYXRpb24gPSBsb2NhdGlvbkRlZmF1bHRbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9sZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYXRpb25zID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uSGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmxpc3QoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFByb2plY3RCeUN1c3RvbWVyKCkgewogICAgICAgICAgICB0aGlzLmN1c3RvbWVyUHJvamVjdHMgPSBbXQogICAgICAgICAgICBjb25zdCByb2xlVHlwZSA9IGRhdGFTdG9yZS5yb2xlVHlwZSB8fCAwCiAgICAgICAgICAgIGlmIChyb2xlVHlwZSA9PT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGRhdGFTdG9yZS5yb2xlRGF0YSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvbGVEYXRhID0gZGF0YVN0b3JlLnJvbGVEYXRhIHx8IFtdCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdCA9IHJvbGVEYXRhLmZpbHRlcihpdG0gPT4gaXRtLnR5cGUgPT09ICdwcm9qZWN0JykKICAgICAgICAgICAgICAgICAgICB0aGlzLmN1c3RvbWVyUHJvamVjdHMgPSBwcm9qZWN0CiAgICAgICAgICAgICAgICAgICAgLy8gcHJvamVjdC5mb3JFYWNoKGsgPT4gewogICAgICAgICAgICAgICAgICAgIC8vICAgICBjb25zdCBjdXN0b21lcnMgPSBrLmN1c3RvbWVycyB8fCBbXQogICAgICAgICAgICAgICAgICAgIC8vICAgICBjb25zdCBwcm9DdXN0b21lciA9IGN1c3RvbWVycy5maWx0ZXIobiA9PiBuLmN1c3RvbWVyLmlkID09PSB0aGlzLmN1c3RvbWVyLmlkKQogICAgICAgICAgICAgICAgICAgIC8vICAgICBpZiAocHJvQ3VzdG9tZXIubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgdGhpcy5jdXN0b21lclByb2plY3RzLnB1c2goaykKICAgICAgICAgICAgICAgICAgICAvLyAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdERlZmF1bHQgPSB0aGlzLmN1c3RvbWVyUHJvamVjdHMuZmlsdGVyKG0gPT4gbS5pc0RlZmF1bHQgPT09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0RGVmYXVsdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnByb2plY3QgPSBwcm9qZWN0RGVmYXVsdFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmVuZG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9qZWN0SGFuZGxlci5nZXRCeVN1cHBsaWVyKHRoaXMudmVuZG9yLmlkKS50aGVuKHJlcyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9qZWN0SGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5saXN0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5jdXN0b21lclByb2plY3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB0aGlzLnB1cmNoYXNlLnByb2plY3QgPSB0aGlzLmN1c3RvbWVyUHJvamVjdHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRDdXN0b21lckJhbGFuY2UoaWQpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0gaWQgKyAiP3R5cGU9YmFsIjsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmN1cnJlbnRCYWxhbmNlID0gMDsKICAgICAgICAgICAgICAgICAgICBiaWxsaW5nSGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAuYmFsYW5jZShzdHJGaWx0ZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuY3VycmVudEJhbGFuY2UgPSBkYXRhWzBdLmJhbGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZEN1c3RvbWVyRGVwb3NpdEJhbGFuY2UoaWQpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0gaWQgKyAiP3R5cGU9ZGVwIjsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRlcG9zaXRBbW91bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9IDA7CiAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgLmJhbGFuY2Uoc3RyRmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbW91bnREZXBvc2l0ID0gZGF0YVswXS5iYWxhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coYW1vdW50RGVwb3NpdCwgImJhbGEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5kZXBvc2l0QW1vdW50ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudERlcG9zaXQgLyB0aGlzLnB1cmNoYXNlLnR4blJhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgY3JlZGl0TGltaXRVc2FnZShiYWxhbmNlLCBjcmVkaXRMaW1pdCkgewogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAga2VuZG8udG9TdHJpbmcoCiAgICAgICAgICAgICAgICAgICAgKGJhbGFuY2UgLyBjcmVkaXRMaW1pdCkgKiAxMDAsCiAgICAgICAgICAgICAgICAgICAgYG4ke3RoaXMucHVyY2hhc2VGb3JtQ29udGVudC5kZWNpbWFsfWAKICAgICAgICAgICAgICAgICkgKyAiICUiCiAgICAgICAgICAgICk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkRW1wbG95ZWVDZW50ZXIoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZW1wbG95ZWVzID0gW107CiAgICAgICAgICAgICAgICAgICAgZW1wbG95ZWVIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgIC5jZW50ZXIodW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbXBsb3llZXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVtcGxveWVlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZW1wbG95ZWUgPSB0aGlzLmVtcGxveWVlc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgpOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkU2VnbWVudCgpIHsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IFtdCiAgICAgICAgICAgIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDAKICAgICAgICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVN0b3JlLnJvbGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW10KICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWdtZW50ID0gcm9sZURhdGEuZmlsdGVyKGl0bSA9PiBpdG0udHlwZSA9PT0gJ3NlZ21lbnQnKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlZ21lbnREZWZhdWx0ID0gc2VnbWVudC5maWx0ZXIobSA9PiBtLmlzRGVmYXVsdCA9PT0gMSkKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gc2VnbWVudAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCB8fCB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWdtZW50RGVmYXVsdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnNlZ21lbnQgPSBzZWdtZW50RGVmYXVsdFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnZGF0YVN0b3JlLS1zZWdtZW50RGVmYXVsdCcsIHNlZ21lbnREZWZhdWx0KQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzSGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFNlZygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVGF4KCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBzZXR0aW5nSGFuZGxlci5nZXQoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGF4ZXMgPSByZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGF4ID0gdGF4ZXMuZmlsdGVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0pID0+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0udGF4VHlwZS50eXBlSWQgPT09IDEgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS50YXhUeXBlLnR5cGVJZCA9PT0gMTAgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS50YXhUeXBlLnR5cGVJZCA9PT0gMikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRyYW5zYWN0aW9uVHlwZSA9PT0gIlB1cmNoYXNlIgogICAgICAgICAgICAgICAgICAgICAgICApOyAvLyB2YWx1YWJsZSB0YXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBvblNhdmVDbG9zZShzYXZlU2VuZCkgewogICAgICAgICAgICBpZiAoIXRoaXMuJHJlZnMuZm9ybS52YWxpZGF0ZSgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRyZWZzLmZvcm0udmFsaWRhdGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy50cmFuc2FjdGlvblJhdGUgPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoaTE4bi50KCJzZXRfZXhjaGFuZ2VfcmF0ZSIpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGlkID0gIiI7CiAgICAgICAgICAgIGlmICh0aGlzLnZlbmRvci5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgaWQgPSB0aGlzLnZlbmRvci5pZCB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaWQgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRzbm90aWZ5LmVycm9yKCJ2ZW5kb3IgaXMgcmVxdWlyZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS5iaWxsTm8gPT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoIlZlbmRvciBJbnZvaWNlIE5vIGlzIHJlcXVpcmVkIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLiRyZWZzLmZvcm0udmFsaWRhdGUoKSkgewogICAgICAgICAgICAgICAgdGhpcy4kcmVmcy5mb3JtLnZhbGlkYXRlKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCk7CiAgICAgICAgICAgIGxldCBkMSA9IGRzLmRhdGEoKTsKICAgICAgICAgICAgbGV0IGRhdGFWYWxpZGF0ZSA9IDA7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgICAgICBkMS5mb3JFYWNoKCh2YWx1ZSwgaW5kZXgpID0+IHsKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICB2YWx1ZS5pdGVtID09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICAgICAgICAgIHZhbHVlLml0ZW0uaWQgPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUuaXRlbS5pZCA9PSBudWxsIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUudW9tID09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICAgICAgICAgIHZhbHVlLnVvbS51b20uaWQgPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUudW9tLnVvbS5pZCA9PSBudWxsCiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRzbm90aWZ5LmVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAiUGxlYXNlIGNoZWNrIEl0ZW0gb3IgVU9NICBvbiByb3cgIiArIChpbmRleCArIDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YVZhbGlkYXRlICs9IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoZDEubGVuZ3RoID09IGRhdGFWYWxpZGF0ZSkgewogICAgICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGlzQXV0b0dlbmVyYXRlID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGUgPSBuZXcgRGF0ZSh0aGlzLnR4bkRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVJbnZvaWNlID0gbmV3IERhdGUodGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvbkRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVNID0gdHJhbkRhdGUuZ2V0RnVsbFllYXIoKSArIHRyYW5EYXRlLmdldE1vbnRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZUludm9pY2VNID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuRGF0ZUludm9pY2UuZ2V0RnVsbFllYXIoKSArIHRyYW5EYXRlSW52b2ljZS5nZXRNb250aCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5EYXRlTSA9PT0gdHJhbkRhdGVJbnZvaWNlTSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzQXV0b0dlbmVyYXRlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGl0ZW1MaW5lRFMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YVJvdyA9IGl0ZW1MaW5lRFMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5kYXRhKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKG8pID0+IG8uYW1vdW50ID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKG4pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEl0ZW1MaW5lTW9kZWwobik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFSb3cubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHRoaXMucHVyY2hhc2UuaWQgPyB0aGlzLnB1cmNoYXNlLmlkIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZDogdGhpcy5wdXJjaGFzZS51dWlkID8gdGhpcy5wdXJjaGFzZS51dWlkIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgam91cm5hbF91dWlkOiB0aGlzLnB1cmNoYXNlLmpvdXJuYWxfdXVpZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMucHVyY2hhc2Uuam91cm5hbF91dWlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalJhdzogdGhpcy5qUmF3LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRSQU5TQUNUSU9OX1RZUEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiB0aGlzLnB1cmNoYXNlLm51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYmJyOiB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZS5hYmJyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uRGF0ZTogdGhpcy50eG5EYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uRGF0ZVRaOiBIZWxwZXIudG9JU09EYXRlKHRoaXMudHhuRGF0ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVlRGF0ZTogdGhpcy5wdXJjaGFzZS5kdWVEYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbnRoT2Y6IHRoaXMubW9udGhPZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50Q29kZTogdGhpcy5wdXJjaGFzZS5wYXltZW50Q29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaWxsTm86IHRoaXMucHVyY2hhc2UuYmlsbE5vLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbGxEYXRlOiB0aGlzLmJpbGxEYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBsaWVyOiB0aGlzLnB1cmNoYXNlLnN1cHBsaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uVHlwZTogdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF5bWVudFRlcm06IHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY291bnRQcm9tb3Rpb246IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwQWNjOiB0aGlzLnB1cmNoYXNlLmFwQWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbmN5OiB0aGlzLnB1cmNoYXNlLmN1cnJlbmN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4blJhdGU6IHRoaXMucHVyY2hhc2UudHhuUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlUmF0ZTogdGhpcy5wdXJjaGFzZS5leGNoYW5nZVJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbDogdGhpcy5wdXJjaGFzZS5wcmljZUxldmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1MaW5lczogZGF0YVJvdywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50OiB0aGlzLnB1cmNoYXNlLnNlZ21lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IHRoaXMucHVyY2hhc2UubG9jYXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvamVjdDogdGhpcy5wdXJjaGFzZS5wcm9qZWN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtcGxveWVlOiB0aGlzLnB1cmNoYXNlLmVtcGxveWVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbGxpbmdBZGRyZXNzOiB0aGlzLnB1cmNoYXNlLmJpbGxpbmdBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGl2ZXJ5QWRkcmVzczogdGhpcy5wdXJjaGFzZS5kZWxpdmVyeUFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsaXZlcnlEYXRlVGltZTogdGhpcy5wdXJjaGFzZS5kZWxpdmVyeURhdGVUaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uTm90ZTogdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvbk5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgam91cm5hbE5vdGU6IHRoaXMucHVyY2hhc2Uuam91cm5hbE5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViVG90YWw6IHRoaXMucHVyY2hhc2Uuc3ViVG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IHRoaXMucHVyY2hhc2UudG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY291bnRUb3RhbDogdGhpcy5wdXJjaGFzZS5kaXNjb3VudFRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlRGlzY291bnRUb3RhbDogKHRoaXMucHVyY2hhc2UuZGlzY291bnRUb3RhbCkgKiAodGhpcy5wdXJjaGFzZS50eG5SYXRlIHx8IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZmljRGlzY291bnRUb3RhbDogdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsaXZlcnlGZWU6IHRoaXMucHVyY2hhc2UuZGVsaXZlcnlGZWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxUYXhBbW91bnQ6IHRoaXMucHVyY2hhc2UudG90YWxUYXhBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwb3NpdEFtb3VudDogdGhpcy5wdXJjaGFzZS5kZXBvc2l0QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlcG9zaXREZWR1Y3Rpb246IHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdBbW91bnQ6IHRoaXMucHVyY2hhc2UucmVtYWluaW5nQW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudER1ZTogdGhpcy5wdXJjaGFzZS5hbW91bnREdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEJhbGFuY2U6IHRoaXMucHVyY2hhc2UuY3VycmVudEJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogdGhpcy5wdXJjaGFzZS5iYWxhbmNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWRpdExpbWl0OiB0aGlzLnB1cmNoYXNlLmNyZWRpdExpbWl0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVPcHRpb246IHRoaXMucHVyY2hhc2Uuc2F2ZU9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwcm92ZWRCeTogdGhpcy5wdXJjaGFzZS5hcHByb3ZlZEJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1UZW1wbGF0ZToge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNEaXNjb3VudEl0ZW06IHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudEl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2U6IHRoaXMubU90aGVyQ2hhcmdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyQ2hhcmdlQW1vdW50OiB0aGlzLnB1cmNoYXNlLm90aGVyQ2hhcmdlQW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRheExpc3RUb3RhbDogdGhpcy50YXhMaXN0VG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcGxpZXJEaXNjb3VudEl0ZW06IHRoaXMuc3VwcGxpZXJEaXNjb3VudEl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZEF0OiB0aGlzLnB1cmNoYXNlLmNyZWF0ZWRBdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtU3VidG90YWw6IHRoaXMucHVyY2hhc2UuaXRlbVN1YnRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlSXRlbVN1YnRvdGFsOiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlSXRlbVN1YnRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VTdWJ0b3RhbDogdGhpcy5wdXJjaGFzZS5zZXJ2aWNlU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VTZXJ2aWNlU3VidG90YWw6IHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VTZXJ2aWNlU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWw6IHRoaXMucHVyY2hhc2UudHhuSXRtU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VUeG5JdG1TdWJ0b3RhbDogdGhpcy5wdXJjaGFzZS5leGNoYW5nZVR4bkl0bVN1YnRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1EaXNjb3VudDogdGhpcy5wdXJjaGFzZS5pdGVtRGlzY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VJdGVtRGlzY291bnQ6IHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VJdGVtRGlzY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZURpc2NvdW50OiB0aGlzLnB1cmNoYXNlLnNlcnZpY2VEaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZVNlcnZpY2VEaXNjb3VudDogdGhpcy5wdXJjaGFzZS5leGNoYW5nZVNlcnZpY2VEaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eG5JdG1EaXNjb3VudDogdGhpcy5wdXJjaGFzZS50eG5JdG1EaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZVR4bkl0bURpc2NvdW50OiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlVHhuSXRtRGlzY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGhvbGRpbmdUYXhBbW91bnQ6IHRoaXMucHVyY2hhc2Uud2l0aGhvbGRpbmdUYXhBbW91bnQgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdXNpdmVUYXhBbW91bnQ6IHRoaXMucHVyY2hhc2UuaW5jbHVzaXZlVGF4QW1vdW50IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VkVXNlcjogdGhpcy5sb2dnZWRVc2VyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVTZW5kOiBzYXZlU2VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZGcm9tOiB0aGlzLnB1cmNoYXNlLnJlZkZyb20gfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmVG86IHRoaXMucHVyY2hhc2UucmVmVG8gfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FsZVRheERldGFpbDogdGhpcy5wdXJjaGFzZS5zYWxlVGF4RGV0YWlsIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0FkZGl0aW9uYWxDb3N0OiB0aGlzLnB1cmNoYXNlLmFkZGl0aW9uYWxDb3N0Lmxlbmd0aCA+IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbENvc3Q6IHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbENvc3RNZXRob2Q6IHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3RNZXRob2QgfHwgJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbENvc3RUb3RhbDogdGhpcy5hZGRpdGlvbmFsQ29zdFRvdGFsIHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNBdXRvR2VuZXJhdGU6IGlzQXV0b0dlbmVyYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvblR5cGU6IHRoaXMuJHJvdXRlLnBhcmFtcy5pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMuJHJvdXRlLnF1ZXJ5LnR5cGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAibmV3IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucXVlcnkudHlwZSA9PT0gInJlY3VycmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmlkID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbGxpbmdIYW5kbGVyLmNyZWF0ZVB1cmNoYXNlKGRhdGEpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY2xvc2UocmVzcG9uc2UuZGF0YS5kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLiRyZWZzLmZvcm0ucmVzZXQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuc3VjY2VzcygiU3VjY2Vzc2Z1bGx5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzYXZlU2VuZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKHJlc3BvbnNlLmRhdGEuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRzbm90aWZ5LmVycm9yKCJTb21ldGhpbmcgd2VudCB3cm9uZyIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JzLnB1c2goZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkUHVyY2hhc2VGb3JtQ29udGVudCgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgcHVyY2hhc2VGb3JtQ29udGVudEhhbmRsZXIubGlzdCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlRm9ybUNvbnRlbnQgPSBkYXRhWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaW1hbEZvcm1hdCA9ICJuIiArIHRoaXMucHVyY2hhc2VGb3JtQ29udGVudC5kZWNpbWFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdERhdGEoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGNsb3NlKGRhdGEpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogIlZlbmRvcnMiLAogICAgICAgICAgICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LmdvKC0xKTsKICAgICAgICAgICAgICAgIC8vIHRoaXMuJHJvdXRlci5wdXNoKHsKICAgICAgICAgICAgICAgIC8vICAgICBwYXRoOiAiaW52b2ljZV92aWV3IiwKICAgICAgICAgICAgICAgIC8vICAgICBuYW1lOiAiSW52b2ljZSBWaWV3IiwKICAgICAgICAgICAgICAgIC8vICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhLCAnZGF0YScpCiAgICAgICAgfSwKICAgICAgICBzYXZlTmV3KCkgewogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlUm93KGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCBncmlkID0ga2VuZG8ualF1ZXJ5KCIjZ3JpZEl0ZW1MaW5lIikuZGF0YSgia2VuZG9HcmlkIiksCiAgICAgICAgICAgICAgICBkYXRhU291cmNlID0gZ3JpZC5kYXRhU291cmNlLAogICAgICAgICAgICAgICAgZGF0YUl0ZW0gPSBncmlkLmRhdGFJdGVtKCQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCJ0ciIpKTsKCiAgICAgICAgICAgIGlmIChkYXRhU291cmNlLnRvdGFsKCkgPiAxKSB7CiAgICAgICAgICAgICAgICBkYXRhU291cmNlLnJlbW92ZShkYXRhSXRlbSk7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2VuZXJhdGVOdW1iZXIoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlID0gbmV3IERhdGUodGhpcy50eG5EYXRlKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlSW52b2ljZSA9IG5ldyBEYXRlKHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25EYXRlKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlTSA9IHRyYW5EYXRlLmdldEZ1bGxZZWFyKCkgKyB0cmFuRGF0ZS5nZXRNb250aCgpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVJbnZvaWNlTSA9CiAgICAgICAgICAgICAgICAgICAgdHJhbkRhdGVJbnZvaWNlLmdldEZ1bGxZZWFyKCkgKyB0cmFuRGF0ZUludm9pY2UuZ2V0TW9udGgoKTsKICAgICAgICAgICAgICAgIGlmICh0cmFuRGF0ZU0gPT09IHRyYW5EYXRlSW52b2ljZU0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnJlZmVyZW5jZU5vID0gdGhpcy5yZWZlcmVuY2VObzsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnR4bkRhdGUgIT09ICIiICYmIHRoaXMucHVyY2hhc2VUeXBlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICBhYmJyOiB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZS5hYmJyLAogICAgICAgICAgICAgICAgICAgIHN0cnVjdHVyZTogdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUuc3RydWN0dXJlLAogICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uRGF0ZTogdGhpcy50eG5EYXRlLAogICAgICAgICAgICAgICAgICAgIHNlcXVjZW5jaW5nOiB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZS5zZXF1Y2VuY2luZywKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiUHVyY2hhc2UiLAogICAgICAgICAgICAgICAgICAgIGVudGl0eTogMSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBiaWxsaW5nSGFuZGxlcgogICAgICAgICAgICAgICAgICAgIC5sYXN0TnVtYmVyKGRhdGEpCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzID0gcmVzcG9uc2UuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdE51bWJlciA9IHRoaXMuemVyb1BhZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZUludChyZXMubGFzdE51bWJlciksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUuZm9ybWF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnVtYmVyID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuc3VmZml4ICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZS5udW1iZXJTZXBhcmF0b3IgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3ROdW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLm51bWJlciA9IG51bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JzLnB1c2goZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHplcm9QYWQobnVtLCBwbGFjZXMpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhudW0pLnBhZFN0YXJ0KHBsYWNlcywgIjAiKTsKICAgICAgICB9LAogICAgICAgIHN1ZmZpeCh0cmFuc2FjdGlvbkRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGtlbmRvLnRvU3RyaW5nKG5ldyBEYXRlKHRyYW5zYWN0aW9uRGF0ZSksIGB5eW1tYCk7CiAgICAgICAgfSwKICAgICAgICBlcnJvck1lc3NhZ2UoKSB7CiAgICAgICAgfSwKICAgICAgICBhY2NvdW50RHJvcERvd25FZGl0b3IoKSB7CiAgICAgICAgfSwKICAgICAgICBjYW5jZWwoKSB7CiAgICAgICAgICAgIHRoaXMuJHN3YWwoewogICAgICAgICAgICAgICAgdGl0bGU6IGkxOG4udCgibXNnX3RpdGxlX3dhcm5pbmciKSwKICAgICAgICAgICAgICAgIHRleHQ6IGkxOG4udCgibXNnX2Rpc2NhcmQiKSwKICAgICAgICAgICAgICAgIGljb246ICJ3YXJuaW5nIiwKICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IHRydWUsCiAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBpMThuLnQoImNhbmNlbCIpLAogICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiAiIzRkNDg0OCIsCiAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25Db2xvcjogIiNFRDFBM0EiLAogICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6IGkxOG4udCgiZGlzY2FyZCIpLAogICAgICAgICAgICB9KS50aGVuKChyZXN1bHRDZW4pID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhyZXN1bHRDZW4pOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdENlbi52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGRlc3Ryb3koKQogICAgICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlci5nbygtMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgaGlkZVNtYWxsU2lkZWJhcigpIHsKICAgICAgICAgICAgdGhpcy5pc0hpZGVCYXIgPSAhdGhpcy5pc0hpZGVCYXI7CiAgICAgICAgfSwKICAgICAgICByZXF1ZXN0RGF0YShza2lwLCBmaWx0ZXIsIGJhc2VVcmwpIHsKICAgICAgICAgICAgY29uc3QgdXJsID0gYmFzZVVybCArIGA/ZmlsdGVyPSR7ZmlsdGVyfWA7CiAgICAgICAgICAgIHRoaXMucmVxdWVzdFN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBmZXRjaCh1cmwpCiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKHRoaXMuYWZ0ZXJGZXRjaCk7CiAgICAgICAgfSwKICAgICAgICByZXF1ZXN0RGF0YV8oc2tpcCwgZmlsdGVyLCBiYXNlVXJsKSB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IGJhc2VVcmwgKyBgLyR7ZmlsdGVyfWA7CiAgICAgICAgICAgIHRoaXMucmVxdWVzdFN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBmZXRjaCh1cmwpCiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKHRoaXMuYWZ0ZXJGZXRjaF8pOwogICAgICAgIH0sCiAgICAgICAgb25DaGFuZ2UoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBldmVudC52YWx1ZTsKICAgICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlW3RleHRGaWVsZF0gPT09IGVtcHR5SXRlbVt0ZXh0RmllbGRdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy52ZW5kb3IgPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zdXBwbGllciA9IHZhbHVlOwogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2codGhpcy5wdXJjaGFzZS5jdXN0b21lciwgJ0NoYW5nZWQnKQogICAgICAgICAgICAvLyB0aGlzLmludm9pY2UgPSB2YWx1ZQogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmFwQWNjID0gdmFsdWUuaGFzT3duUHJvcGVydHkoImFwQWNjIikgPyB2YWx1ZS5hcEFjYyA6IHt9OwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnBheW1lbnRUZXJtID0gdmFsdWUucGF5bWVudFRlcm0gfHwge307CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucHJpY2VMZXZlbCA9IHZhbHVlLnByaWNlTGV2ZWwgfHwge307CiAgICAgICAgICAgIGNvbnN0IGJhc2VDdXJyZW5jeSA9IHZhbHVlLmJhc2VDdXJyZW5jeSB8fCB7fTsKICAgICAgICAgICAgaWYgKGJhc2VDdXJyZW5jeS5oYXNPd25Qcm9wZXJ0eSgiY29kZSIpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2VDdXJyZW5jeUNvZGUgPSAiICIgKyBiYXNlQ3VycmVuY3kuY29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGlzLmxvYWRUcmFuc2FjdGlvblJhdGUoKTsKICAgICAgICAgICAgdGhpcy5iaWxsaW5nQWRkcmVzcyA9IHZhbHVlLmhhc093blByb3BlcnR5KCJiaWxsaW5nQWRkcmVzcyIpCiAgICAgICAgICAgICAgICA/IHZhbHVlLmJpbGxpbmdBZGRyZXNzCiAgICAgICAgICAgICAgICA6IFtdOwogICAgICAgICAgICB0aGlzLmRlbGl2ZXJ5QWRkcmVzcyA9IHZhbHVlLmhhc093blByb3BlcnR5KCJkZWxpdmVyeUFkZHJlc3MiKQogICAgICAgICAgICAgICAgPyB2YWx1ZS5kZWxpdmVyeUFkZHJlc3MKICAgICAgICAgICAgICAgIDogW107CiAgICAgICAgICAgIGlmICh0aGlzLmJpbGxpbmdBZGRyZXNzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuYmlsbGluZ0FkZHJlc3MgPSB0aGlzLmJpbGxpbmdBZGRyZXNzWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmRlbGl2ZXJ5QWRkcmVzcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRlbGl2ZXJ5QWRkcmVzcyA9IHRoaXMuZGVsaXZlcnlBZGRyZXNzWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXhwZW5zZXMgPSBbXQogICAgICAgICAgICB0aGlzLm9uSW52b2ljZURhdGVDaGFuZ2VkKCk7CiAgICAgICAgICAgIHRoaXMubG9hZFByb2plY3RCeUN1c3RvbWVyKCkKICAgICAgICAgICAgLy8gdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMudmVuZG9yLmlkKTsKICAgICAgICAgICAgLy8gY29uc3QgY3JlZGl0TGltaXQgPSB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgiY3JlZGl0TGltaXQiKQogICAgICAgICAgICAvLyAgICAgPyB2YWx1ZS5jcmVkaXRMaW1pdAogICAgICAgICAgICAvLyAgICAgOiAwOwogICAgICAgICAgICAvLyB0aGlzLnB1cmNoYXNlLmNyZWRpdExpbWl0ID0ga2VuZG8ucGFyc2VGbG9hdChjcmVkaXRMaW1pdCk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh2YWx1ZSwgJ3ZhbHVlJykKICAgICAgICB9LAogICAgICAgIG9uRW1wbG95ZWVDaGFuZ2VkKGV2ZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVt0ZXh0RmllbGRdID09PSBlbXB0eUl0ZW1bdGV4dEZpZWxkXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubUVtcGxveWVlID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZW1wbG95ZWUgPSB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIGFmdGVyRmV0Y2goanNvbikgewogICAgICAgICAgICB0aGlzLnZlbmRvckxpc3QgPSBqc29uLmRhdGE7CiAgICAgICAgfSwKICAgICAgICBhZnRlckZldGNoXyhqc29uKSB7CiAgICAgICAgICAgIHRoaXMuZW1wbG95ZWVzID0ganNvbi5kYXRhOwogICAgICAgIH0sCiAgICAgICAgb25GaWx0ZXJDaGFuZ2UoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgZmlsdGVyID0gZXZlbnQuZmlsdGVyLnZhbHVlOwogICAgICAgICAgICB0aGlzLnJlcXVlc3REYXRhKDAsIGZpbHRlciwgdGhpcy5jdXNCYXNlVXJsKTsKICAgICAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7CiAgICAgICAgfSwKICAgICAgICBvbkVtcGxveWVlRmlsdGVyQ2hhbmdlZChldmVudCkgewogICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBldmVudC5maWx0ZXIudmFsdWU7CiAgICAgICAgICAgIHRoaXMucmVxdWVzdERhdGFfKDAsIGZpbHRlciwgdGhpcy5lbXBCYXNlVXJsKTsKICAgICAgICAgICAgdGhpcy5maWx0ZXJfID0gZmlsdGVyOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgaW5pdERhdGEoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkVmlld0NyZWRpdFB1cmNoYXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCkKICAgICAgICAgICAgICAgIC8vIHRoaXMuYWRkUm93KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRWaWV3Q3JlZGl0UHVyY2hhc2UoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52aWV3UHVyY2hhc2UodGhpcy4kcm91dGUucGFyYW1zLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlID0gcmVzLmRhdGEuZGF0YVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZlcmVuY2VObyA9IHRoaXMucHVyY2hhc2UucmVmZXJlbmNlTm87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHhuRGF0ZSA9IG5ldyBEYXRlKHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25EYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZW5kb3IgPSB0aGlzLnB1cmNoYXNlLnN1cHBsaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1FbXBsb3llZSA9IHRoaXMucHVyY2hhc2UuZW1wbG95ZWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGF4TGlzdFRvdGFsID0gdGhpcy5wdXJjaGFzZS50YXhMaXN0VG90YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmVzID0gdGhpcy5wdXJjaGFzZS5pdGVtTGluZXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubU90aGVyQ2hhcmdlID0gdGhpcy5wdXJjaGFzZS5vdGhlckNoYXJnZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBwbGllckRpc2NvdW50SXRlbSA9IHRoaXMucHVyY2hhc2Uuc3VwcGxpZXJEaXNjb3VudEl0ZW0gfHwgW10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3ID0gdGhpcy5wdXJjaGFzZS5qUmF3IHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4cGVuc2VzID0gdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdCB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRpdGlvbmFsQ29zdFRvdGFsID0gdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdFRvdGFsIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2VPcmRlcnMgPSB0aGlzLnB1cmNoYXNlLnJlZkZyb20gfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9udGhPZiA9IGtlbmRvLnRvU3RyaW5nKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUodGhpcy5wdXJjaGFzZS5tb250aE9mKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ5eXl5LU1NIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubU90aGVyQ2hhcmdlLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRTZWxlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmljZUxldmVsID0gdGhpcy5wdXJjaGFzZS5wcmljZUxldmVsIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbmN5ID0gcHJpY2VMZXZlbC5jdXJyZW5jeSB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJDb2RlID0gY3VycmVuY3kuY29kZSB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbmN5Q29kZSA9IGN1ckNvZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMubG9hZFByb2plY3RCeUN1c3RvbWVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmVuZG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52ZW5kb3IuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRDdXN0b21lckJhbGFuY2UodGhpcy52ZW5kb3IuaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5xdWVyeS50eXBlID09PSAicmVjdXJyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eSgidHJhbnNhY3Rpb25EYXRlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coInR5cGUiLCB0aGlzLiRyb3V0ZS5wYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25EYXRlID0gbmV3IERhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy50cmFuc2FjdGlvbkRhdGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHhuRGF0ZSA9IG5ldyBEYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMudHJhbnNhY3Rpb25EYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uSW52b2ljZURhdGVDaGFuZ2VkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgpOwogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIC8vIHRoaXMubG9hZEFjY291bnQoKQogICAgICAgICAgICB0aGlzLmxvYWRQcmljZUxldmVsKCkKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCk7CiAgICAgICAgICAgIGRzLmRhdGEoW10pOwogICAgICAgICAgICB0aGlzLmlkID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLnZlbmRvciA9IHt9CiAgICAgICAgICAgIHRoaXMubUVtcGxveWVlID0ge30KICAgICAgICAgICAgdGhpcy5tT3RoZXJDaGFyZ2UgPSB7fQogICAgICAgICAgICB0aGlzLnB1cmNoYXNlT3JkZXJzID0gW10KICAgICAgICAgICAgdGhpcy5wdXJjaGFzZSA9IG5ldyBQdXJjaGFzZU1vZGVsKHt9KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUgPSB0aGlzLnB1cmNoYXNlVHlwZXNbMF07CiAgICAgICAgICAgIHRoaXMubW9udGhPZiA9IGtlbmRvLnRvU3RyaW5nKG5ldyBEYXRlKHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25EYXRlKSwgJ3l5eXktTU0nKQogICAgICAgICAgICB0aGlzLmFkZFJvdygpOwogICAgICAgICAgICB0aGlzLmdlbmVyYXRlTnVtYmVyKCk7CiAgICAgICAgICAgIHRoaXMubG9hZFNlZ21lbnQoKTsKICAgICAgICAgICAgdGhpcy5sb2FkTG9jYXRpb24oKTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRUcmFuc2FjdGlvblJhdGUoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh0aGlzLnR4bkRhdGUpLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDAsIDEwKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmljZUxldmVsID0gdGhpcy5wdXJjaGFzZS5wcmljZUxldmVsOwogICAgICAgICAgICAgICAgICAgIGxldCBjb2RlID0gIiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaWNlTGV2ZWwuaGFzT3duUHJvcGVydHkoImN1cnJlbmN5IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByaWNlTGV2ZWwuY3VycmVuY3kuaGFzT3duUHJvcGVydHkoImNvZGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IHByaWNlTGV2ZWwuY3VycmVuY3kuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY29kZSAhPT0gdW5kZWZpbmVkIHx8IGNvZGUgIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW5jeUhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRMYXN0RXhjaGFuZ2VSYXRlQnlEYXRlKGRhdGUsIGNvZGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhjaGFuZ2VSYXRlID0gcmVzLmRhdGEuZGF0YVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW5jeUNvZGUgPSB0aGlzLmV4Y2hhbmdlUmF0ZS5jb2RlIHx8ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uUmF0ZSA9IHRoaXMuZXhjaGFuZ2VSYXRlLnJhdGUgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50eG5SYXRlID0gdGhpcy5leGNoYW5nZVJhdGUucmF0ZSB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlUmF0ZSA9IHRoaXMuZXhjaGFuZ2VSYXRlIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFuc2FjdGlvblJhdGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoaTE4bi50KCJzZXRfZXhjaGFuZ2VfcmF0ZSIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZEN1c3RvbWVyRGVwb3NpdEJhbGFuY2UodGhpcy52ZW5kb3IuaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRQdXJjaGFzZU9yZGVyKCk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgcmVsb2FkKCkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZFZpZXdDcmVkaXRQdXJjaGFzZSgpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFB1cmNoYXNlT3JkZXIoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGxldCBzZWdtZW50SWQgPSAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25JZCA9ICcnLAogICAgICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsSWQgPSAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJJZCA9ICIiLAogICAgICAgICAgICAgICAgICAgICAgICB0eG5EYXRlID0gIiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2Uuc2VnbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50SWQgPSB0aGlzLnB1cmNoYXNlLnNlZ21lbnQuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmxvY2F0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uSWQgPSB0aGlzLnB1cmNoYXNlLmxvY2F0aW9uLmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS5zdXBwbGllcikgewogICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21lcklkID0gdGhpcy5wdXJjaGFzZS5zdXBwbGllci5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UucHJpY2VMZXZlbCkgewogICAgICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsSWQgPSB0aGlzLnB1cmNoYXNlLnByaWNlTGV2ZWwuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0eG5EYXRlID0gdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvbkRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxldCBzdHJGaWx0ZXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRJZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJJZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25JZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbElkICE9PSAiIiAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eG5EYXRlICE9PSAiIgogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJGaWx0ZXIgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIj9pZD0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZzZWdJZD0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRJZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJmxvY0lkPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25JZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJnBsSWQ9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsSWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZkYXRlPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZSArICcmdHlwZT1QdXJjaGFzZSBPcmRlcicKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ckZpbHRlciAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5yZWZGcm9tID0gW10KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ1R4biA9IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgc2FsZU9yZGVySGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zYWN0aW9uRmlsdGVyKHN0ckZpbHRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmdUeG4gPSBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlT3JkZXJzID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuID0gZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0RXhwZW5zZUJ5U3VwcGxpZXIoKQogICAgICAgIH0sCiAgICAgICAgYWRkUHVyY2hhc2VPcmRlcihpdGVtKSB7CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpdGVtTGluZSA9IGl0ZW0uaXRlbUxpbmVzIHx8IFtdOwogICAgICAgICAgICAgICAgdGhpcy5yZWZGcm9tLnB1c2goewogICAgICAgICAgICAgICAgICAgIGlkOiBpdGVtLmlkIHx8ICcnLAogICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZTogaXRlbS5yZWZlcmVuY2VObyB8fCAnJwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgICAgICAgICAgICAgIHRvdGFsID0gZHMudG90YWwoKTsKICAgICAgICAgICAgICAgIGl0ZW1MaW5lLmZvckVhY2goKG8pID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lID0gbmV3IEl0ZW1MaW5lTW9kZWwobyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5pZCA9IGl0ZW1MaW5lUHJlZml4ICsgdXVpZC52MSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuZGVjaW1hbEZvcm1hdCA9ICJuIiArIHRoaXMucHVyY2hhc2VGb3JtQ29udGVudC5kZWNpbWFsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuc291cmNlVHJhbnNhY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpdGVtLmlkLAogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VObzogaXRlbS5yZWZlcmVuY2VObywKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuc291cmNlVHJhbnNhY3Rpb25SZWYgPSBpdGVtLnJlZmVyZW5jZU5vOwogICAgICAgICAgICAgICAgICAgIGRzLmluc2VydCh0b3RhbCwgdGhpcy5pdGVtTGluZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUgPSBuZXcgSXRlbUxpbmVNb2RlbCh7fSk7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5wdXJjaGFzZU9yZGVycy5maW5kSW5kZXgoKGl0bSkgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLmlkID09PSBpdG0uaWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2VPcmRlcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucmVmRnJvbSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKHRoaXMucmVmRnJvbSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdG90YWxRdHkoKSB7CiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgIGxldCBxdHkgPSAwCiAgICAgICAgICAgIGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpdG0gPSBtLml0ZW0gfHwge30KICAgICAgICAgICAgICAgIGNvbnN0IHVvbSA9IG0udW9tIHx8IHt9CiAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgIHF0eSArPSAobS5xdHkgfHwgMCkgKiAobS5jb252ZXJzaW9uUmF0ZSB8fCAxKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ3F0eScsIHF0eSkKICAgICAgICAgICAgcmV0dXJuIHF0eQogICAgICAgIH0sCiAgICAgICAgZXhjbHVkZVZBVFRheEluY2x1c2l2ZSh0YXgsIGFtb3VudCwgaW5jVGF4KSB7CiAgICAgICAgICAgIGlmICh0YXgpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VBbW91bnQgPSB0YXguYmFzZUFtb3VudCB8fCAnJzsKICAgICAgICAgICAgICAgIGNvbnN0IHRheFR5cGUgPSB0YXgudGF4VHlwZSB8fCB7fQogICAgICAgICAgICAgICAgY29uc3QgdGF4VHlwZUlkID0gdGF4VHlwZS50eXBlSWQgfHwgMAogICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIiAmJiB0YXhUeXBlSWQgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFtb3VudCAtIGluY1RheAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYW1vdW50CiAgICAgICAgfSwKICAgICAgICB0b3RhbEFtb3VudCgpIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgbGV0IGFtb3VudCA9IDAKICAgICAgICAgICAgZHMuZGF0YSgpLmZpbHRlcihuID0+IG4uYW1vdW50ID4gMCkuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGl0bSA9IG0uaXRlbSB8fCB7fQogICAgICAgICAgICAgICAgY29uc3QgdW9tID0gbS51b20gfHwge30KICAgICAgICAgICAgICAgIGxldCBpbmNsdVRheCA9IDAKICAgICAgICAgICAgICAgIGlmIChpdG0uaWQgJiYgdW9tLnVvbSAmJiBpdG0udHlwZSA9PT0gJ1ZhcmlhbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGF4ID0gbS52YXRUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCBhbW91bnRfID0gbS5hbW91bnQgfHwgMAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VBbW91bnQgPSB0YXguYmFzZUFtb3VudCB8fCAnJzsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVUYXggPSB0aGlzLmF1dG9DYWxjdWxhdGVUYXgodGF4LCBhbW91bnRfKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhbW91bnQgKz0gKGFtb3VudF8gLSAoaW5jbHVUYXggfHwgMCkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnYW1vdW50IHgtJywgYW1vdW50KQogICAgICAgICAgICByZXR1cm4gYW1vdW50CiAgICAgICAgfSwKICAgICAgICBwZXJjZW50YWdlQXBwbGllZCgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHRBbW91bnQgPSB0aGlzLnRvdGFsQW1vdW50KCkKICAgICAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgICAgICBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0bSA9IG0uaXRlbSB8fCB7fQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVvbSA9IG0udW9tIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgbGV0IGluY2x1VGF4ID0gMAogICAgICAgICAgICAgICAgICAgIGlmIChpdG0uaWQgJiYgdW9tLnVvbSAmJiBpdG0udHlwZSA9PT0gJ1ZhcmlhbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRheCA9IG0udmF0VGF4IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudCA9IG0uYW1vdW50IHx8IDAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZUFtb3VudCA9IHRheC5iYXNlQW1vdW50IHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gImluY2x1c2l2ZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdVRheCA9IHRoaXMuYXV0b0NhbGN1bGF0ZVRheCh0YXgsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW1vdW50QWZ0ZXJUYXggPSBhbW91bnQgLSAoaW5jbHVUYXggfHwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcEFtb3VudCA9IGFtb3VudEFmdGVyVGF4IC8gdEFtb3VudAogICAgICAgICAgICAgICAgICAgICAgICBtWydwZXJjZW50YWdlQXBwbGllZCddID0gcEFtb3VudAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ1F0eSBCYXNlZC0tJywgZHMuZGF0YSgpKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2Vycm9yJywgZSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYW1vdW50QXBwbGllZCgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgICAgICBjb25zdCBhZGMgPSB0aGlzLmFkZGl0aW9uYWxDb3N0VG90YWwgfHwgMAogICAgICAgICAgICAgICAgZHMuZGF0YSgpLmZpbHRlcihuID0+IG4uYW1vdW50ID4gMCkuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpdG0gPSBtLml0ZW0gfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCB1b20gPSBtLnVvbSB8fCB7fQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnYW1vdW50QXBwbGllZD09JywgdW9tLnVvbSwgJy0tLScsIGl0bS50eXBlKQogICAgICAgICAgICAgICAgICAgIGlmIChpdG0uaWQgJiYgdW9tLnVvbSAmJiBpdG0udHlwZSA9PT0gJ1ZhcmlhbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlcmNlbnRhZ2VBcHBsaWVkID0gbS5wZXJjZW50YWdlQXBwbGllZCB8fCAwCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygncGVyY2VudGFnZUFwcGxpZWQtLScsIGFkYywgJy0tLScsIChwZXJjZW50YWdlQXBwbGllZCAqIGFkYykpCiAgICAgICAgICAgICAgICAgICAgICAgIG1bJ2Ftb3VudEFwcGxpZWQnXSA9IHBlcmNlbnRhZ2VBcHBsaWVkICogYWRjCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ0FNb3VudCBCYXNlZC0tJywgZHMuZGF0YSgpKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2Vycm9yJywgZSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYW1vdW50QXBwbGllZFF0eUJhc2VkKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgICAgIGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRtID0gbS5pdGVtIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW9tID0gbS51b20gfHwge30KICAgICAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRjID0gbS5hZGRpdGlvbmFsQ29zdCB8fCAwCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHF0eSA9IChtLnF0eSB8fCAxKSAqIChtLmNvbnZlcnNpb25SYXRlIHx8IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIG1bJ2Ftb3VudEFwcGxpZWQnXSA9IGFkZGMgKiBxdHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdhbW91bnRBcHBsaWVkUXR5QmFzZWQgQmFzZWQtLScsIGRzLmRhdGEoKSkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdlcnJvcicsIGUpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGNhbGN1bGF0ZUFkZGl0aW9uYWxDb3N0KCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgLy8gdG9kbzogYWRkaXRpb25hbCBDb3N0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdE1ldGhvZCA9PT0gJ1F0eSBCYXNlZCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmNlbnRhZ2VBcHBsaWVkKCkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZW50YWdlQXBwbGllZCgpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbW91bnRBcHBsaWVkKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmFkZGl0aW9uYWxDb3N0TWV0aG9kID09PSAnUXR5IEJhc2VkJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRRdHkgPSB0aGlzLnRvdGFsUXR5KCkKICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRjID0gdGhpcy5hZGRpdGlvbmFsQ29zdFRvdGFsIHx8IDAKICAgICAgICAgICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKQogICAgICAgICAgICAgICAgICAgIGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0bSA9IG0uaXRlbSB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1b20gPSBtLnVvbSB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbVsnYWRkaXRpb25hbENvc3QnXSA9IGFkZGMgLyB0UXR5CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygncXR5IGJhc2VkJywgZHMuZGF0YSgpKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKQogICAgICAgICAgICAgICAgICAgIGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0bSA9IG0uaXRlbSB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1b20gPSBtLnVvbSB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW1vdW50QXBwbGllZCA9IG0uYW1vdW50QXBwbGllZCB8fCAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBxdHkgPSAobS5xdHkgfHwgMCkgKiAobS5jb252ZXJzaW9uUmF0ZSB8fCAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbVsnYWRkaXRpb25hbENvc3QnXSA9IGFtb3VudEFwcGxpZWQgLyBxdHkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdE1ldGhvZCA9PT0gJ1F0eSBCYXNlZCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFtb3VudEFwcGxpZWRRdHlCYXNlZCgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNsZWFyaW5nQWNjb3VudCgpCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnZXJyb3InLCBlKQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlVGF4RGV0YWlsKCkgewogICAgICAgICAgICBsZXQgaWRzID0gW10KICAgICAgICAgICAgdGhpcy50YXhMaXN0RGV0YWlsLmZvckVhY2gobiA9PiB7CiAgICAgICAgICAgICAgICBpZHMucHVzaChuLmlkIHx8ICcnKQogICAgICAgICAgICB9KQogICAgICAgICAgICBjb25zdCB1bmlxdWUgPSBbLi4ubmV3IFNldChpZHMpXQogICAgICAgICAgICBsZXQgcmVzdWx0ID0gW10KICAgICAgICAgICAgdW5pcXVlLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgYW1vdW50ID0gMCwgcm93ID0ge30sIGRpc2NvdW50ID0gMCwgeERpc2NvdW50ID0gMCwgeEFtb3VudCA9IDAsIHRheEFtb3VudCA9IDAsIHhUYXhBbW91bnQgPSAwCiAgICAgICAgICAgICAgICBsZXQgdGF4RGV0YWlsID0gW10sIGlzVmF0ID0gMAogICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSB0aGlzLnRheExpc3REZXRhaWwuZmlsdGVyKG4gPT4gbi5pZCA9PT0gbSkKICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygndGF4TGlzdERldGFpbGlkcycsIGZvdW5kKQogICAgICAgICAgICAgICAgZm91bmQuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgICAgICByb3cgPSBrCiAgICAgICAgICAgICAgICAgICAgaWYgKGsuaXNWYXQgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNWYXQgPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRldGFpbF8gPSBrLmRldGFpbCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICB0YXhEZXRhaWwucHVzaChkZXRhaWxfKQoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGF4QW1vdW50ICs9IGsudGF4QW1vdW50XyB8fCAwCiAgICAgICAgICAgICAgICAgICAgeFRheEFtb3VudCArPSAoay50YXhBbW91bnRfIHx8IDApICogKGsudHhuUmF0ZSB8fCAxKQogICAgICAgICAgICAgICAgICAgIGFtb3VudCArPSAoay5hbW91bnQgfHwgMCkKICAgICAgICAgICAgICAgICAgICB4QW1vdW50ICs9IChrLmFtb3VudCB8fCAwKSAqIChrLnR4blJhdGUgfHwgMSkKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudCArPSAoay5kaXNjb3VudCB8fCAwKQogICAgICAgICAgICAgICAgICAgIHhEaXNjb3VudCArPSAoay5kaXNjb3VudCB8fCAwKSAqIChrLnR4blJhdGUgfHwgMSkKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBsZXQgc3BUYXhBbXQgPSAwLCBzcFhUYXhBbXQgPSAwLCBwbFRheEFtdCA9IDAsIHBsWFRheEFtdCA9IDAsIG90VGF4QW10ID0gMCwgb3RYVGF4QW10ID0gMCwKICAgICAgICAgICAgICAgICAgICBzcFRheE5hbWUgPSAnJywgcGxUYXhOYW1lID0gJycsIG90VGF4TmFtZSA9ICcnLAogICAgICAgICAgICAgICAgICAgIHNwVGF4TmFtZUxvY2FsZSA9ICcnLCBwbFRheE5hbWVMb2NhbGUgPSAnJywgb3RUYXhOYW1lTG9jYWxlID0gJycsCiAgICAgICAgICAgICAgICAgICAgc3BBY2NJZCA9ICcnLCBwbEFjY0lkID0gJycsIG90QWNjSWQgPSAnJywKICAgICAgICAgICAgICAgICAgICBzcFJhdGUgPSAnJywgcGxSYXRlID0gJycsIG90UmF0ZSA9ICcnCiAgICAgICAgICAgICAgICB0YXhEZXRhaWwuZm9yRWFjaChuID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcFRheCA9IG4uc3BlY2lmaWNUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCBwbFRheCA9IG4ucHVibGljTGlnaHRpbmdUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGhlclRheCA9IG4ub3RoZXJUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoc3BUYXgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3BUYXhBbXQgKz0gKHNwVGF4LnRheEFtb3VudF8gfHwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgc3BYVGF4QW10ICs9ICgoc3BUYXgudGF4QW1vdW50XyB8fCAwKSAqIChzcFRheC50YXhSYXRlIHx8IDEpKQogICAgICAgICAgICAgICAgICAgICAgICBzcFRheE5hbWUgPSBzcFRheC5kZWZhdWx0VGF4IHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIHNwVGF4TmFtZUxvY2FsZSA9IHNwVGF4LmRlZmF1bHRUYXhMb2NhbGUgfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgc3BBY2NJZCA9IHNwVGF4LmFjY291bnQgPyBzcFRheC5hY2NvdW50LmlkIDogJycKICAgICAgICAgICAgICAgICAgICAgICAgc3BSYXRlID0gc3BUYXgucmF0ZSB8fCAxCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhwbFRheCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwbFRheEFtdCArPSAocGxUYXgudGF4QW1vdW50XyB8fCAwKQogICAgICAgICAgICAgICAgICAgICAgICBwbFhUYXhBbXQgKz0gKChwbFRheC50YXhBbW91bnRfIHx8IDApICogKHBsVGF4LnRheFJhdGUgfHwgMSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHBsVGF4TmFtZSA9IHBsVGF4LmRlZmF1bHRUYXggfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgcGxUYXhOYW1lTG9jYWxlID0gcGxUYXguZGVmYXVsdFRheExvY2FsZSB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICBwbEFjY0lkID0gcGxUYXguYWNjb3VudCA/IHBsVGF4LmFjY291bnQuaWQgOiAnJwogICAgICAgICAgICAgICAgICAgICAgICBwbFJhdGUgPSBwbFRheC5yYXRlIHx8IDEKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKG90aGVyVGF4KS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG90VGF4QW10ICs9IChvdGhlclRheC50YXhBbW91bnRfIHx8IDApCiAgICAgICAgICAgICAgICAgICAgICAgIG90WFRheEFtdCArPSAoKG90aGVyVGF4LnRheEFtb3VudF8gfHwgMCkgKiAocGxUYXgudGF4UmF0ZSB8fCAxKSkKICAgICAgICAgICAgICAgICAgICAgICAgb3RUYXhOYW1lID0gb3RoZXJUYXguZGVmYXVsdFRheCB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICBvdFRheE5hbWVMb2NhbGUgPSBvdGhlclRheC5kZWZhdWx0VGF4TG9jYWxlIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIG90QWNjSWQgPSBvdGhlclRheC5hY2NvdW50ID8gb3RoZXJUYXguYWNjb3VudC5pZCA6ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIG90UmF0ZSA9IG90aGVyVGF4LnJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBpZiAoaXNWYXQgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByb3cuZGV0YWlsID0gewogICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZpY1RheDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogc3BUYXhOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZUxvY2FsZTogc3BUYXhOYW1lTG9jYWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBzcFRheEFtdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBzcFhUYXhBbXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwQWNjSWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlOiBzcFJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpY0xpZ2h0aW5nVGF4OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwbFRheE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lTG9jYWxlOiBwbFRheE5hbWVMb2NhbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHBsVGF4QW10LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHBsWFRheEFtdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogcGxBY2NJZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IHBsUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJUYXg6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG90VGF4TmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVMb2NhbGU6IG90VGF4TmFtZUxvY2FsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogb3RUYXhBbXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogb3RYVGF4QW10LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBvdEFjY0lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZTogb3RSYXRlLAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByb3cuZGV0YWlsID0ge30KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByb3dbJ2Ftb3VudCddID0gYW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ2V4Y2hhbmdlQW1vdW50J10gPSB4QW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ3RheEFtb3VudCddID0gdGF4QW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ2V4Y2hhbmdlVGF4QW1vdW50J10gPSB4VGF4QW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ2Rpc2NvdW50J10gPSBkaXNjb3VudAogICAgICAgICAgICAgICAgcm93WydleGNoYW5nZURpc2NvdW50J10gPSB4RGlzY291bnQKICAgICAgICAgICAgICAgIHJvd1snY3VycmVuY3knXSA9IHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VSYXRlIHx8IHt9CiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChyb3cpCiAgICAgICAgICAgICAgICB0YXhEZXRhaWwgPSBbXQogICAgICAgICAgICB9KQogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnNhbGVUYXhEZXRhaWwgPSByZXN1bHQKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdzYWxlVGF4RGV0YWlsJywgcmVzdWx0KQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgZ2V0RXhwZW5zZUJ5U3VwcGxpZXIoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlZ21lbnQgPSB0aGlzLnB1cmNoYXNlLnNlZ21lbnQgfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWdtZW50SWQgPSBzZWdtZW50LmlkIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb24gPSB0aGlzLnB1cmNoYXNlLmxvY2F0aW9uIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb25JZCA9IGxvY2F0aW9uLmlkIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3VwcGxpZXIgPSB0aGlzLnB1cmNoYXNlLnN1cHBsaWVyIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3VwcGxpZXJJZCA9IHN1cHBsaWVyLmlkIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0gJz9pZD0nICsgc3VwcGxpZXJJZCArICcmc2VnSWQ9JyArIHNlZ21lbnRJZCArICcmbG9jSWQ9JyArIGxvY2F0aW9uSWQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5leHBlbnNlcyA9IFtdCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdFRvdGFsID0gMAogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmdUeG5BZGRpdGlvbmFsQ29zdCA9IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdCA9IFtdCiAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIubGlzdFB1cmNoYXNlKHN0ckZpbHRlcikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmdUeG5BZGRpdGlvbmFsQ29zdCA9IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmdUeG5BZGRpdGlvbmFsQ29zdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leHBlbnNlcyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTWV0aG9kQ2hhbmdlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuQWRkaXRpb25hbENvc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGNsZWFyaW5nQWNjb3VudCgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzSXRlbSgpKSB7CiAgICAgICAgICAgICAgICAgICAgLyogdG9kbzogY2xlYXJpbmcgYWNjb3VudCBmb3IgYWRkaXRpb25hbCBjb3N0ICovCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW1vdW50ID0gKHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3RUb3RhbCB8fCAwKSAqIC0xCiAgICAgICAgICAgICAgICAgICAgY29uc3QgeEFtb3VudCA9IGFtb3VudCAqIHRoaXMucHVyY2hhc2UudHhuUmF0ZSB8fCAxCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkaWN0ID0gdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdCB8fCBbXQoKICAgICAgICAgICAgICAgICAgICBpZiAoYWRkaWN0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZGljdFswXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWNjb3VudCA9IGFkZGljdFswXS5hY2NvdW50IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYXR1cmUgPSAnY3InCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGFjY291bnQuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIkFkZGl0aW9uYWwgQ29zdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHhBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogImNsZWFyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2Vycm9yJywgZSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgaXNJdGVtKCkgewogICAgICAgICAgICBjb25zdCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgIGNvbnN0IHJvdyA9IGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApCiAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gcm93LmZpbHRlcihuID0+IG4uaXRlbS50eXBlID09PSAnVmFyaWFudCcpCiAgICAgICAgICAgIGlmIChmb3VuZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kLmxlbmd0aCA+IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgfSwKICAgIGNvbXB1dGVkOiB7CiAgICAgICAgYWJicigpIHsKICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHR4blR5cGUgPSB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZSB8fCB7fQogICAgICAgICAgICAgICAgY29uc3QgYWJiciA9IHR4blR5cGUuYWJiciB8fCAnJwogICAgICAgICAgICAgICAgcmV0dXJuIGFiYnIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB2YWxpZFZlbmRvcigpIHsKICAgICAgICAgICAgbGV0IHZlbmRvciA9IHRoaXMudmVuZG9yOwogICAgICAgICAgICByZXR1cm4gdmVuZG9yLmlkICE9PSB1bmRlZmluZWQgJiYgdmVuZG9yLmlkICE9PSBudWxsOwogICAgICAgIH0sCiAgICAgICAgZGlzYWJsZU1lKCkgewogICAgICAgICAgICByZXR1cm4gISF0aGlzLiRyb3V0ZS5wYXJhbXMuaWQ7CiAgICAgICAgfSwKICAgICAgICBoaWRkZW5CdXR0b24oKSB7CiAgICAgICAgICAgIHJldHVybiAhIXRoaXMuJHJvdXRlLnBhcmFtcy5pZDsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVkU0xQKCkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWZGID0gdGhpcy5wdXJjaGFzZS5yZWZGcm9tIHx8IFtdCiAgICAgICAgICAgICAgICBpZiAocmVmRi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhcmVmRi5sZW5ndGggPiAwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBhZGMgPSB0aGlzLnB1cmNoYXNlLmFkZGl0aW9uYWxDb3N0IHx8IFtdCiAgICAgICAgICAgICAgICBpZiAoYWRjLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gISFhZGMubGVuZ3RoID4gMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0sCiAgICB9LAogICAgd2F0Y2g6IHsKICAgICAgICAvLyBpZCgpIHsKICAgICAgICAvLyAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgLy8gICB9IGVsc2UgewogICAgICAgIC8vICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAvLyAgICAgdGhpcy5sb2FkVmlld0NyZWRpdFB1cmNoYXNlKCk7CiAgICAgICAgLy8gICB9CiAgICAgICAgLy8gfSwKICAgICAgICAnJHJvdXRlJzogJ3JlbG9hZCcKICAgIH0sCiAgICBjcmVhdGVkKCkgewogICAgICAgIHRoaXMubG9hZFRheCgpOwogICAgICAgIHRoaXMubG9hZFByZWZpeCgpOwogICAgICAgIHRoaXMubG9hZFByb2plY3RCeUN1c3RvbWVyKCk7CiAgICB9LAogICAgbW91bnRlZDogYXN5bmMgZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMucmVxdWVzdERhdGEoMCwgdGhpcy5maWx0ZXIsIHRoaXMuY3VzQmFzZVVybCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkU2VnbWVudCgpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZExvY2F0aW9uKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkRGlzY291bnRJdGVtKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkRW1wbG95ZWVDZW50ZXIoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRQYXltZW50VGVybSgpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZEFjY291bnQoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRQcmljZUxldmVsKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkT3RoZXJDaGFyZ2UoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRQdXJjaGFzZUZvcm1Db250ZW50KCk7CiAgICAgICAgYXdhaXQgdGhpcy5pbml0RGF0YSgpCiAgICB9LAp9Owo="},{"version":3,"sources":["CreditPurchases.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAukCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"CreditPurchases.vue","sourceRoot":"src/views/suppliers","sourcesContent":["<template>\n    <v-app>\n        <v-container>\n            <v-row>\n                <v-col sm=\"12\" cols=\"12\">\n                    <v-card\n                        outlined\n                        dense\n                        class=\"pa-4 no_border rounded-sm\"\n                        color=\"white\"\n                    >\n                        <v-form ref=\"form\" v-model=\"valid\" lazy-validation>\n                            <v-row>\n                                <v-col\n                                    class=\"bigSide pr-2 py-0\"\n                                    sm=\"8\"\n                                    cols=\"12\"\n                                    style=\"transition: .3s ease-in;\"\n                                    :class=\"{ hide_big_bar_class: isHideBar }\"\n                                >\n                                    <v-card outlined dense class=\"no_border\">\n                                        <h2 class=\"mb-0\">{{ $t(\"purchase\") }}</h2>\n                                        <v-icon\n                                            v-if=\"isHideBar\"\n                                            @click=\"cancel()\"\n                                            style=\"cursor: pointer;  font-size: 40px;\"\n                                            color=\"grey\"\n                                            class=\"float-right\"\n                                        >close\n                                        </v-icon>\n                                        <span\n                                            style=\"transition: .3s ease-in; z-index:10;\"\n                                            :class=\"{\n                        iconArrow: !isHideBar,\n                        iconArrowHide: isHideBar,\n                      }\"\n                                        >\n                      <v-icon\n                          size=\"22\"\n                          class=\"arr_icon\"\n                          @click=\"hideSmallSidebar\"\n                          v-if=\"isHideBar\"\n                      >\n                        mdi-chevron-left-circle\n                      </v-icon>\n                      <v-icon\n                          size=\"22\"\n                          class=\"arr_icon\"\n                          @click=\"hideSmallSidebar\"\n                          v-if=\"!isHideBar\"\n                      >\n                        mdi-chevron-right-circle\n                      </v-icon>\n                    </span>\n                                    </v-card>\n                                    <v-card outlined dense class=\"px-4 rounded-4 no_border\" color=\"grayBg\">\n                                        <v-row>\n                                            <v-col sm=\"4\" cols=\"12\" class=\"pb-0 pt-4\">\n                                                <label class=\"label  mb-0\">{{ $t(\"supplier\") }}</label>\n                                                <v-col\n                                                    sm=\"12\"\n                                                    cols=\"12\"\n                                                    class=\"kendo_dropdown_custom px-0 pb-3 pt-0\"\n                                                >\n                                                    <dropdownlist\n                                                        :data-items=\"vendorList\"\n                                                        @change=\"onChange\"\n                                                        :value=\"vendor\"\n                                                        :data-item-key=\"dataItemKey\"\n                                                        :text-field=\"textField\"\n                                                        :default-item=\"defaultItem\"\n                                                        :filterable=\"true\"\n                                                        :required=\"true\"\n                                                        :disabled=\"disableMe\"\n                                                        :valid=\"validVendor\"\n                                                        @filterchange=\"onFilterChange\"\n                                                    >\n                                                    </dropdownlist>\n                                                </v-col>\n                                                <div hidden>\n                                                    <label class=\"label mb-0\">{{\n                                                            $t(\"purchase_type\")\n                                                        }}</label>\n                                                    <v-select\n                                                        class=\"mt-1\"\n                                                        :items=\"purchaseTypes\"\n                                                        item-value=\"id\"\n                                                        item-text=\"name\"\n                                                        v-model=\"purchase.transactionType\"\n                                                        @change=\"onInvoiceTypeChanged\"\n                                                        :rules=\"[\n                              (v) => !!v || 'Transaction Currency is required',\n                            ]\"\n                                                        return-object\n                                                        outlined\n                                                    />\n                                                </div>\n\n                                                <label class=\"label  mb-0\">{{\n                                                        $t(\"transaction_date\")\n                                                    }}</label>\n                                                <app-datepicker\n                                                    :initialDate=\"purchase.transactionDate\"\n                                                    :disabled=\"disableMe\"\n                                                    @onChanged=\"onInvoiceDateChanged\"\n                                                    @emitDate=\"txnDate = $event\"\n                                                />\n                                                <label class=\"label mb-0\">{{\n                                                        $t(\"transaction_number\")\n                                                    }}</label>\n                                                <v-row class=\"mt-1 mr-0\">\n                                                    <v-col sm=\"3\" cols=\"3\" class=\"pt-0 pr-0 pb-0\">\n                                                        <div class=\"code_text text-bold\">\n                                                            {{ abbr }}\n                                                        </div>\n                                                    </v-col>\n                                                    <v-col sm=\"7\" cols=\"7\" class=\"pt-0 pl-0 pr-1 pb-0\">\n                                                        <v-text-field\n                                                            class=\" custom-border \"\n                                                            v-model=\"purchase.number\"\n                                                            outlined\n                                                            readonly\n                                                            :rules=\"[(v) => !!v || 'Number is required']\"\n                                                            required\n                                                        />\n                                                    </v-col>\n                                                    <v-col sm=\"2\" cols=\"2\" class=\"pt-0 px-0 pb-0\">\n                                                        <v-icon\n                                                            color=\"black\"\n                                                            size=\"30\"\n                                                            class=\"border_qrcode\"\n                                                            :disabled=\"disableMe\"\n                                                            @click=\"generateNumber\"\n                                                        >mdi-qrcode\n                                                        </v-icon>\n                                                    </v-col>\n                                                </v-row>\n                                                <label class=\"label mb-0\">{{\n                                                        $t(\"suppliers_invoice_no\")\n                                                    }}</label>\n                                                <v-text-field\n                                                    class=\"mt-1 mr-0\"\n                                                    outlined\n                                                    v-model=\"purchase.billNo\"\n                                                    tage=\"Vendor Invoice Number.\"\n                                                    :rules=\"[(v) => !!v || 'required']\"\n                                                    required\n                                                />\n                                            </v-col>\n                                            <v-col sm=\"8\" cols=\"12\" class=\"pt-4\">\n                                                <v-row>\n                                                    <v-col sm=\"6\" cols=\"12\" class=\" pt-0\">\n                                                        <p class=\"mb-1 d-block\">\n                                                            {{ $t(\"current_balance\") }}\n                                                        </p>\n                                                        <h3 class=\"primary--text float-right\">\n                                                            {{ numberFormat(purchase.currentBalance) }}\n                                                            {{ baseCurrencyCode }}\n                                                        </h3>\n                                                    </v-col>\n                                                    <v-col sm=\"6\" cols=\"12\" class=\"pl-0 pt-0\">\n                                                        <p class=\"mb-1 d-block\">\n                                                            {{ $t(\"credit_limit_allowed\") }}\n                                                        </p>\n                                                        <h3 class=\"primary--text float-left\">\n                                                            {{\n                                                                creditLimitUsage(\n                                                                    purchase.currentBalance,\n                                                                    purchase.creditLimit\n                                                                )\n                                                            }}\n                                                        </h3>\n                                                        <h3 class=\"primary--text float-right\">\n                                                            {{ numberFormat(purchase.creditLimit) }}\n                                                            {{ baseCurrencyCode }}\n                                                        </h3>\n                                                    </v-col>\n                                                </v-row>\n                                                <v-row\n                                                    style=\"background-color: #fff;\"\n                                                    class=\"mr-0 mt-2\"\n                                                >\n                                                    <v-col class=\"pb-0 pt-3\" sm=\"6\" cols=\"12\">\n                                                        <label class=\"label mb-0\">{{ $t(\"term\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"purchase.paymentTerm\"\n                                                            :items=\"paymentTerms\"\n                                                            :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                            @change=\"onPaymentTermChanged\"\n                                                            placeholder=\"Term\"\n                                                            item-text=\"name\"\n                                                            item-value=\"id\"\n                                                            return-object\n                                                            outlined\n                                                        />\n\n                                                        <label class=\"label mb-0\">{{\n                                                                $t(\"account_payable\")\n                                                            }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"purchase.apAcc\"\n                                                            :items=\"accPayable\"\n                                                            item-value=\"id\"\n                                                            :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                            :item-text=\"(item) => `${item.number} - ${item.name}` \"\n                                                            return-object\n                                                            placeholder=\"Account Payable\"\n                                                            tage=\"Account Payable\"\n                                                            outlined\n                                                        />\n                                                        <label class=\"label mb-0\">{{\n                                                                $t(\"vendor_invoice_date\")\n                                                            }}</label>\n                                                        <app-datepicker\n                                                            :initialDate=\"purchase.billDate\"\n                                                            @emitDate=\"billDate = $event\"\n                                                        />\n                                                    </v-col>\n                                                    <v-col class=\"pb-0 pt-3\" sm=\"6\" cols=\"12\">\n                                                        <label class=\"label  mb-0\">{{\n                                                                $t(\"due_date\")\n                                                            }}</label>\n                                                        <app-datepicker\n                                                            :initialDate=\"purchase.dueDate\"\n                                                            @emitDate=\"dueDate = $event\"\n                                                        />\n                                                        <label class=\"label mb-0\">{{\n                                                                $t(\"price_level\")\n                                                            }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"purchase.priceLevel\"\n                                                            :items=\"priceLevel\"\n                                                            item-value=\"id\"\n                                                            @change=\"onPriceLevelChange\"\n                                                            :disabled=\"disabledSLP\"\n                                                            :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                            item-text=\"name\"\n                                                            return-object\n                                                            placeholder=\"Price Level\"\n                                                            tage=\"Default Price Level\"\n                                                            outlined\n                                                        />\n                                                        <v-col\n                                                            sm=\"12\"\n                                                            col=\"12\"\n                                                            class=\"d-flex justify-space-between pt-0\"\n                                                        >\n                                                            <div>\n                                                                <p class=\"label mb-0\">{{ $t(\"currency\") }}</p>\n                                                                <p class=\"label mb-0 mt-4\">\n                                                                    {{ currencyCode }}\n                                                                </p>\n                                                            </div>\n                                                            <div>\n                                                                <p class=\"label mb-0\">{{ $t(\"rate\") }}</p>\n                                                                <p class=\"label mb-0 mt-4\">\n                                                                    {{ transactionRate }}\n                                                                </p>\n                                                            </div>\n                                                        </v-col>\n                                                    </v-col>\n                                                </v-row>\n                                            </v-col>\n                                        </v-row>\n                                    </v-card>\n                                    <v-row style=\"background-color: #fff;\">\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pb-0 px-4\">\n                                            <kendo-datasource\n                                                ref=\"itemLineDS\"\n                                                :data=\"itemLines\"\n                                                :change=\"dataSourceChanged\"\n                                            />\n                                            <kendo-grid\n                                                id=\"gridItemLine\"\n                                                class=\"grid-function\"\n                                                :data-source-ref=\"'itemLineDS'\"\n                                                :sortable=\"false\"\n                                                :column-menu=\"true\"\n                                                :editable=\"true\"\n                                                v-on:databound=\"dataBound\"\n                                                :scrollable-virtual=\"true\">\n                                                <kendo-grid-column\n                                                    :command=\"{ iconClass: 'k-icon k-i-trash', text: ' ',  click: removeRow, className: 'isEditable', }\"\n                                                    :title=\"' '\"\n                                                    :width=\"70\"\n                                                    :headerAttributes=\"{ style:'text-align: left; background-color: #EDF1F5', }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :title=\"$t('no.')\"\n                                                    :width=\"55\"\n                                                    :column-menu=\"false\"\n                                                    :template=\"rowNumberTmpl\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5;',\n                            class: 'text-products',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: products' }\"\n                                                />\n\n                                                <kendo-grid-column\n                                                    :field=\"'item'\"\n                                                    :title=\"$t('item')\"\n                                                    :template=\"itemTemplate\"\n                                                    :editor=\"ItemDropDownEditor\"\n                                                    :attributes=\"{ class: 'isEditable'}\"\n                                                    :width=\"200\"\n                                                    :headerAttributes=\"{ style: 'background-color: #EDF1F5',}\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'description'\"\n                                                    :title=\"$t('description')\"\n                                                    :template=\"'<span>#=description#</span>'\"\n                                                    :width=\"200\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'qty'\"\n                                                    :title=\"$t('qty')\"\n                                                    :format=\"'{0:n}'\"\n                                                    :template=\"'<span>#=qty#</span>'\"\n                                                    :width=\"80\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: right; ' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'uom'\"\n                                                    :title=\"$t('uom')\"\n                                                    :width=\"120\"\n                                                    :template=\"UOMTemplate\"\n                                                    :editor=\"UOMDropDownEditor\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'cost'\"\n                                                    :title=\"$t('cost')\"\n                                                    :width=\"200\"\n                                                    :template=\"\n                            '<span>#=kendo.toString(cost || 0, decimalFormat)#</span>'\n                          \"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: right' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'amount'\"\n                                                    :title=\"$t('amount')\"\n                                                    :width=\"200\"\n                                                    :editable=\" () => { return false; }\"\n                                                    :template=\"'<span>#=kendo.toString(amount || 0, decimalFormat)#</span>'\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: right' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'vatTax'\"\n                                                    :title=\"$t('tax')\"\n                                                    :width=\"200\"\n                                                    :template=\"vatTemplate\"\n                                                    :editor=\"VatTaxDropDownEditor\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'serviceDate'\"\n                                                    :title=\"$t('date_from')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!purchaseFormContent.serviceDate\"\n                                                    :template=\"\n                            '<span>#= kendo.toString(new Date(serviceDate), dateFormat)#</span>'\n                          \"\n                                                    :editor=\"ServiceDateEditor\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'serviceDateTo'\"\n                                                    :title=\"$t('date_to')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!purchaseFormContent.serviceDateTo\"\n                                                    :template=\"\n                            '<span>#= kendo.toString(new Date(serviceDateTo), dateFormat)#</span>'\n                          \"\n                                                    :editor=\"ServiceDateToEditor\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'discountItem'\"\n                                                    :title=\"$t('discount_item')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!purchaseFormContent.discountItem\"\n                                                    :template=\"discountItemTemplate\"\n                                                    :editor=\"DiscountItemDropDownEditor\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n\n                                                <kendo-grid-column\n                                                    :field=\"'class1'\"\n                                                    :title=\"$t('class_1')\"\n                                                    :hidden=\"!purchaseFormContent.class1\"\n                                                    :template=\"'<span>#=class1.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class1\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class2'\"\n                                                    :title=\"$t('class_2')\"\n                                                    :hidden=\"!purchaseFormContent.class2\"\n                                                    :template=\"'<span>#=class2.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class2\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class3'\"\n                                                    :title=\"$t('class_3')\"\n                                                    :hidden=\"!purchaseFormContent.class3\"\n                                                    :template=\"'<span>#=class3.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class3\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class4'\"\n                                                    :title=\"$t('class_4')\"\n                                                    :hidden=\"!purchaseFormContent.class4\"\n                                                    :template=\"'<span>#=class4.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class4\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class5'\"\n                                                    :title=\"$t('class_5')\"\n                                                    :hidden=\"!purchaseFormContent.class5\"\n                                                    :template=\"'<span>#=class5.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class5\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                            </kendo-grid>\n                                        </v-col>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pt-1\">\n                                            <v-btn\n                                                class=\"float-left btn_plus mr-2\"\n                                                @click=\"addRow\"\n                                            >\n                                                <v-icon size=\"\" class=\"ma-1\">mdi-plus</v-icon>\n                                            </v-btn>\n                                        </v-col>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                            <v-row>\n                                                <v-col class=\"pt-0\" sm=\"5\" cols=\"6\">\n                                                    <v-card class=\"no-boxshadow pa-3 rounded-4\" color=\"grayBg\">\n                                                        <v-row>\n                                                            <v-col class=\"py-0 pa-4\" sm=\"12\" cols=\"12\">\n                                                                <label class=\"label mb-0\">{{\n                                                                        $t(\"billing_address\")\n                                                                    }}</label>\n                                                                <v-select\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.billingAddress\"\n                                                                    :items=\"billingAddress\"\n                                                                    item-value=\"id\"\n                                                                    item-text=\"name\"\n                                                                    tage=\"Billing Address\"\n                                                                    placeholder=\"Address\"\n                                                                    outlined\n                                                                />\n                                                                <label class=\"label mb-0\">{{\n                                                                        $t(\"pickup_delivery_address\")\n                                                                    }}</label>\n                                                                <v-select\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.deliveryAddress\"\n                                                                    :items=\"deliveryAddress\"\n                                                                    item-value=\"id\"\n                                                                    item-text=\"name\"\n                                                                    tage=\"Pickup/ Delivery Address\"\n                                                                    placeholder=\"Address\"\n                                                                    outlined\n                                                                />\n                                                                <label class=\"label  mb-0\">{{\n                                                                        $t(\"pickup_delivery_date_time\")\n                                                                    }}</label>\n                                                                <app-datepicker\n                                                                    :initialDate=\"purchase.deliveryDateTime\"\n                                                                    @emitDate=\"deliveryDateTime = $event\"\n                                                                />\n\n                                                                <label>{{ $t(\"message_on_invoice\") }}</label>\n                                                                <v-textarea\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.transactionNote\"\n                                                                    outlined\n                                                                    no-resize\n                                                                    height=\"70px\"\n                                                                    tage=\"Message on Purchase\"\n                                                                    placeholder=\"This will appear on the Purchase\"\n                                                                />\n                                                                <label>{{ $t(\"message_on_journal\") }}</label>\n                                                                <v-textarea\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.journalNote\"\n                                                                    outlined\n                                                                    no-resize\n                                                                    height=\"70px\"\n                                                                    tage=\"Message on Order\"\n                                                                    placeholder=\"This will appear on the journal\"\n                                                                />\n                                                            </v-col>\n                                                        </v-row>\n                                                    </v-card>\n                                                </v-col>\n                                                <v-col class=\"pt-0\" sm=\"7\" cols=\"6\">\n                                                    <v-simple-table>\n                                                        <template v-slot:default>\n                                                            <tbody>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"subtotal\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    {{ numberFormat(purchase.subTotal) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"general_discount\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    ({{ numberFormat(purchase.discountTotal) }})\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"total_tax\") }}\n                                                                    <v-btn\n                                                                        @click=\"dialogTax = true\"\n                                                                        color=\"primary\"\n                                                                        outlined\n                                                                        class=\"text-white text-bold  float-right text-uppercase\"\n                                                                        style=\"height: 30px !important;\"\n                                                                    >\n                                                                        {{ $t(\"tax\") }}\n                                                                    </v-btn>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    {{ numberFormat(purchase.totalTaxAmount) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\" width=\"240px\">\n                                                                    <v-select\n                                                                        class=\"mt-3\"\n                                                                        v-model=\"purchase.specificDiscountItem\"\n                                                                        :items=\"specificDiscountItem\"\n                                                                        item-text=\"name\"\n                                                                        @change=\"onSpecificDiscountChanged\"\n                                                                        item-value=\"id\"\n                                                                        return-object\n                                                                        clearable\n                                                                        outlined\n                                                                    />\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    ({{\n                                                                        numberFormat(\n                                                                            purchase.specificDiscountTotal\n                                                                                ? purchase.specificDiscountTotal\n                                                                                : 0\n                                                                        )\n                                                                    }})\n                                                                </td>\n                                                            </tr>\n                                                            <!--                                                            <tr>-->\n                                                            <!--                                                                <td class=\"text-left\">{{ $t('delivery') }}</td>-->\n                                                            <!--                                                                <td class=\"text-center\">:</td>-->\n                                                            <!--                                                                <td class=\"text-right\">{{ invoice.deliveryFee }}</td>-->\n                                                            <!--                                                            </tr>-->\n\n                                                            <tr\n                                                                v-for=\"(num, index) in numSelect\"\n                                                                :key=\"index\"\n                                                                class=\"hide_form_alert\"\n                                                            >\n                                                                <td class=\"text-left text-uppercase pr-0\">\n                                                                    <v-btn\n                                                                        v-if=\"num == 1\"\n                                                                        @click=\"addSelect\"\n                                                                        class=\"float-left mt-2 mr-1 pa-1\"\n                                                                        small\n                                                                    >\n                                                                        <v-icon\n                                                                            color=\"primary\"\n                                                                            size=\"16\"\n                                                                            class=\"ma-1\"\n                                                                        >\n                                                                            mdi-plus\n                                                                        </v-icon>\n                                                                    </v-btn>\n                                                                    <v-btn\n                                                                        v-if=\"num > 1\"\n                                                                        @click=\"removeSelect(index)\"\n                                                                        class=\"float-left mt-2 mr-1 pa-1\"\n                                                                        small\n                                                                    >\n                                                                        <v-icon\n                                                                            color=\"primary\"\n                                                                            size=\"16\"\n                                                                            class=\"ma-1\"\n                                                                        >\n                                                                            fa-trash\n                                                                        </v-icon>\n                                                                    </v-btn>\n                                                                    <v-select\n                                                                        class=\"my-2 capitalize\"\n                                                                        v-model=\"mOtherCharge[index]\"\n                                                                        :items=\"otherChargeList\"\n                                                                        item-text=\"name\"\n                                                                        @change=\"onOtherChargeChange\"\n                                                                        item-value=\"id\"\n                                                                        return-object\n                                                                        clearable\n                                                                        outlined\n                                                                    />\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                >\n                                                                    {{\n                                                                        numberFormat(\n                                                                            onOtherAmount(mOtherCharge[index])\n                                                                        )\n                                                                    }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left text-uppercase pr-0\">\n                                                                    {{ $t(\"total\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                    id=\"total\"\n                                                                >\n                                                                    {{ numberFormat(purchase.total) }}\n                                                                </td>\n                                                            </tr>\n                                                            <!--                                                            <tr>-->\n                                                            <!--                                                                <td class=\"text-left text-uppercase pr-0\">-->\n                                                            <!--                                                                    {{ $t(\"total_after_withholding\") }}-->\n                                                            <!--                                                                </td>-->\n                                                            <!--                                                                <td class=\"text-center\">:</td>-->\n                                                            <!--                                                                <td-->\n                                                            <!--                                                                    class=\"text-right primary&#45;&#45;text text-bold\"-->\n                                                            <!--                                                                    id=\"total_\"-->\n                                                            <!--                                                                >-->\n                                                            <!--                                                                    {{-->\n                                                            <!--                                                                        numberFormat(purchase.totalAfterWithholdingTax)-->\n                                                            <!--                                                                    }}-->\n                                                            <!--                                                                </td>-->\n                                                            <!--                                                            </tr>-->\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"deposit\") }}\n                                                                    <span class=\"float-right primary--text\">{{\n                                                                            numberFormat(purchase.depositAmount)\n                                                                        }}</span>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right hide_form_alert\">\n                                                                    <v-text-field\n                                                                        class=\" text-right float-right deposite_input\"\n                                                                        v-model=\"purchase.depositDeduction\"\n                                                                        @change=\"onDepositDeductionChange\"\n                                                                        min=0\n                                                                        type=\"number\"\n                                                                        tage=\"Deposit\"\n                                                                        width=\"80\"\n                                                                        outlined\n                                                                    />\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">\n                                                                    {{ $t(\"amount_due\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                >\n                                                                    {{ numberFormat(purchase.remainingAmount) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">{{ $t(\"dr\") }}</td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                >\n                                                                    {{ (purchase.dr) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">{{ $t(\"cr\") }}</td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                >\n                                                                    {{ (purchase.cr) }}\n                                                                </td>\n                                                            </tr>\n                                                            </tbody>\n                                                        </template>\n                                                    </v-simple-table>\n                                                </v-col>\n                                            </v-row>\n                                        </v-col>\n                                    </v-row>\n                                    <v-divider/>\n                                    <v-card outlined dense class=\"no_border function_footer\">\n                                        <v-alert type=\"warning\" v-model=\"alert\" dismissible>\n                                            <span v-html=\"errorMessage\"/>\n                                        </v-alert>\n                                        <v-menu>\n                                            <template v-slot:activator=\"{ on }\">\n                                                <v-btn\n                                                    class=\"mr-2 float-left select_template\"\n                                                    v-on=\"on\"\n                                                >\n                                                    {{ $t(\"select_template\") }}\n                                                    <v-icon size=\"\" class=\"ma-1\">expand_more</v-icon>\n                                                </v-btn>\n                                            </template>\n                                            <v-list>\n                                                <v-list-item\n                                                    v-for=\"(item, index) in templates\"\n                                                    :key=\"index\"\n                                                >\n                                                    <v-list-item-title>{{\n                                                            item.title\n                                                        }}\n                                                    </v-list-item-title>\n                                                </v-list-item>\n                                            </v-list>\n                                        </v-menu>\n                                        <v-btn\n                                            outlined\n                                            class=\"text-capitalize  black--text float-left\"\n                                            color=\"primary\"\n                                            @click=\"cancel\"\n                                        >{{ $t(\"cancel\") }}\n                                        </v-btn>\n                                        <v-btn\n                                            class=\"float-right text-capitalize  white--text\"\n                                            @click=\"onSaveClose(false)\"\n                                            color=\"primary\">\n                                            {{ $t(\"save_close\") }}\n                                        </v-btn>\n                                        <v-btn color=\"secondary\"\n                                               style=\"margin-right: 10px !important\"\n                                               class=\"white--text float-right text-capitalize\"\n                                               @click=\"onSaveClose(true)\" :hidden=\"hiddenButton\">{{ $t(\"save_new\") }}\n                                        </v-btn>\n                                    </v-card>\n                                </v-col>\n                                <v-col\n                                    class=\"smallSide pl-2 pt-0\"\n                                    sm=\"4\"\n                                    style=\"transition: .3s ease-in;\"\n                                    :class=\"{ hide_small_bar_class: isHideBar }\"\n                                >\n                                    <div class=\"d-flex justify-end\">\n                                        <h3\n                                            style=\"color: #b3b5bc; font-size:20px;\"\n                                            v-if=\"!isHideBar\"\n                                            class=\"text-uppercase\"\n                                        >\n                      <span class=\"pointer\" @click=\"Help('purchase')\">\n                        {{ $t(\"help\") }}\n                      </span>\n                                            <v-icon\n                                                @click=\"cancel()\"\n                                                style=\"cursor: pointer; color: #333; font-size: 40px;\"\n                                                class=\"float-right mt-n1\"\n                                            >close\n                                            </v-icon>\n                                        </h3>\n                                    </div>\n                                    <div\n                                        v-if=\"!isHideBar\"\n                                        class=\"small_sidebar rounded-4 mt-2 px-4 pt-4 grayBg\"\n                                    >\n                                        <v-card outlined dense class=\"pa-3 no_border my_card rounded-4 white--text\"\n                                                color=\"primary\" height=\"60px\">\n                                            <h3 class=\"text-left font_13 flex-1 text-uppercase\">{{\n                                                    $t('amount_due')\n                                                }}</h3>\n                                            <h3 class=\"text-right flex-1 font_20 niradei_heavy\">\n                                                {{ numberFormat(purchase.amountDue) }} </h3>\n                                        </v-card>\n                                        <v-row>\n                                            <v-col sm=\"12\" cols=\"12\" class=\"pt-4\">\n                                                <label class=\"label mb-0\">{{ $t(\"segment\") }}</label>\n                                                <v-select\n                                                    class=\"mt-1\"\n                                                    v-model=\"purchase.segment\"\n                                                    :items=\"segments\"\n                                                    item-value=\"id\"\n                                                    :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                    @change=\"loadPurchaseOrder\"\n                                                    :disabled=\"disabledSLP\"\n                                                    :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                    return-object\n                                                    tage=\"Segment\"\n                                                    placeholder=\"Segment\"\n                                                    outlined=\"\"\n                                                />\n                                                <label class=\"label mb-0\">{{ $t(\"location\") }}</label>\n                                                <v-select\n                                                    class=\"mt-1\"\n                                                    v-model=\"purchase.location\"\n                                                    :items=\"locations\"\n                                                    :disabled=\"disabledSLP\"\n                                                    @change=\"loadPurchaseOrder\"\n                                                    item-value=\"id\"\n                                                    :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                    :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                    return-object\n                                                    tage=\"Location\"\n                                                    placeholder=\"bu/location\"\n                                                    outlined=\"\"\n                                                />\n                                                <label class=\"label font_14\">{{ $t(\"project\") }}</label>\n                                                <v-select\n                                                    class=\" mt-1\"\n                                                    v-model=\"purchase.project\"\n                                                    :items=\"customerProjects\"\n                                                    :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                    item-value=\"id\"\n                                                    clearable\n                                                    tage=\"Customer Project\"\n                                                    placeholder=\"project\"\n                                                    outlined\n                                                />\n                                                <label class=\"label font_14\">{{\n                                                        $t(\"employee\")\n                                                    }}</label>\n                                                <v-col\n                                                    sm=\"12\"\n                                                    cols=\"12\"\n                                                    class=\"kendo_dropdown_custom pl-0 pr-0 pb-3 pt-0\"\n                                                >\n                                                    <dropdownlist\n                                                        :data-items=\"employees\"\n                                                        @change=\"onEmployeeChanged\"\n                                                        :value=\"mEmployee\"\n                                                        :data-item-key=\"'id'\"\n                                                        :text-field=\"'name'\"\n                                                        :default-item=\"defaultItem\"\n                                                        :filterable=\"true\"\n                                                        @filterchange=\"onEmployeeFilterChanged\"\n                                                    >\n                                                    </dropdownlist>\n                                                </v-col>\n                                                <label class=\"label\">{{ $t(\"for_month_of\") }}</label>\n                                                <month-picker\n                                                    :initialMonth=\"monthOf\"\n                                                    @emitMonth=\"monthOf = $event\"\n                                                />\n                                            </v-col>\n                                        </v-row>\n                                        <v-divider/>\n                                        <v-row>\n                                            <v-col sm=\"12\" cols=\"12\" class=\"pt-1\">\n                                                <v-row>\n                                                    <v-col sm=\"12\" cols=\"12\">\n                                                        <label\n                                                            class=\"label text-bold text-uppercase\">{{\n                                                                $t('tnc_to_be_added')\n                                                            }}</label>\n                                                        <LoadingMe :isLoading=\"showLoadingTxn\" :fullPage=\"false\"\n                                                                   :myLoading=\"true\"\n                                                                   type=\"loading\"/>\n                                                        <v-row v-for=\"item in purchaseOrders\" v-bind:key=\"item.id\">\n                                                            <v-col sm=\"10\" cols=\"10\" class=\"py-0 pr-0\">\n                                                                <v-card\n                                                                    outlined\n                                                                    color=\"third\"\n                                                                    class=\"px-3 py-1 white--text no-boxshadow no_border justify-left d-flex\"\n                                                                    style=\" height: 38px\">\n                                                                    <p class=\"mb-0\" style=\"width: 100%\">\n                                                            <span\n                                                                class=\"pl-3 py-1 float-left\">{{\n                                                                    item.referenceNo\n                                                                }}</span>\n                                                                    </p>\n                                                                </v-card>\n                                                            </v-col>\n                                                            <v-col sm=\"2\" cols=\"2\" class=\"py-0  pl-1\">\n                                                                <v-btn\n                                                                    class=\"text-white text-bold float-right text-uppercase\"\n                                                                    outlined\n                                                                    icon\n                                                                    color=\"primary\"\n                                                                    style=\"height: 30px\"\n                                                                    @click=\"addPurchaseOrder(item)\">\n                                                                    <v-icon>mdi-plus</v-icon>\n                                                                </v-btn>\n                                                            </v-col>\n                                                        </v-row>\n                                                    </v-col>\n                                                </v-row>\n\n                                                <v-divider/>\n                                                <v-row v-if=\"expenses.length >0\">\n                                                    <v-col sm=\"12\" cols=\"12\">\n                                                        <div class=\"justify-space-between\">\n                                                            <label\n                                                                class=\"label lb_bold text-bold text-uppercase\">{{\n                                                                    $t('additional_cost')\n                                                                }}</label>\n                                                            <p class=\"mb-2\">{{ $t('total') }}:\n                                                                {{ numberFormat(additionalCostTotal) }}</p>\n                                                        </div>\n                                                        <label class=\"label mb-0\">{{ $t(\"method\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            :items=\"methods\"\n                                                            @change=\"onMethodChanged\"\n                                                            v-model=\"purchase.additionalCostMethod\"\n                                                            placeholder=\"Method\"\n                                                            return-object\n                                                            outlined\n                                                        />\n                                                        <LoadingMe :isLoading=\"showLoadingTxnAdditionalCost\"\n                                                                   :fullPage=\"false\"\n                                                                   :myLoading=\"true\"\n                                                                   type=\"loading\"/>\n                                                        <v-row v-for=\"(item,i) in expenses\" v-bind:key=\"item.id\">\n                                                            <v-col sm=\"10\" cols=\"10\" class=\"py-0 pr-0\">\n                                                                <v-card\n                                                                    outlined\n                                                                    color=\"third\"\n                                                                    class=\"px-2 py-2 white--text no-boxshadow d-flex justify-space-between no_border\"\n                                                                    style=\" height: 38px\">\n                                                                    <p class=\"ma-0 font_14\">\n                                                                        {{ item.referenceNo || '' }}</p>\n                                                                    <p class=\"ma-0 font_14\">\n                                                                        {{ numberFormat(item.exchangeAmount) || 0 }}</p>\n\n                                                                </v-card>\n                                                            </v-col>\n                                                            <v-col sm=\"2\" cols=\"1\" class=\"py-0  pl-1\">\n                                                                <v-checkbox class=\"ma-0\" v-model=\"chkChecked[i]\"\n                                                                            :value=\"item\"\n                                                                            :disabled=\"disableMe\"\n                                                                            @change=\"onCheckChanged(item)\"/>\n                                                            </v-col>\n                                                        </v-row>\n\n                                                        <!--                                                        <v-row>-->\n                                                        <!--                                                            <v-col sm=\"12\" cols=\"12\" class=\"py-0\">-->\n                                                        <!--                                                                <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">1.-->\n                                                        <!--                                                                    {{ $t('expenses') }}</label>-->\n                                                        <!--                                                            </v-col>-->\n                                                        <!--                                                            <v-col sm=\"8\" cols=\"8\" class=\"py-0 pr-0\">-->\n                                                        <!--                                                                <v-card outlined-->\n                                                        <!--                                                                        color=\"third\"-->\n                                                        <!--                                                                        class=\"px-3  white&#45;&#45;text py-1  no-boxshadow no_border justify-left d-flex\"-->\n                                                        <!--                                                                        style=\" height: 40px\">-->\n                                                        <!--                                                                    <input type=\"checkbox\"-->\n                                                        <!--                                                                           class=\"checkbox_inv float-left mt-2\"/>-->\n                                                        <!--                                                                </v-card>-->\n                                                        <!--                                                            </v-col>-->\n                                                        <!--                                                            <v-col sm=\"4\" cols=\"4\" class=\"py-0  pl-1\">-->\n                                                        <!--                                                                <v-select class=\" pl-3 exp_select\"-->\n                                                        <!--                                                                          :items=\"expense\"-->\n                                                        <!--                                                                          label=\"Equal\"-->\n                                                        <!--                                                                          outlined-->\n                                                        <!--                                                                />-->\n                                                        <!--                                                            </v-col>-->\n                                                        <!--                                                        </v-row>-->\n                                                    </v-col>\n                                                </v-row>\n                                            </v-col>\n                                        </v-row>\n                                    </div>\n                                    <p class=\"pa-3 mb-0 mt-20 detial_smallside_p font_14\">\n                                        {{ $t(\"credit_purchase_desc\") }}\n                                    </p>\n                                </v-col>\n                            </v-row>\n                        </v-form>\n                    </v-card>\n                </v-col>\n            </v-row>\n            <LoadingMe :isLoading=\"showLoading\" :fullPage=\"false\" :myLoading=\"true\"/>\n            <v-dialog v-model=\"dialogTax\" max-width=\"450px\">\n                <v-card>\n                    <div class=\"modal_header\">\n                        <v-card-title>{{ $t(\"tax_list\") }}</v-card-title>\n                        <v-icon @click=\"dialogTax = false\">close</v-icon>\n                    </div>\n                    <v-card-text class=\"modal_text_content\">\n                        <v-row>\n                            <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                <v-simple-table>\n                                    <template v-slot:default>\n                                        <tbody>\n                                        <tr\n                                            v-for=\"(value, name) in taxListTotal\"\n                                            v-bind:key=\"name\"\n                                        >\n                                            <td class=\"text-left\" width=\"180px\">{{ name }}</td>\n                                            <td class=\"text-center\">:</td>\n                                            <td class=\"text-right\">\n                                                {{ numberFormat(value) }}\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td class=\"text-left\" width=\"180px\">\n                                                {{ $t(\"total\") }}\n                                            </td>\n                                            <td class=\"text-center\">:</td>\n                                            <td class=\"text-right\">\n                                                {{ numberFormat(purchase.totalTaxAmount) }}\n                                            </td>\n                                        </tr>\n                                        </tbody>\n                                    </template>\n                                </v-simple-table>\n                            </v-col>\n                        </v-row>\n                    </v-card-text>\n                    <v-divider/>\n                </v-card>\n            </v-dialog>\n        </v-container>\n    </v-app>\n</template>\n\n<script>\n// import kendo from \"@progress/kendo-ui\"\nimport {i18n} from \"@/i18n\";\nimport PurchaseModel from \"@/scripts/purchase/model/Purchase\";\nimport ItemLineModel from \"@/scripts/purchase/model/ItemLine\";\nimport {uuid} from \"vue-uuid\";\nimport {DropDownList} from \"@progress/kendo-vue-dropdowns\";\nimport kendo from \"@progress/kendo-ui\";\nimport PurchaseFormContentModel from \"@/scripts/model/PurchaseFormContent\";\nimport {dataStore, ShowResource} from \"@/observable/store\";\nimport paymentTermHandler_ from \"@/scripts/paymentterm/handler/paymentTermHandler\";\nimport creditLimitHandler from \"@/scripts/creditLimit/handler/creditLimitHandler\";\nimport saleOrderHandler from \"@/scripts/transactionHandler\";\nimport Helper from \"@/helper\";\nimport settingsHandler from \"@/scripts/settingsHandler\";\n\nconst supplierHandler = require(\"@/scripts/supplierHandler\");\n// import kendo from \"@progress/kendo-ui\";\n\nconst projectHandler = require(\"@/scripts/projectHandler\");\nconst priceLevelHandler = require(\"@/scripts/priceLevelHandler\");\nconst currencyHandler = require(\"@/scripts/currency/handler/currencyHandler\");\n\n// const settingsHandler = require(\"@/scripts/settingsHandler\");\nconst employeeHandler = require(\"@/scripts/employeeHandler\");\nconst locationHandler = require(\"@/scripts/locationHandler\");\n// const paymentTermHandler = require(\"@/scripts/paymentTermHandler\");\nconst accountHandler = require(\"@/scripts/handler/accounting/account\");\nconst productVariantHandler = require(\"@/scripts/productVariantHandler\");\nconst uomPriceHandler = require(\"@/scripts/uomPriceHandler\");\nconst discountItemHandler = require(\"@/scripts/discountItemHandler\");\nconst settingHandler = require(\"@/scripts/settingHandler\");\nconst otherChargeHandler = require(\"@/scripts/otherChargeHandler\");\nconst purchaseFormContentHandler = require(\"@/scripts/purchaseFormContentHandler\");\nconst prefixHandler = require(\"@/scripts/prefixHandler\");\nconst billingHandler = require(\"@/scripts/invoice/handler/billingHandler\");\n\nconst purchaseModel = new PurchaseModel({});\nconst itemLineModel = new ItemLineModel({});\nconst purchaseFormContentModel = new PurchaseFormContentModel({});\nconst $ = kendo.jQuery\n\nconst textField = \"numberName\";\nconst keyField = \"id\";\nconst defaultItem = {[textField]: \"Select vendor...\", [keyField]: null};\nconst emptyItem = {[textField]: \"loading ...\"};\nconst pageSize = 10;\nconst itemLinePrefix = \"lin-\";\nconst loadingData = [];\nwhile (loadingData.length < pageSize) {\n    loadingData.push({...emptyItem});\n}\nconst {ClassEditor} = require(\"@/scripts/kendo_editor/Collections\");\nconst DISCOUNT_TYPE = \"?type=Purchase\";\nconst TRANSACTION_TYPE = \"Purchase\";\nconst cookieJS = require(\"@/cookie.js\");\nconst cookie = cookieJS.getCookie();\nconst NATURE = 'purchase'\nexport default {\n    name: \"CreditPurchase\",\n    props: [\"id\", \"transactionDate\"],\n    components: {\n        LoadingMe: () => import(`@/components/Loading`),\n        \"app-datepicker\": () => import(\"@/components/custom_templates/DatePickerComponent\"),\n        \"month-picker\": () => import(\"@/components/custom_templates/MonthPicker\"),\n        dropdownlist: DropDownList,\n    },\n    data: () => ({\n        isEdit: false,\n        showLoadingTxn: false,\n        showLoadingTxnAdditionalCost: false,\n        mOtherCharge: [],\n        mOtherChargeAmount: [],\n        purchaseOrders: [],\n        numSelect: [1],\n        dialogTax: false,\n        vendorList: [],\n        showLoading: false,\n        bill_date: \"\",\n        alert: false,\n        files: [],\n        // Form validation\n        valid: true,\n        itemLines: [],\n        txnDate: new Date().toISOString().substr(0, 10),\n        billDate: new Date().toISOString().substr(0, 10),\n        invoiceDate: new Date().toISOString().substr(0, 10),\n        monthOf: \"\",\n        templates: [\n            {title: \"Purchase\", value: \"Purchase\"},\n\n        ],\n        isHideBar: false,\n        vendor: {},\n        defaultItem: defaultItem,\n        purchase: purchaseModel,\n        transactionType: [\"Invoice\", \"Commercial Invoice\", \"Tax Invoice\"],\n        cusBaseUrl: supplierHandler.search(),\n        empBaseUrl: employeeHandler.search(),\n        init: {method: \"GET\", accept: \"application/json\", headers: []},\n        pendingRequest: undefined,\n        requestStarted: false,\n        skip: 0,\n        tempSkip: null,\n        total: 0,\n        filter: \"\",\n        referenceNo: \"\",\n        filter_: \"\",\n        textField: \"numberName\",\n        dataItemKey: \"id\",\n        segments: [],\n        employees: [],\n        methods: ['Qty Based', 'Amount Based'],\n        mEmployee: {},\n        customerProjects: [],\n        billingAddress: [],\n        deliveryAddress: [],\n        deliveryDateTime: new Date().toISOString().substr(0, 10),\n        priceLevel: [],\n        locations: [],\n        paymentTerms: [],\n        accPayable: [],\n        currencies: [],\n        itemLine: itemLineModel,\n        uoms: [],\n        tax: [],\n        specificDiscountItem: [],\n        otherChargeList: [],\n        depositBalance: 0,\n        schemaDefinition: {\n            model: {\n                id: \"id\",\n            },\n        },\n        purchaseFormContent: purchaseFormContentModel,\n        ClassEditor: ClassEditor,\n        taxListTotal: {},\n        purchaseTypes: [],\n        taxListDetail: [],\n        supplierDiscountItem: [],\n        lateFeeList: [],\n        loggedUser: {\n            id: cookie.creator,\n            name: cookie.email,\n        },\n        exchangeRate: {},\n        baseCurrencyCode: \"\",\n        currencyCode: \"\",\n        transactionRate: 1,\n        jRaw: [],\n        refFrom: [],\n        isPriceLevelChanged: false,\n        expenses: [],\n        additionalCostTotal: 0,\n        chkChecked: [],\n        accWithholdingExpense: []\n    }),\n    methods: {\n        dataBound: function (e) {\n            const grid = kendo.jQuery(\"#gridItemLine\").data(\"kendoGrid\");\n            const items = e.sender.items();\n            if (grid) {\n                items.each(function () {\n                    let dataItem = grid.dataItem(this);\n                    $(\"tr[data-uid='\" + dataItem.uid + \"']\").find('.isEditable')\n                        .each(function () {\n                            if (dataItem.isEditable === false) {\n                                $(this).addClass(\"k-state-disabled\");\n                            }\n                        });\n                });\n            }\n        },\n        onMethodChanged() {\n            if (this.isItem()) {\n                this.calculateAdditionalCost()\n                this.autoCalculate()\n            }\n        },\n        onCheckChanged() {\n            if (this.isItem()) {\n                this.additionalCostTotal = 0\n                this.jRaw = []\n                if (this.chkChecked) {\n                    this.chkChecked.forEach(m => {\n                        if (m) {\n                            const xAmount = m.exchangeAmount || 0\n                            this.additionalCostTotal += parseFloat(xAmount)\n                        }\n                    })\n                    this.purchase.additionalCost = this.chkChecked\n                    this.purchase.additionalCostTotal = this.additionalCostTotal\n                    // if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    //     this.percentageApplied()\n                    // } else {\n                    //     this.amountApplied()\n                    // }\n                    this.calculateAdditionalCost()\n                    this.autoCalculate()\n                }\n            }\n        },\n        onPriceLevelChange() {\n            this.isPriceLevelChanged = true\n            this.loadTransactionRate()\n            this.clearUOMItem()\n        },\n        async clearUOMItem() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            ds.data().map(n => {\n                n.set('uom', {})\n            })\n            this.isPriceLevelChanged = false\n        },\n        async loadPaymentTermList() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    if (this.vendor) {\n                        const strFilter = '?id=' + this.vendor.id + '&transactionDate=' + this.purchase.transactionDate + '&type=Vendor'\n                        this.purchase.paymentTerm = {}\n                        paymentTermHandler_.get(strFilter).then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const terms = res.data.data\n                                this.purchase.paymentTerm = terms.term\n                                this.onPaymentTermChanged()\n                            }\n                        });\n                    }\n                }, 10);\n            });\n        },\n        async loadCreditLimit() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    if (this.vendor) {\n                        const strFilter = '?id=' + this.vendor.id + '&transactionDate=' + this.purchase.transactionDate + '&type=Vendor'\n                        this.purchase.creditLimit = 0\n                        creditLimitHandler.get(strFilter).then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const credit = res.data.data\n                                this.purchase.creditLimit = kendo.parseFloat(credit.amount || 0);\n                            }\n                        });\n                    }\n                }, 10);\n            });\n        },\n        async observerClean(obj) {\n            return Object.keys(obj).reduce(\n                (res, e) => Object.assign(res, {[e]: obj[e]}),\n                {}\n            );\n        },\n        Help(key_search) {\n            ShowResource(key_search);\n        },\n        AmountEditor(container, options) {\n            kendo\n                .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoNumericTextBox({\n                    decimals: 30,\n                    format: `${this.purchaseFormContent.decimal}`,\n                });\n        },\n        vatTemplate(dataItem) {\n            const vat = dataItem.vatTax || {};\n            if (vat) {\n                return `<span>${vat.defaultTax ? vat.defaultTax : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        itemTemplate(dataItem) {\n            const item = dataItem.item;\n            if (item) {\n                return `<span>${item.name ? item.name : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        UOMTemplate(dataItem) {\n            const uom = dataItem.uom || {};\n            const code = uom.code || ''\n            if (uom) {\n                return `<span>${uom.uom ? code : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        discountItemTemplate(dataItem) {\n            const discountItem = dataItem.discountItem;\n            if (discountItem) {\n                return `<span>${discountItem.code ? discountItem.code : ``} - ${\n                    discountItem.name ? discountItem.name : ``\n                }</span>`;\n            } else {\n                return ``;\n            }\n        },\n        addSelect() {\n            let amount_num = this.numSelect.length;\n            let num = this.numSelect[amount_num - 1];\n            let new_num = num + 1;\n            let lenghtItem = this.specificDiscountItem.length;\n            if (new_num <= lenghtItem) {\n                this.numSelect.push(new_num);\n            }\n        },\n        removeSelect(index) {\n            this.numSelect.splice(index, 1);\n            // window.console.log(index, this.numSelect)\n            // this.selectDiscount.splice(index,1)\n            // window.console.log(\"remove\",this.selectDiscount)\n            // this.selectDiscount = this.selectDiscount.filter(item =>  item.id != val.id);\n        },\n        onOtherChargeChange() {\n            let otherCharge = 0;\n            this.mOtherCharge.forEach((m) => {\n                otherCharge += this.autoCalculateDiscount(m, this.purchase.subTotal);\n            });\n            this.purchase.otherChargeAmount = otherCharge;\n            this.autoCalculate();\n        },\n        onOtherAmount(value) {\n            return this.autoCalculateDiscount(value, this.purchase.subTotal);\n        },\n        onSpecificDiscountChanged() {\n            this.purchase.specificDiscountTotal = 0;\n            if (this.purchase.specificDiscountItem) {\n                // window.console.log('-changed', this.purchase.specificDiscountItem)\n                this.purchase.specificDiscountTotal =\n                    this.autoCalculateDiscount(\n                        this.purchase.specificDiscountItem,\n                        this.purchase.subTotal\n                    ) || 0;\n                this.purchase.total =\n                    kendo.parseFloat(this.purchase.subTotal) -\n                    (kendo.parseFloat(this.purchase.discountTotal) +\n                        kendo.parseFloat(this.purchase.totalTaxAmount)) -\n                    this.autoCalculateDiscount(\n                        this.purchase.specificDiscountItem,\n                        this.purchase.subTotal\n                    );\n            }\n            this.autoCalculate();\n        },\n        empImpl(dataItem) {\n            let empIds = [];\n            dataItem.employee.forEach((m) => {\n                empIds.push(m.firstName + \" - \" + m.lastName);\n            });\n            // window.console.log(empIds.join(', '))\n            return `<span>${empIds.join(\", \")}</span>`;\n        },\n        uomTmp(dataItem) {\n            window.console.log(dataItem);\n            return dataItem;\n        },\n        onInvoiceTypeChanged() {\n            if (this.$route.params.id === null || this.$route.params.id === \"\") {\n                this.generateNumber();\n            }\n        },\n        autoCalculateTaxByType(tax) {\n            // return by a key\n            const groupAll = (list) =>\n                list.reduce((tax, item) => {\n                    const taxAmount = tax[item.name] || 0;\n                    return Object.assign({}, tax, {\n                        [item.name]: taxAmount + parseFloat(item.amount),\n                    });\n                }, {});\n            this.taxListTotal = groupAll(tax);\n            window.console.log(\"nimol\", groupAll(tax));\n        },\n        onDepositDeductionChange() {\n            const deduct = parseFloat(this.purchase.depositDeduction || 0)\n            if (deduct < 0) {\n                this.purchase.depositDeduction = 0\n            }\n            if (this.purchase.depositDeduction === \"\" || this.purchase.depositDeduction === undefined) {\n                this.purchase.depositDeduction = 0;\n            }\n            const deduction = parseFloat(this.purchase.depositDeduction) || 0;\n            if (deduction > this.purchase.depositAmount) {\n                this.purchase.depositDeduction = this.purchase.depositAmount;\n            }\n\n            this.autoCalculate();\n        },\n        async autoCalculate() {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                subTotal = 0,\n                totalTax = 0,\n                discountTotal = 0,\n                spTax = 0,\n                pltax = 0,\n                otherTax = 0,\n                vatTax = 0,\n                discountInvoice = 0,\n                taxList = [],\n                taxListDetail = [],\n                discountItem = [],\n                discountLine = [],\n                inclusiveTax = 0,\n                taxTypeId = 0,\n                withholdingTaxAmount = 0,\n                whTaxAmount = 0,\n                itemSubtotal = 0,\n                txnItmSubtotal = 0,\n                serviceSubtotal = 0,\n                itemDiscount = 0,\n                serviceDiscount = 0,\n                txnDiscount = 0;\n            let nature = \"\";\n            this.jRaw = [];\n            const rows = ds.data().filter((m) => parseFloat(m.amount) > 0);\n            rows.forEach((value) => {\n                let modifierPrice = 0, incTax = 0;\n                if (value.modifier) {\n                    modifierPrice = kendo.parseFloat(value.modifier.price);\n                }\n\n                let discount = 0;\n                if (value.discountItem) {\n                    const disItemField = value.discountItem;\n                    let subTo =\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    discount = this.autoCalculateDiscount(value.discountItem, subTo);\n                    value[\"discountAmount\"] = discount;\n                    value[\"discountExchangeAmount\"] =\n                        discount * kendo.parseFloat(this.purchase.txnRate);\n                    if (value.discountItem.hasOwnProperty(\"id\")) {\n                        discountItem.push(value.discountItem);\n                    }\n                    discountTotal += discount ? discount : 0;\n                    if (discount * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (disItemField.account) {\n                        if (disItemField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: disItemField.account.id + \"-\" + nature,\n                                line: new ItemLineModel(value),\n                                description: \"Purchase Discount\",\n                                account: disItemField.account,\n                                accountId: disItemField.account.id,\n                                amount: discount * -1,\n                                exchangeAmount:\n                                    discount * kendo.parseFloat(this.purchase.txnRate) * -1,\n                                type: nature,\n                                typeAs: \"discount\",\n                            });\n                        }\n                    }\n                }\n                if (value.vatTax) {\n                    // window.console.log('Vat Tax', value.tax)\n                    let amt =\n                        kendo.parseFloat(spTax ? spTax : 0) +\n                        kendo.parseFloat(pltax ? pltax : 0) +\n                        kendo.parseFloat(otherTax ? otherTax : 0) +\n                        (kendo.parseFloat(value.amount ? value.amount : 0) -\n                            (discount ? discount : 0));\n                    vatTax = this.autoCalculateTax(value.vatTax, amt);\n                    vatTax = kendo.parseFloat(vatTax) ? kendo.parseFloat(vatTax) : 0;\n                    value[\"vatTaxAmount\"] = vatTax;\n                    value[\"vatTaxExchangeAmount\"] =\n                        vatTax * kendo.parseFloat(this.purchase.txnRate);\n                    const tax = value.vatTax || {};\n                    const baseAmount = tax.baseAmount || '';\n                    window.console.log(tax, \"im tax\");\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            incTax = vatTax\n                        } else {\n                            inclusiveTax += vatTax;\n                        }\n                    }\n                    if (value.vatTax.hasOwnProperty(\"taxType\")) {\n                        taxList.push({\n                            name: value.vatTax.taxType.name,\n                            amount: vatTax,\n                            id: value.vatTax.taxType.id,\n                        });\n                        const vatTax_ = value.vatTax || {}\n                        vatTax_['taxAmount_'] = vatTax\n                        vatTax_['amount'] = value.amount || 0\n                        vatTax_['discount'] = discount || 0\n                        vatTax_['txnRate'] = this.purchase.txnRate || 1\n                        vatTax_['isVat'] = 1\n                        vatTax_.detail = {\n                            specificTax: {},\n                            publicLightingTax: {},\n                            otherTax: {},\n                        }\n                        taxListDetail.push(vatTax_);\n                        window.console.log('vat_', vatTax_)\n                    }\n                    if (value.vatTax.hasOwnProperty(\"taxType\")) {\n                        const taxType = value.vatTax.taxType || {};\n                        taxTypeId = taxType.typeId || 0;\n                    }\n                    let taxAmount = vatTax;\n                    let taxDescription = \"\";\n                    if (taxTypeId === 1) {\n                        nature = \"dr\";\n                        taxAmount = vatTax;\n                        taxDescription = \"Purchase Tax\";\n                    } else if (taxTypeId === 2) {\n                        withholdingTaxAmount += vatTax;\n                        if (taxTypeId === 2 && baseAmount.toLowerCase() === 'net') {\n                            whTaxAmount += vatTax;\n                        }\n                        nature = \"cr\";\n                        taxAmount = vatTax * -1;\n                        taxDescription = \"Withholding Tax\";\n                    } else if (taxTypeId === 10) {\n                        nature = \"cr\";\n                        taxAmount = 0;\n                        taxDescription = \"No Tax\";\n                    }\n                    if (taxAmount > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    const vatTaxField = value.vatTax || {};\n                    if (taxAmount !== 0) {\n                        if (vatTaxField) {\n                            if (vatTaxField.account) {\n                                if (vatTaxField.account.hasOwnProperty(\"id\")) {\n                                    this.jRaw.push({\n                                        id: vatTaxField.account.id + \"-\" + nature,\n                                        line: new ItemLineModel(value),\n                                        description: taxDescription,\n                                        account: vatTaxField.account,\n                                        accountId: vatTaxField.account.id,\n                                        amount: taxAmount,\n                                        exchangeAmount:\n                                            taxAmount * kendo.parseFloat(this.purchase.txnRate),\n                                        type: nature,\n                                        typeAs: \"tax\",\n                                    });\n                                }\n                            }\n                        }\n                    }\n                }\n                totalTax += kendo.parseFloat(spTax ? spTax : 0) + kendo.parseFloat(pltax ? pltax : 0) +\n                    kendo.parseFloat(otherTax ? otherTax : 0) +\n                    kendo.parseFloat(vatTax ? vatTax : 0);\n                subTotal += kendo.parseFloat(value.amount) + modifierPrice - incTax;\n                const amount = kendo.parseFloat(value.amount) + modifierPrice;\n                const amt = this.excludeVATTaxInclusive(value.vatTax, amount, incTax)\n                // const xAmount = (kendo.parseFloat(amt) * kendo.parseFloat(this.purchase.txnRate))\n                const additc = value.additionalCost || 0\n                const itemAmount = amt\n                const itemXAmount = itemAmount * kendo.parseFloat(this.purchase.txnRate);\n\n                const item = value.item;\n                const itmType = item.type || \"\";\n                if (itmType === \"Variant\") {\n                    itemSubtotal +=\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    itemDiscount += kendo.parseFloat(discount);\n                } else if (itmType === \"Service\") {\n                    serviceSubtotal +=\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    serviceDiscount += kendo.parseFloat(discount);\n                } else {\n                    txnItmSubtotal +=\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    txnDiscount += kendo.parseFloat(discount);\n                }\n                if (amt > 0) {\n                    nature = \"dr\";\n                } else {\n                    nature = \"cr\";\n                }\n                if (item) {\n                    if (item.type === \"Service\") {\n                        const plan = item.isPan || false;\n                        if (plan) {\n                            if (item.hasOwnProperty(\"deferredIncomeAcc\")) {\n                                if (item.deferredIncomeAcc.hasOwnProperty(\"id\")) {\n                                    let deferredInAcc = item.deferredIncomeAcc;\n                                    this.jRaw.push({\n                                        id: deferredInAcc.id + \"-\" + nature,\n                                        line: new ItemLineModel(value),\n                                        description: this.purchase.journalNote,\n                                        account: deferredInAcc,\n                                        accountId: deferredInAcc.id,\n                                        amount: itemAmount * -1, // qty*avg_cost ,\n                                        exchangeAmount: itemXAmount, //,\n                                        type: nature,\n                                        typeAs: \"item\",\n                                    });\n                                }\n                            }\n                        } else {\n                            if (item.hasOwnProperty(\"costOfGoodsSoldAcc\")) {\n                                if (item.costOfGoodsSoldAcc.hasOwnProperty(\"id\")) {\n                                    let costOfGoodsSoldAcc = item.costOfGoodsSoldAcc;\n                                    this.jRaw.push({\n                                        id: costOfGoodsSoldAcc.id + \"-\" + nature,\n                                        line: new ItemLineModel(value),\n                                        description: this.purchase.journalNote,\n                                        account: item.costOfGoodsSoldAcc,\n                                        accountId: item.costOfGoodsSoldAcc.id,\n                                        amount: itemAmount, // qty*avg_cost ,\n                                        exchangeAmount: itemXAmount, //xAmount,\n                                        type: nature,\n                                        typeAs: \"item\",\n                                    });\n                                }\n                            }\n                        }\n                    } else if (item.type === \"Variant\") {\n                        const amountWithAddict = (itemAmount + (value.amountApplied || 0))\n                        window.console.log('additc', additc, '-', itemAmount)\n                        if (item.hasOwnProperty(\"inventoryAcc\")) {\n                            if (item.inventoryAcc.hasOwnProperty(\"id\")) {\n                                let inventoryAcc = item.inventoryAcc;\n                                this.jRaw.push({\n                                    id: inventoryAcc.id + \"-\" + nature,\n                                    line: new ItemLineModel(value),\n                                    description: this.purchase.journalNote,\n                                    account: item.inventoryAcc,\n                                    accountId: item.inventoryAcc.id,\n                                    amount: amountWithAddict, // qty*avg_cost ,\n                                    exchangeAmount: amountWithAddict * (this.purchase.txnRate || 1), //xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    } else if (item.type === \"Fixed Asset\") {\n                        if (item.hasOwnProperty(\"assetAcc\")) {\n                            if (item.assetAcc.hasOwnProperty(\"id\")) {\n                                let assetAcc = item.assetAcc;\n                                this.jRaw.push({\n                                    id: assetAcc.id + \"-\" + nature,\n                                    line: new ItemLineModel(value),\n                                    description: this.purchase.journalNote,\n                                    account: item.assetAcc,\n                                    accountId: item.assetAcc.id,\n                                    amount: itemAmount, // qty*avg_cost ,\n                                    exchangeAmount: itemXAmount, //xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    } else if (item.type === \"Transaction Item\") {\n                        if (item.hasOwnProperty(\"account\")) {\n                            if (item.account.hasOwnProperty(\"id\")) {\n                                this.jRaw.push({\n                                    id: item.account.id + \"-\" + nature,\n                                    line: new ItemLineModel(value),\n                                    description: this.purchase.journalNote,\n                                    account: item.account,\n                                    accountId: item.account.id,\n                                    amount: itemAmount, // qty*avg_cost ,\n                                    exchangeAmount: itemXAmount, //xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    }\n                }\n                //include Tax Amount\n                const amountNodiscount = kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty) - discount;\n                const includeTaxAmount = amountNodiscount + vatTax + pltax + spTax + otherTax;\n                value[\"includeTaxAmount\"] = includeTaxAmount;\n                value[\"includeTaxExchangeAmount\"] = includeTaxAmount * kendo.parseFloat(this.purchase.txnRate);\n            });\n            //todo: WithholdingTax expense\n            this.withholdingExpense(whTaxAmount, this.purchase.txnRate || 1)\n\n            this.purchase.itemSubtotal = itemSubtotal;\n            this.purchase.inclusiveTaxAmount = inclusiveTax;\n            this.purchase.exchangeItemSubtotal = itemSubtotal * kendo.parseFloat(this.purchase.txnRate);\n\n            this.purchase.serviceSubtotal = serviceSubtotal;\n            this.purchase.exchangeServiceSubtotal =\n                serviceSubtotal * kendo.parseFloat(this.purchase.txnRate);\n            this.purchase.txnItmSubtotal = txnItmSubtotal;\n            this.purchase.exchangeTxnItmSubtotal =\n                txnItmSubtotal * kendo.parseFloat(this.purchase.txnRate);\n\n            this.purchase.itemDiscount = itemDiscount;\n            this.purchase.exchangeItemDiscount =\n                itemDiscount * kendo.parseFloat(this.purchase.txnRate);\n            this.purchase.serviceDiscount = serviceDiscount;\n            this.purchase.exchangeServiceDiscount =\n                serviceDiscount * kendo.parseFloat(this.purchase.txnRate);\n            this.purchase.txnItmDiscount = txnDiscount;\n            this.purchase.exchangeTxnItmDiscount =\n                txnDiscount * kendo.parseFloat(this.purchase.txnRate);\n\n            let total =\n                kendo.parseFloat(subTotal) -\n                kendo.parseFloat(discountTotal) +\n                kendo.parseFloat(totalTax);\n            this.purchase.subTotal = subTotal;\n            this.purchase.totalTaxAmount = kendo.parseFloat(totalTax);\n            this.purchase.discountTotal = kendo.parseFloat(discountTotal);\n            if (this.purchase.specificDiscountItem) {\n                discountInvoice = this.autoCalculateDiscount(\n                    this.purchase.specificDiscountItem,\n                    kendo.parseFloat(subTotal)\n                );\n                discountInvoice = discountInvoice ? discountInvoice : 0;\n            }\n            // this.onOtherChargeChange()\n            this.purchase.total = kendo.parseFloat(total) - discountInvoice + kendo.parseFloat(this.purchase.otherChargeAmount) //- parseFloat(withholdingTaxAmount);\n            this.purchase.withholdingTaxAmount = withholdingTaxAmount\n            // this.purchase.totalAfterWithholdingTax = kendo.parseFloat(this.purchase.total) - parseFloat(withholdingTaxAmount);\n            this.purchase.remainingAmount = kendo.parseFloat(this.purchase.total) - kendo.parseFloat(this.purchase.depositDeduction) - parseFloat(withholdingTaxAmount);\n            this.purchase.amountDue = kendo.parseFloat(this.purchase.total) - kendo.parseFloat(this.purchase.depositDeduction) - parseFloat(withholdingTaxAmount);\n            this.purchase.exchangeAmount =\n                kendo.parseFloat(this.purchase.amountDue) *\n                kendo.parseFloat(this.purchase.txnRate);\n            // window.console.log('Exchange Amount', this.purchase.exchangeAmount, this.purchase.amountDue)\n            this.autoCalculateTaxByType(taxList);\n            if (this.purchase.specificDiscountItem) {\n                const specificDiscount = this.purchase.specificDiscountItem || {};\n                if (specificDiscount.id) {\n                    discountItem.push(specificDiscount);\n                    discountLine.push({\n                        id: specificDiscount.id,\n                        name: specificDiscount.name,\n                        amount: this.purchase.specificDiscountTotal,\n                        exchangeAmount:\n                            this.purchase.specificDiscountTotal * this.purchase.txnRate,\n                    });\n                }\n            }\n            const uniqueDiscountItem = this.removeDuplicate(discountItem);\n            this.shrinkDiscountItem(uniqueDiscountItem, discountLine);\n            // window.console.log('discount ', this.customerDiscountItem)\n            // todo: raw Journal\n            const apAcc = this.purchase.apAcc || {};\n            if (this.purchase.amountDue * -1 > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            if (apAcc) {\n                if (apAcc.hasOwnProperty(\"id\")) {\n                    this.jRaw.push({\n                        id: apAcc.id + \"-\" + nature,\n                        line: new ItemLineModel({}),\n                        description: this.purchase.journalNote,\n                        account: apAcc,\n                        accountId: apAcc.id,\n                        exchangeAmount: this.purchase.exchangeAmount * -1,\n                        amount: this.purchase.amountDue * -1,\n                        type: nature,\n                        typeAs: \"ap\",\n                    });\n                }\n            }\n            const specificDisc = this.purchase.specificDiscountItem;\n            if (this.purchase.specificDiscountTotal * -1 > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            // window.console.log(specificDisc, 'specificDisc', this.purchase.specificDiscountTotal)\n            if (specificDisc) {\n                if (specificDisc.hasOwnProperty(\"account\")) {\n                    if (specificDisc.account) {\n                        if (specificDisc.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: specificDisc.account.id + \"-\" + nature,\n                                line: new ItemLineModel({}),\n                                description: \"Purchase Discount\",\n                                account: specificDisc.account,\n                                accountId: specificDisc.account.id,\n                                exchangeAmount:\n                                    kendo.parseFloat(this.purchase.specificDiscountTotal) *\n                                    kendo.parseFloat(this.purchase.txnRate) *\n                                    -1,\n                                amount: this.purchase.specificDiscountTotal * -1,\n                                type: nature,\n                                typeAs: \"discount\",\n                            });\n                        }\n                    }\n                }\n            }\n\n            if (this.purchase.depositDeduction * -1 > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            if (this.purchase.depositDeduction) {\n                if (this.purchase.depositDeduction > 0) {\n                    const purchaseDepositAcc = this.vendor.purchaseDepositAcc || {};\n                    if (purchaseDepositAcc) {\n                        if (purchaseDepositAcc.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: purchaseDepositAcc.id + \"-\" + nature,\n                                description: \"Purchase Deposit\",\n                                line: new ItemLineModel({}),\n                                account: purchaseDepositAcc,\n                                accountId: purchaseDepositAcc.id,\n                                exchangeAmount: this.purchase.exchangeDepositDeduction * -1,\n                                amount: this.purchase.depositDeduction * -1,\n                                type: nature,\n                                typeAs: \"deposit\",\n                            });\n                        }\n                    }\n                }\n            }\n            if (this.mOtherCharge.length > 0) {\n                let otherCharge = 0;\n                this.mOtherCharge.forEach((m) => {\n                    otherCharge = this.autoCalculateDiscount(m, this.purchase.subTotal);\n                    if (otherCharge > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (m) {\n                        if (m.hasOwnProperty(\"account\")) {\n                            if (m.account.hasOwnProperty(\"id\")) {\n                                const account = m.account;\n                                if (account) {\n                                    if (account.hasOwnProperty(\"id\")) {\n                                        this.jRaw.push({\n                                            id: account.id + \"-\" + nature,\n                                            line: new ItemLineModel({}),\n                                            description: \"Other Charge\",\n                                            account: account,\n                                            accountId: account.id,\n                                            exchangeAmount:\n                                                otherCharge * kendo.parseFloat(this.purchase.txnRate),\n                                            amount: otherCharge,\n                                            type: nature,\n                                            typeAs: \"otherCharge\",\n                                        });\n                                    }\n                                }\n                            }\n                        }\n                    }\n                });\n                // this.purchase.otherChargeAmount = otherCharge\n                window.console.log(this.mOtherCharge);\n            }\n            this.taxListDetail = taxListDetail\n            this.autoCalculateTaxDetail()\n            // todo: end raw Journal\n            // window.console.log(JSON.stringify(this.purchase), 'purchase')\n\n            await this.calculateAdditionalCost()\n            // todo: cook journal\n            this.shrinkData(this.jRaw);\n            // const unique = this.removeDuplicate(this.accounts)\n            // window.console.log(unique, 'unique')\n        },\n        withholdingExpense(amount, txnRate) {\n            // if (this.isItem()) {\n            if (amount > 0) {\n                const nature = 'dr'\n                const account = this.accWithholdingExpense || []\n                if (account.length > 0) {\n                    const iacc = account[0]\n                    this.jRaw.push({\n                        id: iacc.id + \"-\" + nature,\n                        line: new ItemLineModel({}),\n                        description: \"Withholding Tax Expense\",\n                        account: iacc,\n                        accountId: iacc.id,\n                        exchangeAmount: amount * txnRate,\n                        amount: amount,\n                        type: nature,\n                        typeAs: \"Withholding\",\n                    });\n                }\n            }\n            // }\n        },\n        shrinkData(obj) {\n            const uniques = this.removeDuplicate(\n                obj\n            ); /*[...new Set(accountId.map(i => {\n                return {\n                    id_: i.id_,\n                    id: i.id,\n                    type: i.type\n            }))]*/\n            uniques.forEach((n) => {\n                const found = obj.filter((m) => m.id === n.id);\n                let amount = 0;\n                found.forEach((z) => {\n                    amount += parseFloat(z.amount || 0);\n                });\n                n.amount = parseFloat(amount); //this.numberFormat(amount)\n                n.exchangeAmount = parseFloat(\n                    parseFloat(amount * parseFloat(this.purchase.txnRate))\n                ); //this.numberFormat(amount * parseFloat(this.purchase.txnRate)) //.toFixed(this.saleFormContent.decimal)\n            });\n            this.jRaw = uniques;\n            let dr = 0,\n                cr = 0;\n            this.jRaw.forEach((j) => {\n                switch (j.type) {\n                    case \"cr\":\n                        cr += parseFloat(j.exchangeAmount);\n                        break;\n                    case \"dr\":\n                        dr += parseFloat(j.exchangeAmount);\n                        break;\n                    default:\n                        break;\n                }\n            });\n            this.purchase.dr = dr;\n            this.purchase.cr = cr;\n            window.console.log(\"dr=\", dr, \"cr=\", cr, \"dr+cr = \", dr + cr);\n            window.console.log(JSON.stringify(uniques), 'uniques')\n        },\n        shrinkDiscountItem(discountItem, discountLine) {\n            let uniqueDiscountItems = [];\n            const unique = this.removeDuplicate(discountItem);\n            unique.forEach((m) => {\n                const found = discountLine.filter((n) => n.id === m.id);\n                let amount = 0,\n                    exchangeAmount = 0;\n                found.map((o) => {\n                    amount += o.amount;\n                });\n                found.map((o) => {\n                    exchangeAmount += o.exchangeAmount;\n                });\n                uniqueDiscountItems.push({\n                    id: m.id,\n                    name: m.name,\n                    amount: amount,\n                    exchangeAmount: exchangeAmount,\n                });\n            });\n            this.supplierDiscountItem = uniqueDiscountItems;\n            window.console.log(uniqueDiscountItems, \"uniqueDiscountItems\");\n        },\n        removeDuplicate(array) {\n            const result = [];\n            const map = new Map();\n            for (const item of array) {\n                if (!map.has(item.id)) {\n                    map.set(item.id, true); // set any value to Map\n                    result.push(item);\n                }\n            }\n            return result;\n        },\n        numberFormat(value) {\n            // window.console.log(this.saleFormContent.decimal,'nimol')\n            return kendo.toString(value, `n${this.purchaseFormContent.decimal}`);\n        },\n        autoCalculateDiscount(discountItem, subTotal) {\n            if (discountItem) {\n                const nature = discountItem.nature || ''\n                const amount = discountItem.amount || 0\n                if (nature === 'Amount') {\n                    return parseFloat(amount)\n                } else if (nature === 'Percentage') {\n                    return (subTotal * (parseFloat(amount) / 100))\n                } else {\n                    return 0\n                }\n            } else {\n                return 0\n            }\n        },\n        autoCalculateTax(tax, amount) {\n            if (tax) {\n                var formula = tax.formula;\n                var inAmt = kendo.parseFloat(amount);\n                var nAmt = kendo.parseFloat(amount);\n                var taxBase = kendo.parseFloat(tax.taxBase) / 100;\n                var rate = kendo.parseFloat(tax.rate) / 100;\n                var total = eval(formula);\n                window.console.log(inAmt, nAmt, taxBase, rate, formula, total);\n                return total;\n            }\n            // return 0\n        },\n        taxMapping(objTax, tax) {\n            const taxId = tax.id || ''\n            const tax_ = objTax.filter(t => t.id === taxId)[0]\n            return tax_ || {\n                id: '',\n                defaultTax: ''\n            }\n        },\n        dataSourceChanged(e) {\n            if (e.field) {\n                let dataRow = e.items[0],\n                    buom = {}, vTax = {},\n                    conversionRate = 1,\n                    wac = 0,\n                    qoh = 0,\n                    amount = 0,\n                    xAmount = 0;\n                switch (e.field) {\n                    case \"item\":\n                        // this.attribute_ = this.attributes.filter(m => m.type.id === dataRow.variant.id)\n                        dataRow.set(\"description\", dataRow.item.description);\n                        buom = dataRow.item.uom || {};\n                        dataRow.set(\"buom\", buom);\n                        // dataRow.set('uom', buom)\n                        // window.console.log(dataRow.item,'row')\n                        // await this.inventoryBalance(dataRow, dataRow.item.id)\n                        break;\n                    case \"cost\":\n                        try {\n                            amount = parseFloat(dataRow.cost) * parseFloat(dataRow.qty);\n                            xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                            dataRow.set(\"cost\", parseFloat(dataRow.cost));\n                            dataRow.set(\"amount\", amount);\n                            dataRow.set(\"exchangeAmount\", xAmount);\n                            // window.console.log('price',dataRow.price)\n                        } catch {\n                            dataRow.set(\"cost\", 0);\n                            dataRow.set(\"amount\", 0);\n                            dataRow.set(\"exchangeAmount\", 0);\n                        }\n                        break;\n                    case \"uom\":\n                        if (this.isPriceLevelChanged === false) {\n                            try {\n                                if (dataRow.uom) {\n                                    buom = dataRow.uom.buom || {};\n                                    qoh = dataRow.uom.qoh || 0;\n                                    conversionRate = dataRow.uom.conversionRate || 1;\n                                    wac = dataRow.uom.wac || 0;\n                                    dataRow.set(\"buom\", buom);\n                                    dataRow.set(\"wac\", wac);\n                                    dataRow.set(\"qoh\", qoh);\n                                    /* todo: mapping tax object */\n                                    vTax = this.taxMapping(this.tax, dataRow.uom.purchaseTax || {})\n\n                                    dataRow.set(\"vatTax\", vTax);\n                                    dataRow.set(\"conversionRate\", parseFloat(conversionRate));\n                                    if (dataRow.uom) {\n                                        amount =\n                                            parseFloat(dataRow.uom.cost) * parseFloat(dataRow.qty);\n                                        xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                                        dataRow.set(\"cost\", parseFloat(dataRow.uom.cost));\n                                        dataRow.set(\"amount\", amount);\n                                        dataRow.set(\"exchangeAmount\", xAmount);\n                                    } else {\n                                        amount = parseFloat(dataRow.cost) * parseFloat(dataRow.qty);\n                                        xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                                        dataRow.set(\"cost\", parseFloat(dataRow.cost));\n                                        dataRow.set(\"amount\", amount);\n                                        dataRow.set(\"exchangeAmount\", xAmount);\n                                    }\n                                }\n                            } catch (err) {\n                                window.console.log(\"error\", err);\n                                dataRow.set(\"buom\", {});\n                                dataRow.set(\"conversionRate\", 1);\n                                dataRow.set(\"cost\", 0);\n                                dataRow.set(\"qoh\", 0);\n                                dataRow.set(\"wac\", 0);\n                                dataRow.set(\"amount\", 0);\n                                dataRow.set(\"exchangeAmount\", 0);\n                            }\n                        }\n                        break;\n                    case \"qty\":\n                        try {\n                            amount = parseFloat(dataRow.cost) * parseFloat(dataRow.qty);\n                            xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                            dataRow.set(\"cost\", parseFloat(dataRow.cost));\n                            dataRow.set(\"amount\", amount);\n                            dataRow.set(\"exchangeAmount\", xAmount);\n                        } catch {\n                            dataRow.set(\"cost\", 0);\n                            dataRow.set(\"amount\", 0);\n                            dataRow.set(\"exchangeAmount\", 0);\n                        }\n                        break;\n                    case \"otherTax\":\n                        // window.console.log(\"--\", dataRow)\n                        break;\n                    default:\n                        break;\n                }\n                if (e.field) {\n                    this.autoCalculate();\n                    window.console.log('dataRow', dataRow)\n                }\n            }\n        },\n        ServiceDateEditor(container, options) {\n            kendo\n                .jQuery('<input required name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDatePicker();\n\n            // let ds = this.$refs.itemLineDS.kendoWidget()\n            // window.console.log(ds.data())\n            // // const dateString = kendo.toString((new Date(options.model.items.serviceDate)), this.itemLine.dateFormat)\n            // // const dateString = kendo.toString(options.model.items.serviceDate)\n            // const $input = $(\"<input value=\" + options.model.serviceDate + \" />\").appendTo(container)\n            // $input.kendoDatePicker()\n            // // $input.appendTo(container)\n            // // options.model.items.serviceDate = dateString\n            // window.console.log($input)\n        },\n        ServiceDateToEditor(container, options) {\n            kendo\n                .jQuery('<input required name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDatePicker();\n        },\n        ItemDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Items </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: productVariantHandler.itemSearchURL(),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                        // data: this.variants\n                    }),\n                });\n        },\n        UOMDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"code\",\n                    dataValueField: \"uomConvertId\",\n                    cascadeFrom: \"item\",\n                    template: \"<span>#=code || ``#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: uomPriceHandler.uomPriceByPriceLevelURL(\n                                    \"id=\" +\n                                    options.model.item.id +\n                                    \"&plId=\" +\n                                    this.purchase.priceLevel.id +\n                                    \"&date=\" +\n                                    this.txnDate + \"&nature=purchase\"\n                                ),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    // name: {type: \"string\"},\n                                    // sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                        // data: this.variants\n                    }),\n                });\n        },\n        DiscountItemDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    cascadeFrom: \"item\",\n                    template: \"<span>#=code# - #=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: discountItemHandler.getURL(DISCOUNT_TYPE),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    // name: {type: \"string\"},\n                                    // sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        VatTaxDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"defaultTax\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=defaultTax#</span>\",\n                    optionLabel: \"--Select--\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.tax,\n                    }),\n                });\n        },\n        EmployeeDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoMultiSelect({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    suggest: true,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Employee </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: employeeHandler.searchURL(),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    firstName: {type: \"string\"},\n                                    lastName: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        rowNumberTmpl(dataItem) {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                index = ds.indexOf(dataItem);\n            return index + 1;\n        },\n        addRow() {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                total = ds.total();\n            this.itemLine.id = itemLinePrefix + uuid.v1();\n            this.itemLine.decimalFormat = \"n\" + this.purchaseFormContent.decimal;\n            this.itemLine.isEditable = true;\n            ds.insert(total, this.itemLine);\n\n            // kendo.jQuery().addClass('edit')\n            // this.itemLines.push(this.itemLine)\n            // window.console.log('item Line', this.itemLine)\n        },\n        onPaymentTermChanged() {\n            // this.onInvoiceDateChanged();\n            if (this.vendor) {\n                const paymentTerm = this.purchase.paymentTerm || {}\n                const netDue = paymentTerm.netDue || 0;\n                const someDate = new Date(this.purchase.transactionDate);\n                someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n                this.purchase.dueDate = someDate;\n                // window.console.log(\"im\", someDate, netDue);\n            }\n        },\n        async onInvoiceDateChanged() {\n            await this.loadPaymentTermList();\n            await this.loadCreditLimit();\n            await this.loadCustomerBalance(this.vendor.id);\n            await this.onPriceLevelChange();\n\n            this.monthOf = kendo.toString(new Date(this.txnDate), 'yyyy-MM')\n            // if (this.vendor) {\n            //     if (this.purchase.hasOwnProperty(\"paymentTerm\")) {\n            //         if (this.purchase.paymentTerm.hasOwnProperty(\"netDue\")) {\n            //             const netDue = this.purchase.paymentTerm.netDue;\n            //             const someDate = new Date(this.txnDate);\n            //             someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n            //             this.purchase.dueDate = someDate.toISOString().substr(0, 10);\n            //             // window.console.log('im', someDate, netDue)\n            //         }\n            //     }\n            // }\n            if (this.$route.params.id === undefined) {\n                this.generateNumber();\n            }\n            this.loadTransactionRate();\n        },\n        async loadPrefix() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    prefixHandler.get(\"purchase\").then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoading = false;\n                            this.purchaseTypes = res.data.data;\n                            if (this.purchaseTypes.length > 0) {\n                                this.purchase.transactionType = this.purchaseTypes[0];\n                                if (this.$route.params.id === undefined) {\n                                    this.generateNumber();\n                                }\n                            }\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadPriceLevel() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = '?&nature=' + NATURE\n                    priceLevelHandler.get(strFilter).then((res) => {\n                        this.priceLevel = res;\n                        if (this.priceLevel.length > 0) {\n                            this.purchase.priceLevel = this.priceLevel[0];\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadDiscountItem() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    discountItemHandler.list(DISCOUNT_TYPE).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.specificDiscountItem = res.data.data;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadOtherCharge() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    otherChargeHandler.list().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.otherChargeList = res.data.data;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadAccount() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    accountHandler.getAll().then((res) => {\n                        this.showLoading = false;\n                        //Receivable Account\n                        this.accPayable = res.data\n                            .filter((m) => m.account_type.number === 18)\n                            .map((itm) => {\n                                return {\n                                    id: itm.uuid,\n                                    uuid: itm.uuid,\n                                    name: itm.name,\n                                    local_name: itm.local_name,\n                                    number: itm.number,\n                                    is_taxable: itm.is_taxable,\n                                    banhjiAccCode: itm.banhjiAccCode,\n                                    group_code: itm.group_code,\n                                    parent_account: itm.parent_account,\n                                    type_code: itm.type_code,\n                                    account_type: itm.account_type,\n                                };\n                            });\n                        if (this.accPayable.length > 0) {\n                            this.purchase.apAcc = this.accPayable[0];\n                        }\n                        this.accWithholdingExpense = res.data\n                            .filter((m) => parseInt(m.banhjiAccCode) === 843000)\n                            .map((itm) => {\n                                return {\n                                    id: itm.uuid,\n                                    uuid: itm.uuid,\n                                    name: itm.name,\n                                    local_name: itm.local_name,\n                                    number: itm.number,\n                                    is_taxable: itm.is_taxable,\n                                    banhjiAccCode: itm.banhjiAccCode,\n                                    group_code: itm.group_code,\n                                    parent_account: itm.parent_account,\n                                    type_code: itm.type_code,\n                                    account_type: itm.account_type,\n                                };\n                            });\n                    });\n                }, 10);\n            });\n        },\n        async loadPaymentTerm() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = \"?type=pmt-supplier\";\n                    this.paymentTerms = []\n                    settingsHandler.getPaymentTerm(strFilter).then((res) => {\n                        this.showLoading = false;\n                        this.paymentTerms = res.data.data;\n                        if (this.paymentTerms.length > 0) {\n                            this.purchase.paymentTerm = this.paymentTerms[0];\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadLocation() {\n            this.locations = []\n            const roleType = dataStore.roleType || 0\n            window.console.log(' const roleType = dataStore.roleType || 0', dataStore)\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const location = roleData.filter(itm => itm.type === 'location')\n                    const locationDefault = location.filter(m => m.isDefault === 1)\n                    this.locations = location\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        if (locationDefault.length > 0) {\n                            this.purchase.location = locationDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.locations = [];\n                        locationHandler\n                            .list()\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.locations = res.data.data;\n                                } else {\n                                    this.showLoading = false;\n                                }\n                            })\n                    }, 10);\n                });\n            }\n\n        },\n        async loadProjectByCustomer() {\n            this.customerProjects = []\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const project = roleData.filter(itm => itm.type === 'project')\n                    this.customerProjects = project\n                    // project.forEach(k => {\n                    //     const customers = k.customers || []\n                    //     const proCustomer = customers.filter(n => n.customer.id === this.customer.id)\n                    //     if (proCustomer.length > 0) {\n                    //         this.customerProjects.push(k)\n                    //     }\n                    // })\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        const projectDefault = this.customerProjects.filter(m => m.isDefault === 1)\n                        if (projectDefault.length > 0) {\n                            this.purchase.project = projectDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        if (this.vendor) {\n                            // projectHandler.getBySupplier(this.vendor.id).then(res => {\n                            projectHandler\n                                .list()\n                                .then((res) => {\n                                    if (res.data.statusCode === 200) {\n                                        this.showLoading = false;\n                                        this.customerProjects = res.data.data;\n                                        // if (this.customerProjects.length > 0) {\n                                        //     this.purchase.project = this.customerProjects[0];\n                                        // }\n                                    } else {\n                                        this.showLoading = false;\n                                    }\n                                })\n                        }\n                    }, 10);\n                });\n            }\n        },\n        async loadCustomerBalance(id) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = id + \"?type=bal\";\n                    this.purchase.currentBalance = 0;\n                    billingHandler\n                        .balance(strFilter)\n                        .then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const data = res.data.data;\n                                if (data.length > 0) {\n                                    this.purchase.currentBalance = data[0].balance;\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        async loadCustomerDepositBalance(id) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = id + \"?type=dep\";\n                    this.purchase.depositAmount = 0;\n                    this.purchase.depositDeduction = 0;\n                    billingHandler\n                        .balance(strFilter)\n                        .then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const data = res.data.data;\n                                if (data.length > 0) {\n                                    const amountDeposit = data[0].balance;\n                                    window.console.log(amountDeposit, \"bala\");\n                                    this.purchase.depositAmount =\n                                        amountDeposit / this.purchase.txnRate;\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        creditLimitUsage(balance, creditLimit) {\n            return (\n                kendo.toString(\n                    (balance / creditLimit) * 100,\n                    `n${this.purchaseFormContent.decimal}`\n                ) + \" %\"\n            );\n        },\n        async loadEmployeeCenter() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.employees = [];\n                    employeeHandler\n                        .center(undefined)\n                        .then((res) => {\n                            this.showLoading = true;\n                            if (res.data.statusCode === 200) {\n                                this.showLoading = false;\n                                this.employees = res.data.data;\n                                if (this.employees.length > 0) {\n                                    this.purchase.employee = this.employees[0];\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        async loadSegment() {\n            this.segments = []\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const segment = roleData.filter(itm => itm.type === 'segment')\n                    const segmentDefault = segment.filter(m => m.isDefault === 1)\n                    this.segments = segment\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        if (segmentDefault.length > 0) {\n                            this.purchase.segment = segmentDefault[0];\n                            window.console.log('dataStore--segmentDefault', segmentDefault)\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.segments = [];\n                        settingsHandler\n                            .getSeg()\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.segments = res.data.data;\n                                }\n                            })\n                    }, 10);\n                });\n            }\n        },\n        async loadTax() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    settingHandler.get().then((res) => {\n                        const taxes = res;\n                        this.tax = taxes.filter(\n                            (m) =>\n                                (m.taxType.typeId === 1 ||\n                                    m.taxType.typeId === 10 ||\n                                    m.taxType.typeId === 2) &&\n                                m.transactionType === \"Purchase\"\n                        ); // valuable tax\n                    });\n                }, 10);\n            });\n        },\n        async onSaveClose(saveSend) {\n            if (!this.$refs.form.validate()) {\n                this.$refs.form.validate();\n                return;\n            }\n            if (this.transactionRate === 0) {\n                this.$snotify.error(i18n.t(\"set_exchange_rate\"));\n                return;\n            }\n\n            let id = \"\";\n            if (this.vendor.hasOwnProperty(\"id\")) {\n                id = this.vendor.id || \"\";\n            }\n            if (id === \"\") {\n                this.$snotify.error(\"vendor is required\");\n                return;\n            }\n            if (this.purchase.billNo == \"\") {\n                this.$snotify.error(\"Vendor Invoice No is required\");\n                return;\n            }\n            if (!this.$refs.form.validate()) {\n                this.$refs.form.validate();\n                return;\n            }\n            let ds = this.$refs.itemLineDS.kendoWidget();\n            let d1 = ds.data();\n            let dataValidate = 0;\n            await this.autoCalculate();\n            d1.forEach((value, index) => {\n                if (\n                    value.item == undefined ||\n                    value.item.id == undefined ||\n                    value.item.id == null ||\n                    value.uom == undefined ||\n                    value.uom.uom.id == undefined ||\n                    value.uom.uom.id == null\n                ) {\n                    this.$snotify.error(\n                        \"Please check Item or UOM  on row \" + (index + 1)\n                    );\n                } else {\n                    dataValidate += 1;\n                }\n            });\n            if (d1.length == dataValidate) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        let isAutoGenerate = 1;\n                        if (this.$route.params.id) {\n                            const tranDate = new Date(this.txnDate);\n                            const tranDateInvoice = new Date(this.purchase.transactionDate);\n                            const tranDateM = tranDate.getFullYear() + tranDate.getMonth();\n                            const tranDateInvoiceM =\n                                tranDateInvoice.getFullYear() + tranDateInvoice.getMonth();\n                            if (tranDateM === tranDateInvoiceM) {\n                                isAutoGenerate = 0;\n                            }\n                        }\n\n                        let itemLineDS = this.$refs.itemLineDS.kendoWidget();\n                        const dataRow = itemLineDS\n                            .data()\n                            .filter((o) => o.amount > 0)\n                            .map((n) => {\n                                return new ItemLineModel(n);\n                            });\n                        if (dataRow.length > 0) {\n                            let data = {\n                                id: this.purchase.id ? this.purchase.id : \"\",\n                                uuid: this.purchase.uuid ? this.purchase.uuid : \"\",\n                                journal_uuid: this.purchase.journal_uuid\n                                    ? this.purchase.journal_uuid\n                                    : \"\",\n                                jRaw: this.jRaw,\n                                type: TRANSACTION_TYPE,\n                                number: this.purchase.number,\n                                abbr: this.purchase.transactionType.abbr,\n                                transactionDate: this.txnDate,\n                                transactionDateTZ: Helper.toISODate(this.txnDate),\n                                dueDate: this.purchase.dueDate,\n                                monthOf: this.monthOf,\n                                paymentCode: this.purchase.paymentCode,\n                                billNo: this.purchase.billNo,\n                                billDate: this.billDate,\n                                supplier: this.purchase.supplier,\n                                transactionType: this.purchase.transactionType,\n                                paymentTerm: this.purchase.paymentTerm,\n                                discountPromotion: {},\n                                apAcc: this.purchase.apAcc,\n                                currency: this.purchase.currency,\n                                txnRate: this.purchase.txnRate,\n                                rate: 1,\n                                exchangeRate: this.purchase.exchangeRate,\n                                exchangeAmount: this.purchase.exchangeAmount,\n                                priceLevel: this.purchase.priceLevel,\n                                itemLines: dataRow,\n                                segment: this.purchase.segment,\n                                location: this.purchase.location,\n                                project: this.purchase.project,\n                                employee: this.purchase.employee,\n                                billingAddress: this.purchase.billingAddress,\n                                deliveryAddress: this.purchase.deliveryAddress,\n                                deliveryDateTime: this.purchase.deliveryDateTime,\n                                transactionNote: this.purchase.transactionNote,\n                                journalNote: this.purchase.journalNote,\n                                subTotal: this.purchase.subTotal,\n                                total: this.purchase.total,\n                                discountTotal: this.purchase.discountTotal,\n                                exchangeDiscountTotal: (this.purchase.discountTotal) * (this.purchase.txnRate || 1),\n                                specificDiscountTotal: this.purchase.specificDiscountTotal,\n                                deliveryFee: this.purchase.deliveryFee,\n                                totalTaxAmount: this.purchase.totalTaxAmount,\n                                depositAmount: this.purchase.depositAmount,\n                                depositDeduction: this.purchase.depositDeduction,\n                                remainingAmount: this.purchase.remainingAmount,\n                                amountDue: this.purchase.amountDue,\n                                currentBalance: this.purchase.currentBalance,\n                                balance: this.purchase.balance,\n                                creditLimit: this.purchase.creditLimit,\n                                saveOption: this.purchase.saveOption,\n                                status: 1,\n                                approvedBy: this.purchase.approvedBy,\n                                formTemplate: {},\n                                specificDiscountItem: this.purchase.specificDiscountItem,\n                                otherCharge: this.mOtherCharge,\n                                otherChargeAmount: this.purchase.otherChargeAmount,\n                                taxListTotal: this.taxListTotal,\n                                supplierDiscountItem: this.supplierDiscountItem,\n                                createdAt: this.purchase.createdAt,\n                                itemSubtotal: this.purchase.itemSubtotal,\n                                exchangeItemSubtotal: this.purchase.exchangeItemSubtotal,\n                                serviceSubtotal: this.purchase.serviceSubtotal,\n                                exchangeServiceSubtotal: this.purchase.exchangeServiceSubtotal,\n                                txnItmSubtotal: this.purchase.txnItmSubtotal,\n                                exchangeTxnItmSubtotal: this.purchase.exchangeTxnItmSubtotal,\n                                itemDiscount: this.purchase.itemDiscount,\n                                exchangeItemDiscount: this.purchase.exchangeItemDiscount,\n                                serviceDiscount: this.purchase.serviceDiscount,\n                                exchangeServiceDiscount: this.purchase.exchangeServiceDiscount,\n                                txnItmDiscount: this.purchase.txnItmDiscount,\n                                exchangeTxnItmDiscount: this.purchase.exchangeTxnItmDiscount,\n                                withholdingTaxAmount: this.purchase.withholdingTaxAmount || 0,\n                                inclusiveTaxAmount: this.purchase.inclusiveTaxAmount || 0,\n                                loggedUser: this.loggedUser,\n                                saveSend: saveSend,\n                                refFrom: this.purchase.refFrom || [],\n                                refTo: this.purchase.refTo || [],\n                                saleTaxDetail: this.purchase.saleTaxDetail || [],\n                                hasAdditionalCost: this.purchase.additionalCost.length > 0,\n                                additionalCost: this.purchase.additionalCost || [],\n                                additionalCostMethod: this.purchase.additionalCostMethod || '',\n                                additionalCostTotal: this.additionalCostTotal || 0,\n                                isAutoGenerate: isAutoGenerate,\n                                actionType: this.$route.params.id\n                                    ? this.$route.query.type\n                                    : \"new\",\n                            };\n                            if (this.$route.query.type === \"recurring\") {\n                                data.id = \"\";\n                            }\n                            this.showLoading = true;\n                            billingHandler.createPurchase(data).then((response) => {\n                                if (response.data.statusCode === 201) {\n                                    // this.close(response.data.data)\n                                    // this.$refs.form.reset()\n                                    this.showLoading = false;\n                                    this.$snotify.success(\"Successfully\");\n                                    if (saveSend === true) {\n                                        this.clear()\n                                    } else {\n                                        this.close(response.data.data);\n                                    }\n                                }\n                            }).catch((e) => {\n                                this.showLoading = false;\n                                this.$snotify.error(\"Something went wrong\");\n                                this.errors.push(e);\n                            });\n                        }\n                    }, 50);\n                });\n            }\n        },\n        async loadPurchaseFormContent() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    purchaseFormContentHandler.list().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            const data = res.data.data;\n                            if (data.length > 0) {\n                                this.purchaseFormContent = data[0];\n                                this.decimalFormat = \"n\" + this.purchaseFormContent.decimal;\n                                this.initData();\n                            }\n                        }\n                    });\n                }, 50);\n            });\n        },\n        close(data) {\n            if (this.$route.params.id === undefined) {\n                this.$router.push({\n                    name: \"Vendors\",\n                    params: {\n                        data: data,\n                    },\n                });\n            } else {\n                window.history.go(-1);\n                // this.$router.push({\n                //     path: \"invoice_view\",\n                //     name: \"Invoice View\",\n                //     params: {\n                //         data: data,\n                //     }\n                // })\n            }\n            // window.console.log(data, 'data')\n        },\n        saveNew() {\n        },\n        removeRow(e) {\n            e.preventDefault();\n            const grid = kendo.jQuery(\"#gridItemLine\").data(\"kendoGrid\"),\n                dataSource = grid.dataSource,\n                dataItem = grid.dataItem($(e.currentTarget).closest(\"tr\"));\n\n            if (dataSource.total() > 1) {\n                dataSource.remove(dataItem);\n                this.autoCalculate();\n            }\n        },\n        generateNumber() {\n            if (this.$route.params.id) {\n                const tranDate = new Date(this.txnDate);\n                const tranDateInvoice = new Date(this.purchase.transactionDate);\n                const tranDateM = tranDate.getFullYear() + tranDate.getMonth();\n                const tranDateInvoiceM =\n                    tranDateInvoice.getFullYear() + tranDateInvoice.getMonth();\n                if (tranDateM === tranDateInvoiceM) {\n                    this.purchase.referenceNo = this.referenceNo;\n                    return;\n                }\n            }\n\n            if (this.txnDate !== \"\" && this.purchaseTypes.length > 0) {\n                let data = {\n                    abbr: this.purchase.transactionType.abbr,\n                    structure: this.purchase.transactionType.structure,\n                    transactionDate: this.txnDate,\n                    sequcencing: this.purchase.transactionType.sequcencing,\n                    type: \"Purchase\",\n                    entity: 1,\n                };\n                billingHandler\n                    .lastNumber(data)\n                    .then((response) => {\n                        if (response.data.statusCode === 200) {\n                            const res = response.data.data;\n                            const lastNumber = this.zeroPad(\n                                parseInt(res.lastNumber),\n                                this.purchase.transactionType.format\n                            );\n                            const number =\n                                res.suffix +\n                                this.purchase.transactionType.numberSeparator +\n                                lastNumber;\n                            this.purchase.number = number;\n                        }\n                    })\n                    .catch((e) => {\n                        this.errors.push(e);\n                    });\n            }\n        },\n        zeroPad(num, places) {\n            return String(num).padStart(places, \"0\");\n        },\n        suffix(transactionDate) {\n            return kendo.toString(new Date(transactionDate), `yymm`);\n        },\n        errorMessage() {\n        },\n        accountDropDownEditor() {\n        },\n        cancel() {\n            this.$swal({\n                title: i18n.t(\"msg_title_warning\"),\n                text: i18n.t(\"msg_discard\"),\n                icon: \"warning\",\n                showCancelButton: true,\n                cancelButtonText: i18n.t(\"cancel\"),\n                confirmButtonColor: \"#4d4848\",\n                cancelButtonColor: \"#ED1A3A\",\n                confirmButtonText: i18n.t(\"discard\"),\n            }).then((resultCen) => {\n                window.console.log(resultCen);\n                if (resultCen.value) {\n                    this.$destroy()\n                    this.$router.go(-1);\n                }\n            });\n        },\n        hideSmallSidebar() {\n            this.isHideBar = !this.isHideBar;\n        },\n        requestData(skip, filter, baseUrl) {\n            const url = baseUrl + `?filter=${filter}`;\n            this.requestStarted = true;\n            fetch(url)\n                .then((response) => {\n                    return response.json();\n                })\n                .then(this.afterFetch);\n        },\n        requestData_(skip, filter, baseUrl) {\n            const url = baseUrl + `/${filter}`;\n            this.requestStarted = true;\n            fetch(url)\n                .then((response) => {\n                    return response.json();\n                })\n                .then(this.afterFetch_);\n        },\n        onChange(event) {\n            const value = event.value;\n            if (value && value[textField] === emptyItem[textField]) {\n                return;\n            }\n            this.vendor = value;\n            this.purchase.supplier = value;\n            // window.console.log(this.purchase.customer, 'Changed')\n            // this.invoice = value\n            this.purchase.apAcc = value.hasOwnProperty(\"apAcc\") ? value.apAcc : {};\n            this.purchase.paymentTerm = value.paymentTerm || {};\n            this.purchase.priceLevel = value.priceLevel || {};\n            const baseCurrency = value.baseCurrency || {};\n            if (baseCurrency.hasOwnProperty(\"code\")) {\n                this.baseCurrencyCode = \" \" + baseCurrency.code;\n            }\n            // this.loadTransactionRate();\n            this.billingAddress = value.hasOwnProperty(\"billingAddress\")\n                ? value.billingAddress\n                : [];\n            this.deliveryAddress = value.hasOwnProperty(\"deliveryAddress\")\n                ? value.deliveryAddress\n                : [];\n            if (this.billingAddress.length > 0) {\n                this.purchase.billingAddress = this.billingAddress[0];\n            }\n            if (this.deliveryAddress.length > 0) {\n                this.purchase.deliveryAddress = this.deliveryAddress[0];\n            }\n            this.expenses = []\n            this.onInvoiceDateChanged();\n            this.loadProjectByCustomer()\n            // this.loadCustomerBalance(this.vendor.id);\n            // const creditLimit = value.hasOwnProperty(\"creditLimit\")\n            //     ? value.creditLimit\n            //     : 0;\n            // this.purchase.creditLimit = kendo.parseFloat(creditLimit);\n            // window.console.log(value, 'value')\n        },\n        onEmployeeChanged(event) {\n            const value = event.value;\n            if (value && value[textField] === emptyItem[textField]) {\n                return;\n            }\n            this.mEmployee = value;\n            this.purchase.employee = value;\n        },\n        afterFetch(json) {\n            this.vendorList = json.data;\n        },\n        afterFetch_(json) {\n            this.employees = json.data;\n        },\n        onFilterChange(event) {\n            const filter = event.filter.value;\n            this.requestData(0, filter, this.cusBaseUrl);\n            this.filter = filter;\n        },\n        onEmployeeFilterChanged(event) {\n            const filter = event.filter.value;\n            this.requestData_(0, filter, this.empBaseUrl);\n            this.filter_ = filter;\n        },\n        async initData() {\n            if (this.$route.params.id !== undefined) {\n                await this.loadViewCreditPurchase();\n            } else {\n                this.clear()\n                // this.addRow();\n            }\n        },\n        async loadViewCreditPurchase() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.showLoading = true;\n                    if (this.$route.params.id) {\n                        billingHandler\n                            .viewPurchase(this.$route.params.id)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.purchase = res.data.data[0];\n                                    this.referenceNo = this.purchase.referenceNo;\n                                    this.txnDate = new Date(this.purchase.transactionDate);\n                                    this.vendor = this.purchase.supplier;\n                                    this.mEmployee = this.purchase.employee;\n                                    this.taxListTotal = this.purchase.taxListTotal;\n                                    this.itemLines = this.purchase.itemLines;\n                                    this.mOtherCharge = this.purchase.otherCharge;\n                                    this.supplierDiscountItem = this.purchase.supplierDiscountItem || []\n                                    this.jRaw = this.purchase.jRaw || [];\n                                    this.expenses = this.purchase.additionalCost || [];\n                                    this.additionalCostTotal = this.purchase.additionalCostTotal || 0;\n                                    this.purchaseOrders = this.purchase.refFrom || [];\n                                    this.monthOf = kendo.toString(\n                                        new Date(this.purchase.monthOf),\n                                        \"yyyy-MM\"\n                                    );\n                                    for (let i = 0; i < this.mOtherCharge.length - 1; i++) {\n                                        this.addSelect();\n                                    }\n                                    const priceLevel = this.purchase.priceLevel || {}\n                                    const currency = priceLevel.currency || {}\n                                    const curCode = currency.code || ''\n                                    this.currencyCode = curCode;\n                                    // this.loadProjectByCustomer()\n                                    if (this.vendor) {\n                                        if (this.vendor.hasOwnProperty(\"id\")) {\n                                            this.loadCustomerBalance(this.vendor.id);\n                                        }\n                                    }\n                                    if (this.$route.query.type === \"recurring\") {\n                                        if (this.$route.params.hasOwnProperty(\"transactionDate\")) {\n                                            window.console.log(\"type\", this.$route.params);\n                                            this.purchase.transactionDate = new Date(\n                                                this.$route.params.transactionDate\n                                            );\n                                            this.txnDate = new Date(\n                                                this.$route.params.transactionDate\n                                            );\n                                            this.onInvoiceDateChanged();\n                                            this.generateNumber();\n                                        }\n                                    }\n                                }\n                            })\n                            .catch();\n                        {\n                            this.showLoading = false;\n                        }\n                    }\n                }, 10);\n            });\n        },\n        clear() {\n            // this.loadAccount()\n            this.loadPriceLevel()\n            let ds = this.$refs.itemLineDS.kendoWidget();\n            ds.data([]);\n            this.id = undefined;\n            this.vendor = {}\n            this.mEmployee = {}\n            this.mOtherCharge = {}\n            this.purchaseOrders = []\n            this.purchase = new PurchaseModel({});\n            this.purchase.transactionType = this.purchaseTypes[0];\n            this.monthOf = kendo.toString(new Date(this.purchase.transactionDate), 'yyyy-MM')\n            this.addRow();\n            this.generateNumber();\n            this.loadSegment();\n            this.loadLocation();\n        },\n        async loadTransactionRate() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const date = new Date(this.txnDate).toISOString().substr(0, 10);\n                    const priceLevel = this.purchase.priceLevel;\n                    let code = \"\";\n                    if (priceLevel.hasOwnProperty(\"currency\")) {\n                        if (priceLevel.currency.hasOwnProperty(\"code\")) {\n                            code = priceLevel.currency.code;\n                        }\n                    }\n                    if (code !== undefined || code !== \"\") {\n                        this.showLoading = true;\n                        currencyHandler\n                            .getLastExchangeRateByDate(date, code)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.exchangeRate = res.data.data[0];\n                                    this.currencyCode = this.exchangeRate.code || \"\";\n                                    this.transactionRate = this.exchangeRate.rate || 0;\n                                    this.purchase.txnRate = this.exchangeRate.rate || 0;\n                                    this.purchase.exchangeRate = this.exchangeRate || {};\n                                    if (this.transactionRate === 0) {\n                                        this.$snotify.error(i18n.t(\"set_exchange_rate\"));\n                                        return;\n                                    }\n                                    this.showLoading = false;\n                                    this.loadCustomerDepositBalance(this.vendor.id);\n                                }\n                            });\n                    }\n                    this.loadPurchaseOrder();\n                }, 10);\n            });\n        },\n        reload() {\n            if (this.$route.params.id !== undefined) {\n                this.loadViewCreditPurchase()\n            } else {\n                this.clear()\n            }\n        },\n        async loadPurchaseOrder() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    let segmentId = \"\",\n                        locationId = '',\n                        priceLevelId = \"\",\n                        customerId = \"\",\n                        txnDate = \"\";\n                    if (this.purchase.segment) {\n                        segmentId = this.purchase.segment.id;\n                    }\n                    if (this.purchase.location) {\n                        locationId = this.purchase.location.id;\n                    }\n                    if (this.purchase.supplier) {\n                        customerId = this.purchase.supplier.id;\n                    }\n                    if (this.purchase.priceLevel) {\n                        priceLevelId = this.purchase.priceLevel.id;\n                    }\n                    if (this.purchase.transactionDate) {\n                        txnDate = this.purchase.transactionDate;\n                    }\n                    let strFilter = \"\";\n                    if (\n                        segmentId !== \"\" &&\n                        customerId !== \"\" &&\n                        locationId !== \"\" &&\n                        priceLevelId !== \"\" &&\n                        txnDate !== \"\"\n                    ) {\n                        strFilter =\n                            \"?id=\" +\n                            customerId +\n                            \"&segId=\" +\n                            segmentId +\n                            \"&locId=\" +\n                            locationId +\n                            \"&plId=\" +\n                            priceLevelId +\n                            \"&date=\" +\n                            txnDate + '&type=Purchase Order'\n                    }\n                    if (strFilter !== \"\") {\n                        this.purchase.refFrom = []\n                        this.showLoadingTxn = true\n                        saleOrderHandler\n                            .transactionFilter(strFilter)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoadingTxn = false\n                                    this.purchaseOrders = res.data.data;\n                                } else {\n                                    this.showLoadingTxn = false\n                                }\n                            })\n                    }\n                }, 10);\n            });\n            await this.getExpenseBySupplier()\n        },\n        addPurchaseOrder(item) {\n            if (item) {\n                const itemLine = item.itemLines || [];\n                this.refFrom.push({\n                    id: item.id || '',\n                    reference: item.referenceNo || ''\n                })\n                let ds = this.$refs.itemLineDS.kendoWidget(),\n                    total = ds.total();\n                itemLine.forEach((o) => {\n                    this.itemLine = new ItemLineModel(o);\n                    this.itemLine.id = itemLinePrefix + uuid.v1();\n                    this.itemLine.decimalFormat = \"n\" + this.purchaseFormContent.decimal;\n                    this.itemLine.sourceTransaction = {\n                        id: item.id,\n                        referenceNo: item.referenceNo,\n                    };\n                    this.itemLine.sourceTransactionRef = item.referenceNo;\n                    ds.insert(total, this.itemLine);\n                });\n                this.itemLine = new ItemLineModel({});\n                this.autoCalculate();\n                const index = this.purchaseOrders.findIndex((itm) => {\n                    return item.id === itm.id;\n                });\n                this.purchaseOrders.splice(index, 1);\n                this.purchase.refFrom = this.removeDuplicate(this.refFrom)\n            }\n        },\n        totalQty() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            let qty = 0\n            ds.data().filter(n => n.amount > 0).forEach(m => {\n                const itm = m.item || {}\n                const uom = m.uom || {}\n                if (itm.id && uom.uom && itm.type === 'Variant') {\n                    qty += (m.qty || 0) * (m.conversionRate || 1)\n                }\n            })\n            window.console.log('qty', qty)\n            return qty\n        },\n        excludeVATTaxInclusive(tax, amount, incTax) {\n            if (tax) {\n                const baseAmount = tax.baseAmount || '';\n                const taxType = tax.taxType || {}\n                const taxTypeId = taxType.typeId || 0\n                if (baseAmount) {\n                    if (baseAmount.toLowerCase() === \"inclusive\" && taxTypeId === 1) {\n                        return amount - incTax\n                    }\n                }\n            }\n            return amount\n        },\n        totalAmount() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            let amount = 0\n            ds.data().filter(n => n.amount > 0).forEach(m => {\n                const itm = m.item || {}\n                const uom = m.uom || {}\n                let incluTax = 0\n                if (itm.id && uom.uom && itm.type === 'Variant') {\n                    const tax = m.vatTax || {}\n                    const amount_ = m.amount || 0\n                    const baseAmount = tax.baseAmount || '';\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            incluTax = this.autoCalculateTax(tax, amount_);\n                        }\n                    }\n                    amount += (amount_ - (incluTax || 0))\n                }\n            })\n            window.console.log('amount x-', amount)\n            return amount\n        },\n        percentageApplied() {\n            try {\n                const tAmount = this.totalAmount()\n                let ds = this.$refs.itemLineDS.kendoWidget()\n                ds.data().filter(n => n.amount > 0).forEach(m => {\n                    const itm = m.item || {}\n                    const uom = m.uom || {}\n                    let incluTax = 0\n                    if (itm.id && uom.uom && itm.type === 'Variant') {\n                        const tax = m.vatTax || {}\n                        const amount = m.amount || 0\n                        const baseAmount = tax.baseAmount || '';\n                        if (baseAmount) {\n                            if (baseAmount.toLowerCase() === \"inclusive\") {\n                                incluTax = this.autoCalculateTax(tax, amount);\n                            }\n                        }\n                        const amountAfterTax = amount - (incluTax || 0)\n                        const pAmount = amountAfterTax / tAmount\n                        m['percentageApplied'] = pAmount\n                    }\n                })\n                window.console.log('Qty Based--', ds.data())\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        amountApplied() {\n            try {\n                let ds = this.$refs.itemLineDS.kendoWidget()\n                const adc = this.additionalCostTotal || 0\n                ds.data().filter(n => n.amount > 0).forEach(m => {\n                    const itm = m.item || {}\n                    const uom = m.uom || {}\n                    window.console.log('amountApplied==', uom.uom, '---', itm.type)\n                    if (itm.id && uom.uom && itm.type === 'Variant') {\n                        const percentageApplied = m.percentageApplied || 0\n                        window.console.log('percentageApplied--', adc, '---', (percentageApplied * adc))\n                        m['amountApplied'] = percentageApplied * adc\n                    }\n\n                })\n                window.console.log('AMount Based--', ds.data())\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        amountAppliedQtyBased() {\n            try {\n                let ds = this.$refs.itemLineDS.kendoWidget()\n                ds.data().filter(n => n.amount > 0).forEach(m => {\n                    const itm = m.item || {}\n                    const uom = m.uom || {}\n                    if (itm.id && uom.uom && itm.type === 'Variant') {\n                        const addc = m.additionalCost || 0\n                        const qty = (m.qty || 1) * (m.conversionRate || 1)\n                        m['amountApplied'] = addc * qty\n                    }\n                })\n                window.console.log('amountAppliedQtyBased Based--', ds.data())\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        async calculateAdditionalCost() {\n            try {\n                // todo: additional Cost\n                if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    this.percentageApplied()\n                } else {\n                    this.percentageApplied()\n                    this.amountApplied()\n                }\n                if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    const tQty = this.totalQty()\n                    const addc = this.additionalCostTotal || 0\n                    let ds = this.$refs.itemLineDS.kendoWidget()\n                    ds.data().filter(n => n.amount > 0).forEach(m => {\n                        const itm = m.item || {}\n                        const uom = m.uom || {}\n                        if (itm.id && uom.uom && itm.type === 'Variant') {\n                            m['additionalCost'] = addc / tQty\n                        }\n                    })\n                    window.console.log('qty based', ds.data())\n                } else {\n                    let ds = this.$refs.itemLineDS.kendoWidget()\n                    ds.data().filter(n => n.amount > 0).forEach(m => {\n                        const itm = m.item || {}\n                        const uom = m.uom || {}\n                        if (itm.id && uom.uom && itm.type === 'Variant') {\n                            const amountApplied = m.amountApplied || 0\n                            const qty = (m.qty || 0) * (m.conversionRate || 1)\n                            m['additionalCost'] = amountApplied / qty\n                        }\n                    })\n                }\n                if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    this.amountAppliedQtyBased()\n                }\n                await this.clearingAccount()\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        autoCalculateTaxDetail() {\n            let ids = []\n            this.taxListDetail.forEach(n => {\n                ids.push(n.id || '')\n            })\n            const unique = [...new Set(ids)]\n            let result = []\n            unique.forEach(m => {\n                let amount = 0, row = {}, discount = 0, xDiscount = 0, xAmount = 0, taxAmount = 0, xTaxAmount = 0\n                let taxDetail = [], isVat = 0\n                const found = this.taxListDetail.filter(n => n.id === m)\n                // window.console.log('taxListDetailids', found)\n                found.forEach(k => {\n                    row = k\n                    if (k.isVat === 1) {\n                        isVat = 1\n                        const detail_ = k.detail || {}\n                        taxDetail.push(detail_)\n\n                    }\n                    taxAmount += k.taxAmount_ || 0\n                    xTaxAmount += (k.taxAmount_ || 0) * (k.txnRate || 1)\n                    amount += (k.amount || 0)\n                    xAmount += (k.amount || 0) * (k.txnRate || 1)\n                    discount += (k.discount || 0)\n                    xDiscount += (k.discount || 0) * (k.txnRate || 1)\n                })\n                let spTaxAmt = 0, spXTaxAmt = 0, plTaxAmt = 0, plXTaxAmt = 0, otTaxAmt = 0, otXTaxAmt = 0,\n                    spTaxName = '', plTaxName = '', otTaxName = '',\n                    spTaxNameLocale = '', plTaxNameLocale = '', otTaxNameLocale = '',\n                    spAccId = '', plAccId = '', otAccId = '',\n                    spRate = '', plRate = '', otRate = ''\n                taxDetail.forEach(n => {\n                    const spTax = n.specificTax || {}\n                    const plTax = n.publicLightingTax || {}\n                    const otherTax = n.otherTax || {}\n                    if (Object.keys(spTax).length > 0) {\n                        spTaxAmt += (spTax.taxAmount_ || 0)\n                        spXTaxAmt += ((spTax.taxAmount_ || 0) * (spTax.taxRate || 1))\n                        spTaxName = spTax.defaultTax || ''\n                        spTaxNameLocale = spTax.defaultTaxLocale || ''\n                        spAccId = spTax.account ? spTax.account.id : ''\n                        spRate = spTax.rate || 1\n                    }\n                    if (Object.keys(plTax).length > 0) {\n                        plTaxAmt += (plTax.taxAmount_ || 0)\n                        plXTaxAmt += ((plTax.taxAmount_ || 0) * (plTax.taxRate || 1))\n                        plTaxName = plTax.defaultTax || ''\n                        plTaxNameLocale = plTax.defaultTaxLocale || ''\n                        plAccId = plTax.account ? plTax.account.id : ''\n                        plRate = plTax.rate || 1\n                    }\n                    if (Object.keys(otherTax).length > 0) {\n                        otTaxAmt += (otherTax.taxAmount_ || 0)\n                        otXTaxAmt += ((otherTax.taxAmount_ || 0) * (plTax.taxRate || 1))\n                        otTaxName = otherTax.defaultTax || ''\n                        otTaxNameLocale = otherTax.defaultTaxLocale || ''\n                        otAccId = otherTax.account ? otherTax.account.id : ''\n                        otRate = otherTax.rate || 1\n                    }\n                })\n                if (isVat === 1) {\n                    row.detail = {\n                        specificTax: {\n                            name: spTaxName,\n                            nameLocale: spTaxNameLocale,\n                            amount: spTaxAmt,\n                            exchangeAmount: spXTaxAmt,\n                            accountId: spAccId,\n                            rate: spRate,\n                        },\n                        publicLightingTax: {\n                            name: plTaxName,\n                            nameLocale: plTaxNameLocale,\n                            amount: plTaxAmt,\n                            exchangeAmount: plXTaxAmt,\n                            accountId: plAccId,\n                            rate: plRate,\n                        },\n                        otherTax: {\n                            name: otTaxName,\n                            nameLocale: otTaxNameLocale,\n                            amount: otTaxAmt,\n                            exchangeAmount: otXTaxAmt,\n                            accountId: otAccId,\n                            rate: otRate,\n                        }\n                    }\n                } else {\n                    row.detail = {}\n                }\n\n                row['amount'] = amount\n                row['exchangeAmount'] = xAmount\n                row['taxAmount'] = taxAmount\n                row['exchangeTaxAmount'] = xTaxAmount\n                row['discount'] = discount\n                row['exchangeDiscount'] = xDiscount\n                row['currency'] = this.purchase.exchangeRate || {}\n                result.push(row)\n                taxDetail = []\n            })\n            this.purchase.saleTaxDetail = result\n            window.console.log('saleTaxDetail', result)\n        },\n        async getExpenseBySupplier() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const segment = this.purchase.segment || {}\n                    const segmentId = segment.id || ''\n                    const location = this.purchase.location || {}\n                    const locationId = location.id || ''\n                    const supplier = this.purchase.supplier || {}\n                    const supplierId = supplier.id || ''\n                    const strFilter = '?id=' + supplierId + '&segId=' + segmentId + '&locId=' + locationId;\n                    this.expenses = []\n                    this.purchase.additionalCostTotal = 0\n                    this.showLoadingTxnAdditionalCost = false\n                    this.purchase.additionalCost = []\n                    billingHandler.listPurchase(strFilter).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoadingTxnAdditionalCost = true\n                            this.showLoadingTxnAdditionalCost = false;\n                            this.expenses = res.data.data;\n                            this.onMethodChanged()\n                        } else {\n                            this.showLoadingTxnAdditionalCost = false;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async clearingAccount() {\n            try {\n                if (this.isItem()) {\n                    /* todo: clearing account for additional cost */\n                    const amount = (this.purchase.additionalCostTotal || 0) * -1\n                    const xAmount = amount * this.purchase.txnRate || 1\n                    const addict = this.purchase.additionalCost || []\n\n                    if (addict.length > 0) {\n                        if (addict[0]) {\n                            const account = addict[0].account || {}\n                            const nature = 'cr'\n                            this.jRaw.push({\n                                id: account.id + \"-\" + nature,\n                                line: new ItemLineModel(),\n                                description: \"Additional Cost\",\n                                account: account,\n                                accountId: account.id,\n                                amount: amount,\n                                exchangeAmount: xAmount,\n                                type: nature,\n                                typeAs: \"clearing\",\n                            });\n                        }\n                    }\n                }\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        isItem() {\n            const ds = this.$refs.itemLineDS.kendoWidget()\n            const row = ds.data().filter(n => n.amount > 0)\n            const found = row.filter(n => n.item.type === 'Variant')\n            if (found) {\n                return found.length > 0;\n            }\n            return false\n        }\n    },\n    computed: {\n        abbr() {\n            if (this.purchase) {\n                const txnType = this.purchase.transactionType || {}\n                const abbr = txnType.abbr || ''\n                return abbr\n            } else {\n                return ''\n            }\n        },\n        validVendor() {\n            let vendor = this.vendor;\n            return vendor.id !== undefined && vendor.id !== null;\n        },\n        disableMe() {\n            return !!this.$route.params.id;\n        },\n        hiddenButton() {\n            return !!this.$route.params.id;\n        },\n        disabledSLP() {\n            if (this.$route.params.id) {\n                const refF = this.purchase.refFrom || []\n                if (refF.length > 0) {\n                    return !!refF.length > 0\n                }\n                const adc = this.purchase.additionalCost || []\n                if (adc.length > 0) {\n                    return !!adc.length > 0\n                }\n            }\n            return false\n        },\n    },\n    watch: {\n        // id() {\n        //   if (this.$route.params.id === undefined) {\n        //     this.clear();\n        //   } else {\n        //     this.showLoading = true;\n        //     this.loadViewCreditPurchase();\n        //   }\n        // },\n        '$route': 'reload'\n    },\n    created() {\n        this.loadTax();\n        this.loadPrefix();\n        this.loadProjectByCustomer();\n    },\n    mounted: async function () {\n        this.requestData(0, this.filter, this.cusBaseUrl);\n        await this.loadSegment();\n        await this.loadLocation();\n        await this.loadDiscountItem();\n        await this.loadEmployeeCenter();\n        await this.loadPaymentTerm();\n        await this.loadAccount();\n        await this.loadPriceLevel();\n        await this.loadOtherCharge();\n        await this.loadPurchaseFormContent();\n        await this.initData()\n    },\n};\n</script>\n\n<style scoped>\n.k-dropdown {\n    width: 100%;\n    margin-top: 3px;\n}\n\n.function_wrapper {\n    box-shadow: none !important;\n}\n\n.v-application--is-ltr .v-text-field .v-input__append-inner {\n    margin-top: 0 !important;\n}\n\n.v-input__slot {\n    background-color: #fff !important;\n}\n\n.function_content .label {\n    margin-bottom: 10px;\n    display: inline-block;\n}\n\n.border_radius10 {\n    border-radius: 10px !important;\n    background-color: #f2f2f2;\n}\n\n.pa-3.v-card h4 {\n    font-size: 18px;\n    color: #333;\n}\n\n.pa-3.v-card p {\n    font-size: 12px;\n    color: #b5b5b5;\n}\n\n.attachment_file {\n    background-color: #efeded;\n    border-radius: 0 !important;\n}\n\n.attachment_table.v-data-table table {\n    border: thin solid rgba(0, 0, 0, 0.12);\n}\n\n.attachment_table table tr th {\n    border-left: thin solid rgba(0, 0, 0, 0.12);\n    height: 35px;\n    border-right: thin solid rgba(0, 0, 0, 0.12);\n}\n\n.block_debit,\n.block_credit {\n    border-bottom: 1px solid #fff;\n}\n\n.block_debit p.number,\n.block_credit p.number {\n    font-size: 25px;\n    color: #7f7f7f;\n}\n\n.block_debit h5,\n.block_credit h5,\n.block_difference h5 {\n    text-transform: uppercase;\n    color: #7f7f7f;\n    font-size: 15px;\n    font-weight: normal;\n}\n\n.block_difference h5 {\n    font-size: 18px;\n}\n\n.block_difference h5 span {\n    font-size: 15px;\n}\n\n.custom_grid table th:last-child {\n    text-align: right !important;\n}\n\n@media (min-width: 1264px) {\n    .container {\n        max-width: 1250px;\n    }\n}\n\n@media (max-width: 576px) {\n    .pt-6.col-sm-5.col-12 {\n        padding-top: 0 !important;\n    }\n\n    .code_text {\n        width: 100%;\n    }\n\n    .phone_no_pt {\n        padding-top: 0 !important;\n    }\n\n    .select_template,\n    .save_option {\n        margin-bottom: 10px;\n    }\n}\n\n.hide_small_bar_class {\n    max-width: 0;\n    transition: 0.5s ease-in;\n    flex: 0 0 0;\n}\n\n.hide_big_bar_class {\n    max-width: 100%;\n    transition: 0.5s ease-in;\n    flex: 0 0 100%;\n}\n\n.info_add {\n    background-color: #ffffff;\n}\n\n.small_sidebar {\n    height: 98%;\n    position: relative;\n    padding: 12px;\n    background-color: #edf1f5;\n}\n\n.iconArrow {\n    right: -35px;\n    position: absolute;\n    bottom: -10px;\n}\n\n.iconArrowHide {\n    position: absolute;\n    right: -7px;\n    bottom: -10px;\n}\n\n.color_grey {\n    color: #808080;\n}\n\n.card_green {\n    min-height: 70px;\n    background-color: #00b050 !important;\n    color: #ffffff;\n}\n\n.lb_bold {\n    font-size: 12px;\n}\n\n.detial_smallside_p {\n    position: absolute;\n    bottom: 10px;\n}\n\n.card_background {\n    background-color: #edf1f5;\n    min-height: 120px;\n}\n\n.deposite_input {\n    width: 100px;\n}\n\n.btn_save_draft {\n    color: #ffffff;\n    background-color: #00b0f0 !important;\n    text-transform: capitalize;\n}\n\n.save_option {\n    background-color: #203864 !important;\n}\n\n.btn_add_small {\n    height: 27px !important;\n    min-width: 25px !important;\n    font-size: 10px;\n    padding: 0 22px !important;\n    background-color: #00b050 !important;\n    color: #ffffff;\n    border-radius: 0 !important;\n}\n\n.list_site_inv {\n    background-color: #92d050;\n    color: #ffffff;\n    font-size: 12px;\n}\n\n.list_site_exp {\n    background-color: #c5e0b4;\n    color: #000000;\n    font-size: 12px;\n    line-height: 16px;\n    min-height: 40px;\n}\n\n.checkbox_inv {\n    padding: 2px;\n    margin-top: 3px;\n    margin-right: 2px;\n}\n\n.exp_select {\n    font-size: 12px !important;\n}\n\n.theme--light.v-data-table\n> .v-data-table__wrapper\n> table\n> tbody\n> tr:hover:not(.v-data-table__expanded__content):not(.v-data-table__empty-wrapper) {\n    background-color: transparent !important;\n}\n</style>\n"]}]}