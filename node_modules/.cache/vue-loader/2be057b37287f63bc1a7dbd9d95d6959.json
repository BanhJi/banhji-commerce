{"remainingRequest":"/Users/macos/Desktop/banhji-0.2/banhji-commerce/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/macos/Desktop/banhji-0.2/banhji-commerce/src/views/suppliers/CreditPurchases.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/macos/Desktop/banhji-0.2/banhji-commerce/src/views/suppliers/CreditPurchases.vue","mtime":1642155812723},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-commerce/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-commerce/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-commerce/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-commerce/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCi8vIGltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiCmltcG9ydCB7aTE4bn0gZnJvbSAiQC9pMThuIjsKaW1wb3J0IFB1cmNoYXNlTW9kZWwgZnJvbSAiQC9zY3JpcHRzL3B1cmNoYXNlL21vZGVsL1B1cmNoYXNlIjsKaW1wb3J0IEl0ZW1MaW5lTW9kZWwgZnJvbSAiQC9zY3JpcHRzL3B1cmNoYXNlL21vZGVsL0l0ZW1MaW5lIjsKaW1wb3J0IHt1dWlkfSBmcm9tICJ2dWUtdXVpZCI7CmltcG9ydCB7RHJvcERvd25MaXN0fSBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdnVlLWRyb3Bkb3ducyI7CmltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiOwppbXBvcnQgUHVyY2hhc2VGb3JtQ29udGVudE1vZGVsIGZyb20gIkAvc2NyaXB0cy9tb2RlbC9QdXJjaGFzZUZvcm1Db250ZW50IjsKaW1wb3J0IHtkYXRhU3RvcmUsIFNob3dSZXNvdXJjZX0gZnJvbSAiQC9vYnNlcnZhYmxlL3N0b3JlIjsKaW1wb3J0IHBheW1lbnRUZXJtSGFuZGxlcl8gZnJvbSAiQC9zY3JpcHRzL3BheW1lbnR0ZXJtL2hhbmRsZXIvcGF5bWVudFRlcm1IYW5kbGVyIjsKaW1wb3J0IGNyZWRpdExpbWl0SGFuZGxlciBmcm9tICJAL3NjcmlwdHMvY3JlZGl0TGltaXQvaGFuZGxlci9jcmVkaXRMaW1pdEhhbmRsZXIiOwppbXBvcnQgc2FsZU9yZGVySGFuZGxlciBmcm9tICJAL3NjcmlwdHMvdHJhbnNhY3Rpb25IYW5kbGVyIjsKaW1wb3J0IEhlbHBlciBmcm9tICJAL2hlbHBlciI7CmltcG9ydCBzZXR0aW5nc0hhbmRsZXIgZnJvbSAiQC9zY3JpcHRzL3NldHRpbmdzSGFuZGxlciI7Cgpjb25zdCBzdXBwbGllckhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc3VwcGxpZXJIYW5kbGVyIik7Ci8vIGltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiOwoKY29uc3QgcHJvamVjdEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcHJvamVjdEhhbmRsZXIiKTsKY29uc3QgcHJpY2VMZXZlbEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcHJpY2VMZXZlbEhhbmRsZXIiKTsKY29uc3QgY3VycmVuY3lIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2N1cnJlbmN5L2hhbmRsZXIvY3VycmVuY3lIYW5kbGVyIik7CgovLyBjb25zdCBzZXR0aW5nc0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2V0dGluZ3NIYW5kbGVyIik7CmNvbnN0IGVtcGxveWVlSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9lbXBsb3llZUhhbmRsZXIiKTsKY29uc3QgbG9jYXRpb25IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2xvY2F0aW9uSGFuZGxlciIpOwovLyBjb25zdCBwYXltZW50VGVybUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcGF5bWVudFRlcm1IYW5kbGVyIik7CmNvbnN0IGFjY291bnRIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2hhbmRsZXIvYWNjb3VudGluZy9hY2NvdW50Iik7CmNvbnN0IHByb2R1Y3RWYXJpYW50SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wcm9kdWN0VmFyaWFudEhhbmRsZXIiKTsKY29uc3QgdW9tUHJpY2VIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3VvbVByaWNlSGFuZGxlciIpOwpjb25zdCBkaXNjb3VudEl0ZW1IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2Rpc2NvdW50SXRlbUhhbmRsZXIiKTsKY29uc3Qgc2V0dGluZ0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2V0dGluZ0hhbmRsZXIiKTsKY29uc3Qgb3RoZXJDaGFyZ2VIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL290aGVyQ2hhcmdlSGFuZGxlciIpOwpjb25zdCBwdXJjaGFzZUZvcm1Db250ZW50SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9wdXJjaGFzZUZvcm1Db250ZW50SGFuZGxlciIpOwpjb25zdCBwcmVmaXhIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3ByZWZpeEhhbmRsZXIiKTsKY29uc3QgYmlsbGluZ0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvaW52b2ljZS9oYW5kbGVyL2JpbGxpbmdIYW5kbGVyIik7Cgpjb25zdCBwdXJjaGFzZU1vZGVsID0gbmV3IFB1cmNoYXNlTW9kZWwoe30pOwpjb25zdCBpdGVtTGluZU1vZGVsID0gbmV3IEl0ZW1MaW5lTW9kZWwoe30pOwpjb25zdCBwdXJjaGFzZUZvcm1Db250ZW50TW9kZWwgPSBuZXcgUHVyY2hhc2VGb3JtQ29udGVudE1vZGVsKHt9KTsKY29uc3QgJCA9IGtlbmRvLmpRdWVyeQoKY29uc3QgdGV4dEZpZWxkID0gIm51bWJlck5hbWUiOwpjb25zdCBrZXlGaWVsZCA9ICJpZCI7CmNvbnN0IGRlZmF1bHRJdGVtID0ge1t0ZXh0RmllbGRdOiAiU2VsZWN0IHZlbmRvci4uLiIsIFtrZXlGaWVsZF06IG51bGx9Owpjb25zdCBlbXB0eUl0ZW0gPSB7W3RleHRGaWVsZF06ICJsb2FkaW5nIC4uLiJ9Owpjb25zdCBwYWdlU2l6ZSA9IDEwOwpjb25zdCBpdGVtTGluZVByZWZpeCA9ICJsaW4tIjsKY29uc3QgbG9hZGluZ0RhdGEgPSBbXTsKd2hpbGUgKGxvYWRpbmdEYXRhLmxlbmd0aCA8IHBhZ2VTaXplKSB7CiAgICBsb2FkaW5nRGF0YS5wdXNoKHsuLi5lbXB0eUl0ZW19KTsKfQpjb25zdCB7Q2xhc3NFZGl0b3J9ID0gcmVxdWlyZSgiQC9zY3JpcHRzL2tlbmRvX2VkaXRvci9Db2xsZWN0aW9ucyIpOwpjb25zdCBESVNDT1VOVF9UWVBFID0gIj90eXBlPVB1cmNoYXNlIjsKY29uc3QgVFJBTlNBQ1RJT05fVFlQRSA9ICJQdXJjaGFzZSI7CmNvbnN0IGNvb2tpZUpTID0gcmVxdWlyZSgiQC9jb29raWUuanMiKTsKY29uc3QgY29va2llID0gY29va2llSlMuZ2V0Q29va2llKCk7CmNvbnN0IE5BVFVSRSA9ICdwdXJjaGFzZScKZXhwb3J0IGRlZmF1bHQgewogICAgbmFtZTogIkNyZWRpdFB1cmNoYXNlIiwKICAgIHByb3BzOiBbImlkIiwgInRyYW5zYWN0aW9uRGF0ZSJdLAogICAgY29tcG9uZW50czogewogICAgICAgIExvYWRpbmdNZTogKCkgPT4gaW1wb3J0KGBAL2NvbXBvbmVudHMvTG9hZGluZ2ApLAogICAgICAgICJhcHAtZGF0ZXBpY2tlciI6ICgpID0+IGltcG9ydCgiQC9jb21wb25lbnRzL2N1c3RvbV90ZW1wbGF0ZXMvRGF0ZVBpY2tlckNvbXBvbmVudCIpLAogICAgICAgICJtb250aC1waWNrZXIiOiAoKSA9PiBpbXBvcnQoIkAvY29tcG9uZW50cy9jdXN0b21fdGVtcGxhdGVzL01vbnRoUGlja2VyIiksCiAgICAgICAgZHJvcGRvd25saXN0OiBEcm9wRG93bkxpc3QsCiAgICB9LAogICAgZGF0YTogKCkgPT4gKHsKICAgICAgICBpc0VkaXQ6IGZhbHNlLAogICAgICAgIHNob3dMb2FkaW5nVHhuOiBmYWxzZSwKICAgICAgICBzaG93TG9hZGluZ1R4bkFkZGl0aW9uYWxDb3N0OiBmYWxzZSwKICAgICAgICBtT3RoZXJDaGFyZ2U6IFtdLAogICAgICAgIG1PdGhlckNoYXJnZUFtb3VudDogW10sCiAgICAgICAgcHVyY2hhc2VPcmRlcnM6IFtdLAogICAgICAgIG51bVNlbGVjdDogWzFdLAogICAgICAgIGRpYWxvZ1RheDogZmFsc2UsCiAgICAgICAgdmVuZG9yTGlzdDogW10sCiAgICAgICAgc2hvd0xvYWRpbmc6IGZhbHNlLAogICAgICAgIGJpbGxfZGF0ZTogIiIsCiAgICAgICAgYWxlcnQ6IGZhbHNlLAogICAgICAgIGZpbGVzOiBbXSwKICAgICAgICAvLyBGb3JtIHZhbGlkYXRpb24KICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICBpdGVtTGluZXM6IFtdLAogICAgICAgIHR4bkRhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApLAogICAgICAgIGJpbGxEYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDAsIDEwKSwKICAgICAgICBpbnZvaWNlRGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCksCiAgICAgICAgbW9udGhPZjogIiIsCiAgICAgICAgdGVtcGxhdGVzOiBbCiAgICAgICAgICAgIHt0aXRsZTogIlB1cmNoYXNlIiwgdmFsdWU6ICJQdXJjaGFzZSJ9LAoKICAgICAgICBdLAogICAgICAgIGlzSGlkZUJhcjogZmFsc2UsCiAgICAgICAgdmVuZG9yOiB7fSwKICAgICAgICBkZWZhdWx0SXRlbTogZGVmYXVsdEl0ZW0sCiAgICAgICAgcHVyY2hhc2U6IHB1cmNoYXNlTW9kZWwsCiAgICAgICAgdHJhbnNhY3Rpb25UeXBlOiBbIkludm9pY2UiLCAiQ29tbWVyY2lhbCBJbnZvaWNlIiwgIlRheCBJbnZvaWNlIl0sCiAgICAgICAgY3VzQmFzZVVybDogc3VwcGxpZXJIYW5kbGVyLnNlYXJjaCgpLAogICAgICAgIGVtcEJhc2VVcmw6IGVtcGxveWVlSGFuZGxlci5zZWFyY2goKSwKICAgICAgICBpbml0OiB7bWV0aG9kOiAiR0VUIiwgYWNjZXB0OiAiYXBwbGljYXRpb24vanNvbiIsIGhlYWRlcnM6IFtdfSwKICAgICAgICBwZW5kaW5nUmVxdWVzdDogdW5kZWZpbmVkLAogICAgICAgIHJlcXVlc3RTdGFydGVkOiBmYWxzZSwKICAgICAgICBza2lwOiAwLAogICAgICAgIHRlbXBTa2lwOiBudWxsLAogICAgICAgIHRvdGFsOiAwLAogICAgICAgIGZpbHRlcjogIiIsCiAgICAgICAgcmVmZXJlbmNlTm86ICIiLAogICAgICAgIGZpbHRlcl86ICIiLAogICAgICAgIHRleHRGaWVsZDogIm51bWJlck5hbWUiLAogICAgICAgIGRhdGFJdGVtS2V5OiAiaWQiLAogICAgICAgIHNlZ21lbnRzOiBbXSwKICAgICAgICBlbXBsb3llZXM6IFtdLAogICAgICAgIG1ldGhvZHM6IFsnUXR5IEJhc2VkJywgJ0Ftb3VudCBCYXNlZCddLAogICAgICAgIG1FbXBsb3llZToge30sCiAgICAgICAgY3VzdG9tZXJQcm9qZWN0czogW10sCiAgICAgICAgYmlsbGluZ0FkZHJlc3M6IFtdLAogICAgICAgIGRlbGl2ZXJ5QWRkcmVzczogW10sCiAgICAgICAgZGVsaXZlcnlEYXRlVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCksCiAgICAgICAgcHJpY2VMZXZlbDogW10sCiAgICAgICAgbG9jYXRpb25zOiBbXSwKICAgICAgICBwYXltZW50VGVybXM6IFtdLAogICAgICAgIGFjY1BheWFibGU6IFtdLAogICAgICAgIGN1cnJlbmNpZXM6IFtdLAogICAgICAgIGl0ZW1MaW5lOiBpdGVtTGluZU1vZGVsLAogICAgICAgIHVvbXM6IFtdLAogICAgICAgIHRheDogW10sCiAgICAgICAgc3BlY2lmaWNEaXNjb3VudEl0ZW06IFtdLAogICAgICAgIG90aGVyQ2hhcmdlTGlzdDogW10sCiAgICAgICAgZGVwb3NpdEJhbGFuY2U6IDAsCiAgICAgICAgc2NoZW1hRGVmaW5pdGlvbjogewogICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgIH0sCiAgICAgICAgfSwKICAgICAgICBwdXJjaGFzZUZvcm1Db250ZW50OiBwdXJjaGFzZUZvcm1Db250ZW50TW9kZWwsCiAgICAgICAgQ2xhc3NFZGl0b3I6IENsYXNzRWRpdG9yLAogICAgICAgIHRheExpc3RUb3RhbDoge30sCiAgICAgICAgcHVyY2hhc2VUeXBlczogW10sCiAgICAgICAgdGF4TGlzdERldGFpbDogW10sCiAgICAgICAgc3VwcGxpZXJEaXNjb3VudEl0ZW06IFtdLAogICAgICAgIGxhdGVGZWVMaXN0OiBbXSwKICAgICAgICBsb2dnZWRVc2VyOiB7CiAgICAgICAgICAgIGlkOiBjb29raWUuY3JlYXRvciwKICAgICAgICAgICAgbmFtZTogY29va2llLmVtYWlsLAogICAgICAgIH0sCiAgICAgICAgZXhjaGFuZ2VSYXRlOiB7fSwKICAgICAgICBiYXNlQ3VycmVuY3lDb2RlOiAiIiwKICAgICAgICBjdXJyZW5jeUNvZGU6ICIiLAogICAgICAgIHRyYW5zYWN0aW9uUmF0ZTogMSwKICAgICAgICBqUmF3OiBbXSwKICAgICAgICByZWZGcm9tOiBbXSwKICAgICAgICBpc1ByaWNlTGV2ZWxDaGFuZ2VkOiBmYWxzZSwKICAgICAgICBleHBlbnNlczogW10sCiAgICAgICAgYWRkaXRpb25hbENvc3RUb3RhbDogMCwKICAgICAgICBjaGtDaGVja2VkOiBbXSwKICAgICAgICBhY2NXaXRoaG9sZGluZ0V4cGVuc2U6IFtdCiAgICB9KSwKICAgIG1ldGhvZHM6IHsKICAgICAgICBkYXRhQm91bmQ6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBrZW5kby5qUXVlcnkoIiNncmlkSXRlbUxpbmUiKS5kYXRhKCJrZW5kb0dyaWQiKTsKICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBlLnNlbmRlci5pdGVtcygpOwogICAgICAgICAgICBpZiAoZ3JpZCkgewogICAgICAgICAgICAgICAgaXRlbXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGFJdGVtID0gZ3JpZC5kYXRhSXRlbSh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAkKCJ0cltkYXRhLXVpZD0nIiArIGRhdGFJdGVtLnVpZCArICInXSIpLmZpbmQoJy5pc0VkaXRhYmxlJykKICAgICAgICAgICAgICAgICAgICAgICAgLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFJdGVtLmlzRWRpdGFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiay1zdGF0ZS1kaXNhYmxlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBvbk1ldGhvZENoYW5nZWQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSXRlbSgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUFkZGl0aW9uYWxDb3N0KCkKICAgICAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG9uQ2hlY2tDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0l0ZW0oKSkgewogICAgICAgICAgICAgICAgdGhpcy5hZGRpdGlvbmFsQ29zdFRvdGFsID0gMAogICAgICAgICAgICAgICAgdGhpcy5qUmF3ID0gW10KICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoa0NoZWNrZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoa0NoZWNrZWQuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHhBbW91bnQgPSBtLmV4Y2hhbmdlQW1vdW50IHx8IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkaXRpb25hbENvc3RUb3RhbCArPSBwYXJzZUZsb2F0KHhBbW91bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QgPSB0aGlzLmNoa0NoZWNrZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmFkZGl0aW9uYWxDb3N0VG90YWwgPSB0aGlzLmFkZGl0aW9uYWxDb3N0VG90YWwKICAgICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdE1ldGhvZCA9PT0gJ1F0eSBCYXNlZCcpIHsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5wZXJjZW50YWdlQXBwbGllZCgpCiAgICAgICAgICAgICAgICAgICAgLy8gfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5hbW91bnRBcHBsaWVkKCkKICAgICAgICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVBZGRpdGlvbmFsQ29zdCgpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgb25QcmljZUxldmVsQ2hhbmdlKCkgewogICAgICAgICAgICB0aGlzLmlzUHJpY2VMZXZlbENoYW5nZWQgPSB0cnVlCiAgICAgICAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9uUmF0ZSgpCiAgICAgICAgICAgIHRoaXMuY2xlYXJVT01JdGVtKCkKICAgICAgICB9LAogICAgICAgIGFzeW5jIGNsZWFyVU9NSXRlbSgpIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgZHMuZGF0YSgpLm1hcChuID0+IHsKICAgICAgICAgICAgICAgIG4uc2V0KCd1b20nLCB7fSkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5pc1ByaWNlTGV2ZWxDaGFuZ2VkID0gZmFsc2UKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQYXltZW50VGVybUxpc3QoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbmRvcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2lkPScgKyB0aGlzLnZlbmRvci5pZCArICcmdHJhbnNhY3Rpb25EYXRlPScgKyB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSArICcmdHlwZT1WZW5kb3InCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0gPSB7fQogICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50VGVybUhhbmRsZXJfLmdldChzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlcm1zID0gcmVzLmRhdGEuZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0gPSB0ZXJtcy50ZXJtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vblBheW1lbnRUZXJtQ2hhbmdlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkQ3JlZGl0TGltaXQoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbmRvcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2lkPScgKyB0aGlzLnZlbmRvci5pZCArICcmdHJhbnNhY3Rpb25EYXRlPScgKyB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSArICcmdHlwZT1WZW5kb3InCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuY3JlZGl0TGltaXQgPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWRpdExpbWl0SGFuZGxlci5nZXQoc3RyRmlsdGVyKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVkaXQgPSByZXMuZGF0YS5kYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5jcmVkaXRMaW1pdCA9IGtlbmRvLnBhcnNlRmxvYXQoY3JlZGl0LmFtb3VudCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIG9ic2VydmVyQ2xlYW4ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLnJlZHVjZSgKICAgICAgICAgICAgICAgIChyZXMsIGUpID0+IE9iamVjdC5hc3NpZ24ocmVzLCB7W2VdOiBvYmpbZV19KSwKICAgICAgICAgICAgICAgIHt9CiAgICAgICAgICAgICk7CiAgICAgICAgfSwKICAgICAgICBIZWxwKGtleV9zZWFyY2gpIHsKICAgICAgICAgICAgU2hvd1Jlc291cmNlKGtleV9zZWFyY2gpOwogICAgICAgIH0sCiAgICAgICAgQW1vdW50RWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IGRhdGEtYmluZD0idmFsdWU6JyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9OdW1lcmljVGV4dEJveCh7CiAgICAgICAgICAgICAgICAgICAgZGVjaW1hbHM6IDMwLAogICAgICAgICAgICAgICAgICAgIGZvcm1hdDogYCR7dGhpcy5wdXJjaGFzZUZvcm1Db250ZW50LmRlY2ltYWx9YCwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdmF0VGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgdmF0ID0gZGF0YUl0ZW0udmF0VGF4IHx8IHt9OwogICAgICAgICAgICBpZiAodmF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7dmF0LmRlZmF1bHRUYXggPyB2YXQuZGVmYXVsdFRheCA6IGBgfTwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGBgOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBpdGVtVGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgaXRlbSA9IGRhdGFJdGVtLml0ZW07CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7aXRlbS5uYW1lID8gaXRlbS5uYW1lIDogYGB9PC9zcGFuPmA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYGA7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFVPTVRlbXBsYXRlKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIGNvbnN0IHVvbSA9IGRhdGFJdGVtLnVvbSB8fCB7fTsKICAgICAgICAgICAgY29uc3QgY29kZSA9IHVvbS5jb2RlIHx8ICcnCiAgICAgICAgICAgIGlmICh1b20pIHsKICAgICAgICAgICAgICAgIHJldHVybiBgPHNwYW4+JHt1b20udW9tID8gY29kZSA6IGBgfTwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGBgOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkaXNjb3VudEl0ZW1UZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICAgICAgICBjb25zdCBkaXNjb3VudEl0ZW0gPSBkYXRhSXRlbS5kaXNjb3VudEl0ZW07CiAgICAgICAgICAgIGlmIChkaXNjb3VudEl0ZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBgPHNwYW4+JHtkaXNjb3VudEl0ZW0uY29kZSA/IGRpc2NvdW50SXRlbS5jb2RlIDogYGB9IC0gJHsKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudEl0ZW0ubmFtZSA/IGRpc2NvdW50SXRlbS5uYW1lIDogYGAKICAgICAgICAgICAgICAgIH08L3NwYW4+YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBgYDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWRkU2VsZWN0KCkgewogICAgICAgICAgICBsZXQgYW1vdW50X251bSA9IHRoaXMubnVtU2VsZWN0Lmxlbmd0aDsKICAgICAgICAgICAgbGV0IG51bSA9IHRoaXMubnVtU2VsZWN0W2Ftb3VudF9udW0gLSAxXTsKICAgICAgICAgICAgbGV0IG5ld19udW0gPSBudW0gKyAxOwogICAgICAgICAgICBsZXQgbGVuZ2h0SXRlbSA9IHRoaXMuc3BlY2lmaWNEaXNjb3VudEl0ZW0ubGVuZ3RoOwogICAgICAgICAgICBpZiAobmV3X251bSA8PSBsZW5naHRJdGVtKSB7CiAgICAgICAgICAgICAgICB0aGlzLm51bVNlbGVjdC5wdXNoKG5ld19udW0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZW1vdmVTZWxlY3QoaW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5udW1TZWxlY3Quc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGluZGV4LCB0aGlzLm51bVNlbGVjdCkKICAgICAgICAgICAgLy8gdGhpcy5zZWxlY3REaXNjb3VudC5zcGxpY2UoaW5kZXgsMSkKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCJyZW1vdmUiLHRoaXMuc2VsZWN0RGlzY291bnQpCiAgICAgICAgICAgIC8vIHRoaXMuc2VsZWN0RGlzY291bnQgPSB0aGlzLnNlbGVjdERpc2NvdW50LmZpbHRlcihpdGVtID0+ICBpdGVtLmlkICE9IHZhbC5pZCk7CiAgICAgICAgfSwKICAgICAgICBvbk90aGVyQ2hhcmdlQ2hhbmdlKCkgewogICAgICAgICAgICBsZXQgb3RoZXJDaGFyZ2UgPSAwOwogICAgICAgICAgICB0aGlzLm1PdGhlckNoYXJnZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSArPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudChtLCB0aGlzLnB1cmNoYXNlLnN1YlRvdGFsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uub3RoZXJDaGFyZ2VBbW91bnQgPSBvdGhlckNoYXJnZTsKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgfSwKICAgICAgICBvbk90aGVyQW1vdW50KHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCh2YWx1ZSwgdGhpcy5wdXJjaGFzZS5zdWJUb3RhbCk7CiAgICAgICAgfSwKICAgICAgICBvblNwZWNpZmljRGlzY291bnRDaGFuZ2VkKCkgewogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRUb3RhbCA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJy1jaGFuZ2VkJywgdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSkKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsID0KICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCgKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zdWJUb3RhbAogICAgICAgICAgICAgICAgICAgICkgfHwgMDsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UudG90YWwgPQogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS5zdWJUb3RhbCkgLQogICAgICAgICAgICAgICAgICAgIChrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UuZGlzY291bnRUb3RhbCkgKwogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudG90YWxUYXhBbW91bnQpKSAtCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlRGlzY291bnQoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudEl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3ViVG90YWwKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgIH0sCiAgICAgICAgZW1wSW1wbChkYXRhSXRlbSkgewogICAgICAgICAgICBsZXQgZW1wSWRzID0gW107CiAgICAgICAgICAgIGRhdGFJdGVtLmVtcGxveWVlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgIGVtcElkcy5wdXNoKG0uZmlyc3ROYW1lICsgIiAtICIgKyBtLmxhc3ROYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhlbXBJZHMuam9pbignLCAnKSkKICAgICAgICAgICAgcmV0dXJuIGA8c3Bhbj4ke2VtcElkcy5qb2luKCIsICIpfTwvc3Bhbj5gOwogICAgICAgIH0sCiAgICAgICAgdW9tVG1wKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhSXRlbSk7CiAgICAgICAgICAgIHJldHVybiBkYXRhSXRlbTsKICAgICAgICB9LAogICAgICAgIG9uSW52b2ljZVR5cGVDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSBudWxsIHx8IHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVOdW1iZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXV0b0NhbGN1bGF0ZVRheEJ5VHlwZSh0YXgpIHsKICAgICAgICAgICAgLy8gcmV0dXJuIGJ5IGEga2V5CiAgICAgICAgICAgIGNvbnN0IGdyb3VwQWxsID0gKGxpc3QpID0+CiAgICAgICAgICAgICAgICBsaXN0LnJlZHVjZSgodGF4LCBpdGVtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGF4QW1vdW50ID0gdGF4W2l0ZW0ubmFtZV0gfHwgMDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdGF4LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIFtpdGVtLm5hbWVdOiB0YXhBbW91bnQgKyBwYXJzZUZsb2F0KGl0ZW0uYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIHt9KTsKICAgICAgICAgICAgdGhpcy50YXhMaXN0VG90YWwgPSBncm91cEFsbCh0YXgpOwogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coIm5pbW9sIiwgZ3JvdXBBbGwodGF4KSk7CiAgICAgICAgfSwKICAgICAgICBvbkRlcG9zaXREZWR1Y3Rpb25DaGFuZ2UoKSB7CiAgICAgICAgICAgIGNvbnN0IGRlZHVjdCA9IHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uIHx8IDApCiAgICAgICAgICAgIGlmIChkZWR1Y3QgPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24gPSAwCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9PT0gIiIgfHwgdGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgZGVkdWN0aW9uID0gcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24pIHx8IDA7CiAgICAgICAgICAgIGlmIChkZWR1Y3Rpb24gPiB0aGlzLnB1cmNoYXNlLmRlcG9zaXRBbW91bnQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbiA9IHRoaXMucHVyY2hhc2UuZGVwb3NpdEFtb3VudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBhdXRvQ2FsY3VsYXRlKCkgewogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICAgICAgICAgIHN1YlRvdGFsID0gMCwKICAgICAgICAgICAgICAgIHRvdGFsVGF4ID0gMCwKICAgICAgICAgICAgICAgIGRpc2NvdW50VG90YWwgPSAwLAogICAgICAgICAgICAgICAgc3BUYXggPSAwLAogICAgICAgICAgICAgICAgcGx0YXggPSAwLAogICAgICAgICAgICAgICAgb3RoZXJUYXggPSAwLAogICAgICAgICAgICAgICAgdmF0VGF4ID0gMCwKICAgICAgICAgICAgICAgIGRpc2NvdW50SW52b2ljZSA9IDAsCiAgICAgICAgICAgICAgICB0YXhMaXN0ID0gW10sCiAgICAgICAgICAgICAgICB0YXhMaXN0RGV0YWlsID0gW10sCiAgICAgICAgICAgICAgICBkaXNjb3VudEl0ZW0gPSBbXSwKICAgICAgICAgICAgICAgIGRpc2NvdW50TGluZSA9IFtdLAogICAgICAgICAgICAgICAgaW5jbHVzaXZlVGF4ID0gMCwKICAgICAgICAgICAgICAgIHRheFR5cGVJZCA9IDAsCiAgICAgICAgICAgICAgICB3aXRoaG9sZGluZ1RheEFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICB3aFRheEFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICBpdGVtU3VidG90YWwgPSAwLAogICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgPSAwLAogICAgICAgICAgICAgICAgc2VydmljZVN1YnRvdGFsID0gMCwKICAgICAgICAgICAgICAgIGl0ZW1EaXNjb3VudCA9IDAsCiAgICAgICAgICAgICAgICBzZXJ2aWNlRGlzY291bnQgPSAwLAogICAgICAgICAgICAgICAgdHhuRGlzY291bnQgPSAwOwogICAgICAgICAgICBsZXQgbmF0dXJlID0gIiI7CiAgICAgICAgICAgIHRoaXMualJhdyA9IFtdOwogICAgICAgICAgICBjb25zdCByb3dzID0gZHMuZGF0YSgpLmZpbHRlcigobSkgPT4gcGFyc2VGbG9hdChtLmFtb3VudCkgPiAwKTsKICAgICAgICAgICAgcm93cy5mb3JFYWNoKCh2YWx1ZSkgPT4gewogICAgICAgICAgICAgICAgbGV0IG1vZGlmaWVyUHJpY2UgPSAwLCBpbmNUYXggPSAwOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlLm1vZGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJQcmljZSA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUubW9kaWZpZXIucHJpY2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCBkaXNjb3VudCA9IDA7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuZGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzSXRlbUZpZWxkID0gdmFsdWUuZGlzY291bnRJdGVtOwogICAgICAgICAgICAgICAgICAgIGxldCBzdWJUbyA9CiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuY29zdCkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSk7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnQgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCh2YWx1ZS5kaXNjb3VudEl0ZW0sIHN1YlRvKTsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsiZGlzY291bnRBbW91bnQiXSA9IGRpc2NvdW50OwogICAgICAgICAgICAgICAgICAgIHZhbHVlWyJkaXNjb3VudEV4Y2hhbmdlQW1vdW50Il0gPQogICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUuZGlzY291bnRJdGVtLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvdW50SXRlbS5wdXNoKHZhbHVlLmRpc2NvdW50SXRlbSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50VG90YWwgKz0gZGlzY291bnQgPyBkaXNjb3VudCA6IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc2NvdW50ICogLTEgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc0l0ZW1GaWVsZC5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNJdGVtRmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkaXNJdGVtRmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJQdXJjaGFzZSBEaXNjb3VudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogZGlzSXRlbUZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkaXNJdGVtRmllbGQuYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGRpc2NvdW50ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogImRpc2NvdW50IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZhbHVlLnZhdFRheCkgewogICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnVmF0IFRheCcsIHZhbHVlLnRheCkKICAgICAgICAgICAgICAgICAgICBsZXQgYW10ID0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzcFRheCA/IHNwVGF4IDogMCkgKwogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHBsdGF4ID8gcGx0YXggOiAwKSArCiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXggPyBvdGhlclRheCA6IDApICsKICAgICAgICAgICAgICAgICAgICAgICAgKGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50ID8gdmFsdWUuYW1vdW50IDogMCkgLQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGRpc2NvdW50ID8gZGlzY291bnQgOiAwKSk7CiAgICAgICAgICAgICAgICAgICAgdmF0VGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KHZhbHVlLnZhdFRheCwgYW10KTsKICAgICAgICAgICAgICAgICAgICB2YXRUYXggPSBrZW5kby5wYXJzZUZsb2F0KHZhdFRheCkgPyBrZW5kby5wYXJzZUZsb2F0KHZhdFRheCkgOiAwOwogICAgICAgICAgICAgICAgICAgIHZhbHVlWyJ2YXRUYXhBbW91bnQiXSA9IHZhdFRheDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsidmF0VGF4RXhjaGFuZ2VBbW91bnQiXSA9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhdFRheCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS52YXRUYXggfHwge307CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZUFtb3VudCA9IHRheC5iYXNlQW1vdW50IHx8ICcnOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyh0YXgsICJpbSB0YXgiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jVGF4ID0gdmF0VGF4CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdXNpdmVUYXggKz0gdmF0VGF4OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWUudmF0VGF4LnRheFR5cGUubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdmF0VGF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZhbHVlLnZhdFRheC50YXhUeXBlLmlkLAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmF0VGF4XyA9IHZhbHVlLnZhdFRheCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWyd0YXhBbW91bnRfJ10gPSB2YXRUYXgKICAgICAgICAgICAgICAgICAgICAgICAgdmF0VGF4X1snYW1vdW50J10gPSB2YWx1ZS5hbW91bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWydkaXNjb3VudCddID0gZGlzY291bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWyd0eG5SYXRlJ10gPSB0aGlzLnB1cmNoYXNlLnR4blJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWydpc1ZhdCddID0gMQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfLmRldGFpbCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZmljVGF4OiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpY0xpZ2h0aW5nVGF4OiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyVGF4OiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0RGV0YWlsLnB1c2godmF0VGF4Xyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygndmF0XycsIHZhdFRheF8pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXhUeXBlID0gdmFsdWUudmF0VGF4LnRheFR5cGUgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgIHRheFR5cGVJZCA9IHRheFR5cGUudHlwZUlkIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxldCB0YXhBbW91bnQgPSB2YXRUYXg7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRheERlc2NyaXB0aW9uID0gIiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRheFR5cGVJZCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiZHIiOwogICAgICAgICAgICAgICAgICAgICAgICB0YXhBbW91bnQgPSB2YXRUYXg7CiAgICAgICAgICAgICAgICAgICAgICAgIHRheERlc2NyaXB0aW9uID0gIlB1cmNoYXNlIFRheCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXhUeXBlSWQgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGhvbGRpbmdUYXhBbW91bnQgKz0gdmF0VGF4OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGF4VHlwZUlkID09PSAyICYmIGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gJ25ldCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoVGF4QW1vdW50ICs9IHZhdFRheDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgICAgICB0YXhBbW91bnQgPSB2YXRUYXggKiAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4RGVzY3JpcHRpb24gPSAiV2l0aGhvbGRpbmcgVGF4IjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRheFR5cGVJZCA9PT0gMTApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4QW1vdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4RGVzY3JpcHRpb24gPSAiTm8gVGF4IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRheEFtb3VudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCB2YXRUYXhGaWVsZCA9IHZhbHVlLnZhdFRheCB8fCB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAodGF4QW1vdW50ICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YXRUYXhGaWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhdFRheEZpZWxkLmFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmF0VGF4RmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdmF0VGF4RmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0YXhEZXNjcmlwdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHZhdFRheEZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHZhdFRheEZpZWxkLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHRheEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRheEFtb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogInRheCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRvdGFsVGF4ICs9IGtlbmRvLnBhcnNlRmxvYXQoc3BUYXggPyBzcFRheCA6IDApICsga2VuZG8ucGFyc2VGbG9hdChwbHRheCA/IHBsdGF4IDogMCkgKwogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQob3RoZXJUYXggPyBvdGhlclRheCA6IDApICsKICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHZhdFRheCA/IHZhdFRheCA6IDApOwogICAgICAgICAgICAgICAgc3ViVG90YWwgKz0ga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpICsgbW9kaWZpZXJQcmljZSAtIGluY1RheDsKICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuYW1vdW50KSArIG1vZGlmaWVyUHJpY2U7CiAgICAgICAgICAgICAgICBjb25zdCBhbXQgPSB0aGlzLmV4Y2x1ZGVWQVRUYXhJbmNsdXNpdmUodmFsdWUudmF0VGF4LCBhbW91bnQsIGluY1RheCkKICAgICAgICAgICAgICAgIC8vIGNvbnN0IHhBbW91bnQgPSAoa2VuZG8ucGFyc2VGbG9hdChhbXQpICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpKQogICAgICAgICAgICAgICAgY29uc3QgYWRkaXRjID0gdmFsdWUuYWRkaXRpb25hbENvc3QgfHwgMAogICAgICAgICAgICAgICAgY29uc3QgaXRlbUFtb3VudCA9IGFtdAogICAgICAgICAgICAgICAgY29uc3QgaXRlbVhBbW91bnQgPSBpdGVtQW1vdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB2YWx1ZS5pdGVtOwogICAgICAgICAgICAgICAgY29uc3QgaXRtVHlwZSA9IGl0ZW0udHlwZSB8fCAiIjsKICAgICAgICAgICAgICAgIGlmIChpdG1UeXBlID09PSAiVmFyaWFudCIpIHsKICAgICAgICAgICAgICAgICAgICBpdGVtU3VidG90YWwgKz0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5jb3N0KSAqIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucXR5KTsKICAgICAgICAgICAgICAgICAgICBpdGVtRGlzY291bnQgKz0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0bVR5cGUgPT09ICJTZXJ2aWNlIikgewogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VTdWJ0b3RhbCArPQogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLmNvc3QpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VEaXNjb3VudCArPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgKz0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5jb3N0KSAqIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucXR5KTsKICAgICAgICAgICAgICAgICAgICB0eG5EaXNjb3VudCArPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChhbXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0udHlwZSA9PT0gIlNlcnZpY2UiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBsYW4gPSBpdGVtLmlzUGFuIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGxhbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaGFzT3duUHJvcGVydHkoImRlZmVycmVkSW5jb21lQWNjIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5kZWZlcnJlZEluY29tZUFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVmZXJyZWRJbkFjYyA9IGl0ZW0uZGVmZXJyZWRJbmNvbWVBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkZWZlcnJlZEluQWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMucHVyY2hhc2Uuam91cm5hbE5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBkZWZlcnJlZEluQWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkZWZlcnJlZEluQWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBpdGVtQW1vdW50ICogLTEsIC8vIHF0eSphdmdfY29zdCAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogaXRlbVhBbW91bnQsIC8vLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJjb3N0T2ZHb29kc1NvbGRBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmNvc3RPZkdvb2RzU29sZEFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgY29zdE9mR29vZHNTb2xkQWNjID0gaXRlbS5jb3N0T2ZHb29kc1NvbGRBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBjb3N0T2ZHb29kc1NvbGRBY2MuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uY29zdE9mR29vZHNTb2xkQWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmNvc3RPZkdvb2RzU29sZEFjYy5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBpdGVtWEFtb3VudCwgLy94QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS50eXBlID09PSAiVmFyaWFudCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW1vdW50V2l0aEFkZGljdCA9IChpdGVtQW1vdW50ICsgKHZhbHVlLmFtb3VudEFwcGxpZWQgfHwgMCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnYWRkaXRjJywgYWRkaXRjLCAnLScsIGl0ZW1BbW91bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJpbnZlbnRvcnlBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaW52ZW50b3J5QWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGludmVudG9yeUFjYyA9IGl0ZW0uaW52ZW50b3J5QWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGludmVudG9yeUFjYy5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogaXRlbS5pbnZlbnRvcnlBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogaXRlbS5pbnZlbnRvcnlBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50V2l0aEFkZGljdCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGFtb3VudFdpdGhBZGRpY3QgKiAodGhpcy5wdXJjaGFzZS50eG5SYXRlIHx8IDEpLCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gIkZpeGVkIEFzc2V0IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5oYXNPd25Qcm9wZXJ0eSgiYXNzZXRBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uYXNzZXRBY2MuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzZXRBY2MgPSBpdGVtLmFzc2V0QWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGFzc2V0QWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLnB1cmNoYXNlLmpvdXJuYWxOb3RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmFzc2V0QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uYXNzZXRBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGl0ZW1YQW1vdW50LCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gIlRyYW5zYWN0aW9uIEl0ZW0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJhY2NvdW50IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpdGVtLmFjY291bnQuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMucHVyY2hhc2Uuam91cm5hbE5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGl0ZW1YQW1vdW50LCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL2luY2x1ZGUgVGF4IEFtb3VudAogICAgICAgICAgICAgICAgY29uc3QgYW1vdW50Tm9kaXNjb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUuY29zdCkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSkgLSBkaXNjb3VudDsKICAgICAgICAgICAgICAgIGNvbnN0IGluY2x1ZGVUYXhBbW91bnQgPSBhbW91bnROb2Rpc2NvdW50ICsgdmF0VGF4ICsgcGx0YXggKyBzcFRheCArIG90aGVyVGF4OwogICAgICAgICAgICAgICAgdmFsdWVbImluY2x1ZGVUYXhBbW91bnQiXSA9IGluY2x1ZGVUYXhBbW91bnQ7CiAgICAgICAgICAgICAgICB2YWx1ZVsiaW5jbHVkZVRheEV4Y2hhbmdlQW1vdW50Il0gPSBpbmNsdWRlVGF4QW1vdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy90b2RvOiBXaXRoaG9sZGluZ1RheCBleHBlbnNlCiAgICAgICAgICAgIHRoaXMud2l0aGhvbGRpbmdFeHBlbnNlKHdoVGF4QW1vdW50LCB0aGlzLnB1cmNoYXNlLnR4blJhdGUgfHwgMSkKCiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuaXRlbVN1YnRvdGFsID0gaXRlbVN1YnRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmluY2x1c2l2ZVRheEFtb3VudCA9IGluY2x1c2l2ZVRheDsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5leGNoYW5nZUl0ZW1TdWJ0b3RhbCA9IGl0ZW1TdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKCiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc2VydmljZVN1YnRvdGFsID0gc2VydmljZVN1YnRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlU2VydmljZVN1YnRvdGFsID0KICAgICAgICAgICAgICAgIHNlcnZpY2VTdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50eG5JdG1TdWJ0b3RhbCA9IHR4bkl0bVN1YnRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlVHhuSXRtU3VidG90YWwgPQogICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudHhuUmF0ZSk7CgogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLml0ZW1EaXNjb3VudCA9IGl0ZW1EaXNjb3VudDsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5leGNoYW5nZUl0ZW1EaXNjb3VudCA9CiAgICAgICAgICAgICAgICBpdGVtRGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudHhuUmF0ZSk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc2VydmljZURpc2NvdW50ID0gc2VydmljZURpc2NvdW50OwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlU2VydmljZURpc2NvdW50ID0KICAgICAgICAgICAgICAgIHNlcnZpY2VEaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50eG5JdG1EaXNjb3VudCA9IHR4bkRpc2NvdW50OwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlVHhuSXRtRGlzY291bnQgPQogICAgICAgICAgICAgICAgdHhuRGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudHhuUmF0ZSk7CgogICAgICAgICAgICBsZXQgdG90YWwgPQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzdWJUb3RhbCkgLQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudFRvdGFsKSArCiAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRvdGFsVGF4KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zdWJUb3RhbCA9IHN1YlRvdGFsOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRvdGFsVGF4QW1vdW50ID0ga2VuZG8ucGFyc2VGbG9hdCh0b3RhbFRheCk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGlzY291bnRUb3RhbCA9IGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnRUb3RhbCk7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICBkaXNjb3VudEludm9pY2UgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudCgKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtLAogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQoc3ViVG90YWwpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgZGlzY291bnRJbnZvaWNlID0gZGlzY291bnRJbnZvaWNlID8gZGlzY291bnRJbnZvaWNlIDogMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGlzLm9uT3RoZXJDaGFyZ2VDaGFuZ2UoKQogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRvdGFsID0ga2VuZG8ucGFyc2VGbG9hdCh0b3RhbCkgLSBkaXNjb3VudEludm9pY2UgKyBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2Uub3RoZXJDaGFyZ2VBbW91bnQpIC8vLSBwYXJzZUZsb2F0KHdpdGhob2xkaW5nVGF4QW1vdW50KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS53aXRoaG9sZGluZ1RheEFtb3VudCA9IHdpdGhob2xkaW5nVGF4QW1vdW50CiAgICAgICAgICAgIC8vIHRoaXMucHVyY2hhc2UudG90YWxBZnRlcldpdGhob2xkaW5nVGF4ID0ga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnRvdGFsKSAtIHBhcnNlRmxvYXQod2l0aGhvbGRpbmdUYXhBbW91bnQpOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnJlbWFpbmluZ0Ftb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50b3RhbCkgLSBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UuZGVwb3NpdERlZHVjdGlvbikgLSBwYXJzZUZsb2F0KHdpdGhob2xkaW5nVGF4QW1vdW50KTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5hbW91bnREdWUgPSBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2UudG90YWwpIC0ga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24pIC0gcGFyc2VGbG9hdCh3aXRoaG9sZGluZ1RheEFtb3VudCk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VBbW91bnQgPQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLmFtb3VudER1ZSkgKgogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ0V4Y2hhbmdlIEFtb3VudCcsIHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VBbW91bnQsIHRoaXMucHVyY2hhc2UuYW1vdW50RHVlKQogICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGVUYXhCeVR5cGUodGF4TGlzdCk7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVjaWZpY0Rpc2NvdW50ID0gdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSB8fCB7fTsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2NvdW50LmlkKSB7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnRJdGVtLnB1c2goc3BlY2lmaWNEaXNjb3VudCk7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnRMaW5lLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpZDogc3BlY2lmaWNEaXNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogc3BlY2lmaWNEaXNjb3VudC5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsICogdGhpcy5wdXJjaGFzZS50eG5SYXRlLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHVuaXF1ZURpc2NvdW50SXRlbSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKGRpc2NvdW50SXRlbSk7CiAgICAgICAgICAgIHRoaXMuc2hyaW5rRGlzY291bnRJdGVtKHVuaXF1ZURpc2NvdW50SXRlbSwgZGlzY291bnRMaW5lKTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdkaXNjb3VudCAnLCB0aGlzLmN1c3RvbWVyRGlzY291bnRJdGVtKQogICAgICAgICAgICAvLyB0b2RvOiByYXcgSm91cm5hbAogICAgICAgICAgICBjb25zdCBhcEFjYyA9IHRoaXMucHVyY2hhc2UuYXBBY2MgfHwge307CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmFtb3VudER1ZSAqIC0xID4gMCkgewogICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJjciI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFwQWNjKSB7CiAgICAgICAgICAgICAgICBpZiAoYXBBY2MuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBhcEFjYy5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwoe30pLAogICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogYXBBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogYXBBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlQW1vdW50ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5wdXJjaGFzZS5hbW91bnREdWUgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJhcCIsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3Qgc3BlY2lmaWNEaXNjID0gdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbTsKICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsICogLTEgPiAwKSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiZHIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coc3BlY2lmaWNEaXNjLCAnc3BlY2lmaWNEaXNjJywgdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwpCiAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2MpIHsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2MuaGFzT3duUHJvcGVydHkoImFjY291bnQiKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY0Rpc2MuYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHNwZWNpZmljRGlzYy5hY2NvdW50LmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHt9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIlB1cmNoYXNlIERpc2NvdW50IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBzcGVjaWZpY0Rpc2MuYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwZWNpZmljRGlzYy5hY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRoaXMucHVyY2hhc2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsKSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiZGlzY291bnQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24gKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmRlcG9zaXREZWR1Y3Rpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVyY2hhc2VEZXBvc2l0QWNjID0gdGhpcy52ZW5kb3IucHVyY2hhc2VEZXBvc2l0QWNjIHx8IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChwdXJjaGFzZURlcG9zaXRBY2MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHB1cmNoYXNlRGVwb3NpdEFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBwdXJjaGFzZURlcG9zaXRBY2MuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJQdXJjaGFzZSBEZXBvc2l0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogcHVyY2hhc2VEZXBvc2l0QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogcHVyY2hhc2VEZXBvc2l0QWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlRGVwb3NpdERlZHVjdGlvbiAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogImRlcG9zaXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMubU90aGVyQ2hhcmdlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGxldCBvdGhlckNoYXJnZSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLm1PdGhlckNoYXJnZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2UgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudChtLCB0aGlzLnB1cmNoYXNlLnN1YlRvdGFsKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXJDaGFyZ2UgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uaGFzT3duUHJvcGVydHkoImFjY291bnQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY291bnQgPSBtLmFjY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJPdGhlciBDaGFyZ2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBhY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IG90aGVyQ2hhcmdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJvdGhlckNoYXJnZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gdGhpcy5wdXJjaGFzZS5vdGhlckNoYXJnZUFtb3VudCA9IG90aGVyQ2hhcmdlCiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2codGhpcy5tT3RoZXJDaGFyZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudGF4TGlzdERldGFpbCA9IHRheExpc3REZXRhaWwKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlVGF4RGV0YWlsKCkKICAgICAgICAgICAgLy8gdG9kbzogZW5kIHJhdyBKb3VybmFsCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh0aGlzLnB1cmNoYXNlKSwgJ3B1cmNoYXNlJykKCiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FsY3VsYXRlQWRkaXRpb25hbENvc3QoKQogICAgICAgICAgICAvLyB0b2RvOiBjb29rIGpvdXJuYWwKICAgICAgICAgICAgdGhpcy5zaHJpbmtEYXRhKHRoaXMualJhdyk7CiAgICAgICAgICAgIC8vIGNvbnN0IHVuaXF1ZSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKHRoaXMuYWNjb3VudHMpCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh1bmlxdWUsICd1bmlxdWUnKQogICAgICAgIH0sCiAgICAgICAgd2l0aGhvbGRpbmdFeHBlbnNlKGFtb3VudCwgdHhuUmF0ZSkgewogICAgICAgICAgICAvLyBpZiAodGhpcy5pc0l0ZW0oKSkgewogICAgICAgICAgICBpZiAoYW1vdW50ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgbmF0dXJlID0gJ2RyJwogICAgICAgICAgICAgICAgY29uc3QgYWNjb3VudCA9IHRoaXMuYWNjV2l0aGhvbGRpbmdFeHBlbnNlIHx8IFtdCiAgICAgICAgICAgICAgICBpZiAoYWNjb3VudC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWFjYyA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpYWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiV2l0aGhvbGRpbmcgVGF4IEV4cGVuc2UiLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpYWNjLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGlhY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBhbW91bnQgKiB0eG5SYXRlLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJXaXRoaG9sZGluZyIsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gfQogICAgICAgIH0sCiAgICAgICAgc2hyaW5rRGF0YShvYmopIHsKICAgICAgICAgICAgY29uc3QgdW5pcXVlcyA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKAogICAgICAgICAgICAgICAgb2JqCiAgICAgICAgICAgICk7IC8qWy4uLm5ldyBTZXQoYWNjb3VudElkLm1hcChpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgaWRfOiBpLmlkXywKICAgICAgICAgICAgICAgICAgICBpZDogaS5pZCwKICAgICAgICAgICAgICAgICAgICB0eXBlOiBpLnR5cGUKICAgICAgICAgICAgfSkpXSovCiAgICAgICAgICAgIHVuaXF1ZXMuZm9yRWFjaCgobikgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSBvYmouZmlsdGVyKChtKSA9PiBtLmlkID09PSBuLmlkKTsKICAgICAgICAgICAgICAgIGxldCBhbW91bnQgPSAwOwogICAgICAgICAgICAgICAgZm91bmQuZm9yRWFjaCgoeikgPT4gewogICAgICAgICAgICAgICAgICAgIGFtb3VudCArPSBwYXJzZUZsb2F0KHouYW1vdW50IHx8IDApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBuLmFtb3VudCA9IHBhcnNlRmxvYXQoYW1vdW50KTsgLy90aGlzLm51bWJlckZvcm1hdChhbW91bnQpCiAgICAgICAgICAgICAgICBuLmV4Y2hhbmdlQW1vdW50ID0gcGFyc2VGbG9hdCgKICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKSkKICAgICAgICAgICAgICAgICk7IC8vdGhpcy5udW1iZXJGb3JtYXQoYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpKSAvLy50b0ZpeGVkKHRoaXMuc2FsZUZvcm1Db250ZW50LmRlY2ltYWwpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmpSYXcgPSB1bmlxdWVzOwogICAgICAgICAgICBsZXQgZHIgPSAwLAogICAgICAgICAgICAgICAgY3IgPSAwOwogICAgICAgICAgICB0aGlzLmpSYXcuZm9yRWFjaCgoaikgPT4gewogICAgICAgICAgICAgICAgc3dpdGNoIChqLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJjciI6CiAgICAgICAgICAgICAgICAgICAgICAgIGNyICs9IHBhcnNlRmxvYXQoai5leGNoYW5nZUFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgZHIgKz0gcGFyc2VGbG9hdChqLmV4Y2hhbmdlQW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRyID0gZHI7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuY3IgPSBjcjsKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJkcj0iLCBkciwgImNyPSIsIGNyLCAiZHIrY3IgPSAiLCBkciArIGNyKTsKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHVuaXF1ZXMpLCAndW5pcXVlcycpCiAgICAgICAgfSwKICAgICAgICBzaHJpbmtEaXNjb3VudEl0ZW0oZGlzY291bnRJdGVtLCBkaXNjb3VudExpbmUpIHsKICAgICAgICAgICAgbGV0IHVuaXF1ZURpc2NvdW50SXRlbXMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdW5pcXVlID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUoZGlzY291bnRJdGVtKTsKICAgICAgICAgICAgdW5pcXVlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gZGlzY291bnRMaW5lLmZpbHRlcigobikgPT4gbi5pZCA9PT0gbS5pZCk7CiAgICAgICAgICAgICAgICBsZXQgYW1vdW50ID0gMCwKICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICBmb3VuZC5tYXAoKG8pID0+IHsKICAgICAgICAgICAgICAgICAgICBhbW91bnQgKz0gby5hbW91bnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvdW5kLm1hcCgobykgPT4gewogICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50ICs9IG8uZXhjaGFuZ2VBbW91bnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHVuaXF1ZURpc2NvdW50SXRlbXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IG0uaWQsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbS5uYW1lLAogICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50LAogICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBleGNoYW5nZUFtb3VudCwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5zdXBwbGllckRpc2NvdW50SXRlbSA9IHVuaXF1ZURpc2NvdW50SXRlbXM7CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyh1bmlxdWVEaXNjb3VudEl0ZW1zLCAidW5pcXVlRGlzY291bnRJdGVtcyIpOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlRHVwbGljYXRlKGFycmF5KSB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICAgICAgICBjb25zdCBtYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBhcnJheSkgewogICAgICAgICAgICAgICAgaWYgKCFtYXAuaGFzKGl0ZW0uaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFwLnNldChpdGVtLmlkLCB0cnVlKTsgLy8gc2V0IGFueSB2YWx1ZSB0byBNYXAKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgbnVtYmVyRm9ybWF0KHZhbHVlKSB7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsLCduaW1vbCcpCiAgICAgICAgICAgIHJldHVybiBrZW5kby50b1N0cmluZyh2YWx1ZSwgYG4ke3RoaXMucHVyY2hhc2VGb3JtQ29udGVudC5kZWNpbWFsfWApOwogICAgICAgIH0sCiAgICAgICAgYXV0b0NhbGN1bGF0ZURpc2NvdW50KGRpc2NvdW50SXRlbSwgc3ViVG90YWwpIHsKICAgICAgICAgICAgaWYgKGRpc2NvdW50SXRlbSkgewogICAgICAgICAgICAgICAgY29uc3QgbmF0dXJlID0gZGlzY291bnRJdGVtLm5hdHVyZSB8fCAnJwogICAgICAgICAgICAgICAgY29uc3QgYW1vdW50ID0gZGlzY291bnRJdGVtLmFtb3VudCB8fCAwCiAgICAgICAgICAgICAgICBpZiAobmF0dXJlID09PSAnQW1vdW50JykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KGFtb3VudCkKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmF0dXJlID09PSAnUGVyY2VudGFnZScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHN1YlRvdGFsICogKHBhcnNlRmxvYXQoYW1vdW50KSAvIDEwMCkpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlVGF4KHRheCwgYW1vdW50KSB7CiAgICAgICAgICAgIGlmICh0YXgpIHsKICAgICAgICAgICAgICAgIHZhciBmb3JtdWxhID0gdGF4LmZvcm11bGE7CiAgICAgICAgICAgICAgICB2YXIgaW5BbXQgPSBrZW5kby5wYXJzZUZsb2F0KGFtb3VudCk7CiAgICAgICAgICAgICAgICB2YXIgbkFtdCA9IGtlbmRvLnBhcnNlRmxvYXQoYW1vdW50KTsKICAgICAgICAgICAgICAgIHZhciB0YXhCYXNlID0ga2VuZG8ucGFyc2VGbG9hdCh0YXgudGF4QmFzZSkgLyAxMDA7CiAgICAgICAgICAgICAgICB2YXIgcmF0ZSA9IGtlbmRvLnBhcnNlRmxvYXQodGF4LnJhdGUpIC8gMTAwOwogICAgICAgICAgICAgICAgdmFyIHRvdGFsID0gZXZhbChmb3JtdWxhKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhpbkFtdCwgbkFtdCwgdGF4QmFzZSwgcmF0ZSwgZm9ybXVsYSwgdG90YWwpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJldHVybiAwCiAgICAgICAgfSwKICAgICAgICB0YXhNYXBwaW5nKG9ialRheCwgdGF4KSB7CiAgICAgICAgICAgIGNvbnN0IHRheElkID0gdGF4LmlkIHx8ICcnCiAgICAgICAgICAgIGNvbnN0IHRheF8gPSBvYmpUYXguZmlsdGVyKHQgPT4gdC5pZCA9PT0gdGF4SWQpWzBdCiAgICAgICAgICAgIHJldHVybiB0YXhfIHx8IHsKICAgICAgICAgICAgICAgIGlkOiAnJywKICAgICAgICAgICAgICAgIGRlZmF1bHRUYXg6ICcnCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGRhdGFTb3VyY2VDaGFuZ2VkKGUpIHsKICAgICAgICAgICAgaWYgKGUuZmllbGQpIHsKICAgICAgICAgICAgICAgIGxldCBkYXRhUm93ID0gZS5pdGVtc1swXSwKICAgICAgICAgICAgICAgICAgICBidW9tID0ge30sIHZUYXggPSB7fSwKICAgICAgICAgICAgICAgICAgICBjb252ZXJzaW9uUmF0ZSA9IDEsCiAgICAgICAgICAgICAgICAgICAgd2FjID0gMCwKICAgICAgICAgICAgICAgICAgICBxb2ggPSAwLAogICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUuZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJpdGVtIjoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5hdHRyaWJ1dGVfID0gdGhpcy5hdHRyaWJ1dGVzLmZpbHRlcihtID0+IG0udHlwZS5pZCA9PT0gZGF0YVJvdy52YXJpYW50LmlkKQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZGVzY3JpcHRpb24iLCBkYXRhUm93Lml0ZW0uZGVzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBidW9tID0gZGF0YVJvdy5pdGVtLnVvbSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCBidW9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YVJvdy5zZXQoJ3VvbScsIGJ1b20pCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhUm93Lml0ZW0sJ3JvdycpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF3YWl0IHRoaXMuaW52ZW50b3J5QmFsYW5jZShkYXRhUm93LCBkYXRhUm93Lml0ZW0uaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImNvc3QiOgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpICogcGFyc2VGbG9hdChkYXRhUm93LnF0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4QW1vdW50ID0gYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJjb3N0IiwgcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3ByaWNlJyxkYXRhUm93LnByaWNlKQogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJjb3N0IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJ1b20iOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1ByaWNlTGV2ZWxDaGFuZ2VkID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVJvdy51b20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVvbSA9IGRhdGFSb3cudW9tLmJ1b20gfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHFvaCA9IGRhdGFSb3cudW9tLnFvaCB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzaW9uUmF0ZSA9IGRhdGFSb3cudW9tLmNvbnZlcnNpb25SYXRlIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhYyA9IGRhdGFSb3cudW9tLndhYyB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYnVvbSIsIGJ1b20pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgid2FjIiwgd2FjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInFvaCIsIHFvaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIHRvZG86IG1hcHBpbmcgdGF4IG9iamVjdCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2VGF4ID0gdGhpcy50YXhNYXBwaW5nKHRoaXMudGF4LCBkYXRhUm93LnVvbS5wdXJjaGFzZVRheCB8fCB7fSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJ2YXRUYXgiLCB2VGF4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgcGFyc2VGbG9hdChjb252ZXJzaW9uUmF0ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVJvdy51b20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChkYXRhUm93LnVvbS5jb3N0KSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiY29zdCIsIHBhcnNlRmxvYXQoZGF0YVJvdy51b20uY29zdCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCB4QW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IHBhcnNlRmxvYXQoZGF0YVJvdy5jb3N0KSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5wdXJjaGFzZS50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiY29zdCIsIHBhcnNlRmxvYXQoZGF0YVJvdy5jb3N0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgYW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJleGNoYW5nZUFtb3VudCIsIHhBbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJlcnJvciIsIGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvc3QiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicW9oIiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoIndhYyIsIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJxdHkiOgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpICogcGFyc2VGbG9hdChkYXRhUm93LnF0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4QW1vdW50ID0gYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLnB1cmNoYXNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJjb3N0IiwgcGFyc2VGbG9hdChkYXRhUm93LmNvc3QpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvc3QiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJleGNoYW5nZUFtb3VudCIsIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm90aGVyVGF4IjoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCItLSIsIGRhdGFSb3cpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGUuZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGUoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2RhdGFSb3cnLCBkYXRhUm93KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBTZXJ2aWNlRGF0ZUVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCByZXF1aXJlZCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0RhdGVQaWNrZXIoKTsKCiAgICAgICAgICAgIC8vIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkcy5kYXRhKCkpCiAgICAgICAgICAgIC8vIC8vIGNvbnN0IGRhdGVTdHJpbmcgPSBrZW5kby50b1N0cmluZygobmV3IERhdGUob3B0aW9ucy5tb2RlbC5pdGVtcy5zZXJ2aWNlRGF0ZSkpLCB0aGlzLml0ZW1MaW5lLmRhdGVGb3JtYXQpCiAgICAgICAgICAgIC8vIC8vIGNvbnN0IGRhdGVTdHJpbmcgPSBrZW5kby50b1N0cmluZyhvcHRpb25zLm1vZGVsLml0ZW1zLnNlcnZpY2VEYXRlKQogICAgICAgICAgICAvLyBjb25zdCAkaW5wdXQgPSAkKCI8aW5wdXQgdmFsdWU9IiArIG9wdGlvbnMubW9kZWwuc2VydmljZURhdGUgKyAiIC8+IikuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgICAgICAvLyAkaW5wdXQua2VuZG9EYXRlUGlja2VyKCkKICAgICAgICAgICAgLy8gLy8gJGlucHV0LmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgLy8gLy8gb3B0aW9ucy5tb2RlbC5pdGVtcy5zZXJ2aWNlRGF0ZSA9IGRhdGVTdHJpbmcKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCRpbnB1dCkKICAgICAgICB9LAogICAgICAgIFNlcnZpY2VEYXRlVG9FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgcmVxdWlyZWQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9EYXRlUGlja2VyKCk7CiAgICAgICAgfSwKICAgICAgICBJdGVtRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPkl0ZW1zIDwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBwcm9kdWN0VmFyaWFudEhhbmRsZXIuaXRlbVNlYXJjaFVSTCgnP3JlVXNlZD0yJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDoge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2t1OiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YTogdGhpcy52YXJpYW50cwogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBVT01Ecm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJjb2RlIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogInVvbUNvbnZlcnRJZCIsCiAgICAgICAgICAgICAgICAgICAgY2FzY2FkZUZyb206ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9Y29kZSB8fCBgYCM8L3NwYW4+IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyRmlsdGVyaW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVvbVByaWNlSGFuZGxlci51b21QcmljZUJ5UHJpY2VMZXZlbFVSTCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlkPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLml0ZW0uaWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJnBsSWQ9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucHJpY2VMZXZlbC5pZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICImZGF0ZT0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50eG5EYXRlICsgIiZuYXR1cmU9cHVyY2hhc2UiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuYW1lOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBza3U6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhOiB0aGlzLnZhcmlhbnRzCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIERpc2NvdW50SXRlbURyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IG5hbWU9IicgKyBvcHRpb25zLmZpZWxkICsgJyIvPicpCiAgICAgICAgICAgICAgICAuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgICAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgICAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiAic3RhcnRzd2l0aCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIGNhc2NhZGVGcm9tOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWNvZGUjIC0gIz1uYW1lIzwvc3Bhbj4iLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJGaWx0ZXJpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcG9ydDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogZGlzY291bnRJdGVtSGFuZGxlci5nZXRVUkwoRElTQ09VTlRfVFlQRSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDoge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2t1OiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgVmF0VGF4RHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAiZGVmYXVsdFRheCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJpZCIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWRlZmF1bHRUYXgjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLVNlbGVjdC0tIiwKICAgICAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdGhpcy50YXgsCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIEVtcGxveWVlRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgZGF0YS1iaW5kPSJ2YWx1ZTonICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb011bHRpU2VsZWN0KHsKICAgICAgICAgICAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICAgICAgICAgICAgc3VnZ2VzdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPkVtcGxveWVlIDwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBlbXBsb3llZUhhbmRsZXIuc2VhcmNoVVJMKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDoge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5jb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHJvd051bWJlclRtcGwoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCksCiAgICAgICAgICAgICAgICBpbmRleCA9IGRzLmluZGV4T2YoZGF0YUl0ZW0pOwogICAgICAgICAgICByZXR1cm4gaW5kZXggKyAxOwogICAgICAgIH0sCiAgICAgICAgYWRkUm93KCkgewogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICAgICAgICAgIHRvdGFsID0gZHMudG90YWwoKTsKICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5pZCA9IGl0ZW1MaW5lUHJlZml4ICsgdXVpZC52MSgpOwogICAgICAgICAgICB0aGlzLml0ZW1MaW5lLmRlY2ltYWxGb3JtYXQgPSAibiIgKyB0aGlzLnB1cmNoYXNlRm9ybUNvbnRlbnQuZGVjaW1hbDsKICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5pc0VkaXRhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgZHMuaW5zZXJ0KHRvdGFsLCB0aGlzLml0ZW1MaW5lKTsKCiAgICAgICAgICAgIC8vIGtlbmRvLmpRdWVyeSgpLmFkZENsYXNzKCdlZGl0JykKICAgICAgICAgICAgLy8gdGhpcy5pdGVtTGluZXMucHVzaCh0aGlzLml0ZW1MaW5lKQogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ2l0ZW0gTGluZScsIHRoaXMuaXRlbUxpbmUpCiAgICAgICAgfSwKICAgICAgICBvblBheW1lbnRUZXJtQ2hhbmdlZCgpIHsKICAgICAgICAgICAgLy8gdGhpcy5vbkludm9pY2VEYXRlQ2hhbmdlZCgpOwogICAgICAgICAgICBpZiAodGhpcy52ZW5kb3IpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBheW1lbnRUZXJtID0gdGhpcy5wdXJjaGFzZS5wYXltZW50VGVybSB8fCB7fQogICAgICAgICAgICAgICAgY29uc3QgbmV0RHVlID0gcGF5bWVudFRlcm0ubmV0RHVlIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCBzb21lRGF0ZSA9IG5ldyBEYXRlKHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25EYXRlKTsKICAgICAgICAgICAgICAgIHNvbWVEYXRlLnNldERhdGUoc29tZURhdGUuZ2V0RGF0ZSgpICsgcGFyc2VJbnQobmV0RHVlKSk7IC8vbnVtYmVyICBvZiBkYXlzIHRvIGFkZCwgZS54LiAxNSBkYXlzCiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmR1ZURhdGUgPSBzb21lRGF0ZTsKICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygiaW0iLCBzb21lRGF0ZSwgbmV0RHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgb25JbnZvaWNlRGF0ZUNoYW5nZWQoKSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZFBheW1lbnRUZXJtTGlzdCgpOwogICAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRDcmVkaXRMaW1pdCgpOwogICAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRDdXN0b21lckJhbGFuY2UodGhpcy52ZW5kb3IuaWQpOwogICAgICAgICAgICBhd2FpdCB0aGlzLm9uUHJpY2VMZXZlbENoYW5nZSgpOwoKICAgICAgICAgICAgdGhpcy5tb250aE9mID0ga2VuZG8udG9TdHJpbmcobmV3IERhdGUodGhpcy50eG5EYXRlKSwgJ3l5eXktTU0nKQogICAgICAgICAgICAvLyBpZiAodGhpcy52ZW5kb3IpIHsKICAgICAgICAgICAgLy8gICAgIGlmICh0aGlzLnB1cmNoYXNlLmhhc093blByb3BlcnR5KCJwYXltZW50VGVybSIpKSB7CiAgICAgICAgICAgIC8vICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0uaGFzT3duUHJvcGVydHkoIm5ldER1ZSIpKSB7CiAgICAgICAgICAgIC8vICAgICAgICAgICAgIGNvbnN0IG5ldER1ZSA9IHRoaXMucHVyY2hhc2UucGF5bWVudFRlcm0ubmV0RHVlOwogICAgICAgICAgICAvLyAgICAgICAgICAgICBjb25zdCBzb21lRGF0ZSA9IG5ldyBEYXRlKHRoaXMudHhuRGF0ZSk7CiAgICAgICAgICAgIC8vICAgICAgICAgICAgIHNvbWVEYXRlLnNldERhdGUoc29tZURhdGUuZ2V0RGF0ZSgpICsgcGFyc2VJbnQobmV0RHVlKSk7IC8vbnVtYmVyICBvZiBkYXlzIHRvIGFkZCwgZS54LiAxNSBkYXlzCiAgICAgICAgICAgIC8vICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZHVlRGF0ZSA9IHNvbWVEYXRlLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDAsIDEwKTsKICAgICAgICAgICAgLy8gICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdpbScsIHNvbWVEYXRlLCBuZXREdWUpCiAgICAgICAgICAgIC8vICAgICAgICAgfQogICAgICAgICAgICAvLyAgICAgfQogICAgICAgICAgICAvLyB9CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9uUmF0ZSgpOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFByZWZpeCgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgcHJlZml4SGFuZGxlci5nZXQoInB1cmNoYXNlIikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2VUeXBlcyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZVR5cGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZSA9IHRoaXMucHVyY2hhc2VUeXBlc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQcmljZUxldmVsKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnPyZuYXR1cmU9JyArIE5BVFVSRQogICAgICAgICAgICAgICAgICAgIHByaWNlTGV2ZWxIYW5kbGVyLmdldChzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByaWNlTGV2ZWwgPSByZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnByaWNlTGV2ZWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5wcmljZUxldmVsID0gdGhpcy5wcmljZUxldmVsWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZERpc2NvdW50SXRlbSgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnRJdGVtSGFuZGxlci5saXN0KERJU0NPVU5UX1RZUEUpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNwZWNpZmljRGlzY291bnRJdGVtID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRPdGhlckNoYXJnZSgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2VIYW5kbGVyLmxpc3QoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vdGhlckNoYXJnZUxpc3QgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZEFjY291bnQoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGFjY291bnRIYW5kbGVyLmdldEFsbCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vUmVjZWl2YWJsZSBBY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjUGF5YWJsZSA9IHJlcy5kYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChtKSA9PiBtLmFjY291bnRfdHlwZS5udW1iZXIgPT09IDE4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgoaXRtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGl0bS51dWlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkOiBpdG0udXVpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogaXRtLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsX25hbWU6IGl0bS5sb2NhbF9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXI6IGl0bS5udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX3RheGFibGU6IGl0bS5pc190YXhhYmxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYW5oamlBY2NDb2RlOiBpdG0uYmFuaGppQWNjQ29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBfY29kZTogaXRtLmdyb3VwX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudF9hY2NvdW50OiBpdG0ucGFyZW50X2FjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVfY29kZTogaXRtLnR5cGVfY29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF90eXBlOiBpdG0uYWNjb3VudF90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYWNjUGF5YWJsZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmFwQWNjID0gdGhpcy5hY2NQYXlhYmxlWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjV2l0aGhvbGRpbmdFeHBlbnNlID0gcmVzLmRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKG0pID0+IHBhcnNlSW50KG0uYmFuaGppQWNjQ29kZSkgPT09IDg0MzAwMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKGl0bSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpdG0udXVpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZDogaXRtLnV1aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGl0bS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9uYW1lOiBpdG0ubG9jYWxfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiBpdG0ubnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc190YXhhYmxlOiBpdG0uaXNfdGF4YWJsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuaGppQWNjQ29kZTogaXRtLmJhbmhqaUFjY0NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwX2NvZGU6IGl0bS5ncm91cF9jb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRfYWNjb3VudDogaXRtLnBhcmVudF9hY2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlX2NvZGU6IGl0bS50eXBlX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfdHlwZTogaXRtLmFjY291bnRfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFBheW1lbnRUZXJtKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAiP3R5cGU9cG10LXN1cHBsaWVyIjsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBheW1lbnRUZXJtcyA9IFtdCiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NIYW5kbGVyLmdldFBheW1lbnRUZXJtKHN0ckZpbHRlcikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXltZW50VGVybXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXltZW50VGVybXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5wYXltZW50VGVybSA9IHRoaXMucGF5bWVudFRlcm1zWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZExvY2F0aW9uKCkgewogICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IFtdCiAgICAgICAgICAgIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDAKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCcgY29uc3Qgcm9sZVR5cGUgPSBkYXRhU3RvcmUucm9sZVR5cGUgfHwgMCcsIGRhdGFTdG9yZSkKICAgICAgICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVN0b3JlLnJvbGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW10KICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2NhdGlvbiA9IHJvbGVEYXRhLmZpbHRlcihpdG0gPT4gaXRtLnR5cGUgPT09ICdsb2NhdGlvbicpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb25EZWZhdWx0ID0gbG9jYXRpb24uZmlsdGVyKG0gPT4gbS5pc0RlZmF1bHQgPT09IDEpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSBsb2NhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCB8fCB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2NhdGlvbkRlZmF1bHQubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5sb2NhdGlvbiA9IGxvY2F0aW9uRGVmYXVsdFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25IYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubGlzdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkUHJvamVjdEJ5Q3VzdG9tZXIoKSB7CiAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IFtdCiAgICAgICAgICAgIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDAKICAgICAgICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVN0b3JlLnJvbGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW10KICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0ID0gcm9sZURhdGEuZmlsdGVyKGl0bSA9PiBpdG0udHlwZSA9PT0gJ3Byb2plY3QnKQogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IHByb2plY3QKICAgICAgICAgICAgICAgICAgICAvLyBwcm9qZWN0LmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGNvbnN0IGN1c3RvbWVycyA9IGsuY3VzdG9tZXJzIHx8IFtdCiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGNvbnN0IHByb0N1c3RvbWVyID0gY3VzdG9tZXJzLmZpbHRlcihuID0+IG4uY3VzdG9tZXIuaWQgPT09IHRoaXMuY3VzdG9tZXIuaWQpCiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGlmIChwcm9DdXN0b21lci5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICB0aGlzLmN1c3RvbWVyUHJvamVjdHMucHVzaChrKQogICAgICAgICAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQgfHwgdGhpcy4kcm91dGUucGFyYW1zLmlkID09PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0RGVmYXVsdCA9IHRoaXMuY3VzdG9tZXJQcm9qZWN0cy5maWx0ZXIobSA9PiBtLmlzRGVmYXVsdCA9PT0gMSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb2plY3REZWZhdWx0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucHJvamVjdCA9IHByb2plY3REZWZhdWx0WzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52ZW5kb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2plY3RIYW5kbGVyLmdldEJ5U3VwcGxpZXIodGhpcy52ZW5kb3IuaWQpLnRoZW4ocmVzID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3RIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmxpc3QoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXN0b21lclByb2plY3RzID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmN1c3RvbWVyUHJvamVjdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHRoaXMucHVyY2hhc2UucHJvamVjdCA9IHRoaXMuY3VzdG9tZXJQcm9qZWN0c1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZEN1c3RvbWVyQmFsYW5jZShpZCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSBpZCArICI/dHlwZT1iYWwiOwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuY3VycmVudEJhbGFuY2UgPSAwOwogICAgICAgICAgICAgICAgICAgIGJpbGxpbmdIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgIC5iYWxhbmNlKHN0ckZpbHRlcikKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5jdXJyZW50QmFsYW5jZSA9IGRhdGFbMF0uYmFsYW5jZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgpOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkQ3VzdG9tZXJEZXBvc2l0QmFsYW5jZShpZCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSBpZCArICI/dHlwZT1kZXAiOwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuZGVwb3NpdEFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uID0gMDsKICAgICAgICAgICAgICAgICAgICBiaWxsaW5nSGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAuYmFsYW5jZShzdHJGaWx0ZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudERlcG9zaXQgPSBkYXRhWzBdLmJhbGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhhbW91bnREZXBvc2l0LCAiYmFsYSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmRlcG9zaXRBbW91bnQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50RGVwb3NpdCAvIHRoaXMucHVyY2hhc2UudHhuUmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgpOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBjcmVkaXRMaW1pdFVzYWdlKGJhbGFuY2UsIGNyZWRpdExpbWl0KSB7CiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICBrZW5kby50b1N0cmluZygKICAgICAgICAgICAgICAgICAgICAoYmFsYW5jZSAvIGNyZWRpdExpbWl0KSAqIDEwMCwKICAgICAgICAgICAgICAgICAgICBgbiR7dGhpcy5wdXJjaGFzZUZvcm1Db250ZW50LmRlY2ltYWx9YAogICAgICAgICAgICAgICAgKSArICIgJSIKICAgICAgICAgICAgKTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRFbXBsb3llZUNlbnRlcigpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbXBsb3llZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBlbXBsb3llZUhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgLmNlbnRlcih1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtcGxveWVlcyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZW1wbG95ZWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5lbXBsb3llZSA9IHRoaXMuZW1wbG95ZWVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCk7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRTZWdtZW50KCkgewogICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gW10KICAgICAgICAgICAgY29uc3Qgcm9sZVR5cGUgPSBkYXRhU3RvcmUucm9sZVR5cGUgfHwgMAogICAgICAgICAgICBpZiAocm9sZVR5cGUgPT09IDApIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhU3RvcmUucm9sZURhdGEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByb2xlRGF0YSA9IGRhdGFTdG9yZS5yb2xlRGF0YSB8fCBbXQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlZ21lbnQgPSByb2xlRGF0YS5maWx0ZXIoaXRtID0+IGl0bS50eXBlID09PSAnc2VnbWVudCcpCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VnbWVudERlZmF1bHQgPSBzZWdtZW50LmZpbHRlcihtID0+IG0uaXNEZWZhdWx0ID09PSAxKQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSBzZWdtZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlZ21lbnREZWZhdWx0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc2VnbWVudCA9IHNlZ21lbnREZWZhdWx0WzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdkYXRhU3RvcmUtLXNlZ21lbnREZWZhdWx0Jywgc2VnbWVudERlZmF1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9sZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0U2VnKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRUYXgoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHNldHRpbmdIYW5kbGVyLmdldCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXhlcyA9IHJlczsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YXggPSB0YXhlcy5maWx0ZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobSkgPT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobS50YXhUeXBlLnR5cGVJZCA9PT0gMSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRheFR5cGUudHlwZUlkID09PSAxMCB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRheFR5cGUudHlwZUlkID09PSAyKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNhY3Rpb25UeXBlID09PSAiUHVyY2hhc2UiCiAgICAgICAgICAgICAgICAgICAgICAgICk7IC8vIHZhbHVhYmxlIHRheAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIG9uU2F2ZUNsb3NlKHNhdmVTZW5kKSB7CiAgICAgICAgICAgIGlmICghdGhpcy4kcmVmcy5mb3JtLnZhbGlkYXRlKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHJlZnMuZm9ybS52YWxpZGF0ZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnRyYW5zYWN0aW9uUmF0ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5lcnJvcihpMThuLnQoInNldF9leGNoYW5nZV9yYXRlIikpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWQgPSAiIjsKICAgICAgICAgICAgaWYgKHRoaXMudmVuZG9yLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICBpZCA9IHRoaXMudmVuZG9yLmlkIHx8ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpZCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoInZlbmRvciBpcyByZXF1aXJlZCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLmJpbGxObyA9PSAiIikgewogICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5lcnJvcigiVmVuZG9yIEludm9pY2UgTm8gaXMgcmVxdWlyZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuJHJlZnMuZm9ybS52YWxpZGF0ZSgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRyZWZzLmZvcm0udmFsaWRhdGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKTsKICAgICAgICAgICAgbGV0IGQxID0gZHMuZGF0YSgpOwogICAgICAgICAgICBsZXQgZGF0YVZhbGlkYXRlID0gMDsKICAgICAgICAgICAgYXdhaXQgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgICAgIGQxLmZvckVhY2goKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgIHZhbHVlLml0ZW0gPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUuaXRlbS5pZCA9PSB1bmRlZmluZWQgfHwKICAgICAgICAgICAgICAgICAgICB2YWx1ZS5pdGVtLmlkID09IG51bGwgfHwKICAgICAgICAgICAgICAgICAgICB2YWx1ZS51b20gPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUudW9tLnVvbS5pZCA9PSB1bmRlZmluZWQgfHwKICAgICAgICAgICAgICAgICAgICB2YWx1ZS51b20udW9tLmlkID09IG51bGwKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoCiAgICAgICAgICAgICAgICAgICAgICAgICJQbGVhc2UgY2hlY2sgSXRlbSBvciBVT00gIG9uIHJvdyAiICsgKGluZGV4ICsgMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsaWRhdGUgKz0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChkMS5sZW5ndGggPT0gZGF0YVZhbGlkYXRlKSB7CiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXNBdXRvR2VuZXJhdGUgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZSA9IG5ldyBEYXRlKHRoaXMudHhuRGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZUludm9pY2UgPSBuZXcgRGF0ZSh0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZU0gPSB0cmFuRGF0ZS5nZXRGdWxsWWVhcigpICsgdHJhbkRhdGUuZ2V0TW9udGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlSW52b2ljZU0gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5EYXRlSW52b2ljZS5nZXRGdWxsWWVhcigpICsgdHJhbkRhdGVJbnZvaWNlLmdldE1vbnRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhbkRhdGVNID09PSB0cmFuRGF0ZUludm9pY2VNKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNBdXRvR2VuZXJhdGUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXRlbUxpbmVEUyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhUm93ID0gaXRlbUxpbmVEUwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmRhdGEoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigobykgPT4gby5hbW91bnQgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgobikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSXRlbUxpbmVNb2RlbChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVJvdy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5wdXJjaGFzZS5pZCA/IHRoaXMucHVyY2hhc2UuaWQgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkOiB0aGlzLnB1cmNoYXNlLnV1aWQgPyB0aGlzLnB1cmNoYXNlLnV1aWQgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb3VybmFsX3V1aWQ6IHRoaXMucHVyY2hhc2Uuam91cm5hbF91dWlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gdGhpcy5wdXJjaGFzZS5qb3VybmFsX3V1aWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUmF3OiB0aGlzLmpSYXcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFJBTlNBQ1RJT05fVFlQRSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXI6IHRoaXMucHVyY2hhc2UubnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFiYnI6IHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25UeXBlLmFiYnIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25EYXRlOiB0aGlzLnR4bkRhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25EYXRlVFo6IEhlbHBlci50b0lTT0RhdGUodGhpcy50eG5EYXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdWVEYXRlOiB0aGlzLnB1cmNoYXNlLmR1ZURhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9udGhPZjogdGhpcy5tb250aE9mLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBheW1lbnRDb2RlOiB0aGlzLnB1cmNoYXNlLnBheW1lbnRDb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbGxObzogdGhpcy5wdXJjaGFzZS5iaWxsTm8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmlsbERhdGU6IHRoaXMuYmlsbERhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcGxpZXI6IHRoaXMucHVyY2hhc2Uuc3VwcGxpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25UeXBlOiB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50VGVybTogdGhpcy5wdXJjaGFzZS5wYXltZW50VGVybSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3VudFByb21vdGlvbjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBBY2M6IHRoaXMucHVyY2hhc2UuYXBBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVuY3k6IHRoaXMucHVyY2hhc2UuY3VycmVuY3ksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhuUmF0ZTogdGhpcy5wdXJjaGFzZS50eG5SYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VSYXRlOiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogdGhpcy5wdXJjaGFzZS5leGNoYW5nZUFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsOiB0aGlzLnB1cmNoYXNlLnByaWNlTGV2ZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUxpbmVzOiBkYXRhUm93LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnQ6IHRoaXMucHVyY2hhc2Uuc2VnbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjogdGhpcy5wdXJjaGFzZS5sb2NhdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9qZWN0OiB0aGlzLnB1cmNoYXNlLnByb2plY3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1wbG95ZWU6IHRoaXMucHVyY2hhc2UuZW1wbG95ZWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0FkZHJlc3M6IHRoaXMucHVyY2hhc2UuYmlsbGluZ0FkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsaXZlcnlBZGRyZXNzOiB0aGlzLnB1cmNoYXNlLmRlbGl2ZXJ5QWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeURhdGVUaW1lOiB0aGlzLnB1cmNoYXNlLmRlbGl2ZXJ5RGF0ZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25Ob3RlOiB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb3VybmFsTm90ZTogdGhpcy5wdXJjaGFzZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJUb3RhbDogdGhpcy5wdXJjaGFzZS5zdWJUb3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogdGhpcy5wdXJjaGFzZS50b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3VudFRvdGFsOiB0aGlzLnB1cmNoYXNlLmRpc2NvdW50VG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VEaXNjb3VudFRvdGFsOiAodGhpcy5wdXJjaGFzZS5kaXNjb3VudFRvdGFsKSAqICh0aGlzLnB1cmNoYXNlLnR4blJhdGUgfHwgMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNEaXNjb3VudFRvdGFsOiB0aGlzLnB1cmNoYXNlLnNwZWNpZmljRGlzY291bnRUb3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeUZlZTogdGhpcy5wdXJjaGFzZS5kZWxpdmVyeUZlZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFRheEFtb3VudDogdGhpcy5wdXJjaGFzZS50b3RhbFRheEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXBvc2l0QW1vdW50OiB0aGlzLnB1cmNoYXNlLmRlcG9zaXRBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwb3NpdERlZHVjdGlvbjogdGhpcy5wdXJjaGFzZS5kZXBvc2l0RGVkdWN0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ0Ftb3VudDogdGhpcy5wdXJjaGFzZS5yZW1haW5pbmdBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50RHVlOiB0aGlzLnB1cmNoYXNlLmFtb3VudER1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50QmFsYW5jZTogdGhpcy5wdXJjaGFzZS5jdXJyZW50QmFsYW5jZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlOiB0aGlzLnB1cmNoYXNlLmJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlZGl0TGltaXQ6IHRoaXMucHVyY2hhc2UuY3JlZGl0TGltaXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZU9wdGlvbjogdGhpcy5wdXJjaGFzZS5zYXZlT3B0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHByb3ZlZEJ5OiB0aGlzLnB1cmNoYXNlLmFwcHJvdmVkQnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybVRlbXBsYXRlOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZpY0Rpc2NvdW50SXRlbTogdGhpcy5wdXJjaGFzZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZTogdGhpcy5tT3RoZXJDaGFyZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2VBbW91bnQ6IHRoaXMucHVyY2hhc2Uub3RoZXJDaGFyZ2VBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGF4TGlzdFRvdGFsOiB0aGlzLnRheExpc3RUb3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdXBwbGllckRpc2NvdW50SXRlbTogdGhpcy5zdXBwbGllckRpc2NvdW50SXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHRoaXMucHVyY2hhc2UuY3JlYXRlZEF0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1TdWJ0b3RhbDogdGhpcy5wdXJjaGFzZS5pdGVtU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VJdGVtU3VidG90YWw6IHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VJdGVtU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZVN1YnRvdGFsOiB0aGlzLnB1cmNoYXNlLnNlcnZpY2VTdWJ0b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZVNlcnZpY2VTdWJ0b3RhbDogdGhpcy5wdXJjaGFzZS5leGNoYW5nZVNlcnZpY2VTdWJ0b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eG5JdG1TdWJ0b3RhbDogdGhpcy5wdXJjaGFzZS50eG5JdG1TdWJ0b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZVR4bkl0bVN1YnRvdGFsOiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlVHhuSXRtU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbURpc2NvdW50OiB0aGlzLnB1cmNoYXNlLml0ZW1EaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUl0ZW1EaXNjb3VudDogdGhpcy5wdXJjaGFzZS5leGNoYW5nZUl0ZW1EaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlRGlzY291bnQ6IHRoaXMucHVyY2hhc2Uuc2VydmljZURpc2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlU2VydmljZURpc2NvdW50OiB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlU2VydmljZURpc2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4bkl0bURpc2NvdW50OiB0aGlzLnB1cmNoYXNlLnR4bkl0bURpc2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlVHhuSXRtRGlzY291bnQ6IHRoaXMucHVyY2hhc2UuZXhjaGFuZ2VUeG5JdG1EaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoaG9sZGluZ1RheEFtb3VudDogdGhpcy5wdXJjaGFzZS53aXRoaG9sZGluZ1RheEFtb3VudCB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1c2l2ZVRheEFtb3VudDogdGhpcy5wdXJjaGFzZS5pbmNsdXNpdmVUYXhBbW91bnQgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZWRVc2VyOiB0aGlzLmxvZ2dlZFVzZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZVNlbmQ6IHNhdmVTZW5kLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZkZyb206IHRoaXMucHVyY2hhc2UucmVmRnJvbSB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZUbzogdGhpcy5wdXJjaGFzZS5yZWZUbyB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWxlVGF4RGV0YWlsOiB0aGlzLnB1cmNoYXNlLnNhbGVUYXhEZXRhaWwgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzQWRkaXRpb25hbENvc3Q6IHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QubGVuZ3RoID4gMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbmFsQ29zdDogdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdCB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbmFsQ29zdE1ldGhvZDogdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdE1ldGhvZCB8fCAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbmFsQ29zdFRvdGFsOiB0aGlzLmFkZGl0aW9uYWxDb3N0VG90YWwgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0F1dG9HZW5lcmF0ZTogaXNBdXRvR2VuZXJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVHlwZTogdGhpcy4kcm91dGUucGFyYW1zLmlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gdGhpcy4kcm91dGUucXVlcnkudHlwZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICJuZXciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5xdWVyeS50eXBlID09PSAicmVjdXJyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuaWQgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIuY3JlYXRlUHVyY2hhc2UoZGF0YSkudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5zdGF0dXNDb2RlID09PSAyMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5jbG9zZShyZXNwb25zZS5kYXRhLmRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuJHJlZnMuZm9ybS5yZXNldCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5zdWNjZXNzKCJTdWNjZXNzZnVsbHkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNhdmVTZW5kID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UocmVzcG9uc2UuZGF0YS5kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoIlNvbWV0aGluZyB3ZW50IHdyb25nIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvcnMucHVzaChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQdXJjaGFzZUZvcm1Db250ZW50KCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBwdXJjaGFzZUZvcm1Db250ZW50SGFuZGxlci5saXN0KCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2VGb3JtQ29udGVudCA9IGRhdGFbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNpbWFsRm9ybWF0ID0gIm4iICsgdGhpcy5wdXJjaGFzZUZvcm1Db250ZW50LmRlY2ltYWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbml0RGF0YSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgY2xvc2UoZGF0YSkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiAiVmVuZG9ycyIsCiAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkuZ28oLTEpOwogICAgICAgICAgICAgICAgLy8gdGhpcy4kcm91dGVyLnB1c2goewogICAgICAgICAgICAgICAgLy8gICAgIHBhdGg6ICJpbnZvaWNlX3ZpZXciLAogICAgICAgICAgICAgICAgLy8gICAgIG5hbWU6ICJJbnZvaWNlIFZpZXciLAogICAgICAgICAgICAgICAgLy8gICAgIHBhcmFtczogewogICAgICAgICAgICAgICAgLy8gICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGRhdGEsICdkYXRhJykKICAgICAgICB9LAogICAgICAgIHNhdmVOZXcoKSB7CiAgICAgICAgfSwKICAgICAgICByZW1vdmVSb3coZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBrZW5kby5qUXVlcnkoIiNncmlkSXRlbUxpbmUiKS5kYXRhKCJrZW5kb0dyaWQiKSwKICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UgPSBncmlkLmRhdGFTb3VyY2UsCiAgICAgICAgICAgICAgICBkYXRhSXRlbSA9IGdyaWQuZGF0YUl0ZW0oJChlLmN1cnJlbnRUYXJnZXQpLmNsb3Nlc3QoInRyIikpOwoKICAgICAgICAgICAgaWYgKGRhdGFTb3VyY2UudG90YWwoKSA+IDEpIHsKICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UucmVtb3ZlKGRhdGFJdGVtKTsKICAgICAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZW5lcmF0ZU51bWJlcigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCkgewogICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGUgPSBuZXcgRGF0ZSh0aGlzLnR4bkRhdGUpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVJbnZvaWNlID0gbmV3IERhdGUodGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvbkRhdGUpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVNID0gdHJhbkRhdGUuZ2V0RnVsbFllYXIoKSArIHRyYW5EYXRlLmdldE1vbnRoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZUludm9pY2VNID0KICAgICAgICAgICAgICAgICAgICB0cmFuRGF0ZUludm9pY2UuZ2V0RnVsbFllYXIoKSArIHRyYW5EYXRlSW52b2ljZS5nZXRNb250aCgpOwogICAgICAgICAgICAgICAgaWYgKHRyYW5EYXRlTSA9PT0gdHJhbkRhdGVJbnZvaWNlTSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucmVmZXJlbmNlTm8gPSB0aGlzLnJlZmVyZW5jZU5vOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMudHhuRGF0ZSAhPT0gIiIgJiYgdGhpcy5wdXJjaGFzZVR5cGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGxldCBkYXRhID0gewogICAgICAgICAgICAgICAgICAgIGFiYnI6IHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25UeXBlLmFiYnIsCiAgICAgICAgICAgICAgICAgICAgc3RydWN0dXJlOiB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uVHlwZS5zdHJ1Y3R1cmUsCiAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25EYXRlOiB0aGlzLnR4bkRhdGUsCiAgICAgICAgICAgICAgICAgICAgc2VxdWNlbmNpbmc6IHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25UeXBlLnNlcXVjZW5jaW5nLAogICAgICAgICAgICAgICAgICAgIHByZWZpeFNlcGFyYXRvcjogdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUucHJlZml4U2VwYXJhdG9yIHx8ICcnLAogICAgICAgICAgICAgICAgICAgIG51bWJlclNlcGFyYXRvcjogdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUubnVtYmVyU2VwYXJhdG9yIHx8ICcnLAogICAgICAgICAgICAgICAgICAgIGZvcm1hdDogdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUuZm9ybWF0IHx8IDUsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogIlB1cmNoYXNlIiwKICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IDEsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIKICAgICAgICAgICAgICAgICAgICAubGFzdE51bWJlcihkYXRhKQogICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IHJlc3BvbnNlLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhc3ROdW1iZXIgPSB0aGlzLnplcm9QYWQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VJbnQocmVzLmxhc3ROdW1iZXIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25UeXBlLmZvcm1hdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG51bWJlciA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnN1ZmZpeCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUubnVtYmVyU2VwYXJhdG9yICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5udW1iZXIgPSBudW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9ycy5wdXNoKGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB6ZXJvUGFkKG51bSwgcGxhY2VzKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcobnVtKS5wYWRTdGFydChwbGFjZXMsICIwIik7CiAgICAgICAgfSwKICAgICAgICBzdWZmaXgodHJhbnNhY3Rpb25EYXRlKSB7CiAgICAgICAgICAgIHJldHVybiBrZW5kby50b1N0cmluZyhuZXcgRGF0ZSh0cmFuc2FjdGlvbkRhdGUpLCBgeXltbWApOwogICAgICAgIH0sCiAgICAgICAgZXJyb3JNZXNzYWdlKCkgewogICAgICAgIH0sCiAgICAgICAgYWNjb3VudERyb3BEb3duRWRpdG9yKCkgewogICAgICAgIH0sCiAgICAgICAgY2FuY2VsKCkgewogICAgICAgICAgICB0aGlzLiRzd2FsKHsKICAgICAgICAgICAgICAgIHRpdGxlOiBpMThuLnQoIm1zZ190aXRsZV93YXJuaW5nIiksCiAgICAgICAgICAgICAgICB0ZXh0OiBpMThuLnQoIm1zZ19kaXNjYXJkIiksCiAgICAgICAgICAgICAgICBpY29uOiAid2FybmluZyIsCiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLAogICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uVGV4dDogaTE4bi50KCJjYW5jZWwiKSwKICAgICAgICAgICAgICAgIGNvbmZpcm1CdXR0b25Db2xvcjogIiM0ZDQ4NDgiLAogICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uQ29sb3I6ICIjRUQxQTNBIiwKICAgICAgICAgICAgICAgIGNvbmZpcm1CdXR0b25UZXh0OiBpMThuLnQoImRpc2NhcmQiKSwKICAgICAgICAgICAgfSkudGhlbigocmVzdWx0Q2VuKSA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2cocmVzdWx0Q2VuKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHRDZW4udmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRkZXN0cm95KCkKICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZXIuZ28oLTEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGhpZGVTbWFsbFNpZGViYXIoKSB7CiAgICAgICAgICAgIHRoaXMuaXNIaWRlQmFyID0gIXRoaXMuaXNIaWRlQmFyOwogICAgICAgIH0sCiAgICAgICAgcmVxdWVzdERhdGEoc2tpcCwgZmlsdGVyLCBiYXNlVXJsKSB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IGJhc2VVcmwgKyBgP2ZpbHRlcj0ke2ZpbHRlcn1gOwogICAgICAgICAgICB0aGlzLnJlcXVlc3RTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgZmV0Y2godXJsKQogICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbih0aGlzLmFmdGVyRmV0Y2gpOwogICAgICAgIH0sCiAgICAgICAgcmVxdWVzdERhdGFfKHNraXAsIGZpbHRlciwgYmFzZVVybCkgewogICAgICAgICAgICBjb25zdCB1cmwgPSBiYXNlVXJsICsgYC8ke2ZpbHRlcn1gOwogICAgICAgICAgICB0aGlzLnJlcXVlc3RTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgZmV0Y2godXJsKQogICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbih0aGlzLmFmdGVyRmV0Y2hfKTsKICAgICAgICB9LAogICAgICAgIG9uQ2hhbmdlKGV2ZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVt0ZXh0RmllbGRdID09PSBlbXB0eUl0ZW1bdGV4dEZpZWxkXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudmVuZG9yID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2Uuc3VwcGxpZXIgPSB2YWx1ZTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHRoaXMucHVyY2hhc2UuY3VzdG9tZXIsICdDaGFuZ2VkJykKICAgICAgICAgICAgLy8gdGhpcy5pbnZvaWNlID0gdmFsdWUKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5hcEFjYyA9IHZhbHVlLmhhc093blByb3BlcnR5KCJhcEFjYyIpID8gdmFsdWUuYXBBY2MgOiB7fTsKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5wYXltZW50VGVybSA9IHZhbHVlLnBheW1lbnRUZXJtIHx8IHt9OwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnByaWNlTGV2ZWwgPSB2YWx1ZS5wcmljZUxldmVsIHx8IHt9OwogICAgICAgICAgICBjb25zdCBiYXNlQ3VycmVuY3kgPSB2YWx1ZS5iYXNlQ3VycmVuY3kgfHwge307CiAgICAgICAgICAgIGlmIChiYXNlQ3VycmVuY3kuaGFzT3duUHJvcGVydHkoImNvZGUiKSkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlQ3VycmVuY3lDb2RlID0gIiAiICsgYmFzZUN1cnJlbmN5LmNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gdGhpcy5sb2FkVHJhbnNhY3Rpb25SYXRlKCk7CiAgICAgICAgICAgIHRoaXMuYmlsbGluZ0FkZHJlc3MgPSB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgiYmlsbGluZ0FkZHJlc3MiKQogICAgICAgICAgICAgICAgPyB2YWx1ZS5iaWxsaW5nQWRkcmVzcwogICAgICAgICAgICAgICAgOiBbXTsKICAgICAgICAgICAgdGhpcy5kZWxpdmVyeUFkZHJlc3MgPSB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgiZGVsaXZlcnlBZGRyZXNzIikKICAgICAgICAgICAgICAgID8gdmFsdWUuZGVsaXZlcnlBZGRyZXNzCiAgICAgICAgICAgICAgICA6IFtdOwogICAgICAgICAgICBpZiAodGhpcy5iaWxsaW5nQWRkcmVzcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmJpbGxpbmdBZGRyZXNzID0gdGhpcy5iaWxsaW5nQWRkcmVzc1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5kZWxpdmVyeUFkZHJlc3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5kZWxpdmVyeUFkZHJlc3MgPSB0aGlzLmRlbGl2ZXJ5QWRkcmVzc1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmV4cGVuc2VzID0gW10KICAgICAgICAgICAgdGhpcy5vbkludm9pY2VEYXRlQ2hhbmdlZCgpOwogICAgICAgICAgICB0aGlzLmxvYWRQcm9qZWN0QnlDdXN0b21lcigpCiAgICAgICAgICAgIC8vIHRoaXMubG9hZEN1c3RvbWVyQmFsYW5jZSh0aGlzLnZlbmRvci5pZCk7CiAgICAgICAgICAgIC8vIGNvbnN0IGNyZWRpdExpbWl0ID0gdmFsdWUuaGFzT3duUHJvcGVydHkoImNyZWRpdExpbWl0IikKICAgICAgICAgICAgLy8gICAgID8gdmFsdWUuY3JlZGl0TGltaXQKICAgICAgICAgICAgLy8gICAgIDogMDsKICAgICAgICAgICAgLy8gdGhpcy5wdXJjaGFzZS5jcmVkaXRMaW1pdCA9IGtlbmRvLnBhcnNlRmxvYXQoY3JlZGl0TGltaXQpOwogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2codmFsdWUsICd2YWx1ZScpCiAgICAgICAgfSwKICAgICAgICBvbkVtcGxveWVlQ2hhbmdlZChldmVudCkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2ZW50LnZhbHVlOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWVbdGV4dEZpZWxkXSA9PT0gZW1wdHlJdGVtW3RleHRGaWVsZF0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1FbXBsb3llZSA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLnB1cmNoYXNlLmVtcGxveWVlID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBhZnRlckZldGNoKGpzb24pIHsKICAgICAgICAgICAgdGhpcy52ZW5kb3JMaXN0ID0ganNvbi5kYXRhOwogICAgICAgIH0sCiAgICAgICAgYWZ0ZXJGZXRjaF8oanNvbikgewogICAgICAgICAgICB0aGlzLmVtcGxveWVlcyA9IGpzb24uZGF0YTsKICAgICAgICB9LAogICAgICAgIG9uRmlsdGVyQ2hhbmdlKGV2ZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGZpbHRlciA9IGV2ZW50LmZpbHRlci52YWx1ZTsKICAgICAgICAgICAgdGhpcy5yZXF1ZXN0RGF0YSgwLCBmaWx0ZXIsIHRoaXMuY3VzQmFzZVVybCk7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyID0gZmlsdGVyOwogICAgICAgIH0sCiAgICAgICAgb25FbXBsb3llZUZpbHRlckNoYW5nZWQoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgZmlsdGVyID0gZXZlbnQuZmlsdGVyLnZhbHVlOwogICAgICAgICAgICB0aGlzLnJlcXVlc3REYXRhXygwLCBmaWx0ZXIsIHRoaXMuZW1wQmFzZVVybCk7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyXyA9IGZpbHRlcjsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGluaXREYXRhKCkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZFZpZXdDcmVkaXRQdXJjaGFzZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpCiAgICAgICAgICAgICAgICAvLyB0aGlzLmFkZFJvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVmlld0NyZWRpdFB1cmNoYXNlKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbGxpbmdIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudmlld1B1cmNoYXNlKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZSA9IHJlcy5kYXRhLmRhdGFbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVmZXJlbmNlTm8gPSB0aGlzLnB1cmNoYXNlLnJlZmVyZW5jZU5vOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnR4bkRhdGUgPSBuZXcgRGF0ZSh0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVuZG9yID0gdGhpcy5wdXJjaGFzZS5zdXBwbGllcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tRW1wbG95ZWUgPSB0aGlzLnB1cmNoYXNlLmVtcGxveWVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRheExpc3RUb3RhbCA9IHRoaXMucHVyY2hhc2UudGF4TGlzdFRvdGFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lcyA9IHRoaXMucHVyY2hhc2UuaXRlbUxpbmVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1PdGhlckNoYXJnZSA9IHRoaXMucHVyY2hhc2Uub3RoZXJDaGFyZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwcGxpZXJEaXNjb3VudEl0ZW0gPSB0aGlzLnB1cmNoYXNlLnN1cHBsaWVyRGlzY291bnRJdGVtIHx8IFtdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdyA9IHRoaXMucHVyY2hhc2UualJhdyB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leHBlbnNlcyA9IHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkaXRpb25hbENvc3RUb3RhbCA9IHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3RUb3RhbCB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlT3JkZXJzID0gdGhpcy5wdXJjaGFzZS5yZWZGcm9tIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vbnRoT2YgPSBrZW5kby50b1N0cmluZygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKHRoaXMucHVyY2hhc2UubW9udGhPZiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAieXl5eS1NTSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm1PdGhlckNoYXJnZS5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkU2VsZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJpY2VMZXZlbCA9IHRoaXMucHVyY2hhc2UucHJpY2VMZXZlbCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW5jeSA9IHByaWNlTGV2ZWwuY3VycmVuY3kgfHwge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VyQ29kZSA9IGN1cnJlbmN5LmNvZGUgfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW5jeUNvZGUgPSBjdXJDb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmxvYWRQcm9qZWN0QnlDdXN0b21lcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbmRvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmVuZG9yLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMudmVuZG9yLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucXVlcnkudHlwZSA9PT0gInJlY3VycmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaGFzT3duUHJvcGVydHkoInRyYW5zYWN0aW9uRGF0ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJ0eXBlIiwgdGhpcy4kcm91dGUucGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSA9IG5ldyBEYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMudHJhbnNhY3Rpb25EYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnR4bkRhdGUgPSBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kcm91dGUucGFyYW1zLnRyYW5zYWN0aW9uRGF0ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkludm9pY2VEYXRlQ2hhbmdlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVOdW1iZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGNsZWFyKCkgewogICAgICAgICAgICAvLyB0aGlzLmxvYWRBY2NvdW50KCkKICAgICAgICAgICAgdGhpcy5sb2FkUHJpY2VMZXZlbCgpCiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpOwogICAgICAgICAgICBkcy5kYXRhKFtdKTsKICAgICAgICAgICAgdGhpcy5pZCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy52ZW5kb3IgPSB7fQogICAgICAgICAgICB0aGlzLm1FbXBsb3llZSA9IHt9CiAgICAgICAgICAgIHRoaXMubU90aGVyQ2hhcmdlID0ge30KICAgICAgICAgICAgdGhpcy5wdXJjaGFzZU9yZGVycyA9IFtdCiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UgPSBuZXcgUHVyY2hhc2VNb2RlbCh7fSk7CiAgICAgICAgICAgIHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25UeXBlID0gdGhpcy5wdXJjaGFzZVR5cGVzWzBdOwogICAgICAgICAgICB0aGlzLm1vbnRoT2YgPSBrZW5kby50b1N0cmluZyhuZXcgRGF0ZSh0aGlzLnB1cmNoYXNlLnRyYW5zYWN0aW9uRGF0ZSksICd5eXl5LU1NJykKICAgICAgICAgICAgdGhpcy5hZGRSb3coKTsKICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgICAgICB0aGlzLmxvYWRTZWdtZW50KCk7CiAgICAgICAgICAgIHRoaXMubG9hZExvY2F0aW9uKCk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVHJhbnNhY3Rpb25SYXRlKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUodGhpcy50eG5EYXRlKS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJpY2VMZXZlbCA9IHRoaXMucHVyY2hhc2UucHJpY2VMZXZlbDsKICAgICAgICAgICAgICAgICAgICBsZXQgY29kZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmljZUxldmVsLmhhc093blByb3BlcnR5KCJjdXJyZW5jeSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmljZUxldmVsLmN1cnJlbmN5Lmhhc093blByb3BlcnR5KCJjb2RlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSBwcmljZUxldmVsLmN1cnJlbmN5LmNvZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGUgIT09IHVuZGVmaW5lZCB8fCBjb2RlICE9PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVuY3lIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TGFzdEV4Y2hhbmdlUmF0ZUJ5RGF0ZShkYXRlLCBjb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4Y2hhbmdlUmF0ZSA9IHJlcy5kYXRhLmRhdGFbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVuY3lDb2RlID0gdGhpcy5leGNoYW5nZVJhdGUuY29kZSB8fCAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvblJhdGUgPSB0aGlzLmV4Y2hhbmdlUmF0ZS5yYXRlIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UudHhuUmF0ZSA9IHRoaXMuZXhjaGFuZ2VSYXRlLnJhdGUgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5leGNoYW5nZVJhdGUgPSB0aGlzLmV4Y2hhbmdlUmF0ZSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHJhbnNhY3Rpb25SYXRlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRzbm90aWZ5LmVycm9yKGkxOG4udCgic2V0X2V4Y2hhbmdlX3JhdGUiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRDdXN0b21lckRlcG9zaXRCYWxhbmNlKHRoaXMudmVuZG9yLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkUHVyY2hhc2VPcmRlcigpOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHJlbG9hZCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRWaWV3Q3JlZGl0UHVyY2hhc2UoKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQdXJjaGFzZU9yZGVyKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBsZXQgc2VnbWVudElkID0gIiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uSWQgPSAnJywKICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbElkID0gIiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQgPSAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnNlZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VnbWVudElkID0gdGhpcy5wdXJjaGFzZS5zZWdtZW50LmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS5sb2NhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbklkID0gdGhpcy5wdXJjaGFzZS5sb2NhdGlvbi5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2Uuc3VwcGxpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJJZCA9IHRoaXMucHVyY2hhc2Uuc3VwcGxpZXIuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlLnByaWNlTGV2ZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbElkID0gdGhpcy5wdXJjaGFzZS5wcmljZUxldmVsLmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvbkRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZSA9IHRoaXMucHVyY2hhc2UudHJhbnNhY3Rpb25EYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsZXQgc3RyRmlsdGVyID0gIiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50SWQgIT09ICIiICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQgIT09ICIiICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uSWQgIT09ICIiICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHByaWNlTGV2ZWxJZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZSAhPT0gIiIKICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyRmlsdGVyID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICI/aWQ9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21lcklkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICImc2VnSWQ9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50SWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZsb2NJZD0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uSWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZwbElkPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbElkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICImZGF0ZT0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4bkRhdGUgKyAnJnR5cGU9UHVyY2hhc2UgT3JkZXInCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJGaWx0ZXIgIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UucmVmRnJvbSA9IFtdCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmdUeG4gPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHNhbGVPcmRlckhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2FjdGlvbkZpbHRlcihzdHJGaWx0ZXIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuID0gZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJjaGFzZU9yZGVycyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ1R4biA9IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhd2FpdCB0aGlzLmdldEV4cGVuc2VCeVN1cHBsaWVyKCkKICAgICAgICB9LAogICAgICAgIGFkZFB1cmNoYXNlT3JkZXIoaXRlbSkgewogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgY29uc3QgaXRlbUxpbmUgPSBpdGVtLml0ZW1MaW5lcyB8fCBbXTsKICAgICAgICAgICAgICAgIHRoaXMucmVmRnJvbS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogaXRlbS5pZCB8fCAnJywKICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2U6IGl0ZW0ucmVmZXJlbmNlTm8gfHwgJycKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICAgICAgICAgICAgICB0b3RhbCA9IGRzLnRvdGFsKCk7CiAgICAgICAgICAgICAgICBpdGVtTGluZS5mb3JFYWNoKChvKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtTGluZSA9IG5ldyBJdGVtTGluZU1vZGVsKG8pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaWQgPSBpdGVtTGluZVByZWZpeCArIHV1aWQudjEoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lLmRlY2ltYWxGb3JtYXQgPSAibiIgKyB0aGlzLnB1cmNoYXNlRm9ybUNvbnRlbnQuZGVjaW1hbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lLnNvdXJjZVRyYW5zYWN0aW9uID0gewogICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRlbS5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlTm86IGl0ZW0ucmVmZXJlbmNlTm8sCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lLnNvdXJjZVRyYW5zYWN0aW9uUmVmID0gaXRlbS5yZWZlcmVuY2VObzsKICAgICAgICAgICAgICAgICAgICBkcy5pbnNlcnQodG90YWwsIHRoaXMuaXRlbUxpbmUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lID0gbmV3IEl0ZW1MaW5lTW9kZWwoe30pOwogICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMucHVyY2hhc2VPcmRlcnMuZmluZEluZGV4KChpdG0pID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXRlbS5pZCA9PT0gaXRtLmlkOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlT3JkZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmNoYXNlLnJlZkZyb20gPSB0aGlzLnJlbW92ZUR1cGxpY2F0ZSh0aGlzLnJlZkZyb20pCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHRvdGFsUXR5KCkgewogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKQogICAgICAgICAgICBsZXQgcXR5ID0gMAogICAgICAgICAgICBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXRtID0gbS5pdGVtIHx8IHt9CiAgICAgICAgICAgICAgICBjb25zdCB1b20gPSBtLnVvbSB8fCB7fQogICAgICAgICAgICAgICAgaWYgKGl0bS5pZCAmJiB1b20udW9tICYmIGl0bS50eXBlID09PSAnVmFyaWFudCcpIHsKICAgICAgICAgICAgICAgICAgICBxdHkgKz0gKG0ucXR5IHx8IDApICogKG0uY29udmVyc2lvblJhdGUgfHwgMSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdxdHknLCBxdHkpCiAgICAgICAgICAgIHJldHVybiBxdHkKICAgICAgICB9LAogICAgICAgIGV4Y2x1ZGVWQVRUYXhJbmNsdXNpdmUodGF4LCBhbW91bnQsIGluY1RheCkgewogICAgICAgICAgICBpZiAodGF4KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYXNlQW1vdW50ID0gdGF4LmJhc2VBbW91bnQgfHwgJyc7CiAgICAgICAgICAgICAgICBjb25zdCB0YXhUeXBlID0gdGF4LnRheFR5cGUgfHwge30KICAgICAgICAgICAgICAgIGNvbnN0IHRheFR5cGVJZCA9IHRheFR5cGUudHlwZUlkIHx8IDAKICAgICAgICAgICAgICAgIGlmIChiYXNlQW1vdW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gImluY2x1c2l2ZSIgJiYgdGF4VHlwZUlkID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbW91bnQgLSBpbmNUYXgKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFtb3VudAogICAgICAgIH0sCiAgICAgICAgdG90YWxBbW91bnQoKSB7CiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgIGxldCBhbW91bnQgPSAwCiAgICAgICAgICAgIGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpdG0gPSBtLml0ZW0gfHwge30KICAgICAgICAgICAgICAgIGNvbnN0IHVvbSA9IG0udW9tIHx8IHt9CiAgICAgICAgICAgICAgICBsZXQgaW5jbHVUYXggPSAwCiAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRheCA9IG0udmF0VGF4IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW1vdW50XyA9IG0uYW1vdW50IHx8IDAKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlQW1vdW50ID0gdGF4LmJhc2VBbW91bnQgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gImluY2x1c2l2ZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1VGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KHRheCwgYW1vdW50Xyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ICs9IChhbW91bnRfIC0gKGluY2x1VGF4IHx8IDApKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2Ftb3VudCB4LScsIGFtb3VudCkKICAgICAgICAgICAgcmV0dXJuIGFtb3VudAogICAgICAgIH0sCiAgICAgICAgcGVyY2VudGFnZUFwcGxpZWQoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCB0QW1vdW50ID0gdGhpcy50b3RhbEFtb3VudCgpCiAgICAgICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKQogICAgICAgICAgICAgICAgZHMuZGF0YSgpLmZpbHRlcihuID0+IG4uYW1vdW50ID4gMCkuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpdG0gPSBtLml0ZW0gfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCB1b20gPSBtLnVvbSB8fCB7fQogICAgICAgICAgICAgICAgICAgIGxldCBpbmNsdVRheCA9IDAKICAgICAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXggPSBtLnZhdFRheCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbW91bnQgPSBtLmFtb3VudCB8fCAwCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VBbW91bnQgPSB0YXguYmFzZUFtb3VudCB8fCAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkgPT09ICJpbmNsdXNpdmUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVUYXggPSB0aGlzLmF1dG9DYWxjdWxhdGVUYXgodGF4LCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudEFmdGVyVGF4ID0gYW1vdW50IC0gKGluY2x1VGF4IHx8IDApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBBbW91bnQgPSBhbW91bnRBZnRlclRheCAvIHRBbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgbVsncGVyY2VudGFnZUFwcGxpZWQnXSA9IHBBbW91bnQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdRdHkgQmFzZWQtLScsIGRzLmRhdGEoKSkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdlcnJvcicsIGUpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFtb3VudEFwcGxpZWQoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKQogICAgICAgICAgICAgICAgY29uc3QgYWRjID0gdGhpcy5hZGRpdGlvbmFsQ29zdFRvdGFsIHx8IDAKICAgICAgICAgICAgICAgIGRzLmRhdGEoKS5maWx0ZXIobiA9PiBuLmFtb3VudCA+IDApLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRtID0gbS5pdGVtIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW9tID0gbS51b20gfHwge30KICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2Ftb3VudEFwcGxpZWQ9PScsIHVvbS51b20sICctLS0nLCBpdG0udHlwZSkKICAgICAgICAgICAgICAgICAgICBpZiAoaXRtLmlkICYmIHVvbS51b20gJiYgaXRtLnR5cGUgPT09ICdWYXJpYW50JykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJjZW50YWdlQXBwbGllZCA9IG0ucGVyY2VudGFnZUFwcGxpZWQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ3BlcmNlbnRhZ2VBcHBsaWVkLS0nLCBhZGMsICctLS0nLCAocGVyY2VudGFnZUFwcGxpZWQgKiBhZGMpKQogICAgICAgICAgICAgICAgICAgICAgICBtWydhbW91bnRBcHBsaWVkJ10gPSBwZXJjZW50YWdlQXBwbGllZCAqIGFkYwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdBTW91bnQgQmFzZWQtLScsIGRzLmRhdGEoKSkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdlcnJvcicsIGUpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFtb3VudEFwcGxpZWRRdHlCYXNlZCgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgICAgICBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0bSA9IG0uaXRlbSB8fCB7fQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVvbSA9IG0udW9tIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0bS5pZCAmJiB1b20udW9tICYmIGl0bS50eXBlID09PSAnVmFyaWFudCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkYyA9IG0uYWRkaXRpb25hbENvc3QgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBxdHkgPSAobS5xdHkgfHwgMSkgKiAobS5jb252ZXJzaW9uUmF0ZSB8fCAxKQogICAgICAgICAgICAgICAgICAgICAgICBtWydhbW91bnRBcHBsaWVkJ10gPSBhZGRjICogcXR5CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnYW1vdW50QXBwbGllZFF0eUJhc2VkIEJhc2VkLS0nLCBkcy5kYXRhKCkpCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnZXJyb3InLCBlKQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhc3luYyBjYWxjdWxhdGVBZGRpdGlvbmFsQ29zdCgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIHRvZG86IGFkZGl0aW9uYWwgQ29zdAogICAgICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3RNZXRob2QgPT09ICdRdHkgQmFzZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZW50YWdlQXBwbGllZCgpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGVyY2VudGFnZUFwcGxpZWQoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuYW1vdW50QXBwbGllZCgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdE1ldGhvZCA9PT0gJ1F0eSBCYXNlZCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0UXR5ID0gdGhpcy50b3RhbFF0eSgpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkYyA9IHRoaXMuYWRkaXRpb25hbENvc3RUb3RhbCB8fCAwCiAgICAgICAgICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgICAgICAgICBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpdG0gPSBtLml0ZW0gfHwge30KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW9tID0gbS51b20gfHwge30KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0bS5pZCAmJiB1b20udW9tICYmIGl0bS50eXBlID09PSAnVmFyaWFudCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1bJ2FkZGl0aW9uYWxDb3N0J10gPSBhZGRjIC8gdFF0eQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ3F0eSBiYXNlZCcsIGRzLmRhdGEoKSkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgICAgICAgICBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpdG0gPSBtLml0ZW0gfHwge30KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW9tID0gbS51b20gfHwge30KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0bS5pZCAmJiB1b20udW9tICYmIGl0bS50eXBlID09PSAnVmFyaWFudCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudEFwcGxpZWQgPSBtLmFtb3VudEFwcGxpZWQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcXR5ID0gKG0ucXR5IHx8IDApICogKG0uY29udmVyc2lvblJhdGUgfHwgMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1bJ2FkZGl0aW9uYWxDb3N0J10gPSBhbW91bnRBcHBsaWVkIC8gcXR5CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3RNZXRob2QgPT09ICdRdHkgQmFzZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbW91bnRBcHBsaWVkUXR5QmFzZWQoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGVhcmluZ0FjY291bnQoKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2Vycm9yJywgZSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXV0b0NhbGN1bGF0ZVRheERldGFpbCgpIHsKICAgICAgICAgICAgbGV0IGlkcyA9IFtdCiAgICAgICAgICAgIHRoaXMudGF4TGlzdERldGFpbC5mb3JFYWNoKG4gPT4gewogICAgICAgICAgICAgICAgaWRzLnB1c2gobi5pZCB8fCAnJykKICAgICAgICAgICAgfSkKICAgICAgICAgICAgY29uc3QgdW5pcXVlID0gWy4uLm5ldyBTZXQoaWRzKV0KICAgICAgICAgICAgbGV0IHJlc3VsdCA9IFtdCiAgICAgICAgICAgIHVuaXF1ZS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgbGV0IGFtb3VudCA9IDAsIHJvdyA9IHt9LCBkaXNjb3VudCA9IDAsIHhEaXNjb3VudCA9IDAsIHhBbW91bnQgPSAwLCB0YXhBbW91bnQgPSAwLCB4VGF4QW1vdW50ID0gMAogICAgICAgICAgICAgICAgbGV0IHRheERldGFpbCA9IFtdLCBpc1ZhdCA9IDAKICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gdGhpcy50YXhMaXN0RGV0YWlsLmZpbHRlcihuID0+IG4uaWQgPT09IG0pCiAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3RheExpc3REZXRhaWxpZHMnLCBmb3VuZCkKICAgICAgICAgICAgICAgIGZvdW5kLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICAgICAgcm93ID0gawogICAgICAgICAgICAgICAgICAgIGlmIChrLmlzVmF0ID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzVmF0ID0gMQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZXRhaWxfID0gay5kZXRhaWwgfHwge30KICAgICAgICAgICAgICAgICAgICAgICAgdGF4RGV0YWlsLnB1c2goZGV0YWlsXykKCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRheEFtb3VudCArPSBrLnRheEFtb3VudF8gfHwgMAogICAgICAgICAgICAgICAgICAgIHhUYXhBbW91bnQgKz0gKGsudGF4QW1vdW50XyB8fCAwKSAqIChrLnR4blJhdGUgfHwgMSkKICAgICAgICAgICAgICAgICAgICBhbW91bnQgKz0gKGsuYW1vdW50IHx8IDApCiAgICAgICAgICAgICAgICAgICAgeEFtb3VudCArPSAoay5hbW91bnQgfHwgMCkgKiAoay50eG5SYXRlIHx8IDEpCiAgICAgICAgICAgICAgICAgICAgZGlzY291bnQgKz0gKGsuZGlzY291bnQgfHwgMCkKICAgICAgICAgICAgICAgICAgICB4RGlzY291bnQgKz0gKGsuZGlzY291bnQgfHwgMCkgKiAoay50eG5SYXRlIHx8IDEpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgbGV0IHNwVGF4QW10ID0gMCwgc3BYVGF4QW10ID0gMCwgcGxUYXhBbXQgPSAwLCBwbFhUYXhBbXQgPSAwLCBvdFRheEFtdCA9IDAsIG90WFRheEFtdCA9IDAsCiAgICAgICAgICAgICAgICAgICAgc3BUYXhOYW1lID0gJycsIHBsVGF4TmFtZSA9ICcnLCBvdFRheE5hbWUgPSAnJywKICAgICAgICAgICAgICAgICAgICBzcFRheE5hbWVMb2NhbGUgPSAnJywgcGxUYXhOYW1lTG9jYWxlID0gJycsIG90VGF4TmFtZUxvY2FsZSA9ICcnLAogICAgICAgICAgICAgICAgICAgIHNwQWNjSWQgPSAnJywgcGxBY2NJZCA9ICcnLCBvdEFjY0lkID0gJycsCiAgICAgICAgICAgICAgICAgICAgc3BSYXRlID0gJycsIHBsUmF0ZSA9ICcnLCBvdFJhdGUgPSAnJwogICAgICAgICAgICAgICAgdGF4RGV0YWlsLmZvckVhY2gobiA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BUYXggPSBuLnNwZWNpZmljVGF4IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGxUYXggPSBuLnB1YmxpY0xpZ2h0aW5nVGF4IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RoZXJUYXggPSBuLm90aGVyVGF4IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKHNwVGF4KS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwVGF4QW10ICs9IChzcFRheC50YXhBbW91bnRfIHx8IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHNwWFRheEFtdCArPSAoKHNwVGF4LnRheEFtb3VudF8gfHwgMCkgKiAoc3BUYXgudGF4UmF0ZSB8fCAxKSkKICAgICAgICAgICAgICAgICAgICAgICAgc3BUYXhOYW1lID0gc3BUYXguZGVmYXVsdFRheCB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICBzcFRheE5hbWVMb2NhbGUgPSBzcFRheC5kZWZhdWx0VGF4TG9jYWxlIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIHNwQWNjSWQgPSBzcFRheC5hY2NvdW50ID8gc3BUYXguYWNjb3VudC5pZCA6ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIHNwUmF0ZSA9IHNwVGF4LnJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMocGxUYXgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxUYXhBbXQgKz0gKHBsVGF4LnRheEFtb3VudF8gfHwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgcGxYVGF4QW10ICs9ICgocGxUYXgudGF4QW1vdW50XyB8fCAwKSAqIChwbFRheC50YXhSYXRlIHx8IDEpKQogICAgICAgICAgICAgICAgICAgICAgICBwbFRheE5hbWUgPSBwbFRheC5kZWZhdWx0VGF4IHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIHBsVGF4TmFtZUxvY2FsZSA9IHBsVGF4LmRlZmF1bHRUYXhMb2NhbGUgfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgcGxBY2NJZCA9IHBsVGF4LmFjY291bnQgPyBwbFRheC5hY2NvdW50LmlkIDogJycKICAgICAgICAgICAgICAgICAgICAgICAgcGxSYXRlID0gcGxUYXgucmF0ZSB8fCAxCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhvdGhlclRheCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBvdFRheEFtdCArPSAob3RoZXJUYXgudGF4QW1vdW50XyB8fCAwKQogICAgICAgICAgICAgICAgICAgICAgICBvdFhUYXhBbXQgKz0gKChvdGhlclRheC50YXhBbW91bnRfIHx8IDApICogKHBsVGF4LnRheFJhdGUgfHwgMSkpCiAgICAgICAgICAgICAgICAgICAgICAgIG90VGF4TmFtZSA9IG90aGVyVGF4LmRlZmF1bHRUYXggfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgb3RUYXhOYW1lTG9jYWxlID0gb3RoZXJUYXguZGVmYXVsdFRheExvY2FsZSB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICBvdEFjY0lkID0gb3RoZXJUYXguYWNjb3VudCA/IG90aGVyVGF4LmFjY291bnQuaWQgOiAnJwogICAgICAgICAgICAgICAgICAgICAgICBvdFJhdGUgPSBvdGhlclRheC5yYXRlIHx8IDEKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgaWYgKGlzVmF0ID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgcm93LmRldGFpbCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNUYXg6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHNwVGF4TmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVMb2NhbGU6IHNwVGF4TmFtZUxvY2FsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogc3BUYXhBbXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogc3BYVGF4QW10LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBzcEFjY0lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZTogc3BSYXRlLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWNMaWdodGluZ1RheDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcGxUYXhOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZUxvY2FsZTogcGxUYXhOYW1lTG9jYWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBwbFRheEFtdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBwbFhUYXhBbXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHBsQWNjSWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlOiBwbFJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyVGF4OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBvdFRheE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lTG9jYWxlOiBvdFRheE5hbWVMb2NhbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IG90VGF4QW10LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IG90WFRheEFtdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogb3RBY2NJZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IG90UmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcm93LmRldGFpbCA9IHt9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcm93WydhbW91bnQnXSA9IGFtb3VudAogICAgICAgICAgICAgICAgcm93WydleGNoYW5nZUFtb3VudCddID0geEFtb3VudAogICAgICAgICAgICAgICAgcm93Wyd0YXhBbW91bnQnXSA9IHRheEFtb3VudAogICAgICAgICAgICAgICAgcm93WydleGNoYW5nZVRheEFtb3VudCddID0geFRheEFtb3VudAogICAgICAgICAgICAgICAgcm93WydkaXNjb3VudCddID0gZGlzY291bnQKICAgICAgICAgICAgICAgIHJvd1snZXhjaGFuZ2VEaXNjb3VudCddID0geERpc2NvdW50CiAgICAgICAgICAgICAgICByb3dbJ2N1cnJlbmN5J10gPSB0aGlzLnB1cmNoYXNlLmV4Y2hhbmdlUmF0ZSB8fCB7fQogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocm93KQogICAgICAgICAgICAgICAgdGF4RGV0YWlsID0gW10KICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5wdXJjaGFzZS5zYWxlVGF4RGV0YWlsID0gcmVzdWx0CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnc2FsZVRheERldGFpbCcsIHJlc3VsdCkKICAgICAgICB9LAogICAgICAgIGFzeW5jIGdldEV4cGVuc2VCeVN1cHBsaWVyKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWdtZW50ID0gdGhpcy5wdXJjaGFzZS5zZWdtZW50IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VnbWVudElkID0gc2VnbWVudC5pZCB8fCAnJwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gdGhpcy5wdXJjaGFzZS5sb2NhdGlvbiB8fCB7fQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uSWQgPSBsb2NhdGlvbi5pZCB8fCAnJwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1cHBsaWVyID0gdGhpcy5wdXJjaGFzZS5zdXBwbGllciB8fCB7fQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1cHBsaWVySWQgPSBzdXBwbGllci5pZCB8fCAnJwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0ckZpbHRlciA9ICc/aWQ9JyArIHN1cHBsaWVySWQgKyAnJnNlZ0lkPScgKyBzZWdtZW50SWQgKyAnJmxvY0lkPScgKyBsb2NhdGlvbklkOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXhwZW5zZXMgPSBbXQogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3RUb3RhbCA9IDAKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuQWRkaXRpb25hbENvc3QgPSBmYWxzZQogICAgICAgICAgICAgICAgICAgIHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QgPSBbXQogICAgICAgICAgICAgICAgICAgIGJpbGxpbmdIYW5kbGVyLmxpc3RQdXJjaGFzZShzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuQWRkaXRpb25hbENvc3QgPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuQWRkaXRpb25hbENvc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhwZW5zZXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbk1ldGhvZENoYW5nZWQoKQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ1R4bkFkZGl0aW9uYWxDb3N0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBjbGVhcmluZ0FjY291bnQoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0l0ZW0oKSkgewogICAgICAgICAgICAgICAgICAgIC8qIHRvZG86IGNsZWFyaW5nIGFjY291bnQgZm9yIGFkZGl0aW9uYWwgY29zdCAqLwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudCA9ICh0aGlzLnB1cmNoYXNlLmFkZGl0aW9uYWxDb3N0VG90YWwgfHwgMCkgKiAtMQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHhBbW91bnQgPSBhbW91bnQgKiB0aGlzLnB1cmNoYXNlLnR4blJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkZGljdCA9IHRoaXMucHVyY2hhc2UuYWRkaXRpb25hbENvc3QgfHwgW10KCiAgICAgICAgICAgICAgICAgICAgaWYgKGFkZGljdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZGRpY3RbMF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY291bnQgPSBhZGRpY3RbMF0uYWNjb3VudCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF0dXJlID0gJ2NyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBhY2NvdW50LmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJBZGRpdGlvbmFsIENvc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBhY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB4QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJjbGVhcmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdlcnJvcicsIGUpCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGlzSXRlbSgpIHsKICAgICAgICAgICAgY29uc3QgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKQogICAgICAgICAgICBjb25zdCByb3cgPSBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKQogICAgICAgICAgICBjb25zdCBmb3VuZCA9IHJvdy5maWx0ZXIobiA9PiBuLml0ZW0udHlwZSA9PT0gJ1ZhcmlhbnQnKQogICAgICAgICAgICBpZiAoZm91bmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZC5sZW5ndGggPiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgIH0sCiAgICBjb21wdXRlZDogewogICAgICAgIGFiYnIoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnB1cmNoYXNlKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0eG5UeXBlID0gdGhpcy5wdXJjaGFzZS50cmFuc2FjdGlvblR5cGUgfHwge30KICAgICAgICAgICAgICAgIGNvbnN0IGFiYnIgPSB0eG5UeXBlLmFiYnIgfHwgJycKICAgICAgICAgICAgICAgIHJldHVybiBhYmJyCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJycKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdmFsaWRWZW5kb3IoKSB7CiAgICAgICAgICAgIGxldCB2ZW5kb3IgPSB0aGlzLnZlbmRvcjsKICAgICAgICAgICAgcmV0dXJuIHZlbmRvci5pZCAhPT0gdW5kZWZpbmVkICYmIHZlbmRvci5pZCAhPT0gbnVsbDsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVNZSgpIHsKICAgICAgICAgICAgcmV0dXJuICEhdGhpcy4kcm91dGUucGFyYW1zLmlkOwogICAgICAgIH0sCiAgICAgICAgaGlkZGVuQnV0dG9uKCkgewogICAgICAgICAgICByZXR1cm4gISF0aGlzLiRyb3V0ZS5wYXJhbXMuaWQ7CiAgICAgICAgfSwKICAgICAgICBkaXNhYmxlZFNMUCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCkgewogICAgICAgICAgICAgICAgY29uc3QgcmVmRiA9IHRoaXMucHVyY2hhc2UucmVmRnJvbSB8fCBbXQogICAgICAgICAgICAgICAgaWYgKHJlZkYubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXJlZkYubGVuZ3RoID4gMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgYWRjID0gdGhpcy5wdXJjaGFzZS5hZGRpdGlvbmFsQ29zdCB8fCBbXQogICAgICAgICAgICAgICAgaWYgKGFkYy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhYWRjLmxlbmd0aCA+IDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9LAogICAgfSwKICAgIHdhdGNoOiB7CiAgICAgICAgLy8gaWQoKSB7CiAgICAgICAgLy8gICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIC8vICAgfSBlbHNlIHsKICAgICAgICAvLyAgICAgdGhpcy5zaG93TG9hZGluZyA9IHRydWU7CiAgICAgICAgLy8gICAgIHRoaXMubG9hZFZpZXdDcmVkaXRQdXJjaGFzZSgpOwogICAgICAgIC8vICAgfQogICAgICAgIC8vIH0sCiAgICAgICAgJyRyb3V0ZSc6ICdyZWxvYWQnCiAgICB9LAogICAgY3JlYXRlZCgpIHsKICAgICAgICB0aGlzLmxvYWRUYXgoKTsKICAgICAgICB0aGlzLmxvYWRQcmVmaXgoKTsKICAgICAgICB0aGlzLmxvYWRQcm9qZWN0QnlDdXN0b21lcigpOwogICAgfSwKICAgIG1vdW50ZWQ6IGFzeW5jIGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLnJlcXVlc3REYXRhKDAsIHRoaXMuZmlsdGVyLCB0aGlzLmN1c0Jhc2VVcmwpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZFNlZ21lbnQoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRMb2NhdGlvbigpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZERpc2NvdW50SXRlbSgpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZEVtcGxveWVlQ2VudGVyKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkUGF5bWVudFRlcm0oKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRBY2NvdW50KCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkUHJpY2VMZXZlbCgpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZE90aGVyQ2hhcmdlKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkUHVyY2hhc2VGb3JtQ29udGVudCgpOwogICAgICAgIGF3YWl0IHRoaXMuaW5pdERhdGEoKQogICAgfSwKfTsK"},{"version":3,"sources":["CreditPurchases.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAukCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"CreditPurchases.vue","sourceRoot":"src/views/suppliers","sourcesContent":["<template>\n    <v-app>\n        <v-container>\n            <v-row>\n                <v-col sm=\"12\" cols=\"12\">\n                    <v-card\n                        outlined\n                        dense\n                        class=\"pa-4 no_border rounded-sm\"\n                        color=\"white\"\n                    >\n                        <v-form ref=\"form\" v-model=\"valid\" lazy-validation>\n                            <v-row>\n                                <v-col\n                                    class=\"bigSide pr-2 py-0\"\n                                    sm=\"8\"\n                                    cols=\"12\"\n                                    style=\"transition: .3s ease-in;\"\n                                    :class=\"{ hide_big_bar_class: isHideBar }\"\n                                >\n                                    <v-card outlined dense class=\"no_border\">\n                                        <h2 class=\"mb-0\">{{ $t(\"purchase\") }}</h2>\n                                        <v-icon\n                                            v-if=\"isHideBar\"\n                                            @click=\"cancel()\"\n                                            style=\"cursor: pointer;  font-size: 40px;\"\n                                            color=\"grey\"\n                                            class=\"float-right\"\n                                        >close\n                                        </v-icon>\n                                        <span\n                                            style=\"transition: .3s ease-in; z-index:10;\"\n                                            :class=\"{\n                        iconArrow: !isHideBar,\n                        iconArrowHide: isHideBar,\n                      }\"\n                                        >\n                      <v-icon\n                          size=\"22\"\n                          class=\"arr_icon\"\n                          @click=\"hideSmallSidebar\"\n                          v-if=\"isHideBar\"\n                      >\n                        mdi-chevron-left-circle\n                      </v-icon>\n                      <v-icon\n                          size=\"22\"\n                          class=\"arr_icon\"\n                          @click=\"hideSmallSidebar\"\n                          v-if=\"!isHideBar\"\n                      >\n                        mdi-chevron-right-circle\n                      </v-icon>\n                    </span>\n                                    </v-card>\n                                    <v-card outlined dense class=\"px-4 rounded-4 no_border\" color=\"grayBg\">\n                                        <v-row>\n                                            <v-col sm=\"4\" cols=\"12\" class=\"pb-0 pt-4\">\n                                                <label class=\"label  mb-0\">{{ $t(\"supplier\") }}</label>\n                                                <v-col\n                                                    sm=\"12\"\n                                                    cols=\"12\"\n                                                    class=\"kendo_dropdown_custom px-0 pb-3 pt-0\"\n                                                >\n                                                    <dropdownlist\n                                                        :data-items=\"vendorList\"\n                                                        @change=\"onChange\"\n                                                        :value=\"vendor\"\n                                                        :data-item-key=\"dataItemKey\"\n                                                        :text-field=\"textField\"\n                                                        :default-item=\"defaultItem\"\n                                                        :filterable=\"true\"\n                                                        :required=\"true\"\n                                                        :disabled=\"disableMe\"\n                                                        :valid=\"validVendor\"\n                                                        @filterchange=\"onFilterChange\"\n                                                    >\n                                                    </dropdownlist>\n                                                </v-col>\n                                                <div hidden>\n                                                    <label class=\"label mb-0\">{{\n                                                            $t(\"purchase_type\")\n                                                        }}</label>\n                                                    <v-select\n                                                        class=\"mt-1\"\n                                                        :items=\"purchaseTypes\"\n                                                        item-value=\"id\"\n                                                        item-text=\"name\"\n                                                        v-model=\"purchase.transactionType\"\n                                                        @change=\"onInvoiceTypeChanged\"\n                                                        :rules=\"[\n                              (v) => !!v || 'Transaction Currency is required',\n                            ]\"\n                                                        return-object\n                                                        outlined\n                                                    />\n                                                </div>\n\n                                                <label class=\"label  mb-0\">{{\n                                                        $t(\"transaction_date\")\n                                                    }}</label>\n                                                <app-datepicker\n                                                    :initialDate=\"purchase.transactionDate\"\n                                                    :disabled=\"disableMe\"\n                                                    @onChanged=\"onInvoiceDateChanged\"\n                                                    @emitDate=\"txnDate = $event\"\n                                                />\n                                                <label class=\"label mb-0\">{{\n                                                        $t(\"transaction_number\")\n                                                    }}</label>\n                                                <v-row class=\"mt-1 mr-0\">\n                                                    <v-col sm=\"3\" cols=\"3\" class=\"pt-0 pr-0 pb-0\">\n                                                        <div class=\"code_text text-bold\">\n                                                            {{ abbr }}\n                                                        </div>\n                                                    </v-col>\n                                                    <v-col sm=\"7\" cols=\"7\" class=\"pt-0 pl-0 pr-1 pb-0\">\n                                                        <v-text-field\n                                                            class=\" custom-border \"\n                                                            v-model=\"purchase.number\"\n                                                            outlined\n                                                            readonly\n                                                            :rules=\"[(v) => !!v || 'Number is required']\"\n                                                            required\n                                                        />\n                                                    </v-col>\n                                                    <v-col sm=\"2\" cols=\"2\" class=\"pt-0 px-0 pb-0\">\n                                                        <v-icon\n                                                            color=\"black\"\n                                                            size=\"30\"\n                                                            class=\"border_qrcode\"\n                                                            :disabled=\"disableMe\"\n                                                            @click=\"generateNumber\"\n                                                        >mdi-qrcode\n                                                        </v-icon>\n                                                    </v-col>\n                                                </v-row>\n                                                <label class=\"label mb-0\">{{\n                                                        $t(\"suppliers_invoice_no\")\n                                                    }}</label>\n                                                <v-text-field\n                                                    class=\"mt-1 mr-0\"\n                                                    outlined\n                                                    v-model=\"purchase.billNo\"\n                                                    tage=\"Vendor Invoice Number.\"\n                                                    :rules=\"[(v) => !!v || 'required']\"\n                                                    required\n                                                />\n                                            </v-col>\n                                            <v-col sm=\"8\" cols=\"12\" class=\"pt-4\">\n                                                <v-row>\n                                                    <v-col sm=\"6\" cols=\"12\" class=\" pt-0\">\n                                                        <p class=\"mb-1 d-block\">\n                                                            {{ $t(\"current_balance\") }}\n                                                        </p>\n                                                        <h3 class=\"primary--text float-right\">\n                                                            {{ numberFormat(purchase.currentBalance) }}\n                                                            {{ baseCurrencyCode }}\n                                                        </h3>\n                                                    </v-col>\n                                                    <v-col sm=\"6\" cols=\"12\" class=\"pl-0 pt-0\">\n                                                        <p class=\"mb-1 d-block\">\n                                                            {{ $t(\"credit_limit_allowed\") }}\n                                                        </p>\n                                                        <h3 class=\"primary--text float-left\">\n                                                            {{\n                                                                creditLimitUsage(\n                                                                    purchase.currentBalance,\n                                                                    purchase.creditLimit\n                                                                )\n                                                            }}\n                                                        </h3>\n                                                        <h3 class=\"primary--text float-right\">\n                                                            {{ numberFormat(purchase.creditLimit) }}\n                                                            {{ baseCurrencyCode }}\n                                                        </h3>\n                                                    </v-col>\n                                                </v-row>\n                                                <v-row\n                                                    style=\"background-color: #fff;\"\n                                                    class=\"mr-0 mt-2\"\n                                                >\n                                                    <v-col class=\"pb-0 pt-3\" sm=\"6\" cols=\"12\">\n                                                        <label class=\"label mb-0\">{{ $t(\"term\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"purchase.paymentTerm\"\n                                                            :items=\"paymentTerms\"\n                                                            :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                            @change=\"onPaymentTermChanged\"\n                                                            placeholder=\"Term\"\n                                                            item-text=\"name\"\n                                                            item-value=\"id\"\n                                                            return-object\n                                                            outlined\n                                                        />\n\n                                                        <label class=\"label mb-0\">{{\n                                                                $t(\"account_payable\")\n                                                            }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"purchase.apAcc\"\n                                                            :items=\"accPayable\"\n                                                            item-value=\"id\"\n                                                            :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                            :item-text=\"(item) => `${item.number} - ${item.name}` \"\n                                                            return-object\n                                                            placeholder=\"Account Payable\"\n                                                            tage=\"Account Payable\"\n                                                            outlined\n                                                        />\n                                                        <label class=\"label mb-0\">{{\n                                                                $t(\"vendor_invoice_date\")\n                                                            }}</label>\n                                                        <app-datepicker\n                                                            :initialDate=\"purchase.billDate\"\n                                                            @emitDate=\"billDate = $event\"\n                                                        />\n                                                    </v-col>\n                                                    <v-col class=\"pb-0 pt-3\" sm=\"6\" cols=\"12\">\n                                                        <label class=\"label  mb-0\">{{\n                                                                $t(\"due_date\")\n                                                            }}</label>\n                                                        <app-datepicker\n                                                            :initialDate=\"purchase.dueDate\"\n                                                            @emitDate=\"dueDate = $event\"\n                                                        />\n                                                        <label class=\"label mb-0\">{{\n                                                                $t(\"price_level\")\n                                                            }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"purchase.priceLevel\"\n                                                            :items=\"priceLevel\"\n                                                            item-value=\"id\"\n                                                            @change=\"onPriceLevelChange\"\n                                                            :disabled=\"disabledSLP\"\n                                                            :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                            item-text=\"name\"\n                                                            return-object\n                                                            placeholder=\"Price Level\"\n                                                            tage=\"Default Price Level\"\n                                                            outlined\n                                                        />\n                                                        <v-col\n                                                            sm=\"12\"\n                                                            col=\"12\"\n                                                            class=\"d-flex justify-space-between pt-0\"\n                                                        >\n                                                            <div>\n                                                                <p class=\"label mb-0\">{{ $t(\"currency\") }}</p>\n                                                                <p class=\"label mb-0 mt-4\">\n                                                                    {{ currencyCode }}\n                                                                </p>\n                                                            </div>\n                                                            <div>\n                                                                <p class=\"label mb-0\">{{ $t(\"rate\") }}</p>\n                                                                <p class=\"label mb-0 mt-4\">\n                                                                    {{ transactionRate }}\n                                                                </p>\n                                                            </div>\n                                                        </v-col>\n                                                    </v-col>\n                                                </v-row>\n                                            </v-col>\n                                        </v-row>\n                                    </v-card>\n                                    <v-row style=\"background-color: #fff;\">\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pb-0 px-4\">\n                                            <kendo-datasource\n                                                ref=\"itemLineDS\"\n                                                :data=\"itemLines\"\n                                                :change=\"dataSourceChanged\"\n                                            />\n                                            <kendo-grid\n                                                id=\"gridItemLine\"\n                                                class=\"grid-function\"\n                                                :data-source-ref=\"'itemLineDS'\"\n                                                :sortable=\"false\"\n                                                :column-menu=\"true\"\n                                                :editable=\"true\"\n                                                v-on:databound=\"dataBound\"\n                                                :scrollable-virtual=\"true\">\n                                                <kendo-grid-column\n                                                    :command=\"{ iconClass: 'k-icon k-i-trash', text: ' ',  click: removeRow, className: 'isEditable', }\"\n                                                    :title=\"' '\"\n                                                    :width=\"70\"\n                                                    :headerAttributes=\"{ style:'text-align: left; background-color: #EDF1F5', }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :title=\"$t('no.')\"\n                                                    :width=\"55\"\n                                                    :column-menu=\"false\"\n                                                    :template=\"rowNumberTmpl\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5;',\n                            class: 'text-products',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: products' }\"\n                                                />\n\n                                                <kendo-grid-column\n                                                    :field=\"'item'\"\n                                                    :title=\"$t('item')\"\n                                                    :template=\"itemTemplate\"\n                                                    :editor=\"ItemDropDownEditor\"\n                                                    :attributes=\"{ class: 'isEditable'}\"\n                                                    :width=\"200\"\n                                                    :headerAttributes=\"{ style: 'background-color: #EDF1F5',}\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'description'\"\n                                                    :title=\"$t('description')\"\n                                                    :template=\"'<span>#=description#</span>'\"\n                                                    :width=\"200\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'qty'\"\n                                                    :title=\"$t('qty')\"\n                                                    :format=\"'{0:n}'\"\n                                                    :template=\"'<span>#=qty#</span>'\"\n                                                    :width=\"80\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: right; ' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'uom'\"\n                                                    :title=\"$t('uom')\"\n                                                    :width=\"120\"\n                                                    :template=\"UOMTemplate\"\n                                                    :editor=\"UOMDropDownEditor\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'cost'\"\n                                                    :title=\"$t('cost')\"\n                                                    :width=\"200\"\n                                                    :template=\"\n                            '<span>#=kendo.toString(cost || 0, decimalFormat)#</span>'\n                          \"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: right' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'amount'\"\n                                                    :title=\"$t('amount')\"\n                                                    :width=\"200\"\n                                                    :editable=\" () => { return false; }\"\n                                                    :template=\"'<span>#=kendo.toString(amount || 0, decimalFormat)#</span>'\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: right' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'vatTax'\"\n                                                    :title=\"$t('tax')\"\n                                                    :width=\"200\"\n                                                    :template=\"vatTemplate\"\n                                                    :editor=\"VatTaxDropDownEditor\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'serviceDate'\"\n                                                    :title=\"$t('date_from')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!purchaseFormContent.serviceDate\"\n                                                    :template=\"\n                            '<span>#= kendo.toString(new Date(serviceDate), dateFormat)#</span>'\n                          \"\n                                                    :editor=\"ServiceDateEditor\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'serviceDateTo'\"\n                                                    :title=\"$t('date_to')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!purchaseFormContent.serviceDateTo\"\n                                                    :template=\"\n                            '<span>#= kendo.toString(new Date(serviceDateTo), dateFormat)#</span>'\n                          \"\n                                                    :editor=\"ServiceDateToEditor\"\n                                                    :headerAttributes=\"{\n                            style: 'background-color: #EDF1F5',\n                          }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'discountItem'\"\n                                                    :title=\"$t('discount_item')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!purchaseFormContent.discountItem\"\n                                                    :template=\"discountItemTemplate\"\n                                                    :editor=\"DiscountItemDropDownEditor\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n\n                                                <kendo-grid-column\n                                                    :field=\"'class1'\"\n                                                    :title=\"$t('class_1')\"\n                                                    :hidden=\"!purchaseFormContent.class1\"\n                                                    :template=\"'<span>#=class1.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class1\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class2'\"\n                                                    :title=\"$t('class_2')\"\n                                                    :hidden=\"!purchaseFormContent.class2\"\n                                                    :template=\"'<span>#=class2.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class2\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class3'\"\n                                                    :title=\"$t('class_3')\"\n                                                    :hidden=\"!purchaseFormContent.class3\"\n                                                    :template=\"'<span>#=class3.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class3\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class4'\"\n                                                    :title=\"$t('class_4')\"\n                                                    :hidden=\"!purchaseFormContent.class4\"\n                                                    :template=\"'<span>#=class4.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class4\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                                <kendo-grid-column\n                                                    :field=\"'class5'\"\n                                                    :title=\"$t('class_5')\"\n                                                    :hidden=\"!purchaseFormContent.class5\"\n                                                    :template=\"'<span>#=class5.name || ``#</span>'\"\n                                                    :width=\"200\"\n                                                    :editor=\"ClassEditor.class5\"\n                                                    :headerAttributes=\"{\n                            style:\n                              'text-align: left; background-color: #EDF1F5',\n                          }\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"\n                                                />\n                                            </kendo-grid>\n                                        </v-col>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pt-1\">\n                                            <v-btn\n                                                class=\"float-left btn_plus mr-2\"\n                                                @click=\"addRow\"\n                                            >\n                                                <v-icon size=\"\" class=\"ma-1\">mdi-plus</v-icon>\n                                            </v-btn>\n                                        </v-col>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                            <v-row>\n                                                <v-col class=\"pt-0\" sm=\"5\" cols=\"6\">\n                                                    <v-card class=\"no-boxshadow pa-3 rounded-4\" color=\"grayBg\">\n                                                        <v-row>\n                                                            <v-col class=\"py-0 pa-4\" sm=\"12\" cols=\"12\">\n                                                                <label class=\"label mb-0\">{{\n                                                                        $t(\"billing_address\")\n                                                                    }}</label>\n                                                                <v-select\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.billingAddress\"\n                                                                    :items=\"billingAddress\"\n                                                                    item-value=\"id\"\n                                                                    item-text=\"name\"\n                                                                    tage=\"Billing Address\"\n                                                                    placeholder=\"Address\"\n                                                                    outlined\n                                                                />\n                                                                <label class=\"label mb-0\">{{\n                                                                        $t(\"pickup_delivery_address\")\n                                                                    }}</label>\n                                                                <v-select\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.deliveryAddress\"\n                                                                    :items=\"deliveryAddress\"\n                                                                    item-value=\"id\"\n                                                                    item-text=\"name\"\n                                                                    tage=\"Pickup/ Delivery Address\"\n                                                                    placeholder=\"Address\"\n                                                                    outlined\n                                                                />\n                                                                <label class=\"label  mb-0\">{{\n                                                                        $t(\"pickup_delivery_date_time\")\n                                                                    }}</label>\n                                                                <app-datepicker\n                                                                    :initialDate=\"purchase.deliveryDateTime\"\n                                                                    @emitDate=\"deliveryDateTime = $event\"\n                                                                />\n\n                                                                <label>{{ $t(\"message_on_invoice\") }}</label>\n                                                                <v-textarea\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.transactionNote\"\n                                                                    outlined\n                                                                    no-resize\n                                                                    height=\"70px\"\n                                                                    tage=\"Message on Purchase\"\n                                                                    placeholder=\"This will appear on the Purchase\"\n                                                                />\n                                                                <label>{{ $t(\"message_on_journal\") }}</label>\n                                                                <v-textarea\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"purchase.journalNote\"\n                                                                    outlined\n                                                                    no-resize\n                                                                    height=\"70px\"\n                                                                    tage=\"Message on Order\"\n                                                                    placeholder=\"This will appear on the journal\"\n                                                                />\n                                                            </v-col>\n                                                        </v-row>\n                                                    </v-card>\n                                                </v-col>\n                                                <v-col class=\"pt-0\" sm=\"7\" cols=\"6\">\n                                                    <v-simple-table>\n                                                        <template v-slot:default>\n                                                            <tbody>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"subtotal\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    {{ numberFormat(purchase.subTotal) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"general_discount\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    ({{ numberFormat(purchase.discountTotal) }})\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"total_tax\") }}\n                                                                    <v-btn\n                                                                        @click=\"dialogTax = true\"\n                                                                        color=\"primary\"\n                                                                        outlined\n                                                                        class=\"text-white text-bold  float-right text-uppercase\"\n                                                                        style=\"height: 30px !important;\"\n                                                                    >\n                                                                        {{ $t(\"tax\") }}\n                                                                    </v-btn>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    {{ numberFormat(purchase.totalTaxAmount) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\" width=\"240px\">\n                                                                    <v-select\n                                                                        class=\"mt-3\"\n                                                                        v-model=\"purchase.specificDiscountItem\"\n                                                                        :items=\"specificDiscountItem\"\n                                                                        item-text=\"name\"\n                                                                        @change=\"onSpecificDiscountChanged\"\n                                                                        item-value=\"id\"\n                                                                        return-object\n                                                                        clearable\n                                                                        outlined\n                                                                    />\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    ({{\n                                                                        numberFormat(\n                                                                            purchase.specificDiscountTotal\n                                                                                ? purchase.specificDiscountTotal\n                                                                                : 0\n                                                                        )\n                                                                    }})\n                                                                </td>\n                                                            </tr>\n                                                            <!--                                                            <tr>-->\n                                                            <!--                                                                <td class=\"text-left\">{{ $t('delivery') }}</td>-->\n                                                            <!--                                                                <td class=\"text-center\">:</td>-->\n                                                            <!--                                                                <td class=\"text-right\">{{ invoice.deliveryFee }}</td>-->\n                                                            <!--                                                            </tr>-->\n\n                                                            <tr\n                                                                v-for=\"(num, index) in numSelect\"\n                                                                :key=\"index\"\n                                                                class=\"hide_form_alert\"\n                                                            >\n                                                                <td class=\"text-left text-uppercase pr-0\">\n                                                                    <v-btn\n                                                                        v-if=\"num == 1\"\n                                                                        @click=\"addSelect\"\n                                                                        class=\"float-left mt-2 mr-1 pa-1\"\n                                                                        small\n                                                                    >\n                                                                        <v-icon\n                                                                            color=\"primary\"\n                                                                            size=\"16\"\n                                                                            class=\"ma-1\"\n                                                                        >\n                                                                            mdi-plus\n                                                                        </v-icon>\n                                                                    </v-btn>\n                                                                    <v-btn\n                                                                        v-if=\"num > 1\"\n                                                                        @click=\"removeSelect(index)\"\n                                                                        class=\"float-left mt-2 mr-1 pa-1\"\n                                                                        small\n                                                                    >\n                                                                        <v-icon\n                                                                            color=\"primary\"\n                                                                            size=\"16\"\n                                                                            class=\"ma-1\"\n                                                                        >\n                                                                            fa-trash\n                                                                        </v-icon>\n                                                                    </v-btn>\n                                                                    <v-select\n                                                                        class=\"my-2 capitalize\"\n                                                                        v-model=\"mOtherCharge[index]\"\n                                                                        :items=\"otherChargeList\"\n                                                                        item-text=\"name\"\n                                                                        @change=\"onOtherChargeChange\"\n                                                                        item-value=\"id\"\n                                                                        return-object\n                                                                        clearable\n                                                                        outlined\n                                                                    />\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                >\n                                                                    {{\n                                                                        numberFormat(\n                                                                            onOtherAmount(mOtherCharge[index])\n                                                                        )\n                                                                    }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left text-uppercase pr-0\">\n                                                                    {{ $t(\"total\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                    id=\"total\"\n                                                                >\n                                                                    {{ numberFormat(purchase.total) }}\n                                                                </td>\n                                                            </tr>\n                                                            <!--                                                            <tr>-->\n                                                            <!--                                                                <td class=\"text-left text-uppercase pr-0\">-->\n                                                            <!--                                                                    {{ $t(\"total_after_withholding\") }}-->\n                                                            <!--                                                                </td>-->\n                                                            <!--                                                                <td class=\"text-center\">:</td>-->\n                                                            <!--                                                                <td-->\n                                                            <!--                                                                    class=\"text-right primary&#45;&#45;text text-bold\"-->\n                                                            <!--                                                                    id=\"total_\"-->\n                                                            <!--                                                                >-->\n                                                            <!--                                                                    {{-->\n                                                            <!--                                                                        numberFormat(purchase.totalAfterWithholdingTax)-->\n                                                            <!--                                                                    }}-->\n                                                            <!--                                                                </td>-->\n                                                            <!--                                                            </tr>-->\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">\n                                                                    {{ $t(\"deposit\") }}\n                                                                    <span class=\"float-right primary--text\">{{\n                                                                            numberFormat(purchase.depositAmount)\n                                                                        }}</span>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right hide_form_alert\">\n                                                                    <v-text-field\n                                                                        class=\" text-right float-right deposite_input\"\n                                                                        v-model=\"purchase.depositDeduction\"\n                                                                        @change=\"onDepositDeductionChange\"\n                                                                        min=0\n                                                                        type=\"number\"\n                                                                        tage=\"Deposit\"\n                                                                        width=\"80\"\n                                                                        outlined\n                                                                    />\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">\n                                                                    {{ $t(\"amount_due\") }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td\n                                                                    class=\"text-right primary--text text-bold\"\n                                                                >\n                                                                    {{ numberFormat(purchase.remainingAmount) }}\n                                                                </td>\n                                                            </tr>\n<!--                                                            <tr>-->\n<!--                                                                <td class=\"text-left\">{{ $t(\"dr\") }}</td>-->\n<!--                                                                <td class=\"text-center\">:</td>-->\n<!--                                                                <td-->\n<!--                                                                    class=\"text-right primary&#45;&#45;text text-bold\"-->\n<!--                                                                >-->\n<!--                                                                    {{ (purchase.dr) }}-->\n<!--                                                                </td>-->\n<!--                                                            </tr>-->\n<!--                                                            <tr>-->\n<!--                                                                <td class=\"text-left\">{{ $t(\"cr\") }}</td>-->\n<!--                                                                <td class=\"text-center\">:</td>-->\n<!--                                                                <td-->\n<!--                                                                    class=\"text-right primary&#45;&#45;text text-bold\"-->\n<!--                                                                >-->\n<!--                                                                    {{ (purchase.cr) }}-->\n<!--                                                                </td>-->\n<!--                                                            </tr>-->\n                                                            </tbody>\n                                                        </template>\n                                                    </v-simple-table>\n                                                </v-col>\n                                            </v-row>\n                                        </v-col>\n                                    </v-row>\n                                    <v-divider/>\n                                    <v-card outlined dense class=\"no_border function_footer\">\n                                        <v-alert type=\"warning\" v-model=\"alert\" dismissible>\n                                            <span v-html=\"errorMessage\"/>\n                                        </v-alert>\n                                        <v-menu>\n                                            <template v-slot:activator=\"{ on }\">\n                                                <v-btn\n                                                    class=\"mr-2 float-left select_template\"\n                                                    v-on=\"on\"\n                                                >\n                                                    {{ $t(\"select_template\") }}\n                                                    <v-icon size=\"\" class=\"ma-1\">expand_more</v-icon>\n                                                </v-btn>\n                                            </template>\n                                            <v-list>\n                                                <v-list-item\n                                                    v-for=\"(item, index) in templates\"\n                                                    :key=\"index\"\n                                                >\n                                                    <v-list-item-title>{{\n                                                            item.title\n                                                        }}\n                                                    </v-list-item-title>\n                                                </v-list-item>\n                                            </v-list>\n                                        </v-menu>\n                                        <v-btn\n                                            outlined\n                                            class=\"text-capitalize  black--text float-left\"\n                                            color=\"primary\"\n                                            @click=\"cancel\"\n                                        >{{ $t(\"cancel\") }}\n                                        </v-btn>\n                                        <v-btn\n                                            class=\"float-right text-capitalize  white--text\"\n                                            @click=\"onSaveClose(false)\"\n                                            color=\"primary\">\n                                            {{ $t(\"save_close\") }}\n                                        </v-btn>\n                                        <v-btn color=\"secondary\"\n                                               style=\"margin-right: 10px !important\"\n                                               class=\"white--text float-right text-capitalize\"\n                                               @click=\"onSaveClose(true)\" :hidden=\"hiddenButton\">{{ $t(\"save_new\") }}\n                                        </v-btn>\n                                    </v-card>\n                                </v-col>\n                                <v-col\n                                    class=\"smallSide pl-2 pt-0\"\n                                    sm=\"4\"\n                                    style=\"transition: .3s ease-in;\"\n                                    :class=\"{ hide_small_bar_class: isHideBar }\"\n                                >\n                                    <div class=\"d-flex justify-end\">\n                                        <h3\n                                            style=\"color: #b3b5bc; font-size:20px;\"\n                                            v-if=\"!isHideBar\"\n                                            class=\"text-uppercase\"\n                                        >\n                      <span class=\"pointer\" @click=\"Help('purchase')\">\n                        {{ $t(\"help\") }}\n                      </span>\n                                            <v-icon\n                                                @click=\"cancel()\"\n                                                style=\"cursor: pointer; color: #333; font-size: 40px;\"\n                                                class=\"float-right mt-n1\"\n                                            >close\n                                            </v-icon>\n                                        </h3>\n                                    </div>\n                                    <div\n                                        v-if=\"!isHideBar\"\n                                        class=\"small_sidebar rounded-4 mt-2 px-4 pt-4 grayBg\"\n                                    >\n                                        <v-card outlined dense class=\"pa-3 no_border my_card rounded-4 white--text\"\n                                                color=\"primary\" height=\"60px\">\n                                            <h3 class=\"text-left font_13 flex-1 text-uppercase\">{{\n                                                    $t('amount_due')\n                                                }}</h3>\n                                            <h3 class=\"text-right flex-1 font_20 niradei_heavy\">\n                                                {{ numberFormat(purchase.amountDue) }} </h3>\n                                        </v-card>\n                                        <v-row>\n                                            <v-col sm=\"12\" cols=\"12\" class=\"pt-4\">\n                                                <label class=\"label mb-0\">{{ $t(\"segment\") }}</label>\n                                                <v-select\n                                                    class=\"mt-1\"\n                                                    v-model=\"purchase.segment\"\n                                                    :items=\"segments\"\n                                                    item-value=\"id\"\n                                                    :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                    @change=\"loadPurchaseOrder\"\n                                                    :disabled=\"disabledSLP\"\n                                                    :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                    return-object\n                                                    tage=\"Segment\"\n                                                    placeholder=\"Segment\"\n                                                    outlined=\"\"\n                                                />\n                                                <label class=\"label mb-0\">{{ $t(\"location\") }}</label>\n                                                <v-select\n                                                    class=\"mt-1\"\n                                                    v-model=\"purchase.location\"\n                                                    :items=\"locations\"\n                                                    :disabled=\"disabledSLP\"\n                                                    @change=\"loadPurchaseOrder\"\n                                                    item-value=\"id\"\n                                                    :rules=\"[(v) => !!v['id'] || 'required']\"\n                                                    :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                    return-object\n                                                    tage=\"Location\"\n                                                    placeholder=\"bu/location\"\n                                                    outlined=\"\"\n                                                />\n                                                <label class=\"label font_14\">{{ $t(\"project\") }}</label>\n                                                <v-select\n                                                    class=\" mt-1\"\n                                                    v-model=\"purchase.project\"\n                                                    :items=\"customerProjects\"\n                                                    :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                    item-value=\"id\"\n                                                    clearable\n                                                    tage=\"Customer Project\"\n                                                    placeholder=\"project\"\n                                                    outlined\n                                                />\n                                                <label class=\"label font_14\">{{\n                                                        $t(\"employee\")\n                                                    }}</label>\n                                                <v-col\n                                                    sm=\"12\"\n                                                    cols=\"12\"\n                                                    class=\"kendo_dropdown_custom pl-0 pr-0 pb-3 pt-0\"\n                                                >\n                                                    <dropdownlist\n                                                        :data-items=\"employees\"\n                                                        @change=\"onEmployeeChanged\"\n                                                        :value=\"mEmployee\"\n                                                        :data-item-key=\"'id'\"\n                                                        :text-field=\"'name'\"\n                                                        :default-item=\"defaultItem\"\n                                                        :filterable=\"true\"\n                                                        @filterchange=\"onEmployeeFilterChanged\"\n                                                    >\n                                                    </dropdownlist>\n                                                </v-col>\n                                                <label class=\"label\">{{ $t(\"for_month_of\") }}</label>\n                                                <month-picker\n                                                    :initialMonth=\"monthOf\"\n                                                    @emitMonth=\"monthOf = $event\"\n                                                />\n                                            </v-col>\n                                        </v-row>\n                                        <v-divider/>\n                                        <v-row>\n                                            <v-col sm=\"12\" cols=\"12\" class=\"pt-1\">\n                                                <v-row>\n                                                    <v-col sm=\"12\" cols=\"12\">\n                                                        <label\n                                                            class=\"label text-bold text-uppercase\">{{\n                                                                $t('tnc_to_be_added')\n                                                            }}</label>\n                                                        <LoadingMe :isLoading=\"showLoadingTxn\" :fullPage=\"false\"\n                                                                   :myLoading=\"true\"\n                                                                   type=\"loading\"/>\n                                                        <v-row v-for=\"item in purchaseOrders\" v-bind:key=\"item.id\">\n                                                            <v-col sm=\"10\" cols=\"10\" class=\"py-0 pr-0\">\n                                                                <v-card\n                                                                    outlined\n                                                                    color=\"third\"\n                                                                    class=\"px-3 py-1 white--text no-boxshadow no_border justify-left d-flex\"\n                                                                    style=\" height: 38px\">\n                                                                    <p class=\"mb-0\" style=\"width: 100%\">\n                                                            <span\n                                                                class=\"pl-3 py-1 float-left\">{{\n                                                                    item.referenceNo\n                                                                }}</span>\n                                                                    </p>\n                                                                </v-card>\n                                                            </v-col>\n                                                            <v-col sm=\"2\" cols=\"2\" class=\"py-0  pl-1\">\n                                                                <v-btn\n                                                                    class=\"text-white text-bold float-right text-uppercase\"\n                                                                    outlined\n                                                                    icon\n                                                                    color=\"primary\"\n                                                                    style=\"height: 30px\"\n                                                                    @click=\"addPurchaseOrder(item)\">\n                                                                    <v-icon>mdi-plus</v-icon>\n                                                                </v-btn>\n                                                            </v-col>\n                                                        </v-row>\n                                                    </v-col>\n                                                </v-row>\n\n                                                <v-divider/>\n                                                <v-row v-if=\"expenses.length >0\">\n                                                    <v-col sm=\"12\" cols=\"12\">\n                                                        <div class=\"justify-space-between\">\n                                                            <label\n                                                                class=\"label lb_bold text-bold text-uppercase\">{{\n                                                                    $t('additional_cost')\n                                                                }}</label>\n                                                            <p class=\"mb-2\">{{ $t('total') }}:\n                                                                {{ numberFormat(additionalCostTotal) }}</p>\n                                                        </div>\n                                                        <label class=\"label mb-0\">{{ $t(\"method\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            :items=\"methods\"\n                                                            @change=\"onMethodChanged\"\n                                                            v-model=\"purchase.additionalCostMethod\"\n                                                            placeholder=\"Method\"\n                                                            return-object\n                                                            outlined\n                                                        />\n                                                        <LoadingMe :isLoading=\"showLoadingTxnAdditionalCost\"\n                                                                   :fullPage=\"false\"\n                                                                   :myLoading=\"true\"\n                                                                   type=\"loading\"/>\n                                                        <v-row v-for=\"(item,i) in expenses\" v-bind:key=\"item.id\">\n                                                            <v-col sm=\"10\" cols=\"10\" class=\"py-0 pr-0\">\n                                                                <v-card\n                                                                    outlined\n                                                                    color=\"third\"\n                                                                    class=\"px-2 py-2 white--text no-boxshadow d-flex justify-space-between no_border\"\n                                                                    style=\" height: 38px\">\n                                                                    <p class=\"ma-0 font_14\">\n                                                                        {{ item.referenceNo || '' }}</p>\n                                                                    <p class=\"ma-0 font_14\">\n                                                                        {{ numberFormat(item.exchangeAmount) || 0 }}</p>\n\n                                                                </v-card>\n                                                            </v-col>\n                                                            <v-col sm=\"2\" cols=\"1\" class=\"py-0  pl-1\">\n                                                                <v-checkbox class=\"ma-0\" v-model=\"chkChecked[i]\"\n                                                                            :value=\"item\"\n                                                                            :disabled=\"disableMe\"\n                                                                            @change=\"onCheckChanged(item)\"/>\n                                                            </v-col>\n                                                        </v-row>\n\n                                                        <!--                                                        <v-row>-->\n                                                        <!--                                                            <v-col sm=\"12\" cols=\"12\" class=\"py-0\">-->\n                                                        <!--                                                                <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">1.-->\n                                                        <!--                                                                    {{ $t('expenses') }}</label>-->\n                                                        <!--                                                            </v-col>-->\n                                                        <!--                                                            <v-col sm=\"8\" cols=\"8\" class=\"py-0 pr-0\">-->\n                                                        <!--                                                                <v-card outlined-->\n                                                        <!--                                                                        color=\"third\"-->\n                                                        <!--                                                                        class=\"px-3  white&#45;&#45;text py-1  no-boxshadow no_border justify-left d-flex\"-->\n                                                        <!--                                                                        style=\" height: 40px\">-->\n                                                        <!--                                                                    <input type=\"checkbox\"-->\n                                                        <!--                                                                           class=\"checkbox_inv float-left mt-2\"/>-->\n                                                        <!--                                                                </v-card>-->\n                                                        <!--                                                            </v-col>-->\n                                                        <!--                                                            <v-col sm=\"4\" cols=\"4\" class=\"py-0  pl-1\">-->\n                                                        <!--                                                                <v-select class=\" pl-3 exp_select\"-->\n                                                        <!--                                                                          :items=\"expense\"-->\n                                                        <!--                                                                          label=\"Equal\"-->\n                                                        <!--                                                                          outlined-->\n                                                        <!--                                                                />-->\n                                                        <!--                                                            </v-col>-->\n                                                        <!--                                                        </v-row>-->\n                                                    </v-col>\n                                                </v-row>\n                                            </v-col>\n                                        </v-row>\n                                    </div>\n                                    <p class=\"pa-3 mb-0 mt-20 detial_smallside_p font_14\">\n                                        {{ $t(\"credit_purchase_desc\") }}\n                                    </p>\n                                </v-col>\n                            </v-row>\n                        </v-form>\n                    </v-card>\n                </v-col>\n            </v-row>\n            <LoadingMe :isLoading=\"showLoading\" :fullPage=\"false\" :myLoading=\"true\"/>\n            <v-dialog v-model=\"dialogTax\" max-width=\"450px\">\n                <v-card>\n                    <div class=\"modal_header\">\n                        <v-card-title>{{ $t(\"tax_list\") }}</v-card-title>\n                        <v-icon @click=\"dialogTax = false\">close</v-icon>\n                    </div>\n                    <v-card-text class=\"modal_text_content\">\n                        <v-row>\n                            <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                <v-simple-table>\n                                    <template v-slot:default>\n                                        <tbody>\n                                        <tr\n                                            v-for=\"(value, name) in taxListTotal\"\n                                            v-bind:key=\"name\"\n                                        >\n                                            <td class=\"text-left\" width=\"180px\">{{ name }}</td>\n                                            <td class=\"text-center\">:</td>\n                                            <td class=\"text-right\">\n                                                {{ numberFormat(value) }}\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td class=\"text-left\" width=\"180px\">\n                                                {{ $t(\"total\") }}\n                                            </td>\n                                            <td class=\"text-center\">:</td>\n                                            <td class=\"text-right\">\n                                                {{ numberFormat(purchase.totalTaxAmount) }}\n                                            </td>\n                                        </tr>\n                                        </tbody>\n                                    </template>\n                                </v-simple-table>\n                            </v-col>\n                        </v-row>\n                    </v-card-text>\n                    <v-divider/>\n                </v-card>\n            </v-dialog>\n        </v-container>\n    </v-app>\n</template>\n\n<script>\n// import kendo from \"@progress/kendo-ui\"\nimport {i18n} from \"@/i18n\";\nimport PurchaseModel from \"@/scripts/purchase/model/Purchase\";\nimport ItemLineModel from \"@/scripts/purchase/model/ItemLine\";\nimport {uuid} from \"vue-uuid\";\nimport {DropDownList} from \"@progress/kendo-vue-dropdowns\";\nimport kendo from \"@progress/kendo-ui\";\nimport PurchaseFormContentModel from \"@/scripts/model/PurchaseFormContent\";\nimport {dataStore, ShowResource} from \"@/observable/store\";\nimport paymentTermHandler_ from \"@/scripts/paymentterm/handler/paymentTermHandler\";\nimport creditLimitHandler from \"@/scripts/creditLimit/handler/creditLimitHandler\";\nimport saleOrderHandler from \"@/scripts/transactionHandler\";\nimport Helper from \"@/helper\";\nimport settingsHandler from \"@/scripts/settingsHandler\";\n\nconst supplierHandler = require(\"@/scripts/supplierHandler\");\n// import kendo from \"@progress/kendo-ui\";\n\nconst projectHandler = require(\"@/scripts/projectHandler\");\nconst priceLevelHandler = require(\"@/scripts/priceLevelHandler\");\nconst currencyHandler = require(\"@/scripts/currency/handler/currencyHandler\");\n\n// const settingsHandler = require(\"@/scripts/settingsHandler\");\nconst employeeHandler = require(\"@/scripts/employeeHandler\");\nconst locationHandler = require(\"@/scripts/locationHandler\");\n// const paymentTermHandler = require(\"@/scripts/paymentTermHandler\");\nconst accountHandler = require(\"@/scripts/handler/accounting/account\");\nconst productVariantHandler = require(\"@/scripts/productVariantHandler\");\nconst uomPriceHandler = require(\"@/scripts/uomPriceHandler\");\nconst discountItemHandler = require(\"@/scripts/discountItemHandler\");\nconst settingHandler = require(\"@/scripts/settingHandler\");\nconst otherChargeHandler = require(\"@/scripts/otherChargeHandler\");\nconst purchaseFormContentHandler = require(\"@/scripts/purchaseFormContentHandler\");\nconst prefixHandler = require(\"@/scripts/prefixHandler\");\nconst billingHandler = require(\"@/scripts/invoice/handler/billingHandler\");\n\nconst purchaseModel = new PurchaseModel({});\nconst itemLineModel = new ItemLineModel({});\nconst purchaseFormContentModel = new PurchaseFormContentModel({});\nconst $ = kendo.jQuery\n\nconst textField = \"numberName\";\nconst keyField = \"id\";\nconst defaultItem = {[textField]: \"Select vendor...\", [keyField]: null};\nconst emptyItem = {[textField]: \"loading ...\"};\nconst pageSize = 10;\nconst itemLinePrefix = \"lin-\";\nconst loadingData = [];\nwhile (loadingData.length < pageSize) {\n    loadingData.push({...emptyItem});\n}\nconst {ClassEditor} = require(\"@/scripts/kendo_editor/Collections\");\nconst DISCOUNT_TYPE = \"?type=Purchase\";\nconst TRANSACTION_TYPE = \"Purchase\";\nconst cookieJS = require(\"@/cookie.js\");\nconst cookie = cookieJS.getCookie();\nconst NATURE = 'purchase'\nexport default {\n    name: \"CreditPurchase\",\n    props: [\"id\", \"transactionDate\"],\n    components: {\n        LoadingMe: () => import(`@/components/Loading`),\n        \"app-datepicker\": () => import(\"@/components/custom_templates/DatePickerComponent\"),\n        \"month-picker\": () => import(\"@/components/custom_templates/MonthPicker\"),\n        dropdownlist: DropDownList,\n    },\n    data: () => ({\n        isEdit: false,\n        showLoadingTxn: false,\n        showLoadingTxnAdditionalCost: false,\n        mOtherCharge: [],\n        mOtherChargeAmount: [],\n        purchaseOrders: [],\n        numSelect: [1],\n        dialogTax: false,\n        vendorList: [],\n        showLoading: false,\n        bill_date: \"\",\n        alert: false,\n        files: [],\n        // Form validation\n        valid: true,\n        itemLines: [],\n        txnDate: new Date().toISOString().substr(0, 10),\n        billDate: new Date().toISOString().substr(0, 10),\n        invoiceDate: new Date().toISOString().substr(0, 10),\n        monthOf: \"\",\n        templates: [\n            {title: \"Purchase\", value: \"Purchase\"},\n\n        ],\n        isHideBar: false,\n        vendor: {},\n        defaultItem: defaultItem,\n        purchase: purchaseModel,\n        transactionType: [\"Invoice\", \"Commercial Invoice\", \"Tax Invoice\"],\n        cusBaseUrl: supplierHandler.search(),\n        empBaseUrl: employeeHandler.search(),\n        init: {method: \"GET\", accept: \"application/json\", headers: []},\n        pendingRequest: undefined,\n        requestStarted: false,\n        skip: 0,\n        tempSkip: null,\n        total: 0,\n        filter: \"\",\n        referenceNo: \"\",\n        filter_: \"\",\n        textField: \"numberName\",\n        dataItemKey: \"id\",\n        segments: [],\n        employees: [],\n        methods: ['Qty Based', 'Amount Based'],\n        mEmployee: {},\n        customerProjects: [],\n        billingAddress: [],\n        deliveryAddress: [],\n        deliveryDateTime: new Date().toISOString().substr(0, 10),\n        priceLevel: [],\n        locations: [],\n        paymentTerms: [],\n        accPayable: [],\n        currencies: [],\n        itemLine: itemLineModel,\n        uoms: [],\n        tax: [],\n        specificDiscountItem: [],\n        otherChargeList: [],\n        depositBalance: 0,\n        schemaDefinition: {\n            model: {\n                id: \"id\",\n            },\n        },\n        purchaseFormContent: purchaseFormContentModel,\n        ClassEditor: ClassEditor,\n        taxListTotal: {},\n        purchaseTypes: [],\n        taxListDetail: [],\n        supplierDiscountItem: [],\n        lateFeeList: [],\n        loggedUser: {\n            id: cookie.creator,\n            name: cookie.email,\n        },\n        exchangeRate: {},\n        baseCurrencyCode: \"\",\n        currencyCode: \"\",\n        transactionRate: 1,\n        jRaw: [],\n        refFrom: [],\n        isPriceLevelChanged: false,\n        expenses: [],\n        additionalCostTotal: 0,\n        chkChecked: [],\n        accWithholdingExpense: []\n    }),\n    methods: {\n        dataBound: function (e) {\n            const grid = kendo.jQuery(\"#gridItemLine\").data(\"kendoGrid\");\n            const items = e.sender.items();\n            if (grid) {\n                items.each(function () {\n                    let dataItem = grid.dataItem(this);\n                    $(\"tr[data-uid='\" + dataItem.uid + \"']\").find('.isEditable')\n                        .each(function () {\n                            if (dataItem.isEditable === false) {\n                                $(this).addClass(\"k-state-disabled\");\n                            }\n                        });\n                });\n            }\n        },\n        onMethodChanged() {\n            if (this.isItem()) {\n                this.calculateAdditionalCost()\n                this.autoCalculate()\n            }\n        },\n        onCheckChanged() {\n            if (this.isItem()) {\n                this.additionalCostTotal = 0\n                this.jRaw = []\n                if (this.chkChecked) {\n                    this.chkChecked.forEach(m => {\n                        if (m) {\n                            const xAmount = m.exchangeAmount || 0\n                            this.additionalCostTotal += parseFloat(xAmount)\n                        }\n                    })\n                    this.purchase.additionalCost = this.chkChecked\n                    this.purchase.additionalCostTotal = this.additionalCostTotal\n                    // if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    //     this.percentageApplied()\n                    // } else {\n                    //     this.amountApplied()\n                    // }\n                    this.calculateAdditionalCost()\n                    this.autoCalculate()\n                }\n            }\n        },\n        onPriceLevelChange() {\n            this.isPriceLevelChanged = true\n            this.loadTransactionRate()\n            this.clearUOMItem()\n        },\n        async clearUOMItem() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            ds.data().map(n => {\n                n.set('uom', {})\n            })\n            this.isPriceLevelChanged = false\n        },\n        async loadPaymentTermList() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    if (this.vendor) {\n                        const strFilter = '?id=' + this.vendor.id + '&transactionDate=' + this.purchase.transactionDate + '&type=Vendor'\n                        this.purchase.paymentTerm = {}\n                        paymentTermHandler_.get(strFilter).then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const terms = res.data.data\n                                this.purchase.paymentTerm = terms.term\n                                this.onPaymentTermChanged()\n                            }\n                        });\n                    }\n                }, 10);\n            });\n        },\n        async loadCreditLimit() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    if (this.vendor) {\n                        const strFilter = '?id=' + this.vendor.id + '&transactionDate=' + this.purchase.transactionDate + '&type=Vendor'\n                        this.purchase.creditLimit = 0\n                        creditLimitHandler.get(strFilter).then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const credit = res.data.data\n                                this.purchase.creditLimit = kendo.parseFloat(credit.amount || 0);\n                            }\n                        });\n                    }\n                }, 10);\n            });\n        },\n        async observerClean(obj) {\n            return Object.keys(obj).reduce(\n                (res, e) => Object.assign(res, {[e]: obj[e]}),\n                {}\n            );\n        },\n        Help(key_search) {\n            ShowResource(key_search);\n        },\n        AmountEditor(container, options) {\n            kendo\n                .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoNumericTextBox({\n                    decimals: 30,\n                    format: `${this.purchaseFormContent.decimal}`,\n                });\n        },\n        vatTemplate(dataItem) {\n            const vat = dataItem.vatTax || {};\n            if (vat) {\n                return `<span>${vat.defaultTax ? vat.defaultTax : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        itemTemplate(dataItem) {\n            const item = dataItem.item;\n            if (item) {\n                return `<span>${item.name ? item.name : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        UOMTemplate(dataItem) {\n            const uom = dataItem.uom || {};\n            const code = uom.code || ''\n            if (uom) {\n                return `<span>${uom.uom ? code : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        discountItemTemplate(dataItem) {\n            const discountItem = dataItem.discountItem;\n            if (discountItem) {\n                return `<span>${discountItem.code ? discountItem.code : ``} - ${\n                    discountItem.name ? discountItem.name : ``\n                }</span>`;\n            } else {\n                return ``;\n            }\n        },\n        addSelect() {\n            let amount_num = this.numSelect.length;\n            let num = this.numSelect[amount_num - 1];\n            let new_num = num + 1;\n            let lenghtItem = this.specificDiscountItem.length;\n            if (new_num <= lenghtItem) {\n                this.numSelect.push(new_num);\n            }\n        },\n        removeSelect(index) {\n            this.numSelect.splice(index, 1);\n            // window.console.log(index, this.numSelect)\n            // this.selectDiscount.splice(index,1)\n            // window.console.log(\"remove\",this.selectDiscount)\n            // this.selectDiscount = this.selectDiscount.filter(item =>  item.id != val.id);\n        },\n        onOtherChargeChange() {\n            let otherCharge = 0;\n            this.mOtherCharge.forEach((m) => {\n                otherCharge += this.autoCalculateDiscount(m, this.purchase.subTotal);\n            });\n            this.purchase.otherChargeAmount = otherCharge;\n            this.autoCalculate();\n        },\n        onOtherAmount(value) {\n            return this.autoCalculateDiscount(value, this.purchase.subTotal);\n        },\n        onSpecificDiscountChanged() {\n            this.purchase.specificDiscountTotal = 0;\n            if (this.purchase.specificDiscountItem) {\n                // window.console.log('-changed', this.purchase.specificDiscountItem)\n                this.purchase.specificDiscountTotal =\n                    this.autoCalculateDiscount(\n                        this.purchase.specificDiscountItem,\n                        this.purchase.subTotal\n                    ) || 0;\n                this.purchase.total =\n                    kendo.parseFloat(this.purchase.subTotal) -\n                    (kendo.parseFloat(this.purchase.discountTotal) +\n                        kendo.parseFloat(this.purchase.totalTaxAmount)) -\n                    this.autoCalculateDiscount(\n                        this.purchase.specificDiscountItem,\n                        this.purchase.subTotal\n                    );\n            }\n            this.autoCalculate();\n        },\n        empImpl(dataItem) {\n            let empIds = [];\n            dataItem.employee.forEach((m) => {\n                empIds.push(m.firstName + \" - \" + m.lastName);\n            });\n            // window.console.log(empIds.join(', '))\n            return `<span>${empIds.join(\", \")}</span>`;\n        },\n        uomTmp(dataItem) {\n            window.console.log(dataItem);\n            return dataItem;\n        },\n        onInvoiceTypeChanged() {\n            if (this.$route.params.id === null || this.$route.params.id === \"\") {\n                this.generateNumber();\n            }\n        },\n        autoCalculateTaxByType(tax) {\n            // return by a key\n            const groupAll = (list) =>\n                list.reduce((tax, item) => {\n                    const taxAmount = tax[item.name] || 0;\n                    return Object.assign({}, tax, {\n                        [item.name]: taxAmount + parseFloat(item.amount),\n                    });\n                }, {});\n            this.taxListTotal = groupAll(tax);\n            window.console.log(\"nimol\", groupAll(tax));\n        },\n        onDepositDeductionChange() {\n            const deduct = parseFloat(this.purchase.depositDeduction || 0)\n            if (deduct < 0) {\n                this.purchase.depositDeduction = 0\n            }\n            if (this.purchase.depositDeduction === \"\" || this.purchase.depositDeduction === undefined) {\n                this.purchase.depositDeduction = 0;\n            }\n            const deduction = parseFloat(this.purchase.depositDeduction) || 0;\n            if (deduction > this.purchase.depositAmount) {\n                this.purchase.depositDeduction = this.purchase.depositAmount;\n            }\n\n            this.autoCalculate();\n        },\n        async autoCalculate() {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                subTotal = 0,\n                totalTax = 0,\n                discountTotal = 0,\n                spTax = 0,\n                pltax = 0,\n                otherTax = 0,\n                vatTax = 0,\n                discountInvoice = 0,\n                taxList = [],\n                taxListDetail = [],\n                discountItem = [],\n                discountLine = [],\n                inclusiveTax = 0,\n                taxTypeId = 0,\n                withholdingTaxAmount = 0,\n                whTaxAmount = 0,\n                itemSubtotal = 0,\n                txnItmSubtotal = 0,\n                serviceSubtotal = 0,\n                itemDiscount = 0,\n                serviceDiscount = 0,\n                txnDiscount = 0;\n            let nature = \"\";\n            this.jRaw = [];\n            const rows = ds.data().filter((m) => parseFloat(m.amount) > 0);\n            rows.forEach((value) => {\n                let modifierPrice = 0, incTax = 0;\n                if (value.modifier) {\n                    modifierPrice = kendo.parseFloat(value.modifier.price);\n                }\n\n                let discount = 0;\n                if (value.discountItem) {\n                    const disItemField = value.discountItem;\n                    let subTo =\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    discount = this.autoCalculateDiscount(value.discountItem, subTo);\n                    value[\"discountAmount\"] = discount;\n                    value[\"discountExchangeAmount\"] =\n                        discount * kendo.parseFloat(this.purchase.txnRate);\n                    if (value.discountItem.hasOwnProperty(\"id\")) {\n                        discountItem.push(value.discountItem);\n                    }\n                    discountTotal += discount ? discount : 0;\n                    if (discount * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (disItemField.account) {\n                        if (disItemField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: disItemField.account.id + \"-\" + nature,\n                                line: new ItemLineModel(value),\n                                description: \"Purchase Discount\",\n                                account: disItemField.account,\n                                accountId: disItemField.account.id,\n                                amount: discount * -1,\n                                exchangeAmount:\n                                    discount * kendo.parseFloat(this.purchase.txnRate) * -1,\n                                type: nature,\n                                typeAs: \"discount\",\n                            });\n                        }\n                    }\n                }\n                if (value.vatTax) {\n                    // window.console.log('Vat Tax', value.tax)\n                    let amt =\n                        kendo.parseFloat(spTax ? spTax : 0) +\n                        kendo.parseFloat(pltax ? pltax : 0) +\n                        kendo.parseFloat(otherTax ? otherTax : 0) +\n                        (kendo.parseFloat(value.amount ? value.amount : 0) -\n                            (discount ? discount : 0));\n                    vatTax = this.autoCalculateTax(value.vatTax, amt);\n                    vatTax = kendo.parseFloat(vatTax) ? kendo.parseFloat(vatTax) : 0;\n                    value[\"vatTaxAmount\"] = vatTax;\n                    value[\"vatTaxExchangeAmount\"] =\n                        vatTax * kendo.parseFloat(this.purchase.txnRate);\n                    const tax = value.vatTax || {};\n                    const baseAmount = tax.baseAmount || '';\n                    window.console.log(tax, \"im tax\");\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            incTax = vatTax\n                        } else {\n                            inclusiveTax += vatTax;\n                        }\n                    }\n                    if (value.vatTax.hasOwnProperty(\"taxType\")) {\n                        taxList.push({\n                            name: value.vatTax.taxType.name,\n                            amount: vatTax,\n                            id: value.vatTax.taxType.id,\n                        });\n                        const vatTax_ = value.vatTax || {}\n                        vatTax_['taxAmount_'] = vatTax\n                        vatTax_['amount'] = value.amount || 0\n                        vatTax_['discount'] = discount || 0\n                        vatTax_['txnRate'] = this.purchase.txnRate || 1\n                        vatTax_['isVat'] = 1\n                        vatTax_.detail = {\n                            specificTax: {},\n                            publicLightingTax: {},\n                            otherTax: {},\n                        }\n                        taxListDetail.push(vatTax_);\n                        window.console.log('vat_', vatTax_)\n                    }\n                    if (value.vatTax.hasOwnProperty(\"taxType\")) {\n                        const taxType = value.vatTax.taxType || {};\n                        taxTypeId = taxType.typeId || 0;\n                    }\n                    let taxAmount = vatTax;\n                    let taxDescription = \"\";\n                    if (taxTypeId === 1) {\n                        nature = \"dr\";\n                        taxAmount = vatTax;\n                        taxDescription = \"Purchase Tax\";\n                    } else if (taxTypeId === 2) {\n                        withholdingTaxAmount += vatTax;\n                        if (taxTypeId === 2 && baseAmount.toLowerCase() === 'net') {\n                            whTaxAmount += vatTax;\n                        }\n                        nature = \"cr\";\n                        taxAmount = vatTax * -1;\n                        taxDescription = \"Withholding Tax\";\n                    } else if (taxTypeId === 10) {\n                        nature = \"cr\";\n                        taxAmount = 0;\n                        taxDescription = \"No Tax\";\n                    }\n                    if (taxAmount > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    const vatTaxField = value.vatTax || {};\n                    if (taxAmount !== 0) {\n                        if (vatTaxField) {\n                            if (vatTaxField.account) {\n                                if (vatTaxField.account.hasOwnProperty(\"id\")) {\n                                    this.jRaw.push({\n                                        id: vatTaxField.account.id + \"-\" + nature,\n                                        line: new ItemLineModel(value),\n                                        description: taxDescription,\n                                        account: vatTaxField.account,\n                                        accountId: vatTaxField.account.id,\n                                        amount: taxAmount,\n                                        exchangeAmount:\n                                            taxAmount * kendo.parseFloat(this.purchase.txnRate),\n                                        type: nature,\n                                        typeAs: \"tax\",\n                                    });\n                                }\n                            }\n                        }\n                    }\n                }\n                totalTax += kendo.parseFloat(spTax ? spTax : 0) + kendo.parseFloat(pltax ? pltax : 0) +\n                    kendo.parseFloat(otherTax ? otherTax : 0) +\n                    kendo.parseFloat(vatTax ? vatTax : 0);\n                subTotal += kendo.parseFloat(value.amount) + modifierPrice - incTax;\n                const amount = kendo.parseFloat(value.amount) + modifierPrice;\n                const amt = this.excludeVATTaxInclusive(value.vatTax, amount, incTax)\n                // const xAmount = (kendo.parseFloat(amt) * kendo.parseFloat(this.purchase.txnRate))\n                const additc = value.additionalCost || 0\n                const itemAmount = amt\n                const itemXAmount = itemAmount * kendo.parseFloat(this.purchase.txnRate);\n\n                const item = value.item;\n                const itmType = item.type || \"\";\n                if (itmType === \"Variant\") {\n                    itemSubtotal +=\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    itemDiscount += kendo.parseFloat(discount);\n                } else if (itmType === \"Service\") {\n                    serviceSubtotal +=\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    serviceDiscount += kendo.parseFloat(discount);\n                } else {\n                    txnItmSubtotal +=\n                        kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty);\n                    txnDiscount += kendo.parseFloat(discount);\n                }\n                if (amt > 0) {\n                    nature = \"dr\";\n                } else {\n                    nature = \"cr\";\n                }\n                if (item) {\n                    if (item.type === \"Service\") {\n                        const plan = item.isPan || false;\n                        if (plan) {\n                            if (item.hasOwnProperty(\"deferredIncomeAcc\")) {\n                                if (item.deferredIncomeAcc.hasOwnProperty(\"id\")) {\n                                    let deferredInAcc = item.deferredIncomeAcc;\n                                    this.jRaw.push({\n                                        id: deferredInAcc.id + \"-\" + nature,\n                                        line: new ItemLineModel(value),\n                                        description: this.purchase.journalNote,\n                                        account: deferredInAcc,\n                                        accountId: deferredInAcc.id,\n                                        amount: itemAmount * -1, // qty*avg_cost ,\n                                        exchangeAmount: itemXAmount, //,\n                                        type: nature,\n                                        typeAs: \"item\",\n                                    });\n                                }\n                            }\n                        } else {\n                            if (item.hasOwnProperty(\"costOfGoodsSoldAcc\")) {\n                                if (item.costOfGoodsSoldAcc.hasOwnProperty(\"id\")) {\n                                    let costOfGoodsSoldAcc = item.costOfGoodsSoldAcc;\n                                    this.jRaw.push({\n                                        id: costOfGoodsSoldAcc.id + \"-\" + nature,\n                                        line: new ItemLineModel(value),\n                                        description: this.purchase.journalNote,\n                                        account: item.costOfGoodsSoldAcc,\n                                        accountId: item.costOfGoodsSoldAcc.id,\n                                        amount: itemAmount, // qty*avg_cost ,\n                                        exchangeAmount: itemXAmount, //xAmount,\n                                        type: nature,\n                                        typeAs: \"item\",\n                                    });\n                                }\n                            }\n                        }\n                    } else if (item.type === \"Variant\") {\n                        const amountWithAddict = (itemAmount + (value.amountApplied || 0))\n                        window.console.log('additc', additc, '-', itemAmount)\n                        if (item.hasOwnProperty(\"inventoryAcc\")) {\n                            if (item.inventoryAcc.hasOwnProperty(\"id\")) {\n                                let inventoryAcc = item.inventoryAcc;\n                                this.jRaw.push({\n                                    id: inventoryAcc.id + \"-\" + nature,\n                                    line: new ItemLineModel(value),\n                                    description: this.purchase.journalNote,\n                                    account: item.inventoryAcc,\n                                    accountId: item.inventoryAcc.id,\n                                    amount: amountWithAddict, // qty*avg_cost ,\n                                    exchangeAmount: amountWithAddict * (this.purchase.txnRate || 1), //xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    } else if (item.type === \"Fixed Asset\") {\n                        if (item.hasOwnProperty(\"assetAcc\")) {\n                            if (item.assetAcc.hasOwnProperty(\"id\")) {\n                                let assetAcc = item.assetAcc;\n                                this.jRaw.push({\n                                    id: assetAcc.id + \"-\" + nature,\n                                    line: new ItemLineModel(value),\n                                    description: this.purchase.journalNote,\n                                    account: item.assetAcc,\n                                    accountId: item.assetAcc.id,\n                                    amount: itemAmount, // qty*avg_cost ,\n                                    exchangeAmount: itemXAmount, //xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    } else if (item.type === \"Transaction Item\") {\n                        if (item.hasOwnProperty(\"account\")) {\n                            if (item.account.hasOwnProperty(\"id\")) {\n                                this.jRaw.push({\n                                    id: item.account.id + \"-\" + nature,\n                                    line: new ItemLineModel(value),\n                                    description: this.purchase.journalNote,\n                                    account: item.account,\n                                    accountId: item.account.id,\n                                    amount: itemAmount, // qty*avg_cost ,\n                                    exchangeAmount: itemXAmount, //xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    }\n                }\n                //include Tax Amount\n                const amountNodiscount = kendo.parseFloat(value.cost) * kendo.parseFloat(value.qty) - discount;\n                const includeTaxAmount = amountNodiscount + vatTax + pltax + spTax + otherTax;\n                value[\"includeTaxAmount\"] = includeTaxAmount;\n                value[\"includeTaxExchangeAmount\"] = includeTaxAmount * kendo.parseFloat(this.purchase.txnRate);\n            });\n            //todo: WithholdingTax expense\n            this.withholdingExpense(whTaxAmount, this.purchase.txnRate || 1)\n\n            this.purchase.itemSubtotal = itemSubtotal;\n            this.purchase.inclusiveTaxAmount = inclusiveTax;\n            this.purchase.exchangeItemSubtotal = itemSubtotal * kendo.parseFloat(this.purchase.txnRate);\n\n            this.purchase.serviceSubtotal = serviceSubtotal;\n            this.purchase.exchangeServiceSubtotal =\n                serviceSubtotal * kendo.parseFloat(this.purchase.txnRate);\n            this.purchase.txnItmSubtotal = txnItmSubtotal;\n            this.purchase.exchangeTxnItmSubtotal =\n                txnItmSubtotal * kendo.parseFloat(this.purchase.txnRate);\n\n            this.purchase.itemDiscount = itemDiscount;\n            this.purchase.exchangeItemDiscount =\n                itemDiscount * kendo.parseFloat(this.purchase.txnRate);\n            this.purchase.serviceDiscount = serviceDiscount;\n            this.purchase.exchangeServiceDiscount =\n                serviceDiscount * kendo.parseFloat(this.purchase.txnRate);\n            this.purchase.txnItmDiscount = txnDiscount;\n            this.purchase.exchangeTxnItmDiscount =\n                txnDiscount * kendo.parseFloat(this.purchase.txnRate);\n\n            let total =\n                kendo.parseFloat(subTotal) -\n                kendo.parseFloat(discountTotal) +\n                kendo.parseFloat(totalTax);\n            this.purchase.subTotal = subTotal;\n            this.purchase.totalTaxAmount = kendo.parseFloat(totalTax);\n            this.purchase.discountTotal = kendo.parseFloat(discountTotal);\n            if (this.purchase.specificDiscountItem) {\n                discountInvoice = this.autoCalculateDiscount(\n                    this.purchase.specificDiscountItem,\n                    kendo.parseFloat(subTotal)\n                );\n                discountInvoice = discountInvoice ? discountInvoice : 0;\n            }\n            // this.onOtherChargeChange()\n            this.purchase.total = kendo.parseFloat(total) - discountInvoice + kendo.parseFloat(this.purchase.otherChargeAmount) //- parseFloat(withholdingTaxAmount);\n            this.purchase.withholdingTaxAmount = withholdingTaxAmount\n            // this.purchase.totalAfterWithholdingTax = kendo.parseFloat(this.purchase.total) - parseFloat(withholdingTaxAmount);\n            this.purchase.remainingAmount = kendo.parseFloat(this.purchase.total) - kendo.parseFloat(this.purchase.depositDeduction) - parseFloat(withholdingTaxAmount);\n            this.purchase.amountDue = kendo.parseFloat(this.purchase.total) - kendo.parseFloat(this.purchase.depositDeduction) - parseFloat(withholdingTaxAmount);\n            this.purchase.exchangeAmount =\n                kendo.parseFloat(this.purchase.amountDue) *\n                kendo.parseFloat(this.purchase.txnRate);\n            // window.console.log('Exchange Amount', this.purchase.exchangeAmount, this.purchase.amountDue)\n            this.autoCalculateTaxByType(taxList);\n            if (this.purchase.specificDiscountItem) {\n                const specificDiscount = this.purchase.specificDiscountItem || {};\n                if (specificDiscount.id) {\n                    discountItem.push(specificDiscount);\n                    discountLine.push({\n                        id: specificDiscount.id,\n                        name: specificDiscount.name,\n                        amount: this.purchase.specificDiscountTotal,\n                        exchangeAmount:\n                            this.purchase.specificDiscountTotal * this.purchase.txnRate,\n                    });\n                }\n            }\n            const uniqueDiscountItem = this.removeDuplicate(discountItem);\n            this.shrinkDiscountItem(uniqueDiscountItem, discountLine);\n            // window.console.log('discount ', this.customerDiscountItem)\n            // todo: raw Journal\n            const apAcc = this.purchase.apAcc || {};\n            if (this.purchase.amountDue * -1 > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            if (apAcc) {\n                if (apAcc.hasOwnProperty(\"id\")) {\n                    this.jRaw.push({\n                        id: apAcc.id + \"-\" + nature,\n                        line: new ItemLineModel({}),\n                        description: this.purchase.journalNote,\n                        account: apAcc,\n                        accountId: apAcc.id,\n                        exchangeAmount: this.purchase.exchangeAmount * -1,\n                        amount: this.purchase.amountDue * -1,\n                        type: nature,\n                        typeAs: \"ap\",\n                    });\n                }\n            }\n            const specificDisc = this.purchase.specificDiscountItem;\n            if (this.purchase.specificDiscountTotal * -1 > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            // window.console.log(specificDisc, 'specificDisc', this.purchase.specificDiscountTotal)\n            if (specificDisc) {\n                if (specificDisc.hasOwnProperty(\"account\")) {\n                    if (specificDisc.account) {\n                        if (specificDisc.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: specificDisc.account.id + \"-\" + nature,\n                                line: new ItemLineModel({}),\n                                description: \"Purchase Discount\",\n                                account: specificDisc.account,\n                                accountId: specificDisc.account.id,\n                                exchangeAmount:\n                                    kendo.parseFloat(this.purchase.specificDiscountTotal) *\n                                    kendo.parseFloat(this.purchase.txnRate) *\n                                    -1,\n                                amount: this.purchase.specificDiscountTotal * -1,\n                                type: nature,\n                                typeAs: \"discount\",\n                            });\n                        }\n                    }\n                }\n            }\n\n            if (this.purchase.depositDeduction * -1 > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            if (this.purchase.depositDeduction) {\n                if (this.purchase.depositDeduction > 0) {\n                    const purchaseDepositAcc = this.vendor.purchaseDepositAcc || {};\n                    if (purchaseDepositAcc) {\n                        if (purchaseDepositAcc.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: purchaseDepositAcc.id + \"-\" + nature,\n                                description: \"Purchase Deposit\",\n                                line: new ItemLineModel({}),\n                                account: purchaseDepositAcc,\n                                accountId: purchaseDepositAcc.id,\n                                exchangeAmount: this.purchase.exchangeDepositDeduction * -1,\n                                amount: this.purchase.depositDeduction * -1,\n                                type: nature,\n                                typeAs: \"deposit\",\n                            });\n                        }\n                    }\n                }\n            }\n            if (this.mOtherCharge.length > 0) {\n                let otherCharge = 0;\n                this.mOtherCharge.forEach((m) => {\n                    otherCharge = this.autoCalculateDiscount(m, this.purchase.subTotal);\n                    if (otherCharge > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (m) {\n                        if (m.hasOwnProperty(\"account\")) {\n                            if (m.account.hasOwnProperty(\"id\")) {\n                                const account = m.account;\n                                if (account) {\n                                    if (account.hasOwnProperty(\"id\")) {\n                                        this.jRaw.push({\n                                            id: account.id + \"-\" + nature,\n                                            line: new ItemLineModel({}),\n                                            description: \"Other Charge\",\n                                            account: account,\n                                            accountId: account.id,\n                                            exchangeAmount:\n                                                otherCharge * kendo.parseFloat(this.purchase.txnRate),\n                                            amount: otherCharge,\n                                            type: nature,\n                                            typeAs: \"otherCharge\",\n                                        });\n                                    }\n                                }\n                            }\n                        }\n                    }\n                });\n                // this.purchase.otherChargeAmount = otherCharge\n                window.console.log(this.mOtherCharge);\n            }\n            this.taxListDetail = taxListDetail\n            this.autoCalculateTaxDetail()\n            // todo: end raw Journal\n            // window.console.log(JSON.stringify(this.purchase), 'purchase')\n\n            await this.calculateAdditionalCost()\n            // todo: cook journal\n            this.shrinkData(this.jRaw);\n            // const unique = this.removeDuplicate(this.accounts)\n            // window.console.log(unique, 'unique')\n        },\n        withholdingExpense(amount, txnRate) {\n            // if (this.isItem()) {\n            if (amount > 0) {\n                const nature = 'dr'\n                const account = this.accWithholdingExpense || []\n                if (account.length > 0) {\n                    const iacc = account[0]\n                    this.jRaw.push({\n                        id: iacc.id + \"-\" + nature,\n                        line: new ItemLineModel({}),\n                        description: \"Withholding Tax Expense\",\n                        account: iacc,\n                        accountId: iacc.id,\n                        exchangeAmount: amount * txnRate,\n                        amount: amount,\n                        type: nature,\n                        typeAs: \"Withholding\",\n                    });\n                }\n            }\n            // }\n        },\n        shrinkData(obj) {\n            const uniques = this.removeDuplicate(\n                obj\n            ); /*[...new Set(accountId.map(i => {\n                return {\n                    id_: i.id_,\n                    id: i.id,\n                    type: i.type\n            }))]*/\n            uniques.forEach((n) => {\n                const found = obj.filter((m) => m.id === n.id);\n                let amount = 0;\n                found.forEach((z) => {\n                    amount += parseFloat(z.amount || 0);\n                });\n                n.amount = parseFloat(amount); //this.numberFormat(amount)\n                n.exchangeAmount = parseFloat(\n                    parseFloat(amount * parseFloat(this.purchase.txnRate))\n                ); //this.numberFormat(amount * parseFloat(this.purchase.txnRate)) //.toFixed(this.saleFormContent.decimal)\n            });\n            this.jRaw = uniques;\n            let dr = 0,\n                cr = 0;\n            this.jRaw.forEach((j) => {\n                switch (j.type) {\n                    case \"cr\":\n                        cr += parseFloat(j.exchangeAmount);\n                        break;\n                    case \"dr\":\n                        dr += parseFloat(j.exchangeAmount);\n                        break;\n                    default:\n                        break;\n                }\n            });\n            this.purchase.dr = dr;\n            this.purchase.cr = cr;\n            window.console.log(\"dr=\", dr, \"cr=\", cr, \"dr+cr = \", dr + cr);\n            window.console.log(JSON.stringify(uniques), 'uniques')\n        },\n        shrinkDiscountItem(discountItem, discountLine) {\n            let uniqueDiscountItems = [];\n            const unique = this.removeDuplicate(discountItem);\n            unique.forEach((m) => {\n                const found = discountLine.filter((n) => n.id === m.id);\n                let amount = 0,\n                    exchangeAmount = 0;\n                found.map((o) => {\n                    amount += o.amount;\n                });\n                found.map((o) => {\n                    exchangeAmount += o.exchangeAmount;\n                });\n                uniqueDiscountItems.push({\n                    id: m.id,\n                    name: m.name,\n                    amount: amount,\n                    exchangeAmount: exchangeAmount,\n                });\n            });\n            this.supplierDiscountItem = uniqueDiscountItems;\n            window.console.log(uniqueDiscountItems, \"uniqueDiscountItems\");\n        },\n        removeDuplicate(array) {\n            const result = [];\n            const map = new Map();\n            for (const item of array) {\n                if (!map.has(item.id)) {\n                    map.set(item.id, true); // set any value to Map\n                    result.push(item);\n                }\n            }\n            return result;\n        },\n        numberFormat(value) {\n            // window.console.log(this.saleFormContent.decimal,'nimol')\n            return kendo.toString(value, `n${this.purchaseFormContent.decimal}`);\n        },\n        autoCalculateDiscount(discountItem, subTotal) {\n            if (discountItem) {\n                const nature = discountItem.nature || ''\n                const amount = discountItem.amount || 0\n                if (nature === 'Amount') {\n                    return parseFloat(amount)\n                } else if (nature === 'Percentage') {\n                    return (subTotal * (parseFloat(amount) / 100))\n                } else {\n                    return 0\n                }\n            } else {\n                return 0\n            }\n        },\n        autoCalculateTax(tax, amount) {\n            if (tax) {\n                var formula = tax.formula;\n                var inAmt = kendo.parseFloat(amount);\n                var nAmt = kendo.parseFloat(amount);\n                var taxBase = kendo.parseFloat(tax.taxBase) / 100;\n                var rate = kendo.parseFloat(tax.rate) / 100;\n                var total = eval(formula);\n                window.console.log(inAmt, nAmt, taxBase, rate, formula, total);\n                return total;\n            }\n            // return 0\n        },\n        taxMapping(objTax, tax) {\n            const taxId = tax.id || ''\n            const tax_ = objTax.filter(t => t.id === taxId)[0]\n            return tax_ || {\n                id: '',\n                defaultTax: ''\n            }\n        },\n        dataSourceChanged(e) {\n            if (e.field) {\n                let dataRow = e.items[0],\n                    buom = {}, vTax = {},\n                    conversionRate = 1,\n                    wac = 0,\n                    qoh = 0,\n                    amount = 0,\n                    xAmount = 0;\n                switch (e.field) {\n                    case \"item\":\n                        // this.attribute_ = this.attributes.filter(m => m.type.id === dataRow.variant.id)\n                        dataRow.set(\"description\", dataRow.item.description);\n                        buom = dataRow.item.uom || {};\n                        dataRow.set(\"buom\", buom);\n                        // dataRow.set('uom', buom)\n                        // window.console.log(dataRow.item,'row')\n                        // await this.inventoryBalance(dataRow, dataRow.item.id)\n                        break;\n                    case \"cost\":\n                        try {\n                            amount = parseFloat(dataRow.cost) * parseFloat(dataRow.qty);\n                            xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                            dataRow.set(\"cost\", parseFloat(dataRow.cost));\n                            dataRow.set(\"amount\", amount);\n                            dataRow.set(\"exchangeAmount\", xAmount);\n                            // window.console.log('price',dataRow.price)\n                        } catch {\n                            dataRow.set(\"cost\", 0);\n                            dataRow.set(\"amount\", 0);\n                            dataRow.set(\"exchangeAmount\", 0);\n                        }\n                        break;\n                    case \"uom\":\n                        if (this.isPriceLevelChanged === false) {\n                            try {\n                                if (dataRow.uom) {\n                                    buom = dataRow.uom.buom || {};\n                                    qoh = dataRow.uom.qoh || 0;\n                                    conversionRate = dataRow.uom.conversionRate || 1;\n                                    wac = dataRow.uom.wac || 0;\n                                    dataRow.set(\"buom\", buom);\n                                    dataRow.set(\"wac\", wac);\n                                    dataRow.set(\"qoh\", qoh);\n                                    /* todo: mapping tax object */\n                                    vTax = this.taxMapping(this.tax, dataRow.uom.purchaseTax || {})\n\n                                    dataRow.set(\"vatTax\", vTax);\n                                    dataRow.set(\"conversionRate\", parseFloat(conversionRate));\n                                    if (dataRow.uom) {\n                                        amount =\n                                            parseFloat(dataRow.uom.cost) * parseFloat(dataRow.qty);\n                                        xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                                        dataRow.set(\"cost\", parseFloat(dataRow.uom.cost));\n                                        dataRow.set(\"amount\", amount);\n                                        dataRow.set(\"exchangeAmount\", xAmount);\n                                    } else {\n                                        amount = parseFloat(dataRow.cost) * parseFloat(dataRow.qty);\n                                        xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                                        dataRow.set(\"cost\", parseFloat(dataRow.cost));\n                                        dataRow.set(\"amount\", amount);\n                                        dataRow.set(\"exchangeAmount\", xAmount);\n                                    }\n                                }\n                            } catch (err) {\n                                window.console.log(\"error\", err);\n                                dataRow.set(\"buom\", {});\n                                dataRow.set(\"conversionRate\", 1);\n                                dataRow.set(\"cost\", 0);\n                                dataRow.set(\"qoh\", 0);\n                                dataRow.set(\"wac\", 0);\n                                dataRow.set(\"amount\", 0);\n                                dataRow.set(\"exchangeAmount\", 0);\n                            }\n                        }\n                        break;\n                    case \"qty\":\n                        try {\n                            amount = parseFloat(dataRow.cost) * parseFloat(dataRow.qty);\n                            xAmount = amount * parseFloat(this.purchase.txnRate);\n\n                            dataRow.set(\"cost\", parseFloat(dataRow.cost));\n                            dataRow.set(\"amount\", amount);\n                            dataRow.set(\"exchangeAmount\", xAmount);\n                        } catch {\n                            dataRow.set(\"cost\", 0);\n                            dataRow.set(\"amount\", 0);\n                            dataRow.set(\"exchangeAmount\", 0);\n                        }\n                        break;\n                    case \"otherTax\":\n                        // window.console.log(\"--\", dataRow)\n                        break;\n                    default:\n                        break;\n                }\n                if (e.field) {\n                    this.autoCalculate();\n                    window.console.log('dataRow', dataRow)\n                }\n            }\n        },\n        ServiceDateEditor(container, options) {\n            kendo\n                .jQuery('<input required name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDatePicker();\n\n            // let ds = this.$refs.itemLineDS.kendoWidget()\n            // window.console.log(ds.data())\n            // // const dateString = kendo.toString((new Date(options.model.items.serviceDate)), this.itemLine.dateFormat)\n            // // const dateString = kendo.toString(options.model.items.serviceDate)\n            // const $input = $(\"<input value=\" + options.model.serviceDate + \" />\").appendTo(container)\n            // $input.kendoDatePicker()\n            // // $input.appendTo(container)\n            // // options.model.items.serviceDate = dateString\n            // window.console.log($input)\n        },\n        ServiceDateToEditor(container, options) {\n            kendo\n                .jQuery('<input required name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDatePicker();\n        },\n        ItemDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Items </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: productVariantHandler.itemSearchURL('?reUsed=2'),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                        // data: this.variants\n                    }),\n                });\n        },\n        UOMDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"code\",\n                    dataValueField: \"uomConvertId\",\n                    cascadeFrom: \"item\",\n                    template: \"<span>#=code || ``#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: uomPriceHandler.uomPriceByPriceLevelURL(\n                                    \"id=\" +\n                                    options.model.item.id +\n                                    \"&plId=\" +\n                                    this.purchase.priceLevel.id +\n                                    \"&date=\" +\n                                    this.txnDate + \"&nature=purchase\"\n                                ),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    // name: {type: \"string\"},\n                                    // sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                        // data: this.variants\n                    }),\n                });\n        },\n        DiscountItemDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    cascadeFrom: \"item\",\n                    template: \"<span>#=code# - #=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: discountItemHandler.getURL(DISCOUNT_TYPE),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    // name: {type: \"string\"},\n                                    // sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        VatTaxDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"defaultTax\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=defaultTax#</span>\",\n                    optionLabel: \"--Select--\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.tax,\n                    }),\n                });\n        },\n        EmployeeDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoMultiSelect({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    suggest: true,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Employee </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: employeeHandler.searchURL(),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    firstName: {type: \"string\"},\n                                    lastName: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        rowNumberTmpl(dataItem) {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                index = ds.indexOf(dataItem);\n            return index + 1;\n        },\n        addRow() {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                total = ds.total();\n            this.itemLine.id = itemLinePrefix + uuid.v1();\n            this.itemLine.decimalFormat = \"n\" + this.purchaseFormContent.decimal;\n            this.itemLine.isEditable = true;\n            ds.insert(total, this.itemLine);\n\n            // kendo.jQuery().addClass('edit')\n            // this.itemLines.push(this.itemLine)\n            // window.console.log('item Line', this.itemLine)\n        },\n        onPaymentTermChanged() {\n            // this.onInvoiceDateChanged();\n            if (this.vendor) {\n                const paymentTerm = this.purchase.paymentTerm || {}\n                const netDue = paymentTerm.netDue || 0;\n                const someDate = new Date(this.purchase.transactionDate);\n                someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n                this.purchase.dueDate = someDate;\n                // window.console.log(\"im\", someDate, netDue);\n            }\n        },\n        async onInvoiceDateChanged() {\n            await this.loadPaymentTermList();\n            await this.loadCreditLimit();\n            await this.loadCustomerBalance(this.vendor.id);\n            await this.onPriceLevelChange();\n\n            this.monthOf = kendo.toString(new Date(this.txnDate), 'yyyy-MM')\n            // if (this.vendor) {\n            //     if (this.purchase.hasOwnProperty(\"paymentTerm\")) {\n            //         if (this.purchase.paymentTerm.hasOwnProperty(\"netDue\")) {\n            //             const netDue = this.purchase.paymentTerm.netDue;\n            //             const someDate = new Date(this.txnDate);\n            //             someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n            //             this.purchase.dueDate = someDate.toISOString().substr(0, 10);\n            //             // window.console.log('im', someDate, netDue)\n            //         }\n            //     }\n            // }\n            if (this.$route.params.id === undefined) {\n                this.generateNumber();\n            }\n            this.loadTransactionRate();\n        },\n        async loadPrefix() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    prefixHandler.get(\"purchase\").then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoading = false;\n                            this.purchaseTypes = res.data.data;\n                            if (this.purchaseTypes.length > 0) {\n                                this.purchase.transactionType = this.purchaseTypes[0];\n                                if (this.$route.params.id === undefined) {\n                                    this.generateNumber();\n                                }\n                            }\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadPriceLevel() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = '?&nature=' + NATURE\n                    priceLevelHandler.get(strFilter).then((res) => {\n                        this.priceLevel = res;\n                        if (this.priceLevel.length > 0) {\n                            this.purchase.priceLevel = this.priceLevel[0];\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadDiscountItem() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    discountItemHandler.list(DISCOUNT_TYPE).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.specificDiscountItem = res.data.data;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadOtherCharge() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    otherChargeHandler.list().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.otherChargeList = res.data.data;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadAccount() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    accountHandler.getAll().then((res) => {\n                        this.showLoading = false;\n                        //Receivable Account\n                        this.accPayable = res.data\n                            .filter((m) => m.account_type.number === 18)\n                            .map((itm) => {\n                                return {\n                                    id: itm.uuid,\n                                    uuid: itm.uuid,\n                                    name: itm.name,\n                                    local_name: itm.local_name,\n                                    number: itm.number,\n                                    is_taxable: itm.is_taxable,\n                                    banhjiAccCode: itm.banhjiAccCode,\n                                    group_code: itm.group_code,\n                                    parent_account: itm.parent_account,\n                                    type_code: itm.type_code,\n                                    account_type: itm.account_type,\n                                };\n                            });\n                        if (this.accPayable.length > 0) {\n                            this.purchase.apAcc = this.accPayable[0];\n                        }\n                        this.accWithholdingExpense = res.data\n                            .filter((m) => parseInt(m.banhjiAccCode) === 843000)\n                            .map((itm) => {\n                                return {\n                                    id: itm.uuid,\n                                    uuid: itm.uuid,\n                                    name: itm.name,\n                                    local_name: itm.local_name,\n                                    number: itm.number,\n                                    is_taxable: itm.is_taxable,\n                                    banhjiAccCode: itm.banhjiAccCode,\n                                    group_code: itm.group_code,\n                                    parent_account: itm.parent_account,\n                                    type_code: itm.type_code,\n                                    account_type: itm.account_type,\n                                };\n                            });\n                    });\n                }, 10);\n            });\n        },\n        async loadPaymentTerm() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = \"?type=pmt-supplier\";\n                    this.paymentTerms = []\n                    settingsHandler.getPaymentTerm(strFilter).then((res) => {\n                        this.showLoading = false;\n                        this.paymentTerms = res.data.data;\n                        if (this.paymentTerms.length > 0) {\n                            this.purchase.paymentTerm = this.paymentTerms[0];\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadLocation() {\n            this.locations = []\n            const roleType = dataStore.roleType || 0\n            window.console.log(' const roleType = dataStore.roleType || 0', dataStore)\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const location = roleData.filter(itm => itm.type === 'location')\n                    const locationDefault = location.filter(m => m.isDefault === 1)\n                    this.locations = location\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        if (locationDefault.length > 0) {\n                            this.purchase.location = locationDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.locations = [];\n                        locationHandler\n                            .list()\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.locations = res.data.data;\n                                } else {\n                                    this.showLoading = false;\n                                }\n                            })\n                    }, 10);\n                });\n            }\n\n        },\n        async loadProjectByCustomer() {\n            this.customerProjects = []\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const project = roleData.filter(itm => itm.type === 'project')\n                    this.customerProjects = project\n                    // project.forEach(k => {\n                    //     const customers = k.customers || []\n                    //     const proCustomer = customers.filter(n => n.customer.id === this.customer.id)\n                    //     if (proCustomer.length > 0) {\n                    //         this.customerProjects.push(k)\n                    //     }\n                    // })\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        const projectDefault = this.customerProjects.filter(m => m.isDefault === 1)\n                        if (projectDefault.length > 0) {\n                            this.purchase.project = projectDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        if (this.vendor) {\n                            // projectHandler.getBySupplier(this.vendor.id).then(res => {\n                            projectHandler\n                                .list()\n                                .then((res) => {\n                                    if (res.data.statusCode === 200) {\n                                        this.showLoading = false;\n                                        this.customerProjects = res.data.data;\n                                        // if (this.customerProjects.length > 0) {\n                                        //     this.purchase.project = this.customerProjects[0];\n                                        // }\n                                    } else {\n                                        this.showLoading = false;\n                                    }\n                                })\n                        }\n                    }, 10);\n                });\n            }\n        },\n        async loadCustomerBalance(id) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = id + \"?type=bal\";\n                    this.purchase.currentBalance = 0;\n                    billingHandler\n                        .balance(strFilter)\n                        .then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const data = res.data.data;\n                                if (data.length > 0) {\n                                    this.purchase.currentBalance = data[0].balance;\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        async loadCustomerDepositBalance(id) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = id + \"?type=dep\";\n                    this.purchase.depositAmount = 0;\n                    this.purchase.depositDeduction = 0;\n                    billingHandler\n                        .balance(strFilter)\n                        .then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const data = res.data.data;\n                                if (data.length > 0) {\n                                    const amountDeposit = data[0].balance;\n                                    window.console.log(amountDeposit, \"bala\");\n                                    this.purchase.depositAmount =\n                                        amountDeposit / this.purchase.txnRate;\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        creditLimitUsage(balance, creditLimit) {\n            return (\n                kendo.toString(\n                    (balance / creditLimit) * 100,\n                    `n${this.purchaseFormContent.decimal}`\n                ) + \" %\"\n            );\n        },\n        async loadEmployeeCenter() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.employees = [];\n                    employeeHandler\n                        .center(undefined)\n                        .then((res) => {\n                            this.showLoading = true;\n                            if (res.data.statusCode === 200) {\n                                this.showLoading = false;\n                                this.employees = res.data.data;\n                                if (this.employees.length > 0) {\n                                    this.purchase.employee = this.employees[0];\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        async loadSegment() {\n            this.segments = []\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const segment = roleData.filter(itm => itm.type === 'segment')\n                    const segmentDefault = segment.filter(m => m.isDefault === 1)\n                    this.segments = segment\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        if (segmentDefault.length > 0) {\n                            this.purchase.segment = segmentDefault[0];\n                            window.console.log('dataStore--segmentDefault', segmentDefault)\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.segments = [];\n                        settingsHandler\n                            .getSeg()\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.segments = res.data.data;\n                                }\n                            })\n                    }, 10);\n                });\n            }\n        },\n        async loadTax() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    settingHandler.get().then((res) => {\n                        const taxes = res;\n                        this.tax = taxes.filter(\n                            (m) =>\n                                (m.taxType.typeId === 1 ||\n                                    m.taxType.typeId === 10 ||\n                                    m.taxType.typeId === 2) &&\n                                m.transactionType === \"Purchase\"\n                        ); // valuable tax\n                    });\n                }, 10);\n            });\n        },\n        async onSaveClose(saveSend) {\n            if (!this.$refs.form.validate()) {\n                this.$refs.form.validate();\n                return;\n            }\n            if (this.transactionRate === 0) {\n                this.$snotify.error(i18n.t(\"set_exchange_rate\"));\n                return;\n            }\n\n            let id = \"\";\n            if (this.vendor.hasOwnProperty(\"id\")) {\n                id = this.vendor.id || \"\";\n            }\n            if (id === \"\") {\n                this.$snotify.error(\"vendor is required\");\n                return;\n            }\n            if (this.purchase.billNo == \"\") {\n                this.$snotify.error(\"Vendor Invoice No is required\");\n                return;\n            }\n            if (!this.$refs.form.validate()) {\n                this.$refs.form.validate();\n                return;\n            }\n            let ds = this.$refs.itemLineDS.kendoWidget();\n            let d1 = ds.data();\n            let dataValidate = 0;\n            await this.autoCalculate();\n            d1.forEach((value, index) => {\n                if (\n                    value.item == undefined ||\n                    value.item.id == undefined ||\n                    value.item.id == null ||\n                    value.uom == undefined ||\n                    value.uom.uom.id == undefined ||\n                    value.uom.uom.id == null\n                ) {\n                    this.$snotify.error(\n                        \"Please check Item or UOM  on row \" + (index + 1)\n                    );\n                } else {\n                    dataValidate += 1;\n                }\n            });\n            if (d1.length == dataValidate) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        let isAutoGenerate = 1;\n                        if (this.$route.params.id) {\n                            const tranDate = new Date(this.txnDate);\n                            const tranDateInvoice = new Date(this.purchase.transactionDate);\n                            const tranDateM = tranDate.getFullYear() + tranDate.getMonth();\n                            const tranDateInvoiceM =\n                                tranDateInvoice.getFullYear() + tranDateInvoice.getMonth();\n                            if (tranDateM === tranDateInvoiceM) {\n                                isAutoGenerate = 0;\n                            }\n                        }\n\n                        let itemLineDS = this.$refs.itemLineDS.kendoWidget();\n                        const dataRow = itemLineDS\n                            .data()\n                            .filter((o) => o.amount > 0)\n                            .map((n) => {\n                                return new ItemLineModel(n);\n                            });\n                        if (dataRow.length > 0) {\n                            let data = {\n                                id: this.purchase.id ? this.purchase.id : \"\",\n                                uuid: this.purchase.uuid ? this.purchase.uuid : \"\",\n                                journal_uuid: this.purchase.journal_uuid\n                                    ? this.purchase.journal_uuid\n                                    : \"\",\n                                jRaw: this.jRaw,\n                                type: TRANSACTION_TYPE,\n                                number: this.purchase.number,\n                                abbr: this.purchase.transactionType.abbr,\n                                transactionDate: this.txnDate,\n                                transactionDateTZ: Helper.toISODate(this.txnDate),\n                                dueDate: this.purchase.dueDate,\n                                monthOf: this.monthOf,\n                                paymentCode: this.purchase.paymentCode,\n                                billNo: this.purchase.billNo,\n                                billDate: this.billDate,\n                                supplier: this.purchase.supplier,\n                                transactionType: this.purchase.transactionType,\n                                paymentTerm: this.purchase.paymentTerm,\n                                discountPromotion: {},\n                                apAcc: this.purchase.apAcc,\n                                currency: this.purchase.currency,\n                                txnRate: this.purchase.txnRate,\n                                rate: 1,\n                                exchangeRate: this.purchase.exchangeRate,\n                                exchangeAmount: this.purchase.exchangeAmount,\n                                priceLevel: this.purchase.priceLevel,\n                                itemLines: dataRow,\n                                segment: this.purchase.segment,\n                                location: this.purchase.location,\n                                project: this.purchase.project,\n                                employee: this.purchase.employee,\n                                billingAddress: this.purchase.billingAddress,\n                                deliveryAddress: this.purchase.deliveryAddress,\n                                deliveryDateTime: this.purchase.deliveryDateTime,\n                                transactionNote: this.purchase.transactionNote,\n                                journalNote: this.purchase.journalNote,\n                                subTotal: this.purchase.subTotal,\n                                total: this.purchase.total,\n                                discountTotal: this.purchase.discountTotal,\n                                exchangeDiscountTotal: (this.purchase.discountTotal) * (this.purchase.txnRate || 1),\n                                specificDiscountTotal: this.purchase.specificDiscountTotal,\n                                deliveryFee: this.purchase.deliveryFee,\n                                totalTaxAmount: this.purchase.totalTaxAmount,\n                                depositAmount: this.purchase.depositAmount,\n                                depositDeduction: this.purchase.depositDeduction,\n                                remainingAmount: this.purchase.remainingAmount,\n                                amountDue: this.purchase.amountDue,\n                                currentBalance: this.purchase.currentBalance,\n                                balance: this.purchase.balance,\n                                creditLimit: this.purchase.creditLimit,\n                                saveOption: this.purchase.saveOption,\n                                status: 1,\n                                approvedBy: this.purchase.approvedBy,\n                                formTemplate: {},\n                                specificDiscountItem: this.purchase.specificDiscountItem,\n                                otherCharge: this.mOtherCharge,\n                                otherChargeAmount: this.purchase.otherChargeAmount,\n                                taxListTotal: this.taxListTotal,\n                                supplierDiscountItem: this.supplierDiscountItem,\n                                createdAt: this.purchase.createdAt,\n                                itemSubtotal: this.purchase.itemSubtotal,\n                                exchangeItemSubtotal: this.purchase.exchangeItemSubtotal,\n                                serviceSubtotal: this.purchase.serviceSubtotal,\n                                exchangeServiceSubtotal: this.purchase.exchangeServiceSubtotal,\n                                txnItmSubtotal: this.purchase.txnItmSubtotal,\n                                exchangeTxnItmSubtotal: this.purchase.exchangeTxnItmSubtotal,\n                                itemDiscount: this.purchase.itemDiscount,\n                                exchangeItemDiscount: this.purchase.exchangeItemDiscount,\n                                serviceDiscount: this.purchase.serviceDiscount,\n                                exchangeServiceDiscount: this.purchase.exchangeServiceDiscount,\n                                txnItmDiscount: this.purchase.txnItmDiscount,\n                                exchangeTxnItmDiscount: this.purchase.exchangeTxnItmDiscount,\n                                withholdingTaxAmount: this.purchase.withholdingTaxAmount || 0,\n                                inclusiveTaxAmount: this.purchase.inclusiveTaxAmount || 0,\n                                loggedUser: this.loggedUser,\n                                saveSend: saveSend,\n                                refFrom: this.purchase.refFrom || [],\n                                refTo: this.purchase.refTo || [],\n                                saleTaxDetail: this.purchase.saleTaxDetail || [],\n                                hasAdditionalCost: this.purchase.additionalCost.length > 0,\n                                additionalCost: this.purchase.additionalCost || [],\n                                additionalCostMethod: this.purchase.additionalCostMethod || '',\n                                additionalCostTotal: this.additionalCostTotal || 0,\n                                isAutoGenerate: isAutoGenerate,\n                                actionType: this.$route.params.id\n                                    ? this.$route.query.type\n                                    : \"new\",\n                            };\n                            if (this.$route.query.type === \"recurring\") {\n                                data.id = \"\";\n                            }\n                            this.showLoading = true;\n                            billingHandler.createPurchase(data).then((response) => {\n                                if (response.data.statusCode === 201) {\n                                    // this.close(response.data.data)\n                                    // this.$refs.form.reset()\n                                    this.showLoading = false;\n                                    this.$snotify.success(\"Successfully\");\n                                    if (saveSend === true) {\n                                        this.clear()\n                                    } else {\n                                        this.close(response.data.data);\n                                    }\n                                }\n                            }).catch((e) => {\n                                this.showLoading = false;\n                                this.$snotify.error(\"Something went wrong\");\n                                this.errors.push(e);\n                            });\n                        }\n                    }, 50);\n                });\n            }\n        },\n        async loadPurchaseFormContent() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    purchaseFormContentHandler.list().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            const data = res.data.data;\n                            if (data.length > 0) {\n                                this.purchaseFormContent = data[0];\n                                this.decimalFormat = \"n\" + this.purchaseFormContent.decimal;\n                                this.initData();\n                            }\n                        }\n                    });\n                }, 50);\n            });\n        },\n        close(data) {\n            if (this.$route.params.id === undefined) {\n                this.$router.push({\n                    name: \"Vendors\",\n                    params: {\n                        data: data,\n                    },\n                });\n            } else {\n                window.history.go(-1);\n                // this.$router.push({\n                //     path: \"invoice_view\",\n                //     name: \"Invoice View\",\n                //     params: {\n                //         data: data,\n                //     }\n                // })\n            }\n            // window.console.log(data, 'data')\n        },\n        saveNew() {\n        },\n        removeRow(e) {\n            e.preventDefault();\n            const grid = kendo.jQuery(\"#gridItemLine\").data(\"kendoGrid\"),\n                dataSource = grid.dataSource,\n                dataItem = grid.dataItem($(e.currentTarget).closest(\"tr\"));\n\n            if (dataSource.total() > 1) {\n                dataSource.remove(dataItem);\n                this.autoCalculate();\n            }\n        },\n        generateNumber() {\n            if (this.$route.params.id) {\n                const tranDate = new Date(this.txnDate);\n                const tranDateInvoice = new Date(this.purchase.transactionDate);\n                const tranDateM = tranDate.getFullYear() + tranDate.getMonth();\n                const tranDateInvoiceM =\n                    tranDateInvoice.getFullYear() + tranDateInvoice.getMonth();\n                if (tranDateM === tranDateInvoiceM) {\n                    this.purchase.referenceNo = this.referenceNo;\n                    return;\n                }\n            }\n\n            if (this.txnDate !== \"\" && this.purchaseTypes.length > 0) {\n                let data = {\n                    abbr: this.purchase.transactionType.abbr,\n                    structure: this.purchase.transactionType.structure,\n                    transactionDate: this.txnDate,\n                    sequcencing: this.purchase.transactionType.sequcencing,\n                    prefixSeparator: this.purchase.transactionType.prefixSeparator || '',\n                    numberSeparator: this.purchase.transactionType.numberSeparator || '',\n                    format: this.purchase.transactionType.format || 5,\n                    type: \"Purchase\",\n                    entity: 1,\n                };\n                billingHandler\n                    .lastNumber(data)\n                    .then((response) => {\n                        if (response.data.statusCode === 200) {\n                            const res = response.data.data;\n                            const lastNumber = this.zeroPad(\n                                parseInt(res.lastNumber),\n                                this.purchase.transactionType.format\n                            );\n                            const number =\n                                res.suffix +\n                                this.purchase.transactionType.numberSeparator +\n                                lastNumber;\n                            this.purchase.number = number;\n                        }\n                    })\n                    .catch((e) => {\n                        this.errors.push(e);\n                    });\n            }\n        },\n        zeroPad(num, places) {\n            return String(num).padStart(places, \"0\");\n        },\n        suffix(transactionDate) {\n            return kendo.toString(new Date(transactionDate), `yymm`);\n        },\n        errorMessage() {\n        },\n        accountDropDownEditor() {\n        },\n        cancel() {\n            this.$swal({\n                title: i18n.t(\"msg_title_warning\"),\n                text: i18n.t(\"msg_discard\"),\n                icon: \"warning\",\n                showCancelButton: true,\n                cancelButtonText: i18n.t(\"cancel\"),\n                confirmButtonColor: \"#4d4848\",\n                cancelButtonColor: \"#ED1A3A\",\n                confirmButtonText: i18n.t(\"discard\"),\n            }).then((resultCen) => {\n                window.console.log(resultCen);\n                if (resultCen.value) {\n                    this.$destroy()\n                    this.$router.go(-1);\n                }\n            });\n        },\n        hideSmallSidebar() {\n            this.isHideBar = !this.isHideBar;\n        },\n        requestData(skip, filter, baseUrl) {\n            const url = baseUrl + `?filter=${filter}`;\n            this.requestStarted = true;\n            fetch(url)\n                .then((response) => {\n                    return response.json();\n                })\n                .then(this.afterFetch);\n        },\n        requestData_(skip, filter, baseUrl) {\n            const url = baseUrl + `/${filter}`;\n            this.requestStarted = true;\n            fetch(url)\n                .then((response) => {\n                    return response.json();\n                })\n                .then(this.afterFetch_);\n        },\n        onChange(event) {\n            const value = event.value;\n            if (value && value[textField] === emptyItem[textField]) {\n                return;\n            }\n            this.vendor = value;\n            this.purchase.supplier = value;\n            // window.console.log(this.purchase.customer, 'Changed')\n            // this.invoice = value\n            this.purchase.apAcc = value.hasOwnProperty(\"apAcc\") ? value.apAcc : {};\n            this.purchase.paymentTerm = value.paymentTerm || {};\n            this.purchase.priceLevel = value.priceLevel || {};\n            const baseCurrency = value.baseCurrency || {};\n            if (baseCurrency.hasOwnProperty(\"code\")) {\n                this.baseCurrencyCode = \" \" + baseCurrency.code;\n            }\n            // this.loadTransactionRate();\n            this.billingAddress = value.hasOwnProperty(\"billingAddress\")\n                ? value.billingAddress\n                : [];\n            this.deliveryAddress = value.hasOwnProperty(\"deliveryAddress\")\n                ? value.deliveryAddress\n                : [];\n            if (this.billingAddress.length > 0) {\n                this.purchase.billingAddress = this.billingAddress[0];\n            }\n            if (this.deliveryAddress.length > 0) {\n                this.purchase.deliveryAddress = this.deliveryAddress[0];\n            }\n            this.expenses = []\n            this.onInvoiceDateChanged();\n            this.loadProjectByCustomer()\n            // this.loadCustomerBalance(this.vendor.id);\n            // const creditLimit = value.hasOwnProperty(\"creditLimit\")\n            //     ? value.creditLimit\n            //     : 0;\n            // this.purchase.creditLimit = kendo.parseFloat(creditLimit);\n            // window.console.log(value, 'value')\n        },\n        onEmployeeChanged(event) {\n            const value = event.value;\n            if (value && value[textField] === emptyItem[textField]) {\n                return;\n            }\n            this.mEmployee = value;\n            this.purchase.employee = value;\n        },\n        afterFetch(json) {\n            this.vendorList = json.data;\n        },\n        afterFetch_(json) {\n            this.employees = json.data;\n        },\n        onFilterChange(event) {\n            const filter = event.filter.value;\n            this.requestData(0, filter, this.cusBaseUrl);\n            this.filter = filter;\n        },\n        onEmployeeFilterChanged(event) {\n            const filter = event.filter.value;\n            this.requestData_(0, filter, this.empBaseUrl);\n            this.filter_ = filter;\n        },\n        async initData() {\n            if (this.$route.params.id !== undefined) {\n                await this.loadViewCreditPurchase();\n            } else {\n                this.clear()\n                // this.addRow();\n            }\n        },\n        async loadViewCreditPurchase() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.showLoading = true;\n                    if (this.$route.params.id) {\n                        billingHandler\n                            .viewPurchase(this.$route.params.id)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.purchase = res.data.data[0];\n                                    this.referenceNo = this.purchase.referenceNo;\n                                    this.txnDate = new Date(this.purchase.transactionDate);\n                                    this.vendor = this.purchase.supplier;\n                                    this.mEmployee = this.purchase.employee;\n                                    this.taxListTotal = this.purchase.taxListTotal;\n                                    this.itemLines = this.purchase.itemLines;\n                                    this.mOtherCharge = this.purchase.otherCharge;\n                                    this.supplierDiscountItem = this.purchase.supplierDiscountItem || []\n                                    this.jRaw = this.purchase.jRaw || [];\n                                    this.expenses = this.purchase.additionalCost || [];\n                                    this.additionalCostTotal = this.purchase.additionalCostTotal || 0;\n                                    this.purchaseOrders = this.purchase.refFrom || [];\n                                    this.monthOf = kendo.toString(\n                                        new Date(this.purchase.monthOf),\n                                        \"yyyy-MM\"\n                                    );\n                                    for (let i = 0; i < this.mOtherCharge.length - 1; i++) {\n                                        this.addSelect();\n                                    }\n                                    const priceLevel = this.purchase.priceLevel || {}\n                                    const currency = priceLevel.currency || {}\n                                    const curCode = currency.code || ''\n                                    this.currencyCode = curCode;\n                                    // this.loadProjectByCustomer()\n                                    if (this.vendor) {\n                                        if (this.vendor.hasOwnProperty(\"id\")) {\n                                            this.loadCustomerBalance(this.vendor.id);\n                                        }\n                                    }\n                                    if (this.$route.query.type === \"recurring\") {\n                                        if (this.$route.params.hasOwnProperty(\"transactionDate\")) {\n                                            window.console.log(\"type\", this.$route.params);\n                                            this.purchase.transactionDate = new Date(\n                                                this.$route.params.transactionDate\n                                            );\n                                            this.txnDate = new Date(\n                                                this.$route.params.transactionDate\n                                            );\n                                            this.onInvoiceDateChanged();\n                                            this.generateNumber();\n                                        }\n                                    }\n                                }\n                            })\n                            .catch();\n                        {\n                            this.showLoading = false;\n                        }\n                    }\n                }, 10);\n            });\n        },\n        clear() {\n            // this.loadAccount()\n            this.loadPriceLevel()\n            let ds = this.$refs.itemLineDS.kendoWidget();\n            ds.data([]);\n            this.id = undefined;\n            this.vendor = {}\n            this.mEmployee = {}\n            this.mOtherCharge = {}\n            this.purchaseOrders = []\n            this.purchase = new PurchaseModel({});\n            this.purchase.transactionType = this.purchaseTypes[0];\n            this.monthOf = kendo.toString(new Date(this.purchase.transactionDate), 'yyyy-MM')\n            this.addRow();\n            this.generateNumber();\n            this.loadSegment();\n            this.loadLocation();\n        },\n        async loadTransactionRate() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const date = new Date(this.txnDate).toISOString().substr(0, 10);\n                    const priceLevel = this.purchase.priceLevel;\n                    let code = \"\";\n                    if (priceLevel.hasOwnProperty(\"currency\")) {\n                        if (priceLevel.currency.hasOwnProperty(\"code\")) {\n                            code = priceLevel.currency.code;\n                        }\n                    }\n                    if (code !== undefined || code !== \"\") {\n                        this.showLoading = true;\n                        currencyHandler\n                            .getLastExchangeRateByDate(date, code)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.exchangeRate = res.data.data[0];\n                                    this.currencyCode = this.exchangeRate.code || \"\";\n                                    this.transactionRate = this.exchangeRate.rate || 0;\n                                    this.purchase.txnRate = this.exchangeRate.rate || 0;\n                                    this.purchase.exchangeRate = this.exchangeRate || {};\n                                    if (this.transactionRate === 0) {\n                                        this.$snotify.error(i18n.t(\"set_exchange_rate\"));\n                                        return;\n                                    }\n                                    this.showLoading = false;\n                                    this.loadCustomerDepositBalance(this.vendor.id);\n                                }\n                            });\n                    }\n                    this.loadPurchaseOrder();\n                }, 10);\n            });\n        },\n        reload() {\n            if (this.$route.params.id !== undefined) {\n                this.loadViewCreditPurchase()\n            } else {\n                this.clear()\n            }\n        },\n        async loadPurchaseOrder() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    let segmentId = \"\",\n                        locationId = '',\n                        priceLevelId = \"\",\n                        customerId = \"\",\n                        txnDate = \"\";\n                    if (this.purchase.segment) {\n                        segmentId = this.purchase.segment.id;\n                    }\n                    if (this.purchase.location) {\n                        locationId = this.purchase.location.id;\n                    }\n                    if (this.purchase.supplier) {\n                        customerId = this.purchase.supplier.id;\n                    }\n                    if (this.purchase.priceLevel) {\n                        priceLevelId = this.purchase.priceLevel.id;\n                    }\n                    if (this.purchase.transactionDate) {\n                        txnDate = this.purchase.transactionDate;\n                    }\n                    let strFilter = \"\";\n                    if (\n                        segmentId !== \"\" &&\n                        customerId !== \"\" &&\n                        locationId !== \"\" &&\n                        priceLevelId !== \"\" &&\n                        txnDate !== \"\"\n                    ) {\n                        strFilter =\n                            \"?id=\" +\n                            customerId +\n                            \"&segId=\" +\n                            segmentId +\n                            \"&locId=\" +\n                            locationId +\n                            \"&plId=\" +\n                            priceLevelId +\n                            \"&date=\" +\n                            txnDate + '&type=Purchase Order'\n                    }\n                    if (strFilter !== \"\") {\n                        this.purchase.refFrom = []\n                        this.showLoadingTxn = true\n                        saleOrderHandler\n                            .transactionFilter(strFilter)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoadingTxn = false\n                                    this.purchaseOrders = res.data.data;\n                                } else {\n                                    this.showLoadingTxn = false\n                                }\n                            })\n                    }\n                }, 10);\n            });\n            await this.getExpenseBySupplier()\n        },\n        addPurchaseOrder(item) {\n            if (item) {\n                const itemLine = item.itemLines || [];\n                this.refFrom.push({\n                    id: item.id || '',\n                    reference: item.referenceNo || ''\n                })\n                let ds = this.$refs.itemLineDS.kendoWidget(),\n                    total = ds.total();\n                itemLine.forEach((o) => {\n                    this.itemLine = new ItemLineModel(o);\n                    this.itemLine.id = itemLinePrefix + uuid.v1();\n                    this.itemLine.decimalFormat = \"n\" + this.purchaseFormContent.decimal;\n                    this.itemLine.sourceTransaction = {\n                        id: item.id,\n                        referenceNo: item.referenceNo,\n                    };\n                    this.itemLine.sourceTransactionRef = item.referenceNo;\n                    ds.insert(total, this.itemLine);\n                });\n                this.itemLine = new ItemLineModel({});\n                this.autoCalculate();\n                const index = this.purchaseOrders.findIndex((itm) => {\n                    return item.id === itm.id;\n                });\n                this.purchaseOrders.splice(index, 1);\n                this.purchase.refFrom = this.removeDuplicate(this.refFrom)\n            }\n        },\n        totalQty() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            let qty = 0\n            ds.data().filter(n => n.amount > 0).forEach(m => {\n                const itm = m.item || {}\n                const uom = m.uom || {}\n                if (itm.id && uom.uom && itm.type === 'Variant') {\n                    qty += (m.qty || 0) * (m.conversionRate || 1)\n                }\n            })\n            window.console.log('qty', qty)\n            return qty\n        },\n        excludeVATTaxInclusive(tax, amount, incTax) {\n            if (tax) {\n                const baseAmount = tax.baseAmount || '';\n                const taxType = tax.taxType || {}\n                const taxTypeId = taxType.typeId || 0\n                if (baseAmount) {\n                    if (baseAmount.toLowerCase() === \"inclusive\" && taxTypeId === 1) {\n                        return amount - incTax\n                    }\n                }\n            }\n            return amount\n        },\n        totalAmount() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            let amount = 0\n            ds.data().filter(n => n.amount > 0).forEach(m => {\n                const itm = m.item || {}\n                const uom = m.uom || {}\n                let incluTax = 0\n                if (itm.id && uom.uom && itm.type === 'Variant') {\n                    const tax = m.vatTax || {}\n                    const amount_ = m.amount || 0\n                    const baseAmount = tax.baseAmount || '';\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            incluTax = this.autoCalculateTax(tax, amount_);\n                        }\n                    }\n                    amount += (amount_ - (incluTax || 0))\n                }\n            })\n            window.console.log('amount x-', amount)\n            return amount\n        },\n        percentageApplied() {\n            try {\n                const tAmount = this.totalAmount()\n                let ds = this.$refs.itemLineDS.kendoWidget()\n                ds.data().filter(n => n.amount > 0).forEach(m => {\n                    const itm = m.item || {}\n                    const uom = m.uom || {}\n                    let incluTax = 0\n                    if (itm.id && uom.uom && itm.type === 'Variant') {\n                        const tax = m.vatTax || {}\n                        const amount = m.amount || 0\n                        const baseAmount = tax.baseAmount || '';\n                        if (baseAmount) {\n                            if (baseAmount.toLowerCase() === \"inclusive\") {\n                                incluTax = this.autoCalculateTax(tax, amount);\n                            }\n                        }\n                        const amountAfterTax = amount - (incluTax || 0)\n                        const pAmount = amountAfterTax / tAmount\n                        m['percentageApplied'] = pAmount\n                    }\n                })\n                window.console.log('Qty Based--', ds.data())\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        amountApplied() {\n            try {\n                let ds = this.$refs.itemLineDS.kendoWidget()\n                const adc = this.additionalCostTotal || 0\n                ds.data().filter(n => n.amount > 0).forEach(m => {\n                    const itm = m.item || {}\n                    const uom = m.uom || {}\n                    window.console.log('amountApplied==', uom.uom, '---', itm.type)\n                    if (itm.id && uom.uom && itm.type === 'Variant') {\n                        const percentageApplied = m.percentageApplied || 0\n                        window.console.log('percentageApplied--', adc, '---', (percentageApplied * adc))\n                        m['amountApplied'] = percentageApplied * adc\n                    }\n\n                })\n                window.console.log('AMount Based--', ds.data())\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        amountAppliedQtyBased() {\n            try {\n                let ds = this.$refs.itemLineDS.kendoWidget()\n                ds.data().filter(n => n.amount > 0).forEach(m => {\n                    const itm = m.item || {}\n                    const uom = m.uom || {}\n                    if (itm.id && uom.uom && itm.type === 'Variant') {\n                        const addc = m.additionalCost || 0\n                        const qty = (m.qty || 1) * (m.conversionRate || 1)\n                        m['amountApplied'] = addc * qty\n                    }\n                })\n                window.console.log('amountAppliedQtyBased Based--', ds.data())\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        async calculateAdditionalCost() {\n            try {\n                // todo: additional Cost\n                if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    this.percentageApplied()\n                } else {\n                    this.percentageApplied()\n                    this.amountApplied()\n                }\n                if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    const tQty = this.totalQty()\n                    const addc = this.additionalCostTotal || 0\n                    let ds = this.$refs.itemLineDS.kendoWidget()\n                    ds.data().filter(n => n.amount > 0).forEach(m => {\n                        const itm = m.item || {}\n                        const uom = m.uom || {}\n                        if (itm.id && uom.uom && itm.type === 'Variant') {\n                            m['additionalCost'] = addc / tQty\n                        }\n                    })\n                    window.console.log('qty based', ds.data())\n                } else {\n                    let ds = this.$refs.itemLineDS.kendoWidget()\n                    ds.data().filter(n => n.amount > 0).forEach(m => {\n                        const itm = m.item || {}\n                        const uom = m.uom || {}\n                        if (itm.id && uom.uom && itm.type === 'Variant') {\n                            const amountApplied = m.amountApplied || 0\n                            const qty = (m.qty || 0) * (m.conversionRate || 1)\n                            m['additionalCost'] = amountApplied / qty\n                        }\n                    })\n                }\n                if (this.purchase.additionalCostMethod === 'Qty Based') {\n                    this.amountAppliedQtyBased()\n                }\n                await this.clearingAccount()\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        autoCalculateTaxDetail() {\n            let ids = []\n            this.taxListDetail.forEach(n => {\n                ids.push(n.id || '')\n            })\n            const unique = [...new Set(ids)]\n            let result = []\n            unique.forEach(m => {\n                let amount = 0, row = {}, discount = 0, xDiscount = 0, xAmount = 0, taxAmount = 0, xTaxAmount = 0\n                let taxDetail = [], isVat = 0\n                const found = this.taxListDetail.filter(n => n.id === m)\n                // window.console.log('taxListDetailids', found)\n                found.forEach(k => {\n                    row = k\n                    if (k.isVat === 1) {\n                        isVat = 1\n                        const detail_ = k.detail || {}\n                        taxDetail.push(detail_)\n\n                    }\n                    taxAmount += k.taxAmount_ || 0\n                    xTaxAmount += (k.taxAmount_ || 0) * (k.txnRate || 1)\n                    amount += (k.amount || 0)\n                    xAmount += (k.amount || 0) * (k.txnRate || 1)\n                    discount += (k.discount || 0)\n                    xDiscount += (k.discount || 0) * (k.txnRate || 1)\n                })\n                let spTaxAmt = 0, spXTaxAmt = 0, plTaxAmt = 0, plXTaxAmt = 0, otTaxAmt = 0, otXTaxAmt = 0,\n                    spTaxName = '', plTaxName = '', otTaxName = '',\n                    spTaxNameLocale = '', plTaxNameLocale = '', otTaxNameLocale = '',\n                    spAccId = '', plAccId = '', otAccId = '',\n                    spRate = '', plRate = '', otRate = ''\n                taxDetail.forEach(n => {\n                    const spTax = n.specificTax || {}\n                    const plTax = n.publicLightingTax || {}\n                    const otherTax = n.otherTax || {}\n                    if (Object.keys(spTax).length > 0) {\n                        spTaxAmt += (spTax.taxAmount_ || 0)\n                        spXTaxAmt += ((spTax.taxAmount_ || 0) * (spTax.taxRate || 1))\n                        spTaxName = spTax.defaultTax || ''\n                        spTaxNameLocale = spTax.defaultTaxLocale || ''\n                        spAccId = spTax.account ? spTax.account.id : ''\n                        spRate = spTax.rate || 1\n                    }\n                    if (Object.keys(plTax).length > 0) {\n                        plTaxAmt += (plTax.taxAmount_ || 0)\n                        plXTaxAmt += ((plTax.taxAmount_ || 0) * (plTax.taxRate || 1))\n                        plTaxName = plTax.defaultTax || ''\n                        plTaxNameLocale = plTax.defaultTaxLocale || ''\n                        plAccId = plTax.account ? plTax.account.id : ''\n                        plRate = plTax.rate || 1\n                    }\n                    if (Object.keys(otherTax).length > 0) {\n                        otTaxAmt += (otherTax.taxAmount_ || 0)\n                        otXTaxAmt += ((otherTax.taxAmount_ || 0) * (plTax.taxRate || 1))\n                        otTaxName = otherTax.defaultTax || ''\n                        otTaxNameLocale = otherTax.defaultTaxLocale || ''\n                        otAccId = otherTax.account ? otherTax.account.id : ''\n                        otRate = otherTax.rate || 1\n                    }\n                })\n                if (isVat === 1) {\n                    row.detail = {\n                        specificTax: {\n                            name: spTaxName,\n                            nameLocale: spTaxNameLocale,\n                            amount: spTaxAmt,\n                            exchangeAmount: spXTaxAmt,\n                            accountId: spAccId,\n                            rate: spRate,\n                        },\n                        publicLightingTax: {\n                            name: plTaxName,\n                            nameLocale: plTaxNameLocale,\n                            amount: plTaxAmt,\n                            exchangeAmount: plXTaxAmt,\n                            accountId: plAccId,\n                            rate: plRate,\n                        },\n                        otherTax: {\n                            name: otTaxName,\n                            nameLocale: otTaxNameLocale,\n                            amount: otTaxAmt,\n                            exchangeAmount: otXTaxAmt,\n                            accountId: otAccId,\n                            rate: otRate,\n                        }\n                    }\n                } else {\n                    row.detail = {}\n                }\n\n                row['amount'] = amount\n                row['exchangeAmount'] = xAmount\n                row['taxAmount'] = taxAmount\n                row['exchangeTaxAmount'] = xTaxAmount\n                row['discount'] = discount\n                row['exchangeDiscount'] = xDiscount\n                row['currency'] = this.purchase.exchangeRate || {}\n                result.push(row)\n                taxDetail = []\n            })\n            this.purchase.saleTaxDetail = result\n            window.console.log('saleTaxDetail', result)\n        },\n        async getExpenseBySupplier() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const segment = this.purchase.segment || {}\n                    const segmentId = segment.id || ''\n                    const location = this.purchase.location || {}\n                    const locationId = location.id || ''\n                    const supplier = this.purchase.supplier || {}\n                    const supplierId = supplier.id || ''\n                    const strFilter = '?id=' + supplierId + '&segId=' + segmentId + '&locId=' + locationId;\n                    this.expenses = []\n                    this.purchase.additionalCostTotal = 0\n                    this.showLoadingTxnAdditionalCost = false\n                    this.purchase.additionalCost = []\n                    billingHandler.listPurchase(strFilter).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoadingTxnAdditionalCost = true\n                            this.showLoadingTxnAdditionalCost = false;\n                            this.expenses = res.data.data;\n                            this.onMethodChanged()\n                        } else {\n                            this.showLoadingTxnAdditionalCost = false;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async clearingAccount() {\n            try {\n                if (this.isItem()) {\n                    /* todo: clearing account for additional cost */\n                    const amount = (this.purchase.additionalCostTotal || 0) * -1\n                    const xAmount = amount * this.purchase.txnRate || 1\n                    const addict = this.purchase.additionalCost || []\n\n                    if (addict.length > 0) {\n                        if (addict[0]) {\n                            const account = addict[0].account || {}\n                            const nature = 'cr'\n                            this.jRaw.push({\n                                id: account.id + \"-\" + nature,\n                                line: new ItemLineModel(),\n                                description: \"Additional Cost\",\n                                account: account,\n                                accountId: account.id,\n                                amount: amount,\n                                exchangeAmount: xAmount,\n                                type: nature,\n                                typeAs: \"clearing\",\n                            });\n                        }\n                    }\n                }\n            } catch (e) {\n                window.console.log('error', e)\n            }\n        },\n        isItem() {\n            const ds = this.$refs.itemLineDS.kendoWidget()\n            const row = ds.data().filter(n => n.amount > 0)\n            const found = row.filter(n => n.item.type === 'Variant')\n            if (found) {\n                return found.length > 0;\n            }\n            return false\n        }\n    },\n    computed: {\n        abbr() {\n            if (this.purchase) {\n                const txnType = this.purchase.transactionType || {}\n                const abbr = txnType.abbr || ''\n                return abbr\n            } else {\n                return ''\n            }\n        },\n        validVendor() {\n            let vendor = this.vendor;\n            return vendor.id !== undefined && vendor.id !== null;\n        },\n        disableMe() {\n            return !!this.$route.params.id;\n        },\n        hiddenButton() {\n            return !!this.$route.params.id;\n        },\n        disabledSLP() {\n            if (this.$route.params.id) {\n                const refF = this.purchase.refFrom || []\n                if (refF.length > 0) {\n                    return !!refF.length > 0\n                }\n                const adc = this.purchase.additionalCost || []\n                if (adc.length > 0) {\n                    return !!adc.length > 0\n                }\n            }\n            return false\n        },\n    },\n    watch: {\n        // id() {\n        //   if (this.$route.params.id === undefined) {\n        //     this.clear();\n        //   } else {\n        //     this.showLoading = true;\n        //     this.loadViewCreditPurchase();\n        //   }\n        // },\n        '$route': 'reload'\n    },\n    created() {\n        this.loadTax();\n        this.loadPrefix();\n        this.loadProjectByCustomer();\n    },\n    mounted: async function () {\n        this.requestData(0, this.filter, this.cusBaseUrl);\n        await this.loadSegment();\n        await this.loadLocation();\n        await this.loadDiscountItem();\n        await this.loadEmployeeCenter();\n        await this.loadPaymentTerm();\n        await this.loadAccount();\n        await this.loadPriceLevel();\n        await this.loadOtherCharge();\n        await this.loadPurchaseFormContent();\n        await this.initData()\n    },\n};\n</script>\n\n<style scoped>\n.k-dropdown {\n    width: 100%;\n    margin-top: 3px;\n}\n\n.function_wrapper {\n    box-shadow: none !important;\n}\n\n.v-application--is-ltr .v-text-field .v-input__append-inner {\n    margin-top: 0 !important;\n}\n\n.v-input__slot {\n    background-color: #fff !important;\n}\n\n.function_content .label {\n    margin-bottom: 10px;\n    display: inline-block;\n}\n\n.border_radius10 {\n    border-radius: 10px !important;\n    background-color: #f2f2f2;\n}\n\n.pa-3.v-card h4 {\n    font-size: 18px;\n    color: #333;\n}\n\n.pa-3.v-card p {\n    font-size: 12px;\n    color: #b5b5b5;\n}\n\n.attachment_file {\n    background-color: #efeded;\n    border-radius: 0 !important;\n}\n\n.attachment_table.v-data-table table {\n    border: thin solid rgba(0, 0, 0, 0.12);\n}\n\n.attachment_table table tr th {\n    border-left: thin solid rgba(0, 0, 0, 0.12);\n    height: 35px;\n    border-right: thin solid rgba(0, 0, 0, 0.12);\n}\n\n.block_debit,\n.block_credit {\n    border-bottom: 1px solid #fff;\n}\n\n.block_debit p.number,\n.block_credit p.number {\n    font-size: 25px;\n    color: #7f7f7f;\n}\n\n.block_debit h5,\n.block_credit h5,\n.block_difference h5 {\n    text-transform: uppercase;\n    color: #7f7f7f;\n    font-size: 15px;\n    font-weight: normal;\n}\n\n.block_difference h5 {\n    font-size: 18px;\n}\n\n.block_difference h5 span {\n    font-size: 15px;\n}\n\n.custom_grid table th:last-child {\n    text-align: right !important;\n}\n\n@media (min-width: 1264px) {\n    .container {\n        max-width: 1250px;\n    }\n}\n\n@media (max-width: 576px) {\n    .pt-6.col-sm-5.col-12 {\n        padding-top: 0 !important;\n    }\n\n    .code_text {\n        width: 100%;\n    }\n\n    .phone_no_pt {\n        padding-top: 0 !important;\n    }\n\n    .select_template,\n    .save_option {\n        margin-bottom: 10px;\n    }\n}\n\n.hide_small_bar_class {\n    max-width: 0;\n    transition: 0.5s ease-in;\n    flex: 0 0 0;\n}\n\n.hide_big_bar_class {\n    max-width: 100%;\n    transition: 0.5s ease-in;\n    flex: 0 0 100%;\n}\n\n.info_add {\n    background-color: #ffffff;\n}\n\n.small_sidebar {\n    height: 98%;\n    position: relative;\n    padding: 12px;\n    background-color: #edf1f5;\n}\n\n.iconArrow {\n    right: -35px;\n    position: absolute;\n    bottom: -10px;\n}\n\n.iconArrowHide {\n    position: absolute;\n    right: -7px;\n    bottom: -10px;\n}\n\n.color_grey {\n    color: #808080;\n}\n\n.card_green {\n    min-height: 70px;\n    background-color: #00b050 !important;\n    color: #ffffff;\n}\n\n.lb_bold {\n    font-size: 12px;\n}\n\n.detial_smallside_p {\n    position: absolute;\n    bottom: 10px;\n}\n\n.card_background {\n    background-color: #edf1f5;\n    min-height: 120px;\n}\n\n.deposite_input {\n    width: 100px;\n}\n\n.btn_save_draft {\n    color: #ffffff;\n    background-color: #00b0f0 !important;\n    text-transform: capitalize;\n}\n\n.save_option {\n    background-color: #203864 !important;\n}\n\n.btn_add_small {\n    height: 27px !important;\n    min-width: 25px !important;\n    font-size: 10px;\n    padding: 0 22px !important;\n    background-color: #00b050 !important;\n    color: #ffffff;\n    border-radius: 0 !important;\n}\n\n.list_site_inv {\n    background-color: #92d050;\n    color: #ffffff;\n    font-size: 12px;\n}\n\n.list_site_exp {\n    background-color: #c5e0b4;\n    color: #000000;\n    font-size: 12px;\n    line-height: 16px;\n    min-height: 40px;\n}\n\n.checkbox_inv {\n    padding: 2px;\n    margin-top: 3px;\n    margin-right: 2px;\n}\n\n.exp_select {\n    font-size: 12px !important;\n}\n\n.theme--light.v-data-table\n> .v-data-table__wrapper\n> table\n> tbody\n> tr:hover:not(.v-data-table__expanded__content):not(.v-data-table__empty-wrapper) {\n    background-color: transparent !important;\n}\n</style>\n"]}]}