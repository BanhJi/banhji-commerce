{"remainingRequest":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/src/views/customers/Invoice.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/src/views/customers/Invoice.vue","mtime":1640658755379},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/macos/Desktop/banhji-0.2/banhji-accounting-web-module/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCi8vIGltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiCmltcG9ydCB7aTE4bn0gZnJvbSAiQC9pMThuIjsKaW1wb3J0IERhdGVQaWNrZXJDb21wb25lbnQgZnJvbSAiQC9jb21wb25lbnRzL2N1c3RvbV90ZW1wbGF0ZXMvRGF0ZVBpY2tlckNvbXBvbmVudCI7CmltcG9ydCBJbnZvaWNlTW9kZWwgZnJvbSAiQC9zY3JpcHRzL2ludm9pY2UvbW9kZWwvSW52b2ljZSI7CmltcG9ydCBJdGVtTGluZU1vZGVsIGZyb20gIkAvc2NyaXB0cy9pbnZvaWNlL21vZGVsL0l0ZW1MaW5lIjsKaW1wb3J0IHt1dWlkfSBmcm9tICJ2dWUtdXVpZCI7CmltcG9ydCBwYXltZW50VGVybUhhbmRsZXJfIGZyb20gIkAvc2NyaXB0cy9wYXltZW50dGVybS9oYW5kbGVyL3BheW1lbnRUZXJtSGFuZGxlciI7CmltcG9ydCB7RHJvcERvd25MaXN0fSBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdnVlLWRyb3Bkb3ducyI7CmltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiOwppbXBvcnQgU2FsZUZvcm1Db250ZW50TW9kZWwgZnJvbSAiQC9zY3JpcHRzL21vZGVsL1NhbGVGb3JtQ29udGVudCI7Ci8vIGltcG9ydCBrZW5kbyBmcm9tICJAcHJvZ3Jlc3Mva2VuZG8tdWkiOwppbXBvcnQge2RhdGFTdG9yZSwgU2hvd1Jlc291cmNlfSBmcm9tICJAL29ic2VydmFibGUvc3RvcmUiOwppbXBvcnQge2dldFByaW50fSBmcm9tICJAL2Zvcm0vaW52b2ljZXMuanMiOwppbXBvcnQgY3JlZGl0TGltaXRIYW5kbGVyIGZyb20gIkAvc2NyaXB0cy9jcmVkaXRMaW1pdC9oYW5kbGVyL2NyZWRpdExpbWl0SGFuZGxlciI7CmltcG9ydCBQYXltZW50T3B0aW9uTW9kZWwgZnJvbSAiQC9zY3JpcHRzL21vZGVsL1BheW1lbnRPcHRpb24iOwppbXBvcnQge1BBWU1FTlRfT1BJTklPTl9UWVBFfSBmcm9tICJAL3NjcmlwdHMvZGVmYXVsdF9zZXR1cC9TZXR0aW5nIjsKCmNvbnN0IGN1c3RvbWVySGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9jdXN0b21lckhhbmRsZXIiKTsKCmNvbnN0IHByb2plY3RIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3Byb2plY3RIYW5kbGVyIik7CmNvbnN0IHByaWNlTGV2ZWxIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3ByaWNlTGV2ZWxIYW5kbGVyIik7CmNvbnN0IGN1cnJlbmN5SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9jdXJyZW5jeS9oYW5kbGVyL2N1cnJlbmN5SGFuZGxlciIpOwpjb25zdCBzYWxlT3JkZXJIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3RyYW5zYWN0aW9uSGFuZGxlciIpOwoKY29uc3Qgc2V0dGluZ3NIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3NldHRpbmdzSGFuZGxlciIpOwpjb25zdCBzYWxlQ2hhbm5lbEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvc2FsZUNoYW5uZWxIYW5kbGVyIik7CmNvbnN0IGVtcGxveWVlSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9lbXBsb3llZUhhbmRsZXIiKTsKY29uc3QgbG9jYXRpb25IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2xvY2F0aW9uSGFuZGxlciIpOwovLyBjb25zdCBwYXltZW50VGVybUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcGF5bWVudFRlcm1IYW5kbGVyIikKCmNvbnN0IHBheW1lbnRUZXJtSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9zZXR0aW5nc0hhbmRsZXIiKTsKY29uc3QgYWNjb3VudEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvaGFuZGxlci9hY2NvdW50aW5nL2FjY291bnQiKTsKY29uc3QgcHJvZHVjdFZhcmlhbnRIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3Byb2R1Y3RWYXJpYW50SGFuZGxlciIpOwpjb25zdCB1b21QcmljZUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvdW9tUHJpY2VIYW5kbGVyIik7CmNvbnN0IHVvbUNvbnZlcnNpb25IYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL3VvbUNvbnZlcnNpb25IYW5kbGVyIik7CmNvbnN0IGRpc2NvdW50SXRlbUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvZGlzY291bnRJdGVtSGFuZGxlciIpOwpjb25zdCBzZXR0aW5nSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9zZXR0aW5nSGFuZGxlciIpOwpjb25zdCBpdGVtTW9kaWZpZXJIYW5kbGVyID0gcmVxdWlyZSgiQC9zY3JpcHRzL2l0ZW1Nb2RpZmllckhhbmRsZXIiKTsKY29uc3Qgc2FsZVVuaXRJdGVtSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9zYWxlVW5pdEl0ZW1IYW5kbGVyIik7CmNvbnN0IG90aGVyQ2hhcmdlSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9vdGhlckNoYXJnZUhhbmRsZXIiKTsKY29uc3Qgc2FsZUZvcm1Db250ZW50SGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9zYWxlRm9ybUNvbnRlbnRIYW5kbGVyIik7CmNvbnN0IHByZWZpeEhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcHJlZml4SGFuZGxlciIpOwpjb25zdCBiaWxsaW5nSGFuZGxlciA9IHJlcXVpcmUoIkAvc2NyaXB0cy9pbnZvaWNlL2hhbmRsZXIvYmlsbGluZ0hhbmRsZXIiKTsKY29uc3QgbGF0ZUZlZUhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvbGF0ZUZlZUhhbmRsZXIiKTsKY29uc3QgcGF5bWVudE9wdGlvbkhhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvcGF5bWVudE9wdGlvbkhhbmRsZXIiKTsKY29uc3QgY2F0YWxvZ0hhbmRsZXIgPSByZXF1aXJlKCJAL3NjcmlwdHMvY2F0YWxvZ0hhbmRsZXIiKTsKCmNvbnN0IGludm9pY2VNb2RlbCA9IG5ldyBJbnZvaWNlTW9kZWwoe30pOwpjb25zdCBpdGVtTGluZU1vZGVsID0gbmV3IEl0ZW1MaW5lTW9kZWwoe30pOwpjb25zdCBzYWxlRm9ybUNvbnRlbnRNb2RlbCA9IG5ldyBTYWxlRm9ybUNvbnRlbnRNb2RlbCh7fSk7CmltcG9ydCBPdGhlckNoYXJnZU1vZGVsIGZyb20gIkAvc2NyaXB0cy9tb2RlbC9PdGhlckNoYXJnZSI7Cgpjb25zdCAkID0ga2VuZG8ualF1ZXJ5Cgpjb25zdCB0ZXh0RmllbGQgPSAibnVtYmVyTmFtZSI7CmNvbnN0IGtleUZpZWxkID0gImlkIjsKY29uc3QgZGVmYXVsdEl0ZW0gPSB7W3RleHRGaWVsZF06ICJTZWxlY3QgY3VzdG9tZXIuLi4iLCBba2V5RmllbGRdOiBudWxsfTsKY29uc3QgZW1wdHlJdGVtID0ge1t0ZXh0RmllbGRdOiAibG9hZGluZyAuLi4ifTsKY29uc3QgcGFnZVNpemUgPSAxMDsKY29uc3QgaXRlbUxpbmVQcmVmaXggPSAibGluLSI7CmNvbnN0IGxvYWRpbmdEYXRhID0gW107CndoaWxlIChsb2FkaW5nRGF0YS5sZW5ndGggPCBwYWdlU2l6ZSkgewogICAgbG9hZGluZ0RhdGEucHVzaCh7Li4uZW1wdHlJdGVtfSk7Cn0KY29uc3QgT1BUSU9OX1RZUEUgPSAiQ3VzdG9tZXIiOwpjb25zdCBzdHJGaWx0ZXIgPSAiP29wdGlvblR5cGU9IiArIE9QVElPTl9UWVBFOwpjb25zdCBESVNDT1VOVF9UWVBFID0gIj90eXBlPVNhbGUiOwpjb25zdCBjb29raWVKUyA9IHJlcXVpcmUoIkAvY29va2llLmpzIik7CmNvbnN0IGNvb2tpZSA9IGNvb2tpZUpTLmdldENvb2tpZSgpOwpleHBvcnQgZGVmYXVsdCB7CiAgICBuYW1lOiAiQ3VzdG9tZXJJbnZvaWNlIiwKICAgIHByb3BzOiBbImlkIiwgInRyYW5zYWN0aW9uRGF0ZSJdLAogICAgY29tcG9uZW50czogewogICAgICAgIExvYWRpbmdNZTogKCkgPT4gaW1wb3J0KGBAL2NvbXBvbmVudHMvTG9hZGluZ2ApLAogICAgICAgICJhcHAtZGF0ZXBpY2tlciI6IERhdGVQaWNrZXJDb21wb25lbnQsCiAgICAgICAgZHJvcGRvd25saXN0OiBEcm9wRG93bkxpc3QsCiAgICB9LAogICAgZGF0YTogKCkgPT4gKHsKICAgICAgICBpc0VkaXQ6IGZhbHNlLAogICAgICAgIG1PdGhlckNoYXJnZTogW10sCiAgICAgICAgbU90aGVyQ2hhcmdlQW1vdW50OiBbXSwKICAgICAgICBudW1TZWxlY3Q6IFsxXSwKICAgICAgICBkaWFsb2dUYXg6IGZhbHNlLAogICAgICAgIGN1c3RvbWVyTGlzdDogW10sCiAgICAgICAgc2hvd0xvYWRpbmc6IGZhbHNlLAogICAgICAgIHNob3dMb2FkaW5nVHhuOiBmYWxzZSwKICAgICAgICBhbGVydDogZmFsc2UsCiAgICAgICAgZmlsZXM6IFtdLAogICAgICAgIC8vIEZvcm0gdmFsaWRhdGlvbgogICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgIGl0ZW1MaW5lczogW10sCiAgICAgICAgaW52b2ljZURhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApLAogICAgICAgIHRlbXBsYXRlOiAtMSwKICAgICAgICB0ZW1wbGF0ZXNGb3JtOiBbXSwKICAgICAgICBpc0hpZGVCYXI6IGZhbHNlLAogICAgICAgIGdyaWRTY2hlbWE6IHsKICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgICAgY3VzdG9tZXI6IHt9LAogICAgICAgIGRlZmF1bHRJdGVtOiBkZWZhdWx0SXRlbSwKICAgICAgICBpbnZvaWNlOiBpbnZvaWNlTW9kZWwsCiAgICAgICAgdHJhbnNhY3Rpb25UeXBlOiBbIkludm9pY2UiLCAiQ29tbWVyY2lhbCBJbnZvaWNlIiwgIlRheCBJbnZvaWNlIl0sCiAgICAgICAgY3VzQmFzZVVybDogY3VzdG9tZXJIYW5kbGVyLnNlYXJjaHYxKCksCiAgICAgICAgZW1wQmFzZVVybDogZW1wbG95ZWVIYW5kbGVyLnNlYXJjaCgpLAogICAgICAgIGluaXQ6IHttZXRob2Q6ICJHRVQiLCBhY2NlcHQ6ICJhcHBsaWNhdGlvbi9qc29uIiwgaGVhZGVyczogW119LAogICAgICAgIHBlbmRpbmdSZXF1ZXN0OiB1bmRlZmluZWQsCiAgICAgICAgcmVxdWVzdFN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgIHNraXA6IDAsCiAgICAgICAgdGVtcFNraXA6IG51bGwsCiAgICAgICAgdG90YWw6IDAsCiAgICAgICAgZmlsdGVyOiAiIiwKICAgICAgICByZWZlcmVuY2VObzogIiIsCiAgICAgICAgZmlsdGVyXzogIiIsCiAgICAgICAgdGV4dEZpZWxkOiAibnVtYmVyTmFtZSIsCiAgICAgICAgZGF0YUl0ZW1LZXk6ICJpZCIsCiAgICAgICAgc2VnbWVudHM6IFtdLAogICAgICAgIHNhbGVDaGFubmVsTGlzdDogW10sCiAgICAgICAgZW1wbG95ZWVzOiBbXSwKICAgICAgICBtRW1wbG95ZWU6IHt9LAogICAgICAgIGN1c3RvbWVyUHJvamVjdHM6IFtdLAogICAgICAgIGJpbGxpbmdBZGRyZXNzOiBbXSwKICAgICAgICBkZWxpdmVyeUFkZHJlc3M6IFtdLAogICAgICAgIGRlbGl2ZXJ5RGF0ZVRpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApLAogICAgICAgIHByaWNlTGV2ZWw6IFtdLAogICAgICAgIGxvY2F0aW9uczogW10sCiAgICAgICAgcGF5bWVudFRlcm1zOiBbXSwKICAgICAgICByZWNlaXZhYmxlQWNjOiBbXSwKICAgICAgICBjdXJyZW5jaWVzOiBbXSwKICAgICAgICBpdGVtTGluZTogaXRlbUxpbmVNb2RlbCwKICAgICAgICB1b21zOiBbXSwKICAgICAgICBvdGhlclRheDogW10sCiAgICAgICAgdmF0VGF4OiBbXSwKICAgICAgICBzcGVjaWZpY1RheDogW10sCiAgICAgICAgcHVibGljTGlnaHRpbmdUYXg6IFtdLAogICAgICAgIHNhbGVVbml0SXRlbUxpc3Q6IFtdLAogICAgICAgIHNwZWNpZmljRGlzY291bnRJdGVtOiBbXSwKICAgICAgICBvdGhlckNoYXJnZUxpc3Q6IFtdLAogICAgICAgIGRlcG9zaXRCYWxhbmNlOiAwLAogICAgICAgIHNjaGVtYURlZmluaXRpb246IHsKICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgICAgc2FsZUZvcm1Db250ZW50OiBzYWxlRm9ybUNvbnRlbnRNb2RlbCwKICAgICAgICB0YXhMaXN0VG90YWw6IHt9LAogICAgICAgIGludm9pY2VUeXBlczogW10sCiAgICAgICAgY3VzdG9tZXJEaXNjb3VudEl0ZW06IFtdLAogICAgICAgIGN1c3RvbWVyT3RoZXJDaGFyZ2VJdGVtOiBbXSwKICAgICAgICBjdXN0b21lclNhbGVVbml0OiBbXSwKICAgICAgICBjdXN0b21lclNhbGVVbml0TGluZTogW10sCiAgICAgICAgbGF0ZUZlZUxpc3Q6IFtdLAogICAgICAgIGxvZ2dlZFVzZXI6IHsKICAgICAgICAgICAgaWQ6IGNvb2tpZS5jcmVhdG9yLAogICAgICAgICAgICBuYW1lOiBjb29raWUuZW1haWwsCiAgICAgICAgfSwKICAgICAgICBwYXltZW50T3B0aW9uV0JNb2JpbGU6IFtdLAogICAgICAgIHBheW1lbnRPcHRpb25PbmxpbmU6IFtdLAogICAgICAgIHBheW1lbnRPcHRpb25LSFFSOiBbXSwKICAgICAgICBwYXltZW50T3B0aW9uQmFua1RyYW5zZmVyOiBbXSwKICAgICAgICBleGNoYW5nZVJhdGU6IHt9LAogICAgICAgIGJhc2VDdXJyZW5jeUNvZGU6ICIiLAogICAgICAgIGN1cnJlbmN5Q29kZTogIiIsCiAgICAgICAgdHJhbnNhY3Rpb25SYXRlOiAxLAogICAgICAgIGpSYXc6IFtdLAogICAgICAgIGNhdGFsb2dzOiBbXSwKICAgICAgICBkaWFsb2dDYXRhbG9nOiBmYWxzZSwKICAgICAgICBzYWxlT3JkZXJzOiBbXSwKICAgICAgICBpc1ByaWNlTGV2ZWxDaGFuZ2VkOiBmYWxzZSwKICAgICAgICBjYXNoUGF5bWVudDogW10sCiAgICAgICAgYmlsbFBheW1lbnQ6IFtdLAogICAgICAgIHFyUGF5bWVudDogW10sCiAgICAgICAgYmFua1RyYW5zZmVyOiBbXSwKICAgICAgICByZWZGcm9tOiBbXSwKICAgICAgICB0YXhMaXN0RGV0YWlsOiBbXSwKICAgICAgICB0YXg6IFtdLAogICAgICAgIGlzQWRkZWQ6IGZhbHNlLAogICAgICAgIGJ0bkRpc2FibGVkOiBmYWxzZSwKICAgICAgICBkZXBvc2l0RGVkdWN0aW9uOiAwLAogICAgICAgIGNhc2hCYXNpY1JldmVudWVBY2M6IFtdCiAgICB9KSwKICAgIG1ldGhvZHM6IHsKICAgICAgICBkYXRhQm91bmQ6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBrZW5kby5qUXVlcnkoIiNncmlkSXRlbUxpbmUiKS5kYXRhKCJrZW5kb0dyaWQiKTsKICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBlLnNlbmRlci5pdGVtcygpOwogICAgICAgICAgICBpZiAoZ3JpZCkgewogICAgICAgICAgICAgICAgaXRlbXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGFJdGVtID0gZ3JpZC5kYXRhSXRlbSh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAkKCJ0cltkYXRhLXVpZD0nIiArIGRhdGFJdGVtLnVpZCArICInXSIpLmZpbmQoJy5pc0VkaXRhYmxlJykKICAgICAgICAgICAgICAgICAgICAgICAgLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFJdGVtLmlzRWRpdGFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiay1zdGF0ZS1kaXNhYmxlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlVGF4RGV0YWlsKCkgewogICAgICAgICAgICBsZXQgaWRzID0gW10KICAgICAgICAgICAgdGhpcy50YXhMaXN0RGV0YWlsLmZvckVhY2gobiA9PiB7CiAgICAgICAgICAgICAgICBpZHMucHVzaChuLmlkIHx8ICcnKQogICAgICAgICAgICB9KQogICAgICAgICAgICBjb25zdCB1bmlxdWUgPSBbLi4ubmV3IFNldChpZHMpXQogICAgICAgICAgICBsZXQgcmVzdWx0ID0gW10KICAgICAgICAgICAgdW5pcXVlLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgYW1vdW50ID0gMCwgcm93ID0ge30sIGRpc2NvdW50ID0gMCwgeERpc2NvdW50ID0gMCwgeEFtb3VudCA9IDAsIHRheEFtb3VudCA9IDAsIHhUYXhBbW91bnQgPSAwCiAgICAgICAgICAgICAgICBsZXQgdGF4RGV0YWlsID0gW10sIGlzVmF0ID0gMAogICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSB0aGlzLnRheExpc3REZXRhaWwuZmlsdGVyKG4gPT4gbi5pZCA9PT0gbSkKICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygndGF4TGlzdERldGFpbGlkcycsIGZvdW5kKQogICAgICAgICAgICAgICAgZm91bmQuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgICAgICByb3cgPSBrCiAgICAgICAgICAgICAgICAgICAgaWYgKGsuaXNWYXQgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNWYXQgPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRldGFpbF8gPSBrLmRldGFpbCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICB0YXhEZXRhaWwucHVzaChkZXRhaWxfKQoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGF4QW1vdW50ICs9IGsudGF4QW1vdW50XyB8fCAwCiAgICAgICAgICAgICAgICAgICAgeFRheEFtb3VudCArPSAoay50YXhBbW91bnRfIHx8IDApICogKGsudHhuUmF0ZSB8fCAxKQogICAgICAgICAgICAgICAgICAgIGFtb3VudCArPSAoay5hbW91bnQgfHwgMCkKICAgICAgICAgICAgICAgICAgICB4QW1vdW50ICs9IChrLmFtb3VudCB8fCAwKSAqIChrLnR4blJhdGUgfHwgMSkKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudCArPSAoay5kaXNjb3VudCB8fCAwKQogICAgICAgICAgICAgICAgICAgIHhEaXNjb3VudCArPSAoay5kaXNjb3VudCB8fCAwKSAqIChrLnR4blJhdGUgfHwgMSkKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBsZXQgc3BUYXhBbXQgPSAwLCBzcFhUYXhBbXQgPSAwLCBwbFRheEFtdCA9IDAsIHBsWFRheEFtdCA9IDAsIG90VGF4QW10ID0gMCwgb3RYVGF4QW10ID0gMCwKICAgICAgICAgICAgICAgICAgICBzcFRheE5hbWUgPSAnJywgcGxUYXhOYW1lID0gJycsIG90VGF4TmFtZSA9ICcnLAogICAgICAgICAgICAgICAgICAgIHNwVGF4TmFtZUxvY2FsZSA9ICcnLCBwbFRheE5hbWVMb2NhbGUgPSAnJywgb3RUYXhOYW1lTG9jYWxlID0gJycsCiAgICAgICAgICAgICAgICAgICAgc3BBY2NJZCA9ICcnLCBwbEFjY0lkID0gJycsIG90QWNjSWQgPSAnJywKICAgICAgICAgICAgICAgICAgICBzcFJhdGUgPSAnJywgcGxSYXRlID0gJycsIG90UmF0ZSA9ICcnCiAgICAgICAgICAgICAgICB0YXhEZXRhaWwuZm9yRWFjaChuID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcFRheCA9IG4uc3BlY2lmaWNUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCBwbFRheCA9IG4ucHVibGljTGlnaHRpbmdUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGhlclRheCA9IG4ub3RoZXJUYXggfHwge30KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoc3BUYXgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3BUYXhBbXQgKz0gKHNwVGF4LnRheEFtb3VudF8gfHwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgc3BYVGF4QW10ICs9ICgoc3BUYXgudGF4QW1vdW50XyB8fCAwKSAqIChzcFRheC50YXhSYXRlIHx8IDEpKQogICAgICAgICAgICAgICAgICAgICAgICBzcFRheE5hbWUgPSBzcFRheC5kZWZhdWx0VGF4IHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIHNwVGF4TmFtZUxvY2FsZSA9IHNwVGF4LmRlZmF1bHRUYXhMb2NhbGUgfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgc3BBY2NJZCA9IHNwVGF4LmFjY291bnQgPyBzcFRheC5hY2NvdW50LmlkIDogJycKICAgICAgICAgICAgICAgICAgICAgICAgc3BSYXRlID0gc3BUYXgucmF0ZSB8fCAxCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhwbFRheCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwbFRheEFtdCArPSAocGxUYXgudGF4QW1vdW50XyB8fCAwKQogICAgICAgICAgICAgICAgICAgICAgICBwbFhUYXhBbXQgKz0gKChwbFRheC50YXhBbW91bnRfIHx8IDApICogKHBsVGF4LnRheFJhdGUgfHwgMSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHBsVGF4TmFtZSA9IHBsVGF4LmRlZmF1bHRUYXggfHwgJycKICAgICAgICAgICAgICAgICAgICAgICAgcGxUYXhOYW1lTG9jYWxlID0gcGxUYXguZGVmYXVsdFRheExvY2FsZSB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICBwbEFjY0lkID0gcGxUYXguYWNjb3VudCA/IHBsVGF4LmFjY291bnQuaWQgOiAnJwogICAgICAgICAgICAgICAgICAgICAgICBwbFJhdGUgPSBwbFRheC5yYXRlIHx8IDEKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKG90aGVyVGF4KS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG90VGF4QW10ICs9IChvdGhlclRheC50YXhBbW91bnRfIHx8IDApCiAgICAgICAgICAgICAgICAgICAgICAgIG90WFRheEFtdCArPSAoKG90aGVyVGF4LnRheEFtb3VudF8gfHwgMCkgKiAocGxUYXgudGF4UmF0ZSB8fCAxKSkKICAgICAgICAgICAgICAgICAgICAgICAgb3RUYXhOYW1lID0gb3RoZXJUYXguZGVmYXVsdFRheCB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICBvdFRheE5hbWVMb2NhbGUgPSBvdGhlclRheC5kZWZhdWx0VGF4TG9jYWxlIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIG90QWNjSWQgPSBvdGhlclRheC5hY2NvdW50ID8gb3RoZXJUYXguYWNjb3VudC5pZCA6ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIG90UmF0ZSA9IG90aGVyVGF4LnJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBpZiAoaXNWYXQgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByb3cuZGV0YWlsID0gewogICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZpY1RheDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogc3BUYXhOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZUxvY2FsZTogc3BUYXhOYW1lTG9jYWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBzcFRheEFtdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBzcFhUYXhBbXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwQWNjSWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlOiBzcFJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpY0xpZ2h0aW5nVGF4OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwbFRheE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lTG9jYWxlOiBwbFRheE5hbWVMb2NhbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHBsVGF4QW10LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHBsWFRheEFtdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogcGxBY2NJZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IHBsUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJUYXg6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG90VGF4TmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVMb2NhbGU6IG90VGF4TmFtZUxvY2FsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogb3RUYXhBbXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogb3RYVGF4QW10LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBvdEFjY0lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZTogb3RSYXRlLAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByb3cuZGV0YWlsID0ge30KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByb3dbJ2Ftb3VudCddID0gYW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ2V4Y2hhbmdlQW1vdW50J10gPSB4QW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ3RheEFtb3VudCddID0gdGF4QW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ2V4Y2hhbmdlVGF4QW1vdW50J10gPSB4VGF4QW1vdW50CiAgICAgICAgICAgICAgICByb3dbJ2Rpc2NvdW50J10gPSBkaXNjb3VudAogICAgICAgICAgICAgICAgcm93WydleGNoYW5nZURpc2NvdW50J10gPSB4RGlzY291bnQKICAgICAgICAgICAgICAgIHJvd1snY3VycmVuY3knXSA9IHRoaXMuaW52b2ljZS5leGNoYW5nZVJhdGUgfHwge30KICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHJvdykKICAgICAgICAgICAgICAgIHRheERldGFpbCA9IFtdCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5zYWxlVGF4RGV0YWlsID0gcmVzdWx0CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnc2FsZVRheERldGFpbCcsIHJlc3VsdCkKICAgICAgICB9LAogICAgICAgIENob3NlVGVtcGxhdGUoaSkgewogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coaSk7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSBpOwogICAgICAgIH0sCiAgICAgICAgc2hyaW5rRGlzY291bnRJdGVtKGRpc2NvdW50SXRlbSwgZGlzY291bnRMaW5lKSB7CiAgICAgICAgICAgIGxldCB1bmlxdWVEaXNjb3VudEl0ZW1zID0gW107CiAgICAgICAgICAgIGNvbnN0IHVuaXF1ZSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKGRpc2NvdW50SXRlbSk7CiAgICAgICAgICAgIHVuaXF1ZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBmb3VuZCA9IGRpc2NvdW50TGluZS5maWx0ZXIoKG4pID0+IG4uaWQgPT09IG0uaWQpOwogICAgICAgICAgICAgICAgbGV0IGFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQgPSAwOwogICAgICAgICAgICAgICAgZm91bmQubWFwKChvKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ICs9IG8uYW1vdW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3VuZC5tYXAoKG8pID0+IHsKICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudCArPSBvLmV4Y2hhbmdlQW1vdW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB1bmlxdWVEaXNjb3VudEl0ZW1zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGlkOiBtLmlkLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG0ubmFtZSwKICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudCwKICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogZXhjaGFuZ2VBbW91bnQsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJEaXNjb3VudEl0ZW0gPSB1bmlxdWVEaXNjb3VudEl0ZW1zOwogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2codW5pcXVlRGlzY291bnRJdGVtcywgInVuaXF1ZURpc2NvdW50SXRlbXMiKTsKICAgICAgICB9LAogICAgICAgIHNocmlua090aGVyQ2hhcmdlSXRlbShvdGhlckNoYXJnZUl0ZW0sIG90aGVyQ2hhcmdlTGluZSkgewogICAgICAgICAgICBsZXQgaXRlbXMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdW5pcXVlID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUob3RoZXJDaGFyZ2VJdGVtKTsKICAgICAgICAgICAgdW5pcXVlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gb3RoZXJDaGFyZ2VMaW5lLmZpbHRlcigobikgPT4gbi5pZCA9PT0gbS5pZCk7CiAgICAgICAgICAgICAgICBsZXQgYW1vdW50ID0gMCwgZXhjaGFuZ2VBbW91bnQgPSAwOwogICAgICAgICAgICAgICAgZm91bmQubWFwKChvKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ICs9IG8uYW1vdW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3VuZC5tYXAoKG8pID0+IHsKICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudCArPSBvLmV4Y2hhbmdlQW1vdW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogbS5pZCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGV4Y2hhbmdlQW1vdW50LAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmN1c3RvbWVyT3RoZXJDaGFyZ2VJdGVtID0gaXRlbXM7CiAgICAgICAgfSwKICAgICAgICBhZGRTYWxlT3JkZXIoaXRlbSkgewogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgY29uc3QgaXRlbUxpbmUgPSBpdGVtLml0ZW1MaW5lcyB8fCBbXTsKICAgICAgICAgICAgICAgIHRoaXMucmVmRnJvbS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogaXRlbS5pZCB8fCAnJywKICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2U6IGl0ZW0ucmVmZXJlbmNlTm8gfHwgJycKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICAgICAgICAgICAgICB0b3RhbCA9IGRzLnRvdGFsKCk7CiAgICAgICAgICAgICAgICBpdGVtTGluZS5mb3JFYWNoKChvKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtTGluZSA9IG5ldyBJdGVtTGluZU1vZGVsKG8pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaWQgPSBpdGVtTGluZVByZWZpeCArIHV1aWQudjEoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lLmRlY2ltYWxGb3JtYXQgPSAibiIgKyB0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaXNFZGl0YWJsZSA9IHRydWUKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lLnNvdXJjZVRyYW5zYWN0aW9uID0gewogICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRlbS5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlTm86IGl0ZW0ucmVmZXJlbmNlTm8sCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lLnNvdXJjZVRyYW5zYWN0aW9uUmVmID0gaXRlbS5yZWZlcmVuY2VObzsKICAgICAgICAgICAgICAgICAgICBkcy5pbnNlcnQodG90YWwsIHRoaXMuaXRlbUxpbmUpOwogICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLml0ZW1MaW5lLCAnaXRlbUxpbmUnKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLml0ZW1MaW5lID0gbmV3IEl0ZW1MaW5lTW9kZWwoe30pOwogICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2FsZU9yZGVycy5maW5kSW5kZXgoKGl0bSkgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLmlkID09PSBpdG0uaWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnJlZkZyb20gPSB0aGlzLnJlbW92ZUR1cGxpY2F0ZSh0aGlzLnJlZkZyb20pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGl0ZW0sICctLScpCiAgICAgICAgfSwKICAgICAgICBsb2FkSW1hZ2UoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgaWYgKGRhdGFJdGVtLmhhc093blByb3BlcnR5KCJpbWFnZXMiKSkgewogICAgICAgICAgICAgICAgaWYgKGRhdGFJdGVtLmltYWdlcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdCIpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJsID0gdGhpcy5pbWdVUkwgKyBkYXRhSXRlbS5pbWFnZXMuZGVmYXVsdC50aHVtYjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAiPGltZyB3aWR0aD0nNTAnIGhlaWdodD0nNTAnIHN0eWxlPSAnbWFyZ2luOiBhdXRvO2Rpc3BsYXk6IGJsb2NrOycgc3JjPSciICsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsICsKICAgICAgICAgICAgICAgICAgICAgICAgIicgLz4iCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZENhdGFsb2dzKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRhbG9nSGFuZGxlci5nZXQoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhdGFsb2dzID0gcmVzOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFkZENhdGFsb2coZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGxldCBncmlkID0ga2VuZG8ualF1ZXJ5KCIjZ3JpZENhdGFsb2ciKS5kYXRhKCJrZW5kb0dyaWQiKTsKICAgICAgICAgICAgbGV0IGRhdGFJdGVtID0gZ3JpZC5kYXRhSXRlbSgkKGUuY3VycmVudFRhcmdldCkuY2xvc2VzdCgidHIiKSk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhSXRlbSkKICAgICAgICAgICAgaWYgKGRhdGFJdGVtLnZhcmlhbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGRhdGFJdGVtLnZhcmlhbnRzLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobS5oYXNPd25Qcm9wZXJ0eSgidmFyaWFudCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtLnZhcmlhbnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZFNpbmdsZUl0ZW0obS52YXJpYW50LmlkLCAiaSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmRpYWxvZ0NhdGFsb2cgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGF0YUl0ZW0uc2VydmljZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgZGF0YUl0ZW0uc2VydmljZXMuZm9yRWFjaCgobSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChtLmhhc093blByb3BlcnR5KCJzZXJ2aWNlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uc2VydmljZS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkU2luZ2xlSXRlbShtLnNlcnZpY2UuaWQsICJzIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuZGlhbG9nQ2F0YWxvZyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBxb2hUZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICAgICAgICBjb25zdCBidW9tID0gZGF0YUl0ZW0uYnVvbSB8fCB7fTsKICAgICAgICAgICAgY29uc3QgcW9oID0gZGF0YUl0ZW0ucW9oIHx8IDA7CiAgICAgICAgICAgIGlmIChidW9tLmhhc093blByb3BlcnR5KCJuYW1lIikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBrZW5kby50b1N0cmluZyhxb2gsIGBuJHt0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsfWApICsgYCBgICsgYnVvbS5uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBgYDsKICAgICAgICB9LAogICAgICAgIEhlbHAoa2V5KSB7CiAgICAgICAgICAgIFNob3dSZXNvdXJjZShrZXkpOwogICAgICAgIH0sCiAgICAgICAgbnVtYmVyRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IGRhdGEtYmluZD0idmFsdWU6JyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9OdW1lcmljVGV4dEJveCh7CiAgICAgICAgICAgICAgICAgICAgZGVjaW1hbHM6IDMwLAogICAgICAgICAgICAgICAgICAgIG1pbjogMC4wMDAwMSwKICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6IGAke3RoaXMuc2FsZUZvcm1Db250ZW50LmRlY2ltYWx9YCwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFBheW1lbnRPcHRpb24oKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHBheW1lbnRPcHRpb25IYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgIC5saXN0KHN0ckZpbHRlcikKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXMuZGF0YS5kYXRhIHx8IFtdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXNoUGF5bWVudCA9IGRhdGEuZmlsdGVyKG0gPT4gbS50eXBlID09PSBQQVlNRU5UX09QSU5JT05fVFlQRS5DQVNIX1BBWU1FTlQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5iaWxsUGF5bWVudCA9IGRhdGEuZmlsdGVyKG0gPT4gbS50eXBlID09PSBQQVlNRU5UX09QSU5JT05fVFlQRS5CSUxMX1BBWU1FTlQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5xclBheW1lbnQgPSBkYXRhLmZpbHRlcihtID0+IG0udHlwZSA9PT0gUEFZTUVOVF9PUElOSU9OX1RZUEUuUVJfUEFZTUVOVCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJhbmtUcmFuc2ZlciA9IGRhdGEuZmlsdGVyKG0gPT4gbS50eXBlID09PSBQQVlNRU5UX09QSU5JT05fVFlQRS5CQU5LX1RSQU5TRkVSKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdmF0VGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgdmF0ID0gZGF0YUl0ZW0udmF0VGF4OwogICAgICAgICAgICBpZiAodmF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7dmF0LmRlZmF1bHRUYXggfHwgYGB9PC9zcGFuPmA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYGA7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1vZGlmaWVyVGVtcGxhdGUoZGF0YUl0ZW0pIHsKICAgICAgICAgICAgY29uc3QgbW9kaWZpZXIgPSBkYXRhSXRlbS5tb2RpZmllcjsKICAgICAgICAgICAgaWYgKG1vZGlmaWVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7bW9kaWZpZXIubmFtZSB8fCBgYH08L3NwYW4+YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBgYDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgaXRlbVRlbXBsYXRlKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhSXRlbS5pdGVtOwogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGA8c3Bhbj4ke2l0ZW0ubmFtZSA/IGl0ZW0ubmFtZSA6IGBgfTwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGBgOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBVT01UZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICAgICAgICBjb25zdCB1b20gPSBkYXRhSXRlbS51b207CiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSB1b20uY29kZSB8fCAnJwogICAgICAgICAgICBpZiAodW9tKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYDxzcGFuPiR7dW9tLnVvbSA/IGNvZGUgOiBgYH08L3NwYW4+YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBgYDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc2FsZVVuaXRUZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICAgICAgICBjb25zdCBzYWxlVW5pdCA9IGRhdGFJdGVtLnNhbGVVbml0OwogICAgICAgICAgICBpZiAoc2FsZVVuaXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBgPHNwYW4+JHtzYWxlVW5pdC5uYW1lID8gc2FsZVVuaXQubmFtZSA6IGBgfTwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGBgOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkaXNjb3VudEl0ZW1UZW1wbGF0ZShkYXRhSXRlbSkgewogICAgICAgICAgICBjb25zdCBkaXNjb3VudEl0ZW0gPSBkYXRhSXRlbS5kaXNjb3VudEl0ZW07CiAgICAgICAgICAgIGlmIChkaXNjb3VudEl0ZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBgPHNwYW4+JHtkaXNjb3VudEl0ZW0uY29kZSA/IGRpc2NvdW50SXRlbS5jb2RlIDogYGB9IC0gJHsKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudEl0ZW0ubmFtZSA/IGRpc2NvdW50SXRlbS5uYW1lIDogYGAKICAgICAgICAgICAgICAgIH08L3NwYW4+YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBgYDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWRkU2VsZWN0KCkgewogICAgICAgICAgICBsZXQgYW1vdW50X251bSA9IHRoaXMubnVtU2VsZWN0Lmxlbmd0aDsKICAgICAgICAgICAgbGV0IG51bSA9IHRoaXMubnVtU2VsZWN0W2Ftb3VudF9udW0gLSAxXTsKICAgICAgICAgICAgbGV0IG5ld19udW0gPSBudW0gKyAxOwogICAgICAgICAgICBsZXQgbGVuZ2h0SXRlbSA9IHRoaXMuc3BlY2lmaWNEaXNjb3VudEl0ZW0ubGVuZ3RoOwogICAgICAgICAgICBpZiAobmV3X251bSA8PSBsZW5naHRJdGVtKSB7CiAgICAgICAgICAgICAgICB0aGlzLm51bVNlbGVjdC5wdXNoKG5ld19udW0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZW1vdmVTZWxlY3QoaW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5udW1TZWxlY3Quc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGluZGV4LCB0aGlzLm51bVNlbGVjdCkKICAgICAgICAgICAgLy8gdGhpcy5zZWxlY3REaXNjb3VudC5zcGxpY2UoaW5kZXgsMSkKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCJyZW1vdmUiLHRoaXMuc2VsZWN0RGlzY291bnQpCiAgICAgICAgICAgIC8vIHRoaXMuc2VsZWN0RGlzY291bnQgPSB0aGlzLnNlbGVjdERpc2NvdW50LmZpbHRlcihpdGVtID0+ICBpdGVtLmlkICE9IHZhbC5pZCk7CiAgICAgICAgfSwKICAgICAgICBvbk90aGVyQ2hhcmdlQ2hhbmdlKCkgewogICAgICAgICAgICBsZXQgb3RoZXJDaGFyZ2UgPSAwLAogICAgICAgICAgICAgICAgYW1vdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLm90aGVyQ2hhcmdlTGluZSA9IFtdOwogICAgICAgICAgICB0aGlzLm1PdGhlckNoYXJnZS5mb3JFYWNoKChtKSA9PiB7CiAgICAgICAgICAgICAgICBhbW91bnQgPSB0aGlzLmF1dG9DYWxjdWxhdGVEaXNjb3VudChtLCB0aGlzLmludm9pY2Uuc3ViVG90YWwpOwogICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2UgKz0gYW1vdW50OwogICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLm90aGVyQ2hhcmdlTGluZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogbS5pZCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGFtb3VudCAqICh0aGlzLmludm9pY2UudHhuUmF0ZSB8fCAxKSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLm90aGVyQ2hhcmdlQW1vdW50ID0gb3RoZXJDaGFyZ2U7CiAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgIH0sCiAgICAgICAgb25PdGhlckFtb3VudCh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hdXRvQ2FsY3VsYXRlRGlzY291bnQodmFsdWUsIHRoaXMuaW52b2ljZS5zdWJUb3RhbCk7CiAgICAgICAgfSwKICAgICAgICBvblNwZWNpZmljRGlzY291bnRDaGFuZ2VkKCkgewogICAgICAgICAgICB0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsID0gMDsKICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSkgewogICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCctY2hhbmdlZCcsIHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSkKICAgICAgICAgICAgICAgIGNvbnN0IGRpc2NvdW50SW52b2ljZSA9IHRoaXMuYXV0b0NhbGN1bGF0ZURpc2NvdW50KAogICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSwKICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2Uuc3ViVG90YWwKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsID0ga2VuZG8ucGFyc2VGbG9hdCgKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudEludm9pY2UgPyBkaXNjb3VudEludm9pY2UgOiAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbGV0IHRvdGFsID0KICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS5zdWJUb3RhbCkgLQogICAgICAgICAgICAgICAgICAgIChrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS5kaXNjb3VudFRvdGFsKSArCiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnRvdGFsVGF4QW1vdW50KSkgLQogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50SW52b2ljZTsKICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS50b3RhbCA9IHRvdGFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZSgpOwogICAgICAgIH0sCiAgICAgICAgZW1wSW1wbChkYXRhSXRlbSkgewogICAgICAgICAgICBsZXQgZW1wSWRzID0gW107CiAgICAgICAgICAgIGRhdGFJdGVtLmVtcGxveWVlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgIGVtcElkcy5wdXNoKG0uZmlyc3ROYW1lICsgIiAtICIgKyBtLmxhc3ROYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhlbXBJZHMuam9pbignLCAnKSkKICAgICAgICAgICAgcmV0dXJuIGA8c3Bhbj4ke2VtcElkcy5qb2luKCIsICIpfTwvc3Bhbj5gOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFNhbGVGb3JtQ29udGVudCgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgc2FsZUZvcm1Db250ZW50SGFuZGxlci5saXN0KCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2FsZUZvcm1Db250ZW50ID0gZGF0YVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXREYXRhKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkU2FsZVVuaXRJdGVtcygpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgc2FsZVVuaXRJdGVtSGFuZGxlci5saXN0KCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbGVVbml0SXRlbUxpc3QgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHVvbVRtcChkYXRhSXRlbSkgewogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coZGF0YUl0ZW0pOwogICAgICAgICAgICByZXR1cm4gZGF0YUl0ZW07CiAgICAgICAgfSwKICAgICAgICBsb2FkSXRlbVVPTShpdGVtSWQsIHByaWNlTGV2ZWxJZCkgewogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coInAiLCBpdGVtSWQsIHByaWNlTGV2ZWxJZCk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVU9NUHJpY2UoaXRlbUlkLCBwcmljZUxldmVsSWQpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgdW9tUHJpY2VIYW5kbGVyLmdldChpdGVtSWQpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmljZXMgPSByZXMuZmlsdGVyKChtKSA9PiBtLnByaWNlTGV2ZWwuaWQgPT09IHByaWNlTGV2ZWxJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygicHJpY2UiLCBwcmljZXMsIGl0ZW1JZCwgcHJpY2VMZXZlbElkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVU9NTGlzdChpdGVtSWQpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgdW9tQ29udmVyc2lvbkhhbmRsZXIuZ2V0KGl0ZW1JZCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudW9tcyA9IHJlczsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJhbGwgVU9tIiwgcmVzKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBvbkludm9pY2VUeXBlQ2hhbmdlZCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gbnVsbCB8fCB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlbmVyYXRlTnVtYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZUhhbmRsZSgpOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVIYW5kbGUoKSB7CiAgICAgICAgICAgIGxldCB0ZW1wID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2UudHJhbnNhY3Rpb25UeXBlLm5hbWUgPT0gIkNvbW1lcmNpYWwgSW52b2ljZSIpIHsKICAgICAgICAgICAgICAgIHRlbXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IDAsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkNvbW1lcmNpYWwgSW52b2ljZSIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogIlRlbXBsYXRlIE9uZSIsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmludm9pY2UudHJhbnNhY3Rpb25UeXBlLm5hbWUgPT0gIkdlbmVyYWwgSW52b2ljZSIpIHsKICAgICAgICAgICAgICAgIHRlbXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IDAsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkdlbmVyYWwgSW52b2ljZSIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogIlRlbXBsYXRlIE9uZSIsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmludm9pY2UudHJhbnNhY3Rpb25UeXBlLm5hbWUgPT0gIlRheCBJbnZvaWNlIikgewogICAgICAgICAgICAgICAgdGVtcC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogMCwKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiVGF4IEludm9pY2UiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6ICJUZW1wbGF0ZSBPbmUiLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0ZW1wLnB1c2goewogICAgICAgICAgICAgICAgICAgIGlkOiAxLAogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJUYXggSW52b2ljZTIiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6ICJUZW1wbGF0ZSBUd28iLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZXNGb3JtID0gdGVtcDsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IDA7CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlVGF4QnlUeXBlKHRheCkgewogICAgICAgICAgICAvLyByZXR1cm4gYnkgYSBrZXkKICAgICAgICAgICAgY29uc3QgZ3JvdXBBbGwgPSAobGlzdCkgPT4KICAgICAgICAgICAgICAgIGxpc3QucmVkdWNlKCh0YXgsIGl0ZW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXhBbW91bnQgPSB0YXhbaXRlbS5uYW1lXSB8fCAwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCB0YXgsIHsKICAgICAgICAgICAgICAgICAgICAgICAgW2l0ZW0ubmFtZV06IHRheEFtb3VudCArIHBhcnNlRmxvYXQoaXRlbS5hbW91bnQpLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwge30pOwogICAgICAgICAgICB0aGlzLnRheExpc3RUb3RhbCA9IGdyb3VwQWxsKHRheCk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnbmltb2wnLCBncm91cEFsbCh0YXgpKQogICAgICAgIH0sCiAgICAgICAgb25EZXBvc2l0RGVkdWN0aW9uQ2hhbmdlKCkgewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICB0aGlzLmRlcG9zaXREZWR1Y3Rpb24gPT09ICIiIHx8CiAgICAgICAgICAgICAgICB0aGlzLmRlcG9zaXREZWR1Y3Rpb24gPT09IHVuZGVmaW5lZAogICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVwb3NpdERlZHVjdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24gPSAwCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygndGhpcy5kZXBvc2l0RGVkdWN0aW9uJywgdGhpcy5kZXBvc2l0RGVkdWN0aW9uKQogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3RoaXMuaW52b2ljZS5kZXBvc2l0RGVkdWN0aW9uJywgdGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24pCiAgICAgICAgICAgIGNvbnN0IGFtb3VudCA9IHBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnRvdGFsKSAtIHBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24pCiAgICAgICAgICAgIGNvbnN0IHhDaGFuZ2VBbW91bnQgPSBhbW91bnQgKiAodGhpcy5pbnZvaWNlLnR4blJhdGUgfHwgMSkKICAgICAgICAgICAgY29uc3QgZGVkdWN0aW9uID0gcGFyc2VGbG9hdCh0aGlzLmRlcG9zaXREZWR1Y3Rpb24pIHx8IDA7CiAgICAgICAgICAgIGNvbnN0IGRlcEEgPSBwYXJzZUZsb2F0KHRoaXMuaW52b2ljZS5kZXBvc2l0QW1vdW50KSB8fCAwCiAgICAgICAgICAgIGNvbnN0IHhBbW91bnQgPSBwYXJzZUZsb2F0KHhDaGFuZ2VBbW91bnQpIHx8IDAKICAgICAgICAgICAgbGV0IGRlZHVjdCA9IGRlZHVjdGlvbgogICAgICAgICAgICBpZiAoZGVkdWN0aW9uID4geEFtb3VudCkgewogICAgICAgICAgICAgICAgZGVkdWN0ID0geEFtb3VudAogICAgICAgICAgICAgICAgaWYgKGRlZHVjdCA+IGRlcEEpIHsKICAgICAgICAgICAgICAgICAgICBkZWR1Y3QgPSBkZXBBCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJzEnLCBkZWR1Y3QpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoZGVkdWN0ID4gZGVwQSkgewogICAgICAgICAgICAgICAgICAgIGRlZHVjdCA9IGRlcEEKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnMicsIGRlZHVjdCkKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlcG9zaXREZWR1Y3Rpb24gPSBwYXJzZUZsb2F0KGRlZHVjdCkKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24gPSBwYXJzZUZsb2F0KGRlZHVjdCk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygndGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24nLCBkZWR1Y3QpCiAgICAgICAgICAgIC8vIGlmIChkZWR1Y3Rpb24gPiB0aGlzLmludm9pY2UuZGVwb3NpdEFtb3VudCkgewogICAgICAgICAgICAvLyAgICAgdGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24gPSB0aGlzLmludm9pY2UuZGVwb3NpdEFtb3VudDsKICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAvLyBpZiAoZGVkdWN0aW9uID4gcGFyc2VGbG9hdCh0aGlzLmludm9pY2UuZXhjaGFuZ2VBbW91bnQpKSB7CiAgICAgICAgICAgIC8vICAgICB0aGlzLmludm9pY2UuZGVwb3NpdERlZHVjdGlvbiA9IHRoaXMuaW52b2ljZS5leGNoYW5nZUFtb3VudDsKICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3RoaXMuaW52b2ljZScsIHRoaXMuaW52b2ljZSkKICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlKCkgewogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKSwKICAgICAgICAgICAgICAgIHN1YlRvdGFsID0gMCwKICAgICAgICAgICAgICAgIHRvdGFsVGF4ID0gMCwKICAgICAgICAgICAgICAgIGRpc2NvdW50VG90YWwgPSAwLAogICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2VUb3RhbCA9IDAsCiAgICAgICAgICAgICAgICBzcFRheCA9IDAsCiAgICAgICAgICAgICAgICBwbHRheCA9IDAsCiAgICAgICAgICAgICAgICBvdGhlclRheCA9IDAsCiAgICAgICAgICAgICAgICB2YXRUYXggPSAwLAogICAgICAgICAgICAgICAgZGlzY291bnRJbnZvaWNlID0gMCwKICAgICAgICAgICAgICAgIHRheExpc3QgPSBbXSwKICAgICAgICAgICAgICAgIHRheExpc3REZXRhaWwgPSBbXSwKICAgICAgICAgICAgICAgIGRpc2NvdW50SXRlbSA9IFtdLAogICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2VJdGVtID0gW10sCiAgICAgICAgICAgICAgICBzYWxlVW5pdCA9IFtdLAogICAgICAgICAgICAgICAgaW5jbHVzaXZlVGF4ID0gMCwKICAgICAgICAgICAgICAgIGRpc2NvdW50TGluZSA9IFtdLAogICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2VMaW5lID0gW10sCiAgICAgICAgICAgICAgICBzYWxlVW5pdExpbmUgPSBbXSwKICAgICAgICAgICAgICAgIGl0ZW1TdWJ0b3RhbCA9IDAsCiAgICAgICAgICAgICAgICB0eG5JdG1TdWJ0b3RhbCA9IDAsCiAgICAgICAgICAgICAgICBzZXJ2aWNlU3VidG90YWwgPSAwLAogICAgICAgICAgICAgICAgaXRlbURpc2NvdW50ID0gMCwKICAgICAgICAgICAgICAgIHNlcnZpY2VEaXNjb3VudCA9IDAsCiAgICAgICAgICAgICAgICB0eG5EaXNjb3VudCA9IDA7CiAgICAgICAgICAgIGxldCBuYXR1cmUgPSAiIjsKICAgICAgICAgICAgdGhpcy5qUmF3ID0gW107CiAgICAgICAgICAgIGNvbnN0IHJvd3MgPSBkcy5kYXRhKCkuZmlsdGVyKChtKSA9PiBwYXJzZUZsb2F0KG0uYW1vdW50KSA+IDApOwogICAgICAgICAgICByb3dzLmZvckVhY2goKHZhbHVlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgbW9kaWZpZXJQcmljZSA9IDA7CiAgICAgICAgICAgICAgICBsZXQgdmF0U3BUYXggPSB7fSwgdmF0UExUYXggPSB7fSwgdmF0T3RoZXJUYXggPSB7fQogICAgICAgICAgICAgICAgaWYgKHZhbHVlLm1vZGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJQcmljZSA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUubW9kaWZpZXIucHJpY2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHN1YlRvdGFsICs9IChrZW5kby5wYXJzZUZsb2F0KHZhbHVlLmFtb3VudCkgKyBtb2RpZmllclByaWNlKQogICAgICAgICAgICAgICAgbGV0IGRpc2NvdW50ID0gMCwgb3RoZXJDaGFyZ2UgPSAwOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlLm90aGVyQ2hhcmdlSXRlbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YlRvdGFsID0ga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5wcmljZSkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RoZXJDaGFyZ2VGaWVsZCA9IHZhbHVlLm90aGVyQ2hhcmdlSXRlbSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSA9IHRoaXMuYXV0b0NhbGN1bGF0ZURpc2NvdW50KG90aGVyQ2hhcmdlRmllbGQsIHN1YlRvdGFsKQogICAgICAgICAgICAgICAgICAgIHZhbHVlWyJvdGhlckNoYXJnZUFtb3VudCJdID0gb3RoZXJDaGFyZ2U7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVbIm90aGVyQ2hhcmdlRXhjaGFuZ2VBbW91bnQiXSA9IG90aGVyQ2hhcmdlICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLm90aGVyQ2hhcmdlSXRlbS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZUl0ZW0ucHVzaCh2YWx1ZS5vdGhlckNoYXJnZUl0ZW0pOwogICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZUxpbmUucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdmFsdWUub3RoZXJDaGFyZ2VJdGVtLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWUub3RoZXJDaGFyZ2VJdGVtLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IG90aGVyQ2hhcmdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IG90aGVyQ2hhcmdlICogcGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSksCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ290aGVyQ2hhcmdlVG90YWwnLCBvdGhlckNoYXJnZSkKICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZVRvdGFsICs9IChvdGhlckNoYXJnZSB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXJDaGFyZ2UgKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXJDaGFyZ2VGaWVsZC5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdGhlckNoYXJnZUZpZWxkLmFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogb3RoZXJDaGFyZ2VGaWVsZC5hY2NvdW50LmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiT3RoZXIgQ2hhcmdlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBvdGhlckNoYXJnZUZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBvdGhlckNoYXJnZUZpZWxkLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBvdGhlckNoYXJnZSAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBvdGhlckNoYXJnZSAqIC0xICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogIm90aGVyQ2hhcmdlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZhbHVlLmRpc2NvdW50SXRlbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc0l0ZW1GaWVsZCA9IHZhbHVlLmRpc2NvdW50SXRlbTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJUbyA9IGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50ID0gdGhpcy5hdXRvQ2FsY3VsYXRlRGlzY291bnQodmFsdWUuZGlzY291bnRJdGVtLCBzdWJUbyk7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVbImRpc2NvdW50QW1vdW50Il0gPSBkaXNjb3VudDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsiZGlzY291bnRFeGNoYW5nZUFtb3VudCJdID0gZGlzY291bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3ZhbHVlJywgSlNPTi5zdHJpbmdpZnkodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5kaXNjb3VudEl0ZW0uaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzY291bnRJdGVtLnB1c2godmFsdWUuZGlzY291bnRJdGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzY291bnRMaW5lLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZhbHVlLmRpc2NvdW50SXRlbS5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHZhbHVlLmRpc2NvdW50SXRlbS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBkaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiBkaXNjb3VudCAqIHBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpLAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGlzY291bnRUb3RhbCArPSAoZGlzY291bnQgfHwgMCkKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzY291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc0l0ZW1GaWVsZC5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNJdGVtRmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkaXNJdGVtRmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJEaXNjb3VudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogZGlzSXRlbUZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkaXNJdGVtRmllbGQuYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGRpc2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJkaXNjb3VudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5zYWxlVW5pdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5zYWxlVW5pdC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzYWxlVW5pdC5wdXNoKHZhbHVlLnNhbGVVbml0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbV8gPSB2YWx1ZS5pdGVtIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbW91bnRfID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1PYmogPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRlbV8uaWQgfHwgIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBpdGVtXy5uYW1lIHx8ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBhbW91bnRfIC0gKGRpc2NvdW50IHx8IDApLAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBzYWxlVW5pdExpbmUucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lSWQ6IHZhbHVlLmlkIHx8ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZhbHVlLnNhbGVVbml0LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWUuc2FsZVVuaXQubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IGl0ZW1PYmosCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGl0ZW1PYmouYW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGl0ZW1PYmouYW1vdW50ICogKHRoaXMuaW52b2ljZS50eG5SYXRlIHx8IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY291bnQ6IGRpc2NvdW50IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZURpc2NvdW50OiAoZGlzY291bnQgfHwgMCkgKiAodGhpcy5pbnZvaWNlLnR4blJhdGUgfHwgMSksCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5zcGVjaWZpY1RheCkgewogICAgICAgICAgICAgICAgICAgIHNwVGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zcGVjaWZpY1RheCwKICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpIC0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHNwVGF4ID0ga2VuZG8ucGFyc2VGbG9hdChzcFRheCkgPyBrZW5kby5wYXJzZUZsb2F0KHNwVGF4KSA6IDA7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVbInNwZWNpZmljVGF4QW1vdW50Il0gPSBzcFRheDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsic3BlY2lmaWNUYXhFeGNoYW5nZUFtb3VudCJdID0KICAgICAgICAgICAgICAgICAgICAgICAgc3BUYXggKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS5zcGVjaWZpY1RheDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlQW1vdW50ID0gdGF4LmJhc2VBbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gImluY2x1c2l2ZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1c2l2ZVRheCArPSBzcFRheDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2codmFsdWUuc3BlY2lmaWNUYXgpCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLnNwZWNpZmljVGF4Lmhhc093blByb3BlcnR5KCJ0YXhUeXBlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGF4TGlzdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHZhbHVlLnNwZWNpZmljVGF4LnRheFR5cGUubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogc3BUYXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdmFsdWUuc3BlY2lmaWNUYXgudGF4VHlwZS5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwVGF4XyA9IHZhbHVlLnNwZWNpZmljVGF4IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNwVGF4X1sndGF4QW1vdW50J10gPSBzcFRheAogICAgICAgICAgICAgICAgICAgICAgICBzcFRheF9bJ3RheEFtb3VudF8nXSA9IHNwVGF4CiAgICAgICAgICAgICAgICAgICAgICAgIHNwVGF4X1snYW1vdW50J10gPSB2YWx1ZS5hbW91bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICBzcFRheF9bJ2Rpc2NvdW50J10gPSBkaXNjb3VudCB8fCAwCiAgICAgICAgICAgICAgICAgICAgICAgIHNwVGF4X1sndHhuUmF0ZSddID0gdGhpcy5pbnZvaWNlLnR4blJhdGUgfHwgMQogICAgICAgICAgICAgICAgICAgICAgICAvLyBkZWxldGUgdGF4X1snYWNjb3VudCddCiAgICAgICAgICAgICAgICAgICAgICAgIHRheExpc3REZXRhaWwucHVzaChzcFRheF8pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXRTcFRheCA9IHNwVGF4XwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoc3BUYXggKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVjaWZpY1RheEZpZWxkID0gdmFsdWUuc3BlY2lmaWNUYXg7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWNpZmljVGF4RmllbGQuYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNUYXhGaWVsZC5hY2NvdW50Lmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHNwZWNpZmljVGF4RmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJUYXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHNwZWNpZmljVGF4RmllbGQuYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwZWNpZmljVGF4RmllbGQuYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHNwVGF4ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwVGF4ICogLTEgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAidGF4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZhbHVlLnB1YmxpY0xpZ2h0aW5nVGF4KSB7CiAgICAgICAgICAgICAgICAgICAgcGx0YXggPSB0aGlzLmF1dG9DYWxjdWxhdGVUYXgoCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1YmxpY0xpZ2h0aW5nVGF4LAogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLmFtb3VudCkgLSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgcGx0YXggPSBrZW5kby5wYXJzZUZsb2F0KHBsdGF4KSA/IGtlbmRvLnBhcnNlRmxvYXQocGx0YXgpIDogMDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsicHVibGljTGlnaHRpbmdUYXhBbW91bnQiXSA9IHBsdGF4OwogICAgICAgICAgICAgICAgICAgIHZhbHVlWyJwdWJsaWNMaWdodGluZ1RheEV4Y2hhbmdlQW1vdW50Il0gPQogICAgICAgICAgICAgICAgICAgICAgICBwbHRheCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRheCA9IHZhbHVlLnB1YmxpY0xpZ2h0aW5nVGF4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VBbW91bnQgPSB0YXguYmFzZUFtb3VudDsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PSAiaW5jbHVzaXZlIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVzaXZlVGF4ICs9IHBsdGF4OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5wdWJsaWNMaWdodGluZ1RheC5oYXNPd25Qcm9wZXJ0eSgidGF4VHlwZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRheExpc3QucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB2YWx1ZS5wdWJsaWNMaWdodGluZ1RheC50YXhUeXBlLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHBsdGF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZhbHVlLnB1YmxpY0xpZ2h0aW5nVGF4LnRheFR5cGUuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbFRheF8gPSB2YWx1ZS5wdWJsaWNMaWdodGluZ1RheCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICAvLyBwbFRheF9bJ3RheEFtb3VudCddID0gcGx0YXgKICAgICAgICAgICAgICAgICAgICAgICAgcGxUYXhfWyd0YXhBbW91bnRfJ10gPSBwbHRheAogICAgICAgICAgICAgICAgICAgICAgICBwbFRheF9bJ2Ftb3VudCddID0gdmFsdWUuYW1vdW50IHx8IDAKICAgICAgICAgICAgICAgICAgICAgICAgcGxUYXhfWydkaXNjb3VudCddID0gZGlzY291bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICBwbFRheF9bJ3R4blJhdGUnXSA9IHRoaXMuaW52b2ljZS50eG5SYXRlIHx8IDEKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGVsZXRlIHRheF9bJ2FjY291bnQnXQogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0RGV0YWlsLnB1c2gocGxUYXhfKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmF0UExUYXggPSBwbFRheF8KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHBsdGF4ICogLTEgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgUExUYXhGaWVsZCA9IHZhbHVlLnB1YmxpY0xpZ2h0aW5nVGF4OwogICAgICAgICAgICAgICAgICAgIGlmIChQTFRheEZpZWxkLmFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFBMVGF4RmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBQTFRheEZpZWxkLmFjY291bnQuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiVGF4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBQTFRheEZpZWxkLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBQTFRheEZpZWxkLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBwbHRheCAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbHRheCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogInRheCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5vdGhlclRheCkgewogICAgICAgICAgICAgICAgICAgIG90aGVyVGF4ID0gdGhpcy5hdXRvQ2FsY3VsYXRlVGF4KAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5vdGhlclRheCwKICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpIC0ga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG90aGVyVGF4ID0ga2VuZG8ucGFyc2VGbG9hdChvdGhlclRheCkKICAgICAgICAgICAgICAgICAgICAgICAgPyBrZW5kby5wYXJzZUZsb2F0KG90aGVyVGF4KQogICAgICAgICAgICAgICAgICAgICAgICA6IDA7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVbIm90aGVyVGF4QW1vdW50Il0gPSBvdGhlclRheDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsib3RoZXJUYXhFeGNoYW5nZUFtb3VudCJdID0KICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJUYXggKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS5vdGhlclRheDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlQW1vdW50ID0gdGF4LmJhc2VBbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0gImluY2x1c2l2ZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1c2l2ZVRheCArPSBvdGhlclRheDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUub3RoZXJUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWUub3RoZXJUYXgudGF4VHlwZS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBvdGhlclRheCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB2YWx1ZS5vdGhlclRheC50YXhUeXBlLmlkLAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGF4X18gPSB2YWx1ZS5vdGhlclRheCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0YXhfX1sndGF4QW1vdW50J10gPSBvdGhlclRheAogICAgICAgICAgICAgICAgICAgICAgICB0YXhfX1sndGF4QW1vdW50XyddID0gb3RoZXJUYXgKICAgICAgICAgICAgICAgICAgICAgICAgdGF4X19bJ2Ftb3VudCddID0gdmFsdWUuYW1vdW50IHx8IDAKICAgICAgICAgICAgICAgICAgICAgICAgdGF4X19bJ2Rpc2NvdW50J10gPSBkaXNjb3VudCB8fCAwCiAgICAgICAgICAgICAgICAgICAgICAgIHRheF9fWyd0eG5SYXRlJ10gPSB0aGlzLmludm9pY2UudHhuUmF0ZSB8fCAxCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSB0YXhfWydhY2NvdW50J10KICAgICAgICAgICAgICAgICAgICAgICAgdGF4TGlzdERldGFpbC5wdXNoKHRheF9fKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmF0T3RoZXJUYXggPSB0YXhfXwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXJUYXggKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGhlclRheEZpZWxkID0gdmFsdWUub3RoZXJUYXg7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyVGF4RmllbGQuYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXJUYXhGaWVsZC5hY2NvdW50Lmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG90aGVyVGF4RmllbGQuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJUYXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IG90aGVyVGF4RmllbGQuYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IG90aGVyVGF4RmllbGQuYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IG90aGVyVGF4ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyVGF4ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSkgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAidGF4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXgpIHsKICAgICAgICAgICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ1ZhdCBUYXgnLCB2YWx1ZS52YXRUYXgpCiAgICAgICAgICAgICAgICAgICAgbGV0IGFtdCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQoc3BUYXggPyBzcFRheCA6IDApICsKICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChwbHRheCA/IHBsdGF4IDogMCkgKwogICAgICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KG90aGVyVGF4ID8gb3RoZXJUYXggOiAwKSArCiAgICAgICAgICAgICAgICAgICAgICAgIChrZW5kby5wYXJzZUZsb2F0KHZhbHVlLmFtb3VudCA/IHZhbHVlLmFtb3VudCA6IDApIC0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIChkaXNjb3VudCA/IGRpc2NvdW50IDogMCkpOwogICAgICAgICAgICAgICAgICAgIHZhdFRheCA9IHRoaXMuYXV0b0NhbGN1bGF0ZVRheCh2YWx1ZS52YXRUYXgsIGFtdCk7CiAgICAgICAgICAgICAgICAgICAgdmF0VGF4ID0ga2VuZG8ucGFyc2VGbG9hdCh2YXRUYXgpID8ga2VuZG8ucGFyc2VGbG9hdCh2YXRUYXgpIDogMDsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVsidmF0VGF4QW1vdW50Il0gPSB2YXRUYXg7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVbInZhdFRheEV4Y2hhbmdlQW1vdW50Il0gPQogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXggKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXggPSB2YWx1ZS52YXRUYXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZUFtb3VudCA9IHRheC5iYXNlQW1vdW50OwogICAgICAgICAgICAgICAgICAgIGlmIChiYXNlQW1vdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkgPT09ICJpbmNsdXNpdmUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdXNpdmVUYXggKz0gdmF0VGF4OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS52YXRUYXguaGFzT3duUHJvcGVydHkoInRheFR5cGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWUudmF0VGF4LnRheFR5cGUubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdmF0VGF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZhbHVlLnZhdFRheC50YXhUeXBlLmlkLAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmF0VGF4XyA9IHZhbHVlLnZhdFRheCB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YXRUYXhfWyd0YXhBbW91bnQnXSA9IHZhdFRheAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWyd0YXhBbW91bnRfJ10gPSB2YXRUYXgKICAgICAgICAgICAgICAgICAgICAgICAgdmF0VGF4X1snYW1vdW50J10gPSB2YWx1ZS5hbW91bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWydkaXNjb3VudCddID0gZGlzY291bnQgfHwgMAogICAgICAgICAgICAgICAgICAgICAgICB2YXRUYXhfWyd0eG5SYXRlJ10gPSB0aGlzLmludm9pY2UudHhuUmF0ZSB8fCAxCiAgICAgICAgICAgICAgICAgICAgICAgIHZhdFRheF9bJ2lzVmF0J10gPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIHZhdFRheF8uZGV0YWlsID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNUYXg6IHZhdFNwVGF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVibGljTGlnaHRpbmdUYXg6IHZhdFBMVGF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJUYXg6IHZhdE90aGVyVGF4LAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSB0YXhfWydhY2NvdW50J10KICAgICAgICAgICAgICAgICAgICAgICAgdGF4TGlzdERldGFpbC5wdXNoKHZhdFRheF8pOwoKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh2YXRUYXggKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImRyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCB2YXRUYXhGaWVsZCA9IHZhbHVlLnZhdFRheDsKICAgICAgICAgICAgICAgICAgICBpZiAodmF0VGF4RmllbGQuYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmF0VGF4RmllbGQuYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB2YXRUYXhGaWVsZC5hY2NvdW50LmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIlRheCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogdmF0VGF4RmllbGQuYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHZhdFRheEZpZWxkLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiB2YXRUYXggKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmF0VGF4ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSkgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAidGF4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmF0U3BUYXggPSB7fSwgdmF0UExUYXggPSB7fSAsIHZhdE90aGVyVGF4ID0ge30KICAgICAgICAgICAgICAgIHRvdGFsVGF4ICs9CiAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzcFRheCA/IHNwVGF4IDogMCkgKwogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQocGx0YXggPyBwbHRheCA6IDApICsKICAgICAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KG90aGVyVGF4ID8gb3RoZXJUYXggOiAwKSArCiAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YXRUYXggPyB2YXRUYXggOiAwKTsKICAgICAgICAgICAgICAgIHN1YlRvdGFsICs9CiAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpICsgbW9kaWZpZXJQcmljZSAtIGluY2x1c2l2ZVRheDsKICAgICAgICAgICAgICAgIGNvbnN0IGFtdCA9CiAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5hbW91bnQpICsgbW9kaWZpZXJQcmljZSAtIGluY2x1c2l2ZVRheDsKICAgICAgICAgICAgICAgIGNvbnN0IHhBbW91bnQgPQogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQoYW10KSAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpICogLTE7CiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gdmFsdWUuaXRlbTsKICAgICAgICAgICAgICAgIGNvbnN0IGl0bVR5cGUgPSBpdGVtLnR5cGUgfHwgIiI7CiAgICAgICAgICAgICAgICBpZiAoaXRtVHlwZSA9PT0gIlZhcmlhbnQiKSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVN1YnRvdGFsICs9CiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgICAgICAgICAgIGl0ZW1EaXNjb3VudCArPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRtVHlwZSA9PT0gIlNlcnZpY2UiKSB7CiAgICAgICAgICAgICAgICAgICAgc2VydmljZVN1YnRvdGFsICs9CiAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucHJpY2UpICoga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5xdHkpOwogICAgICAgICAgICAgICAgICAgIGl0ZW1EaXNjb3VudCArPSBrZW5kby5wYXJzZUZsb2F0KGRpc2NvdW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgKz0KICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh2YWx1ZS5wcmljZSkgKiBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnF0eSk7CiAgICAgICAgICAgICAgICAgICAgaXRlbURpc2NvdW50ICs9IGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNvbnZlcnNpb25SYXRlID0gdmFsdWUuY29udmVyc2lvblJhdGUgfHwgMTsKICAgICAgICAgICAgICAgIGNvbnN0IGJRdHkgPSBwYXJzZUZsb2F0KHZhbHVlLnF0eSAqIGNvbnZlcnNpb25SYXRlKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdhYyA9IHBhcnNlRmxvYXQodmFsdWUud2FjKSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3QgaXRlbUFtb3VudCA9IHBhcnNlRmxvYXQoYlF0eSkgKiB3YWM7CiAgICAgICAgICAgICAgICAvLyBjb25zdCBpdGVteEFtb3VudCA9IGl0ZW1BbW91bnQKICAgICAgICAgICAgICAgIGlmIChhbXQgKiAtMSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiZHIiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS50eXBlID09PSAiU2VydmljZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmlzUGxhbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaGFzT3duUHJvcGVydHkoImRlZmVycmVkSW5jb21lQWNjIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5kZWZlcnJlZEluY29tZUFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVmZXJyZWRJbkFjYyA9IGl0ZW0uZGVmZXJyZWRJbmNvbWVBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkZWZlcnJlZEluQWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuaW52b2ljZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGRlZmVycmVkSW5BY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGRlZmVycmVkSW5BY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtdCAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHhBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluY29tZUFjYyA9IGl0ZW0uaW5jb21lQWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaGFzT3duUHJvcGVydHkoImluY29tZUFjYyIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaW5jb21lQWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpbmNvbWVBY2MuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5pbnZvaWNlLmpvdXJuYWxOb3RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogaW5jb21lQWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpbmNvbWVBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtdCAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHhBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2hCYXNpYzogMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gIlZhcmlhbnQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJpbmNvbWVBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaW5jb21lQWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluY29tZUFjYyA9IGl0ZW0uaW5jb21lQWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGluY29tZUFjYy5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5pbnZvaWNlLmpvdXJuYWxOb3RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmluY29tZUFjYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmluY29tZUFjYy5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBhbXQgKiAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHhBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2hCYXNpYzogMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJpbnZlbnRvcnlBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaW52ZW50b3J5QWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGludmVudG9yeUFjYyA9IGl0ZW0uaW52ZW50b3J5QWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGludmVudG9yeUFjYy5pZCArICItIiArICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuaW52b2ljZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogaXRlbS5pbnZlbnRvcnlBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogaXRlbS5pbnZlbnRvcnlBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCAqIC0xLCAvLyBxdHkqYXZnX2Nvc3QgLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogaXRlbUFtb3VudCAqIC0xLCAvL3hBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogIml0ZW0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJjb3N0T2ZHb29kc1NvbGRBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uY29zdE9mR29vZHNTb2xkQWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNvc3RPZkdvb2RzU29sZEFjYyA9IGl0ZW0uY29zdE9mR29vZHNTb2xkQWNjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGNvc3RPZkdvb2RzU29sZEFjYy5pZCArICItIiArICJkciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuaW52b2ljZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogaXRlbS5jb3N0T2ZHb29kc1NvbGRBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogaXRlbS5jb3N0T2ZHb29kc1NvbGRBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogaXRlbUFtb3VudCwgLy8gcXR5KmF2Z19jb3N0ICwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IGl0ZW1BbW91bnQsIC8veEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImRyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtLnR5cGUgPT09ICJGaXhlZCBBc3NldCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaGFzT3duUHJvcGVydHkoImFzc2V0QWNjIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmFzc2V0QWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFzc2V0QWNjID0gaXRlbS5hc3NldEFjYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBhc3NldEFjYy5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwodmFsdWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5pbnZvaWNlLmpvdXJuYWxOb3RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmFzc2V0QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uYXNzZXRBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW10ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB4QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogIml0ZW0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtLnR5cGUgPT09ICJUcmFuc2FjdGlvbiBJdGVtIikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5oYXNPd25Qcm9wZXJ0eSgiYWNjb3VudCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5hY2NvdW50Lmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRlbS5hY2NvdW50LmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLmludm9pY2Uuam91cm5hbE5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW10ICogLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OiB4QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogIml0ZW0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9pbmNsdWRlIFRheCBBbW91bnQKICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudE5vZGlzY291bnQgPSBrZW5kby5wYXJzZUZsb2F0KHZhbHVlLnByaWNlKSAqIGtlbmRvLnBhcnNlRmxvYXQodmFsdWUucXR5KSAtIGRpc2NvdW50OwogICAgICAgICAgICAgICAgY29uc3QgaW5jbHVkZVRheEFtb3VudCA9IGFtb3VudE5vZGlzY291bnQgKyB2YXRUYXggKyBwbHRheCArIHNwVGF4ICsgb3RoZXJUYXg7CiAgICAgICAgICAgICAgICB2YWx1ZVsiaW5jbHVkZVRheEFtb3VudCJdID0gaW5jbHVkZVRheEFtb3VudDsKICAgICAgICAgICAgICAgIHZhbHVlWyJpbmNsdWRlVGF4RXhjaGFuZ2VBbW91bnQiXSA9IGluY2x1ZGVUYXhBbW91bnQgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5pdGVtU3VidG90YWwgPSBpdGVtU3VidG90YWw7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5leGNoYW5nZUl0ZW1TdWJ0b3RhbCA9CiAgICAgICAgICAgICAgICBpdGVtU3VidG90YWwgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnNlcnZpY2VTdWJ0b3RhbCA9IHNlcnZpY2VTdWJ0b3RhbDsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmV4Y2hhbmdlU2VydmljZVN1YnRvdGFsID0KICAgICAgICAgICAgICAgIHNlcnZpY2VTdWJ0b3RhbCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpOwogICAgICAgICAgICB0aGlzLmludm9pY2UudHhuSXRtU3VidG90YWwgPSB0eG5JdG1TdWJ0b3RhbDsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmV4Y2hhbmdlVHhuSXRtU3VidG90YWwgPQogICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWwgKiBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLml0ZW1EaXNjb3VudCA9IGl0ZW1EaXNjb3VudDsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmV4Y2hhbmdlSXRlbURpc2NvdW50ID0KICAgICAgICAgICAgICAgIGl0ZW1EaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpOwogICAgICAgICAgICB0aGlzLmludm9pY2Uuc2VydmljZURpc2NvdW50ID0gc2VydmljZURpc2NvdW50OwogICAgICAgICAgICB0aGlzLmludm9pY2UuZXhjaGFuZ2VTZXJ2aWNlRGlzY291bnQgPQogICAgICAgICAgICAgICAgc2VydmljZURpc2NvdW50ICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSk7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS50eG5JdG1EaXNjb3VudCA9IHR4bkRpc2NvdW50OwogICAgICAgICAgICB0aGlzLmludm9pY2UuZXhjaGFuZ2VUeG5JdG1EaXNjb3VudCA9CiAgICAgICAgICAgICAgICB0eG5EaXNjb3VudCAqIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpOwogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coc3BUYXgsIHBsdGF4LCBvdGhlclRheCwgdmF0VGF4KQogICAgICAgICAgICBsZXQgdG90YWwgPQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChzdWJUb3RhbCkgLQogICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdChkaXNjb3VudFRvdGFsKSArCiAgICAgICAgICAgICAgICBrZW5kby5wYXJzZUZsb2F0KHRvdGFsVGF4KTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnN1YlRvdGFsID0gc3ViVG90YWw7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5leGNoYW5nZVN1YlRvdGFsID0KICAgICAgICAgICAgICAgIHN1YlRvdGFsICogcGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSk7CiAgICAgICAgICAgIC8vICQoIiNzdWJ0b3RhbCIpLnRleHQoa2VuZG8ucGFyc2VGbG9hdChzdWJUb3RhbCkpCiAgICAgICAgICAgIHRoaXMuaW52b2ljZS50b3RhbFRheEFtb3VudCA9IGtlbmRvLnBhcnNlRmxvYXQodG90YWxUYXgpOwogICAgICAgICAgICB0aGlzLmludm9pY2UuZGlzY291bnRUb3RhbCA9IGtlbmRvLnBhcnNlRmxvYXQoZGlzY291bnRUb3RhbCk7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5vdGhlckNoYXJnZVRvdGFsID0ga2VuZG8ucGFyc2VGbG9hdChvdGhlckNoYXJnZVRvdGFsKTsKICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSkgewogICAgICAgICAgICAgICAgZGlzY291bnRJbnZvaWNlID0gdGhpcy5hdXRvQ2FsY3VsYXRlRGlzY291bnQoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnNwZWNpZmljRGlzY291bnRJdGVtLAogICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQoc3ViVG90YWwpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgZGlzY291bnRJbnZvaWNlID0gZGlzY291bnRJbnZvaWNlID8gZGlzY291bnRJbnZvaWNlIDogMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGlzLm9uT3RoZXJDaGFyZ2VDaGFuZ2UoKQogICAgICAgICAgICB0aGlzLmludm9pY2UudG90YWwgPSBrZW5kby5wYXJzZUZsb2F0KHRvdGFsKSAtIGRpc2NvdW50SW52b2ljZSArIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLm90aGVyQ2hhcmdlQW1vdW50KSArIG90aGVyQ2hhcmdlVG90YWw7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5yZW1haW5pbmdBbW91bnQgPSBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50b3RhbCkgLSBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS5kZXBvc2l0RGVkdWN0aW9uKTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmFtb3VudER1ZSA9IGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnRvdGFsKSAtIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb24pOwogICAgICAgICAgICB0aGlzLmludm9pY2UuZXhjaGFuZ2VBbW91bnQgPSBrZW5kby5wYXJzZUZsb2F0KHRoaXMuaW52b2ljZS5hbW91bnREdWUpICoga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSk7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygnRXhjaGFuZ2UgQW1vdW50JywgdGhpcy5pbnZvaWNlLmV4Y2hhbmdlQW1vdW50KQogICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGVUYXhCeVR5cGUodGF4TGlzdCk7CiAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudEl0ZW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWNpZmljRGlzY291bnQgPSB0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudEl0ZW0gfHwge307CiAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjb3VudC5pZCkgewogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50SXRlbS5wdXNoKHNwZWNpZmljRGlzY291bnQpOwogICAgICAgICAgICAgICAgICAgIGRpc2NvdW50TGluZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHNwZWNpZmljRGlzY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHNwZWNpZmljRGlzY291bnQubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiB0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwgKiB0aGlzLmludm9pY2UudHhuUmF0ZSwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB1bmlxdWVEaXNjb3VudEl0ZW0gPSB0aGlzLnJlbW92ZUR1cGxpY2F0ZShkaXNjb3VudEl0ZW0pOwogICAgICAgICAgICB0aGlzLnNocmlua0Rpc2NvdW50SXRlbSh1bmlxdWVEaXNjb3VudEl0ZW0sIGRpc2NvdW50TGluZSk7CgogICAgICAgICAgICBjb25zdCB1bmlxdWVPdGhlckNoYXJnZSA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKG90aGVyQ2hhcmdlSXRlbSk7CiAgICAgICAgICAgIHRoaXMuc2hyaW5rT3RoZXJDaGFyZ2VJdGVtKHVuaXF1ZU90aGVyQ2hhcmdlLCBvdGhlckNoYXJnZUxpbmUpOwoKICAgICAgICAgICAgdGhpcy5jdXN0b21lclNhbGVVbml0ID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUoc2FsZVVuaXQpOwogICAgICAgICAgICB0aGlzLmN1c3RvbWVyU2FsZVVuaXRMaW5lID0gc2FsZVVuaXRMaW5lOyAvL3RoaXMucmVtb3ZlRHVwbGljYXRlKHNhbGVVbml0KQogICAgICAgICAgICB0aGlzLnRheExpc3REZXRhaWwgPSB0YXhMaXN0RGV0YWlsCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygndGF4TGlzdERldGFpbC0tJywgdGF4TGlzdERldGFpbCkKICAgICAgICAgICAgLy8gdG9kbzogcmF3IEpvdXJuYWwKICAgICAgICAgICAgY29uc3QgcmVjZWl2YWJsZUFjYyA9IHRoaXMuaW52b2ljZS5yZWNlaXZhYmxlQWNjIHx8IHt9OwogICAgICAgICAgICBpZiAodGhpcy5pbnZvaWNlLmFtb3VudER1ZSA+IDApIHsKICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWNlaXZhYmxlQWNjKSB7CiAgICAgICAgICAgICAgICBpZiAocmVjZWl2YWJsZUFjYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHJlY2VpdmFibGVBY2MuaWQgKyAiLSIgKyBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpbmU6IG5ldyBJdGVtTGluZU1vZGVsKHt9KSwKICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuaW52b2ljZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogcmVjZWl2YWJsZUFjYywKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiByZWNlaXZhYmxlQWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogdGhpcy5pbnZvaWNlLmV4Y2hhbmdlQW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHRoaXMuaW52b2ljZS5hbW91bnREdWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiYXIiLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHNwZWNpZmljRGlzYyA9IHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbTsKICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50VG90YWwgPiAwKSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiZHIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjKSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjLmhhc093blByb3BlcnR5KCJhY2NvdW50IikpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjLmFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWNpZmljRGlzYy5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBzcGVjaWZpY0Rpc2MuYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJEaXNjb3VudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogc3BlY2lmaWNEaXNjLmFjY291bnQgfHwge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBzcGVjaWZpY0Rpc2MuYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2VuZG8ucGFyc2VGbG9hdCh0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsKSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogdGhpcy5pbnZvaWNlLnNwZWNpZmljRGlzY291bnRUb3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiZGlzY291bnQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2UuZGVwb3NpdERlZHVjdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYXR1cmUgPSAiY3IiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5leGNoYW5nZURlcG9zaXREZWR1Y3Rpb24gPQogICAgICAgICAgICAgICAgKHRoaXMuaW52b2ljZS50eG5SYXRlIHx8IDApICogdGhpcy5pbnZvaWNlLmRlcG9zaXREZWR1Y3Rpb247CiAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2UuZGVwb3NpdERlZHVjdGlvbikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS5kZXBvc2l0RGVkdWN0aW9uID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNhbGVEZXBvc2l0QWNjID0gdGhpcy5jdXN0b21lci5zYWxlRGVwb3NpdEFjYyB8fCB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2FsZURlcG9zaXRBY2MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNhbGVEZXBvc2l0QWNjLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHNhbGVEZXBvc2l0QWNjLmlkICsgIi0iICsgbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiRGVwb3NpdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwoe30pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHNhbGVEZXBvc2l0QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogc2FsZURlcG9zaXRBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VBbW91bnQ6IHRoaXMuaW52b2ljZS5leGNoYW5nZURlcG9zaXREZWR1Y3Rpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiB0aGlzLmludm9pY2UuZGVwb3NpdERlZHVjdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBuYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiZGVwb3NpdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5tT3RoZXJDaGFyZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgbGV0IG90aGVyQ2hhcmdlID0gMDsKICAgICAgICAgICAgICAgIHRoaXMubU90aGVyQ2hhcmdlLmZvckVhY2goKG0pID0+IHsKICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSA9IHRoaXMuYXV0b0NhbGN1bGF0ZURpc2NvdW50KG0sIHRoaXMuaW52b2ljZS5zdWJUb3RhbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyQ2hhcmdlICogLTEgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hdHVyZSA9ICJkciI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF0dXJlID0gImNyIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uaGFzT3duUHJvcGVydHkoImFjY291bnQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0uYWNjb3VudC5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY291bnQgPSBtLmFjY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogYWNjb3VudC5pZCArICItIiArIG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJPdGhlciBDaGFyZ2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBhY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlQW1vdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZSAqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlbmRvLnBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpICoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBvdGhlckNoYXJnZSAqIC0xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJvdGhlckNoYXJnZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gdGhpcy5pbnZvaWNlLm90aGVyQ2hhcmdlQW1vdW50ID0gb3RoZXJDaGFyZ2UKCiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2codGhpcy5tT3RoZXJDaGFyZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXV0b0NhbGN1bGF0ZVRheERldGFpbCgpOwogICAgICAgICAgICAvLyB0b2RvOiBlbmQgcmF3IEpvdXJuYWwKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHRoaXMuYWNjb3VudHMpLCAnYWNjb3VudHMnKQogICAgICAgICAgICB0aGlzLnNocmlua0RhdGEodGhpcy5qUmF3KTsKICAgICAgICAgICAgLy8gY29uc3QgdW5pcXVlID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUodGhpcy5hY2NvdW50cykKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHVuaXF1ZSwgJ3VuaXF1ZScpCiAgICAgICAgfSwKICAgICAgICBzaHJpbmtEYXRhKG9iaikgewogICAgICAgICAgICBjb25zdCB1bmlxdWVzID0gdGhpcy5yZW1vdmVEdXBsaWNhdGUoCiAgICAgICAgICAgICAgICBvYmoKICAgICAgICAgICAgKTsgLypbLi4ubmV3IFNldChhY2NvdW50SWQubWFwKGkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICBpZF86IGkuaWRfLAogICAgICAgICAgICAgICAgICAgIGlkOiBpLmlkLAogICAgICAgICAgICAgICAgICAgIHR5cGU6IGkudHlwZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSldKi8KICAgICAgICAgICAgLyogdG9kbzogY2FzaCBiYXNpYyBhY2NvdW50ICovCiAgICAgICAgICAgIGxldCBjYXNoQmFzaWNBbW91bnQgPSAwCiAgICAgICAgICAgIGxldCB4Q2FzaEJhc2ljQW1vdW50ID0gMAogICAgICAgICAgICB0aGlzLmludm9pY2UuY2FzaEJhc2ljSW5jb21lQWNjID0gW10KICAgICAgICAgICAgbGV0IGNhc2hCYXNpY0FjYyA9IHVuaXF1ZXMuZmlsdGVyKG0gPT4gbS5jYXNoQmFzaWMgPT09IDEpCiAgICAgICAgICAgIGNhc2hCYXNpY0FjYy5mb3JFYWNoKGsgPT4gewogICAgICAgICAgICAgICAgY2FzaEJhc2ljQW1vdW50ICs9IGsuYW1vdW50CiAgICAgICAgICAgICAgICB4Q2FzaEJhc2ljQW1vdW50ICs9IGsuZXhjaGFuZ2VBbW91bnQKICAgICAgICAgICAgfSkKICAgICAgICAgICAgY2FzaEJhc2ljQWNjLm1hcChvID0+IHsKICAgICAgICAgICAgICAgIG9bJ2Ftb3VudFBlcmNlbnRhZ2UnXSA9IG8uYW1vdW50IC8gY2FzaEJhc2ljQW1vdW50CiAgICAgICAgICAgICAgICBvWyd4QW1vdW50UGVyY2VudGFnZSddID0gby5leGNoYW5nZUFtb3VudCAvIHhDYXNoQmFzaWNBbW91bnQKICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmNhc2hCYXNpY0luY29tZUFjYyA9IGNhc2hCYXNpY0FjYwogICAgICAgICAgICAvKiB0b2RvOiBlbmQgKi8KICAgICAgICAgICAgdW5pcXVlcy5mb3JFYWNoKChuKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBmb3VuZCA9IG9iai5maWx0ZXIoKG0pID0+IG0uaWQgPT09IG4uaWQpOwogICAgICAgICAgICAgICAgbGV0IGFtb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICBmb3VuZC5mb3JFYWNoKCh6KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ICs9IHBhcnNlRmxvYXQoei5hbW91bnQgfHwgMCk7CiAgICAgICAgICAgICAgICAgICAgeEFtb3VudCArPSBwYXJzZUZsb2F0KHouZXhjaGFuZ2VBbW91bnQgfHwgMCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG4uYW1vdW50ID0gcGFyc2VGbG9hdChhbW91bnQpOyAvL3RoaXMubnVtYmVyRm9ybWF0KGFtb3VudCkKICAgICAgICAgICAgICAgIG4uZXhjaGFuZ2VBbW91bnQgPSBwYXJzZUZsb2F0KHhBbW91bnQpOyAvL3BhcnNlRmxvYXQocGFyc2VGbG9hdChhbW91bnQgKiBwYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKSkpIC8vdGhpcy5udW1iZXJGb3JtYXQoYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSkpIC8vLnRvRml4ZWQodGhpcy5zYWxlRm9ybUNvbnRlbnQuZGVjaW1hbCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMualJhdyA9IHVuaXF1ZXM7CiAgICAgICAgICAgIGxldCBkciA9IDAsCiAgICAgICAgICAgICAgICBjciA9IDA7CiAgICAgICAgICAgIHRoaXMualJhdy5mb3JFYWNoKChqKSA9PiB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGoudHlwZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImNyIjoKICAgICAgICAgICAgICAgICAgICAgICAgY3IgKz0gcGFyc2VGbG9hdChqLmFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgZHIgKz0gcGFyc2VGbG9hdChqLmFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmRyID0gZHI7CiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5jciA9IGNyOwogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coImRyPSIsIGRyLCAiY3I9IiwgY3IsICJkcitjciA9ICIsIGRyICsgY3IpOwogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkodW5pcXVlcyksICJ1bmlxdWVzIik7CiAgICAgICAgfSwKICAgICAgICByYXdGb3JKb3VybmFsKCkgewogICAgICAgICAgICAvL3RvZG86IERSIHNpZGUgYWNjb3VudCByZWNlaXZhYmxlCiAgICAgICAgICAgIGxldCBpdGVtTGluZURTID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCk7CiAgICAgICAgICAgIGNvbnN0IGRhdGFSb3cgPSBpdGVtTGluZURTLmRhdGEoKTsKICAgICAgICAgICAgdGhpcy5qUmF3ID0gW107CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhUm93LCAnZGF0YVJvdycpCiAgICAgICAgICAgIGRhdGFSb3cuZm9yRWFjaCgobykgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IG8uaXRlbTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc2NvdW50SXRlbSA9IG8uZGlzY291bnRJdGVtOwogICAgICAgICAgICAgICAgY29uc3QgdmF0VGF4ID0gby52YXRUYXg7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVjaWZpY1RheCA9IG8uc3BlY2lmaWNUYXg7CiAgICAgICAgICAgICAgICBjb25zdCBQTFRheCA9IG8ucHVibGljTGlnaHRpbmdUYXg7CiAgICAgICAgICAgICAgICBjb25zdCBvdGhlclRheCA9IG8ub3RoZXJUYXg7CiAgICAgICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnR5cGUgPT09ICJTZXJ2aWNlIikgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5jb21lQWNjID0gaXRlbS5pbmNvbWVBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJpbmNvbWVBY2MiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IGl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpbmNvbWVBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpbmNvbWVBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImNyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCJkZWZlcnJlZEluY29tZUFjYyIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVmZXJyZWRJbkFjYyA9IGl0ZW0uZGVmZXJyZWRJbmNvbWVBY2M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTogaXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGRlZmVycmVkSW5BY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkZWZlcnJlZEluQWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS50eXBlID09PSAiVmFyaWFudCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTogaXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmluY29tZUFjYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogaXRlbS5pbmNvbWVBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY3IiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uaW52ZW50b3J5QWNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBpdGVtLmludmVudG9yeUFjYy5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IGl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogaXRlbS5jb3N0T2ZHb29kc1NvbGRBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uY29zdE9mR29vZHNTb2xkQWNjLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImRyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogIml0ZW0iLAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gIkZpeGVkIEFzc2V0IikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IGl0ZW0uYXNzZXRBY2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uYXNzZXRBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY3IiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiaXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS50eXBlID09PSAiVHJhbnNhY3Rpb24gSXRlbSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTogaXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtLnR5cGUgPT09ICJGaXhlZCBBc3NldCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTogaXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBpdGVtLmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IGl0ZW0uYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRpc2NvdW50SXRlbS5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBvLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBkaXNjb3VudEl0ZW0uYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBkaXNjb3VudEl0ZW0uYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImRyIiwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAiZGlzY291bnQiLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZhdFRheC5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBvLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiB2YXRUYXguYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiB2YXRUYXguYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImNyIiwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAidGF4IiwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzcGVjaWZpY1RheC5hY2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBvLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBzcGVjaWZpY1RheC5hY2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwZWNpZmljVGF4LmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjciIsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVBczogInRheCIsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoUExUYXguYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTogaXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbywKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogUExUYXguYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiBQTFRheC5hY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY3IiLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlQXM6ICJ0YXgiLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG90aGVyVGF4LmFjY291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IGl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IG8sCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IG90aGVyVGF4LmFjY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRJZDogb3RoZXJUYXguYWNjb3VudC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImNyIiwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUFzOiAidGF4IiwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHJlY2VpdmFibGVBY2MgPSB0aGlzLmludm9pY2UucmVjZWl2YWJsZUFjYyB8fCB7fTsKICAgICAgICAgICAgaWYgKHJlY2VpdmFibGVBY2MpIHsKICAgICAgICAgICAgICAgIHRoaXMualJhdy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpdGVtOiB7fSwKICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogcmVjZWl2YWJsZUFjYywKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHJlY2VpdmFibGVBY2MuaWQsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogImRyIiwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHNwZWNpZmljRGlzYyA9IHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbTsKICAgICAgICAgICAgaWYgKHNwZWNpZmljRGlzYy5oYXNPd25Qcm9wZXJ0eSgiYWNjb3VudCIpKSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlY2lmaWNEaXNjLmFjY291bnQuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmpSYXcucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IHt9LAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBuZXcgSXRlbUxpbmVNb2RlbCh7fSksCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHNwZWNpZmljRGlzYy5hY2NvdW50IHx8IHt9LAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNwZWNpZmljRGlzYy5hY2NvdW50LmlkLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiZHIiLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHNhbGVEZXBvc2l0QWNjID0gdGhpcy5jdXN0b21lci5zYWxlRGVwb3NpdEFjYyB8fCB7fTsKICAgICAgICAgICAgaWYgKHNhbGVEZXBvc2l0QWNjLmhhc093blByb3BlcnR5KCJhY2NvdW50IikpIHsKICAgICAgICAgICAgICAgIGlmIChzYWxlRGVwb3NpdEFjYy5hY2NvdW50Lmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbmV3IEl0ZW1MaW5lTW9kZWwoe30pLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiBzYWxlRGVwb3NpdEFjYy5hY2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQ6IHNhbGVEZXBvc2l0QWNjLmFjY291bnQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJkciIsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhzYWxlRGVwb3NpdEFjYyk7CiAgICAgICAgICAgIGlmICh0aGlzLm1PdGhlckNoYXJnZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2codGhpcy5tT3RoZXJDaGFyZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh0aGlzLmpSYXcpLCAiYWNjb3VudHMiKTsKICAgICAgICAgICAgLy8gdG9kbzogY2FsY3VsYXRlIEFtb3VudAogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlRHVwbGljYXRlKGFycmF5KSB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICAgICAgICBjb25zdCBtYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBhcnJheSkgewogICAgICAgICAgICAgICAgaWYgKCFtYXAuaGFzKGl0ZW0uaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFwLnNldChpdGVtLmlkLCB0cnVlKTsgLy8gc2V0IGFueSB2YWx1ZSB0byBNYXAKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgbnVtYmVyRm9ybWF0KHZhbHVlKSB7CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyh0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsLCduaW1vbCcpCiAgICAgICAgICAgIHJldHVybiBrZW5kby50b1N0cmluZyh2YWx1ZSwgYG4ke3RoaXMuc2FsZUZvcm1Db250ZW50LmRlY2ltYWx9YCk7CiAgICAgICAgfSwKICAgICAgICBhdXRvQ2FsY3VsYXRlRGlzY291bnQoZGlzY291bnRJdGVtLCBzdWJUb3RhbCkgewogICAgICAgICAgICBpZiAoZGlzY291bnRJdGVtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuYXR1cmUgPSBkaXNjb3VudEl0ZW0ubmF0dXJlIHx8ICcnCiAgICAgICAgICAgICAgICBjb25zdCBhbW91bnQgPSBkaXNjb3VudEl0ZW0uYW1vdW50IHx8IDAKICAgICAgICAgICAgICAgIGlmIChuYXR1cmUgPT09ICdBbW91bnQnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoYW1vdW50KQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXR1cmUgPT09ICdQZXJjZW50YWdlJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoc3ViVG90YWwgKiAocGFyc2VGbG9hdChhbW91bnQpIC8gMTAwKSkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGF1dG9DYWxjdWxhdGVUYXgodGF4LCBhbW91bnQpIHsKICAgICAgICAgICAgaWYgKHRheCkgewogICAgICAgICAgICAgICAgdmFyIGZvcm11bGEgPSB0YXguZm9ybXVsYTsKICAgICAgICAgICAgICAgIHZhciBpbkFtdCA9IGtlbmRvLnBhcnNlRmxvYXQoYW1vdW50KTsKICAgICAgICAgICAgICAgIHZhciBuQW10ID0ga2VuZG8ucGFyc2VGbG9hdChhbW91bnQpOwogICAgICAgICAgICAgICAgdmFyIHRheEJhc2UgPSBrZW5kby5wYXJzZUZsb2F0KHRheC50YXhCYXNlKSAvIDEwMDsKICAgICAgICAgICAgICAgIHZhciByYXRlID0ga2VuZG8ucGFyc2VGbG9hdCh0YXgucmF0ZSkgLyAxMDA7CiAgICAgICAgICAgICAgICB2YXIgdG90YWwgPSBldmFsKGZvcm11bGEpOwogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGluQW10LCBuQW10LCB0YXhCYXNlLCByYXRlLCBmb3JtdWxhLCB0b3RhbCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdG90YWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcmV0dXJuIDAKICAgICAgICB9LAogICAgICAgIHRheE1hcHBpbmcob2JqVGF4LCB0YXgpIHsKICAgICAgICAgICAgY29uc3QgdGF4SWQgPSB0YXguaWQgfHwgJycKICAgICAgICAgICAgY29uc3QgdGF4XyA9IG9ialRheC5maWx0ZXIodCA9PiB0LmlkID09PSB0YXhJZClbMF0KICAgICAgICAgICAgcmV0dXJuIHRheF8gfHwgewogICAgICAgICAgICAgICAgaWQ6ICcnLAogICAgICAgICAgICAgICAgZGVmYXVsdFRheDogJycKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgZGF0YVNvdXJjZUNoYW5nZWQoZSkgewogICAgICAgICAgICBpZiAoZS5maWVsZCkgewogICAgICAgICAgICAgICAgbGV0IGRhdGFSb3cgPSBlLml0ZW1zWzBdLCBpdGVtID0ge30sCiAgICAgICAgICAgICAgICAgICAgYnVvbSA9IHt9LCB2VGF4ID0ge30sIHNwVGF4ID0ge30sIG90VGF4ID0ge30sIHBsVGF4ID0ge30sCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2lvblJhdGUgPSAxLAogICAgICAgICAgICAgICAgICAgIHdhYyA9IDAsCiAgICAgICAgICAgICAgICAgICAgcW9oID0gMCwKICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSAwLAogICAgICAgICAgICAgICAgICAgIHhBbW91bnQgPSAwOwogICAgICAgICAgICAgICAgc3dpdGNoIChlLmZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiaXRlbSI6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuYXR0cmlidXRlXyA9IHRoaXMuYXR0cmlidXRlcy5maWx0ZXIobSA9PiBtLnR5cGUuaWQgPT09IGRhdGFSb3cudmFyaWFudC5pZCkKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IGRhdGFSb3cuaXRlbSB8fCB7fQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZGVzY3JpcHRpb24iLCBpdGVtLmRlc2NyaXB0aW9uIHx8ICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnVvbSA9IGl0ZW0udW9tIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYnVvbSIsIGJ1b20pOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhUm93LnNldCgndW9tJywgYnVvbSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKGRhdGFSb3cuaXRlbSwncm93JykKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXdhaXQgdGhpcy5pbnZlbnRvcnlCYWxhbmNlKGRhdGFSb3csIGRhdGFSb3cuaXRlbS5pZCkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAicHJpY2UiOgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gcGFyc2VGbG9hdChkYXRhUm93LnByaWNlKSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeEFtb3VudCA9IGFtb3VudCAqIHBhcnNlRmxvYXQodGhpcy5pbnZvaWNlLnR4blJhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwcmljZSIsIHBhcnNlRmxvYXQoZGF0YVJvdy5wcmljZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImFtb3VudCIsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCB4QW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygncHJpY2UnLGRhdGFSb3cucHJpY2UpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInByaWNlIiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJ1b20iOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1ByaWNlTGV2ZWxDaGFuZ2VkID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW9tID0gZGF0YVJvdy51b20uYnVvbSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxb2ggPSBkYXRhUm93LnVvbS5xb2ggfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzaW9uUmF0ZSA9IGRhdGFSb3cudW9tLmNvbnZlcnNpb25SYXRlIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2FjID0gZGF0YVJvdy51b20ud2FjIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCBidW9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgid2FjIiwgd2FjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicW9oIiwgcW9oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiB0b2RvOiBtYXBwaW5nIHRheCBvYmplY3QgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2VGF4ID0gdGhpcy50YXhNYXBwaW5nKHRoaXMudmF0VGF4LCBkYXRhUm93LnVvbS52YXRUYXggfHwge30pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RUYXggPSB0aGlzLnRheE1hcHBpbmcodGhpcy5vdGhlclRheCwgZGF0YVJvdy51b20ub3RoZXJUYXggfHwge30pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BUYXggPSB0aGlzLnRheE1hcHBpbmcodGhpcy5zcGVjaWZpY1RheCwgZGF0YVJvdy51b20uc3BlY2lmaWNUYXggfHwge30pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxUYXggPSB0aGlzLnRheE1hcHBpbmcodGhpcy5wdWJsaWNMaWdodGluZ1RheCwgZGF0YVJvdy51b20ucHVibGljTGlnaHRpbmdUYXggfHwge30pCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJ2YXRUYXgiLCB2VGF4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgic3BlY2lmaWNUYXgiLCBzcFRheCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoIm90aGVyVGF4Iiwgb3RUYXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwdWJsaWNMaWdodGluZ1RheCIsIHBsVGF4KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgcGFyc2VGbG9hdChjb252ZXJzaW9uUmF0ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhUm93LnVvbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSBwYXJzZUZsb2F0KGRhdGFSb3cudW9tLnByaWNlKSAqIHBhcnNlRmxvYXQoZGF0YVJvdy5xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4QW1vdW50ID0gYW1vdW50ICogcGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicHJpY2UiLCBwYXJzZUZsb2F0KGRhdGFSb3cudW9tLnByaWNlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCB4QW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSBwYXJzZUZsb2F0KGRhdGFSb3cucHJpY2UpICogcGFyc2VGbG9hdChkYXRhUm93LnF0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhBbW91bnQgPSBhbW91bnQgKiBwYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJwcmljZSIsIHBhcnNlRmxvYXQoZGF0YVJvdy5wcmljZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgYW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJlcnJvciIsIGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImJ1b20iLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvbnZlcnNpb25SYXRlIiwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInByaWNlIiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInFvaCIsIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJ3YWMiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAicXR5IjoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IHBhcnNlRmxvYXQoZGF0YVJvdy5wcmljZSkgKiBwYXJzZUZsb2F0KGRhdGFSb3cucXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhBbW91bnQgPSBhbW91bnQgKiBwYXJzZUZsb2F0KHRoaXMuaW52b2ljZS50eG5SYXRlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicHJpY2UiLCBwYXJzZUZsb2F0KGRhdGFSb3cucHJpY2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KCJhbW91bnQiLCBhbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImV4Y2hhbmdlQW1vdW50IiwgeEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoInByaWNlIiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiYW1vdW50IiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiZXhjaGFuZ2VBbW91bnQiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJvdGhlclRheCI6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZygiLS0iLCBkYXRhUm93KQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlLmZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5yYXdGb3JKb3VybmFsKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXN5bmMgaW52ZW50b3J5QmFsYW5jZShkYXRhUm93LCBpdGVtSWQpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnREYXRlID0gdGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZTsKICAgICAgICAgICAgICAgICAgICBsZXQgc3RyRmlsdGVyID0gIj9hc09mPSIgKyBzdGFydERhdGUgKyAiJmlkPSIgKyBpdGVtSWQ7CiAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIuaW52ZW50b3J5QmFsYW5jZShzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxhbmNlID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWxhbmNlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgiY29zdCIsIGJhbGFuY2VbMF0ud2FjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhUm93LnNldCgicW9oIiwgYmFsYW5jZVswXS5xb2gpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFSb3cuc2V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYW1vdW50IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChiYWxhbmNlWzBdLndhYykgKiBwYXJzZUZsb2F0KGRhdGFSb3cucXR5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YVJvdy5zZXQoJ3VvbScsIGJhbGFuY2VbMF0uYnVvbSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJvdy5zZXQoImNvc3QiLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygiYmFsYW5jZSIsIHJlcy5kYXRhLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBTZXJ2aWNlRGF0ZUVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCByZXF1aXJlZCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0RhdGVQaWNrZXIoKTsKCiAgICAgICAgICAgIC8vIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpCiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkcy5kYXRhKCkpCiAgICAgICAgICAgIC8vIC8vIGNvbnN0IGRhdGVTdHJpbmcgPSBrZW5kby50b1N0cmluZygobmV3IERhdGUob3B0aW9ucy5tb2RlbC5pdGVtcy5zZXJ2aWNlRGF0ZSkpLCB0aGlzLml0ZW1MaW5lLmRhdGVGb3JtYXQpCiAgICAgICAgICAgIC8vIC8vIGNvbnN0IGRhdGVTdHJpbmcgPSBrZW5kby50b1N0cmluZyhvcHRpb25zLm1vZGVsLml0ZW1zLnNlcnZpY2VEYXRlKQogICAgICAgICAgICAvLyBjb25zdCAkaW5wdXQgPSAkKCI8aW5wdXQgdmFsdWU9IiArIG9wdGlvbnMubW9kZWwuc2VydmljZURhdGUgKyAiIC8+IikuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgICAgICAvLyAkaW5wdXQua2VuZG9EYXRlUGlja2VyKCkKICAgICAgICAgICAgLy8gLy8gJGlucHV0LmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgLy8gLy8gb3B0aW9ucy5tb2RlbC5pdGVtcy5zZXJ2aWNlRGF0ZSA9IGRhdGVTdHJpbmcKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCRpbnB1dCkKICAgICAgICB9LAogICAgICAgIFNlcnZpY2VEYXRlVG9FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgcmVxdWlyZWQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9EYXRlUGlja2VyKCk7CiAgICAgICAgfSwKICAgICAgICBJdGVtRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPkl0ZW1zIDwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBwcm9kdWN0VmFyaWFudEhhbmRsZXIuaXRlbVNlYXJjaFVSTCgnP3BsSWQ9JyArIHRoaXMuaW52b2ljZS5wcmljZUxldmVsLmlkICsnJnJlVXNlZD0xJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDoge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2t1OiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YTogdGhpcy52YXJpYW50cwogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBVT01Ecm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJjb2RlIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogInVvbUNvbnZlcnRJZCIsCiAgICAgICAgICAgICAgICAgICAgY2FzY2FkZUZyb206ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9IGNvZGUgfHwgYE5vIFByaWNlIExldmVsYCM8L3NwYW4+IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyRmlsdGVyaW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQ6IHt1cmw6IHVvbVByaWNlSGFuZGxlci51b21QcmljZUJ5UHJpY2VMZXZlbFVSTCgiaWQ9IiArIG9wdGlvbnMubW9kZWwuaXRlbS5pZCArICImcGxJZD0iICsgdGhpcy5pbnZvaWNlLnByaWNlTGV2ZWwuaWQgKyAiJmRhdGU9IiArIHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUpLH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuYW1lOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBza3U6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5jb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhdGE6IHRoaXMudmFyaWFudHMKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgRGlzY291bnRJdGVtRHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAibmFtZSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJpZCIsCiAgICAgICAgICAgICAgICAgICAgY2FzY2FkZUZyb206ICJpdGVtIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9Y29kZSMgLSAjPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBkaXNjb3VudEl0ZW1IYW5kbGVyLmdldFVSTChESVNDT1VOVF9UWVBFKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuYW1lOiB7dHlwZTogInN0cmluZyJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBza3U6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBTcGVjaWZpY1RheERyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IG5hbWU9IicgKyBvcHRpb25zLmZpZWxkICsgJyIvPicpCiAgICAgICAgICAgICAgICAuYXBwZW5kVG8oY29udGFpbmVyKQogICAgICAgICAgICAgICAgLmtlbmRvRHJvcERvd25MaXN0KHsKICAgICAgICAgICAgICAgICAgICBhdXRvQmluZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBhdXRvV2lkdGg6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA0MDAsCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiAic3RhcnRzd2l0aCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogImRlZmF1bHRUYXgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1kZWZhdWx0VGF4IHx8IGBgIzwvc3Bhbj4iLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLnNwZWNpZmljVGF4LmZpbHRlcigobSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMubW9kZWwuaGFzT3duUHJvcGVydHkoInZhdFRheCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmF0ID0gb3B0aW9ucy5tb2RlbC52YXRUYXggfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLnZhdFRheCAhPT0gbnVsbCB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC52YXRUYXggIT09ICJudWxsIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm1vZGVsLnZhdFRheC5iYXNlQW1vdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5iYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkgPT09CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubW9kZWwudmF0VGF4LmJhc2VBbW91bnQudG9Mb3dlckNhc2UoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgUHVibGljTGlnaHRpbmdUYXhEcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJkZWZhdWx0VGF4IiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9ZGVmYXVsdFRheCB8fCBgYCM8L3NwYW4+IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25MYWJlbDogIi0tLSBTZWxlY3QgLS0tIiwKICAgICAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBuZXcga2VuZG8uZGF0YS5EYXRhU291cmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdGhpcy5wdWJsaWNMaWdodGluZ1RheC5maWx0ZXIoKG0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm1vZGVsLmhhc093blByb3BlcnR5KCJ2YXRUYXgiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhdCA9IG9wdGlvbnMubW9kZWwudmF0VGF4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC52YXRUYXggIT09IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubW9kZWwudmF0VGF4ICE9PSAibnVsbCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlbC52YXRUYXguYmFzZUFtb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpID09PQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLnZhdFRheC5iYXNlQW1vdW50LnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIE90aGVyVGF4RHJvcERvd25FZGl0b3IoY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJzdGFydHN3aXRoIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVGV4dEZpZWxkOiAiZGVmYXVsdFRheCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVZhbHVlRmllbGQ6ICJpZCIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPWRlZmF1bHRUYXggfHwgYGAjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMub3RoZXJUYXguZmlsdGVyKChtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlbC5oYXNPd25Qcm9wZXJ0eSgidmF0VGF4IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YXQgPSBvcHRpb25zLm1vZGVsLnZhdFRheDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubW9kZWwudmF0VGF4ICE9PSBudWxsICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1vZGVsLnZhdFRheCAhPT0gIm51bGwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMubW9kZWwudmF0VGF4LmJhc2VBbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmJhc2VBbW91bnQudG9Mb3dlckNhc2UoKSA9PT0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tb2RlbC52YXRUYXguYmFzZUFtb3VudC50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBWYXRUYXhEcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJkZWZhdWx0VGF4IiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9ZGVmYXVsdFRheCB8fCBgYCM8L3NwYW4+IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25MYWJlbDogIi0tU2VsZWN0LS0iLAogICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLnZhdFRheCwKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgT3RoZXJDaGFyZ2VEcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9bmFtZSM8L3NwYW4+IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25MYWJlbDogIi0tU2VsZWN0LS0iLAogICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLm90aGVyQ2hhcmdlTGlzdCwKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgU2FsZVVuaXREcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAga2VuZG8KICAgICAgICAgICAgICAgIC5qUXVlcnkoJzxpbnB1dCBuYW1lPSInICsgb3B0aW9ucy5maWVsZCArICciLz4nKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGNvbnRhaW5lcikKICAgICAgICAgICAgICAgIC5rZW5kb0Ryb3BEb3duTGlzdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogInN0YXJ0c3dpdGgiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogIjxzcGFuPiM9Y29kZSMgLSAjPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuc2FsZVVuaXRJdGVtTGlzdCwKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgTW9kaWZpZXJEcm9wRG93bkVkaXRvcihjb250YWluZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAgY29uc3QgaXRlbSA9IG9wdGlvbnMubW9kZWwuaXRlbSB8fCB7fQogICAgICAgICAgICBjb25zdCB1b20gPSBpdGVtLnVvbSB8fCB7fQogICAgICAgICAgICBjb25zdCBpdGVtSWQgPSBpdGVtLmlkIHx8ICcnCiAgICAgICAgICAgIGNvbnN0IHVvbUlkID0gdW9tLmlkIHx8ICcnCiAgICAgICAgICAgIGtlbmRvCiAgICAgICAgICAgICAgICAualF1ZXJ5KCc8aW5wdXQgbmFtZT0iJyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9Ecm9wRG93bkxpc3QoewogICAgICAgICAgICAgICAgICAgIGF1dG9CaW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGF1dG9XaWR0aDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6ICJjb250YWlucyIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVRleHRGaWVsZDogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZUZpZWxkOiAiaWQiLAogICAgICAgICAgICAgICAgICAgIGhlYWRlclRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZHJvcGRvd24taGVhZGVyIGstd2lkZ2V0IGstaGVhZGVyIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPk1vZGlmaWVyIDwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjxzcGFuPjwvc3Bhbj4iICsKICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiIsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICI8c3Bhbj4jPW5hbWUjPC9zcGFuPiIsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uTGFiZWw6ICItLS0gU2VsZWN0IC0tLSIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV3IGtlbmRvLmRhdGEuRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlckZpbHRlcmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBpdGVtTW9kaWZpZXJIYW5kbGVyLnNlYXJjaFVSTCgnP3BsSWQ9JyArIHRoaXMuaW52b2ljZS5wcmljZUxldmVsLmlkICsgJyZpZD0nICsgaXRlbUlkICsgJyZ1b21JZD0nICsgdW9tSWQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVtYTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaWNlOiB7dHlwZTogIm51bWJlciJ9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1b206IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBFbXBsb3llZURyb3BEb3duRWRpdG9yKGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgICAgICAgICBrZW5kbwogICAgICAgICAgICAgICAgLmpRdWVyeSgnPGlucHV0IGRhdGEtYmluZD0idmFsdWU6JyArIG9wdGlvbnMuZmllbGQgKyAnIi8+JykKICAgICAgICAgICAgICAgIC5hcHBlbmRUbyhjb250YWluZXIpCiAgICAgICAgICAgICAgICAua2VuZG9NdWx0aVNlbGVjdCh7CiAgICAgICAgICAgICAgICAgICAgYXV0b0JpbmQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYXV0b1dpZHRoOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDAwLAogICAgICAgICAgICAgICAgICAgIHN1Z2dlc3Q6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiAiY29udGFpbnMiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUZXh0RmllbGQ6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWVGaWVsZDogImlkIiwKICAgICAgICAgICAgICAgICAgICBoZWFkZXJUZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImRyb3Bkb3duLWhlYWRlciBrLXdpZGdldCBrLWhlYWRlciI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICI8c3Bhbj5FbXBsb3llZSA8L3NwYW4+IiArCiAgICAgICAgICAgICAgICAgICAgICAgICI8c3Bhbj48L3NwYW4+IiArCiAgICAgICAgICAgICAgICAgICAgICAgICI8L2Rpdj4iLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAiPHNwYW4+Iz1uYW1lIzwvc3Bhbj4iLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbkxhYmVsOiAiLS0tIFNlbGVjdCAtLS0iLAogICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IG5ldyBrZW5kby5kYXRhLkRhdGFTb3VyY2UoewogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJGaWx0ZXJpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcG9ydDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogZW1wbG95ZWVIYW5kbGVyLnNlYXJjaFVSTCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVtYTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZToge3R5cGU6ICJzdHJpbmcifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHt0eXBlOiAic3RyaW5nIn0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByb3dOdW1iZXJUbXBsKGRhdGFJdGVtKSB7CiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpLAogICAgICAgICAgICAgICAgaW5kZXggPSBkcy5pbmRleE9mKGRhdGFJdGVtKTsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ICsgMTsKICAgICAgICB9LAogICAgICAgIGFkZFJvdygpIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCksCiAgICAgICAgICAgICAgICB0b3RhbCA9IGRzLnRvdGFsKCk7CiAgICAgICAgICAgIHRoaXMuaXRlbUxpbmUuaWQgPSBpdGVtTGluZVByZWZpeCArIHV1aWQudjEoKTsKICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5kZWNpbWFsRm9ybWF0ID0gIm4iICsgdGhpcy5zYWxlRm9ybUNvbnRlbnQuZGVjaW1hbDsKICAgICAgICAgICAgdGhpcy5pdGVtTGluZS5pc0VkaXRhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRvdGFsIDwgMzYpIHsKICAgICAgICAgICAgICAgIGRzLmluc2VydCh0b3RhbCwgdGhpcy5pdGVtTGluZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gdGhpcy5pdGVtTGluZXMucHVzaCh0aGlzLml0ZW1MaW5lKQogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ2l0ZW0gTGluZScsIHRoaXMuaXRlbUxpbmUpCiAgICAgICAgfSwKICAgICAgICBvblBheW1lbnRUZXJtQ2hhbmdlZCgpIHsKICAgICAgICAgICAgLy8gdGhpcy5vbkludm9pY2VEYXRlQ2hhbmdlZCgpOwogICAgICAgICAgICAvLyB3aW5kb3cuY29uc29sZS5sb2coJ3Rlcm0nLCB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25EYXRlLCAnLScsIHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUsICctLS0nLCB0aGlzLmludm9pY2UucGF5bWVudFRlcm0pCiAgICAgICAgICAgIGlmICh0aGlzLmN1c3RvbWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYXltZW50VGVybSA9IHRoaXMuaW52b2ljZS5wYXltZW50VGVybSB8fCB7fQogICAgICAgICAgICAgICAgaWYgKHBheW1lbnRUZXJtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV0RHVlID0gcGF5bWVudFRlcm0ubmV0RHVlIHx8IDAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzb21lRGF0ZSA9IG5ldyBEYXRlKHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUpOwogICAgICAgICAgICAgICAgICAgIHNvbWVEYXRlLnNldERhdGUoc29tZURhdGUuZ2V0RGF0ZSgpICsgcGFyc2VJbnQobmV0RHVlKSk7IC8vbnVtYmVyICBvZiBkYXlzIHRvIGFkZCwgZS54LiAxNSBkYXlzCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmR1ZURhdGUgPSBzb21lRGF0ZS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIG9uSW52b2ljZURhdGVDaGFuZ2VkKCkgewogICAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRQYXltZW50VGVybUxpc3QoKTsKICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ3JlZGl0TGltaXQoKTsKICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMuY3VzdG9tZXIuaWQpOwogICAgICAgICAgICBhd2FpdCB0aGlzLm9uUHJpY2VMZXZlbENoYW5nZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY3VzdG9tZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBheW1lbnRUZXJtID0gdGhpcy5pbnZvaWNlLnBheW1lbnRUZXJtIHx8IHt9CiAgICAgICAgICAgICAgICBpZiAocGF5bWVudFRlcm0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXREdWUgPSBwYXltZW50VGVybS5uZXREdWUgfHwgMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzb21lRGF0ZSA9IG5ldyBEYXRlKHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUpOwogICAgICAgICAgICAgICAgICAgIHNvbWVEYXRlLnNldERhdGUoc29tZURhdGUuZ2V0RGF0ZSgpICsgcGFyc2VJbnQobmV0RHVlKSk7IC8vbnVtYmVyICBvZiBkYXlzIHRvIGFkZCwgZS54LiAxNSBkYXlzCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmR1ZURhdGUgPSBzb21lRGF0ZS50b0lTT1N0cmluZygpLnN1YnN0cigwLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdpbScsIHNvbWVEYXRlLCBuZXREdWUpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB0aGlzLmxvYWRDdXN0b21lckJhbGFuY2UodGhpcy5jdXN0b21lci5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmdlbmVyYXRlTnVtYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQcmVmaXgoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHByZWZpeEhhbmRsZXIuZ2V0KCJpbnZvaWNlIikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZVR5cGVzID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2VUeXBlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uVHlwZSA9IHRoaXMuaW52b2ljZVR5cGVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlbmVyYXRlTnVtYmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcGxhdGVIYW5kbGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRQcmljZUxldmVsKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP25hdHVyZT1zYWxlJwogICAgICAgICAgICAgICAgICAgIHByaWNlTGV2ZWxIYW5kbGVyLmdldChzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByaWNlTGV2ZWwgPSByZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLnByaWNlTGV2ZWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5pbnZvaWNlLnByaWNlTGV2ZWwgPSB0aGlzLnByaWNlTGV2ZWxbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkRGlzY291bnRJdGVtKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBkaXNjb3VudEl0ZW1IYW5kbGVyLmxpc3QoRElTQ09VTlRfVFlQRSkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3BlY2lmaWNEaXNjb3VudEl0ZW0gPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZE90aGVyQ2hhcmdlKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZUhhbmRsZXIubGlzdCgpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm90aGVyQ2hhcmdlTGlzdCA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkQWNjb3VudCgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudEhhbmRsZXIuZ2V0QWxsKCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgLy9SZWNlaXZhYmxlIEFjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZhYmxlQWNjID0gcmVzLmRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKG0pID0+IG0uYWNjb3VudF90eXBlLm51bWJlciA9PT0gNykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKGl0bSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpdG0udXVpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZDogaXRtLnV1aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGl0bS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9uYW1lOiBpdG0ubG9jYWxfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiBpdG0ubnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc190YXhhYmxlOiBpdG0uaXNfdGF4YWJsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuaGppQWNjQ29kZTogaXRtLmJhbmhqaUFjY0NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwX2NvZGU6IGl0bS5ncm91cF9jb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRfYWNjb3VudDogaXRtLnBhcmVudF9hY2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlX2NvZGU6IGl0bS50eXBlX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfdHlwZTogaXRtLmFjY291bnRfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLnJlY2VpdmFibGVBY2MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5pbnZvaWNlLnJlY2VpdmFibGVBY2MgPSB0aGlzLnJlY2VpdmFibGVBY2NbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkUGF5bWVudFRlcm0oKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0ckZpbHRlciA9ICI/dHlwZT1wbXQtY3VzdG9tZXIiOwogICAgICAgICAgICAgICAgICAgIHBheW1lbnRUZXJtSGFuZGxlci5nZXRQYXltZW50VGVybShzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBheW1lbnRUZXJtcyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5wYXltZW50VGVybXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuaW52b2ljZS5wYXltZW50VGVybSA9IHRoaXMucGF5bWVudFRlcm1zWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZExvY2F0aW9uKCkgewogICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IFtdCiAgICAgICAgICAgIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDAKICAgICAgICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVN0b3JlLnJvbGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW10KICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2NhdGlvbiA9IHJvbGVEYXRhLmZpbHRlcihpdG0gPT4gaXRtLnR5cGUgPT09ICdsb2NhdGlvbicpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb25EZWZhdWx0ID0gbG9jYXRpb24uZmlsdGVyKG0gPT4gbS5pc0RlZmF1bHQgPT09IDEpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSBsb2NhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCB8fCB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2NhdGlvbkRlZmF1bHQubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmxvY2F0aW9uID0gbG9jYXRpb25EZWZhdWx0WzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbkhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5saXN0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmxvY2F0aW9ucy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5sb2NhdGlvbiA9IHRoaXMubG9jYXRpb25zWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKCiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkUHJvamVjdEJ5Q3VzdG9tZXIoKSB7CiAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IFtdCiAgICAgICAgICAgIGNvbnN0IHJvbGVUeXBlID0gZGF0YVN0b3JlLnJvbGVUeXBlIHx8IDAKICAgICAgICAgICAgaWYgKHJvbGVUeXBlID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVN0b3JlLnJvbGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZURhdGEgPSBkYXRhU3RvcmUucm9sZURhdGEgfHwgW10KICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0ID0gcm9sZURhdGEuZmlsdGVyKGl0bSA9PiBpdG0udHlwZSA9PT0gJ3Byb2plY3QnKQogICAgICAgICAgICAgICAgICAgIHByb2plY3QuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VzdG9tZXJzID0gay5jdXN0b21lcnMgfHwgW10KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvQ3VzdG9tZXIgPSBjdXN0b21lcnMuZmlsdGVyKG4gPT4gbi5jdXN0b21lci5pZCA9PT0gdGhpcy5jdXN0b21lci5pZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb0N1c3RvbWVyLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cy5wdXNoKGspCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCB8fCB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2plY3REZWZhdWx0ID0gdGhpcy5jdXN0b21lclByb2plY3RzLmZpbHRlcihtID0+IG0uaXNEZWZhdWx0ID09PSAxKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvamVjdERlZmF1bHQubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnByb2plY3QgPSBwcm9qZWN0RGVmYXVsdFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvamVjdEhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRCeUN1c3RvbWVyKHRoaXMuY3VzdG9tZXIuaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXJQcm9qZWN0cyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCgogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZEN1c3RvbWVyQmFsYW5jZShpZCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSBpZCArICI/dHlwZT1iYWwiOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5jdXJyZW50QmFsYW5jZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgLmJhbGFuY2Uoc3RyRmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UuY3VycmVudEJhbGFuY2UgPSBkYXRhWzBdLmJhbGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZEN1c3RvbWVyRGVwb3NpdEJhbGFuY2UoaWQpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyRmlsdGVyID0gaWQgKyAiP3R5cGU9ZGVwIjsKICAgICAgICAgICAgICAgICAgICBiaWxsaW5nSGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAuYmFsYW5jZShzdHJGaWx0ZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5kZXBvc2l0QW1vdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFtb3VudERlcG9zaXQgPSBkYXRhWzBdLmJhbGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5kZXBvc2l0QW1vdW50ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudERlcG9zaXQgLyB0aGlzLmludm9pY2UudHhuUmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgpOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBjcmVkaXRMaW1pdFVzYWdlKGJhbGFuY2UsIGNyZWRpdExpbWl0KSB7CiAgICAgICAgICAgIGlmIChjcmVkaXRMaW1pdCA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAga2VuZG8udG9TdHJpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgIChiYWxhbmNlIC8gY3JlZGl0TGltaXQpICogMTAwLAogICAgICAgICAgICAgICAgICAgICAgICBgbiR7dGhpcy5zYWxlRm9ybUNvbnRlbnQuZGVjaW1hbH1gCiAgICAgICAgICAgICAgICAgICAgKSArICIgJSIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga2VuZG8udG9TdHJpbmcoMCwgYG4ke3RoaXMuc2FsZUZvcm1Db250ZW50LmRlY2ltYWx9YCkgKyAiICUiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjb25zdCBhbGxvd2VkID0ga2VuZG8udG9TdHJpbmcoKGJhbGFuY2UgLyBjcmVkaXRMaW1pdCkgKiAxMDAsIGBuJHt0aGlzLnNhbGVGb3JtQ29udGVudC5kZWNpbWFsfWApCiAgICAgICAgICAgIC8vIHJldHVybiAoaXNOYU4oYWxsb3dlZCkgPyAwIDogYWxsb3dlZCkgKyAnICUnCiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkRW1wbG95ZWVDZW50ZXIoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZW1wbG95ZWVzID0gW107CiAgICAgICAgICAgICAgICAgICAgZW1wbG95ZWVIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgIC5jZW50ZXIodW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbXBsb3llZXMgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVtcGxveWVlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5lbXBsb3llZSA9IHRoaXMuZW1wbG95ZWVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCk7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRTZWdtZW50KCkgewogICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ2RhdGFTdG9yZS5yb2xlRGF0YScsIGRhdGFTdG9yZSkKICAgICAgICAgICAgY29uc3Qgcm9sZVR5cGUgPSBkYXRhU3RvcmUucm9sZVR5cGUgfHwgMAogICAgICAgICAgICBpZiAocm9sZVR5cGUgPT09IDApIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhU3RvcmUucm9sZURhdGEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByb2xlRGF0YSA9IGRhdGFTdG9yZS5yb2xlRGF0YSB8fCBbXQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlZ21lbnQgPSByb2xlRGF0YS5maWx0ZXIoaXRtID0+IGl0bS50eXBlID09PSAnc2VnbWVudCcpCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VnbWVudERlZmF1bHQgPSBzZWdtZW50LmZpbHRlcihtID0+IG0uaXNEZWZhdWx0ID09PSAxKQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSBzZWdtZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlZ21lbnREZWZhdWx0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5zZWdtZW50ID0gc2VnbWVudERlZmF1bHRbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9sZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0U2VnKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc2VnbWVudHMubGVuZ3RoID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2Uuc2VnbWVudCA9IHRoaXMuc2VnbWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgoKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRTYWxlT3JkZXIoKSB7CiAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCJyZXNvbHZlZCIpOwogICAgICAgICAgICAgICAgICAgIGxldCBzZWdtZW50SWQgPSAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbElkID0gIiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQgPSAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2Uuc2VnbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50SWQgPSB0aGlzLmludm9pY2Uuc2VnbWVudC5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS5sb2NhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbklkID0gdGhpcy5pbnZvaWNlLmxvY2F0aW9uLmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnZvaWNlLmN1c3RvbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQgPSB0aGlzLmludm9pY2UuY3VzdG9tZXIuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludm9pY2UucHJpY2VMZXZlbCkgewogICAgICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsSWQgPSB0aGlzLmludm9pY2UucHJpY2VMZXZlbC5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZSA9IHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxldCBzdHJGaWx0ZXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRJZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJJZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25JZCAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2VMZXZlbElkICE9PSAiIiAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eG5EYXRlICE9PSAiIgogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJGaWx0ZXIgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIj9pZD0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZzZWdJZD0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRJZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJmxvY0lkPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25JZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJnBsSWQ9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmljZUxldmVsSWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiZkYXRlPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhuRGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ckZpbHRlciAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnJlZkZyb20gPSBbXQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nVHhuID0gdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBzYWxlT3JkZXJIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNhY3Rpb25GaWx0ZXIoc3RyRmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ1R4biA9IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVycyA9IHJlcy5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ1R4biA9IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFNhbGVDaGFubmVsKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBzYWxlQ2hhbm5lbEhhbmRsZXIuZ2V0KCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2FsZUNoYW5uZWxMaXN0ID0gcmVzLmRhdGEuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNhbGVDaGFubmVsTGlzdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnNhbGVDaGFubmVsID0gdGhpcy5zYWxlQ2hhbm5lbExpc3RbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVGF4KCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBzZXR0aW5nSGFuZGxlci5nZXQoKS50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YXggPSByZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3RoZXJUYXggPSB0aGlzLnRheC5maWx0ZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobSkgPT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobS50YXhUeXBlLnR5cGVJZCA9PT0gNyB8fCBtLnRheFR5cGUudHlwZUlkID09PSAxMCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRyYW5zYWN0aW9uVHlwZSA9PT0gIlNhbGUiCiAgICAgICAgICAgICAgICAgICAgICAgICk7IC8vIHZhbHVhYmxlIHRheAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNwZWNpZmljVGF4ID0gdGhpcy50YXguZmlsdGVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0pID0+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0udGF4VHlwZS50eXBlSWQgPT09IDggfHwgbS50YXhUeXBlLnR5cGVJZCA9PT0gMTApICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS50cmFuc2FjdGlvblR5cGUgPT09ICJTYWxlIgogICAgICAgICAgICAgICAgICAgICAgICApOyAvLyB2YWx1YWJsZSB0YXgKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdWJsaWNMaWdodGluZ1RheCA9IHRoaXMudGF4LmZpbHRlcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChtKSA9PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChtLnRheFR5cGUudHlwZUlkID09PSA5IHx8IG0udGF4VHlwZS50eXBlSWQgPT09IDEwKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNhY3Rpb25UeXBlID09PSAiU2FsZSIKICAgICAgICAgICAgICAgICAgICAgICAgKTsgLy8gdmFsdWFibGUgdGF4CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmF0VGF4ID0gdGhpcy50YXguZmlsdGVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0pID0+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0udGF4VHlwZS50eXBlSWQgPT09IDEgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS50YXhUeXBlLnR5cGVJZCA9PT0gMTApICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS50cmFuc2FjdGlvblR5cGUgPT09ICJTYWxlIgogICAgICAgICAgICAgICAgICAgICAgICApOyAvLyB2YWx1YWJsZSB0YXgKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCd0YXgnLCBKU09OLnN0cmluZ2lmeSh0aGlzLnZhdFRheCkpCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgb25TYXZlQ2xvc2Uoc2F2ZU5ldywgc2F2ZVNlbmQsIGlzUHJpbnQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLiRyZWZzLmZvcm0udmFsaWRhdGUoKSkgewogICAgICAgICAgICAgICAgLy8gdGhpcy4kcmVmcy5mb3JtLnZhbGlkYXRlKCkKICAgICAgICAgICAgICAgIHRoaXMuJHNub3RpZnkuZXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIkZpZWxkIGlzIHJlcXVpcmVkLCBwbGVhc2UgY2hlY2sgZmllbGQgZWFjaCBvZiB0YWJzISIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGlkID0gIiI7CiAgICAgICAgICAgIGlmICh0aGlzLmN1c3RvbWVyLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICBpZCA9IHRoaXMuY3VzdG9tZXIuaWQgfHwgIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlkID09PSAiIikgewogICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5lcnJvcigiY3VzdG9tZXIgaXMgcmVxdWlyZSIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBkcyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpOwogICAgICAgICAgICBsZXQgZDEgPSBkcy5kYXRhKCkuZmlsdGVyKG4gPT4gbi5hbW91bnQgPiAwKTsKICAgICAgICAgICAgbGV0IGRhdGFWYWxpZGF0ZSA9IDA7CiAgICAgICAgICAgIGQxLmZvckVhY2goKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgIHZhbHVlLml0ZW0uaWQgPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUudW9tLnVvbS5pZCA9PSB1bmRlZmluZWQgfHwKICAgICAgICAgICAgICAgICAgICB2YWx1ZS5pdGVtLmlkID09ICIiIHx8CiAgICAgICAgICAgICAgICAgICAgdmFsdWUudW9tLnVvbS5pZCA9PSAiIgogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5lcnJvcigKICAgICAgICAgICAgICAgICAgICAgICAgIlBsZWFzZSBjaGVjayBJdGVtIG9yIFVvbSAgb24gcm93ICIgKyAoaW5kZXggKyAxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRhdGFWYWxpZGF0ZSArPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGQxLmxlbmd0aCA9PSBkYXRhVmFsaWRhdGUpIHsKICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc0F1dG9HZW5lcmF0ZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlID0gbmV3IERhdGUodGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZUludm9pY2UgPSBuZXcgRGF0ZSh0aGlzLmludm9pY2UudHJhbnNhY3Rpb25EYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlTSA9IHRyYW5EYXRlLmdldEZ1bGxZZWFyKCkgKyB0cmFuRGF0ZS5nZXRNb250aCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVJbnZvaWNlTSA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbkRhdGVJbnZvaWNlLmdldEZ1bGxZZWFyKCkgKyB0cmFuRGF0ZUludm9pY2UuZ2V0TW9udGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuRGF0ZU0gPT09IHRyYW5EYXRlSW52b2ljZU0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0F1dG9HZW5lcmF0ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvQ2FsY3VsYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuYXV0b0NhbGN1bGF0ZVRheERldGFpbCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXRlbUxpbmVEUyA9IHRoaXMuJHJlZnMuaXRlbUxpbmVEUy5rZW5kb1dpZGdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhUm93ID0gaXRlbUxpbmVEUwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmRhdGEoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigobykgPT4gby5hbW91bnQgPiAwKS5tYXAoKG4pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGhlckNoYXJnZSA9IG5ldyBPdGhlckNoYXJnZU1vZGVsKG4ub3RoZXJDaGFyZ2UgfHwge30pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgblsnb3RoZXJDaGFyZ2UnXSA9IG90aGVyQ2hhcmdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBJdGVtTGluZU1vZGVsKG4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vdG9kbzogY2hlY2sgU291cmNlCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZVJlZiA9IGRhdGFSb3cubWFwKChvKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gby5zb3VyY2VUcmFuc2FjdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZVR4biA9IHRoaXMucmVtb3ZlRHVwbGljYXRlKHNvdXJjZVJlZik7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnZGF0YVJvdycsIEpTT04uc3RyaW5naWZ5KGRhdGFSb3cpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFSb3cubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHRoaXMuaW52b2ljZS5pZCA/IHRoaXMuaW52b2ljZS5pZCA6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWQ6IHRoaXMuaW52b2ljZS51dWlkID8gdGhpcy5pbnZvaWNlLnV1aWQgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb3VybmFsX3V1aWQ6IHRoaXMuaW52b2ljZS5qb3VybmFsX3V1aWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmludm9pY2Uuam91cm5hbF91dWlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIkludm9pY2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogdGhpcy5pbnZvaWNlLm51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYmJyOiB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25UeXBlLmFiYnIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25EYXRlOiB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25EYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1ZURhdGU6IHRoaXMuaW52b2ljZS5kdWVEYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbnRoT2Y6IHRoaXMuaW52b2ljZS5tb250aE9mLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVyOiB0aGlzLmludm9pY2UuY3VzdG9tZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25UeXBlOiB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25UeXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBheW1lbnRUZXJtOiB0aGlzLmludm9pY2UucGF5bWVudFRlcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwcm92ZWRUZXJtOiB0aGlzLmludm9pY2UuYXBwcm92ZWRUZXJtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvdW50UHJvbW90aW9uOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZhYmxlQWNjOiB0aGlzLmludm9pY2UucmVjZWl2YWJsZUFjYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW5jeTogdGhpcy5pbnZvaWNlLmN1cnJlbmN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4blJhdGU6IHRoaXMuaW52b2ljZS50eG5SYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRheEV4Y2hhbmdlUmF0ZTogdGhpcy5pbnZvaWNlLnRheEV4Y2hhbmdlUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlUmF0ZTogdGhpcy5pbnZvaWNlLmV4Y2hhbmdlUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZUFtb3VudDogdGhpcy5pbnZvaWNlLmV4Y2hhbmdlQW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaWNlTGV2ZWw6IHRoaXMuaW52b2ljZS5wcmljZUxldmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1MaW5lczogZGF0YVJvdywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50OiB0aGlzLmludm9pY2Uuc2VnbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjogdGhpcy5pbnZvaWNlLmxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3Q6IHRoaXMuaW52b2ljZS5wcm9qZWN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhbGVDaGFubmVsOiB0aGlzLmludm9pY2Uuc2FsZUNoYW5uZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1wbG95ZWU6IHRoaXMuaW52b2ljZS5lbXBsb3llZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaWxsaW5nQWRkcmVzczogdGhpcy5pbnZvaWNlLmJpbGxpbmdBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGl2ZXJ5QWRkcmVzczogdGhpcy5pbnZvaWNlLmRlbGl2ZXJ5QWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeURhdGVUaW1lOiB0aGlzLmludm9pY2UuZGVsaXZlcnlEYXRlVGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbk5vdGU6IHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbk5vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgam91cm5hbE5vdGU6IHRoaXMuaW52b2ljZS5qb3VybmFsTm90ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJUb3RhbDogdGhpcy5pbnZvaWNlLnN1YlRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlU3ViVG90YWw6IHRoaXMuaW52b2ljZS5leGNoYW5nZVN1YlRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiB0aGlzLmludm9pY2UudG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VUb3RhbDogcGFyc2VGbG9hdCh0aGlzLmludm9pY2UudG90YWwpICogcGFyc2VGbG9hdCh0aGlzLmludm9pY2UudHhuUmF0ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY291bnRUb3RhbDogdGhpcy5pbnZvaWNlLmRpc2NvdW50VG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNEaXNjb3VudFRvdGFsOiB0aGlzLmludm9pY2Uuc3BlY2lmaWNEaXNjb3VudFRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGl2ZXJ5RmVlOiB0aGlzLmludm9pY2UuZGVsaXZlcnlGZWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxUYXhBbW91bnQ6IHRoaXMuaW52b2ljZS50b3RhbFRheEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXBvc2l0QW1vdW50OiB0aGlzLmludm9pY2UuZGVwb3NpdEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXBvc2l0RGVkdWN0aW9uOiB0aGlzLmludm9pY2UuZGVwb3NpdERlZHVjdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdBbW91bnQ6IHRoaXMuaW52b2ljZS5yZW1haW5pbmdBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50RHVlOiB0aGlzLmludm9pY2UuYW1vdW50RHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCYWxhbmNlOiB0aGlzLmludm9pY2UuY3VycmVudEJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogdGhpcy5pbnZvaWNlLmJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlZGl0TGltaXQ6IHRoaXMuaW52b2ljZS5jcmVkaXRMaW1pdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXZlT3B0aW9uOiB0aGlzLmludm9pY2Uuc2F2ZU9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwcm92ZWRCeTogdGhpcy5pbnZvaWNlLmFwcHJvdmVkQnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybVRlbXBsYXRlOiB0aGlzLnRlbXBsYXRlc0Zvcm1bdGhpcy50ZW1wbGF0ZV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWNEaXNjb3VudEl0ZW06IHRoaXMuaW52b2ljZS5zcGVjaWZpY0Rpc2NvdW50SXRlbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdGhlckNoYXJnZTogdGhpcy5tT3RoZXJDaGFyZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJDaGFyZ2VMaW5lOiB0aGlzLmludm9pY2Uub3RoZXJDaGFyZ2VMaW5lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90aGVyQ2hhcmdlQW1vdW50OiB0aGlzLmludm9pY2Uub3RoZXJDaGFyZ2VBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF0ZUZlZTogdGhpcy5pbnZvaWNlLmxhdGVGZWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGF5bWVudE9wdGlvbldCTW9iaWxlOiB0aGlzLmludm9pY2UucGF5bWVudE9wdGlvbldCTW9iaWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBheW1lbnRPcHRpb25PbmxpbmU6IHRoaXMuaW52b2ljZS5wYXltZW50T3B0aW9uT25saW5lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBheW1lbnRPcHRpb25LSFFSOiB0aGlzLmludm9pY2UucGF5bWVudE9wdGlvbktIUVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVibGljTGluazogdGhpcy5pbnZvaWNlLnB1YmxpY0xpbmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF5bWVudENvZGU6IHRoaXMuaW52b2ljZS5wYXltZW50Q29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXhMaXN0VG90YWw6IHRoaXMudGF4TGlzdFRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVyRGlzY291bnRJdGVtOiB0aGlzLmN1c3RvbWVyRGlzY291bnRJdGVtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVyT3RoZXJDaGFyZ2VJdGVtOiB0aGlzLmN1c3RvbWVyLmN1c3RvbWVyT3RoZXJDaGFyZ2VJdGVtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVyU2FsZVVuaXQ6IHRoaXMuY3VzdG9tZXJTYWxlVW5pdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21lclNhbGVVbml0TGluZTogdGhpcy5jdXN0b21lclNhbGVVbml0TGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50U2NoZW1lOiB0aGlzLmludm9pY2UucGF5bWVudFNjaGVtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHRoaXMuaW52b2ljZS5jcmVhdGVkQXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VkVXNlcjogdGhpcy5sb2dnZWRVc2VyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVTZW5kOiBzYXZlU2VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0F1dG9HZW5lcmF0ZTogaXNBdXRvR2VuZXJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalJhdzogdGhpcy5qUmF3LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVRyYW5zYWN0aW9uOiBzb3VyY2VUeG4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVN1YnRvdGFsOiB0aGlzLmludm9pY2UuaXRlbVN1YnRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlSXRlbVN1YnRvdGFsOiB0aGlzLmludm9pY2UuZXhjaGFuZ2VJdGVtU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZVN1YnRvdGFsOiB0aGlzLmludm9pY2Uuc2VydmljZVN1YnRvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlU2VydmljZVN1YnRvdGFsOiB0aGlzLmludm9pY2UuZXhjaGFuZ2VTZXJ2aWNlU3VidG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhuSXRtU3VidG90YWw6IHRoaXMuaW52b2ljZS50eG5JdG1TdWJ0b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZVR4bkl0bVN1YnRvdGFsOiB0aGlzLmludm9pY2UuZXhjaGFuZ2VUeG5JdG1TdWJ0b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtRGlzY291bnQ6IHRoaXMuaW52b2ljZS5pdGVtRGlzY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VJdGVtRGlzY291bnQ6IHRoaXMuaW52b2ljZS5leGNoYW5nZUl0ZW1EaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlRGlzY291bnQ6IHRoaXMuaW52b2ljZS5zZXJ2aWNlRGlzY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjaGFuZ2VTZXJ2aWNlRGlzY291bnQ6IHRoaXMuaW52b2ljZS5leGNoYW5nZVNlcnZpY2VEaXNjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eG5JdG1EaXNjb3VudDogdGhpcy5pbnZvaWNlLnR4bkl0bURpc2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlVHhuSXRtRGlzY291bnQ6IHRoaXMuaW52b2ljZS5leGNoYW5nZVR4bkl0bURpc2NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2hQYXltZW50OiBuZXcgUGF5bWVudE9wdGlvbk1vZGVsKHRoaXMuaW52b2ljZS5jYXNoUGF5bWVudCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXJQYXltZW50OiBuZXcgUGF5bWVudE9wdGlvbk1vZGVsKHRoaXMuaW52b2ljZS5xclBheW1lbnQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbmtUcmFuc2ZlcjogbmV3IFBheW1lbnRPcHRpb25Nb2RlbCh0aGlzLmludm9pY2UuYmFua1RyYW5zZmVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaWxsUGF5bWVudDogbmV3IFBheW1lbnRPcHRpb25Nb2RlbCh0aGlzLmludm9pY2UuYmlsbFBheW1lbnQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZkZyb206IHRoaXMuaW52b2ljZS5yZWZGcm9tIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZlRvOiB0aGlzLmludm9pY2UucmVmVG8gfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FsZVRheERldGFpbDogdGhpcy5pbnZvaWNlLnNhbGVUYXhEZXRhaWwgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzaEJhc2ljSW5jb21lQWNjOiB0aGlzLmludm9pY2UuY2FzaEJhc2ljSW5jb21lQWNjIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvblR5cGU6IHRoaXMuJHJvdXRlLnBhcmFtcy5pZCA/IHRoaXMuJHJvdXRlLnF1ZXJ5LnR5cGUgOiAibmV3IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucXVlcnkudHlwZSA9PT0gInJlY3VycmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmlkID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYnRuRGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdEYXRhJywgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmlsbGluZ0hhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY3JlYXRlKGRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5jbG9zZShyZXNwb25zZS5kYXRhLmRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLiRyZWZzLmZvcm0ucmVzZXQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5idG5EaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5zdWNjZXNzKCJTdWNjZXNzZnVsbHkiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQcmludCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0UHJpbnQocmVzcG9uc2UuZGF0YS5kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2F2ZU5ldyA9PSAibmV3IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGVmYXVsdERhdGEoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmNsZWFyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKHJlc3BvbnNlLmRhdGEuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYnRuRGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kc25vdGlmeS5lcnJvcigiU29tZXRoaW5nIHdlbnQgd3JvbmciKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvcnMucHVzaChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbG9zZShkYXRhKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICJDdXN0b21lcnMiLAogICAgICAgICAgICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LmdvKC0xKTsKICAgICAgICAgICAgICAgIC8vIHRoaXMuJHJvdXRlci5wdXNoKHsKICAgICAgICAgICAgICAgIC8vICAgICBwYXRoOiAiaW52b2ljZV92aWV3IiwKICAgICAgICAgICAgICAgIC8vICAgICBuYW1lOiAiSW52b2ljZSBWaWV3IiwKICAgICAgICAgICAgICAgIC8vICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHdpbmRvdy5jb25zb2xlLmxvZyhkYXRhLCAnZGF0YScpCiAgICAgICAgfSwKICAgICAgICBzYXZlTmV3KCkgewogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlUm93KGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCBncmlkID0ga2VuZG8ualF1ZXJ5KCIjZ3JpZEl0ZW1MaW5lIikuZGF0YSgia2VuZG9HcmlkIiksCiAgICAgICAgICAgICAgICBkYXRhU291cmNlID0gZ3JpZC5kYXRhU291cmNlLAogICAgICAgICAgICAgICAgZGF0YUl0ZW0gPSBncmlkLmRhdGFJdGVtKCQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCJ0ciIpKTsKCiAgICAgICAgICAgIGlmIChkYXRhU291cmNlLnRvdGFsKCkgPiAxKSB7CiAgICAgICAgICAgICAgICBkYXRhU291cmNlLnJlbW92ZShkYXRhSXRlbSk7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9DYWxjdWxhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2VuZXJhdGVOdW1iZXIoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlID0gbmV3IERhdGUodGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZSk7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFuRGF0ZUludm9pY2UgPSBuZXcgRGF0ZSh0aGlzLmludm9pY2UudHJhbnNhY3Rpb25EYXRlKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5EYXRlTSA9IHRyYW5EYXRlLmdldEZ1bGxZZWFyKCkgKyB0cmFuRGF0ZS5nZXRNb250aCgpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhbkRhdGVJbnZvaWNlTSA9CiAgICAgICAgICAgICAgICAgICAgdHJhbkRhdGVJbnZvaWNlLmdldEZ1bGxZZWFyKCkgKyB0cmFuRGF0ZUludm9pY2UuZ2V0TW9udGgoKTsKICAgICAgICAgICAgICAgIGlmICh0cmFuRGF0ZU0gPT09IHRyYW5EYXRlSW52b2ljZU0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UucmVmZXJlbmNlTm8gPSB0aGlzLnJlZmVyZW5jZU5vOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUgIT09ICIiICYmIHRoaXMuaW52b2ljZVR5cGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGxldCBkYXRhID0gewogICAgICAgICAgICAgICAgICAgIGFiYnI6IHRoaXMuaW52b2ljZS50cmFuc2FjdGlvblR5cGUuYWJiciwKICAgICAgICAgICAgICAgICAgICBzdHJ1Y3R1cmU6IHRoaXMuaW52b2ljZS50cmFuc2FjdGlvblR5cGUuc3RydWN0dXJlLAogICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uRGF0ZTogdGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZSwKICAgICAgICAgICAgICAgICAgICBzZXF1Y2VuY2luZzogdGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uVHlwZS5zZXF1Y2VuY2luZywKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiSW52b2ljZSIsCiAgICAgICAgICAgICAgICAgICAgZW50aXR5OiAxLAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJpbGxpbmdIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgLmxhc3ROdW1iZXIoZGF0YSkKICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXMgPSByZXNwb25zZS5kYXRhLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0TnVtYmVyID0gdGhpcy56ZXJvUGFkKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlSW50KHJlcy5sYXN0TnVtYmVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25UeXBlLmZvcm1hdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG51bWJlciA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnN1ZmZpeCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uVHlwZS5udW1iZXJTZXBhcmF0b3IgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3ROdW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UubnVtYmVyID0gbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvcnMucHVzaChlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgemVyb1BhZChudW0sIHBsYWNlcykgewogICAgICAgICAgICByZXR1cm4gU3RyaW5nKG51bSkucGFkU3RhcnQocGxhY2VzLCAiMCIpOwogICAgICAgIH0sCiAgICAgICAgc3VmZml4KHRyYW5zYWN0aW9uRGF0ZSkgewogICAgICAgICAgICByZXR1cm4ga2VuZG8udG9TdHJpbmcobmV3IERhdGUodHJhbnNhY3Rpb25EYXRlKSwgYHl5bW1gKTsKICAgICAgICB9LAogICAgICAgIGVycm9yTWVzc2FnZSgpIHsKICAgICAgICB9LAogICAgICAgIGFjY291bnREcm9wRG93bkVkaXRvcigpIHsKICAgICAgICB9LAogICAgICAgIGNhbmNlbCgpIHsKICAgICAgICAgICAgdGhpcy4kc3dhbCh7CiAgICAgICAgICAgICAgICB0aXRsZTogaTE4bi50KCJtc2dfdGl0bGVfd2FybmluZyIpLAogICAgICAgICAgICAgICAgdGV4dDogaTE4bi50KCJtc2dfZGlzY2FyZCIpLAogICAgICAgICAgICAgICAgaWNvbjogIndhcm5pbmciLAogICAgICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogdHJ1ZSwKICAgICAgICAgICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IGkxOG4udCgiY2FuY2VsIiksCiAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uQ29sb3I6ICIjNGQ0ODQ4IiwKICAgICAgICAgICAgICAgIGNhbmNlbEJ1dHRvbkNvbG9yOiAiI0VEMUEzQSIsCiAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dDogaTE4bi50KCJkaXNjYXJkIiksCiAgICAgICAgICAgIH0pLnRoZW4oKHJlc3VsdCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHJlc3VsdC52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZXIuZ28oLTEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGhpZGVTbWFsbFNpZGViYXIoKSB7CiAgICAgICAgICAgIHRoaXMuaXNIaWRlQmFyID0gIXRoaXMuaXNIaWRlQmFyOwogICAgICAgIH0sCiAgICAgICAgcmVxdWVzdERhdGEoc2tpcCwgZmlsdGVyLCBiYXNlVXJsKSB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IGJhc2VVcmwgKyBgP2ZpbHRlcj0ke2ZpbHRlcn1gOwogICAgICAgICAgICB0aGlzLnJlcXVlc3RTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgZmV0Y2godXJsKQogICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbih0aGlzLmFmdGVyRmV0Y2gpOwogICAgICAgIH0sCiAgICAgICAgcmVxdWVzdERhdGFfKHNraXAsIGZpbHRlciwgYmFzZVVybCkgewogICAgICAgICAgICBjb25zdCB1cmwgPSBiYXNlVXJsICsgYC8ke2ZpbHRlcn1gOwogICAgICAgICAgICB0aGlzLnJlcXVlc3RTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgZmV0Y2godXJsKQogICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbih0aGlzLmFmdGVyRmV0Y2hfKTsKICAgICAgICB9LAogICAgICAgIG9uQ2hhbmdlKGV2ZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVt0ZXh0RmllbGRdID09PSBlbXB0eUl0ZW1bdGV4dEZpZWxkXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGlkID0gdmFsdWUuaWQgfHwgJycKICAgICAgICAgICAgaWYgKGlkICE9PSAnJykgewogICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCd2YWx1ZScsIHZhbHVlKQogICAgICAgICAgICAgICAgdGhpcy5jdXN0b21lciA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmN1c3RvbWVyID0gdmFsdWU7CiAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UuYmlsbFBheW1lbnQgPSB0aGlzLmN1c3RvbWVyLmJpbGxQYXltZW50CiAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UucXJQYXltZW50ID0gdGhpcy5jdXN0b21lci5xclBheW1lbnQKICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5jYXNoUGF5bWVudCA9IHRoaXMuY3VzdG9tZXIuY2FzaFBheW1lbnQKICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5iYW5rVHJhbnNmZXIgPSB0aGlzLmN1c3RvbWVyLmJhbmtUcmFuc2ZlcgogICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHRoaXMuaW52b2ljZS5jdXN0b21lciwgJ0NoYW5nZWQnKQogICAgICAgICAgICAgICAgLy8gdGhpcy5pbnZvaWNlID0gdmFsdWUKICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5yZWNlaXZhYmxlQWNjID0gdmFsdWUucmVjZWl2YWJsZUFjYyB8fCB7fQogICAgICAgICAgICAgICAgLy8gdGhpcy5pbnZvaWNlLnBheW1lbnRUZXJtID0gdmFsdWUuaGFzT3duUHJvcGVydHkoInBheW1lbnRUZXJtIikKICAgICAgICAgICAgICAgIC8vICAgICA/IHZhbHVlLnBheW1lbnRUZXJtCiAgICAgICAgICAgICAgICAvLyAgICAgOiB7fTsKICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5wcmljZUxldmVsID0gdmFsdWUucHJpY2VMZXZlbCB8fCB7fQogICAgICAgICAgICAgICAgY29uc3QgYmFzZUN1cnJlbmN5ID0gdmFsdWUuYmFzZUN1cnJlbmN5IHx8IHt9CiAgICAgICAgICAgICAgICBpZiAoYmFzZUN1cnJlbmN5Lmhhc093blByb3BlcnR5KCJjb2RlIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VDdXJyZW5jeUNvZGUgPSAiICIgKyBiYXNlQ3VycmVuY3kuY29kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHByaWNlTGV2ZWwgPSB2YWx1ZS5wcmljZUxldmVsIHx8IHt9CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW5jeSA9IHByaWNlTGV2ZWwuY3VycmVuY3kgfHwge30KICAgICAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBjdXJyZW5jeS5jb2RlIHx8ICcnCiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coJ3ByaWNlTGV2ZWw6ICcgKyBKU09OLnN0cmluZ2lmeShwcmljZUxldmVsKSkKICAgICAgICAgICAgICAgIGlmIChjb2RlICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZFRyYW5zYWN0aW9uUmF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5iaWxsaW5nQWRkcmVzcyA9IHZhbHVlLmJpbGxpbmdBZGRyZXNzIHx8IFtdCiAgICAgICAgICAgICAgICB0aGlzLmRlbGl2ZXJ5QWRkcmVzcyA9IHZhbHVlLmRlbGl2ZXJ5QWRkcmVzcyB8fCBbXQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmlsbGluZ0FkZHJlc3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5iaWxsaW5nQWRkcmVzcyA9IHRoaXMuYmlsbGluZ0FkZHJlc3NbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWxpdmVyeUFkZHJlc3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5kZWxpdmVyeUFkZHJlc3MgPSB0aGlzLmRlbGl2ZXJ5QWRkcmVzc1swXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMub25JbnZvaWNlRGF0ZUNoYW5nZWQoKTsKICAgICAgICAgICAgICAgIHRoaXMubG9hZFByb2plY3RCeUN1c3RvbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gdGhpcy5sb2FkQ3VzdG9tZXJCYWxhbmNlKHRoaXMuY3VzdG9tZXIuaWQpOwogICAgICAgICAgICAvLyB0aGlzLmxvYWRDcmVkaXRMaW1pdCgpOwogICAgICAgICAgICAvLyB0aGlzLmxvYWRQYXltZW50VGVybUxpc3QoKTsKICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKHZhbHVlLCAndmFsdWUnKQogICAgICAgIH0sCiAgICAgICAgb25FbXBsb3llZUNoYW5nZWQoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBldmVudC52YWx1ZTsKICAgICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlW3RleHRGaWVsZF0gPT09IGVtcHR5SXRlbVt0ZXh0RmllbGRdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5tRW1wbG95ZWUgPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLmVtcGxveWVlID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBhZnRlckZldGNoKGpzb24pIHsKICAgICAgICAgICAgdGhpcy5jdXN0b21lckxpc3QgPSBqc29uLmRhdGE7CiAgICAgICAgfSwKICAgICAgICBhZnRlckZldGNoXyhqc29uKSB7CiAgICAgICAgICAgIHRoaXMuZW1wbG95ZWVzID0ganNvbi5kYXRhOwogICAgICAgIH0sCiAgICAgICAgb25GaWx0ZXJDaGFuZ2UoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgZmlsdGVyID0gZXZlbnQuZmlsdGVyLnZhbHVlOwogICAgICAgICAgICB0aGlzLnJlcXVlc3REYXRhKDAsIGZpbHRlciwgdGhpcy5jdXNCYXNlVXJsKTsKICAgICAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7CiAgICAgICAgfSwKICAgICAgICBvbkVtcGxveWVlRmlsdGVyQ2hhbmdlZChldmVudCkgewogICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBldmVudC5maWx0ZXIudmFsdWU7CiAgICAgICAgICAgIHRoaXMucmVxdWVzdERhdGFfKDAsIGZpbHRlciwgdGhpcy5lbXBCYXNlVXJsKTsKICAgICAgICAgICAgdGhpcy5maWx0ZXJfID0gZmlsdGVyOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgaW5pdERhdGEoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkVmlld0ludm9pY2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0RGVmYXVsdERhdGEoKQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkTGF0ZUZlZSgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJpY2VMZXZlbCA9IHRoaXMuaW52b2ljZS5wcmljZUxldmVsIHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVuY3kgPSBwcmljZUxldmVsLmN1cnJlbmN5IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29kZSA9IGN1cnJlbmN5LmNvZGUgfHwgJycKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2NvZGU9JyArIGNvZGUKICAgICAgICAgICAgICAgICAgICBsYXRlRmVlSGFuZGxlci5saXN0KHN0ckZpbHRlcikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGF0ZUZlZUxpc3QgPSByZXMuZGF0YS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFzeW5jIGxvYWRWaWV3SW52b2ljZSgpIHsKICAgICAgICAgICAgdGhpcy5idG5EaXNhYmxlZCA9IGZhbHNlCiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBiaWxsaW5nSGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZpZXcodGhpcy4kcm91dGUucGFyYW1zLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UgPSByZXMuZGF0YS5kYXRhWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZmVyZW5jZU5vID0gdGhpcy5pbnZvaWNlLnJlZmVyZW5jZU5vOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25EYXRlID0gbmV3IERhdGUodGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tZXIgPSB0aGlzLmludm9pY2UuY3VzdG9tZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubUVtcGxveWVlID0gdGhpcy5pbnZvaWNlLmVtcGxveWVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRheExpc3RUb3RhbCA9IHRoaXMuaW52b2ljZS50YXhMaXN0VG90YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbUxpbmVzID0gdGhpcy5pbnZvaWNlLml0ZW1MaW5lczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tT3RoZXJDaGFyZ2UgPSB0aGlzLmludm9pY2Uub3RoZXJDaGFyZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwb3NpdERlZHVjdGlvbiA9IHRoaXMuaW52b2ljZS5kZXBvc2l0RGVkdWN0aW9uOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgeFJhdGUgPSB0aGlzLmludm9pY2UuZXhjaGFuZ2VSYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY3VycmVuY3lDb2RlID0geFJhdGUuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93LmNvbnNvbGUubG9nKCdjdXJyZW5jeUNvZGUnLCB4UmF0ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZUhhbmRsZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gdGhpcy5pbnZvaWNlLmZvcm1UZW1wbGF0ZS5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5qUmF3ID0gdGhpcy5pbnZvaWNlLmpSYXcgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5tT3RoZXJDaGFyZ2UubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFNlbGVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZFByb2plY3RCeUN1c3RvbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1c3RvbWVyLmhhc093blByb3BlcnR5KCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRDdXN0b21lckJhbGFuY2UodGhpcy5jdXN0b21lci5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYWxlT3JkZXJzID0gdGhpcy5pbnZvaWNlLnJlZkZyb20gfHwgW10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnF1ZXJ5LnR5cGUgPT09ICJyZWN1cnJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmhhc093blByb3BlcnR5KCJ0cmFuc2FjdGlvbkRhdGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygidHlwZSIsIHRoaXMuJHJvdXRlLnBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZSA9IG5ldyBEYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3V0ZS5wYXJhbXMudHJhbnNhY3Rpb25EYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UudHJhbnNhY3Rpb25EYXRlID0gbmV3IERhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlLnBhcmFtcy50cmFuc2FjdGlvbkRhdGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25JbnZvaWNlRGF0ZUNoYW5nZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlbmVyYXRlTnVtYmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgY29uc3QgdGVybSA9IHRoaXMuaW52b2ljZS5wYXltZW50VGVybSB8fCB7fQogICAgICAgICAgICBjb25zdCBwcmljZUwgPSB0aGlzLmludm9pY2UucHJpY2VMZXZlbCB8fCB7fQogICAgICAgICAgICB0aGlzLmlkID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLml0ZW1MaW5lcyA9IFtdCiAgICAgICAgICAgIHRoaXMuaW52b2ljZSA9IG5ldyBJbnZvaWNlTW9kZWwoKTsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnBheW1lbnRUZXJtID0gdGVybQogICAgICAgICAgICB0aGlzLmludm9pY2UucHJpY2VMZXZlbCA9IHByaWNlTAogICAgICAgICAgICB0aGlzLmN1c3RvbWVyID0gJycKICAgICAgICAgICAgdGhpcy5lbXBsb3llZSA9ICcnCiAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVycyA9IFtdCiAgICAgICAgICAgIHRoaXMuaW52b2ljZS50cmFuc2FjdGlvblR5cGUgPSB0aGlzLmludm9pY2VUeXBlc1swXTsKICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZFRyYW5zYWN0aW9uUmF0ZSgpIHsKICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoInJlc29sdmVkIik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUpLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDAsIDEwKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmljZUxldmVsID0gdGhpcy5pbnZvaWNlLnByaWNlTGV2ZWwgfHwge307CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVuY3kgPSBwcmljZUxldmVsLmN1cnJlbmN5IHx8IHt9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29kZSA9IGN1cnJlbmN5LmNvZGUgfHwgJycKICAgICAgICAgICAgICAgICAgICBpZiAoY29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVuY3lIYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TGFzdEV4Y2hhbmdlUmF0ZUJ5RGF0ZShkYXRlLCBjb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdGF0dXNDb2RlID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4Y2hhbmdlUmF0ZSA9IHJlcy5kYXRhLmRhdGFbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVuY3lDb2RlID0gdGhpcy5leGNoYW5nZVJhdGUuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvblJhdGUgPSB0aGlzLmV4Y2hhbmdlUmF0ZS5yYXRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UudHhuUmF0ZSA9IHRoaXMuZXhjaGFuZ2VSYXRlLnJhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5leGNoYW5nZVJhdGUgPSB0aGlzLmV4Y2hhbmdlUmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRDdXN0b21lckRlcG9zaXRCYWxhbmNlKHRoaXMuY3VzdG9tZXIuaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRTYWxlT3JkZXIoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRUcmFuc2FjdGlvblRheFJhdGUoKTsKICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkVHJhbnNhY3Rpb25UYXhSYXRlKCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUodGhpcy5pbnZvaWNlLnRyYW5zYWN0aW9uRGF0ZSkudG9JU09TdHJpbmcoKS5zdWJzdHIoMCwgMTApOwogICAgICAgICAgICAgICAgICAgIGxldCBjb2RlID0gIktIUiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGUgIT09IHVuZGVmaW5lZCB8fCBjb2RlICE9PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW5jeUhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRMYXN0RXhjaGFuZ2VSYXRlQnlEYXRlKGRhdGUsIGNvZGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UudGF4RXhjaGFuZ2VSYXRlID0gcmVzLmRhdGEuZGF0YVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbG9hZENyZWRpdExpbWl0KCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXN0b21lcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2lkPScgKyB0aGlzLmN1c3RvbWVyLmlkICsgJyZ0cmFuc2FjdGlvbkRhdGU9JyArIHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUgKyAnJnR5cGU9Q3VzdG9tZXInCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5jcmVkaXRMaW1pdCA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgY3JlZGl0TGltaXRIYW5kbGVyLmdldChzdHJGaWx0ZXIpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLnN0YXR1c0NvZGUgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY3JlZGl0TGltaXRJdGVtID0gcmVzLmRhdGEuZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyZWRpdCA9IHJlcy5kYXRhLmRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9pY2UuY3JlZGl0TGltaXQgPSBrZW5kby5wYXJzZUZsb2F0KGNyZWRpdC5hbW91bnQgfHwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhc3luYyBsb2FkUGF5bWVudFRlcm1MaXN0KCkgewogICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgicmVzb2x2ZWQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXN0b21lcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJGaWx0ZXIgPSAnP2lkPScgKyB0aGlzLmN1c3RvbWVyLmlkICsgJyZ0cmFuc2FjdGlvbkRhdGU9JyArIHRoaXMuaW52b2ljZS50cmFuc2FjdGlvbkRhdGUgKyAnJnR5cGU9Q3VzdG9tZXInCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5wYXltZW50VGVybSA9IHt9CiAgICAgICAgICAgICAgICAgICAgICAgIHBheW1lbnRUZXJtSGFuZGxlcl8uZ2V0KHN0ckZpbHRlcikudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuc3RhdHVzQ29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVybXMgPSByZXMuZGF0YS5kYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZvaWNlLnBheW1lbnRUZXJtID0gdGVybXMudGVybQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2ljZS5hcHByb3ZlZFRlcm0gPSB0ZXJtcy50ZXJtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vblBheW1lbnRUZXJtQ2hhbmdlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBvblByaWNlTGV2ZWxDaGFuZ2UoKSB7CiAgICAgICAgICAgIHRoaXMuaXNQcmljZUxldmVsQ2hhbmdlZCA9IHRydWUKICAgICAgICAgICAgdGhpcy5sb2FkVHJhbnNhY3Rpb25SYXRlKCkKICAgICAgICAgICAgdGhpcy5jbGVhclVPTUl0ZW0oKQogICAgICAgICAgICB0aGlzLmxvYWRMYXRlRmVlKCkKICAgICAgICB9LAogICAgICAgIGFzeW5jIGNsZWFyVU9NSXRlbSgpIHsKICAgICAgICAgICAgbGV0IGRzID0gdGhpcy4kcmVmcy5pdGVtTGluZURTLmtlbmRvV2lkZ2V0KCkKICAgICAgICAgICAgZHMuZGF0YSgpLm1hcChuID0+IHsKICAgICAgICAgICAgICAgIG4uc2V0KCd1b20nLCB7fSkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5pc1ByaWNlTGV2ZWxDaGFuZ2VkID0gZmFsc2UKICAgICAgICB9LAogICAgICAgIHNldERlZmF1bHREYXRhKCkgewogICAgICAgICAgICBsZXQgZHMgPSB0aGlzLiRyZWZzLml0ZW1MaW5lRFMua2VuZG9XaWRnZXQoKTsKICAgICAgICAgICAgZHMuZGF0YShbXSk7CiAgICAgICAgICAgIGNvbnN0IHRlcm0gPSB0aGlzLmludm9pY2UucGF5bWVudFRlcm0gfHwge30KICAgICAgICAgICAgY29uc3QgcHJpY2VMID0gdGhpcy5pbnZvaWNlLnByaWNlTGV2ZWwgfHwge30KICAgICAgICAgICAgdGhpcy5pZCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5pbnZvaWNlID0gbmV3IEludm9pY2VNb2RlbCgpOwogICAgICAgICAgICB0aGlzLmludm9pY2UucGF5bWVudFRlcm0gPSB0ZXJtCiAgICAgICAgICAgIHRoaXMuaW52b2ljZS5wcmljZUxldmVsID0gcHJpY2VMCiAgICAgICAgICAgIHRoaXMuY3VzdG9tZXIgPSB7fQogICAgICAgICAgICB0aGlzLm1FbXBsb3llZSA9IHt9CiAgICAgICAgICAgIHRoaXMuc2FsZU9yZGVycyA9IFtdCiAgICAgICAgICAgIHRoaXMuaW52b2ljZS50cmFuc2FjdGlvblR5cGUgPSB0aGlzLmludm9pY2VUeXBlc1swXTsKICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZU51bWJlcigpOwogICAgICAgICAgICB0aGlzLmxvYWRTZWdtZW50KCk7CiAgICAgICAgICAgIHRoaXMubG9hZExvY2F0aW9uKCk7CiAgICAgICAgICAgIHRoaXMuYWRkUm93KCkKICAgICAgICAgICAgLy8gdGhpcy5hZGRSb3coKQogICAgICAgIH0KICAgIH0sCiAgICBjb21wdXRlZDogewogICAgICAgIGRpc2FibGVkU0xQKCkgewogICAgICAgICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWZGID0gdGhpcy5pbnZvaWNlLnJlZkZyb20gfHwgW10KICAgICAgICAgICAgICAgIGlmIChyZWZGLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gISFyZWZGLmxlbmd0aCA+IDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9LAogICAgICAgIGRpc2FibGVkTWUoKSB7CiAgICAgICAgICAgIHJldHVybiAhIXRoaXMuJHJvdXRlLnBhcmFtcy5pZDsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVkRGVwb3NpdCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJHJvdXRlLnBhcmFtcy5pZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVwb3NpdERlZHVjdGlvbiA+IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdmFsaWRDdXN0b21lcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jdXN0b21lci5pZCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuY3VzdG9tZXIuaWQgIT09IG51bGw7CiAgICAgICAgfSwKICAgICAgICBoaWRkZW5CdXR0b24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRyb3V0ZS5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLy8gZGVwb3NpdERlZHVjdGlvbjogewogICAgICAgIC8vICAgICBnZXQodmFsdWUpIHsKICAgICAgICAvLyAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIC8vICAgICB9LCBzZXQodmFsdWUpIHsKICAgICAgICAvLyAgICAgICAgIHRoaXMuJGVtaXQoJ2RlcG9zaXREZWR1Y3Rpb24nLCB2YWx1ZSkKICAgICAgICAvLyAgICAgfQogICAgICAgIC8vIH0KICAgIH0sCiAgICB3YXRjaDogewogICAgICAgIC8vIGlkKCkgewogICAgICAgIC8vICAgICBpZiAodGhpcy4kcm91dGUucGFyYW1zLmlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyAgICAgICAgIHRoaXMuc2V0RGVmYXVsdERhdGEoKTsKICAgICAgICAvLyAgICAgfSBlbHNlIHsKICAgICAgICAvLyAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcgPSB0cnVlOwogICAgICAgIC8vICAgICAgICAgdGhpcy5sb2FkVmlld0ludm9pY2UoKTsKICAgICAgICAvLyAgICAgfQogICAgICAgIC8vIH0sCiAgICAgICAgJyRyb3V0ZSc6ICdsb2FkU2FsZUZvcm1Db250ZW50JwogICAgfSwKICAgIGNyZWF0ZWQoKSB7CiAgICAgICAgdGhpcy5sb2FkUHJpY2VMZXZlbCgpOwogICAgICAgIHRoaXMubG9hZFRheCgpOwogICAgICAgIHRoaXMubG9hZFNhbGVVbml0SXRlbXMoKTsKICAgICAgICB0aGlzLmxvYWRQcmVmaXgoKTsKICAgICAgICAvLyB0aGlzLmxvYWRMYXRlRmVlKCk7CiAgICAgICAgdGhpcy5sb2FkU2VnbWVudCgpOwogICAgICAgIHRoaXMubG9hZExvY2F0aW9uKCk7CiAgICAgICAgdGhpcy5sb2FkUGF5bWVudE9wdGlvbigpOwogICAgfSwKICAgIG1vdW50ZWQ6IGFzeW5jIGZ1bmN0aW9uICgpIHsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRTYWxlRm9ybUNvbnRlbnQoKTsKICAgICAgICB0aGlzLnJlcXVlc3REYXRhKDAsIHRoaXMuZmlsdGVyLCB0aGlzLmN1c0Jhc2VVcmwpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZERpc2NvdW50SXRlbSgpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZFNhbGVDaGFubmVsKCk7CiAgICAgICAgYXdhaXQgdGhpcy5sb2FkRW1wbG95ZWVDZW50ZXIoKTsKICAgICAgICBhd2FpdCB0aGlzLmxvYWRQYXltZW50VGVybSgpOwogICAgICAgIGF3YWl0IHRoaXMubG9hZEFjY291bnQoKTsKICAgICAgICAvLyBhd2FpdCB0aGlzLmxvYWRDdXJyZW5jeSgpCiAgICAgICAgYXdhaXQgdGhpcy5sb2FkT3RoZXJDaGFyZ2UoKTsKICAgICAgICAvLyBhd2FpdCB0aGlzLmxvYWRDYXRhbG9ncygpCiAgICAgICAgLy8gYXdhaXQgdGhpcy5pbml0RGF0YSgpCiAgICAgICAgYXdhaXQgdGhpcy5sb2FkVmlld0ludm9pY2UoKQogICAgfSwKfTsK"},{"version":3,"sources":["Invoice.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8uCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Invoice.vue","sourceRoot":"src/views/customers","sourcesContent":["<template>\n    <v-app class=\"zoom-in\">\n        <v-container>\n            <v-row>\n                <v-col sm=\"12\" cols=\"12\">\n                    <v-card\n                        outlined\n                        dense\n                        class=\"pa-4 no_border rounded-sm\"\n                        color=\"white\">\n                        <v-row>\n                            <v-col\n                                class=\"bigSide pr-2 py-0\"\n                                sm=\"8\"\n                                cols=\"12\"\n                                style=\"transition: .3s ease-in;\"\n                                :class=\"{ hide_big_bar_class: isHideBar }\">\n                                <v-form ref=\"form\" v-model=\"valid\" lazy-validation>\n                                    <v-card outlined dense class=\"no_border\">\n                                        <h2 class=\"mb-0\">{{ $t(\"invoice\") }}</h2>\n                                        <v-icon\n                                            v-if=\"isHideBar\"\n                                            @click=\"cancel()\"\n                                            style=\"cursor: pointer; color: #333; font-size: 40px;\"\n                                            class=\"float-right\">close\n                                        </v-icon>\n                                        <span style=\"transition: .3s ease-in; z-index:10;\"\n                                              :class=\"{ iconArrow: !isHideBar, iconArrowHide: isHideBar}\">\n                                            <v-icon\n                                                size=\"22\"\n                                                class=\"arr_icon\"\n                                                @click=\"hideSmallSidebar\"\n                                                v-if=\"isHideBar\">mdi-chevron-left-circle\n                                            </v-icon>\n                                            <v-icon\n                                                size=\"22\"\n                                                class=\"arr_icon\"\n                                                @click=\"hideSmallSidebar\"\n                                                v-if=\"!isHideBar\">mdi-chevron-right-circle\n                                            </v-icon>\n                                        </span>\n                                    </v-card>\n                                    <v-card outlined dense class=\"px-4 no_border\" color=\"grayBg\">\n                                        <v-row>\n                                            <v-col sm=\"4\" cols=\"12\" class=\"pb-0 pt-4\">\n                                                <label class=\"label  mb-0\">{{ $t(\"customer\") }}</label>\n                                                <v-col\n                                                    sm=\"12\"\n                                                    cols=\"12\"\n                                                    class=\"kendo_dropdown_custom px-0 pb-3 pt-0\">\n                                                    <dropdownlist\n                                                        :data-items=\"customerList\"\n                                                        @change=\"onChange\"\n                                                        :value=\"customer\"\n                                                        :data-item-key=\"dataItemKey\"\n                                                        :text-field=\"textField\"\n                                                        :default-item=\"defaultItem\"\n                                                        :filterable=\"true\"\n                                                        :required=\"true\"\n                                                        :disabled=\"disabledMe\"\n                                                        :valid=\"validCustomer\"\n                                                        @filterchange=\"onFilterChange\">\n                                                    </dropdownlist>\n                                                </v-col>\n                                                <label class=\"label mb-0\">{{ $t(\"invoice_type\") }}</label>\n                                                <v-select\n                                                    class=\"mt-1\"\n                                                    :items=\"invoiceTypes\"\n                                                    item-value=\"id\"\n                                                    item-text=\"name\"\n                                                    :disabled=\"disabledMe\"\n                                                    v-model=\"invoice.transactionType\"\n                                                    @change=\"onInvoiceTypeChanged\"\n                                                    :rules=\"[(v) => !!v || 'Transaction Currency is required']\"\n                                                    return-object\n                                                    outlined/>\n                                                <label class=\"label  mb-0\">{{ $t(\"date\") }}</label>\n                                                <app-datepicker\n                                                    :initialDate=\"invoice.transactionDate\"\n                                                    :disabled=\"disabledMe\"\n                                                    @onChanged=\"onInvoiceDateChanged\"\n                                                    @emitDate=\"invoice.transactionDate = $event\"/>\n                                                <label class=\"label mb-0\">{{ $t(\"number\") }}</label>\n                                                <v-row class=\"mt-1 mr-0\">\n                                                    <v-col sm=\"3\" cols=\"3\" class=\"py-0 pr-0\">\n                                                        <div class=\"code_text text-bold\">\n                                                            {{ invoice.transactionType.abbr }}\n                                                        </div>\n                                                    </v-col>\n                                                    <v-col sm=\"7\" cols=\"7\" class=\"py-0 pl-0 pr-1\">\n                                                        <v-text-field\n                                                            class=\" custom-border \"\n                                                            v-model=\"invoice.number\"\n                                                            outlined\n                                                            disabled\n                                                            :rules=\"[(v) => !!v || 'Number is required']\"\n                                                            required/>\n                                                    </v-col>\n                                                    <v-col sm=\"2\" cols=\"2\" class=\"py-0 px-0\">\n                                                        <v-icon\n                                                            color=\"black\"\n                                                            size=\"30\"\n                                                            class=\"border_qrcode\"\n                                                            :disabled=\"disabledMe\"\n                                                            @click=\"generateNumber\">mdi-qrcode\n                                                        </v-icon>\n                                                    </v-col>\n                                                </v-row>\n                                            </v-col>\n                                            <v-col sm=\"8\" cols=\"12\" class=\"pt-4 pb-0\">\n                                                <v-row>\n                                                    <v-col sm=\"6\" cols=\"12\" class=\" pt-0\">\n                                                        <p class=\"mb-1 d-block\">\n                                                            {{ $t(\"current_balance\") }}\n                                                        </p>\n                                                        <h3 class=\"color_green float-right\">\n                                                            {{\n                                                                numberFormat(invoice.currentBalance)\n                                                            }}{{ baseCurrencyCode }}\n                                                        </h3>\n                                                    </v-col>\n                                                    <v-col sm=\"6\" cols=\"12\" class=\"pl-0 pt-0\">\n                                                        <p class=\"mb-1 d-block\">\n                                                            {{ $t(\"credit_limit_allowed\") }}\n                                                        </p>\n                                                        <h3 class=\"color_green float-left\">\n                                                            {{\n                                                                creditLimitUsage(invoice.currentBalance, invoice.creditLimit)\n                                                            }}\n                                                        </h3>\n                                                        <h3 class=\"color_green float-right\">\n                                                            {{ numberFormat(invoice.creditLimit) }}{{\n                                                                baseCurrencyCode\n                                                            }}\n                                                        </h3>\n                                                    </v-col>\n                                                </v-row>\n                                                <v-row class=\"mr-0 mt-1\">\n                                                    <v-col class=\"pb-0 pt-3\" sm=\"6\" cols=\"12\">\n                                                        <label class=\"label mb-0\">{{ $t(\"term\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"invoice.paymentTerm\"\n                                                            :items=\"paymentTerms\"\n                                                            @change=\"onPaymentTermChanged\"\n                                                            placeholder=\"Term\"\n                                                            :rules=\"[(v) => !!v['id'] || $t('is_required')]\"\n                                                            item-text=\"name\"\n                                                            item-value=\"id\"\n                                                            return-object\n                                                            outlined/>\n                                                        <label\n                                                            class=\"label mb-0\">{{ $t(\"accounts_receivable\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"invoice.receivableAcc\"\n                                                            :items=\"receivableAcc\"\n                                                            item-value=\"id\"\n                                                            :item-text=\"(item) => `${item.number} - ${item.name}`\"\n                                                            return-object\n                                                            placeholder=\"Account Receivable\"\n                                                            tage=\"Account Receivable\"\n                                                            outlined/>\n                                                        <div v-if=\"saleFormContent.lateFee\" id=\"hide\">\n                                                            <label class=\"label mb-0\">{{ $t(\"late_fee\") }}</label>\n                                                            <v-select\n                                                                class=\"mt-1\"\n                                                                v-model=\"invoice.lateFee\"\n                                                                :items=\"lateFeeList\"\n                                                                item-value=\"id\"\n                                                                :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                                return-object\n                                                                placeholder=\"Late Fee\"\n                                                                tage=\"Late Fee\"\n                                                                clearable\n                                                                outlined/>\n                                                        </div>\n                                                        <!--                                                        <label class=\"label mb-0\">{{ $t('discount_promotion') }}</label>-->\n                                                    </v-col>\n                                                    <v-col class=\"pb-0 pt-3 pr-0\" sm=\"6\" cols=\"12\">\n                                                        <label class=\"label  mb-0\">{{ $t(\"due_date\") }}</label>\n                                                        <app-datepicker\n                                                            :initialDate=\"invoice.dueDate\"\n                                                            @emitDate=\"dueDate = $event\"/>\n                                                        <!--                                                        <label class=\"label mb-0\">{{ $t('invoice_currency') }}</label>-->\n                                                        <!--                                                        <v-select class=\"mt-1\"-->\n                                                        <!--                                                                  v-model=\"invoice.currency\"-->\n                                                        <!--                                                                  :items=\"currencies\"-->\n                                                        <!--                                                                  placeholder=\"currency\"-->\n                                                        <!--                                                                  item-value=\"id\"-->\n                                                        <!--                                                                  :item-text=\"item =>`${item.code} - ${item.name}`\"-->\n                                                        <!--                                                                  return-object-->\n                                                        <!--                                                                  outlined-->\n                                                        <!--                                                                  clearable-->\n                                                        <!--                                                        />-->\n                                                        <label class=\"label mb-0\">{{ $t(\"price_level\") }}</label>\n                                                        <v-select\n                                                            class=\"mt-1\"\n                                                            v-model=\"invoice.priceLevel\"\n                                                            :items=\"priceLevel\"\n                                                            item-value=\"id\"\n                                                            @change=\"onPriceLevelChange\"\n                                                            :disabled=\"disabledMe\"\n                                                            item-text=\"name\"\n                                                            return-object\n                                                            placeholder=\"Price Level\"\n                                                            tage=\"Default Price Level\"\n                                                            outlined\n                                                            :rules=\"[(v) => !!v['id'] || $t('is_required')]\"/>\n                                                        <v-col\n                                                            sm=\"12\"\n                                                            col=\"12\"\n                                                            class=\"d-flex justify-space-between pt-0\">\n                                                            <div>\n                                                                <p class=\"label mb-0\">{{ $t(\"currency\") }}</p>\n                                                                <p class=\"label mb-0 mt-4\">{{ currencyCode }}</p>\n                                                            </div>\n                                                            <div>\n                                                                <p class=\"label mb-0\">{{ $t(\"rate\") }}</p>\n                                                                <p class=\"label mb-0 mt-4\">{{ transactionRate }}</p>\n                                                            </div>\n                                                        </v-col>\n                                                    </v-col>\n                                                </v-row>\n                                            </v-col>\n                                        </v-row>\n                                    </v-card>\n\n                                    <v-row style=\"background-color: #fff;\">\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pt-4 pb-0 px-4\">\n                                            <kendo-datasource\n                                                ref=\"itemLineDS\"\n                                                :data=\"itemLines\"\n                                                :change=\"dataSourceChanged\"/>\n                                            <kendo-grid\n                                                id=\"gridItemLine\"\n                                                class=\"grid-function\"\n                                                :data-source-ref=\"'itemLineDS'\"\n                                                :sortable=\"false\"\n                                                :column-menu=\"true\"\n                                                :editable=\"true\"\n                                                v-on:databound=\"dataBound\"\n                                                :scrollable-virtual=\"true\">\n                                                <kendo-grid-column\n                                                    :command=\"{iconClass: 'k-icon k-i-trash', text: ' ', click: removeRow, className: 'btn-plus isEditable'}\"\n                                                    :title=\"''\"\n                                                    :width=\"63\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"/>\n                                                <kendo-grid-column\n                                                    :title=\"$t('no.')\"\n                                                    :width=\"53\"\n                                                    :column-menu=\"false\"\n                                                    :template=\"rowNumberTmpl\"\n                                                    :headerAttributes=\"{style: 'background-color: #EDF1F5;', class: 'text-products'}\"\n                                                    :attributes=\"{style: 'text-align: products'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'serviceDate'\"\n                                                    :title=\"$t('date_from')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.serviceDate\"\n                                                    :template=\"'<span>#= kendo.toString(new Date(serviceDate), dateFormat)#</span>'\"\n                                                    :editor=\"ServiceDateEditor\"\n                                                    :headerAttributes=\"{style: 'background-color: #EDF1F5'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'serviceDateTo'\"\n                                                    :title=\"$t('date_to')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.serviceDateTo\"\n                                                    :template=\"'<span>#= kendo.toString(new Date(serviceDateTo), dateFormat)#</span>'\"\n                                                    :editor=\"ServiceDateToEditor\"\n                                                    :headerAttributes=\"{style: 'background-color: #EDF1F5'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'item'\"\n                                                    :title=\"$t('item')\"\n                                                    :template=\"itemTemplate\"\n                                                    :editor=\"ItemDropDownEditor\"\n                                                    :attributes=\"{class:'tb_name_td isEditable'}\"\n                                                    :width=\"200\"\n                                                    :headerAttributes=\"{style: 'background-color: #EDF1F5'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'description'\"\n                                                    :title=\"$t('description')\"\n                                                    :template=\"'<span>#=description#</span>'\"\n                                                    :width=\"200\"\n                                                    :headerAttributes=\"{style: 'background-color: #EDF1F5'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'uom'\"\n                                                    :title=\"$t('uom')\"\n                                                    :width=\"120\"\n                                                    :template=\"UOMTemplate\"\n                                                    :editor=\"UOMDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{style: 'text-align: left'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'qoh'\"\n                                                    :title=\"$t('on_hand')\"\n                                                    :template=\"qohTemplate\"\n                                                    :width=\"170\"\n                                                    :editable=\"() => {return false}\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5',}\"\n                                                    :attributes=\"{ style: 'text-align: right; ' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'qty'\"\n                                                    :title=\"$t('qty')\"\n                                                    :format=\"'{0:n}'\"\n                                                    :editor=\"numberEditor\"\n                                                    :template=\"'<span>#=qty || 0#</span>'\"\n                                                    :width=\"120\"\n                                                    :headerAttributes=\"{style: 'text-align: left; background-color: #EDF1F5',}\"\n                                                    :attributes=\"{ style: 'text-align: right; ' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'price'\"\n                                                    :title=\"$t('price')\"\n                                                    :width=\"200\"\n                                                    :template=\"'<span>#=kendo.toString(price || 0, decimalFormat)#</span>'\"\n                                                    :editor=\"numberEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5',}\"\n                                                    :attributes=\"{style: 'text-align: right'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'amount'\"\n                                                    :title=\"$t('amount')\"\n                                                    :width=\"200\"\n                                                    :editable=\"() => {return false;}\"\n                                                    :template=\"'<span>#=kendo.toString(amount || 0, decimalFormat)#</span>'\"\n                                                    :editor=\"numberEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{style: 'text-align: right'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'modifier'\"\n                                                    :title=\"$t('modifier')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.modifier\"\n                                                    :template=\"modifierTemplate\"\n                                                    :editor=\"ModifierDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'discountItem'\"\n                                                    :title=\"$t('discount_item')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.discountItem\"\n                                                    :template=\"discountItemTemplate\"\n                                                    :editor=\"DiscountItemDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{style: 'text-align: left'}\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'vatTax'\"\n                                                    :title=\"$t('vat')\"\n                                                    :width=\"200\"\n                                                    :template=\"vatTemplate\"\n                                                    :editor=\"VatTaxDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5',}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n\n                                                <kendo-grid-column\n                                                    :field=\"'specificTax'\"\n                                                    :title=\"$t('specific_tax')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.specificTax\"\n                                                    :template=\"'<span>#=specificTax.defaultTax || ``#</span>'\"\n                                                    :editor=\"SpecificTaxDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'otherTax'\"\n                                                    :title=\"$t('other_tax')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.otherTax\"\n                                                    :template=\"'<span>#=otherTax.defaultTax||``#</span>'\"\n                                                    :editor=\"OtherTaxDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'publicLightingTax'\"\n                                                    :title=\"$t('pl_tax')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.publicLightingTax\"\n                                                    :template=\"'<span>#=publicLightingTax.defaultTax||``#</span>'\"\n                                                    :editor=\"PublicLightingTaxDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'otherChargeItem'\"\n                                                    :title=\"$t('other_charge')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.otherCharge\"\n                                                    :template=\"'<span>#=otherChargeItem.name || ``#'\"\n                                                    :editor=\"OtherChargeDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'saleUnit'\"\n                                                    :title=\"$t('sale_unit')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.saleUnit\"\n                                                    :template=\"saleUnitTemplate\"\n                                                    :editor=\"SaleUnitDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                                <kendo-grid-column\n                                                    :field=\"'employee'\"\n                                                    :title=\"$t('employee')\"\n                                                    :width=\"200\"\n                                                    :hidden=\"!saleFormContent.employee\"\n                                                    :template=\"empImpl\"\n                                                    :editor=\"EmployeeDropDownEditor\"\n                                                    :headerAttributes=\"{style:'text-align: left; background-color: #EDF1F5'}\"\n                                                    :attributes=\"{ style: 'text-align: left' }\"/>\n                                            </kendo-grid>\n                                        </v-col>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pt-2\">\n                                            <v-btn\n                                                color=\"primary\"\n                                                class=\"float-left btn_plus mr-2\"\n                                                @click=\"addRow\">\n                                                <v-icon size=\"\" class=\"ma-1\">mdi-plus</v-icon>\n                                            </v-btn>\n                                        </v-col>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                            <v-row>\n                                                <v-col class=\"pt-0\" sm=\"5\" cols=\"6\">\n                                                    <v-card class=\"no-boxshadow rounded-4 pa-3\" color=\"grayBg\">\n                                                        <v-row>\n                                                            <v-col class=\"py-0 pa-4\" sm=\"12\" cols=\"12\">\n                                                                <label\n                                                                    class=\"label mb-0\">{{\n                                                                        $t(\"billing_address\")\n                                                                    }}</label>\n                                                                <v-select\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"invoice.billingAddress\"\n                                                                    :items=\"billingAddress\"\n                                                                    item-value=\"id\"\n                                                                    item-text=\"name\"\n                                                                    tage=\"Billing Address\"\n                                                                    placeholder=\"address\"\n                                                                    outlined/>\n                                                                <label\n                                                                    class=\"label mb-0\">{{\n                                                                        $t(\"pickup_delivery_address\")\n                                                                    }}</label>\n                                                                <v-select\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"invoice.deliveryAddress\"\n                                                                    :items=\"deliveryAddress\"\n                                                                    item-value=\"id\"\n                                                                    item-text=\"name\"\n                                                                    tage=\"Pickup/ Delivery Address\"\n                                                                    placeholder=\"address\"\n                                                                    outlined/>\n                                                                <label\n                                                                    class=\"label  mb-0\">{{\n                                                                        $t(\"pickup_delivery_date_time\")\n                                                                    }}</label>\n                                                                <app-datepicker\n                                                                    :initialDate=\"invoice.deliveryDateTime\"\n                                                                    @emitDate=\"deliveryDateTime = $event\"/>\n                                                                <label>{{ $t(\"message_on_invoice\") }}</label>\n                                                                <v-textarea\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"invoice.transactionNote\"\n                                                                    outlined\n                                                                    no-resize\n                                                                    height=\"70px\"\n                                                                    tage=\"Message on Invoice\"\n                                                                    placeholder=\"This will appear on the invoice\"/>\n                                                                <label>{{ $t(\"message_on_journal\") }}</label>\n                                                                <v-textarea\n                                                                    class=\"mt-1\"\n                                                                    v-model=\"invoice.journalNote\"\n                                                                    outlined\n                                                                    no-resize\n                                                                    height=\"70px\"\n                                                                    tage=\"Message on Order\"\n                                                                    placeholder=\"This will appear on the journal\"/>\n                                                            </v-col>\n                                                        </v-row>\n                                                    </v-card>\n                                                </v-col>\n                                                <v-col class=\"pt-0\" sm=\"7\" cols=\"6\">\n                                                    <v-simple-table>\n                                                        <template v-slot:default>\n                                                            <tbody>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">{{ $t(\"subtotal\") }}</td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">{{\n                                                                        numberFormat(invoice.subTotal)\n                                                                    }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">{{\n                                                                        $t(\"general_discount\")\n                                                                    }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    ({{ numberFormat(invoice.discountTotal) }})\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">{{\n                                                                        $t(\"other_charge\")\n                                                                    }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    {{ numberFormat(invoice.otherChargeTotal) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">{{ $t(\"total_tax\") }}\n                                                                    <v-btn\n                                                                        @click=\"dialogTax = true\"\n                                                                        color=\"grayBg\"\n                                                                        outlined\n                                                                        class=\"black--text rounded-4 text-bold  float-right text-uppercase\"\n                                                                        style=\"height: 30px !important;\">{{ $t(\"tax\") }}\n                                                                    </v-btn>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    {{ numberFormat(invoice.totalTaxAmount) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\" width=\"240px\">\n                                                                    <v-select\n                                                                        class=\"mt-3\"\n                                                                        v-model=\"invoice.specificDiscountItem\"\n                                                                        :items=\"specificDiscountItem\"\n                                                                        item-text=\"name\"\n                                                                        @change=\"onSpecificDiscountChanged\"\n                                                                        item-value=\"id\"\n                                                                        return-object\n                                                                        clearable\n                                                                        outlined/>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right\">\n                                                                    ({{\n                                                                        numberFormat(invoice.specificDiscountTotal ? invoice.specificDiscountTotal : 0)\n                                                                    }})\n                                                                </td>\n                                                            </tr>\n                                                            <!--                                                            <tr>-->\n                                                            <!--                                                                <td class=\"text-left\">{{ $t('delivery') }}</td>-->\n                                                            <!--                                                                <td class=\"text-center\">:</td>-->\n                                                            <!--                                                                <td class=\"text-right\">{{ invoice.deliveryFee }}</td>-->\n                                                            <!--                                                            </tr>-->\n\n                                                            <tr v-for=\"(num, index) in numSelect\"\n                                                                :key=\"index\"\n                                                                class=\"hide_form_alert\">\n                                                                <td class=\"text-left text-uppercase pr-0\">\n                                                                    <v-btn\n                                                                        v-if=\"num == 1\"\n                                                                        @click=\"addSelect\"\n                                                                        class=\"float-left mt-2 mr-1 pa-1\"\n                                                                        small>\n                                                                        <v-icon\n                                                                            color=\"primary\"\n                                                                            size=\"16\"\n                                                                            class=\"ma-1\">mdi-plus\n                                                                        </v-icon>\n                                                                    </v-btn>\n                                                                    <v-btn v-if=\"num > 1\"\n                                                                           @click=\"removeSelect(index)\"\n                                                                           class=\"float-left mt-2 mr-1 pa-1\"\n                                                                           small>\n                                                                        <v-icon\n                                                                            color=\"primary\"\n                                                                            size=\"16\"\n                                                                            class=\"ma-1\">fa-trash\n                                                                        </v-icon>\n                                                                    </v-btn>\n                                                                    <v-select\n                                                                        class=\"my-2 capitalize\"\n                                                                        v-model=\"mOtherCharge[index]\"\n                                                                        :items=\"otherChargeList\"\n                                                                        item-text=\"name\"\n                                                                        @change=\"onOtherChargeChange\"\n                                                                        item-value=\"id\"\n                                                                        return-object\n                                                                        clearable\n                                                                        outlined/>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right color_green text-bold\">\n                                                                    {{\n                                                                        numberFormat(onOtherAmount(mOtherCharge[index]))\n                                                                    }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr style=\"background: #F8F8F9\">\n                                                                <td class=\"text-left text-uppercase pr-0\">{{\n                                                                        $t(\"total\")\n                                                                    }}\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right color_green text-bold\" id=\"total\">\n                                                                    {{ numberFormat(invoice.total) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left pr-0\">{{ $t(\"deposit\") }}\n                                                                    <span\n                                                                        class=\"float-right color_green\">{{\n                                                                            numberFormat(invoice.depositAmount)\n                                                                        }}</span>\n                                                                </td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right hide_form_alert\">\n                                                                    <v-text-field\n                                                                        type=\"number\"\n                                                                        :min=0\n                                                                        :max=\"invoice.depositAmount\"\n                                                                        class=\" text-right float-right deposite_input\"\n                                                                        v-model=\"depositDeduction\"\n                                                                        @change=\"onDepositDeductionChange\"\n                                                                        :disabled=\"disabledDeposit\"\n                                                                        tage=\"Deposit\"\n                                                                        width=\"80\"\n                                                                        outlined/>\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">{{ $t(\"amount_due\") }}</td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right color_green text-bold\">\n                                                                    {{ numberFormat(invoice.remainingAmount) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">dr</td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right color_green text-bold\">\n                                                                    {{ numberFormat(invoice.dr) }}\n                                                                </td>\n                                                            </tr>\n                                                            <tr>\n                                                                <td class=\"text-left\">cr</td>\n                                                                <td class=\"text-center\">:</td>\n                                                                <td class=\"text-right color_green text-bold\">\n                                                                    {{ numberFormat(invoice.cr) }}\n                                                                </td>\n                                                            </tr>\n                                                            </tbody>\n                                                        </template>\n                                                    </v-simple-table>\n                                                </v-col>\n                                            </v-row>\n                                        </v-col>\n                                    </v-row>\n                                    <v-divider/>\n                                    <v-card outlined dense class=\"no_border function_footer\">\n                                        <v-alert type=\"warning\" v-model=\"alert\" dismissible>\n                                            <span v-html=\"errorMessage\"/>\n                                        </v-alert>\n                                        <v-menu>\n                                            <template v-slot:activator=\"{ on }\">\n                                                <v-btn class=\"mr-2 float-left select_template\" v-on=\"on\">\n                                                    {{\n                                                        template >= 0 ? templatesForm[template].name : $t(\"select_template\")\n                                                    }}\n                                                    <v-icon size=\"\" class=\"ma-1\">expand_more</v-icon>\n                                                </v-btn>\n                                            </template>\n                                            <v-list>\n                                                <v-list-item-group>\n                                                    <v-list-item\n                                                        v-for=\"(item, index) in templatesForm\"\n                                                        @click=\"ChoseTemplate(index)\"\n                                                        :key=\"index\">\n                                                        <v-list-item-content>\n                                                            <v-list-item-title>\n                                                                {{ item.name }}\n                                                            </v-list-item-title>\n                                                        </v-list-item-content>\n                                                    </v-list-item>\n                                                </v-list-item-group>\n                                            </v-list>\n                                        </v-menu>\n                                        <v-btn\n                                            outlined\n                                            class=\"text-capitalize  black--text float-left\"\n                                            color=\"primary\"\n                                            @click=\"cancel\">{{ $t(\"cancel\") }}\n                                        </v-btn>\n                                        <!--                    <v-menu>-->\n                                        <!--                      <template v-slot:activator=\"{ on }\">-->\n                                        <!--                        <v-btn-->\n                                        <!--                            class=\"ml-2 float-right text-capitalize  white&#45;&#45;text\"-->\n                                        <!--                            color=\"secondary\"-->\n                                        <!--                            v-on=\"on\"-->\n                                        <!--                        >-->\n                                        <!--                          {{ $t(\"save_option\") }}-->\n                                        <!--                          <v-icon size=\"\" class=\"ma-1\">expand_more</v-icon>-->\n                                        <!--                        </v-btn>-->\n                                        <!--                      </template>-->\n                                        <!--                      <v-list rounded>-->\n                                        <!--                        <v-list-item-group>-->\n                                        <!--                          <v-list-item>-->\n                                        <!--                            <v-list-item-content>-->\n                                        <!--                              <v-list-item-title-->\n                                        <!--                                  v-if=\"!isEdit\"-->\n                                        <!--                                  @click=\"saveNew\"-->\n                                        <!--                              >-->\n                                        <!--                                {{ $t(\"save_new\") }}-->\n                                        <!--                              </v-list-item-title>-->\n                                        <!--                            </v-list-item-content>-->\n                                        <!--                          </v-list-item>-->\n                                        <!--                          <v-list-item>-->\n                                        <!--                            <v-list-item-content>-->\n                                        <!--                              <v-list-item-title @click=\"onSaveClose(false, 1)\">-->\n                                        <!--                                {{ $t(\"save_print\") }}-->\n                                        <!--                              </v-list-item-title>-->\n                                        <!--                            </v-list-item-content>-->\n                                        <!--                          </v-list-item>-->\n                                        <!--                          &lt;!&ndash; <v-list-item>-->\n                                        <!--                            <v-list-item-content>-->\n                                        <!--                              <v-list-item-title>{{-->\n                                        <!--                                  $t('save_draft')-->\n                                        <!--                                }}-->\n                                        <!--                              </v-list-item-title>-->\n                                        <!--                            </v-list-item-content>-->\n                                        <!--                          </v-list-item> &ndash;&gt;-->\n                                        <!--                          <v-list-item>-->\n                                        <!--                            <v-list-item-content>-->\n                                        <!--                              <v-list-item-title @click=\"onSaveClose(true, 0)\"-->\n                                        <!--                              >{{ $t(\"save_send_close\") }}-->\n                                        <!--                              </v-list-item-title>-->\n                                        <!--                            </v-list-item-content>-->\n                                        <!--                          </v-list-item>-->\n                                        <!--                        </v-list-item-group>-->\n                                        <!--                      </v-list>-->\n                                        <!--                    </v-menu>-->\n                                        <v-btn\n                                            style=\"margin-left: 10px !important\"\n                                            class=\"float-right text-capitalize  white--text\"\n                                            @click=\"onSaveClose('close', false, 0)\"\n                                            color=\"primary\">{{ $t(\"save_pay\") }}\n                                        </v-btn>\n                                        <v-btn\n                                            class=\"float-right text-capitalize  white--text\"\n                                            @click=\"onSaveClose('close', false, 0)\"\n                                            color=\"primary\">{{ $t(\"save_close\") }}\n                                        </v-btn>\n                                        <v-btn color=\"secondary\"\n                                               style=\"margin-right: 10px !important\"\n                                               class=\"white--text float-right text-capitalize\"\n                                               @click=\"onSaveClose('new', false, 0)\" :hidden=\"hiddenButton\">\n                                            {{ $t(\"save_new\") }}\n                                        </v-btn>\n                                    </v-card>\n                                </v-form>\n                            </v-col>\n                            <v-col\n                                class=\"smallSide pl-2 pt-0\"\n                                sm=\"4\"\n                                style=\"transition: .3s ease-in;\"\n                                :class=\"{ hide_small_bar_class: isHideBar }\">\n                                <div class=\"d-flex justify-end\">\n                                    <h3\n                                        style=\"color: #b3b5bc; font-size:20px;\"\n                                        v-if=\"!isHideBar\"\n                                        class=\"text-uppercase\">\n                                        <span class=\"pointer\" @click=\"Help('invoice')\">{{ $t(\"help\") }}</span>\n                                        <v-icon\n                                            @click=\"cancel()\"\n                                            style=\"cursor: pointer; color: #333; font-size: 40px;\"\n                                            class=\"\">close\n                                        </v-icon>\n                                    </h3>\n                                </div>\n                                <div\n                                    v-if=\"!isHideBar\"\n                                    class=\"small_sidebar rounded-4 mt-1 px-4 pt-4 grayBg\">\n                                    <v-card outlined dense class=\"pa-3 no_border my_card rounded-4 white--text\"\n                                            color=\"primary\" height=\"60px\">\n                                        <h3 class=\"text-left font_13 flex-1 text-uppercase\">{{ $t('amount_due') }}</h3>\n                                        <h3 class=\"text-right flex-1 font_20 niradei_heavy\">\n                                            {{ numberFormat(invoice.amountDue) }}</h3>\n                                    </v-card>\n                                    <v-row>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pt-3\">\n                                            <label class=\"label mb-0\">{{ $t(\"segment\") }}</label>\n                                            <v-select\n                                                class=\"mt-1\"\n                                                v-model=\"invoice.segment\"\n                                                :items=\"segments\"\n                                                item-value=\"id\"\n                                                @change=\"loadSaleOrder\"\n                                                :disabled=\"disabledMe\"\n                                                :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                :rules=\"[(v) => !!v['id'] || $t('is_required')]\"\n                                                return-object\n                                                tage=\"sub Of\"\n                                                placeholder=\"Sub Of\"\n                                                outlined=\"\"/>\n                                            <label class=\"label mb-0\">{{ $t(\"location\") }}</label>\n                                            <v-select\n                                                class=\"mt-1\"\n                                                v-model=\"invoice.location\"\n                                                :items=\"locations\"\n                                                @change=\"loadSaleOrder\"\n                                                :disabled=\"disabledMe\"\n                                                item-value=\"id\"\n                                                :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                :rules=\"[(v) => !!v['id'] || $t('is_required')]\"\n                                                return-object\n                                                tage=\"Location\"\n                                                placeholder=\"bu/location\"\n                                                outlined=\"\"/>\n                                            <label class=\"label font_14\">{{ $t(\"project\") }}</label>\n                                            <v-select\n                                                class=\" mt-1\"\n                                                v-model=\"invoice.project\"\n                                                :items=\"customerProjects\"\n                                                :item-text=\"(item) => `${item.code} - ${item.name}`\"\n                                                item-value=\"id\"\n                                                tage=\"Customer Project\"\n                                                clearable\n                                                placeholder=\"project\"\n                                                outlined/>\n                                            <label class=\"label font_14\">{{ $t(\"sale_channel\") }}</label>\n                                            <v-select\n                                                class=\" mt-1\"\n                                                v-model=\"invoice.saleChannel\"\n                                                :items=\"saleChannelList\"\n                                                item-value=\"id\"\n                                                item-text=\"name\"\n                                                return-object\n                                                tage=\"Sale Channel\"\n                                                placeholder=\"Channel\"\n                                                outlined/>\n                                            <label class=\"label font_14\">{{ $t(\"employee\") }}</label>\n                                            <v-col\n                                                sm=\"12\"\n                                                cols=\"12\"\n                                                class=\"kendo_dropdown_custom pl-0 pr-0 pb-3 pt-0\">\n                                                <dropdownlist\n                                                    :data-items=\"employees\"\n                                                    @change=\"onEmployeeChanged\"\n                                                    :value=\"mEmployee\"\n                                                    :data-item-key=\"'id'\"\n                                                    :text-field=\"'name'\"\n                                                    :default-item=\"defaultItem\"\n                                                    :filterable=\"true\"\n                                                    @filterchange=\"onEmployeeFilterChanged\">\n                                                </dropdownlist>\n                                            </v-col>\n                                            <label class=\"label\">{{ $t(\"for_month_of\") }}</label>\n                                            <app-datepicker\n                                                :initialDate=\"invoice.monthOf\"\n                                                @emitDate=\"monthOf = $event\"/>\n                                        </v-col>\n                                    </v-row>\n                                    <v-divider class=\"mb-3\"/>\n                                    <v-row>\n                                        <v-col sm=\"12\" cols=\"12\" class=\"pt-1\">\n                                            <label class=\"label text-bold text-uppercase font_14\">{{\n                                                    $t(\"tnc_to_be_added\")\n                                                }}</label>\n                                            <LoadingMe :isLoading=\"showLoadingTxn\" :fullPage=\"false\" :myLoading=\"true\"\n                                                       type=\"loading\"/>\n                                            <v-row v-for=\"item in saleOrders\" v-bind:key=\"item.id\">\n                                                <v-col sm=\"10\" cols=\"10\" class=\"py-0 pr-0\">\n                                                    <v-card\n                                                        outlined\n                                                        color=\"third\"\n                                                        class=\"px-3 py-1 white--text no-boxshadow no_border justify-left d-flex\"\n                                                        style=\" height: 38px\">\n                                                        <p class=\"mb-0\" style=\"width: 100%\">\n                                                            <span\n                                                                class=\"pl-3 py-1 float-left\">{{\n                                                                    item.referenceNo || item.reference\n                                                                }}</span>\n                                                        </p>\n                                                    </v-card>\n                                                </v-col>\n                                                <v-col sm=\"2\" cols=\"2\" class=\"py-0  pl-1\">\n                                                    <v-btn\n                                                        class=\"text-white text-bold float-right text-uppercase\"\n                                                        outlined\n                                                        icon\n                                                        color=\"primary\"\n                                                        style=\"height: 30px\"\n                                                        :disabled=\"disabledMe\"\n                                                        @click=\"addSaleOrder(item)\">\n                                                        <v-icon>mdi-plus</v-icon>\n                                                    </v-btn>\n                                                </v-col>\n                                            </v-row>\n\n                                            <!-- <v-row>\n                        <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">1.\n                          {{ $t('sale_order') }}</label>\n                        <v-col sm=\"9\" cols=\"9\" class=\"py-0 pr-0\">\n                          <v-card outlined\n                                  class=\"px-5 py-1 text-white no-boxshadow no_border justify-left d-flex\"\n                                  height=\"30px\"\n                                  color=\"third\"\n                          >\n                            <input type=\"checkbox\" class=\"checkbox_inv float-left\"/>\n                            <p class=\"mb-0 white--text\" style=\"width: 100%\">\n                              <span class=\"pl-3 float-left\">No. 00224</span>\n                              <span class=\"float-right\">2,500.00</span>\n                            </p>\n                          </v-card>\n                        </v-col>\n                        <v-col sm=\"3\" cols=\"3\" class=\"py-0  pl-1\">\n                          <v-btn\n                              class=\"text-white b_add text-bold rounded-0 float-right text-uppercase\"\n                              height=\"30px\"\n                              color=\"primary\"\n                          >\n                            {{ $t('add') }}\n                          </v-btn>\n                        </v-col>\n                      </v-row>\n                      <v-row>\n                        <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">2.\n                          {{ $t('delayed_invoice') }}</label>\n                        <v-col sm=\"9\" cols=\"9\" class=\"py-0 pr-0\">\n                          <v-card outlined\n                                  class=\"px-5 py-1 text-white no-boxshadow no_border justify-left d-flex\"\n                                  height=\"30px\"\n                                  color=\"third\">\n                            <input type=\"checkbox\" class=\"checkbox_inv float-left\"/>\n                            <p class=\"mb-0 white--text\" style=\"width: 100%\">\n                              <span class=\"pl-3 float-left\">No. 00224</span>\n                              <span class=\"float-right\">2,500.00</span>\n                            </p>\n                          </v-card>\n                        </v-col>\n                        <v-col sm=\"3\" cols=\"3\" class=\"py-0  pl-1\">\n                          <v-btn\n                              class=\"text-white b_add text-bold rounded-0 float-right text-uppercase\"\n                              height=\"30px\"\n                              color=\"primary\">\n                            {{ $t('add') }}\n                          </v-btn>\n                        </v-col>\n                      </v-row>\n                      <v-row>\n                        <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">3.\n                          {{ $t('delayed_credit') }}</label>\n                        <v-col sm=\"9\" cols=\"9\" class=\"py-0 pr-0\">\n                          <v-card outlined\n                                  class=\"px-5 py-1 text-white no-boxshadow no_border justify-left d-flex\"\n                                  height=\"30px\"\n                                  color=\"third\">\n                            <input type=\"checkbox\" class=\"checkbox_inv float-left\"/>\n                            <p class=\"mb-0 white--text\" style=\"width: 100%\">\n                              <span class=\"pl-3 float-left\">No. 00224</span>\n                              <span class=\"float-right\">2,500.00</span>\n                            </p>\n                          </v-card>\n                        </v-col>\n                        <v-col sm=\"3\" cols=\"3\" class=\"py-0  pl-1\">\n                          <v-btn\n                              class=\"text-white b_add text-bold rounded-0 float-right text-uppercase\"\n                              height=\"30px\"\n                              color=\"primary\">\n                            {{ $t('add') }}\n                          </v-btn>\n                        </v-col>\n                      </v-row>\n                      <v-row>\n                        <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">4.\n                          {{ $t('quotation') }}</label>\n                        <v-col sm=\"9\" cols=\"9\" class=\"py-0 pr-0\">\n                          <v-card outlined\n                                  class=\"px-5 py-1 text-white no-boxshadow no_border justify-left d-flex\"\n                                  height=\"30px\"\n                                  color=\"third\">\n                            <input type=\"checkbox\" class=\"checkbox_inv float-left\"/>\n                            <p class=\"mb-0 white--text\" style=\"width: 100%\">\n                              <span class=\"pl-3 float-left\">No. 00224</span>\n                              <span class=\"float-right\">2,500.00</span>\n                            </p>\n                          </v-card>\n                        </v-col>\n                        <v-col sm=\"3\" cols=\"3\" class=\"py-0  pl-1\">\n                          <v-btn\n                              class=\"text-white b_add text-bold rounded-0 float-right text-uppercase\"\n                              height=\"30px\"\n                              color=\"primary\">\n                            {{ $t('add') }}\n                          </v-btn>\n                        </v-col>\n                      </v-row>\n                      <v-row>\n                        <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">5.\n                          {{ $t('delivery_note') }}</label>\n                        <v-col sm=\"9\" cols=\"9\" class=\"py-0 pr-0\">\n                          <v-card outlined\n                                  class=\"px-5 py-1 text-white no-boxshadow no_border justify-left d-flex\"\n                                  height=\"30px\"\n                                  color=\"third\">\n                            <input type=\"checkbox\" class=\"checkbox_inv float-left\"/>\n                            <p class=\"mb-0 white--text\" style=\"width: 100%\">\n                              <span class=\"pl-3 float-left\">No. 00224</span>\n                              <span class=\"float-right\">2,500.00</span>\n                            </p>\n                          </v-card>\n                        </v-col>\n                        <v-col sm=\"3\" cols=\"3\" class=\"py-0  pl-1\">\n                          <v-btn\n                              class=\"text-white text-bold b_add rounded-0 float-right text-uppercase\"\n                              height=\"30px\"\n                              color=\"primary\">\n                            {{ $t('add') }}\n                          </v-btn>\n                        </v-col>\n                      </v-row>\n                      <v-row>\n                        <label class=\"text-bold ml-9\" style=\"font-size: 12px;\">6.\n                          {{ $t('billable_expense') }}</label>\n                        <v-col sm=\"9\" cols=\"9\" class=\"py-0 pr-0\">\n                          <v-card outlined\n                                  class=\"px-5 py-1 text-white no-boxshadow no_border justify-left d-flex\"\n                                  height=\"30px\"\n                                  color=\"third\">\n                            <input type=\"checkbox\" class=\"checkbox_inv float-left\"/>\n                            <p class=\"mb-0 white--text\" style=\"width: 100%\">\n                              <span class=\"pl-3 float-left\">No. 00224</span>\n                              <span class=\"float-right\">2,500.00</span>\n                            </p>\n                          </v-card>\n                        </v-col>\n                        <v-col sm=\"3\" cols=\"3\" class=\"py-0  pl-1\">\n                          <v-btn\n                              class=\"text-white b_add text-bold rounded-0 float-right text-uppercase\"\n                              height=\"30px\"\n                              color=\"primary\">\n                            {{ $t('add') }}\n                          </v-btn>\n                        </v-col>\n                      </v-row> -->\n                                            <v-row>\n                                                <v-col sm=\"12\" cols=\"12\" class=\"pb-0\">\n                                                    <label class=\"label mt-2 text-uppercase\">{{\n                                                            $t(\"payment_options\")\n                                                        }}</label>\n                                                </v-col>\n                                                <v-col sm=\"12\" cols=\"12\">\n                                                    <v-row>\n                                                        <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                                            <label class=\"label\">{{ $t('cash_payment') }}</label>\n                                                            <v-select\n                                                                class=\"mt-1\"\n                                                                outlined\n                                                                return-object\n                                                                id=\"\"\n                                                                :items=\"cashPayment\"\n                                                                item-text=\"name\"\n                                                                tage=\"PaymentOption\"\n                                                                item-value=\"id\"\n                                                                v-model=\"invoice.cashPayment\"/>\n                                                            <label class=\"label\">{{ $t('bill_payment') }}</label>\n                                                            <v-select\n                                                                class=\"mt-1\"\n                                                                outlined\n                                                                return-object\n                                                                id=\"\"\n                                                                clearable\n                                                                :items=\"billPayment\"\n                                                                item-text=\"name\"\n                                                                tage=\"PaymentOption\"\n                                                                item-value=\"id\"\n                                                                v-model=\"invoice.billPayment\"/>\n                                                            <label class=\"label\">{{ $t('qr_payment') }}</label>\n                                                            <v-select\n                                                                class=\"mt-1\"\n                                                                outlined\n                                                                return-object\n                                                                id=\"\"\n                                                                :items=\"qrPayment\"\n                                                                item-text=\"name\"\n                                                                tage=\"PaymentOption\"\n                                                                item-value=\"id\"\n                                                                clearable\n                                                                v-model=\"invoice.qrPayment\"/>\n                                                            <label class=\"label\">{{ $t('bank_transfer') }}</label>\n                                                            <v-select\n                                                                class=\"mt-1\"\n                                                                outlined\n                                                                return-object\n                                                                clearable\n                                                                id=\"\"\n                                                                :items=\"bankTransfer\"\n                                                                item-text=\"name\"\n                                                                tage=\"PaymentOption\"\n                                                                item-value=\"id\"\n                                                                v-model=\"invoice.bankTransfer\"/>\n                                                        </v-col>\n                                                    </v-row>\n                                                </v-col>\n                                            </v-row>\n                                        </v-col>\n                                    </v-row>\n                                    <!--                                    <v-divider class=\"mb-5\"/>-->\n                                    <!--                                    <label class=\"label\">{{ $t('delivery_options') }} (<span-->\n                                    <!--                                        style=\"color:#1bb5f1\">{{ $t('get_setup') }}</span>)</label>-->\n                                    <!--                                    <v-row>-->\n                                    <!--                                        <v-col sm=\"6\" cols=\"12\" class=\"pb-0\">-->\n                                    <!--                                            <label class=\"label font_14\">{{ $t('project') }}</label>-->\n                                    <!--                                            <v-text-field class=\"mt-1\"-->\n                                    <!--                                                          palceholder=\"joonak\"-->\n                                    <!--                                                          tage=\"Project\"-->\n                                    <!--                                                          outlined-->\n                                    <!--                                            />-->\n                                    <!--                                            <label class=\"label font_14\">{{ $t('from') }}</label>-->\n                                    <!--                                            <v-text-field class=\" my-2\"-->\n                                    <!--                                                          palceholder=\"joonak\"-->\n                                    <!--                                                          tage=\"From\"-->\n                                    <!--                                                          outlined-->\n                                    <!--                                            />-->\n                                    <!--                                        </v-col>-->\n                                    <!--                                        <v-col sm=\"6\" cols=\"12\" class=\"pb-0\">-->\n                                    <!--                                            <label class=\"label font_14\">{{ $t('delivery_date_time') }}</label>-->\n                                    <!--                                            <app-datepicker :initialDate=\"journal_date\"-->\n                                    <!--                                                            @emitDate=\"journal_date = $event\"/>-->\n                                    <!--                                            <label class=\"label font_14\">{{ $t('to') }}</label>-->\n                                    <!--                                            <v-text-field class=\" my-2\"-->\n                                    <!--                                                          palceholder=\"to\"-->\n                                    <!--                                                          outlined-->\n                                    <!--                                            />-->\n                                    <!--                                        </v-col>-->\n                                    <!--                                    </v-row>-->\n                                    <!--                                    <v-row>-->\n                                    <!--                                        <v-col sm=\"4\" cols=\"9\" class=\"py-0 pr-0 pl-4\">-->\n                                    <!--                                            <p class=\"color_grey font_10 mb-0\">QUOTED FEE</p>-->\n                                    <!--                                            <p class=\"color_green  mb-0\">1,000.00 </p>-->\n                                    <!--                                        </v-col>-->\n                                    <!--                                        <v-col sm=\"2\" cols=\"3\" class=\"py-0 mt-1 pl-0\">-->\n                                    <!--                                            <v-btn class=\"text-white text-bold rounded-0 float-right text-uppercase\"-->\n                                    <!--                                                   style=\"height: 30px !important; background-color: rgb(0, 176, 80) !important\">-->\n                                    <!--                                                {{ $t('add') }}-->\n                                    <!--                                            </v-btn>-->\n                                    <!--                                        </v-col>-->\n                                    <!--                                    </v-row>-->\n\n                                    <!-- <p class=\"mb-0 detial_smallside_p font_14\">{{$t('sale_order_funct_desc')}}</p> -->\n                                </div>\n                            </v-col>\n                        </v-row>\n                    </v-card>\n                </v-col>\n            </v-row>\n            <LoadingMe :isLoading=\"showLoading\" :fullPage=\"false\" :myLoading=\"true\"/>\n            <v-dialog v-model=\"dialogTax\" max-width=\"450px\">\n                <v-card>\n                    <div class=\"modal_header\">\n                        <v-card-title>{{ $t(\"tax_list\") }}</v-card-title>\n                        <v-icon class=\"btn_close\" @click=\"dialogTax = false\">close</v-icon>\n                    </div>\n                    <v-card-text class=\"modal_text_content\">\n                        <v-row>\n                            <v-col sm=\"12\" cols=\"12\" class=\"py-0\">\n                                <v-simple-table>\n                                    <template v-slot:default>\n                                        <tbody>\n                                        <tr\n                                            v-for=\"(value, name) in taxListTotal\"\n                                            v-bind:key=\"name\">\n                                            <td class=\"text-left\" width=\"180px\">{{ name }}</td>\n                                            <td class=\"text-center\">:</td>\n                                            <td class=\"text-right\">{{ numberFormat(value) }}</td>\n                                        </tr>\n                                        <tr>\n                                            <td class=\"text-left\" width=\"180px\">{{ $t(\"total\") }}</td>\n                                            <td class=\"text-center\">:</td>\n                                            <td class=\"text-right\">{{ numberFormat(invoice.totalTaxAmount) }}</td>\n                                        </tr>\n                                        </tbody>\n                                    </template>\n                                </v-simple-table>\n                            </v-col>\n                        </v-row>\n                    </v-card-text>\n                    <v-divider/>\n                </v-card>\n            </v-dialog>\n            <!--      <v-dialog v-model=\"dialogCatalog\" max-width=\"850px\">-->\n            <!--        <template v-slot:activator=\"{ on }\">-->\n            <!--        </template>-->\n            <!--        <v-card>-->\n            <!--          <v-card-title>{{ $t('catalog') }}</v-card-title>-->\n            <!--          <v-icon class=\"btn_close\" @click=\"dialogCatalog = false\">close</v-icon>-->\n            <!--          <v-divider/>-->\n            <!--          <v-card-text style=\"height: 240px; background-color: #EDF1F5; color: #333;\">-->\n            <!--            <v-row>-->\n            <!--              <v-col sm=\"12\" cols=\"12\" class=\"pb-0\">-->\n            <!--                <v-simple-table>-->\n            <!--                  <kendo-datasource ref=\"catalogDatasource\"-->\n            <!--                                    :data=\"catalogs\"-->\n            <!--                                    :schema=\"gridSchema\"/>-->\n            <!--                  <kendo-grid id=\"gridCatalog\"-->\n            <!--                              class=\"grid-function\"-->\n            <!--                              :data-source-ref=\"'catalogDatasource'\"-->\n            <!--                              :style=\"{width: '100%'}\"-->\n            <!--                              :noRecords=\"true\"-->\n            <!--                              :pageable-numeric=\"false\"-->\n            <!--                              :pageable-previous-next=\"false\"-->\n            <!--                              :pageable-messages-display=\"'Showing {2} data items'\"-->\n            <!--                              :scrollable-virtual=\"true\">-->\n            <!--                    <kendo-grid-column-->\n            <!--                        :field=\"'images'\"-->\n            <!--                        :title=\"$t('image')\"-->\n            <!--                        :width=\"50\"-->\n            <!--                        :template=\"loadImage\"-->\n            <!--                        :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"/>-->\n            <!--                    <kendo-grid-column-->\n            <!--                        :field=\"'number'\"-->\n            <!--                        :title=\"$t('number')\"-->\n            <!--                        :width=\"70\"-->\n            <!--                        :template=\"'<span>#=number#</span>'\"-->\n            <!--                        :groupHeaderColumnTemplate=\"'#=value#'\"-->\n            <!--                        :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"/>-->\n            <!--                    <kendo-grid-column-->\n            <!--                        :field=\"'name'\"-->\n            <!--                        :title=\"$t('name')\"-->\n            <!--                        :attributes=\"{class:'tb_name_td'}\"-->\n            <!--                        :width=\"100\"-->\n            <!--                        :template=\"'<span>#=name#</span>'\"-->\n            <!--                        :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"/>-->\n            <!--                    <kendo-grid-column-->\n            <!--                        :field=\"'description'\"-->\n            <!--                        :title=\"$t('description')\"-->\n            <!--                        :width=\"100\"-->\n            <!--                        :template=\"'<span>#=description#</span>'\"-->\n            <!--                        :headerAttributes=\"{ style: 'background-color: #EDF1F5' }\"/>-->\n            <!--                    <kendo-grid-column-->\n            <!--                        :field=\"'noOfProduct'\"-->\n            <!--                        :title=\"$t('products')\"-->\n            <!--                        :template=\"'<span>#=noOfProduct#</span>'\"-->\n            <!--                        :width=\"50\"-->\n            <!--                        :headerAttributes=\"{style: 'text-align: left; background-color: #EDF1F5'}\"/>-->\n            <!--                    <kendo-grid-column-->\n            <!--                        :field=\"''\"-->\n            <!--                        :title=\"$t('action')\"-->\n            <!--                        :width=\"60\"-->\n            <!--                        :command=\"[{ text: $t('add'), click: addCatalog }]\"-->\n            <!--                        :headerAttributes=\"{style: 'text-align: left; background-color: #EDF1F5'}\"/>-->\n            <!--                  </kendo-grid>-->\n            <!--                </v-simple-table>-->\n            <!--              </v-col>-->\n            <!--            </v-row>-->\n            <!--          </v-card-text>-->\n            <!--          <v-divider/>-->\n\n            <!--        </v-card>-->\n            <!--      </v-dialog>-->\n        </v-container>\n    </v-app>\n</template>\n\n<script>\n// import kendo from \"@progress/kendo-ui\"\nimport {i18n} from \"@/i18n\";\nimport DatePickerComponent from \"@/components/custom_templates/DatePickerComponent\";\nimport InvoiceModel from \"@/scripts/invoice/model/Invoice\";\nimport ItemLineModel from \"@/scripts/invoice/model/ItemLine\";\nimport {uuid} from \"vue-uuid\";\nimport paymentTermHandler_ from \"@/scripts/paymentterm/handler/paymentTermHandler\";\nimport {DropDownList} from \"@progress/kendo-vue-dropdowns\";\nimport kendo from \"@progress/kendo-ui\";\nimport SaleFormContentModel from \"@/scripts/model/SaleFormContent\";\n// import kendo from \"@progress/kendo-ui\";\nimport {dataStore, ShowResource} from \"@/observable/store\";\nimport {getPrint} from \"@/form/invoices.js\";\nimport creditLimitHandler from \"@/scripts/creditLimit/handler/creditLimitHandler\";\nimport PaymentOptionModel from \"@/scripts/model/PaymentOption\";\nimport {PAYMENT_OPINION_TYPE} from \"@/scripts/default_setup/Setting\";\n\nconst customerHandler = require(\"@/scripts/customerHandler\");\n\nconst projectHandler = require(\"@/scripts/projectHandler\");\nconst priceLevelHandler = require(\"@/scripts/priceLevelHandler\");\nconst currencyHandler = require(\"@/scripts/currency/handler/currencyHandler\");\nconst saleOrderHandler = require(\"@/scripts/transactionHandler\");\n\nconst settingsHandler = require(\"@/scripts/settingsHandler\");\nconst saleChannelHandler = require(\"@/scripts/saleChannelHandler\");\nconst employeeHandler = require(\"@/scripts/employeeHandler\");\nconst locationHandler = require(\"@/scripts/locationHandler\");\n// const paymentTermHandler = require(\"@/scripts/paymentTermHandler\")\n\nconst paymentTermHandler = require(\"@/scripts/settingsHandler\");\nconst accountHandler = require(\"@/scripts/handler/accounting/account\");\nconst productVariantHandler = require(\"@/scripts/productVariantHandler\");\nconst uomPriceHandler = require(\"@/scripts/uomPriceHandler\");\nconst uomConversionHandler = require(\"@/scripts/uomConversionHandler\");\nconst discountItemHandler = require(\"@/scripts/discountItemHandler\");\nconst settingHandler = require(\"@/scripts/settingHandler\");\nconst itemModifierHandler = require(\"@/scripts/itemModifierHandler\");\nconst saleUnitItemHandler = require(\"@/scripts/saleUnitItemHandler\");\nconst otherChargeHandler = require(\"@/scripts/otherChargeHandler\");\nconst saleFormContentHandler = require(\"@/scripts/saleFormContentHandler\");\nconst prefixHandler = require(\"@/scripts/prefixHandler\");\nconst billingHandler = require(\"@/scripts/invoice/handler/billingHandler\");\nconst lateFeeHandler = require(\"@/scripts/lateFeeHandler\");\nconst paymentOptionHandler = require(\"@/scripts/paymentOptionHandler\");\nconst catalogHandler = require(\"@/scripts/catalogHandler\");\n\nconst invoiceModel = new InvoiceModel({});\nconst itemLineModel = new ItemLineModel({});\nconst saleFormContentModel = new SaleFormContentModel({});\nimport OtherChargeModel from \"@/scripts/model/OtherCharge\";\n\nconst $ = kendo.jQuery\n\nconst textField = \"numberName\";\nconst keyField = \"id\";\nconst defaultItem = {[textField]: \"Select customer...\", [keyField]: null};\nconst emptyItem = {[textField]: \"loading ...\"};\nconst pageSize = 10;\nconst itemLinePrefix = \"lin-\";\nconst loadingData = [];\nwhile (loadingData.length < pageSize) {\n    loadingData.push({...emptyItem});\n}\nconst OPTION_TYPE = \"Customer\";\nconst strFilter = \"?optionType=\" + OPTION_TYPE;\nconst DISCOUNT_TYPE = \"?type=Sale\";\nconst cookieJS = require(\"@/cookie.js\");\nconst cookie = cookieJS.getCookie();\nexport default {\n    name: \"CustomerInvoice\",\n    props: [\"id\", \"transactionDate\"],\n    components: {\n        LoadingMe: () => import(`@/components/Loading`),\n        \"app-datepicker\": DatePickerComponent,\n        dropdownlist: DropDownList,\n    },\n    data: () => ({\n        isEdit: false,\n        mOtherCharge: [],\n        mOtherChargeAmount: [],\n        numSelect: [1],\n        dialogTax: false,\n        customerList: [],\n        showLoading: false,\n        showLoadingTxn: false,\n        alert: false,\n        files: [],\n        // Form validation\n        valid: true,\n        itemLines: [],\n        invoiceDate: new Date().toISOString().substr(0, 10),\n        template: -1,\n        templatesForm: [],\n        isHideBar: false,\n        gridSchema: {\n            model: {\n                id: \"id\",\n            },\n        },\n        customer: {},\n        defaultItem: defaultItem,\n        invoice: invoiceModel,\n        transactionType: [\"Invoice\", \"Commercial Invoice\", \"Tax Invoice\"],\n        cusBaseUrl: customerHandler.searchv1(),\n        empBaseUrl: employeeHandler.search(),\n        init: {method: \"GET\", accept: \"application/json\", headers: []},\n        pendingRequest: undefined,\n        requestStarted: false,\n        skip: 0,\n        tempSkip: null,\n        total: 0,\n        filter: \"\",\n        referenceNo: \"\",\n        filter_: \"\",\n        textField: \"numberName\",\n        dataItemKey: \"id\",\n        segments: [],\n        saleChannelList: [],\n        employees: [],\n        mEmployee: {},\n        customerProjects: [],\n        billingAddress: [],\n        deliveryAddress: [],\n        deliveryDateTime: new Date().toISOString().substr(0, 10),\n        priceLevel: [],\n        locations: [],\n        paymentTerms: [],\n        receivableAcc: [],\n        currencies: [],\n        itemLine: itemLineModel,\n        uoms: [],\n        otherTax: [],\n        vatTax: [],\n        specificTax: [],\n        publicLightingTax: [],\n        saleUnitItemList: [],\n        specificDiscountItem: [],\n        otherChargeList: [],\n        depositBalance: 0,\n        schemaDefinition: {\n            model: {\n                id: \"id\",\n            },\n        },\n        saleFormContent: saleFormContentModel,\n        taxListTotal: {},\n        invoiceTypes: [],\n        customerDiscountItem: [],\n        customerOtherChargeItem: [],\n        customerSaleUnit: [],\n        customerSaleUnitLine: [],\n        lateFeeList: [],\n        loggedUser: {\n            id: cookie.creator,\n            name: cookie.email,\n        },\n        paymentOptionWBMobile: [],\n        paymentOptionOnline: [],\n        paymentOptionKHQR: [],\n        paymentOptionBankTransfer: [],\n        exchangeRate: {},\n        baseCurrencyCode: \"\",\n        currencyCode: \"\",\n        transactionRate: 1,\n        jRaw: [],\n        catalogs: [],\n        dialogCatalog: false,\n        saleOrders: [],\n        isPriceLevelChanged: false,\n        cashPayment: [],\n        billPayment: [],\n        qrPayment: [],\n        bankTransfer: [],\n        refFrom: [],\n        taxListDetail: [],\n        tax: [],\n        isAdded: false,\n        btnDisabled: false,\n        depositDeduction: 0,\n        cashBasicRevenueAcc: []\n    }),\n    methods: {\n        dataBound: function (e) {\n            const grid = kendo.jQuery(\"#gridItemLine\").data(\"kendoGrid\");\n            const items = e.sender.items();\n            if (grid) {\n                items.each(function () {\n                    let dataItem = grid.dataItem(this);\n                    $(\"tr[data-uid='\" + dataItem.uid + \"']\").find('.isEditable')\n                        .each(function () {\n                            if (dataItem.isEditable === false) {\n                                $(this).addClass(\"k-state-disabled\");\n                            }\n                        });\n                });\n            }\n        },\n        autoCalculateTaxDetail() {\n            let ids = []\n            this.taxListDetail.forEach(n => {\n                ids.push(n.id || '')\n            })\n            const unique = [...new Set(ids)]\n            let result = []\n            unique.forEach(m => {\n                let amount = 0, row = {}, discount = 0, xDiscount = 0, xAmount = 0, taxAmount = 0, xTaxAmount = 0\n                let taxDetail = [], isVat = 0\n                const found = this.taxListDetail.filter(n => n.id === m)\n                // window.console.log('taxListDetailids', found)\n                found.forEach(k => {\n                    row = k\n                    if (k.isVat === 1) {\n                        isVat = 1\n                        const detail_ = k.detail || {}\n                        taxDetail.push(detail_)\n\n                    }\n                    taxAmount += k.taxAmount_ || 0\n                    xTaxAmount += (k.taxAmount_ || 0) * (k.txnRate || 1)\n                    amount += (k.amount || 0)\n                    xAmount += (k.amount || 0) * (k.txnRate || 1)\n                    discount += (k.discount || 0)\n                    xDiscount += (k.discount || 0) * (k.txnRate || 1)\n                })\n                let spTaxAmt = 0, spXTaxAmt = 0, plTaxAmt = 0, plXTaxAmt = 0, otTaxAmt = 0, otXTaxAmt = 0,\n                    spTaxName = '', plTaxName = '', otTaxName = '',\n                    spTaxNameLocale = '', plTaxNameLocale = '', otTaxNameLocale = '',\n                    spAccId = '', plAccId = '', otAccId = '',\n                    spRate = '', plRate = '', otRate = ''\n                taxDetail.forEach(n => {\n                    const spTax = n.specificTax || {}\n                    const plTax = n.publicLightingTax || {}\n                    const otherTax = n.otherTax || {}\n                    if (Object.keys(spTax).length > 0) {\n                        spTaxAmt += (spTax.taxAmount_ || 0)\n                        spXTaxAmt += ((spTax.taxAmount_ || 0) * (spTax.taxRate || 1))\n                        spTaxName = spTax.defaultTax || ''\n                        spTaxNameLocale = spTax.defaultTaxLocale || ''\n                        spAccId = spTax.account ? spTax.account.id : ''\n                        spRate = spTax.rate || 1\n                    }\n                    if (Object.keys(plTax).length > 0) {\n                        plTaxAmt += (plTax.taxAmount_ || 0)\n                        plXTaxAmt += ((plTax.taxAmount_ || 0) * (plTax.taxRate || 1))\n                        plTaxName = plTax.defaultTax || ''\n                        plTaxNameLocale = plTax.defaultTaxLocale || ''\n                        plAccId = plTax.account ? plTax.account.id : ''\n                        plRate = plTax.rate || 1\n                    }\n                    if (Object.keys(otherTax).length > 0) {\n                        otTaxAmt += (otherTax.taxAmount_ || 0)\n                        otXTaxAmt += ((otherTax.taxAmount_ || 0) * (plTax.taxRate || 1))\n                        otTaxName = otherTax.defaultTax || ''\n                        otTaxNameLocale = otherTax.defaultTaxLocale || ''\n                        otAccId = otherTax.account ? otherTax.account.id : ''\n                        otRate = otherTax.rate || 1\n                    }\n                })\n                if (isVat === 1) {\n                    row.detail = {\n                        specificTax: {\n                            name: spTaxName,\n                            nameLocale: spTaxNameLocale,\n                            amount: spTaxAmt,\n                            exchangeAmount: spXTaxAmt,\n                            accountId: spAccId,\n                            rate: spRate,\n                        },\n                        publicLightingTax: {\n                            name: plTaxName,\n                            nameLocale: plTaxNameLocale,\n                            amount: plTaxAmt,\n                            exchangeAmount: plXTaxAmt,\n                            accountId: plAccId,\n                            rate: plRate,\n                        },\n                        otherTax: {\n                            name: otTaxName,\n                            nameLocale: otTaxNameLocale,\n                            amount: otTaxAmt,\n                            exchangeAmount: otXTaxAmt,\n                            accountId: otAccId,\n                            rate: otRate,\n                        }\n                    }\n                } else {\n                    row.detail = {}\n                }\n\n                row['amount'] = amount\n                row['exchangeAmount'] = xAmount\n                row['taxAmount'] = taxAmount\n                row['exchangeTaxAmount'] = xTaxAmount\n                row['discount'] = discount\n                row['exchangeDiscount'] = xDiscount\n                row['currency'] = this.invoice.exchangeRate || {}\n                result.push(row)\n                taxDetail = []\n            })\n            this.invoice.saleTaxDetail = result\n            window.console.log('saleTaxDetail', result)\n        },\n        ChoseTemplate(i) {\n            window.console.log(i);\n            this.template = i;\n        },\n        shrinkDiscountItem(discountItem, discountLine) {\n            let uniqueDiscountItems = [];\n            const unique = this.removeDuplicate(discountItem);\n            unique.forEach((m) => {\n                const found = discountLine.filter((n) => n.id === m.id);\n                let amount = 0,\n                    exchangeAmount = 0;\n                found.map((o) => {\n                    amount += o.amount;\n                });\n                found.map((o) => {\n                    exchangeAmount += o.exchangeAmount;\n                });\n                uniqueDiscountItems.push({\n                    id: m.id,\n                    name: m.name,\n                    amount: amount,\n                    exchangeAmount: exchangeAmount,\n                });\n            });\n            this.customerDiscountItem = uniqueDiscountItems;\n            window.console.log(uniqueDiscountItems, \"uniqueDiscountItems\");\n        },\n        shrinkOtherChargeItem(otherChargeItem, otherChargeLine) {\n            let items = [];\n            const unique = this.removeDuplicate(otherChargeItem);\n            unique.forEach((m) => {\n                const found = otherChargeLine.filter((n) => n.id === m.id);\n                let amount = 0, exchangeAmount = 0;\n                found.map((o) => {\n                    amount += o.amount;\n                });\n                found.map((o) => {\n                    exchangeAmount += o.exchangeAmount;\n                });\n                items.push({\n                    id: m.id,\n                    name: m.name,\n                    amount: amount,\n                    exchangeAmount: exchangeAmount,\n                });\n            });\n            this.customerOtherChargeItem = items;\n        },\n        addSaleOrder(item) {\n            if (item) {\n                const itemLine = item.itemLines || [];\n                this.refFrom.push({\n                    id: item.id || '',\n                    reference: item.referenceNo || ''\n                })\n                let ds = this.$refs.itemLineDS.kendoWidget(),\n                    total = ds.total();\n                itemLine.forEach((o) => {\n                    this.itemLine = new ItemLineModel(o);\n                    this.itemLine.id = itemLinePrefix + uuid.v1();\n                    this.itemLine.decimalFormat = \"n\" + this.saleFormContent.decimal;\n                    this.itemLine.isEditable = true\n                    this.itemLine.sourceTransaction = {\n                        id: item.id,\n                        referenceNo: item.referenceNo,\n                    };\n                    this.itemLine.sourceTransactionRef = item.referenceNo;\n                    ds.insert(total, this.itemLine);\n                    // window.console.log(this.itemLine, 'itemLine')\n                });\n                this.itemLine = new ItemLineModel({});\n                this.autoCalculate();\n                const index = this.saleOrders.findIndex((itm) => {\n                    return item.id === itm.id;\n                });\n                this.saleOrders.splice(index, 1);\n                this.invoice.refFrom = this.removeDuplicate(this.refFrom)\n            }\n            // window.console.log(item, '--')\n        },\n        loadImage(dataItem) {\n            if (dataItem.hasOwnProperty(\"images\")) {\n                if (dataItem.images.hasOwnProperty(\"default\")) {\n                    const url = this.imgURL + dataItem.images.default.thumb;\n                    return (\n                        \"<img width='50' height='50' style= 'margin: auto;display: block;' src='\" +\n                        url +\n                        \"' />\"\n                    );\n                }\n            } else {\n                return \"\";\n            }\n        },\n        async loadCatalogs() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.showLoading = true;\n                    catalogHandler.get().then((res) => {\n                        this.showLoading = false;\n                        this.catalogs = res;\n                    });\n                }, 10);\n            });\n        },\n        addCatalog(e) {\n            e.preventDefault();\n            let grid = kendo.jQuery(\"#gridCatalog\").data(\"kendoGrid\");\n            let dataItem = grid.dataItem($(e.currentTarget).closest(\"tr\"));\n            // window.console.log(dataItem)\n            if (dataItem.variants.length > 0) {\n                dataItem.variants.forEach((m) => {\n                    if (m.hasOwnProperty(\"variant\")) {\n                        if (m.variant.hasOwnProperty(\"id\")) {\n                            this.loadSingleItem(m.variant.id, \"i\");\n                        }\n                    }\n                });\n                this.dialogCatalog = false;\n            }\n            if (dataItem.services.length > 0) {\n                dataItem.services.forEach((m) => {\n                    if (m.hasOwnProperty(\"service\")) {\n                        if (m.service.hasOwnProperty(\"id\")) {\n                            this.loadSingleItem(m.service.id, \"s\");\n                        }\n                    }\n                });\n                this.dialogCatalog = false;\n            }\n        },\n        qohTemplate(dataItem) {\n            const buom = dataItem.buom || {};\n            const qoh = dataItem.qoh || 0;\n            if (buom.hasOwnProperty(\"name\")) {\n                return kendo.toString(qoh, `n${this.saleFormContent.decimal}`) + ` ` + buom.name;\n            }\n            return ``;\n        },\n        Help(key) {\n            ShowResource(key);\n        },\n        numberEditor(container, options) {\n            kendo\n                .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoNumericTextBox({\n                    decimals: 30,\n                    min: 0.00001,\n                    format: `${this.saleFormContent.decimal}`,\n                });\n        },\n        async loadPaymentOption() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    paymentOptionHandler\n                        .list(strFilter)\n                        .then((res) => {\n                            this.showLoading = true;\n                            if (res.data.statusCode === 200) {\n                                this.showLoading = false;\n                                const data = res.data.data || []\n                                this.cashPayment = data.filter(m => m.type === PAYMENT_OPINION_TYPE.CASH_PAYMENT)\n                                this.billPayment = data.filter(m => m.type === PAYMENT_OPINION_TYPE.BILL_PAYMENT)\n                                this.qrPayment = data.filter(m => m.type === PAYMENT_OPINION_TYPE.QR_PAYMENT)\n                                this.bankTransfer = data.filter(m => m.type === PAYMENT_OPINION_TYPE.BANK_TRANSFER)\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        vatTemplate(dataItem) {\n            const vat = dataItem.vatTax;\n            if (vat) {\n                return `<span>${vat.defaultTax || ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        modifierTemplate(dataItem) {\n            const modifier = dataItem.modifier;\n            if (modifier) {\n                return `<span>${modifier.name || ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        itemTemplate(dataItem) {\n            const item = dataItem.item;\n            if (item) {\n                return `<span>${item.name ? item.name : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        UOMTemplate(dataItem) {\n            const uom = dataItem.uom;\n            const code = uom.code || ''\n            if (uom) {\n                return `<span>${uom.uom ? code : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        saleUnitTemplate(dataItem) {\n            const saleUnit = dataItem.saleUnit;\n            if (saleUnit) {\n                return `<span>${saleUnit.name ? saleUnit.name : ``}</span>`;\n            } else {\n                return ``;\n            }\n        },\n        discountItemTemplate(dataItem) {\n            const discountItem = dataItem.discountItem;\n            if (discountItem) {\n                return `<span>${discountItem.code ? discountItem.code : ``} - ${\n                    discountItem.name ? discountItem.name : ``\n                }</span>`;\n            } else {\n                return ``;\n            }\n        },\n        addSelect() {\n            let amount_num = this.numSelect.length;\n            let num = this.numSelect[amount_num - 1];\n            let new_num = num + 1;\n            let lenghtItem = this.specificDiscountItem.length;\n            if (new_num <= lenghtItem) {\n                this.numSelect.push(new_num);\n            }\n        },\n        removeSelect(index) {\n            this.numSelect.splice(index, 1);\n            // window.console.log(index, this.numSelect)\n            // this.selectDiscount.splice(index,1)\n            // window.console.log(\"remove\",this.selectDiscount)\n            // this.selectDiscount = this.selectDiscount.filter(item =>  item.id != val.id);\n        },\n        onOtherChargeChange() {\n            let otherCharge = 0,\n                amount = 0;\n            this.invoice.otherChargeLine = [];\n            this.mOtherCharge.forEach((m) => {\n                amount = this.autoCalculateDiscount(m, this.invoice.subTotal);\n                otherCharge += amount;\n                this.invoice.otherChargeLine.push({\n                    id: m.id,\n                    name: m.name,\n                    amount: amount,\n                    exchangeAmount: amount * (this.invoice.txnRate || 1),\n                });\n            });\n            this.invoice.otherChargeAmount = otherCharge;\n            this.autoCalculate();\n        },\n        onOtherAmount(value) {\n            return this.autoCalculateDiscount(value, this.invoice.subTotal);\n        },\n        onSpecificDiscountChanged() {\n            this.invoice.specificDiscountTotal = 0;\n            if (this.invoice.specificDiscountItem) {\n                // window.console.log('-changed', this.invoice.specificDiscountItem)\n                const discountInvoice = this.autoCalculateDiscount(\n                    this.invoice.specificDiscountItem,\n                    this.invoice.subTotal\n                );\n                this.invoice.specificDiscountTotal = kendo.parseFloat(\n                    discountInvoice ? discountInvoice : 0\n                );\n                let total =\n                    kendo.parseFloat(this.invoice.subTotal) -\n                    (kendo.parseFloat(this.invoice.discountTotal) +\n                        kendo.parseFloat(this.invoice.totalTaxAmount)) -\n                    discountInvoice;\n                this.invoice.total = total;\n            }\n            this.autoCalculate();\n        },\n        empImpl(dataItem) {\n            let empIds = [];\n            dataItem.employee.forEach((m) => {\n                empIds.push(m.firstName + \" - \" + m.lastName);\n            });\n            // window.console.log(empIds.join(', '))\n            return `<span>${empIds.join(\", \")}</span>`;\n        },\n        async loadSaleFormContent() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    saleFormContentHandler.list().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            const data = res.data.data;\n                            if (data.length > 0) {\n                                this.saleFormContent = data[0];\n                                this.initData();\n                            }\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadSaleUnitItems() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    saleUnitItemHandler.list().then((res) => {\n                        if (res.data.statusCode === 200)\n                            this.saleUnitItemList = res.data.data;\n                    });\n                }, 10);\n            });\n        },\n        uomTmp(dataItem) {\n            window.console.log(dataItem);\n            return dataItem;\n        },\n        loadItemUOM(itemId, priceLevelId) {\n            window.console.log(\"p\", itemId, priceLevelId);\n        },\n        async loadUOMPrice(itemId, priceLevelId) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    uomPriceHandler.get(itemId).then((res) => {\n                        const prices = res.filter((m) => m.priceLevel.id === priceLevelId);\n                        window.console.log(\"price\", prices, itemId, priceLevelId);\n                    });\n                }, 10);\n            });\n        },\n        async loadUOMList(itemId) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    uomConversionHandler.get(itemId).then((res) => {\n                        this.uoms = res;\n                        window.console.log(\"all UOm\", res);\n                    });\n                }, 10);\n            });\n        },\n        onInvoiceTypeChanged() {\n            if (this.$route.params.id === null || this.$route.params.id === \"\") {\n                this.generateNumber();\n            }\n            this.templateHandle();\n        },\n        templateHandle() {\n            let temp = [];\n            if (this.invoice.transactionType.name == \"Commercial Invoice\") {\n                temp.push({\n                    id: 0,\n                    type: \"Commercial Invoice\",\n                    name: \"Template One\",\n                });\n            } else if (this.invoice.transactionType.name == \"General Invoice\") {\n                temp.push({\n                    id: 0,\n                    type: \"General Invoice\",\n                    name: \"Template One\",\n                });\n            } else if (this.invoice.transactionType.name == \"Tax Invoice\") {\n                temp.push({\n                    id: 0,\n                    type: \"Tax Invoice\",\n                    name: \"Template One\",\n                });\n                temp.push({\n                    id: 1,\n                    type: \"Tax Invoice2\",\n                    name: \"Template Two\",\n                });\n            }\n            this.templatesForm = temp;\n            this.template = 0;\n        },\n        autoCalculateTaxByType(tax) {\n            // return by a key\n            const groupAll = (list) =>\n                list.reduce((tax, item) => {\n                    const taxAmount = tax[item.name] || 0;\n                    return Object.assign({}, tax, {\n                        [item.name]: taxAmount + parseFloat(item.amount),\n                    });\n                }, {});\n            this.taxListTotal = groupAll(tax);\n            // window.console.log('nimol', groupAll(tax))\n        },\n        onDepositDeductionChange() {\n            if (\n                this.depositDeduction === \"\" ||\n                this.depositDeduction === undefined\n            ) {\n                this.depositDeduction = 0;\n            }\n            this.invoice.depositDeduction = 0\n            // window.console.log('this.depositDeduction', this.depositDeduction)\n            // window.console.log('this.invoice.depositDeduction', this.invoice.depositDeduction)\n            const amount = parseFloat(this.invoice.total) - parseFloat(this.invoice.depositDeduction)\n            const xChangeAmount = amount * (this.invoice.txnRate || 1)\n            const deduction = parseFloat(this.depositDeduction) || 0;\n            const depA = parseFloat(this.invoice.depositAmount) || 0\n            const xAmount = parseFloat(xChangeAmount) || 0\n            let deduct = deduction\n            if (deduction > xAmount) {\n                deduct = xAmount\n                if (deduct > depA) {\n                    deduct = depA\n                }\n                window.console.log('1', deduct)\n            } else {\n                if (deduct > depA) {\n                    deduct = depA\n                }\n                window.console.log('2', deduct)\n            }\n            this.depositDeduction = parseFloat(deduct)\n            this.invoice.depositDeduction = parseFloat(deduct);\n            // window.console.log('this.invoice.depositDeduction', deduct)\n            // if (deduction > this.invoice.depositAmount) {\n            //     this.invoice.depositDeduction = this.invoice.depositAmount;\n            // }\n            // if (deduction > parseFloat(this.invoice.exchangeAmount)) {\n            //     this.invoice.depositDeduction = this.invoice.exchangeAmount;\n            // }\n            // window.console.log('this.invoice', this.invoice)\n            this.autoCalculate();\n        },\n        autoCalculate() {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                subTotal = 0,\n                totalTax = 0,\n                discountTotal = 0,\n                otherChargeTotal = 0,\n                spTax = 0,\n                pltax = 0,\n                otherTax = 0,\n                vatTax = 0,\n                discountInvoice = 0,\n                taxList = [],\n                taxListDetail = [],\n                discountItem = [],\n                otherChargeItem = [],\n                saleUnit = [],\n                inclusiveTax = 0,\n                discountLine = [],\n                otherChargeLine = [],\n                saleUnitLine = [],\n                itemSubtotal = 0,\n                txnItmSubtotal = 0,\n                serviceSubtotal = 0,\n                itemDiscount = 0,\n                serviceDiscount = 0,\n                txnDiscount = 0;\n            let nature = \"\";\n            this.jRaw = [];\n            const rows = ds.data().filter((m) => parseFloat(m.amount) > 0);\n            rows.forEach((value) => {\n                let modifierPrice = 0;\n                let vatSpTax = {}, vatPLTax = {}, vatOtherTax = {}\n                if (value.modifier) {\n                    modifierPrice = kendo.parseFloat(value.modifier.price);\n                }\n\n                // subTotal += (kendo.parseFloat(value.amount) + modifierPrice)\n                let discount = 0, otherCharge = 0;\n                if (value.otherChargeItem) {\n                    const subTotal = kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n                    const otherChargeField = value.otherChargeItem || {};\n                    otherCharge = this.autoCalculateDiscount(otherChargeField, subTotal)\n                    value[\"otherChargeAmount\"] = otherCharge;\n                    value[\"otherChargeExchangeAmount\"] = otherCharge * kendo.parseFloat(this.invoice.txnRate);\n                    if (value.otherChargeItem.hasOwnProperty(\"id\")) {\n                        otherChargeItem.push(value.otherChargeItem);\n                        otherChargeLine.push({\n                            id: value.otherChargeItem.id,\n                            name: value.otherChargeItem.name,\n                            amount: otherCharge,\n                            exchangeAmount: otherCharge * parseFloat(this.invoice.txnRate),\n                        });\n                    }\n                    window.console.log('otherChargeTotal', otherCharge)\n                    otherChargeTotal += (otherCharge || 0);\n                    if (otherCharge * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (otherChargeField.account) {\n                        if (otherChargeField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: otherChargeField.account.id + \"-\" + nature,\n                                description: \"Other Charge\",\n                                account: otherChargeField.account,\n                                accountId: otherChargeField.account.id,\n                                amount: otherCharge * -1,\n                                exchangeAmount: otherCharge * -1 * kendo.parseFloat(this.invoice.txnRate),\n                                type: nature,\n                                typeAs: \"otherCharge\",\n                            });\n                        }\n                    }\n                }\n                if (value.discountItem) {\n                    const disItemField = value.discountItem;\n                    const subTo = kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n                    discount = this.autoCalculateDiscount(value.discountItem, subTo);\n                    value[\"discountAmount\"] = discount;\n                    value[\"discountExchangeAmount\"] = discount * kendo.parseFloat(this.invoice.txnRate);\n                    // window.console.log('value', JSON.stringify(value))\n                    if (value.discountItem.hasOwnProperty(\"id\")) {\n                        discountItem.push(value.discountItem);\n                        discountLine.push({\n                            id: value.discountItem.id,\n                            name: value.discountItem.name,\n                            amount: discount,\n                            exchangeAmount: discount * parseFloat(this.invoice.txnRate),\n                        });\n                    }\n                    discountTotal += (discount || 0)\n                    if (discount > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (disItemField.account) {\n                        if (disItemField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: disItemField.account.id + \"-\" + nature,\n                                // line: new ItemLineModel(value),\n                                description: \"Discount\",\n                                account: disItemField.account,\n                                accountId: disItemField.account.id,\n                                amount: discount,\n                                exchangeAmount:\n                                    discount * kendo.parseFloat(this.invoice.txnRate),\n                                type: nature,\n                                typeAs: \"discount\",\n                            });\n                        }\n                    }\n                }\n                if (value.saleUnit) {\n                    if (value.saleUnit.hasOwnProperty(\"id\")) {\n                        saleUnit.push(value.saleUnit);\n                        const item_ = value.item || {};\n                        const amount_ =\n                            kendo.parseFloat(value.price) * kendo.parseFloat(value.qty) || 0;\n                        const itemObj = {\n                            id: item_.id || \"\",\n                            name: item_.name || \"\",\n                            amount: amount_ - (discount || 0),\n                        };\n                        saleUnitLine.push({\n                            lineId: value.id || \"\",\n                            id: value.saleUnit.id,\n                            name: value.saleUnit.name,\n                            item: itemObj,\n                            amount: itemObj.amount,\n                            exchangeAmount: itemObj.amount * (this.invoice.txnRate || 1),\n                            discount: discount || 0,\n                            exchangeDiscount: (discount || 0) * (this.invoice.txnRate || 1),\n                        });\n                    }\n                }\n                if (value.specificTax) {\n                    spTax = this.autoCalculateTax(\n                        value.specificTax,\n                        kendo.parseFloat(value.amount) - kendo.parseFloat(discount)\n                    );\n                    spTax = kendo.parseFloat(spTax) ? kendo.parseFloat(spTax) : 0;\n                    value[\"specificTaxAmount\"] = spTax;\n                    value[\"specificTaxExchangeAmount\"] =\n                        spTax * kendo.parseFloat(this.invoice.txnRate);\n                    const tax = value.specificTax;\n                    const baseAmount = tax.baseAmount;\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            inclusiveTax += spTax;\n                        }\n                    }\n                    // window.console.log(value.specificTax)\n                    if (value.specificTax.hasOwnProperty(\"taxType\")) {\n                        taxList.push({\n                            name: value.specificTax.taxType.name,\n                            amount: spTax,\n                            id: value.specificTax.taxType.id,\n                        });\n                        const spTax_ = value.specificTax || {}\n                        // spTax_['taxAmount'] = spTax\n                        spTax_['taxAmount_'] = spTax\n                        spTax_['amount'] = value.amount || 0\n                        spTax_['discount'] = discount || 0\n                        spTax_['txnRate'] = this.invoice.txnRate || 1\n                        // delete tax_['account']\n                        taxListDetail.push(spTax_);\n                        vatSpTax = spTax_\n                    }\n                    if (spTax * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    const specificTaxField = value.specificTax;\n                    if (specificTaxField.account) {\n                        if (specificTaxField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: specificTaxField.account.id + \"-\" + nature,\n                                // line: new ItemLineModel(value),\n                                description: \"Tax\",\n                                account: specificTaxField.account,\n                                accountId: specificTaxField.account.id,\n                                amount: spTax * -1,\n                                exchangeAmount:\n                                    spTax * -1 * kendo.parseFloat(this.invoice.txnRate),\n                                type: nature,\n                                typeAs: \"tax\",\n                            });\n                        }\n                    }\n                }\n                if (value.publicLightingTax) {\n                    pltax = this.autoCalculateTax(\n                        value.publicLightingTax,\n                        kendo.parseFloat(value.amount) - kendo.parseFloat(discount)\n                    );\n                    pltax = kendo.parseFloat(pltax) ? kendo.parseFloat(pltax) : 0;\n                    value[\"publicLightingTaxAmount\"] = pltax;\n                    value[\"publicLightingTaxExchangeAmount\"] =\n                        pltax * kendo.parseFloat(this.invoice.txnRate);\n                    const tax = value.publicLightingTax;\n                    const baseAmount = tax.baseAmount;\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            inclusiveTax += pltax;\n                        }\n                    }\n                    if (value.publicLightingTax.hasOwnProperty(\"taxType\")) {\n                        taxList.push({\n                            name: value.publicLightingTax.taxType.name,\n                            amount: pltax,\n                            id: value.publicLightingTax.taxType.id,\n                        });\n                        const plTax_ = value.publicLightingTax || {}\n                        // plTax_['taxAmount'] = pltax\n                        plTax_['taxAmount_'] = pltax\n                        plTax_['amount'] = value.amount || 0\n                        plTax_['discount'] = discount || 0\n                        plTax_['txnRate'] = this.invoice.txnRate || 1\n                        // delete tax_['account']\n                        taxListDetail.push(plTax_);\n                        vatPLTax = plTax_\n                    }\n                    if (pltax * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    const PLTaxField = value.publicLightingTax;\n                    if (PLTaxField.account) {\n                        if (PLTaxField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: PLTaxField.account.id + \"-\" + nature,\n                                // line: new ItemLineModel(value),\n                                description: \"Tax\",\n                                account: PLTaxField.account,\n                                accountId: PLTaxField.account.id,\n                                amount: pltax * -1,\n                                exchangeAmount:\n                                    pltax * kendo.parseFloat(this.invoice.txnRate) * -1,\n                                type: nature,\n                                typeAs: \"tax\",\n                            });\n                        }\n                    }\n                }\n                if (value.otherTax) {\n                    otherTax = this.autoCalculateTax(\n                        value.otherTax,\n                        kendo.parseFloat(value.amount) - kendo.parseFloat(discount)\n                    );\n                    otherTax = kendo.parseFloat(otherTax)\n                        ? kendo.parseFloat(otherTax)\n                        : 0;\n                    value[\"otherTaxAmount\"] = otherTax;\n                    value[\"otherTaxExchangeAmount\"] =\n                        otherTax * kendo.parseFloat(this.invoice.txnRate);\n                    const tax = value.otherTax;\n                    const baseAmount = tax.baseAmount;\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            inclusiveTax += otherTax;\n                        }\n                    }\n                    if (value.otherTax.hasOwnProperty(\"taxType\")) {\n                        taxList.push({\n                            name: value.otherTax.taxType.name,\n                            amount: otherTax,\n                            id: value.otherTax.taxType.id,\n                        });\n                        const tax__ = value.otherTax || {}\n                        // tax__['taxAmount'] = otherTax\n                        tax__['taxAmount_'] = otherTax\n                        tax__['amount'] = value.amount || 0\n                        tax__['discount'] = discount || 0\n                        tax__['txnRate'] = this.invoice.txnRate || 1\n                        // delete tax_['account']\n                        taxListDetail.push(tax__);\n                        vatOtherTax = tax__\n                    }\n                    if (otherTax * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    const otherTaxField = value.otherTax;\n                    if (otherTaxField.account) {\n                        if (otherTaxField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: otherTaxField.account.id + \"-\" + nature,\n                                // line: new ItemLineModel(value),\n                                description: \"Tax\",\n                                account: otherTaxField.account,\n                                accountId: otherTaxField.account.id,\n                                amount: otherTax * -1,\n                                exchangeAmount:\n                                    otherTax * kendo.parseFloat(this.invoice.txnRate) * -1,\n                                type: nature,\n                                typeAs: \"tax\",\n                            });\n                        }\n                    }\n                }\n\n                if (value.vatTax) {\n                    // window.console.log('Vat Tax', value.vatTax)\n                    let amt =\n                        kendo.parseFloat(spTax ? spTax : 0) +\n                        kendo.parseFloat(pltax ? pltax : 0) +\n                        kendo.parseFloat(otherTax ? otherTax : 0) +\n                        (kendo.parseFloat(value.amount ? value.amount : 0) -\n                            (discount ? discount : 0));\n                    vatTax = this.autoCalculateTax(value.vatTax, amt);\n                    vatTax = kendo.parseFloat(vatTax) ? kendo.parseFloat(vatTax) : 0;\n                    value[\"vatTaxAmount\"] = vatTax;\n                    value[\"vatTaxExchangeAmount\"] =\n                        vatTax * kendo.parseFloat(this.invoice.txnRate);\n                    const tax = value.vatTax;\n                    const baseAmount = tax.baseAmount;\n                    if (baseAmount) {\n                        if (baseAmount.toLowerCase() === \"inclusive\") {\n                            inclusiveTax += vatTax;\n                        }\n                    }\n                    if (value.vatTax.hasOwnProperty(\"taxType\")) {\n                        taxList.push({\n                            name: value.vatTax.taxType.name,\n                            amount: vatTax,\n                            id: value.vatTax.taxType.id,\n                        });\n                        const vatTax_ = value.vatTax || {}\n                        // vatTax_['taxAmount'] = vatTax\n                        vatTax_['taxAmount_'] = vatTax\n                        vatTax_['amount'] = value.amount || 0\n                        vatTax_['discount'] = discount || 0\n                        vatTax_['txnRate'] = this.invoice.txnRate || 1\n                        vatTax_['isVat'] = 1\n                        vatTax_.detail = {\n                            specificTax: vatSpTax,\n                            publicLightingTax: vatPLTax,\n                            otherTax: vatOtherTax,\n                        }\n                        // delete tax_['account']\n                        taxListDetail.push(vatTax_);\n\n                    }\n\n                    if (vatTax * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    const vatTaxField = value.vatTax;\n                    if (vatTaxField.account) {\n                        if (vatTaxField.account.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: vatTaxField.account.id + \"-\" + nature,\n                                // line: new ItemLineModel(value),\n                                description: \"Tax\",\n                                account: vatTaxField.account,\n                                accountId: vatTaxField.account.id,\n                                amount: vatTax * -1,\n                                exchangeAmount:\n                                    vatTax * kendo.parseFloat(this.invoice.txnRate) * -1,\n                                type: nature,\n                                typeAs: \"tax\",\n                            });\n                        }\n                    }\n                }\n                vatSpTax = {}, vatPLTax = {} , vatOtherTax = {}\n                totalTax +=\n                    kendo.parseFloat(spTax ? spTax : 0) +\n                    kendo.parseFloat(pltax ? pltax : 0) +\n                    kendo.parseFloat(otherTax ? otherTax : 0) +\n                    kendo.parseFloat(vatTax ? vatTax : 0);\n                subTotal +=\n                    kendo.parseFloat(value.amount) + modifierPrice - inclusiveTax;\n                const amt =\n                    kendo.parseFloat(value.amount) + modifierPrice - inclusiveTax;\n                const xAmount =\n                    kendo.parseFloat(amt) * kendo.parseFloat(this.invoice.txnRate) * -1;\n                const item = value.item;\n                const itmType = item.type || \"\";\n                if (itmType === \"Variant\") {\n                    itemSubtotal +=\n                        kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n                    itemDiscount += kendo.parseFloat(discount);\n                } else if (itmType === \"Service\") {\n                    serviceSubtotal +=\n                        kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n                    itemDiscount += kendo.parseFloat(discount);\n                } else {\n                    txnItmSubtotal +=\n                        kendo.parseFloat(value.price) * kendo.parseFloat(value.qty);\n                    itemDiscount += kendo.parseFloat(discount);\n                }\n\n                const conversionRate = value.conversionRate || 1;\n                const bQty = parseFloat(value.qty * conversionRate);\n                const wac = parseFloat(value.wac) || 0;\n                const itemAmount = parseFloat(bQty) * wac;\n                // const itemxAmount = itemAmount\n                if (amt * -1 > 0) {\n                    nature = \"dr\";\n                } else {\n                    nature = \"cr\";\n                }\n                if (item) {\n                    if (item.type === \"Service\") {\n                        if (value.isPlan) {\n                            if (item.hasOwnProperty(\"deferredIncomeAcc\")) {\n                                if (item.deferredIncomeAcc.hasOwnProperty(\"id\")) {\n                                    let deferredInAcc = item.deferredIncomeAcc;\n                                    this.jRaw.push({\n                                        id: deferredInAcc.id + \"-\" + nature,\n                                        // line: new ItemLineModel(value),\n                                        description: this.invoice.journalNote,\n                                        account: deferredInAcc,\n                                        accountId: deferredInAcc.id,\n                                        amount: amt * -1,\n                                        exchangeAmount: xAmount,\n                                        type: nature,\n                                        typeAs: \"item\",\n                                    });\n                                }\n                            }\n                        } else {\n                            let incomeAcc = item.incomeAcc;\n                            if (item.hasOwnProperty(\"incomeAcc\")) {\n                                if (item.incomeAcc.hasOwnProperty(\"id\")) {\n                                    this.jRaw.push({\n                                        id: incomeAcc.id + \"-\" + nature,\n                                        // line: new ItemLineModel(value),\n                                        description: this.invoice.journalNote,\n                                        account: incomeAcc,\n                                        accountId: incomeAcc.id,\n                                        amount: amt * -1,\n                                        exchangeAmount: xAmount,\n                                        type: nature,\n                                        typeAs: \"item\",\n                                        cashBasic: 1\n                                    });\n                                }\n                            }\n                        }\n                    } else if (item.type === \"Variant\") {\n                        if (item.hasOwnProperty(\"incomeAcc\")) {\n                            if (item.incomeAcc.hasOwnProperty(\"id\")) {\n                                let incomeAcc = item.incomeAcc;\n                                this.jRaw.push({\n                                    id: incomeAcc.id + \"-\" + nature,\n                                    // line: new ItemLineModel(value),\n                                    description: this.invoice.journalNote,\n                                    account: item.incomeAcc,\n                                    accountId: item.incomeAcc.id,\n                                    amount: amt * -1,\n                                    exchangeAmount: xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                    cashBasic: 1\n                                });\n                            }\n                        }\n                        if (item.hasOwnProperty(\"inventoryAcc\")) {\n                            if (item.inventoryAcc.hasOwnProperty(\"id\")) {\n                                let inventoryAcc = item.inventoryAcc;\n                                this.jRaw.push({\n                                    id: inventoryAcc.id + \"-\" + \"cr\",\n                                    // line: new ItemLineModel(value),\n                                    description: this.invoice.journalNote,\n                                    account: item.inventoryAcc,\n                                    accountId: item.inventoryAcc.id,\n                                    amount: itemAmount * -1, // qty*avg_cost ,\n                                    exchangeAmount: itemAmount * -1, //xAmount,\n                                    type: \"cr\",\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                        if (item.hasOwnProperty(\"costOfGoodsSoldAcc\")) {\n                            if (item.costOfGoodsSoldAcc.hasOwnProperty(\"id\")) {\n                                let costOfGoodsSoldAcc = item.costOfGoodsSoldAcc;\n                                this.jRaw.push({\n                                    id: costOfGoodsSoldAcc.id + \"-\" + \"dr\",\n                                    // line: new ItemLineModel(value),\n                                    description: this.invoice.journalNote,\n                                    account: item.costOfGoodsSoldAcc,\n                                    accountId: item.costOfGoodsSoldAcc.id,\n                                    amount: itemAmount, // qty*avg_cost ,\n                                    exchangeAmount: itemAmount, //xAmount,\n                                    type: \"dr\",\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n\n                    } else if (item.type === \"Fixed Asset\") {\n                        if (item.hasOwnProperty(\"assetAcc\")) {\n                            if (item.assetAcc.hasOwnProperty(\"id\")) {\n                                let assetAcc = item.assetAcc;\n                                this.jRaw.push({\n                                    id: assetAcc.id + \"-\" + nature,\n                                    // line: new ItemLineModel(value),\n                                    description: this.invoice.journalNote,\n                                    account: item.assetAcc,\n                                    accountId: item.assetAcc.id,\n                                    amount: amt * -1,\n                                    exchangeAmount: xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    } else if (item.type === \"Transaction Item\") {\n                        if (item.hasOwnProperty(\"account\")) {\n                            if (item.account.hasOwnProperty(\"id\")) {\n                                this.jRaw.push({\n                                    id: item.account.id + \"-\" + nature,\n                                    // line: new ItemLineModel(value),\n                                    description: this.invoice.journalNote,\n                                    account: item.account,\n                                    accountId: item.account.id,\n                                    amount: amt * -1,\n                                    exchangeAmount: xAmount,\n                                    type: nature,\n                                    typeAs: \"item\",\n                                });\n                            }\n                        }\n                    }\n                }\n                //include Tax Amount\n                const amountNodiscount = kendo.parseFloat(value.price) * kendo.parseFloat(value.qty) - discount;\n                const includeTaxAmount = amountNodiscount + vatTax + pltax + spTax + otherTax;\n                value[\"includeTaxAmount\"] = includeTaxAmount;\n                value[\"includeTaxExchangeAmount\"] = includeTaxAmount * kendo.parseFloat(this.invoice.txnRate);\n            });\n            this.invoice.itemSubtotal = itemSubtotal;\n            this.invoice.exchangeItemSubtotal =\n                itemSubtotal * kendo.parseFloat(this.invoice.txnRate);\n            this.invoice.serviceSubtotal = serviceSubtotal;\n            this.invoice.exchangeServiceSubtotal =\n                serviceSubtotal * kendo.parseFloat(this.invoice.txnRate);\n            this.invoice.txnItmSubtotal = txnItmSubtotal;\n            this.invoice.exchangeTxnItmSubtotal =\n                txnItmSubtotal * kendo.parseFloat(this.invoice.txnRate);\n            this.invoice.itemDiscount = itemDiscount;\n            this.invoice.exchangeItemDiscount =\n                itemDiscount * kendo.parseFloat(this.invoice.txnRate);\n            this.invoice.serviceDiscount = serviceDiscount;\n            this.invoice.exchangeServiceDiscount =\n                serviceDiscount * kendo.parseFloat(this.invoice.txnRate);\n            this.invoice.txnItmDiscount = txnDiscount;\n            this.invoice.exchangeTxnItmDiscount =\n                txnDiscount * kendo.parseFloat(this.invoice.txnRate);\n            // window.console.log(spTax, pltax, otherTax, vatTax)\n            let total =\n                kendo.parseFloat(subTotal) -\n                kendo.parseFloat(discountTotal) +\n                kendo.parseFloat(totalTax);\n            this.invoice.subTotal = subTotal;\n            this.invoice.exchangeSubTotal =\n                subTotal * parseFloat(this.invoice.txnRate);\n            // $(\"#subtotal\").text(kendo.parseFloat(subTotal))\n            this.invoice.totalTaxAmount = kendo.parseFloat(totalTax);\n            this.invoice.discountTotal = kendo.parseFloat(discountTotal);\n            this.invoice.otherChargeTotal = kendo.parseFloat(otherChargeTotal);\n            if (this.invoice.specificDiscountItem) {\n                discountInvoice = this.autoCalculateDiscount(\n                    this.invoice.specificDiscountItem,\n                    kendo.parseFloat(subTotal)\n                );\n                discountInvoice = discountInvoice ? discountInvoice : 0;\n            }\n            // this.onOtherChargeChange()\n            this.invoice.total = kendo.parseFloat(total) - discountInvoice + kendo.parseFloat(this.invoice.otherChargeAmount) + otherChargeTotal;\n            this.invoice.remainingAmount = kendo.parseFloat(this.invoice.total) - kendo.parseFloat(this.invoice.depositDeduction);\n            this.invoice.amountDue = kendo.parseFloat(this.invoice.total) - kendo.parseFloat(this.invoice.depositDeduction);\n            this.invoice.exchangeAmount = kendo.parseFloat(this.invoice.amountDue) * kendo.parseFloat(this.invoice.txnRate);\n            // window.console.log('Exchange Amount', this.invoice.exchangeAmount)\n            this.autoCalculateTaxByType(taxList);\n            if (this.invoice.specificDiscountItem) {\n                const specificDiscount = this.invoice.specificDiscountItem || {};\n                if (specificDiscount.id) {\n                    discountItem.push(specificDiscount);\n                    discountLine.push({\n                        id: specificDiscount.id,\n                        name: specificDiscount.name,\n                        amount: this.invoice.specificDiscountTotal,\n                        exchangeAmount:\n                            this.invoice.specificDiscountTotal * this.invoice.txnRate,\n                    });\n                }\n            }\n            const uniqueDiscountItem = this.removeDuplicate(discountItem);\n            this.shrinkDiscountItem(uniqueDiscountItem, discountLine);\n\n            const uniqueOtherCharge = this.removeDuplicate(otherChargeItem);\n            this.shrinkOtherChargeItem(uniqueOtherCharge, otherChargeLine);\n\n            this.customerSaleUnit = this.removeDuplicate(saleUnit);\n            this.customerSaleUnitLine = saleUnitLine; //this.removeDuplicate(saleUnit)\n            this.taxListDetail = taxListDetail\n            // window.console.log('taxListDetail--', taxListDetail)\n            // todo: raw Journal\n            const receivableAcc = this.invoice.receivableAcc || {};\n            if (this.invoice.amountDue > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            if (receivableAcc) {\n                if (receivableAcc.hasOwnProperty(\"id\")) {\n                    this.jRaw.push({\n                        id: receivableAcc.id + \"-\" + nature,\n                        // line: new ItemLineModel({}),\n                        description: this.invoice.journalNote,\n                        account: receivableAcc,\n                        accountId: receivableAcc.id,\n                        exchangeAmount: this.invoice.exchangeAmount,\n                        amount: this.invoice.amountDue,\n                        type: nature,\n                        typeAs: \"ar\",\n                    });\n                }\n            }\n            const specificDisc = this.invoice.specificDiscountItem;\n            if (this.invoice.specificDiscountTotal > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            if (specificDisc) {\n                if (specificDisc.hasOwnProperty(\"account\")) {\n                    if (specificDisc.account) {\n                        if (specificDisc.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: specificDisc.account.id + \"-\" + nature,\n                                // line: new ItemLineModel({}),\n                                description: \"Discount\",\n                                account: specificDisc.account || {},\n                                accountId: specificDisc.account.id,\n                                exchangeAmount:\n                                    kendo.parseFloat(this.invoice.specificDiscountTotal) *\n                                    kendo.parseFloat(this.invoice.txnRate),\n                                amount: this.invoice.specificDiscountTotal,\n                                type: nature,\n                                typeAs: \"discount\",\n                            });\n                        }\n                    }\n                }\n            }\n\n            if (this.invoice.depositDeduction > 0) {\n                nature = \"dr\";\n            } else {\n                nature = \"cr\";\n            }\n            this.invoice.exchangeDepositDeduction =\n                (this.invoice.txnRate || 0) * this.invoice.depositDeduction;\n            if (this.invoice.depositDeduction) {\n                if (this.invoice.depositDeduction > 0) {\n                    const saleDepositAcc = this.customer.saleDepositAcc || {};\n                    if (saleDepositAcc) {\n                        if (saleDepositAcc.hasOwnProperty(\"id\")) {\n                            this.jRaw.push({\n                                id: saleDepositAcc.id + \"-\" + nature,\n                                description: \"Deposit\",\n                                // line: new ItemLineModel({}),\n                                account: saleDepositAcc,\n                                accountId: saleDepositAcc.id,\n                                exchangeAmount: this.invoice.exchangeDepositDeduction,\n                                amount: this.invoice.depositDeduction,\n                                type: nature,\n                                typeAs: \"deposit\",\n                            });\n                        }\n                    }\n                }\n            }\n            if (this.mOtherCharge.length > 0) {\n                let otherCharge = 0;\n                this.mOtherCharge.forEach((m) => {\n                    otherCharge = this.autoCalculateDiscount(m, this.invoice.subTotal);\n                    if (otherCharge * -1 > 0) {\n                        nature = \"dr\";\n                    } else {\n                        nature = \"cr\";\n                    }\n                    if (m) {\n                        if (m.hasOwnProperty(\"account\")) {\n                            if (m.account.hasOwnProperty(\"id\")) {\n                                const account = m.account;\n                                if (account) {\n                                    if (account.hasOwnProperty(\"id\")) {\n                                        this.jRaw.push({\n                                            id: account.id + \"-\" + nature,\n                                            // line: new ItemLineModel({}),\n                                            description: \"Other Charge\",\n                                            account: account,\n                                            accountId: account.id,\n                                            exchangeAmount:\n                                                otherCharge *\n                                                kendo.parseFloat(this.invoice.txnRate) *\n                                                -1,\n                                            amount: otherCharge * -1,\n                                            type: nature,\n                                            typeAs: \"otherCharge\",\n                                        });\n                                    }\n                                }\n                            }\n                        }\n                    }\n                });\n                // this.invoice.otherChargeAmount = otherCharge\n\n                window.console.log(this.mOtherCharge);\n            }\n            this.autoCalculateTaxDetail();\n            // todo: end raw Journal\n            // window.console.log(JSON.stringify(this.accounts), 'accounts')\n            this.shrinkData(this.jRaw);\n            // const unique = this.removeDuplicate(this.accounts)\n            // window.console.log(unique, 'unique')\n        },\n        shrinkData(obj) {\n            const uniques = this.removeDuplicate(\n                obj\n            ); /*[...new Set(accountId.map(i => {\n                return {\n                    id_: i.id_,\n                    id: i.id,\n                    type: i.type\n                }\n            }))]*/\n            /* todo: cash basic account */\n            let cashBasicAmount = 0\n            let xCashBasicAmount = 0\n            this.invoice.cashBasicIncomeAcc = []\n            let cashBasicAcc = uniques.filter(m => m.cashBasic === 1)\n            cashBasicAcc.forEach(k => {\n                cashBasicAmount += k.amount\n                xCashBasicAmount += k.exchangeAmount\n            })\n            cashBasicAcc.map(o => {\n                o['amountPercentage'] = o.amount / cashBasicAmount\n                o['xAmountPercentage'] = o.exchangeAmount / xCashBasicAmount\n            })\n            this.invoice.cashBasicIncomeAcc = cashBasicAcc\n            /* todo: end */\n            uniques.forEach((n) => {\n                const found = obj.filter((m) => m.id === n.id);\n                let amount = 0,\n                    xAmount = 0;\n                found.forEach((z) => {\n                    amount += parseFloat(z.amount || 0);\n                    xAmount += parseFloat(z.exchangeAmount || 0);\n                });\n                n.amount = parseFloat(amount); //this.numberFormat(amount)\n                n.exchangeAmount = parseFloat(xAmount); //parseFloat(parseFloat(amount * parseFloat(this.invoice.txnRate))) //this.numberFormat(amount * parseFloat(this.invoice.txnRate)) //.toFixed(this.saleFormContent.decimal)\n            });\n            this.jRaw = uniques;\n            let dr = 0,\n                cr = 0;\n            this.jRaw.forEach((j) => {\n                switch (j.type) {\n                    case \"cr\":\n                        cr += parseFloat(j.amount);\n                        break;\n                    case \"dr\":\n                        dr += parseFloat(j.amount);\n                        break;\n                    default:\n                        break;\n                }\n            });\n            this.invoice.dr = dr;\n            this.invoice.cr = cr;\n            window.console.log(\"dr=\", dr, \"cr=\", cr, \"dr+cr = \", dr + cr);\n            window.console.log(JSON.stringify(uniques), \"uniques\");\n        },\n        rawForJournal() {\n            //todo: DR side account receivable\n            let itemLineDS = this.$refs.itemLineDS.kendoWidget();\n            const dataRow = itemLineDS.data();\n            this.jRaw = [];\n            // window.console.log(dataRow, 'dataRow')\n            dataRow.forEach((o) => {\n                const item = o.item;\n                const discountItem = o.discountItem;\n                const vatTax = o.vatTax;\n                const specificTax = o.specificTax;\n                const PLTax = o.publicLightingTax;\n                const otherTax = o.otherTax;\n                if (item) {\n                    if (item.type === \"Service\") {\n                        let incomeAcc = item.incomeAcc;\n                        if (item.hasOwnProperty(\"incomeAcc\")) {\n                            this.jRaw.push({\n                                item: item,\n                                line: o,\n                                account: incomeAcc,\n                                accountId: incomeAcc.id,\n                                type: \"cr\",\n                                typeAs: \"item\",\n                            });\n                        }\n                        if (item.hasOwnProperty(\"deferredIncomeAcc\")) {\n                            let deferredInAcc = item.deferredIncomeAcc;\n                            this.jRaw.push({\n                                item: item,\n                                line: o,\n                                account: deferredInAcc,\n                                accountId: deferredInAcc.id,\n                                type: \"cr\",\n                                typeAs: \"item\",\n                            });\n                        }\n                    } else if (item.type === \"Variant\") {\n                        this.jRaw.push({\n                            item: item,\n                            line: o,\n                            account: item.incomeAcc,\n                            accountId: item.incomeAcc.id,\n                            type: \"cr\",\n                            typeAs: \"item\",\n                        });\n                        this.jRaw.push({\n                            item: item,\n                            line: o,\n                            account: item.inventoryAcc,\n                            accountId: item.inventoryAcc.id,\n                            type: \"cr\",\n                            typeAs: \"item\",\n                        });\n                        this.jRaw.push({\n                            item: item,\n                            line: o,\n                            account: item.costOfGoodsSoldAcc,\n                            accountId: item.costOfGoodsSoldAcc.id,\n                            type: \"dr\",\n                            typeAs: \"item\",\n                        });\n                    } else if (item.type === \"Fixed Asset\") {\n                        this.jRaw.push({\n                            item: item,\n                            line: o,\n                            account: item.assetAcc,\n                            accountId: item.assetAcc.id,\n                            type: \"cr\",\n                            typeAs: \"item\",\n                        });\n                    } else if (item.type === \"Transaction Item\") {\n                        this.jRaw.push({\n                            item: item,\n                            line: o,\n                            account: item.account,\n                            accountId: item.account.id,\n                            type: \"cr\",\n                            typeAs: \"item\",\n                        });\n                    } else if (item.type === \"Fixed Asset\") {\n                        this.jRaw.push({\n                            item: item,\n                            line: o,\n                            account: item.account,\n                            accountId: item.account.id,\n                            type: \"cr\",\n                            typeAs: \"item\",\n                        });\n                    }\n                }\n                if (discountItem.account) {\n                    this.jRaw.push({\n                        item: item,\n                        line: o,\n                        account: discountItem.account,\n                        accountId: discountItem.account.id,\n                        type: \"dr\",\n                        typeAs: \"discount\",\n                    });\n                }\n                if (vatTax.account) {\n                    this.jRaw.push({\n                        item: item,\n                        line: o,\n                        account: vatTax.account,\n                        accountId: vatTax.account.id,\n                        type: \"cr\",\n                        typeAs: \"tax\",\n                    });\n                }\n                if (specificTax.account) {\n                    this.jRaw.push({\n                        item: item,\n                        line: o,\n                        account: specificTax.account,\n                        accountId: specificTax.account.id,\n                        type: \"cr\",\n                        typeAs: \"tax\",\n                    });\n                }\n                if (PLTax.account) {\n                    this.jRaw.push({\n                        item: item,\n                        line: o,\n                        account: PLTax.account,\n                        accountId: PLTax.account.id,\n                        type: \"cr\",\n                        typeAs: \"tax\",\n                    });\n                }\n                if (otherTax.account) {\n                    this.jRaw.push({\n                        item: item,\n                        line: o,\n                        account: otherTax.account,\n                        accountId: otherTax.account.id,\n                        type: \"cr\",\n                        typeAs: \"tax\",\n                    });\n                }\n            });\n            const receivableAcc = this.invoice.receivableAcc || {};\n            if (receivableAcc) {\n                this.jRaw.push({\n                    item: {},\n                    line: new ItemLineModel({}),\n                    account: receivableAcc,\n                    accountId: receivableAcc.id,\n                    type: \"dr\",\n                });\n            }\n            const specificDisc = this.invoice.specificDiscountItem;\n            if (specificDisc.hasOwnProperty(\"account\")) {\n                if (specificDisc.account.hasOwnProperty(\"id\")) {\n                    this.jRaw.push({\n                        item: {},\n                        line: new ItemLineModel({}),\n                        account: specificDisc.account || {},\n                        accountId: specificDisc.account.id,\n                        type: \"dr\",\n                    });\n                }\n            }\n            const saleDepositAcc = this.customer.saleDepositAcc || {};\n            if (saleDepositAcc.hasOwnProperty(\"account\")) {\n                if (saleDepositAcc.account.hasOwnProperty(\"id\")) {\n                    this.jRaw.push({\n                        item: {},\n                        line: new ItemLineModel({}),\n                        account: saleDepositAcc.account,\n                        accountId: saleDepositAcc.account.id,\n                        type: \"dr\",\n                    });\n                }\n            }\n\n            window.console.log(saleDepositAcc);\n            if (this.mOtherCharge.length > 0) {\n                window.console.log(this.mOtherCharge);\n            }\n            window.console.log(JSON.stringify(this.jRaw), \"accounts\");\n            // todo: calculate Amount\n        },\n        removeDuplicate(array) {\n            const result = [];\n            const map = new Map();\n            for (const item of array) {\n                if (!map.has(item.id)) {\n                    map.set(item.id, true); // set any value to Map\n                    result.push(item);\n                }\n            }\n            return result;\n        },\n        numberFormat(value) {\n            // window.console.log(this.saleFormContent.decimal,'nimol')\n            return kendo.toString(value, `n${this.saleFormContent.decimal}`);\n        },\n        autoCalculateDiscount(discountItem, subTotal) {\n            if (discountItem) {\n                const nature = discountItem.nature || ''\n                const amount = discountItem.amount || 0\n                if (nature === 'Amount') {\n                    return parseFloat(amount)\n                } else if (nature === 'Percentage') {\n                    return (subTotal * (parseFloat(amount) / 100))\n                } else {\n                    return 0\n                }\n            } else {\n                return 0\n            }\n        },\n        autoCalculateTax(tax, amount) {\n            if (tax) {\n                var formula = tax.formula;\n                var inAmt = kendo.parseFloat(amount);\n                var nAmt = kendo.parseFloat(amount);\n                var taxBase = kendo.parseFloat(tax.taxBase) / 100;\n                var rate = kendo.parseFloat(tax.rate) / 100;\n                var total = eval(formula);\n                window.console.log(inAmt, nAmt, taxBase, rate, formula, total);\n                return total;\n            }\n            // return 0\n        },\n        taxMapping(objTax, tax) {\n            const taxId = tax.id || ''\n            const tax_ = objTax.filter(t => t.id === taxId)[0]\n            return tax_ || {\n                id: '',\n                defaultTax: ''\n            }\n        },\n        async dataSourceChanged(e) {\n            if (e.field) {\n                let dataRow = e.items[0], item = {},\n                    buom = {}, vTax = {}, spTax = {}, otTax = {}, plTax = {},\n                    conversionRate = 1,\n                    wac = 0,\n                    qoh = 0,\n                    amount = 0,\n                    xAmount = 0;\n                switch (e.field) {\n                    case \"item\":\n                        // this.attribute_ = this.attributes.filter(m => m.type.id === dataRow.variant.id)\n                        item = dataRow.item || {}\n                        dataRow.set(\"description\", item.description || '');\n                        buom = item.uom || {};\n                        dataRow.set(\"buom\", buom);\n                        // dataRow.set('uom', buom)\n                        // window.console.log(dataRow.item,'row')\n                        // await this.inventoryBalance(dataRow, dataRow.item.id)\n                        break;\n                    case \"price\":\n                        try {\n                            amount = parseFloat(dataRow.price) * parseFloat(dataRow.qty);\n                            xAmount = amount * parseFloat(this.invoice.txnRate);\n\n                            dataRow.set(\"price\", parseFloat(dataRow.price));\n                            dataRow.set(\"amount\", amount);\n                            dataRow.set(\"exchangeAmount\", xAmount);\n                            // window.console.log('price',dataRow.price)\n                        } catch {\n                            dataRow.set(\"price\", 0);\n                            dataRow.set(\"amount\", 0);\n                            dataRow.set(\"exchangeAmount\", 0);\n                        }\n                        break;\n                    case \"uom\":\n                        if (this.isPriceLevelChanged === false) {\n                            try {\n                                buom = dataRow.uom.buom || {};\n                                qoh = dataRow.uom.qoh || 0;\n                                conversionRate = dataRow.uom.conversionRate || 1;\n                                wac = dataRow.uom.wac || 0;\n                                dataRow.set(\"buom\", buom);\n                                dataRow.set(\"wac\", wac);\n                                dataRow.set(\"qoh\", qoh);\n                                /* todo: mapping tax object */\n                                vTax = this.taxMapping(this.vatTax, dataRow.uom.vatTax || {})\n                                otTax = this.taxMapping(this.otherTax, dataRow.uom.otherTax || {})\n                                spTax = this.taxMapping(this.specificTax, dataRow.uom.specificTax || {})\n                                plTax = this.taxMapping(this.publicLightingTax, dataRow.uom.publicLightingTax || {})\n\n                                dataRow.set(\"vatTax\", vTax);\n                                dataRow.set(\"specificTax\", spTax);\n                                dataRow.set(\"otherTax\", otTax);\n                                dataRow.set(\"publicLightingTax\", plTax);\n\n                                dataRow.set(\"conversionRate\", parseFloat(conversionRate));\n                                if (dataRow.uom) {\n                                    amount = parseFloat(dataRow.uom.price) * parseFloat(dataRow.qty);\n                                    xAmount = amount * parseFloat(this.invoice.txnRate);\n\n                                    dataRow.set(\"price\", parseFloat(dataRow.uom.price));\n                                    dataRow.set(\"amount\", amount);\n                                    dataRow.set(\"exchangeAmount\", xAmount);\n                                } else {\n                                    amount = parseFloat(dataRow.price) * parseFloat(dataRow.qty);\n                                    xAmount = amount * parseFloat(this.invoice.txnRate);\n\n                                    dataRow.set(\"price\", parseFloat(dataRow.price));\n                                    dataRow.set(\"amount\", amount);\n                                    dataRow.set(\"exchangeAmount\", xAmount);\n                                }\n                            } catch (err) {\n                                window.console.log(\"error\", err);\n                                dataRow.set(\"buom\", {});\n                                dataRow.set(\"conversionRate\", 1);\n                                dataRow.set(\"price\", 0);\n                                dataRow.set(\"qoh\", 0);\n                                dataRow.set(\"wac\", 0);\n                                dataRow.set(\"amount\", 0);\n                                dataRow.set(\"exchangeAmount\", 0);\n                            }\n                        }\n                        break;\n                    case \"qty\":\n                        try {\n                            amount = parseFloat(dataRow.price) * parseFloat(dataRow.qty);\n                            xAmount = amount * parseFloat(this.invoice.txnRate);\n\n                            dataRow.set(\"price\", parseFloat(dataRow.price));\n                            dataRow.set(\"amount\", amount);\n                            dataRow.set(\"exchangeAmount\", xAmount);\n                        } catch {\n                            dataRow.set(\"price\", 0);\n                            dataRow.set(\"amount\", 0);\n                            dataRow.set(\"exchangeAmount\", 0);\n                        }\n                        break;\n                    case \"otherTax\":\n                        // window.console.log(\"--\", dataRow)\n                        break;\n                    default:\n                        break;\n                }\n                if (e.field) {\n                    this.autoCalculate();\n                    // this.rawForJournal()\n                }\n            }\n        },\n        async inventoryBalance(dataRow, itemId) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.showLoading = true;\n                    const startDate = this.invoice.transactionDate;\n                    let strFilter = \"?asOf=\" + startDate + \"&id=\" + itemId;\n                    billingHandler.inventoryBalance(strFilter).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            const balance = res.data.data;\n                            if (balance.length > 0) {\n                                dataRow.set(\"cost\", balance[0].wac);\n                                dataRow.set(\"qoh\", balance[0].qoh);\n                                dataRow.set(\n                                    \"amount\",\n                                    parseFloat(balance[0].wac) * parseFloat(dataRow.qty)\n                                );\n                                // dataRow.set('uom', balance[0].buom)\n                            } else {\n                                dataRow.set(\"cost\", 0);\n                            }\n                            window.console.log(\"balance\", res.data.data);\n                        }\n                        this.showLoading = false;\n                    });\n                }, 10);\n            });\n        },\n        ServiceDateEditor(container, options) {\n            kendo\n                .jQuery('<input required name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDatePicker();\n\n            // let ds = this.$refs.itemLineDS.kendoWidget()\n            // window.console.log(ds.data())\n            // // const dateString = kendo.toString((new Date(options.model.items.serviceDate)), this.itemLine.dateFormat)\n            // // const dateString = kendo.toString(options.model.items.serviceDate)\n            // const $input = $(\"<input value=\" + options.model.serviceDate + \" />\").appendTo(container)\n            // $input.kendoDatePicker()\n            // // $input.appendTo(container)\n            // // options.model.items.serviceDate = dateString\n            // window.console.log($input)\n        },\n        ServiceDateToEditor(container, options) {\n            kendo\n                .jQuery('<input required name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDatePicker();\n        },\n        ItemDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Items </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: productVariantHandler.itemSearchURL('?plId=' + this.invoice.priceLevel.id +'&reUsed=1'),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                        // data: this.variants\n                    }),\n                });\n        },\n        UOMDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"code\",\n                    dataValueField: \"uomConvertId\",\n                    cascadeFrom: \"item\",\n                    template: \"<span>#= code || `No Price Level`#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {url: uomPriceHandler.uomPriceByPriceLevelURL(\"id=\" + options.model.item.id + \"&plId=\" + this.invoice.priceLevel.id + \"&date=\" + this.invoice.transactionDate),},\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    // name: {type: \"string\"},\n                                    // sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                        // data: this.variants\n                    }),\n                });\n        },\n        DiscountItemDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    cascadeFrom: \"item\",\n                    template: \"<span>#=code# - #=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: discountItemHandler.getURL(DISCOUNT_TYPE),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    // name: {type: \"string\"},\n                                    // sku: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        SpecificTaxDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"defaultTax\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=defaultTax || ``#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.specificTax.filter((m) => {\n                            if (options.model.hasOwnProperty(\"vatTax\")) {\n                                const vat = options.model.vatTax || {};\n                                if (vat) {\n                                    if (\n                                        options.model.vatTax !== null ||\n                                        options.model.vatTax !== \"null\"\n                                    ) {\n                                        if (options.model.vatTax.baseAmount) {\n                                            return (\n                                                m.baseAmount.toLowerCase() ===\n                                                options.model.vatTax.baseAmount.toLowerCase()\n                                            );\n                                        } else {\n                                            return m;\n                                        }\n                                    }\n                                } else {\n                                    return m;\n                                }\n                            }\n                        }),\n                    }),\n                });\n        },\n        PublicLightingTaxDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"defaultTax\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=defaultTax || ``#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.publicLightingTax.filter((m) => {\n                            if (options.model.hasOwnProperty(\"vatTax\")) {\n                                const vat = options.model.vatTax;\n                                if (vat) {\n                                    if (\n                                        options.model.vatTax !== null &&\n                                        options.model.vatTax !== \"null\"\n                                    ) {\n                                        if (options.model.vatTax.baseAmount) {\n                                            return (\n                                                m.baseAmount.toLowerCase() ===\n                                                options.model.vatTax.baseAmount.toLowerCase()\n                                            );\n                                        } else {\n                                            return m;\n                                        }\n                                    }\n                                } else {\n                                    return m;\n                                }\n                            }\n                        }),\n                    }),\n                });\n        },\n        OtherTaxDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"defaultTax\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=defaultTax || ``#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.otherTax.filter((m) => {\n                            if (options.model.hasOwnProperty(\"vatTax\")) {\n                                const vat = options.model.vatTax;\n                                if (vat) {\n                                    if (\n                                        options.model.vatTax !== null &&\n                                        options.model.vatTax !== \"null\"\n                                    ) {\n                                        if (options.model.vatTax.baseAmount) {\n                                            return (\n                                                m.baseAmount.toLowerCase() ===\n                                                options.model.vatTax.baseAmount.toLowerCase()\n                                            );\n                                        } else {\n                                            return m;\n                                        }\n                                    }\n                                } else {\n                                    return m;\n                                }\n                            }\n                        }),\n                    }),\n                });\n        },\n        VatTaxDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"defaultTax\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=defaultTax || ``#</span>\",\n                    optionLabel: \"--Select--\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.vatTax,\n                    }),\n                });\n        },\n        OtherChargeDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--Select--\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.otherChargeList,\n                    }),\n                });\n        },\n        SaleUnitDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"startswith\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    template: \"<span>#=code# - #=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        data: this.saleUnitItemList,\n                    }),\n                });\n        },\n        ModifierDropDownEditor(container, options) {\n            const item = options.model.item || {}\n            const uom = item.uom || {}\n            const itemId = item.id || ''\n            const uomId = uom.id || ''\n            kendo\n                .jQuery('<input name=\"' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoDropDownList({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Modifier </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: itemModifierHandler.searchURL('?plId=' + this.invoice.priceLevel.id + '&id=' + itemId + '&uomId=' + uomId),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    price: {type: \"number\"},\n                                    uom: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        EmployeeDropDownEditor(container, options) {\n            kendo\n                .jQuery('<input data-bind=\"value:' + options.field + '\"/>')\n                .appendTo(container)\n                .kendoMultiSelect({\n                    autoBind: true,\n                    autoWidth: true,\n                    height: 400,\n                    suggest: true,\n                    filter: \"contains\",\n                    dataTextField: \"name\",\n                    dataValueField: \"id\",\n                    headerTemplate:\n                        '<div class=\"dropdown-header k-widget k-header\">' +\n                        \"<span>Employee </span>\" +\n                        \"<span></span>\" +\n                        \"</div>\",\n                    template: \"<span>#=name#</span>\",\n                    optionLabel: \"--- Select ---\",\n                    dataSource: new kendo.data.DataSource({\n                        serverFiltering: true,\n                        transport: {\n                            read: {\n                                url: employeeHandler.searchURL(),\n                            },\n                            dataType: \"json\",\n                        },\n                        schema: {\n                            model: {\n                                id: \"id\",\n                                fields: {\n                                    id: {type: \"string\"},\n                                    name: {type: \"string\"},\n                                    firstName: {type: \"string\"},\n                                    lastName: {type: \"string\"},\n                                },\n                            },\n                            data: function (response) {\n                                return response.data;\n                            },\n                            total: function (response) {\n                                return response.data.count;\n                            },\n                        },\n                    }),\n                });\n        },\n        rowNumberTmpl(dataItem) {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                index = ds.indexOf(dataItem);\n            return index + 1;\n        },\n        addRow() {\n            let ds = this.$refs.itemLineDS.kendoWidget(),\n                total = ds.total();\n            this.itemLine.id = itemLinePrefix + uuid.v1();\n            this.itemLine.decimalFormat = \"n\" + this.saleFormContent.decimal;\n            this.itemLine.isEditable = true;\n            if (total < 36) {\n                ds.insert(total, this.itemLine);\n            }\n            // this.itemLines.push(this.itemLine)\n            // window.console.log('item Line', this.itemLine)\n        },\n        onPaymentTermChanged() {\n            // this.onInvoiceDateChanged();\n            // window.console.log('term', this.invoice.transactionDate, '-', this.invoice.transactionDate, '---', this.invoice.paymentTerm)\n            if (this.customer) {\n                const paymentTerm = this.invoice.paymentTerm || {}\n                if (paymentTerm) {\n                    const netDue = paymentTerm.netDue || 0\n                    const someDate = new Date(this.invoice.transactionDate);\n                    someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n                    this.invoice.dueDate = someDate.toISOString().substr(0, 10);\n                }\n            }\n        },\n        async onInvoiceDateChanged() {\n            await this.loadPaymentTermList();\n            await this.loadCreditLimit();\n            await this.loadCustomerBalance(this.customer.id);\n            await this.onPriceLevelChange();\n\n            if (this.customer) {\n                const paymentTerm = this.invoice.paymentTerm || {}\n                if (paymentTerm) {\n                    const netDue = paymentTerm.netDue || 0;\n                    const someDate = new Date(this.invoice.transactionDate);\n                    someDate.setDate(someDate.getDate() + parseInt(netDue)); //number  of days to add, e.x. 15 days\n                    this.invoice.dueDate = someDate.toISOString().substr(0, 10);\n                    // window.console.log('im', someDate, netDue)\n                }\n                // this.loadCustomerBalance(this.customer.id);\n            }\n            if (this.$route.params.id === undefined) {\n                await this.generateNumber();\n            }\n        },\n        async loadPrefix() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    prefixHandler.get(\"invoice\").then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoading = false;\n                            this.invoiceTypes = res.data.data;\n                            if (this.invoiceTypes.length > 0) {\n                                this.invoice.transactionType = this.invoiceTypes[0];\n                                if (this.$route.params.id === undefined) {\n                                    this.generateNumber();\n                                }\n                                this.templateHandle();\n                            }\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadPriceLevel() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = '?nature=sale'\n                    priceLevelHandler.get(strFilter).then((res) => {\n                        this.priceLevel = res;\n                        // if (this.priceLevel.length > 0) {\n                        //     this.invoice.priceLevel = this.priceLevel[0];\n                        // }\n                    });\n                }, 10);\n            });\n        },\n        async loadDiscountItem() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    discountItemHandler.list(DISCOUNT_TYPE).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.specificDiscountItem = res.data.data;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadOtherCharge() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    otherChargeHandler.list().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.otherChargeList = res.data.data;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadAccount() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    accountHandler.getAll().then((res) => {\n                        this.showLoading = false;\n                        //Receivable Account\n                        this.receivableAcc = res.data\n                            .filter((m) => m.account_type.number === 7)\n                            .map((itm) => {\n                                return {\n                                    id: itm.uuid,\n                                    uuid: itm.uuid,\n                                    name: itm.name,\n                                    local_name: itm.local_name,\n                                    number: itm.number,\n                                    is_taxable: itm.is_taxable,\n                                    banhjiAccCode: itm.banhjiAccCode,\n                                    group_code: itm.group_code,\n                                    parent_account: itm.parent_account,\n                                    type_code: itm.type_code,\n                                    account_type: itm.account_type,\n                                };\n                            });\n                        // if (this.receivableAcc.length > 0) {\n                        //     this.invoice.receivableAcc = this.receivableAcc[0];\n                        // }\n                    });\n                }, 10);\n            });\n        },\n        async loadPaymentTerm() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = \"?type=pmt-customer\";\n                    paymentTermHandler.getPaymentTerm(strFilter).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoading = false;\n                            this.paymentTerms = res.data.data;\n                            // if (this.paymentTerms.length > 0) {\n                            //     this.invoice.paymentTerm = this.paymentTerms[0];\n                            // }\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadLocation() {\n            this.locations = []\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const location = roleData.filter(itm => itm.type === 'location')\n                    const locationDefault = location.filter(m => m.isDefault === 1)\n                    this.locations = location\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        if (locationDefault.length > 0) {\n                            this.invoice.location = locationDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.locations = [];\n                        locationHandler\n                            .list()\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.locations = res.data.data;\n                                    if(this.locations.length > 0){\n                                        this.invoice.location = this.locations[0];\n                                    }\n                                }\n                            })\n                    }, 10);\n                });\n            }\n\n\n        },\n        async loadProjectByCustomer() {\n            this.customerProjects = []\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const project = roleData.filter(itm => itm.type === 'project')\n                    project.forEach(k => {\n                        const customers = k.customers || []\n                        const proCustomer = customers.filter(n => n.customer.id === this.customer.id)\n                        if (proCustomer.length > 0) {\n                            this.customerProjects.push(k)\n                        }\n                    })\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        const projectDefault = this.customerProjects.filter(m => m.isDefault === 1)\n                        if (projectDefault.length > 0) {\n                            this.invoice.project = projectDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        projectHandler\n                            .getByCustomer(this.customer.id)\n                            .then((res) => {\n                                this.showLoading = true;\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.customerProjects = res.data.data;\n                                } else {\n                                    this.showLoading = false;\n                                }\n                            })\n                            .catch();\n                        {\n                            this.showLoading = false;\n                        }\n                    }, 10);\n                });\n            }\n\n\n        },\n        async loadCustomerBalance(id) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = id + \"?type=bal\";\n                    this.invoice.currentBalance = 0;\n                    billingHandler\n                        .balance(strFilter)\n                        .then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const data = res.data.data;\n                                if (data.length > 0) {\n                                    this.invoice.currentBalance = data[0].balance;\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        async loadCustomerDepositBalance(id) {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const strFilter = id + \"?type=dep\";\n                    billingHandler\n                        .balance(strFilter)\n                        .then((res) => {\n                            this.invoice.depositAmount = 0;\n                            if (res.data.statusCode === 200) {\n                                const data = res.data.data;\n                                if (data.length > 0) {\n                                    const amountDeposit = data[0].balance;\n                                    this.invoice.depositAmount =\n                                        amountDeposit / this.invoice.txnRate;\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        creditLimitUsage(balance, creditLimit) {\n            if (creditLimit > 0) {\n                return (\n                    kendo.toString(\n                        (balance / creditLimit) * 100,\n                        `n${this.saleFormContent.decimal}`\n                    ) + \" %\"\n                );\n            } else {\n                return kendo.toString(0, `n${this.saleFormContent.decimal}`) + \" %\";\n            }\n\n            // const allowed = kendo.toString((balance / creditLimit) * 100, `n${this.saleFormContent.decimal}`)\n            // return (isNaN(allowed) ? 0 : allowed) + ' %'\n        },\n        async loadEmployeeCenter() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.employees = [];\n                    employeeHandler\n                        .center(undefined)\n                        .then((res) => {\n                            this.showLoading = true;\n                            if (res.data.statusCode === 200) {\n                                this.showLoading = false;\n                                this.employees = res.data.data;\n                                if (this.employees.length > 0) {\n                                    this.invoice.employee = this.employees[0];\n                                }\n                            }\n                        })\n                        .catch();\n                    {\n                        this.showLoading = false;\n                    }\n                }, 10);\n            });\n        },\n        async loadSegment() {\n            window.console.log('dataStore.roleData', dataStore)\n            const roleType = dataStore.roleType || 0\n            if (roleType === 0) {\n                if (dataStore.roleData) {\n                    const roleData = dataStore.roleData || []\n                    const segment = roleData.filter(itm => itm.type === 'segment')\n                    const segmentDefault = segment.filter(m => m.isDefault === 1)\n                    this.segments = segment\n                    if (this.$route.params.id === undefined || this.$route.params.id === '') {\n                        if (segmentDefault.length > 0) {\n                            this.invoice.segment = segmentDefault[0];\n                        }\n                    }\n                }\n            } else if (roleType === 1) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.segments = [];\n                        settingsHandler\n                            .getSeg()\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.segments = res.data.data;\n                                    if(this.segments.length > 0){\n                                        this.invoice.segment = this.segments[0];\n                                    }\n                                }\n                            })\n                    }, 10);\n                });\n            }\n\n\n        },\n        async loadSaleOrder() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    let segmentId = \"\",\n                        locationId,\n                        priceLevelId = \"\",\n                        customerId = \"\",\n                        txnDate = \"\";\n                    if (this.invoice.segment) {\n                        segmentId = this.invoice.segment.id;\n                    }\n                    if (this.invoice.location) {\n                        locationId = this.invoice.location.id;\n                    }\n                    if (this.invoice.customer) {\n                        customerId = this.invoice.customer.id;\n                    }\n                    if (this.invoice.priceLevel) {\n                        priceLevelId = this.invoice.priceLevel.id;\n                    }\n                    if (this.invoice.transactionDate) {\n                        txnDate = this.invoice.transactionDate;\n                    }\n                    let strFilter = \"\";\n                    if (\n                        segmentId !== \"\" &&\n                        customerId !== \"\" &&\n                        locationId !== \"\" &&\n                        priceLevelId !== \"\" &&\n                        txnDate !== \"\"\n                    ) {\n                        strFilter =\n                            \"?id=\" +\n                            customerId +\n                            \"&segId=\" +\n                            segmentId +\n                            \"&locId=\" +\n                            locationId +\n                            \"&plId=\" +\n                            priceLevelId +\n                            \"&date=\" +\n                            txnDate;\n                    }\n                    if (strFilter !== \"\") {\n                        this.invoice.refFrom = []\n                        this.showLoadingTxn = true\n                        saleOrderHandler\n                            .transactionFilter(strFilter)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoadingTxn = false\n                                    this.saleOrders = res.data.data;\n                                } else {\n                                    this.showLoadingTxn = false\n                                }\n                            })\n                    }\n                }, 10);\n            });\n        },\n        async loadSaleChannel() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    this.showLoading = true;\n                    saleChannelHandler.get().then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoading = false;\n                            this.saleChannelList = res.data.data;\n                            if (this.saleChannelList.length > 0) {\n                                this.invoice.saleChannel = this.saleChannelList[0];\n                            }\n                        } else {\n                            this.showLoading = false;\n                        }\n                    });\n                }, 10);\n            });\n        },\n        async loadTax() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    settingHandler.get().then((res) => {\n                        this.tax = res;\n                        this.otherTax = this.tax.filter(\n                            (m) =>\n                                (m.taxType.typeId === 7 || m.taxType.typeId === 10) &&\n                                m.transactionType === \"Sale\"\n                        ); // valuable tax\n                        this.specificTax = this.tax.filter(\n                            (m) =>\n                                (m.taxType.typeId === 8 || m.taxType.typeId === 10) &&\n                                m.transactionType === \"Sale\"\n                        ); // valuable tax\n                        this.publicLightingTax = this.tax.filter(\n                            (m) =>\n                                (m.taxType.typeId === 9 || m.taxType.typeId === 10) &&\n                                m.transactionType === \"Sale\"\n                        ); // valuable tax\n                        this.vatTax = this.tax.filter(\n                            (m) =>\n                                (m.taxType.typeId === 1 ||\n                                    m.taxType.typeId === 10) &&\n                                m.transactionType === \"Sale\"\n                        ); // valuable tax\n                        // window.console.log('tax', JSON.stringify(this.vatTax))\n                    });\n                }, 10);\n            });\n        },\n        async onSaveClose(saveNew, saveSend, isPrint) {\n            if (!this.$refs.form.validate()) {\n                // this.$refs.form.validate()\n                this.$snotify.error(\n                    \"Field is required, please check field each of tabs!\"\n                );\n                return;\n            }\n            let id = \"\";\n            if (this.customer.hasOwnProperty(\"id\")) {\n                id = this.customer.id || \"\";\n            }\n            if (id === \"\") {\n                this.$snotify.error(\"customer is require\");\n                return;\n            }\n            let ds = this.$refs.itemLineDS.kendoWidget();\n            let d1 = ds.data().filter(n => n.amount > 0);\n            let dataValidate = 0;\n            d1.forEach((value, index) => {\n                if (\n                    value.item.id == undefined ||\n                    value.uom.uom.id == undefined ||\n                    value.item.id == \"\" ||\n                    value.uom.uom.id == \"\"\n                ) {\n                    this.$snotify.error(\n                        \"Please check Item or Uom  on row \" + (index + 1)\n                    );\n                } else {\n                    dataValidate += 1;\n                }\n            });\n            if (d1.length == dataValidate) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        let isAutoGenerate = 1;\n                        if (this.$route.params.id) {\n                            const tranDate = new Date(this.invoice.transactionDate);\n                            const tranDateInvoice = new Date(this.invoice.transactionDate);\n                            const tranDateM = tranDate.getFullYear() + tranDate.getMonth();\n                            const tranDateInvoiceM =\n                                tranDateInvoice.getFullYear() + tranDateInvoice.getMonth();\n                            if (tranDateM === tranDateInvoiceM) {\n                                isAutoGenerate = 0;\n                            }\n                        }\n                        this.autoCalculate();\n                        // this.autoCalculateTaxDetail();\n                        let itemLineDS = this.$refs.itemLineDS.kendoWidget();\n                        const dataRow = itemLineDS\n                            .data()\n                            .filter((o) => o.amount > 0).map((n) => {\n                                const otherCharge = new OtherChargeModel(n.otherCharge || {})\n                                n['otherCharge'] = otherCharge\n                                return new ItemLineModel(n);\n                            });\n                        //todo: check Source\n                        const sourceRef = dataRow.map((o) => {\n                            return o.sourceTransaction;\n                        });\n                        const sourceTxn = this.removeDuplicate(sourceRef);\n                        window.console.log('dataRow', JSON.stringify(dataRow));\n                        if (dataRow.length > 0) {\n                            let data = {\n                                id: this.invoice.id ? this.invoice.id : \"\",\n                                uuid: this.invoice.uuid ? this.invoice.uuid : \"\",\n                                journal_uuid: this.invoice.journal_uuid\n                                    ? this.invoice.journal_uuid\n                                    : \"\",\n                                type: \"Invoice\",\n                                number: this.invoice.number,\n                                abbr: this.invoice.transactionType.abbr,\n                                transactionDate: this.invoice.transactionDate,\n                                dueDate: this.invoice.dueDate,\n                                monthOf: this.invoice.monthOf,\n                                customer: this.invoice.customer,\n                                transactionType: this.invoice.transactionType,\n                                paymentTerm: this.invoice.paymentTerm,\n                                approvedTerm: this.invoice.approvedTerm,\n                                discountPromotion: {},\n                                receivableAcc: this.invoice.receivableAcc,\n                                currency: this.invoice.currency,\n                                txnRate: this.invoice.txnRate,\n                                taxExchangeRate: this.invoice.taxExchangeRate,\n                                rate: 1,\n                                exchangeRate: this.invoice.exchangeRate,\n                                exchangeAmount: this.invoice.exchangeAmount,\n                                priceLevel: this.invoice.priceLevel,\n                                itemLines: dataRow,\n                                segment: this.invoice.segment,\n                                location: this.invoice.location,\n                                project: this.invoice.project,\n                                saleChannel: this.invoice.saleChannel,\n                                employee: this.invoice.employee,\n                                billingAddress: this.invoice.billingAddress,\n                                deliveryAddress: this.invoice.deliveryAddress,\n                                deliveryDateTime: this.invoice.deliveryDateTime,\n                                transactionNote: this.invoice.transactionNote,\n                                journalNote: this.invoice.journalNote,\n                                subTotal: this.invoice.subTotal,\n                                exchangeSubTotal: this.invoice.exchangeSubTotal,\n                                total: this.invoice.total,\n                                exchangeTotal: parseFloat(this.invoice.total) * parseFloat(this.invoice.txnRate),\n                                discountTotal: this.invoice.discountTotal,\n                                specificDiscountTotal: this.invoice.specificDiscountTotal,\n                                deliveryFee: this.invoice.deliveryFee,\n                                totalTaxAmount: this.invoice.totalTaxAmount,\n                                depositAmount: this.invoice.depositAmount,\n                                depositDeduction: this.invoice.depositDeduction,\n                                remainingAmount: this.invoice.remainingAmount,\n                                amountDue: this.invoice.amountDue,\n                                currentBalance: this.invoice.currentBalance,\n                                balance: this.invoice.balance,\n                                creditLimit: this.invoice.creditLimit,\n                                saveOption: this.invoice.saveOption,\n                                status: 1,\n                                approvedBy: this.invoice.approvedBy,\n                                formTemplate: this.templatesForm[this.template],\n                                specificDiscountItem: this.invoice.specificDiscountItem,\n                                otherCharge: this.mOtherCharge,\n                                otherChargeLine: this.invoice.otherChargeLine,\n                                otherChargeAmount: this.invoice.otherChargeAmount,\n                                lateFee: this.invoice.lateFee,\n                                // paymentOptionWBMobile: this.invoice.paymentOptionWBMobile,\n                                // paymentOptionOnline: this.invoice.paymentOptionOnline,\n                                // paymentOptionKHQR: this.invoice.paymentOptionKHQR,\n                                publicLink: this.invoice.publicLink,\n                                paymentCode: this.invoice.paymentCode,\n                                taxListTotal: this.taxListTotal,\n                                customerDiscountItem: this.customerDiscountItem,\n                                customerOtherChargeItem: this.customer.customerOtherChargeItem,\n                                customerSaleUnit: this.customerSaleUnit,\n                                customerSaleUnitLine: this.customerSaleUnitLine,\n                                paymentScheme: this.invoice.paymentScheme,\n                                createdAt: this.invoice.createdAt,\n                                loggedUser: this.loggedUser,\n                                saveSend: saveSend,\n                                isAutoGenerate: isAutoGenerate,\n                                jRaw: this.jRaw,\n                                sourceTransaction: sourceTxn,\n                                itemSubtotal: this.invoice.itemSubtotal,\n                                exchangeItemSubtotal: this.invoice.exchangeItemSubtotal,\n                                serviceSubtotal: this.invoice.serviceSubtotal,\n                                exchangeServiceSubtotal: this.invoice.exchangeServiceSubtotal,\n                                txnItmSubtotal: this.invoice.txnItmSubtotal,\n                                exchangeTxnItmSubtotal: this.invoice.exchangeTxnItmSubtotal,\n                                itemDiscount: this.invoice.itemDiscount,\n                                exchangeItemDiscount: this.invoice.exchangeItemDiscount,\n                                serviceDiscount: this.invoice.serviceDiscount,\n                                exchangeServiceDiscount: this.invoice.exchangeServiceDiscount,\n                                txnItmDiscount: this.invoice.txnItmDiscount,\n                                exchangeTxnItmDiscount: this.invoice.exchangeTxnItmDiscount,\n                                cashPayment: new PaymentOptionModel(this.invoice.cashPayment),\n                                qrPayment: new PaymentOptionModel(this.invoice.qrPayment),\n                                bankTransfer: new PaymentOptionModel(this.invoice.bankTransfer),\n                                billPayment: new PaymentOptionModel(this.invoice.billPayment),\n                                refFrom: this.invoice.refFrom || [],\n                                refTo: this.invoice.refTo || [],\n                                saleTaxDetail: this.invoice.saleTaxDetail || [],\n                                cashBasicIncomeAcc: this.invoice.cashBasicIncomeAcc || [],\n                                actionType: this.$route.params.id ? this.$route.query.type : \"new\",\n                            };\n                            if (this.$route.query.type === \"recurring\") {\n                                data.id = \"\";\n                            }\n                            this.showLoading = true;\n                            this.btnDisabled = true;\n                            window.console.log('Data', JSON.stringify(data));\n                            billingHandler\n                                .create(data)\n                                .then((response) => {\n                                    if (response.data.statusCode === 201) {\n                                        // this.close(response.data.data)\n                                        // this.$refs.form.reset()\n                                        this.showLoading = false;\n                                        this.btnDisabled = false;\n                                        this.$snotify.success(\"Successfully\");\n\n                                        if (isPrint == 1) {\n                                            getPrint(response.data.data);\n                                        } else if (saveNew == \"new\") {\n                                            this.setDefaultData()\n                                        } else {\n                                            // this.clear()\n                                            this.close(response.data.data);\n                                        }\n                                    }\n                                })\n                                .catch((e) => {\n                                    this.showLoading = false;\n                                    this.btnDisabled = false;\n                                    this.$snotify.error(\"Something went wrong\");\n                                    this.errors.push(e);\n                                });\n                        }\n                    }, 10);\n                });\n            }\n        },\n        close(data) {\n            if (this.$route.params.id === undefined) {\n                this.$router.push({\n                    name: \"Customers\",\n                    params: {\n                        data: data,\n                    },\n                });\n            } else {\n                window.history.go(-1);\n                // this.$router.push({\n                //     path: \"invoice_view\",\n                //     name: \"Invoice View\",\n                //     params: {\n                //         data: data,\n                //     }\n                // })\n            }\n            // window.console.log(data, 'data')\n        },\n        saveNew() {\n        },\n        removeRow(e) {\n            e.preventDefault();\n            const grid = kendo.jQuery(\"#gridItemLine\").data(\"kendoGrid\"),\n                dataSource = grid.dataSource,\n                dataItem = grid.dataItem($(e.currentTarget).closest(\"tr\"));\n\n            if (dataSource.total() > 1) {\n                dataSource.remove(dataItem);\n                this.autoCalculate();\n            }\n        },\n        generateNumber() {\n            if (this.$route.params.id) {\n                const tranDate = new Date(this.invoice.transactionDate);\n                const tranDateInvoice = new Date(this.invoice.transactionDate);\n                const tranDateM = tranDate.getFullYear() + tranDate.getMonth();\n                const tranDateInvoiceM =\n                    tranDateInvoice.getFullYear() + tranDateInvoice.getMonth();\n                if (tranDateM === tranDateInvoiceM) {\n                    this.invoice.referenceNo = this.referenceNo;\n                    return;\n                }\n            }\n\n            if (this.invoice.transactionDate !== \"\" && this.invoiceTypes.length > 0) {\n                let data = {\n                    abbr: this.invoice.transactionType.abbr,\n                    structure: this.invoice.transactionType.structure,\n                    transactionDate: this.invoice.transactionDate,\n                    sequcencing: this.invoice.transactionType.sequcencing,\n                    type: \"Invoice\",\n                    entity: 1,\n                };\n                billingHandler\n                    .lastNumber(data)\n                    .then((response) => {\n                        if (response.data.statusCode === 200) {\n                            const res = response.data.data;\n                            const lastNumber = this.zeroPad(\n                                parseInt(res.lastNumber),\n                                this.invoice.transactionType.format\n                            );\n                            const number =\n                                res.suffix +\n                                this.invoice.transactionType.numberSeparator +\n                                lastNumber;\n                            this.invoice.number = number;\n                        }\n                    })\n                    .catch((e) => {\n                        this.errors.push(e);\n                    });\n            }\n        },\n        zeroPad(num, places) {\n            return String(num).padStart(places, \"0\");\n        },\n        suffix(transactionDate) {\n            return kendo.toString(new Date(transactionDate), `yymm`);\n        },\n        errorMessage() {\n        },\n        accountDropDownEditor() {\n        },\n        cancel() {\n            this.$swal({\n                title: i18n.t(\"msg_title_warning\"),\n                text: i18n.t(\"msg_discard\"),\n                icon: \"warning\",\n                showCancelButton: true,\n                cancelButtonText: i18n.t(\"cancel\"),\n                confirmButtonColor: \"#4d4848\",\n                cancelButtonColor: \"#ED1A3A\",\n                confirmButtonText: i18n.t(\"discard\"),\n            }).then((result) => {\n                if (result.value) {\n                    this.clear();\n                    this.$router.go(-1);\n                }\n            });\n        },\n        hideSmallSidebar() {\n            this.isHideBar = !this.isHideBar;\n        },\n        requestData(skip, filter, baseUrl) {\n            const url = baseUrl + `?filter=${filter}`;\n            this.requestStarted = true;\n            fetch(url)\n                .then((response) => {\n                    return response.json();\n                })\n                .then(this.afterFetch);\n        },\n        requestData_(skip, filter, baseUrl) {\n            const url = baseUrl + `/${filter}`;\n            this.requestStarted = true;\n            fetch(url)\n                .then((response) => {\n                    return response.json();\n                })\n                .then(this.afterFetch_);\n        },\n        onChange(event) {\n            const value = event.value;\n            if (value && value[textField] === emptyItem[textField]) {\n                return;\n            }\n            const id = value.id || ''\n            if (id !== '') {\n                window.console.log('value', value)\n                this.customer = value;\n                this.invoice.customer = value;\n                this.invoice.billPayment = this.customer.billPayment\n                this.invoice.qrPayment = this.customer.qrPayment\n                this.invoice.cashPayment = this.customer.cashPayment\n                this.invoice.bankTransfer = this.customer.bankTransfer\n                // window.console.log(this.invoice.customer, 'Changed')\n                // this.invoice = value\n                this.invoice.receivableAcc = value.receivableAcc || {}\n                // this.invoice.paymentTerm = value.hasOwnProperty(\"paymentTerm\")\n                //     ? value.paymentTerm\n                //     : {};\n                this.invoice.priceLevel = value.priceLevel || {}\n                const baseCurrency = value.baseCurrency || {}\n                if (baseCurrency.hasOwnProperty(\"code\")) {\n                    this.baseCurrencyCode = \" \" + baseCurrency.code;\n                }\n                const priceLevel = value.priceLevel || {}\n                const currency = priceLevel.currency || {}\n                const code = currency.code || ''\n                window.console.log('priceLevel: ' + JSON.stringify(priceLevel))\n                if (code !== '') {\n                    this.loadTransactionRate();\n                }\n                this.billingAddress = value.billingAddress || []\n                this.deliveryAddress = value.deliveryAddress || []\n                if (this.billingAddress.length > 0) {\n                    this.invoice.billingAddress = this.billingAddress[0];\n                }\n                if (this.deliveryAddress.length > 0) {\n                    this.invoice.deliveryAddress = this.deliveryAddress[0];\n                }\n                this.onInvoiceDateChanged();\n                this.loadProjectByCustomer();\n            }\n            // this.loadCustomerBalance(this.customer.id);\n            // this.loadCreditLimit();\n            // this.loadPaymentTermList();\n            // window.console.log(value, 'value')\n        },\n        onEmployeeChanged(event) {\n            const value = event.value;\n            if (value && value[textField] === emptyItem[textField]) {\n                return;\n            }\n            this.mEmployee = value;\n            this.invoice.employee = value;\n        },\n        afterFetch(json) {\n            this.customerList = json.data;\n        },\n        afterFetch_(json) {\n            this.employees = json.data;\n        },\n        onFilterChange(event) {\n            const filter = event.filter.value;\n            this.requestData(0, filter, this.cusBaseUrl);\n            this.filter = filter;\n        },\n        onEmployeeFilterChanged(event) {\n            const filter = event.filter.value;\n            this.requestData_(0, filter, this.empBaseUrl);\n            this.filter_ = filter;\n        },\n        async initData() {\n            if (this.$route.params.id !== undefined) {\n                await this.loadViewInvoice();\n            } else {\n                this.setDefaultData()\n            }\n        },\n        async loadLateFee() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const priceLevel = this.invoice.priceLevel || {}\n                    const currency = priceLevel.currency || {}\n                    const code = currency.code || ''\n                    const strFilter = '?code=' + code\n                    lateFeeHandler.list(strFilter).then((res) => {\n                        if (res.data.statusCode === 200) {\n                            this.showLoading = false;\n                            this.lateFeeList = res.data.data;\n                        } else {\n                            this.showLoading = false;\n                        }\n\n                    });\n                }, 10);\n            });\n        },\n        async loadViewInvoice() {\n            this.btnDisabled = false\n            if (this.$route.params.id) {\n                new Promise((resolve) => {\n                    setTimeout(() => {\n                        resolve(\"resolved\");\n                        this.showLoading = true;\n                        billingHandler\n                            .view(this.$route.params.id)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.invoice = res.data.data[0];\n                                    this.referenceNo = this.invoice.referenceNo;\n                                    this.invoice.transactionDate = new Date(this.invoice.transactionDate);\n                                    this.customer = this.invoice.customer;\n                                    this.mEmployee = this.invoice.employee;\n                                    this.taxListTotal = this.invoice.taxListTotal;\n                                    this.itemLines = this.invoice.itemLines;\n                                    this.mOtherCharge = this.invoice.otherCharge;\n                                    this.depositDeduction = this.invoice.depositDeduction;\n\n                                    // const xRate = this.invoice.exchangeRate\n                                    // this.currencyCode = xRate.code;\n                                    // window.console.log('currencyCode', xRate)\n                                    this.templateHandle();\n                                    this.template = this.invoice.formTemplate.id;\n                                    this.jRaw = this.invoice.jRaw || [];\n                                    for (let i = 0; i < this.mOtherCharge.length - 1; i++) {\n                                        this.addSelect();\n                                    }\n                                    this.loadProjectByCustomer();\n                                    if (this.customer.hasOwnProperty(\"id\")) {\n                                        this.loadCustomerBalance(this.customer.id);\n                                    }\n                                    this.saleOrders = this.invoice.refFrom || []\n                                    if (this.$route.query.type === \"recurring\") {\n                                        if (this.$route.params.hasOwnProperty(\"transactionDate\")) {\n                                            window.console.log(\"type\", this.$route.params);\n                                            this.invoice.transactionDate = new Date(\n                                                this.$route.params.transactionDate\n                                            );\n                                            this.invoice.transactionDate = new Date(\n                                                this.$route.params.transactionDate\n                                            );\n                                            this.onInvoiceDateChanged();\n                                            this.generateNumber();\n                                        }\n                                    }\n                                }\n                            })\n                            .catch();\n                        {\n                            this.showLoading = false;\n                        }\n                    }, 10);\n                });\n            }\n        },\n        clear() {\n            const term = this.invoice.paymentTerm || {}\n            const priceL = this.invoice.priceLevel || {}\n            this.id = undefined;\n            this.itemLines = []\n            this.invoice = new InvoiceModel();\n            this.invoice.paymentTerm = term\n            this.invoice.priceLevel = priceL\n            this.customer = ''\n            this.employee = ''\n            this.saleOrders = []\n            this.invoice.transactionType = this.invoiceTypes[0];\n            this.generateNumber();\n        },\n        async loadTransactionRate() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const date = new Date(this.invoice.transactionDate).toISOString().substr(0, 10);\n                    const priceLevel = this.invoice.priceLevel || {};\n                    const currency = priceLevel.currency || {}\n                    const code = currency.code || ''\n                    if (code) {\n                        this.showLoading = true;\n                        currencyHandler\n                            .getLastExchangeRateByDate(date, code)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.showLoading = false;\n                                    this.exchangeRate = res.data.data[0];\n                                    this.currencyCode = this.exchangeRate.code;\n                                    this.transactionRate = this.exchangeRate.rate;\n                                    this.invoice.txnRate = this.exchangeRate.rate;\n                                    this.invoice.exchangeRate = this.exchangeRate;\n                                    this.showLoading = false;\n                                    this.loadCustomerDepositBalance(this.customer.id);\n                                }\n                            });\n                    }\n                    this.loadSaleOrder();\n                    this.loadTransactionTaxRate();\n                }, 10);\n            });\n        },\n        async loadTransactionTaxRate() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    const date = new Date(this.invoice.transactionDate).toISOString().substr(0, 10);\n                    let code = \"KHR\";\n                    if (code !== undefined || code !== \"\") {\n                        currencyHandler\n                            .getLastExchangeRateByDate(date, code)\n                            .then((res) => {\n                                if (res.data.statusCode === 200) {\n                                    this.invoice.taxExchangeRate = res.data.data[0];\n                                }\n                            });\n                    }\n                }, 10);\n            });\n        },\n        async loadCreditLimit() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    if (this.customer) {\n                        const strFilter = '?id=' + this.customer.id + '&transactionDate=' + this.invoice.transactionDate + '&type=Customer'\n                        this.invoice.creditLimit = 0\n                        creditLimitHandler.get(strFilter).then((res) => {\n                            if (res.data.statusCode === 200) {\n                                // this.creditLimitItem = res.data.data\n                                const credit = res.data.data\n                                this.invoice.creditLimit = kendo.parseFloat(credit.amount || 0);\n                            }\n                        });\n                    }\n                }, 10);\n            });\n        },\n        async loadPaymentTermList() {\n            new Promise((resolve) => {\n                setTimeout(() => {\n                    resolve(\"resolved\");\n                    if (this.customer) {\n                        const strFilter = '?id=' + this.customer.id + '&transactionDate=' + this.invoice.transactionDate + '&type=Customer'\n                        this.invoice.paymentTerm = {}\n                        paymentTermHandler_.get(strFilter).then((res) => {\n                            if (res.data.statusCode === 200) {\n                                const terms = res.data.data\n                                this.invoice.paymentTerm = terms.term\n                                this.invoice.approvedTerm = terms.term\n                                this.onPaymentTermChanged()\n                            }\n                        });\n                    }\n                }, 10);\n            });\n        },\n        onPriceLevelChange() {\n            this.isPriceLevelChanged = true\n            this.loadTransactionRate()\n            this.clearUOMItem()\n            this.loadLateFee()\n        },\n        async clearUOMItem() {\n            let ds = this.$refs.itemLineDS.kendoWidget()\n            ds.data().map(n => {\n                n.set('uom', {})\n            })\n            this.isPriceLevelChanged = false\n        },\n        setDefaultData() {\n            let ds = this.$refs.itemLineDS.kendoWidget();\n            ds.data([]);\n            const term = this.invoice.paymentTerm || {}\n            const priceL = this.invoice.priceLevel || {}\n            this.id = undefined;\n            this.invoice = new InvoiceModel();\n            this.invoice.paymentTerm = term\n            this.invoice.priceLevel = priceL\n            this.customer = {}\n            this.mEmployee = {}\n            this.saleOrders = []\n            this.invoice.transactionType = this.invoiceTypes[0];\n            this.generateNumber();\n            this.loadSegment();\n            this.loadLocation();\n            this.addRow()\n            // this.addRow()\n        }\n    },\n    computed: {\n        disabledSLP() {\n            if (this.$route.params.id) {\n                const refF = this.invoice.refFrom || []\n                if (refF.length > 0) {\n                    return !!refF.length > 0\n                }\n            }\n            return false\n        },\n        disabledMe() {\n            return !!this.$route.params.id;\n        },\n        disabledDeposit() {\n            if (this.$route.params.id) {\n                return this.depositDeduction > 0;\n            } else {\n                return false\n            }\n        },\n        validCustomer: function () {\n            return this.customer.id !== undefined && this.customer.id !== null;\n        },\n        hiddenButton() {\n            if (this.$route.params.id) {\n                return true\n            } else {\n                return false\n            }\n        },\n        // depositDeduction: {\n        //     get(value) {\n        //         return value\n        //     }, set(value) {\n        //         this.$emit('depositDeduction', value)\n        //     }\n        // }\n    },\n    watch: {\n        // id() {\n        //     if (this.$route.params.id === undefined) {\n        //         this.setDefaultData();\n        //     } else {\n        //         this.showLoading = true;\n        //         this.loadViewInvoice();\n        //     }\n        // },\n        '$route': 'loadSaleFormContent'\n    },\n    created() {\n        this.loadPriceLevel();\n        this.loadTax();\n        this.loadSaleUnitItems();\n        this.loadPrefix();\n        // this.loadLateFee();\n        this.loadSegment();\n        this.loadLocation();\n        this.loadPaymentOption();\n    },\n    mounted: async function () {\n        await this.loadSaleFormContent();\n        this.requestData(0, this.filter, this.cusBaseUrl);\n        await this.loadDiscountItem();\n        await this.loadSaleChannel();\n        await this.loadEmployeeCenter();\n        await this.loadPaymentTerm();\n        await this.loadAccount();\n        // await this.loadCurrency()\n        await this.loadOtherCharge();\n        // await this.loadCatalogs()\n        // await this.initData()\n        await this.loadViewInvoice()\n    },\n};\n</script>\n\n<style scoped>\n.k-dropdown {\n    width: 100%;\n    margin-top: 3px;\n}\n\n.function_wrapper {\n    box-shadow: none !important;\n}\n\n.v-application--is-ltr .v-text-field .v-input__append-inner {\n    margin-top: 0 !important;\n}\n\n.v-input__slot {\n    background-color: #fff !important;\n}\n\n.function_content .label {\n    margin-bottom: 10px;\n    display: inline-block;\n}\n\n.border_radius10 {\n    border-radius: 10px !important;\n    background-color: #f2f2f2;\n}\n\n.pa-3.v-card h4 {\n    font-size: 18px;\n    color: #333;\n}\n\n.pa-3.v-card p {\n    font-size: 12px;\n    color: #b5b5b5;\n}\n\n.attachment_file {\n    background-color: #efeded;\n    border-radius: 0 !important;\n}\n\n.attachment_table.v-data-table table {\n    border: thin solid rgba(0, 0, 0, 0.12);\n}\n\n.attachment_table table tr th {\n    border-left: thin solid rgba(0, 0, 0, 0.12);\n    height: 35px;\n    border-right: thin solid rgba(0, 0, 0, 0.12);\n}\n\n.block_debit,\n.block_credit {\n    border-bottom: 1px solid #fff;\n}\n\n.block_debit p.number,\n.block_credit p.number {\n    font-size: 25px;\n    color: #7f7f7f;\n}\n\n.block_debit h5,\n.block_credit h5,\n.block_difference h5 {\n    text-transform: uppercase;\n    color: #7f7f7f;\n    font-size: 15px;\n    font-weight: normal;\n}\n\n.block_difference h5 {\n    font-size: 18px;\n}\n\n.block_difference h5 span {\n    font-size: 15px;\n}\n\n.custom_grid table th:last-child {\n    text-align: right !important;\n}\n\n.color_green {\n    color: #c80000;\n}\n\n@media (min-width: 1264px) {\n    .container {\n        max-width: 1250px;\n    }\n}\n\n@media (max-width: 576px) {\n    .pt-6.col-sm-5.col-12 {\n        padding-top: 0 !important;\n    }\n\n    .code_text {\n        width: 100%;\n    }\n\n    .phone_no_pt {\n        padding-top: 0 !important;\n    }\n\n    .select_template,\n    .save_option {\n        margin-bottom: 10px;\n    }\n}\n\n.hide_small_bar_class {\n    max-width: 0;\n    transition: 0.5s ease-in;\n    flex: 0 0 0;\n}\n\n.hide_big_bar_class {\n    max-width: 100%;\n    transition: 0.5s ease-in;\n    flex: 0 0 100%;\n}\n\n.info_add {\n    background-color: #ffffff;\n}\n\n.small_sidebar {\n    height: 98%;\n    position: relative;\n    padding: 12px;\n    background-color: #edf1f5;\n}\n\n.my_card h3 {\n    display: block !important;\n}\n\n.iconArrow {\n    right: -35px;\n    position: absolute;\n    bottom: -10px;\n}\n\n.iconArrowHide {\n    position: absolute;\n    right: -7px;\n    bottom: -10px;\n}\n\n.color_grey {\n    color: #808080;\n}\n\n.card_green {\n    min-height: 70px;\n    background-color: #c80000 !important;\n    color: #ffffff;\n}\n\n.lb_bold {\n    font-size: 12px;\n}\n\n.detial_smallside_p {\n    position: absolute;\n    bottom: 10px;\n}\n\n.card_background {\n    background-color: #edf1f5;\n    min-height: 120px;\n}\n\n.deposite_input {\n    width: 100px;\n}\n\n.btn_save_draft {\n    color: #ffffff;\n    background-color: #00b0f0 !important;\n    text-transform: capitalize;\n}\n\n.save_option {\n    background-color: #203864 !important;\n}\n\n.btn_add_small {\n    height: 27px !important;\n    min-width: 25px !important;\n    font-size: 10px;\n    padding: 0 22px !important;\n    background-color: #c80000 !important;\n    color: #ffffff;\n    border-radius: 0 !important;\n}\n\n.list_site_inv {\n    background-color: #f44336;\n    color: #ffffff;\n    font-size: 12px;\n}\n\n.list_site_exp {\n    background-color: #c5e0b4;\n    color: #000000;\n    font-size: 12px;\n    line-height: 16px;\n    min-height: 40px;\n}\n\n.checkbox_inv {\n    padding: 2px;\n    margin-top: 3px;\n    margin-right: 2px;\n}\n\n.exp_select {\n    font-size: 12px !important;\n}\n\n.theme--light.v-data-table\n> .v-data-table__wrapper\n> table\n> tbody\n> tr:hover:not(.v-data-table__expanded__content):not(.v-data-table__empty-wrapper) {\n    background-color: transparent !important;\n}\n\n.b_add {\n    height: 30px !important;\n}\n</style>\n"]}]}